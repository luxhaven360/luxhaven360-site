<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Ordine ricevuto - LuxHaven360</title>
  <link rel="stylesheet" href="styles.css"/>
</head>
<body>
  <section class="section active" id="success">
    <h2 class="section-title">Grazie per il tuo ordine</h2>
    <div style="max-width:800px;margin:0 auto;padding:2rem;text-align:center;">
      <p id="message">Sto verificando il pagamento...</p>
      <div id="orderDetails" style="margin-top:1.5rem;"></div>
      <a href="/" class="btn" style="margin-top:2rem;">Torna allo Shop</a>
    </div>
  </section>

  <script>
    async function fetchSession(sessionId) {
      try {
        const res = await fetch(`/api/get-session?session_id=${encodeURIComponent(sessionId)}`);
        return await res.json();
      } catch (e){
        return { error: e.message || "Errore" };
      }
    }

    async function init(){
      const params = new URLSearchParams(window.location.search);
      const sessionId = params.get('session_id');
      if(!sessionId){
        document.getElementById('message').innerText = "Nessuna sessione di pagamento trovata.";
        return;
      }
      document.getElementById('message').innerText = "Pagamento completato — recupero dati ordine...";
      const data = await fetchSession(sessionId);
      if(data.error){
        document.getElementById('message').innerText = "Errore: " + data.error;
        return;
      }
      // mostra dettagli
      const details = document.getElementById('orderDetails');
      const cust = data.customer_details || {};
      const line_items = data.line_items || [];
      details.innerHTML = `
        <p><strong>ID ordine (Stripe):</strong> ${data.id}</p>
        <p><strong>Cliente:</strong> ${cust.name || cust.email || "N/A"}</p>
        <p><strong>Totale:</strong> ${(data.amount_total/100).toFixed(2)} ${data.currency.toUpperCase()}</p>
        <h4>Prodotti:</h4>
        <ul>
          ${line_items.map(li => `<li>${li.quantity} × ${li.description} — ${(li.amount_total/100).toFixed(2)} ${li.currency.toUpperCase()}</li>`).join('')}
        </ul>
        <p>Abbiamo registrato l'ordine su Google Sheets. Riceverai un'email di conferma (se fornita).</p>
      `;
      document.getElementById('message').innerText = "Pagamento verificato. Grazie!";
    }
    init();
  </script>
</body>
</html>
