<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prenotazione Confermata</title>
    <!-- Connection Monitor Styles -->
    <link rel="stylesheet" href="../connection-monitor.css" />
    
    <!-- ‚úÖ Sistema i18n -->
    <script src="../translations.js"></script>
    <script src="translations-pdp.js"></script>
    <script src="i18n-pdp.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@300;400;600&family=Montserrat:wght@300;400;500;600&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Montserrat', sans-serif;
            background: linear-gradient(135deg, #0a0a0a 0%, #1a1a1a 50%, #0f0f0f 100%);
            color: #e8e8e8;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            overflow-x: hidden;
            position: relative;
        }
        
        body::before {
            content: '';
            position: fixed;
            top: -50%;
            right: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(195, 155, 98, 0.05) 0%, transparent 70%);
            animation: rotate 60s linear infinite;
            pointer-events: none;
        }
        
        @keyframes rotate {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        .container {
            max-width: 900px;
            width: 100%;
            position: relative;
            z-index: 1;
        }
        
        .confirmation-card {
            background: rgba(255, 255, 255, 0.03);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(195, 155, 98, 0.2);
            border-radius: 24px;
            padding: 60px 50px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            animation: slideUp 0.8s cubic-bezier(0.16, 1, 0.3, 1);
            position: relative;
            overflow: hidden;
        }
        
        .confirmation-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg, transparent, rgba(195, 155, 98, 0.5), transparent);
        }
        
        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .icon-wrapper {
            width: 100px;
            height: 100px;
            margin: 0 auto 30px;
            position: relative;
        }
        
        .circle-bg {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background: linear-gradient(135deg, rgba(195, 155, 98, 0.2), rgba(195, 155, 98, 0.05));
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            animation: pulse 2s ease-in-out infinite;
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        
        .checkmark {
            width: 50px;
            height: 50px;
            stroke: #c39b62;
            stroke-width: 3;
            stroke-linecap: round;
            stroke-linejoin: round;
            fill: none;
        }
        
        .checkmark-path {
            stroke-dasharray: 100;
            stroke-dashoffset: 100;
            animation: draw 1s cubic-bezier(0.47, 0, 0.745, 0.715) 0.3s forwards;
        }
        
        @keyframes draw {
            to { stroke-dashoffset: 0; }
        }
        
        h1 {
            font-family: 'Cormorant Garamond', serif;
            font-size: 3rem;
            font-weight: 300;
            text-align: center;
            margin-bottom: 15px;
            color: #c39b62;
            letter-spacing: 2px;
            animation: fadeIn 0.8s ease-out 0.3s backwards;
        }
        
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .subtitle {
            text-align: center;
            font-size: 1rem;
            color: #b0b0b0;
            margin-bottom: 50px;
            font-weight: 300;
            letter-spacing: 1px;
            animation: fadeIn 0.8s ease-out 0.5s backwards;
        }
        
        .divider {
            height: 1px;
            background: linear-gradient(90deg, transparent, rgba(195, 155, 98, 0.3), transparent);
            margin: 40px 0;
        }
        
        .booking-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 25px;
            margin-bottom: 40px;
            animation: fadeIn 0.8s ease-out 0.7s backwards;
        }
        
        .detail-item {
            background: rgba(255, 255, 255, 0.02);
            padding: 25px;
            border-radius: 16px;
            border: 1px solid rgba(195, 155, 98, 0.1);
            transition: all 0.3s ease;
        }
        
        .detail-item:hover {
            background: rgba(255, 255, 255, 0.04);
            border-color: rgba(195, 155, 98, 0.3);
            transform: translateY(-2px);
        }
        
        .detail-label {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 2px;
            color: #c39b62;
            margin-bottom: 10px;
            font-weight: 500;
        }
        
        .detail-value {
            font-size: 1.1rem;
            color: #ffffff;
            font-weight: 400;
        }
        
        .info-section {
            background: linear-gradient(135deg, rgba(195, 155, 98, 0.05), rgba(195, 155, 98, 0.02));
            padding: 30px;
            border-radius: 16px;
            border-left: 3px solid #c39b62;
            margin-bottom: 40px;
            animation: fadeIn 0.8s ease-out 0.9s backwards;
        }
        
        .info-section h3 {
            font-family: 'Cormorant Garamond', serif;
            font-size: 1.5rem;
            color: #c39b62;
            margin-bottom: 15px;
            font-weight: 400;
        }
        
        .info-section p {
            line-height: 1.8;
            color: #d0d0d0;
            font-weight: 300;
        }
        
        .action-buttons {
            display: flex;
            gap: 20px;
            justify-content: center;
            flex-wrap: wrap;
            animation: fadeIn 0.8s ease-out 1.1s backwards;
        }
        
        .btn {
            padding: 16px 40px;
            border: none;
            border-radius: 12px;
            font-family: 'Montserrat', sans-serif;
            font-size: 0.95rem;
            font-weight: 500;
            letter-spacing: 1px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            position: relative;
            overflow: hidden;
        }
        
        .btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.1);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }
        
        .btn:hover::before {
            width: 300px;
            height: 300px;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #c39b62, #a67c52);
            color: #ffffff;
            position: relative;
            z-index: 1;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(195, 155, 98, 0.3);
        }
        
        .btn-secondary {
            background: transparent;
            border: 1px solid rgba(195, 155, 98, 0.5);
            color: #c39b62;
        }
        
        .btn-secondary:hover {
            background: rgba(195, 155, 98, 0.1);
            border-color: #c39b62;
        }
        
        .booking-number {
            text-align: center;
            margin-top: 40px;
            padding-top: 30px;
            border-top: 1px solid rgba(195, 155, 98, 0.2);
            animation: fadeIn 0.8s ease-out 1.3s backwards;
        }
        
        .booking-number-label {
            font-size: 0.8rem;
            color: #888;
            text-transform: uppercase;
            letter-spacing: 2px;
            margin-bottom: 8px;
        }
        
        .booking-number-value {
            font-family: 'Cormorant Garamond', serif;
            font-size: 1.8rem;
            color: #c39b62;
            letter-spacing: 3px;
            font-weight: 400;
        }
        
        .category-indicator {
            position: absolute;
            top: 30px;
            right: 30px;
            padding: 8px 20px;
            background: rgba(195, 155, 98, 0.15);
            border: 1px solid rgba(195, 155, 98, 0.3);
            border-radius: 20px;
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 2px;
            color: #c39b62;
            font-weight: 500;
        }
        
        /* ============================================
           SELETTORE LINGUA PREMIUM (SUCCESS-BOOKING)
           ============================================ */

        .pdp-lang-selector {
            position: fixed;
            top: 2rem;
            left: 2rem;
            right: auto;
            z-index: 9999;
            display: flex;
            align-items: center;
            gap: 0.25rem;
            background: rgba(9, 9, 11, 0.85);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(212, 175, 55, 0.2);
            border-radius: 2rem;
            padding: 0.625rem 1.25rem;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .pdp-lang-selector:hover {
            border-color: rgba(212, 175, 55, 0.5);
            box-shadow: 0 12px 48px rgba(212, 175, 55, 0.15);
        }

        .pdp-lang-option {
            background: none;
            border: none;
            color: #71717a;
            font-size: 0.875rem;
            font-weight: 500;
            letter-spacing: 0.05em;
            padding: 0.5rem 0.75rem;
            cursor: pointer;
            transition: all 0.3s;
            border-radius: 1rem;
            position: relative;
        }

        .pdp-lang-option:hover {
            color: #d4d4d8;
            background: rgba(255, 255, 255, 0.05);
        }

        .pdp-lang-option.active {
            color: #D4AF37;
            font-weight: 600;
            background: linear-gradient(135deg, rgba(212, 175, 55, 0.1), rgba(255, 215, 0, 0.05));
        }

        .pdp-lang-option.active::after {
            content: '';
            position: absolute;
            bottom: 0.25rem;
            left: 50%;
            transform: translateX(-50%);
            width: 1.25rem;
            height: 2px;
            background: linear-gradient(90deg, #D4AF37, #FFD700);
            border-radius: 2px;
            box-shadow: 0 0 8px rgba(212, 175, 55, 0.6);
        }

        .pdp-lang-divider {
            width: 1px;
            height: 1rem;
            background: rgba(113, 113, 122, 0.3);
            margin: 0 0.125rem;
        }

        /* Responsive Mobile */
        @media (max-width: 768px) {
            .pdp-lang-selector {
                top: 1rem;
                left: auto;
                right: 1rem;
                padding: 0.5rem 1rem;
            }
            
            .pdp-lang-option {
                font-size: 0.8125rem;
                padding: 0.375rem 0.5rem;
            }
            
            .confirmation-card {
                padding: 40px 30px;
            }
            
            h1 {
                font-size: 2rem;
            }
            
            .booking-details {
                grid-template-columns: 1fr;
            }
            
            .action-buttons {
                flex-direction: column;
            }
            
            .btn {
                width: 100%;
            }
            
            .category-indicator {
                position: static;
                display: inline-block;
                margin-bottom: 20px;
            }
        }
        
        @media (max-width: 480px) {
            .confirmation-card {
                padding: 30px 20px;
            }
            
            h1 {
                font-size: 1.75rem;
            }
            
            .subtitle {
                font-size: 0.9rem;
            }
        }
    </style>
</head>
<body>
    <!-- ‚úÖ Selettore Lingua Premium -->
    <div class="pdp-lang-selector" id="pdpLanguageSelector">
        <button class="pdp-lang-option active" data-lang="it">IT</button>
        <span class="pdp-lang-divider"></span>
        <button class="pdp-lang-option" data-lang="en">EN</button>
        <span class="pdp-lang-divider"></span>
        <button class="pdp-lang-option" data-lang="fr">FR</button>
        <span class="pdp-lang-divider"></span>
        <button class="pdp-lang-option" data-lang="de">DE</button>
        <span class="pdp-lang-divider"></span>
        <button class="pdp-lang-option" data-lang="es">ES</button>
    </div>
    
    <!-- üíé LOADER PREMIUM INTERATTIVO -->
    <div id="pageLoader" style="position:fixed;top:0;left:0;width:100%;height:100%;background:linear-gradient(135deg, #0a0a0a 0%, #1a1412 40%, #0f0f0f 100%);z-index:999999;display:flex;align-items:center;justify-content:center;">
        <div style="text-align: center; position: relative;">
            
            <!-- üí´ Anelli rotanti multi-layer -->
            <div style="position: relative; width: 140px; height: 140px; margin: 0 auto 40px;">
                
                <!-- Anello esterno (lento) -->
                <div style="
                    position: absolute;
                    inset: 0;
                    border: 2px solid transparent;
                    border-top-color: rgba(212, 175, 55, 0.3);
                    border-right-color: rgba(212, 175, 55, 0.15);
                    border-radius: 50%;
                    animation: rotate-slow 3s linear infinite;
                "></div>
                
                <!-- Anello medio (medio) -->
                <div style="
                    position: absolute;
                    inset: 15px;
                    border: 2px solid transparent;
                    border-top-color: #D4AF37;
                    border-right-color: rgba(212, 175, 55, 0.5);
                    border-radius: 50%;
                    animation: rotate-medium 2s cubic-bezier(0.68, -0.55, 0.265, 1.55) infinite;
                "></div>
                
                <!-- Anello interno (veloce) -->
                <div style="
                    position: absolute;
                    inset: 30px;
                    border: 2px solid transparent;
                    border-top-color: rgba(255, 215, 0, 0.6);
                    border-radius: 50%;
                    animation: rotate-fast 1.2s linear infinite;
                "></div>
                
                <!-- Centro luminoso -->
                <div style="
                    position: absolute;
                    inset: 45px;
                    background: radial-gradient(circle, rgba(212, 175, 55, 0.3), transparent);
                    border-radius: 50%;
                    animation: pulse-glow 2s ease-in-out infinite;
                "></div>
                
                <!-- Punto centrale -->
                <div style="
                    position: absolute;
                    top: 50%;
                    left: 50%;
                    transform: translate(-50%, -50%);
                    width: 8px;
                    height: 8px;
                    background: #D4AF37;
                    border-radius: 50%;
                    box-shadow: 0 0 20px rgba(212, 175, 55, 0.8);
                "></div>
            </div>
            
            <!-- ‚ú® Testo principale con gradiente -->
            <div style="
                font-family: 'Cormorant Garamond', serif;
                font-size: 28px;
                font-weight: 300;
                letter-spacing: 4px;
                margin-bottom: 20px;
                background: linear-gradient(135deg, #D4AF37 0%, #F4E4C1 50%, #C9A02C 100%);
                -webkit-background-clip: text;
                -webkit-text-fill-color: transparent;
                background-clip: text;
            " data-i18n="booking_loader_title">
                Un momento
            </div>
            
            <!-- üìã Messaggio dinamico -->
            <div id="loaderMessage" style="
                color: #c9a891;
                font-size: 14px;
                font-weight: 300;
                letter-spacing: 2px;
                text-transform: uppercase;
                opacity: 0;
                transition: opacity 0.6s ease-in-out;
                min-height: 20px;
            ">
                Preparazione dei dettagli
            </div>
            
            <!-- üéØ Decorazione dorata animata -->
            <div style="
                margin-top: 30px;
                height: 1px;
                width: 120px;
                margin-left: auto;
                margin-right: auto;
                background: linear-gradient(90deg, transparent, #D4AF37, transparent);
                animation: expand-line 2s ease-in-out infinite;
            "></div>
            
            <!-- ‚ú® Particelle decorative -->
            <div style="position: absolute; top: 20%; left: 10%; width: 4px; height: 4px; background: #D4AF37; border-radius: 50%; opacity: 0; animation: float-particle 3s ease-in-out infinite;"></div>
            <div style="position: absolute; top: 70%; right: 15%; width: 3px; height: 3px; background: rgba(212, 175, 55, 0.6); border-radius: 50%; opacity: 0; animation: float-particle 3s ease-in-out 0.5s infinite;"></div>
            <div style="position: absolute; bottom: 30%; left: 20%; width: 5px; height: 5px; background: rgba(212, 175, 55, 0.4); border-radius: 50%; opacity: 0; animation: float-particle 3s ease-in-out 1s infinite;"></div>
        </div>
    </div>

    <!-- üé¨ ANIMAZIONI CSS + SCRIPT MESSAGGI DINAMICI -->
    <style>
        @keyframes rotate-slow {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        @keyframes rotate-medium {
            0% { transform: rotate(0deg) scale(1); }
            50% { transform: rotate(180deg) scale(1.1); }
            100% { transform: rotate(360deg) scale(1); }
        }
        
        @keyframes rotate-fast {
            from { transform: rotate(360deg); }
            to { transform: rotate(0deg); }
        }
        
        @keyframes pulse-glow {
            0%, 100% {
                opacity: 0.3;
                transform: scale(1);
            }
            50% {
                opacity: 0.6;
                transform: scale(1.2);
            }
        }
        
        @keyframes expand-line {
            0%, 100% {
                width: 60px;
                opacity: 0.4;
            }
            50% {
                width: 120px;
                opacity: 1;
            }
        }
        
        @keyframes float-particle {
            0% {
                opacity: 0;
                transform: translateY(0px);
            }
            50% {
                opacity: 1;
                transform: translateY(-20px);
            }
            100% {
                opacity: 0;
                transform: translateY(-40px);
            }
        }
    </style>

    <script src="../connection-monitor.js"></script>

    <script>
// üéØ Sistema messaggi dinamici loader TRADOTTO + AGGIORNAMENTO DINAMICO
(function initLoaderMessages() {
    let loaderInterval = null;
    let currentIndex = 0;
    
    // ‚úÖ Funzione per inizializzare/aggiornare i messaggi
    function setupMessages() {
        const i18n = window.i18nPDP && window.i18nPDP();
        if (!i18n) return null;
        
        return [
            i18n.t('booking_loader_msg1'),
            i18n.t('booking_loader_msg2'),
            i18n.t('booking_loader_msg3'),
            i18n.t('booking_loader_msg4'),
            i18n.t('booking_loader_msg5'),
            i18n.t('booking_loader_msg6'),
            i18n.t('booking_loader_msg7')
        ];
    }
    
    // ‚úÖ Funzione per avviare la rotazione messaggi
    function startMessageRotation(messages) {
        const messageEl = document.getElementById('loaderMessage');
        if (!messageEl || !messages) return;
        
        // Ferma rotazione precedente se esiste
        if (loaderInterval) {
            clearInterval(loaderInterval);
        }
        
        // Mostra primo messaggio
        setTimeout(() => {
            messageEl.textContent = messages[currentIndex];
            messageEl.style.opacity = '1';
        }, 300);
        
        // Cambia messaggio ogni 2 secondi
        loaderInterval = setInterval(() => {
            messageEl.style.opacity = '0';
            
            setTimeout(() => {
                currentIndex = (currentIndex + 1) % messages.length;
                messageEl.textContent = messages[currentIndex];
                messageEl.style.opacity = '1';
            }, 600);
        }, 2000);
    }
    
    // ‚úÖ Aspetta che i18n sia pronto e avvia
    function waitForI18n() {
        const messages = setupMessages();
        if (!messages) {
            setTimeout(waitForI18n, 50);
            return;
        }
        
        startMessageRotation(messages);
        
        // Cleanup quando loader viene rimosso
        const observer = new MutationObserver((mutations) => {
            mutations.forEach((mutation) => {
                mutation.removedNodes.forEach((node) => {
                    if (node.id === 'pageLoader') {
                        if (loaderInterval) clearInterval(loaderInterval);
                        observer.disconnect();
                    }
                });
            });
        });
        
        observer.observe(document.body, { childList: true });
    }
    
    // ‚úÖ LISTENER: Aggiorna messaggi al cambio lingua
    document.addEventListener('languageChanged', () => {
        const loader = document.getElementById('pageLoader');
        if (loader && loader.style.display !== 'none') {
            const messages = setupMessages();
            if (messages) {
                currentIndex = 0; // Reset indice
                startMessageRotation(messages);
            }
        }
    });
    
    waitForI18n();
})();
</script>
    
    <div class="container">
        <div class="confirmation-card">
            <div class="category-indicator" id="categoryBadge" data-category="">Immobili</div>
            
            <div class="icon-wrapper">
                <div class="circle-bg">
                    <svg class="checkmark" viewBox="0 0 52 52">
                        <path class="checkmark-path" d="M14 27l10 10L38 15"/>
                    </svg>
                </div>
            </div>
            
            <h1 data-i18n="booking_title">Prenotazione Confermata</h1>
            <p class="subtitle" data-i18n="booking_subtitle">La tua richiesta √® stata registrata con successo</p>
            
            <div class="divider"></div>
            
            <div class="booking-details">
                <div class="detail-item">
                    <div class="detail-label" data-i18n="booking_detail_service">Servizio</div>
                    <div class="detail-value" id="serviceType">Villa Toscana Vista Mare</div>
                </div>
                
                <div class="detail-item">
                    <div class="detail-label" data-i18n="booking_detail_date">Data</div>
                    <div class="detail-value" id="bookingDate">15 Gennaio 2026</div>
                </div>
                
                <div class="detail-item">
                    <div class="detail-label" data-i18n="booking_detail_time">Orario</div>
                    <div class="detail-value" id="bookingPeriod">7 Giorni</div>
                </div>
                
                <div class="detail-item">
                    <div class="detail-label" data-i18n="booking_detail_amount">Importo</div>
                    <div class="detail-value" id="totalAmount">‚Ç¨ 12.500</div>
                </div>
            </div>
            
            <div class="info-section">
                <h3 data-i18n="booking_next_steps_title">Prossimi Passi</h3>
                <p id="nextStepsText">Riceverai una conferma dettagliata via email entro le prossime 24 ore. Il nostro team di concierge personale ti contatter√† per finalizzare ogni aspetto della tua prenotazione e assicurarti un'esperienza impeccabile. Per qualsiasi esigenza immediata, il nostro servizio clienti √® disponibile 24/7.</p>
            </div>
            
            <div class="action-buttons">
                <button class="btn btn-primary" onclick="handleViewDetails()">
                    <span style="position: relative; z-index: 2;" data-i18n="booking_btn_details">Visualizza Dettagli</span>
                </button>
                <button class="btn btn-secondary" onclick="handleReturnHome()">
                    <span style="position: relative; z-index: 2;" data-i18n="booking_btn_home">Torna alla Home</span>
                </button>
            </div>
            
            <div class="booking-number">
                <div class="booking-number-label" data-i18n="booking_code_label">Codice Prenotazione</div>
                <div class="booking-number-value" id="bookingCode">IMB-2026-0184</div>
            </div>
        </div>
    </div>
    
    <script>
        // ========================================
        // üì° RECUPERO DATI DINAMICI DA STRIPE
        // ========================================
        const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbwr79RkXIEocpuOKaM6uMJqE6VFs9wjlUPvrr__FvDbDDrD2ELB1NbfrWP3BCYpHj2u/exec';

        // üåç Salva dati booking per gestione multilingua
        let bookingData = null;

        // ‚úÖ Estrai session_id O booking_id dall'URL
        const urlParams = new URLSearchParams(window.location.search);
        const sessionId = urlParams.get('session_id');
        const bookingId = urlParams.get('booking_id');

        // ‚úÖ Usa booking_id per IMMOBILI, session_id per SUPERCAR/ESPERIENZE
        const identifier = bookingId || sessionId;

        if (!identifier) {
            console.error('‚ùå Nessun identificatore nell\'URL');
            alert('Errore: dati prenotazione non disponibili');
            hideLoader();
        }

        console.log(`üìå Identificatore: ${identifier} (Tipo: ${bookingId ? 'IMMOBILI' : 'STRIPE'})`);

        /**
         * üé¨ Nasconde il loader con transizione premium
         */
        function hideLoader() {
            const loader = document.getElementById('pageLoader');
            if (loader) {
                loader.style.transition = 'opacity 0.6s cubic-bezier(0.4, 0, 0.2, 1)';
                loader.style.opacity = '0';
                
                setTimeout(() => {
                    loader.style.transform = 'scale(0.95)';
                    setTimeout(() => loader.remove(), 300);
                }, 400);
            }
        }

        /**
         * üñºÔ∏è Imposta immagine prodotto come sfondo con overlay scuro elegante
         */
        function setProductBackground(imageUrl) {
            if (!imageUrl) {
                console.log('‚ö†Ô∏è Nessuna immagine prodotto disponibile, mantengo sfondo default');
                return;
            }
            
            console.log('üé® Applicazione sfondo immagine:', imageUrl);
            
            const overlay = document.createElement('div');
            overlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: linear-gradient(
                    135deg, 
                    rgba(10, 10, 10, 0.88) 0%, 
                    rgba(26, 20, 18, 0.85) 40%, 
                    rgba(15, 15, 15, 0.90) 100%
                );
                backdrop-filter: blur(2px);
                z-index: 1;
                pointer-events: none;
            `;
            
            document.body.insertBefore(overlay, document.body.firstChild);
            
            const img = new Image();
            img.onload = function() {
                console.log('‚úÖ Immagine caricata con successo');
                document.body.style.backgroundImage = `url('${imageUrl}')`;
                document.body.style.backgroundSize = 'cover';
                document.body.style.backgroundPosition = 'center';
                document.body.style.backgroundRepeat = 'no-repeat';
                document.body.style.backgroundAttachment = 'fixed';
                
                overlay.style.transition = 'opacity 0.6s ease';
            };
            
            img.onerror = function() {
                console.error('‚ùå Errore caricamento immagine:', imageUrl);
                overlay.remove();
            };
            
            img.src = imageUrl;
            
            const container = document.querySelector('.container');
            if (container) {
                container.style.position = 'relative';
                container.style.zIndex = '10';
            }
        }

        /**
         * ‚úÖ Aggiorna il messaggio "Prossimi Passi" in base alla categoria (TRADOTTO)
         */
        function updateNextStepsMessage(category) {
            const i18n = window.i18nPDP && window.i18nPDP();
            if (!i18n) return;
            
            const messagesMap = {
                'SUPERCAR': 'booking_next_steps_supercars',
                'IMMOBILI': 'booking_next_steps_properties',
                'ESPERIENZE': 'booking_next_steps_experiences'
            };
            
            const messageKey = messagesMap[category] || 'booking_next_steps_experiences';
            const message = i18n.t(messageKey);
            
            const infoSection = document.querySelector('#nextStepsText');
            if (infoSection) {
                infoSection.textContent = message;
            }
        }

        /**
         * ‚úÖ Traduce il badge categoria dinamicamente
         */
        function translateCategoryBadge(category) {
            const i18n = window.i18nPDP && window.i18nPDP();
            if (!i18n) return category;
            
            const categoryMap = {
                'IMMOBILI': 'booking_category_properties',
                'SUPERCAR': 'booking_category_supercars',
                'ESPERIENZE': 'booking_category_experiences'
            };
            
            const key = categoryMap[category];
            return key ? i18n.t(key) : category;
        }

        /**
         * üìÖ Formatta data per visualizzazione (gestisce stringhe E Date objects)
         */
        function formatDateDisplay(dateValue) {
            if (!dateValue) return 'Data da confermare';
            
            if (typeof dateValue === 'string' && !dateValue.includes('GMT') && !dateValue.includes('T')) {
                return dateValue;
            }
            
            try {
                const dateObj = dateValue instanceof Date ? dateValue : new Date(dateValue);
                
                if (isNaN(dateObj.getTime())) {
                    return String(dateValue);
                }
                
                const options = { 
                    day: 'numeric', 
                    month: 'long', 
                    year: 'numeric' 
                };
                
                return dateObj.toLocaleDateString('it-IT', options);
                
            } catch (e) {
                console.error('Errore formattazione data:', e);
                return String(dateValue);
            }
        }

        /**
 * üí∞ Estrae valore numerico da stringa prezzo (es: "‚Ç¨ 12.500" ‚Üí 12500)
 */
function parseAmountString(amountStr) {
    if (!amountStr) return 0;
    const cleaned = amountStr.replace(/[‚Ç¨$¬£\s]/g, '').replace(/\./g, '').replace(',', '.');
    return parseFloat(cleaned) || 0;
}

/**
 * üíµ Formatta prezzo usando sistema i18n
 */
function formatBookingPrice(amount, currency) {
    const i18n = window.i18nPDP && window.i18nPDP();
    if (!i18n) return `‚Ç¨ ${amount.toLocaleString('it-IT')}`;
    
    return i18n.formatPrice(amount, currency);
}

/**
 * üìÖ Formatta data in base alla lingua corrente
 */
function formatBookingDate(dateValue) {
    if (!dateValue) return 'Data da confermare';
    
    const i18n = window.i18nPDP && window.i18nPDP();
    if (!i18n) return formatDateDisplay(dateValue);
    
    // Se √® gi√† formattata (es: "15 Gennaio 2026")
    if (typeof dateValue === 'string' && !dateValue.includes('T') && !dateValue.includes('GMT')) {
        try {
            const match = dateValue.match(/(\d{1,2})\s+(\w+)\s+(\d{4})/);
            if (match) {
                const day = match[1];
                const monthName = match[2].toLowerCase();
                const year = match[3];
                
                const monthKey = `pdp_month_${monthName}`;
                const translatedMonth = i18n.t(monthKey);
                const finalMonth = translatedMonth.charAt(0).toUpperCase() + translatedMonth.slice(1);
                
                return `${day} ${finalMonth} ${year}`;
            }
        } catch (e) {
            console.warn('Errore parsing data:', e);
        }
        return dateValue;
    }
    
    // Se √® Date object o ISO string
    try {
        const date = dateValue instanceof Date ? dateValue : new Date(dateValue);
        if (isNaN(date.getTime())) return String(dateValue);
        
        const day = date.getDate();
        const month = date.getMonth();
        const year = date.getFullYear();
        
        const monthKeys = [
            'pdp_month_gennaio', 'pdp_month_febbraio', 'pdp_month_marzo',
            'pdp_month_aprile', 'pdp_month_maggio', 'pdp_month_giugno',
            'pdp_month_luglio', 'pdp_month_agosto', 'pdp_month_settembre',
            'pdp_month_ottobre', 'pdp_month_novembre', 'pdp_month_dicembre'
        ];
        
        const monthKey = monthKeys[month];
        const translatedMonth = i18n.t(monthKey);
        const finalMonth = translatedMonth.charAt(0).toUpperCase() + translatedMonth.slice(1);
        
        return `${day} ${finalMonth} ${year}`;
    } catch (e) {
        console.error('Errore formattazione data:', e);
        return String(dateValue);
    }
}

/**
 * üîÑ Aggiorna TUTTI i campi dinamici al cambio lingua
 */
function updateAllDynamicFields() {
    const i18n = window.i18nPDP && window.i18nPDP();
    if (!i18n || !bookingData) return;
    
    console.log('üîÑ Aggiornamento campi dinamici per lingua:', i18n.currentLang);
    
    // 1Ô∏è‚É£ Badge Categoria
    const badge = document.getElementById('categoryBadge');
    if (badge) {
        const category = badge.getAttribute('data-category');
        if (category) {
            badge.textContent = translateCategoryBadge(category);
        }
    }
    
    // 2Ô∏è‚É£ Prossimi Passi
    updateNextStepsMessage(bookingData.category);
    
    // 3Ô∏è‚É£ Data
    const dateEl = document.getElementById('bookingDate');
    if (dateEl) {
        const rawDate = dateEl.getAttribute('data-raw-date');
        if (rawDate) {
            dateEl.textContent = formatBookingDate(rawDate);
        }
    }
    
    // 4Ô∏è‚É£ Prezzo
    const amountEl = document.getElementById('totalAmount');
    if (amountEl) {
        const rawAmount = parseFloat(amountEl.getAttribute('data-raw-amount'));
        const currency = amountEl.getAttribute('data-currency') || 'EUR';
        if (rawAmount) {
            amountEl.textContent = formatBookingPrice(rawAmount, currency);
        }
    }

    // 5Ô∏è‚É£ Orario
const timeEl = document.getElementById('bookingPeriod');
if (timeEl) {
  const rawTime = timeEl.getAttribute('data-raw-time');
  if (rawTime) {
    timeEl.textContent = i18n.formatTime(rawTime);
  }
}
    
    // 6Ô∏è‚É£ Labels statiche (gi√† gestite da i18n)
    i18n.translatePage();
    
    console.log('‚úÖ Aggiornamento completato');
}

        // ‚úÖ Chiamata API per recuperare dettagli (INTEGRATA CON TRADUZIONI)
        fetch(`${WEB_APP_URL}?action=get_booking_details&session_id=${identifier}`)
            .then(response => response.json())
            .then(data => {
                if (!data.success) {
                   throw new Error(data.error || 'Errore recupero dati');
                }

                // üíæ SALVA DATI GLOBALMENTE
                bookingData = data;
                // ‚úÖ Assicura campo sku disponibile (da booking_metadata o sku diretto)
                if (!bookingData.sku && data.booking_sku) bookingData.sku = data.booking_sku;
                if (!bookingData.sku && data.metadata && data.metadata.sku) bookingData.sku = data.metadata.sku;

                console.log('‚úÖ Dati booking ricevuti:', data);
                console.log('üñºÔ∏è Immagine prodotto ricevuta:', data.productImage);
                console.log('üìã Categoria:', data.category);
                console.log('üÜî SKU/Codice:', data.code);
                
                // 1Ô∏è‚É£ Badge Categoria (con data attribute)
const badge = document.getElementById('categoryBadge');
badge.setAttribute('data-category', data.category);
badge.textContent = translateCategoryBadge(data.category);

// 2Ô∏è‚É£ Servizio
document.getElementById('serviceType').textContent = data.service;

// 3Ô∏è‚É£ Data (salva raw + formatta)
const dateEl = document.getElementById('bookingDate');
dateEl.setAttribute('data-raw-date', data.date);
dateEl.textContent = formatBookingDate(data.date);

// 4Ô∏è‚É£ Orario (salva raw + formatta)
const timeEl = document.getElementById('bookingPeriod');
timeEl.setAttribute('data-raw-time', data.time);

const i18nInstance = window.i18nPDP && window.i18nPDP();
if (i18nInstance) {
  timeEl.textContent = i18nInstance.formatTime(data.time);
} else {
  timeEl.textContent = data.time || '‚Äî';
}

// 5Ô∏è‚É£ Prezzo (salva numero + formatta)
const amountEl = document.getElementById('totalAmount');
const numericAmount = parseAmountString(data.amount);
amountEl.setAttribute('data-raw-amount', numericAmount);
amountEl.setAttribute('data-currency', 'EUR');
amountEl.textContent = formatBookingPrice(numericAmount, 'EUR');

// 6Ô∏è‚É£ Codice Prenotazione
document.getElementById('bookingCode').textContent = data.code;
                
                // ‚úÖ Aggiorna testo "Prossimi Passi" (TRADOTTO)
                updateNextStepsMessage(data.category);
                
                // ‚úÖ Imposta sfondo con immagine prodotto
                if (data.productImage) {
                    setProductBackground(data.productImage);
                }
                
                // ‚úÖ Nascondi loader dopo caricamento completo
                hideLoader();
                
            })
            .catch(error => {
                console.error('‚ùå Errore caricamento dati:', error);
                hideLoader();
                
                // ‚úÖ Messaggio di errore TRADOTTO
                const i18n = window.i18nPDP && window.i18nPDP();
                const errorTitle = i18n ? i18n.t('booking_error_title') : 'Errore Caricamento Dati';
                const errorMessage = i18n ? i18n.t('booking_error_message') : 'Impossibile recuperare i dettagli della prenotazione.';
                const errorSubmessage = i18n ? i18n.t('booking_error_submessage') : 'Ti preghiamo di contattare il supporto.';
                const errorCta = i18n ? i18n.t('booking_error_cta') : 'Torna alla Home';
                
                document.querySelector('.confirmation-card').innerHTML = `
                    <div style="text-align: center; padding: 60px 40px;">
                        <div style="font-size: 48px; margin-bottom: 20px;">‚ö†Ô∏è</div>
                        <h2 style="color: #ef4444; margin-bottom: 15px;">${errorTitle}</h2>
                        <p style="color: #a1a1aa; margin-bottom: 30px;">
                            ${errorMessage}<br>
                            ${errorSubmessage}
                        </p>
                        <button class="btn btn-primary" onclick="window.location.href='/'">
                            <span style="position: relative; z-index: 2;">${errorCta}</span>
                        </button>
                    </div>
                `;
            });

        function handleViewDetails() {
            // ‚úÖ Recupera SKU dalla sessionStorage (salvato prima del checkout)
            let sku = '';
            let lang = 'it';
            try {
                sku = sessionStorage.getItem('lh360_last_booking_sku') || '';
                lang = sessionStorage.getItem('lh360_last_booking_lang') || localStorage.getItem('lh360_lang') || 'it';
            } catch(e) {}

            // Fallback: usa data.sku dal bookingData se disponibile
            if (!sku && bookingData && bookingData.sku) {
                sku = bookingData.sku;
            }

            if (sku) {
                const baseUrl = window.location.origin + '/luxhaven360-site/product-details/booking.html';
                window.location.href = `${baseUrl}?sku=${encodeURIComponent(sku)}&lang=${lang}`;
            } else {
                // Fallback generico alla pagina prodotti
                window.location.href = 'https://luxhaven360.github.io/luxhaven360-site/';
            }
        }

        function handleReturnHome() {
            window.location.href = 'https://luxhaven360.github.io/luxhaven360-site/';
        }
    </script>
    
    <script>
    // ‚úÖ Inizializza sistema i18n quando DOM √® pronto
    document.addEventListener('DOMContentLoaded', () => {
        // Aspetta che i18nPDP sia disponibile
        function initI18n() {
            const i18n = window.i18nPDP && window.i18nPDP();
            if (!i18n) {
                setTimeout(initI18n, 50);
                return;
            }
            
            console.log(`‚úÖ success-booking.html: Lingua attiva ${i18n.currentLang.toUpperCase()}`);
            
            // Traduci tutti gli elementi con data-i18n
            i18n.translatePage();
        }
        
        initI18n();
    });

    // ‚úÖ Sincronizza cambio lingua con altre pagine
    window.addEventListener('storage', (event) => {
        if (event.key === 'lh360_lang' && event.newValue) {
            const i18n = window.i18nPDP && window.i18nPDP();
            if (i18n && i18n.currentLang !== event.newValue) {
                i18n.changeLanguage(event.newValue);
            }
        }
    });

        // üîÑ LISTENER: Aggiorna contenuti dinamici al cambio lingua
document.addEventListener('languageChanged', (event) => {
    console.log('üåç Evento languageChanged ricevuto:', event.detail.lang);
    updateAllDynamicFields();
});
    </script>
</body>
</html>
