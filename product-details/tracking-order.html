<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>I Tuoi Ordini - LuxHaven360</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(2rem); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes pulse {
            0%, 100% { 
                box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.4);
            }
            50% { 
                box-shadow: 0 0 0 15px rgba(16, 185, 129, 0);
            }
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(to bottom, #09090b, #18181b, #09090b);
            color: #fafafa;
            line-height: 1.6;
            min-height: 100vh;
        }

        .container {
            max-width: 1100px;
            margin: 0 auto;
            padding: 3rem 1.5rem;
        }

        /* Header */
        .header {
            text-align: center;
            margin-bottom: 4rem;
            animation: fadeIn 0.8s ease-out;
        }

        .brand {
            font-size: 0.875rem;
            letter-spacing: 0.3em;
            text-transform: uppercase;
            color: #71717a;
            margin-bottom: 2rem;
        }

        .title {
            font-size: 3rem;
            font-weight: 300;
            letter-spacing: -0.03em;
            margin-bottom: 1rem;
        }

        .subtitle {
            color: #a1a1aa;
            font-size: 1.125rem;
        }

        /* Orders List */
        .orders-list {
            display: flex;
            flex-direction: column;
            gap: 2rem;
        }

        .order-card {
            background: rgba(24, 24, 27, 0.5);
            border: 1px solid rgba(39, 39, 42, 0.6);
            border-radius: 1.5rem;
            padding: 2.5rem;
            backdrop-filter: blur(40px);
            transition: all 0.3s;
            animation: fadeIn 0.8s ease-out both;
        }

        .order-card:nth-child(1) { animation-delay: 0.1s; }
        .order-card:nth-child(2) { animation-delay: 0.2s; }
        .order-card:nth-child(3) { animation-delay: 0.3s; }

        .order-card:hover {
            border-color: rgba(255, 255, 255, 0.1);
            transform: translateY(-4px);
        }

        .order-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 2rem;
            padding-bottom: 1.5rem;
            border-bottom: 1px solid rgba(39, 39, 42, 0.4);
        }

        .order-info h3 {
            font-size: 1.5rem;
            font-weight: 400;
            letter-spacing: -0.01em;
            margin-bottom: 0.5rem;
        }

        .order-date {
            color: #a1a1aa;
            font-size: 0.9375rem;
        }

        .status-badge {
            padding: 0.75rem 1.5rem;
            border-radius: 2rem;
            font-size: 0.875rem;
            font-weight: 500;
            letter-spacing: 0.05em;
            white-space: nowrap;
        }

        .status-badge.transit {
            background: rgba(16, 185, 129, 0.1);
            border: 1px solid rgba(16, 185, 129, 0.3);
            color: #34d399;
        }

        .status-badge.delivered {
            background: rgba(59, 130, 246, 0.1);
            border: 1px solid rgba(59, 130, 246, 0.3);
            color: #60a5fa;
        }

        .status-badge.processing {
            background: rgba(251, 191, 36, 0.1);
            border: 1px solid rgba(251, 191, 36, 0.3);
            color: #fbbf24;
        }

        /* Progress Bar */
        .progress-section {
            margin-bottom: 2rem;
        }

        .progress-steps {
            display: flex;
            justify-content: space-between;
            position: relative;
            margin-bottom: 2rem;
        }

        .progress-steps::before {
            content: '';
            position: absolute;
            top: 1.25rem;
            left: 0;
            right: 0;
            height: 2px;
            background: rgba(39, 39, 42, 0.5);
        }

        .progress-line {
            position: absolute;
            top: 1.25rem;
            left: 0;
            height: 2px;
            background: linear-gradient(90deg, #10b981, #34d399);
            transition: width 1s ease;
        }

        .step {
            position: relative;
            z-index: 2;
            text-align: center;
            flex: 1;
        }

        .step-icon {
            width: 2.5rem;
            height: 2.5rem;
            border-radius: 50%;
            background: rgba(24, 24, 27, 0.8);
            border: 2px solid rgba(39, 39, 42, 0.6);
            margin: 0 auto 0.75rem;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
        }

        .step.completed .step-icon {
            background: linear-gradient(135deg, #10b981, #059669);
            border-color: #10b981;
            color: white;
        }

        .step.active .step-icon {
            background: rgba(16, 185, 129, 0.2);
            border-color: #10b981;
            animation: pulse 2s infinite;
        }

        .step-label {
            font-size: 0.8125rem;
            color: #71717a;
        }

        .step.completed .step-label,
        .step.active .step-label {
            color: #34d399;
        }

        /* Order Details */
        .order-details {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .detail-item {
            background: rgba(9, 9, 11, 0.4);
            padding: 1.5rem;
            border-radius: 1rem;
            border: 1px solid rgba(39, 39, 42, 0.3);
        }

        .detail-label {
            font-size: 0.75rem;
            letter-spacing: 0.1em;
            text-transform: uppercase;
            color: #71717a;
            margin-bottom: 0.5rem;
        }

        .detail-value {
            color: #d4d4d8;
            font-size: 0.9375rem;
        }

        /* Items */
        .order-items {
            margin-bottom: 2rem;
        }

        .items-title {
            font-size: 0.875rem;
            color: #a1a1aa;
            margin-bottom: 1rem;
        }

        .items-list {
            display: flex;
            gap: 1rem;
        }

        .item-image {
            width: 80px;
            height: 100px;
            border-radius: 0.75rem;
            overflow: hidden;
            background: #18181b;
        }

        .item-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        /* Actions */
        .order-actions {
            display: flex;
            gap: 1rem;
        }

        .btn {
            padding: 1rem 1.75rem;
            border-radius: 1rem;
            font-size: 0.9375rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-primary {
            background: white;
            color: #09090b;
        }

        .btn-primary:hover {
            background: #f4f4f5;
            transform: scale(1.02);
        }

        .btn-secondary {
            background: rgba(39, 39, 42, 0.8);
            color: #fafafa;
        }

        .btn-secondary:hover {
            background: #27272a;
            transform: scale(1.02);
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 4rem 0;
            color: #a1a1aa;
        }

        .empty-state h2 {
            font-size: 1.5rem;
            font-weight: 300;
            margin-bottom: 1rem;
        }

        .empty-state p {
            font-size: 1rem;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="brand">LuxHaven360</div>
            <h1 class="title">I Tuoi Ordini</h1>
            <p class="subtitle">Ordini degli ultimi 30 giorni</p>
        </div>

        <div class="orders-list" id="ordersListContainer">
            <div class="empty-state" id="loader">
                <div class="empty-icon">‚è≥</div>
                <h2 class="empty-title">Caricamento ordini...</h2>
                <p class="empty-text">Recupero delle informazioni in corso...</p>
            </div>
            
            </div>
    </div>

    <script>
        // URL della Web App Google Apps Script
        const webAppUrl = 'https://script.google.com/macros/s/AKfycbyiDu50VIVwzJ3qQNCWZmSk-_ovC7iBvxJGUYriRc3-PwMRbsgi8wb0baqxk3nLxti2/exec';
        const ordersListContainer = document.getElementById('ordersListContainer');
        const loader = document.getElementById('loader');

        /**
         * 1. Trova ordini locali da localStorage (salvati da success.html)
         */
        function getLocalOrderKeys() {
            const keys = [];
            try {
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    // Cerca sia le date (lh360_order_time_...) che i dettagli (lh360_order_details_...)
                    if (key && (key.startsWith('lh360_order_time_') || key.startsWith('lh360_order_details_'))) {
                        const orderId = key.replace('lh360_order_time_', '').replace('lh360_order_details_', '').replace('session_', '');
                        const orderDate = localStorage.getItem(`lh360_order_time_${orderId}`) || localStorage.getItem(`lh360_order_time_session_${orderId}`);
                        
                        // Aggiungi solo se non gi√† presente e se abbiamo una data
                        if (orderDate && !keys.some(k => k.id === orderId)) {
                             keys.push({ id: orderId, date: orderDate });
                        }
                    }
                }
            } catch (e) { console.error('Errore lettura localStorage', e); }
            
            // Ordina per data, pi√π recente prima
            keys.sort((a, b) => new Date(b.date) - new Date(a.date));
            return keys;
        }

        /**
         * 2. Fetch dati da Google Script
         */
        function fetchTrackingData(localOrders) {
            if (localOrders.length === 0) {
                renderEmptyState();
                return;
            }
            
            const ids = localOrders.map(o => o.id).join(',');
            const callback = 'handleTrackingResponse';
            const script = document.createElement('script');
            script.src = `${webAppUrl}?action=getTrackingDetails&ids=${encodeURIComponent(ids)}&callback=${callback}`;
            
            script.onerror = () => {
                renderErrorState('Errore di connessione con il server di tracciamento.');
            };
            document.body.appendChild(script);
        }

        /**
         * 3. Callback per JSONP (Req 3, 4, 5)
         */
        window.handleTrackingResponse = function(response) {
            if (loader) loader.style.display = 'none';

            if (!response || !response.success) {
                renderErrorState(response ? response.error : 'Risposta non valida dal server.');
                return;
            }
            
            const localOrders = getLocalOrderKeys(); // Prendi di nuovo per mappare
            const localOrderMap = new Map(localOrders.map(o => [o.id, o]));
            
            if (!response.orders || response.orders.length === 0) {
                renderEmptyState(); // Nessun ordine trovato sul server (magari vecchi)
                return;
            }

            // Unisci dati locali (data, items) e remoti (stato, totale)
            const combinedOrders = response.orders.map(remoteOrder => {
                const localData = localOrderMap.get(remoteOrder.id);
                const cartDataRaw = localStorage.getItem(`lh360_order_details_${remoteOrder.id}`) || localStorage.getItem(`lh360_order_details_session_${remoteOrder.id}`) || '[]';
                let cartData = [];
                try { cartData = JSON.parse(cartDataRaw); } catch(e) {}
                
                let itemCount = 0;
                let images = [];
                if (Array.isArray(cartData)) {
                    cartData.forEach(item => {
                        itemCount += (item.qty || 1);
                        if (item.image) images.push(item.image);
                    });
                }

                return {
                    ...remoteOrder,
                    orderDate: localData ? localData.date : null,
                    itemCount: itemCount,
                    images: images.slice(0, 3) // Max 3 immagini
                };
            }).sort((a, b) => new Date(b.orderDate) - new Date(a.orderDate)); // Ordina di nuovo
            
            // 4. Renderizza
            renderOrders(combinedOrders);
        }

        /**
         * 5. Funzioni di Render
         */
        function renderOrders(orders) {
            ordersListContainer.innerHTML = ''; // Svuota
            if (orders.length === 0) {
                renderEmptyState();
                return;
            }
            orders.forEach((order, index) => {
                const card = createOrderCard(order);
                // Applica delay animazione come nell'originale statico
                card.style.animationDelay = `${(index + 1) * 0.1}s`;
                ordersListContainer.appendChild(card);
            });
        }
        
        function renderEmptyState() {
            if (loader) loader.style.display = 'none';
            ordersListContainer.innerHTML = `
                <div class="empty-state" style="text-align: center; padding: 6rem 2rem;">
                    <div class="empty-icon">üì¶</div>
                    <h2 class="empty-title">Nessun ordine attivo</h2>
                    <p class="empty-text">Non ci sono ordini recenti (ultimi 30 giorni) da tracciare.</p>
                    <a href="https://luxhaven360.github.io/luxhaven360-site/index.html#shop" class="btn btn-primary">Torna allo Shop</a>
                </div>
            `;
        }
        
        function renderErrorState(message) {
            if (loader) loader.style.display = 'none';
            ordersListContainer.innerHTML = `<div class="empty-state" style="text-align: center; padding: 6rem 2rem;"><h2 class="empty-title">Errore</h2><p class="empty-text">${message}</p></div>`;
        }

        /**
         * 6. Funzione per creare una card (Req 3, 4, 5)
         */
        function createOrderCard(order) {
            const card = document.createElement('div');
            card.className = 'order-card';
            
            // Helpers per info dinamiche
            const { statusBadge, statusClass } = getStatusInfo(order.stato);
            const { progressPercent, activeStep } = getProgressInfo(order.stato, order.orderDate, order.consegna_prevista);
            const buttons = getButtonInfo(order.stato);
            
            const orderDateFormatted = order.orderDate ? new Date(order.orderDate).toLocaleDateString('it-IT', { day: 'numeric', month: 'long', year: 'numeric' }) : 'Data non disponibile';
            
            // Gestisce Totale (che arriva come stringa "123.45 ‚Ç¨" o numero)
            let totalString = 'N/D';
            if (typeof order.totale === 'string' && order.totale.includes('‚Ç¨')) {
                totalString = order.totale;
            } else if (typeof order.totale === 'number') {
                totalString = `‚Ç¨ ${order.totale.toLocaleString('it-IT', {minimumFractionDigits: 2})}`;
            } else if (order.totale) { // Altra stringa
                 totalString = order.totale;
            }

            const itemsLabel = order.itemCount === 0 ? 'N/D' : (order.itemCount === 1 ? '1 articolo' : `${order.itemCount} articoli`);
            
            // Immagini
            let imagesHTML = order.images.map(imgSrc => `
                <div class="item-image">
                    <img src="${imgSrc}" alt="Prodotto">
                </div>
            `).join('');
            if (order.images.length === 0) {
                imagesHTML = `<div class="items-title" style="font-size: 0.8em; color: #71717a;">Dettagli prodotto non disponibili</div>`;
            }

            // HTML Card
            card.innerHTML = `
                <div class="order-header">
                    <div class="order-info">
                        <h3>${order.id}</h3>
                        <div class="order-date">${orderDateFormatted}</div>
                    </div>
                    <div class="status-badge ${statusClass}">${statusBadge}</div>
                </div>

                <div class="progress-section">
                    <div class="progress-steps">
                    <div class="progress-line" style="width: ${progressPercent}%;"></div>
                    <div class="step ${activeStep >= 0 ? 'completed' : ''} ${activeStep === 0 ? 'active' : ''}">
                        <div class="step-icon">${activeStep > 0 ? '‚úì' : 'üìù'}</div>
                        <div class="step-label">Confermato</div>
                    </div>
                    <div class="step ${activeStep >= 1 ? 'completed' : ''} ${activeStep === 1 ? 'active' : ''}">
                        <div class="step-icon">${activeStep > 1 ? '‚úì' : 'üì¶'}</div>
                        <div class="step-label">Preparato</div>
                    </div>
                    <div class="step ${activeStep >= 2 ? 'completed' : ''} ${activeStep === 2 ? 'active' : ''}">
                        <div class="step-icon">${activeStep > 2 ? '‚úì' : 'üöö'}</div>
                        <div class="step-label">In Viaggio</div>
                    </div>
                    <div class="step ${activeStep >= 3 ? 'completed' : ''} ${activeStep === 3 ? 'active' : ''}">
                        <div class="step-icon">${activeStep === 3 ? '‚úì' : 'üè†'}</div>
                        <div class="step-label">Consegnato</div>
                      </div>
                   </div>
                </div>

                <div class="order-details">
                    <div class="detail-item">
                        <div class="detail-label">${order.stato === 'Consegnato' ? 'Consegnato il' : 'Consegna Prevista'}</div>
                        <div class="detail-value">${order.consegna_prevista || 'Da definire'}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Articoli</div>
                        <div class="detail-value">${itemsLabel}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Totale</div>
                        <div class="detail-value">${totalString}</div>
                    </div>
                </div>

                <div class="order-items">
                    <div class="items-title">Articoli ordinati</div>
                    <div class="items-list">
                        ${imagesHTML}
                    </div>
                </div>

                <div class="order-actions">
                    ${buttons.primary}
                    ${buttons.secondary}
                </div>
            `;
            return card;
        }

        /**
         * Helper per stato (Req 3)
         */
        function getStatusInfo(stato) {
            switch (stato) {
                case 'In Transito': return { statusBadge: 'In Transito', statusClass: 'transit' };
                case 'Consegnato': return { statusBadge: 'Consegnato', statusClass: 'delivered' };
                case 'In Preparazione': return { statusBadge: 'In Preparazione', statusClass: 'processing' };
                case 'Confermato': return { statusBadge: 'Confermato', statusClass: 'processing' };
                default: return { statusBadge: stato || 'In Elaborazione', statusClass: 'processing' };
            }
        }
        
        /**
         * Helper per barra progresso (Logica Ibrida Stato + Tempo)
         * - activeStep: lo step corrente (0, 1, 2, 3)
         * - progressPercent: la percentuale riempita della barra
         */
        function getProgressInfo(stato, orderDateStr, deliveryDateStr) {
            const stepMap = { 'Confermato': 0, 'In Preparazione': 1, 'In Transito': 2, 'Consegnato': 3 };
            let activeStep = stepMap[stato] !== undefined ? stepMap[stato] : 0;
            let progressPercent = 0;
            
            // Definisci la percentuale minima per ogni step completato
            const basePercents = [0, 33, 66, 100];
            
            // 1. Se Consegnato, √® sempre 100% e step 3
            if (stato === 'Consegnato') {
                return { progressPercent: 100, activeStep: 3 };
            }
            
            // 2. Se l'ordine non √® ancora "In Transito" (cio√® Confermato o In Preparazione)
            if (activeStep <= 1) {
                // Calcola l'avanzamento tra l'ordine e la fase di preparazione
                // (Esempio: assume che la preparazione duri 7 giorni se non specificato)
                try {
                    const start = new Date(orderDateStr).getTime();
                    // Assumiamo che la preparazione duri max 7 giorni (604800000ms) se non √® gi√† 'In Preparazione'
                    const targetEnd = start + (activeStep === 0 ? (7 * 24 * 60 * 60 * 1000) : 0);
                    const now = Date.now();
                    
                    if (!isNaN(start) && targetEnd > start && activeStep < 1) {
                         const totalDuration = targetEnd - start;
                         const elapsed = now - start;
                         // Progresso solo tra il 0% e 33% (fase 0)
                         progressPercent = Math.min(33, (elapsed / totalDuration) * 33);
                         // Blocca al minimo 10% per un feedback visivo immediato
                         progressPercent = Math.max(10, progressPercent);
                    } else {
                         // Ordine Confermato / In Preparazione, usa la percentuale base
                         progressPercent = basePercents[activeStep];
                    }
                } catch (e) {
                    // Fallback se date non valide
                    progressPercent = basePercents[activeStep];
                }
                
            } else if (activeStep === 2) { 
                // 3. Fase "In Viaggio" (tra 66% e 100%)
                try {
                    const start = new Date(orderDateStr).getTime();
                    const end = parseItalianDate(deliveryDateStr).getTime();
                    const now = Date.now();
                    
                    if (!isNaN(start) && !isNaN(end) && end > start) {
                        const totalDuration = end - start;
                        const elapsed = now - start;
                        
                        // Calcola progresso totale e lo normalizza tra 66% e 99%
                        progressPercent = Math.max(66, Math.min(99, (elapsed / totalDuration) * 100));
                    } else {
                        progressPercent = basePercents[activeStep]; // Usa 66% se la data di consegna √® ignota
                    }
                } catch (e) {
                    progressPercent = basePercents[activeStep];
                }
            }
            
            return { progressPercent, activeStep };
        }

        function parseItalianDate(dateStr) {
            if (!dateStr) throw new Error('Data non valida');
            const months = {
                'gennaio': 0, 'febbraio': 1, 'marzo': 2, 'aprile': 3, 'maggio': 4, 'giugno': 5,
                'luglio': 6, 'agosto': 7, 'settembre': 8, 'ottobre': 9, 'novembre': 10, 'dicembre': 11
            };
            const parts = String(dateStr).split(' '); // "dd MMMM yyyy"
            if (parts.length >= 3) {
                const day = parseInt(parts[0], 10);
                const month = months[parts[1].toLowerCase()];
                const year = parseInt(parts[2], 10);
                if (!isNaN(day) && month !== undefined && !isNaN(year)) {
                    return new Date(year, month, day);
                }
            }
            // Fallback per date ISO o altri formati
            const isoDate = new Date(dateStr);
            if (!isNaN(isoDate.getTime())) return isoDate;
            throw new Error('Formato data non riconosciuto');
        }
        
        /**
         * Helper per bottoni (Req 4)
         */
        function getButtonInfo(stato) {
            let primary = '', secondary = '';
            // Link statici per i pulsanti (puntano allo shop o a se stessi)
            const shopLink = 'https://luxhaven360.github.io/luxhaven360-site/index.html#shop';
            
            switch (stato) {
                case 'In Transito':
                    primary = `<a href="#" class="btn btn-primary"><span>Traccia Spedizione</span><span>‚Üí</span></a>`;
                    secondary = `<a href="#" class="btn btn-secondary">Dettagli</a>`;
                    break;
                case 'Consegnato':
                    primary = `<a href="${shopLink}" class="btn btn-primary"><span>Acquista di Nuovo</span></a>`;
                    secondary = `<a href="#" class="btn btn-secondary">Lascia Recensione</a>`;
                    break;
                case 'In Preparazione':
                case 'Confermato':
                default:
                    primary = `<a href="#" class="btn btn-primary"><span>Dettagli Ordine</span><span>‚Üí</span></a>`;
                    secondary = `<a href="#" class="btn btn-secondary">Contatta Supporto</a>`;
                    break;
            }
            return { primary, secondary };
        }

        /**
         * 7. Avvia il refresh automatico dei dati ogni 30 secondi
         */
        function startAutoRefresh() {
            // Aggiorna i dati immediatamente
            const localOrders = getLocalOrderKeys();
            fetchTrackingData(localOrders);

            // Poi imposta un timer per aggiornare i dati ogni 30 secondi
            setInterval(() => {
                console.log('Aggiornamento automatico dei dati di tracciamento...');
                const currentLocalOrders = getLocalOrderKeys();
                fetchTrackingData(currentLocalOrders);
            }, 30000); // 30000 millisecondi = 30 secondi
        }

        /**
         * 8. Avvio Iniziale e Refresh
         */
        document.addEventListener('DOMContentLoaded', () => {
            // Avvia il ciclo di refresh automatico
            startAutoRefresh();
        });
        
    </script>
</body>
</html>
