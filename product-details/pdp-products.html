<!DOCTYPE html>
<html lang="it">
<head>
    <script src="../error-handler.js"></script>
<script src="../siteguard-client.js"></script>
    <meta charset="utf-8" />
    <!-- PERFORMANCE: preconnect GAS -->
    <link rel="preconnect" href="https://script.google.com" crossorigin>
    <link rel="dns-prefetch" href="https://www.google.com">
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Dettaglio Prodotto</title>
    <!-- Connection Monitor Styles -->
    <link rel="stylesheet" href="../connection-monitor.css" />

    <!-- Sistema i18n -->
<script src="../translations.js"></script>
<script src="translations-pdp.js"></script>
<script src="translations-descriptions.js"></script>
<script src="i18n-pdp.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(to bottom, #09090b, #18181b, #09090b);
            color: #fafafa;
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 3rem 1.5rem;
        }

        .product-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 4rem;
            margin-bottom: 6rem;
        }

        /* Gallery Section */
        .gallery {
            position: sticky;
            top: 2rem;
        }

        .main-image {
            position: relative;
            aspect-ratio: 3/4;
            background: #18181b;
            border-radius: 1.5rem;
            overflow: hidden;
            margin-bottom: 1.5rem;
            cursor: zoom-in;
        }

        .main-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.7s ease;
        }

        .main-image:hover img {
            transform: scale(1.05);
        }

        .nav-btn {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            width: 3rem;
            height: 3rem;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
            border: none;
            border-radius: 50%;
            color: white;
            cursor: pointer;
            opacity: 0;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .main-image:hover .nav-btn {
            opacity: 1;
        }

        .nav-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .nav-btn.prev { left: 1rem; }
        .nav-btn.next { right: 1rem; }

        .heart-btn {
            position: absolute;
            top: 1.5rem;
            right: 1.5rem;
            width: 3rem;
            height: 3rem;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
            border: none;
            border-radius: 50%;
            color: white;
            cursor: pointer;
            transition: all 0.3s;
        }

        .heart-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: scale(1.1);
        }

        .thumbnails {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 1rem;
        }

        .thumbnail {
            aspect-ratio: 1;
            border-radius: 0.75rem;
            overflow: hidden;
            cursor: pointer;
            opacity: 0.6;
            transition: all 0.3s;
            border: 2px solid transparent;
        }

        .thumbnail:hover {
            opacity: 1;
        }

        .thumbnail.active {
            opacity: 1;
            border-color: white;
            transform: scale(1.05);
        }

        .thumbnail img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        /* Product Info */
        .product-info {
            padding-top: 2rem;
        }

        h1 {
            font-size: 3rem;
            font-weight: 300;
            letter-spacing: -0.02em;
            margin-bottom: 1rem;
        }

        /* Rating Display (Solo Stelle Piene) */
        .rating {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .stars {
            display: flex;
            gap: 0.25rem;
            color: #fbbf24;
        }

        .star {
            font-size: 1.25rem;
        }

        .star-empty {
            color: #27272a; /* Colore stella vuota piÃ¹ scuro per contrasto */
        }

        .rating-text {
            color: #a1a1aa;
        }

        /* === SISTEMA SCONTI PREMIUM === */

/* Container prezzi con sconto */
.price-container {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
    margin-bottom: 1rem;
}

/* Prezzo originale barrato */
.price-original {
    font-size: 1.125rem;
    color: #71717a;
    text-decoration: line-through;
    font-weight: 300;
    letter-spacing: 0.01em;
}

/* Prezzo scontato evidenziato */
.price-discounted {
    font-size: 1.75rem;
    font-weight: 300;
    letter-spacing: 0.02em;
    background: linear-gradient(135deg, #D4AF37, #FFD700);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
}

/* Badge sconto percentuale */
.discount-badge {
    display: inline-block;
    background: linear-gradient(135deg, #D4AF37, #FFD700);
    color: #09090b;
    padding: 0.375rem 0.875rem;
    border-radius: 2rem;
    font-size: 0.875rem;
    font-weight: 600;
    letter-spacing: 0.05em;
    box-shadow: 0 4px 12px rgba(212, 175, 55, 0.3);
    margin-left: 0.75rem;
}

/* Layout orizzontale prezzo + badge */
.price-row {
    display: flex;
    align-items: center;
}

/* Fallback per prodotti senza sconto */
.price {
    font-size: 1.5rem;
    font-weight: 300;
    letter-spacing: 0.02em;
    margin-bottom: 1rem;
}

        .description {
            color: #a1a1aa;
            font-size: 1.125rem;
            line-height: 1.7;
            margin-bottom: 1.5rem;
        }

        /* ============================================================
           DESCRIZIONE LUNGA â€” SISTEMA TIPOGRAFICO LUXURY
           ============================================================ */

        /* Contenitore globale */
        #longDescription {
            padding-bottom: 0.5rem;
        }

        /* â”€â”€ Hook / frase singola in evidenza â”€â”€ */
        .desc-single {
            font-weight: 700;
            color: #fafafa;
            font-size: 1.175rem;
            line-height: 1.65;
            letter-spacing: -0.01em;
            margin-top: 2em;
            margin-bottom: 2em;
        }

        .desc-single:first-child {
            margin-top: 0;
        }

        /* Ultima di una coppia seguita da paragrafo â†’ margine inferiore azzerato */
        .desc-single.tight-bottom {
            margin-bottom: 0;
        }

        /* â”€â”€ Paragrafo corpo â”€â”€ */
        .desc-para {
            color: #c4c4c8;
            font-size: 1.0625rem;
            line-height: 1.8;
            margin-top: 1.25em;
            margin-bottom: 1.25em;
        }

        .desc-para:first-child {
            margin-top: 0;
        }

        /* Paragrafo subito dopo coppia di hook â†’ nessun margine sopra aggiuntivo */
        .desc-para.tight-top {
            margin-top: 0;
        }

        /* â”€â”€ Separatore decorativo tra macro-sezioni â”€â”€ */
        .desc-divider {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin: 2.25em 0 2em;
        }

        .desc-divider::before,
        .desc-divider::after {
            content: '';
            flex: 1;
            height: 1px;
            background: linear-gradient(to right, transparent, rgba(212,175,55,0.35), transparent);
        }

        .desc-divider-dot {
            width: 5px;
            height: 5px;
            border-radius: 50%;
            background: rgba(212,175,55,0.55);
            flex-shrink: 0;
        }

        /* â”€â”€ Intestazione sezione lista â”€â”€ */
        .desc-list-header {
            font-weight: 700;
            color: #fafafa;
            font-size: 1.0625rem;
            line-height: 1.6;
            letter-spacing: 0.01em;
            margin-top: 2em;
            margin-bottom: 0.75em;
        }

        /* â”€â”€ Lista bullet premium â”€â”€ */
        .desc-list {
            list-style: none;
            padding-left: 0;
            color: #c4c4c8;
            font-size: 1.0rem;
            line-height: 1.75;
            margin-top: 0;
            margin-bottom: 1.75em;
        }

        .desc-list li {
            display: flex;
            align-items: baseline;
            gap: 0.6rem;
            margin-bottom: 0.45em;
            padding-left: 0.1rem;
        }

        .desc-list li::before {
            content: 'â€”';
            color: rgba(212,175,55,0.7);
            font-weight: 300;
            font-size: 0.9em;
            flex-shrink: 0;
            line-height: 1.75;
        }

        /* â”€â”€ Riga in corsivo (grammatura, edizione, ecc.) â”€â”€ */
        .desc-italic {
            font-style: italic;
            color: #8e8e96;
            font-size: 0.9875rem;
            line-height: 1.7;
            margin-top: 1.5em;
            margin-bottom: 1.5em;
        }

        /* â”€â”€ Nota sulle taglie â”€â”€ */
        .desc-size-note {
            font-style: italic;
            color: #7dd3fc;
            font-size: 0.9625rem;
            line-height: 1.7;
            margin-top: 2em;
            margin-bottom: 0;
            padding: 0.9em 1.1em;
            background: rgba(125, 211, 252, 0.05);
            border-left: 2px solid rgba(125, 211, 252, 0.4);
            border-radius: 0 6px 6px 0;
        }

        .desc-size-note strong {
            font-weight: 600;
            font-style: italic;
        }

        /* â”€â”€ Premium Delivery Estimator â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .delivery-estimator {
            display: flex;
            align-items: flex-start;
            gap: 1rem;
            padding: 1rem 1.25rem;
            background: rgba(212, 175, 55, 0.04);
            border: 1px solid rgba(212, 175, 55, 0.15);
            border-radius: 0.875rem;
            margin-bottom: 2rem;
            position: relative;
            overflow: hidden;
            transition: border-color 0.3s;
        }

        .delivery-estimator::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0;
            height: 1px;
            background: linear-gradient(90deg, transparent, rgba(212,175,55,0.5), transparent);
        }

        .delivery-estimator__icon {
            font-size: 1.375rem;
            line-height: 1;
            flex-shrink: 0;
            margin-top: 0.125rem;
            filter: drop-shadow(0 0 8px rgba(212,175,55,0.3));
        }

        .delivery-estimator__body {
            flex: 1;
            min-width: 0;
        }

        .delivery-estimator__label {
            font-size: 0.6875rem;
            font-weight: 600;
            letter-spacing: 0.12em;
            text-transform: uppercase;
            color: rgba(212, 175, 55, 0.7);
            margin-bottom: 0.3rem;
        }

        .delivery-estimator__time {
            font-size: 1rem;
            font-weight: 300;
            color: #fafafa;
            letter-spacing: 0.01em;
            line-height: 1.45;
        }

        .delivery-estimator__time strong {
            font-weight: 500;
            color: #fff;
        }

        .delivery-estimator__note {
            font-size: 0.7rem;
            color: #a1a1aa;
            margin-top: 0.4rem;
            line-height: 1.5;
            font-style: italic;
        }

        .delivery-estimator--loading .delivery-estimator__icon {
            animation: pulse-icon 1.4s ease-in-out infinite;
        }

        .delivery-estimator--tbd .delivery-estimator__icon { opacity: 0.5; }

        @keyframes pulse-icon {
            0%, 100% { opacity: 0.4; }
            50%       { opacity: 1; }
        }
  
        .section {
            margin-bottom: 2rem;
        }

        .section-title {
            font-size: 0.875rem;
            font-weight: 500;
            letter-spacing: 0.1em;
            text-transform: uppercase;
            color: #a1a1aa;
            margin-bottom: 1rem;
        }

        /* Color Selection */
        .color-options {
            display: flex;
            gap: 0.75rem;
        }

        .color-btn {
            width: 3.5rem;
            height: 3.5rem;
            border-radius: 50%;
            border: none;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
        }

        .color-btn:hover {
            transform: scale(1.05);
        }

        .color-btn.active {
            box-shadow: 0 0 0 2px #09090b, 0 0 0 4px white;
            transform: scale(1.1);
        }

        .color-btn.active::after {
            content: 'âœ“';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 1.25rem;
        }

        /* Size Selection */
        .size-grid {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 0.75rem;
        }

        .size-btn {
            padding: 0.75rem;
            border-radius: 0.75rem;
            border: none;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 1rem;
            font-weight: 400;
            background: rgba(39, 39, 42, 0.5);
            color: #d4d4d8;
        }

        .size-btn:hover {
            background: #27272a;
        }

        .size-btn.active {
            background: white;
            color: #09090b;
            font-weight: 500;
        }

        /* CTA Buttons */
        .cta-buttons {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            margin: 2rem 0;
        }

        .btn {
            padding: 1.25rem;
            border-radius: 1rem;
            border: none;
            font-size: 1.125rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.75rem;
        }

        .btn-primary {
            background: white;
            color: #09090b;
        }

        .btn-primary:hover {
            background: #f4f4f5;
            transform: scale(1.02);
        }

        .btn-secondary {
            background: rgba(39, 39, 42, 0.5);
            color: white;
        }

        .btn-secondary:hover {
            background: #27272a;
        }

        /* Trust Badges */
        .trust-badges {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
            padding-top: 1.5rem;
            border-top: 1px solid #27272a;
        }

        .badge {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            gap: 0.5rem;
        }

        .badge-icon {
            color: #a1a1aa;
            font-size: 1.5rem;
        }

        .badge-text {
            font-size: 0.75rem;
            color: #a1a1aa;
        }

        /* â”€â”€ Refund Policy Box â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .refund-policy {
            margin-top: 1.75rem;
            border: 1px solid #27272a;
            border-radius: 1rem;
            background: #111113;
            overflow: hidden;
        }

        .refund-policy__header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 1rem 1.25rem;
            cursor: pointer;
            user-select: none;
            border-bottom: 1px solid transparent;
            transition: border-color 0.25s;
        }

        .refund-policy.open .refund-policy__header {
            border-color: #27272a;
        }

        .refund-policy__icon {
            width: 1.75rem;
            height: 1.75rem;
            border-radius: 50%;
            background: #1c1c1f;
            border: 1px solid #3f3f46;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            font-size: 0.8rem;
        }

        .refund-policy__title {
            font-size: 0.8125rem;
            font-weight: 600;
            letter-spacing: 0.06em;
            text-transform: uppercase;
            color: #d4d4d8;
            flex: 1;
        }

        .refund-policy__chevron {
            color: #52525b;
            font-size: 0.7rem;
            transition: transform 0.25s ease;
        }

        .refund-policy.open .refund-policy__chevron {
            transform: rotate(180deg);
        }

        .refund-policy__body {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.35s ease;
        }

        .refund-policy.open .refund-policy__body {
            max-height: 600px;
        }

        .refund-policy__inner {
            padding: 1.25rem 1.25rem 1.5rem;
            display: grid;
            gap: 1rem;
        }

        .refund-policy__block {
            display: flex;
            gap: 0.75rem;
            align-items: flex-start;
        }

        .refund-policy__dot {
            width: 0.35rem;
            height: 0.35rem;
            border-radius: 50%;
            margin-top: 0.5rem;
            flex-shrink: 0;
        }

        .refund-policy__dot--green  { background: #4ade80; }
        .refund-policy__dot--red    { background: #f87171; }
        .refund-policy__dot--amber  { background: #fbbf24; }

        .refund-policy__block-text {
            font-size: 0.8125rem;
            color: #a1a1aa;
            line-height: 1.65;
        }

        .refund-policy__block-text strong {
            color: #d4d4d8;
            font-weight: 600;
        }

        .refund-policy__steps {
            margin-top: 0.4rem;
            padding-left: 0;
            list-style: none;
            display: flex;
            flex-direction: column;
            gap: 0.35rem;
        }

        .refund-policy__steps li {
            display: flex;
            gap: 0.6rem;
            font-size: 0.8125rem;
            color: #a1a1aa;
            line-height: 1.55;
        }

        .refund-policy__step-num {
            width: 1.15rem;
            height: 1.15rem;
            border-radius: 50%;
            background: #1c1c1f;
            border: 1px solid #3f3f46;
            font-size: 0.625rem;
            color: #fbbf24;
            font-weight: 700;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            margin-top: 0.15rem;
        }

        /* Tabs Section */
        .tabs-section {
            margin-top: 6rem;
        }

        .tabs {
            display: flex;
            gap: 2rem;
            border-bottom: 1px solid #27272a;
            margin-bottom: 2rem;
        }

        .tab {
            padding: 1rem 0;
            background: none;
            border: none;
            color: #71717a;
            font-size: 1.125rem;
            cursor: pointer;
            position: relative;
            transition: color 0.3s;
        }

        .tab:hover {
            color: #d4d4d8;
        }

        .tab.active {
            color: white;
        }

        .tab.active::after {
            content: '';
            position: absolute;
            bottom: -1px;
            left: 0;
            right: 0;
            height: 2px;
            background: white;
        }

        .tab-content {
            display: none;
            padding: 2rem 0;
            max-width: 900px;
        }

        .tab-content.active {
            display: block;
        }

        .tab-content p {
            margin-bottom: 1.5rem;
            color: #d4d4d8;
            line-height: 1.7;
        }

        .tab-content h4 {
            margin-top: 2rem;
            margin-bottom: 1rem;
            font-size: 1.125rem;
            font-weight: 500;
        }

        .tab-content ul {
            list-style: none;
        }

        .tab-content ul li {
            padding: 0.25rem 0;
            color: #d4d4d8;
            font-size: 0.875rem;
        }

        /* Specs Table */
        .specs-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 2rem 4rem;
            margin-bottom: 3rem;
        }

        .spec-row {
            display: flex;
            justify-content: space-between;
            padding-bottom: 0.75rem;
            border-bottom: 1px solid #27272a;
        }

        .spec-label {
            color: #a1a1aa;
        }

        .size-table {
            width: 100%;
            margin-top: 2rem;
            border-collapse: collapse;
        }

        .size-table th {
            text-align: left;
            padding-bottom: 0.75rem;
            border-bottom: 1px solid #27272a;
            color: #a1a1aa;
            font-weight: 500;
            font-size: 0.875rem;
        }

        .size-table td {
            padding: 0.75rem 0;
            border-bottom: 1px solid rgba(39, 39, 42, 0.5);
        }

        .size-table th:not(:first-child),
        .size-table td:not(:first-child) {
            text-align: center;
        }

        /* --- AGGIUNTA: STILE CUORE ATTIVO --- */
.heart-btn.active {
    color: #ef4444; /* Rosso vivo */
    background: rgba(255, 255, 255, 0.2);
    transform: scale(1.1);
    border: 1px solid rgba(239, 68, 68, 0.3);
}

/* --- AGGIUNTA: STILE PREMIUM "NESSUNA SPECIFICA" --- */
.no-specs-container {
    padding: 3rem 2rem;
    text-align: center;
    background: linear-gradient(135deg, rgba(212, 175, 55, 0.05) 0%, rgba(0, 0, 0, 0) 100%);
    border: 1px solid rgba(212, 175, 55, 0.2);
    border-radius: 1rem;
    margin-top: 1rem;
}

.no-specs-icon {
    font-size: 2rem;
    color: #D4AF37;
    margin-bottom: 1rem;
    animation: pulseGold 3s infinite ease-in-out;
}

.no-specs-title {
    font-family: serif; /* Font elegante */
    font-size: 1.5rem;
    color: #D4AF37;
    margin-bottom: 0.5rem;
    letter-spacing: 0.05em;
}

.no-specs-text {
    font-size: 0.95rem;
    color: #a1a1aa;
    font-weight: 300;
}

@keyframes pulseGold {
    0%, 100% { opacity: 0.5; transform: scale(1); }
    50% { opacity: 1; transform: scale(1.1); }
}

        /* ============================================
           RECENSIONI - STILI PREMIUM
           ============================================ */
        
        /* Overview recensioni */
        .reviews-summary {
            display: flex;
            gap: 3rem;
            padding-bottom: 2rem;
            border-bottom: 1px solid #27272a;
            margin-bottom: 2rem;
        }

/* 3. Fix Allineamento Stelle Mobile vs Desktop */

/* Desktop default: Rating overview giÃ  gestito, ma forziamo il layout */
.rating-overview {
    text-align: center; /* Default fallback */
}

.rating-overview .stars {
    justify-content: center; /* Assicura che le stelle siano centrate nel loro container flex */
    margin-top: 0.5rem;
}

        .rating-number {
            font-size: 3rem;
            font-weight: 300;
            margin-bottom: 0.5rem;
        }

        .rating-bars {
            flex: 1;
        }

        .rating-bar {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 0.5rem;
        }

        .rating-bar-label {
            width: 4rem;
            font-size: 0.875rem;
            color: #a1a1aa;
        }

        .rating-bar-track {
            flex: 1;
            height: 0.5rem;
            background: #27272a;
            border-radius: 9999px;
            overflow: hidden;
        }

        .rating-bar-fill {
            height: 100%;
            background: #fbbf24;
            border-radius: 9999px;
            transition: width 0.5s;
        }

        /* Form recensioni premium */
        .review-form-container {
            background: linear-gradient(135deg, #18181b, #0f0f0f);
            border: 1px solid #27272a;
            border-radius: 1.5rem;
            padding: 2.5rem;
            margin-bottom: 3rem;
        }

        .review-form-title {
            font-size: 1.75rem;
            font-weight: 300;
            margin-bottom: 0.5rem;
            color: #D4AF37;
        }

        .review-form-subtitle {
            font-size: 0.875rem;
            color: #a1a1aa;
            margin-bottom: 2rem;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-label {
            display: block;
            font-size: 0.875rem;
            font-weight: 500;
            color: #d4d4d8;
            margin-bottom: 0.5rem;
        }

        .form-input,
        .form-textarea {
            width: 100%;
            padding: 0.875rem 1rem;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid #27272a;
            border-radius: 0.75rem;
            color: #fafafa;
            font-size: 1rem;
            transition: all 0.3s;
        }

        .form-input:focus,
        .form-textarea:focus {
            outline: none;
            border-color: #D4AF37;
            background: rgba(0, 0, 0, 0.5);
        }

        .form-textarea {
            resize: vertical;
            min-height: 120px;
            font-family: inherit;
        }

        /* --- AGGIUNTA CSS PER STELLE MOBILE E FIX GRAFICI --- */

/* Rimuove highlight tap su mobile */
.rating-selector, 
.rating-star {
    -webkit-tap-highlight-color: transparent;
    outline: none;
    user-select: none;
    -webkit-user-select: none;
}

/* Stile base stelle */
.rating-selector {
    display: flex;
    gap: 0.5rem;
    cursor: pointer;
    touch-action: manipulation; /* Migliora risposta touch */
}

.rating-star {
    font-size: 2rem;
    color: #27272a;
    transition: color 0.2s, transform 0.1s; /* Animazione piÃ¹ veloce */
    display: inline-block;
    line-height: 1;
}

/* Rimuovi completamente effetto hover su dispositivi touch se necessario */
@media (hover: hover) {
    .rating-star:hover {
        transform: scale(1.15);
    }
}

        .rating-star.full {
            color: #fbbf24;
        }
        
        /* Rimuoviamo completamente lo stile .half */

        .rating-star:hover {
            transform: scale(1.15);
        }

        /* Stelle compatte lista recensioni */
        .stars-compact {
            letter-spacing: 1px;
            color: #fbbf24;
            font-size: 1.1rem;
        }
        .stars-compact .empty {
            color: #27272a;
        }
        .rating-star.active {
            color: #fbbf24;
            transform: scale(1.1);
        }

        .btn-submit-review {
            background: linear-gradient(135deg, #D4AF37, #FFD700);
            color: #09090b;
            padding: 1rem 2rem;
            border-radius: 0.75rem;
            border: none;
            font-size: 1.125rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 1rem;
        }

        .btn-submit-review:hover {
            transform: scale(1.02);
            box-shadow: 0 8px 20px rgba(212, 175, 55, 0.4);
        }

        .btn-submit-review:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

/* 2. Fix Spaziatura Recensioni: Aggiunge spazio laterale per l'evidenziazione */
.review-item {
    padding: 1.5rem 1.5rem; /* Aggiunto padding orizzontale (destra/sinistra) */
    border-bottom: 1px solid #27272a;
    transition: background-color 0.5s ease; /* Transizione fluida per il background */
}

        .review-item:last-child {
            border-bottom: none;
        }

        .review-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.75rem;
        }

        .review-author {
            font-weight: 500;
        }

/* 1. Fix Data: Rimuovi capitalize per permettere "ora" minuscolo */
.review-date {
    font-size: 0.85rem;
    color: #a1a1aa;
    text-transform: none; /* FONDAMENTALE: rimuove la capitalizzazione automatica */
}

        .review-title {
            font-size: 1.125rem;
            font-weight: 500;
            color: #D4AF37;
            margin-bottom: 0.5rem;
        }

        .review-text {
            color: #d4d4d8;
            line-height: 1.7;
        }

        .no-reviews {
            text-align: center;
            padding: 3rem 1rem;
            color: #a1a1aa;
        }

        .no-reviews-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        /* FAQs */
        .faqs {
            margin-top: 4rem;
            max-width: 900px;
        }

        .faqs h3 {
            font-size: 1.5rem;
            font-weight: 300;
            margin-bottom: 2rem;
        }

        .faq-item {
            border: 1px solid #27272a;
            border-radius: 1rem;
            margin-bottom: 1rem;
            overflow: hidden;
        }

        .faq-question {
            width: 100%;
            padding: 1.25rem 1.5rem;
            background: none;
            border: none;
            color: white;
            text-align: left;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background 0.3s;
        }

        .faq-question:hover {
            background: rgba(24, 24, 27, 0.5);
        }

        .faq-icon {
            transition: transform 0.3s;
        }

        .faq-item.active .faq-icon {
            transform: rotate(180deg);
        }

        .faq-answer {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s;
        }

        .faq-item.active .faq-answer {
            max-height: 500px;
        }

        .faq-answer-content {
            padding: 0 1.5rem 1.25rem;
            color: #a1a1aa;
            line-height: 1.7;
        }

        /* Cart Icon */
        .cart-icon {
            position: fixed;
            top: 1rem;
            right: 1rem;
            z-index: 1000;
            width: 3rem;
            height: 3rem;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
            border-radius: 50%;
            display: none;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 1.5rem;
        }

        .cart-icon:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: scale(1.1);
        }

        .cart-icon.show {
            display: flex;
        }

        /* Responsive */
        @media (max-width: 1024px) {
            .product-grid {
                grid-template-columns: 1fr;
                gap: 2rem;
            }

            .gallery {
                position: static;
            }

            h1 {
                font-size: 2rem;
            }

            .specs-grid {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 640px) {
            .size-grid {
                grid-template-columns: repeat(3, 1fr);
            }

            .trust-badges {
                grid-template-columns: 1fr;
            }
        }

        /* Mobile specifico */
@media (max-width: 768px) {
    .reviews-summary {
        flex-direction: column; /* Impila Overview sopra le Barre */
        align-items: center;    /* Centra tutto orizzontalmente */
        gap: 2rem;
    }

    .rating-overview {
        display: flex;
        flex-direction: column;
        align-items: center; /* CRUCIALE: Centra numero e stelle */
        width: 100%;
    }
    
    .rating-number {
        line-height: 1;
        margin-bottom: 0.5rem;
    }
    
    .rating-overview .stars {
        justify-content: center; /* Assicura che le stelle siano centrate */
        margin-bottom: 0.25rem;
    }
    
    .rating-bars {
        width: 100%; /* Le barre riprendono larghezza piena */
    }
}

        /* --- NUOVO CSS PER RECENSIONI --- */

/* 1. Navigazione Recensioni (Frecce) */
.reviews-nav-container {
    display: flex;
    justify-content: center;
    gap: 1.5rem;
    margin-top: 2rem;
    margin-bottom: 2rem;
}

.review-nav-btn {
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid #27272a;
    color: #D4AF37;
    width: 3rem;
    height: 3rem;
    border-radius: 50%;
    font-size: 1.5rem;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    user-select: none;
}

.review-nav-btn:hover:not(:disabled) {
    background: rgba(212, 175, 55, 0.1);
    border-color: #D4AF37;
    transform: scale(1.1);
}

.review-nav-btn:disabled {
    opacity: 0.3;
    cursor: not-allowed;
    border-color: transparent;
    color: #52525b;
}

/* 2. Avviso professionale "Non modificabile" */
.review-disclaimer {
    background: rgba(212, 175, 55, 0.05); /* Sfondo dorato molto tenue */
    border-left: 3px solid #D4AF37;
    padding: 1rem;
    margin-bottom: 1.5rem;
    border-radius: 0 0.5rem 0.5rem 0;
}

.review-disclaimer p {
    font-size: 0.85rem;
    color: #d4d4d8;
    margin: 0;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.disclaimer-icon {
    color: #D4AF37;
    font-size: 1.1rem;
}

        /* --- AGGIUNGI O SOSTITUISCI QUESTO CSS NEL BLOCCO <style> --- */

/* Fix per evitare lo zoom/glitch al click sulle stelle */
.rating-selector {
    transform: none !important;
    transition: none !important;
    display: flex;
    gap: 0.25rem;
    align-items: center;
    cursor: pointer;
}
.rating-selector:active, .rating-selector:hover {
    transform: none !important;
}

/* Stelle nel form di input */
.rating-star {
    font-size: 2rem;
    color: #27272a;
    position: relative;
    transition: color 0.2s;
    display: inline-block;
}
.rating-star.full { color: #fbbf24; }
.rating-star.half { color: #27272a; }
.rating-star.half::before {
    content: 'â˜…';
    position: absolute;
    left: 0; top: 0; width: 50%;
    overflow: hidden; color: #fbbf24;
    pointer-events: none;
}
.rating-star:hover { transform: scale(1.1); } /* Hover leggero solo sulla singola stella */

/* Stelle compatte per la lista recensioni (es: â˜…â˜…â¯ªâ˜†â˜†) */
.stars-compact {
    font-family: "Segoe UI Symbol", "DejaVu Sans", sans-serif;
    letter-spacing: -2px;
    color: #fbbf24;
    font-size: 1.2rem;
}

        /* Stili Modale Premium */
.custom-modal {
    position: fixed;
    top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0, 0, 0, 0.8);
    backdrop-filter: blur(8px);
    z-index: 10000;
    display: flex;
    align-items: center;
    justify-content: center;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.3s ease;
}

.custom-modal.active {
    opacity: 1;
    pointer-events: auto;
}

.modal-content {
    background: linear-gradient(135deg, #18181b, #0f0f0f);
    border: 1px solid #D4AF37;
    padding: 2.5rem;
    border-radius: 1.5rem;
    max-width: 450px;
    width: 90%;
    text-align: center;
    box-shadow: 0 20px 50px rgba(0, 0, 0, 0.5), 0 0 30px rgba(212, 175, 55, 0.1);
    transform: scale(0.9);
    transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
}

.custom-modal.active .modal-content {
    transform: scale(1);
}

.modal-icon {
    font-size: 3rem;
    margin-bottom: 1rem;
    color: #D4AF37;
}

.modal-title {
    color: #D4AF37;
    font-size: 1.5rem;
    margin-bottom: 1rem;
    font-weight: 300;
}

.modal-message {
    color: #fafafa;
    font-size: 1.1rem;
    margin-bottom: 0.5rem;
    line-height: 1.6;
}

.modal-submessage {
    color: #a1a1aa;
    font-size: 0.9rem;
    margin-bottom: 2rem;
}

.modal-btn {
    background: #D4AF37;
    color: #000;
    border: none;
    padding: 1rem 2.5rem;
    border-radius: 2rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s;
    font-size: 1rem;
}

.modal-btn:hover {
    background: #fff;
    transform: scale(1.05);
}

/* 3. Animazione Premium "Gold Pulse" piÃ¹ elegante e fluida */
@keyframes goldPulse {
    0% { 
        background-color: transparent; 
        border-left: 3px solid transparent; 
    }
    10% { 
        background-color: rgba(212, 175, 55, 0.08); /* Sfondo molto tenue */
        border-left: 3px solid #D4AF37; 
    }
    80% { 
        background-color: rgba(212, 175, 55, 0.02); 
        border-left: 3px solid #D4AF37; 
    }
    100% { 
        background-color: transparent; 
        border-left: 3px solid transparent; 
    }
}

.review-highlight-premium {
    animation: goldPulse 4s cubic-bezier(0.25, 1, 0.5, 1) forwards;
    /* La classe ora lavora con il padding del .review-item per non attaccare il testo */
}

        /* Bordo per il colore Nero (e scuri) per farlo risaltare */
.color-btn.is-dark {
    border: 1px solid rgba(255, 255, 255, 0.3) !important;
}
.color-btn.is-dark:hover {
    border-color: rgba(255, 255, 255, 0.8) !important;
}

/* Colore della spunta per i colori chiari (Bianco) */
.color-btn.is-light.active::after {
    color: #000000; /* Spunta nera su sfondo bianco */
    font-weight: bold;
}

        /* ============================================
   SELETTORE LINGUA PREMIUM (PDP PAGES)
   ============================================ */

.pdp-lang-selector {
    position: fixed;
    top: 1rem;
    right: 5rem;
    z-index: 9999;
    display: flex;
    align-items: center;
    gap: 0.25rem;
    background: rgba(9, 9, 11, 0.85);
    backdrop-filter: blur(20px);
    border: 1px solid rgba(212, 175, 55, 0.2);
    border-radius: 2rem;
    padding: 0.625rem 1.25rem;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

.pdp-lang-selector:hover {
    border-color: rgba(212, 175, 55, 0.5);
    box-shadow: 0 12px 48px rgba(212, 175, 55, 0.15);
}

.pdp-lang-option {
    background: none;
    border: none;
    color: #71717a;
    font-size: 0.875rem;
    font-weight: 500;
    letter-spacing: 0.05em;
    padding: 0.5rem 0.75rem;
    cursor: pointer;
    transition: all 0.3s;
    border-radius: 1rem;
    position: relative;
}

.pdp-lang-option:hover {
    color: #d4d4d8;
    background: rgba(255, 255, 255, 0.05);
}

.pdp-lang-option.active {
    color: #D4AF37;
    font-weight: 600;
    background: linear-gradient(135deg, rgba(212, 175, 55, 0.1), rgba(255, 215, 0, 0.05));
}

.pdp-lang-option.active::after {
    content: '';
    position: absolute;
    bottom: 0.25rem;
    left: 50%;
    transform: translateX(-50%);
    width: 1.25rem;
    height: 2px;
    background: linear-gradient(90deg, #D4AF37, #FFD700);
    border-radius: 2px;
    box-shadow: 0 0 8px rgba(212, 175, 55, 0.6);
}

.pdp-lang-divider {
    width: 1px;
    height: 1rem;
    background: rgba(113, 113, 122, 0.3);
    margin: 0 0.125rem;
}

/* Responsive Mobile */
@media (max-width: 768px) {
    .pdp-lang-selector {
        top: 1rem;
        right: 1rem;
        padding: 0.5rem 1rem;
    }
    
    .pdp-lang-option {
        font-size: 0.8125rem;
        padding: 0.375rem 0.5rem;
    }

    /* âœ… FIX MOBILE: Carrello sotto il selettore lingua */
    .cart-icon {
        top: auto !important;
        bottom: 1.5rem !important;
        right: 1rem !important;
        width: 3.2rem !important;
        height: 3.2rem !important;
        background: linear-gradient(135deg, rgba(212,175,55,0.18), rgba(255,215,0,0.1)) !important;
        border: 1.5px solid rgba(212,175,55,0.4) !important;
        font-size: 1.4rem !important;
        box-shadow: 0 4px 20px rgba(212,175,55,0.2) !important;
    }
}
        
    </style>
    <script src="https://unpkg.com/dompurify@2.4.0/dist/purify.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@fingerprintjs/fingerprintjs@3/dist/fp.min.js"></script>
    <script>
    document.write(`
    <div id="luxhaven-loader" class="visible" style="position:fixed;top:0;left:0;width:100%;height:100%;background:linear-gradient(135deg, #0a0a0a 0%, #18181b 50%, #0a0a0a 100%);z-index:99999;display:flex;align-items:center;justify-content:center;transition:opacity 0.5s ease;">
        <div style="text-align:center;color:#fafafa;max-width:400px;">
            <div style="font-family:serif;font-size:2.5rem;margin-bottom:2rem;letter-spacing:0.05em;">LUXHAVEN360</div>
            
            <div style="position:relative;height:6px;background:rgba(212,175,55,0.1);border-radius:10px;margin-bottom:2rem;overflow:hidden;">
                <div id="loader-progress" style="position:absolute;left:0;top:0;height:100%;width:0%;background:linear-gradient(90deg, #D4AF37, #FFD700, #D4AF37);border-radius:10px;transition:width 0.8s cubic-bezier(0.4, 0, 0.2, 1);box-shadow:0 0 20px rgba(212,175,55,0.5);"></div>
            </div>
            
            <div id="loader-message" style="font-size:0.95rem;letter-spacing:0.1em;color:#d4d4d8;min-height:24px;transition:opacity 0.3s ease;"></div>
            
            <div style="margin-top:1.5rem;display:flex;gap:0.5rem;justify-content:center;">
                <div class="loader-dot" style="width:8px;height:8px;background:#D4AF37;border-radius:50%;animation:pulse 1.5s ease-in-out infinite;"></div>
                <div class="loader-dot" style="width:8px;height:8px;background:#D4AF37;border-radius:50%;animation:pulse 1.5s ease-in-out 0.3s infinite;"></div>
                <div class="loader-dot" style="width:8px;height:8px;background:#D4AF37;border-radius:50%;animation:pulse 1.5s ease-in-out 0.6s infinite;"></div>
            </div>
        </div>
    </div>
    
    <style>
        @keyframes pulse {
            0%, 100% { opacity: 0.3; transform: scale(0.8); }
            50% { opacity: 1; transform: scale(1.2); }
        }
    </style>
    `);
</script>
</head>
<body>
    <body>
    <!-- Selettore Lingua Premium -->
    <div class="pdp-lang-selector" id="pdpLanguageSelector">
        <button class="pdp-lang-option active" data-lang="it">IT</button>
        <span class="pdp-lang-divider"></span>
        <button class="pdp-lang-option" data-lang="en">EN</button>
        <span class="pdp-lang-divider"></span>
        <button class="pdp-lang-option" data-lang="fr">FR</button>
        <span class="pdp-lang-divider"></span>
        <button class="pdp-lang-option" data-lang="de">DE</button>
        <span class="pdp-lang-divider"></span>
        <button class="pdp-lang-option" data-lang="es">ES</button>
    </div>
    
    <div class="cart-icon" id="cartIcon">ðŸ›’</div>
    <div class="container">
        <div class="product-grid">
            <div class="gallery">
                <div class="main-image" id="mainImage">
                    <img id="mainImageImg" src="https://images.unsplash.com/photo-1591047139829-d91aecb6caea?w=800&h=1000&fit=crop" alt="Prodotto">
                    <button class="nav-btn prev" id="prevBtn" aria-label="Immagine precedente">â€¹</button>
                    <button class="nav-btn next" id="nextBtn" aria-label="Immagine successiva">â€º</button>
                    <button class="heart-btn" id="favBtn" aria-label="Aggiungi ai preferiti">â™¡</button>
                </div>
                <div class="thumbnails" id="thumbnailsContainer"></div>
            </div>

            <div class="product-info">
    <h1 id="productTitle">Cashmere Essentials</h1>
    <div class="rating" id="ratingContainer">
        <div class="stars" id="starsContainer"></div>
        <span class="rating-text" id="ratingText"></span>
    </div>
    <div class="price" id="productPrice">â‚¬ 485,00</div>
    <p class="description" id="productDesc">Un capo senza tempo che ridefinisce l'eleganza contemporanea.</p>
    <!-- â”€â”€ Premium Delivery Estimator â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
    <div class="delivery-estimator delivery-estimator--loading" id="deliveryEstimator">
        <div class="delivery-estimator__icon" id="deliveryIcon">ðŸ“¦</div>
        <div class="delivery-estimator__body">
            <div class="delivery-estimator__label" id="deliveryLabel">Consegna Stimata</div>
            <div class="delivery-estimator__time" id="deliveryTime">â€”</div>
            <div class="delivery-estimator__note" id="deliveryNote"></div>
        </div>
    </div>

    <div class="section" id="colorSection">
        <div class="section-title" data-i18n="pdp_color_label">Colore</div>
        <div class="color-options" id="colorOptions"></div>
    </div>

    <div class="section" id="sizeSection">
        <div class="section-title" data-i18n="pdp_size_label">Taglia</div>
        <div class="size-grid" id="sizeGrid"></div>
    </div>

    <div class="cta-buttons">
        <button id="addCartBtn" class="btn btn-primary" data-i18n="pdp_add_to_cart">Aggiungi al Carrello</button>
        <button id="buyNowBtn" class="btn btn-secondary" data-i18n="pdp_buy_now">Acquista Ora</button>
    </div>

    <div class="trust-badges">
        <div class="badge">
            <div class="badge-icon">ðŸšš</div>
            <div class="badge-text" data-i18n="pdp_trust_shipping">Spedizione Gratuita sopra â‚¬150</div>
        </div>
        <div class="badge">
            <div class="badge-icon">â†»</div>
            <div class="badge-text" data-i18n="pdp_trust_return">Rimborso in caso di difetto accertato</div>
        </div>
        <div class="badge">
            <div class="badge-icon">ðŸ›¡</div>
            <div class="badge-text" data-i18n="pdp_trust_secure">Pagamenti Sicuri al 100%</div>
        </div>
    </div>

    <!-- â”€â”€ Refund Policy â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
    <div class="refund-policy" id="refundPolicy">
        <div class="refund-policy__header" onclick="toggleRefundPolicy()">
            <div class="refund-policy__icon">ðŸ”„</div>
            <span class="refund-policy__title" data-i18n="refund_title">Politica di Rimborso</span>
            <span class="refund-policy__chevron">â–¼</span>
        </div>
        <div class="refund-policy__body">
            <div class="refund-policy__inner">

                <!-- Quando Ã¨ possibile -->
                <div class="refund-policy__block">
                    <div class="refund-policy__dot refund-policy__dot--green"></div>
                    <div class="refund-policy__block-text">
                        <strong data-i18n="refund_when_title">Quando hai diritto al rimborso</strong><br>
                        <span data-i18n="refund_when_text">Accettiamo richieste di rimborso esclusivamente per prodotti difettosi, danneggiati alla consegna o con errori documentati di produzione.</span>
                    </div>
                </div>

                <!-- Quando NON Ã¨ possibile -->
                <div class="refund-policy__block">
                    <div class="refund-policy__dot refund-policy__dot--red"></div>
                    <div class="refund-policy__block-text">
                        <strong data-i18n="refund_not_title">Cosa non dÃ  diritto al rimborso</strong><br>
                        <span data-i18n="refund_not_text">Cambi di taglia, variazioni di colore, preferenze estetiche o ripensamenti personali non costituiscono motivo di rimborso.</span>
                    </div>
                </div>

                <!-- Come procedere -->
                <div class="refund-policy__block">
                    <div class="refund-policy__dot refund-policy__dot--amber"></div>
                    <div class="refund-policy__block-text">
                        <strong data-i18n="refund_how_title">Come richiedere un rimborso</strong>
                        <ul class="refund-policy__steps">
                            <li>
                                <span class="refund-policy__step-num">1</span>
                                <span data-i18n="refund_step1">Fotografa il difetto entro 48 ore dalla ricezione del pacco.</span>
                            </li>
                            <li>
                                <span class="refund-policy__step-num">2</span>
                                <span data-i18n="refund_step2">Contattaci via email con numero d'ordine e foto allegate.</span>
                            </li>
                            <li>
                                <span class="refund-policy__step-num">3</span>
                                <span data-i18n="refund_step3">Il nostro team valuterÃ  la richiesta entro 2 giorni lavorativi e ti guiderÃ  nella procedura.</span>
                            </li>
                        </ul>
                    </div>
                </div>

            </div>
        </div>
    </div>
</div>
        </div>

        <div class="tabs-section">
            <div class="tabs">
    <button class="tab active" onclick="switchTab('description', this)" data-i18n="pdp_tab_description">Descrizione</button>
    <button class="tab" onclick="switchTab('specs', this)" data-i18n="pdp_tab_specs">Specifiche</button>
    <button class="tab" onclick="switchTab('reviews', this)" data-i18n="pdp_tab_reviews">Recensioni</button>
</div>

            <div id="description" class="tab-content active">
                <div id="longDescription"></div>
            </div>

            <div id="specs" class="tab-content">
                <div class="specs-grid" id="specsGrid"></div>
                <h4 id="sizeGuideTitle" style="display:none">Guida alle Taglie</h4>
                <table class="size-table" id="sizeTable" style="display: none;">
                    <thead id="sizeTableHead">
                        <tr>
                            <th data-col-key="taglia">Taglia</th>
                            <th data-col-key="petto">Petto (cm)</th>
                            <th data-col-key="vita">Vita (cm)</th>
                            <th data-col-key="lunghezza">Lunghezza (cm)</th>
                        </tr>
                    </thead>
                    <tbody id="sizeTableBody"></tbody>
                </table>
            </div>

<div id="reviews" class="tab-content">
    <div id="reviewsSummary" class="reviews-summary">
    <div class="rating-overview">
        <div class="rating-number" id="ratingNumber">0.0</div>
        <div class="stars" id="reviewsStarsContainer"></div>
        <p style="font-size:.875rem;color:#a1a1aa;margin-top:.25rem;" id="reviewsCount" data-i18n="pdp_reviews_count_zero">0 recensioni</p>
    </div>
    <div class="rating-bars" id="ratingBarsContainer">
        <div class="rating-bar">
            <span class="rating-bar-label" data-i18n="pdp_reviews_stars_5">5 stelle</span>
            <div class="rating-bar-track"><div class="rating-bar-fill" style="width:0%"></div></div>
        </div>
        <div class="rating-bar">
            <span class="rating-bar-label" data-i18n="pdp_reviews_stars_4">4 stelle</span>
            <div class="rating-bar-track"><div class="rating-bar-fill" style="width:0%"></div></div>
        </div>
        <div class="rating-bar">
            <span class="rating-bar-label" data-i18n="pdp_reviews_stars_3">3 stelle</span>
            <div class="rating-bar-track"><div class="rating-bar-fill" style="width:0%"></div></div>
        </div>
        <div class="rating-bar">
            <span class="rating-bar-label" data-i18n="pdp_reviews_stars_2">2 stelle</span>
            <div class="rating-bar-track"><div class="rating-bar-fill" style="width:0%"></div></div>
        </div>
        <div class="rating-bar">
            <span class="rating-bar-label" data-i18n="pdp_reviews_stars_1">1 stella</span>
            <div class="rating-bar-track"><div class="rating-bar-fill" style="width:0%"></div></div>
        </div>
    </div>
</div>

    <div id="reviewsList"></div>

    <div id="reviewsPagination" class="reviews-nav-container" style="display: none;">
        <button id="prevReviewPage" class="review-nav-btn">â†</button>
        <span id="pageIndicator" style="color: #52525b; font-size: 0.9rem; align-self: center;"></span>
        <button id="nextReviewPage" class="review-nav-btn">â†’</button>
    </div>

    <div class="review-form-container" style="margin-top: 3rem;">
    <h3 class="review-form-title" data-i18n="pdp_review_form_title">Scrivi una Recensione</h3>
    
    <div class="review-disclaimer">
        <p>
            <span class="disclaimer-icon">â“˜</span> 
            <span data-i18n="pdp_review_form_disclaimer">Nota bene: Per garantire l'integritÃ  delle opinioni, una volta inviata, la recensione non potrÃ  essere modificata o eliminata.</span>
        </p>
    </div>

    <p class="review-form-subtitle" data-i18n="pdp_review_form_subtitle">Condividi la tua esperienza con questo prodotto</p>
    
    <form id="reviewForm">
        <div class="form-group">
            <label class="form-label" data-i18n="pdp_review_form_rating_label">Valutazione *</label>
            <div class="rating-selector" id="ratingSelector">
                <span class="rating-star" data-rating="1">â˜…</span>
                <span class="rating-star" data-rating="2">â˜…</span>
                <span class="rating-star" data-rating="3">â˜…</span>
                <span class="rating-star" data-rating="4">â˜…</span>
                <span class="rating-star" data-rating="5">â˜…</span>
            </div>
        </div>

        <div class="form-group">
            <label class="form-label" for="reviewName" data-i18n="pdp_review_form_name_label">Nome Completo *</label>
            <input type="text" id="reviewName" class="form-input" required data-i18n-placeholder="pdp_review_form_name_placeholder" placeholder="Es. Marco Rossi">
        </div>

        <div class="form-group">
            <label class="form-label" for="reviewEmail" data-i18n="pdp_review_form_email_label">Email *</label>
            <input type="email" id="reviewEmail" class="form-input" required data-i18n-placeholder="pdp_review_form_email_placeholder" placeholder="esempio@email.com">
        </div>

        <div class="form-group">
            <label class="form-label" for="reviewTitle" data-i18n="pdp_review_form_title_label">Titolo (opzionale)</label>
            <input type="text" id="reviewTitle" class="form-input" data-i18n-placeholder="pdp_review_form_title_placeholder" placeholder="Riassumi la tua esperienza">
        </div>

        <div class="form-group">
            <label class="form-label" for="reviewComment" data-i18n="pdp_review_form_comment_label">Recensione *</label>
            <textarea id="reviewComment" class="form-textarea" required data-i18n-placeholder="pdp_review_form_comment_placeholder" placeholder="Racconta la tua esperienza con questo prodotto..."></textarea>
        </div>

        <button type="submit" class="btn-submit-review" id="submitReviewBtn" data-i18n="pdp_review_form_submit">
            Pubblica Recensione
        </button>
    </form>
</div>
</div>
        </div>

        <div class="faqs">
    <h3 data-i18n="pdp_faq_title">Domande Frequenti</h3>
    
    <div class="faq-item">
        <button class="faq-question" onclick="toggleFaq(this)">
            <span data-i18n="pdp_faq_q1">LuxHaven360 vende solo merchandising...</span>
            <span class="faq-icon">â–¼</span>
        </button>
        <div class="faq-answer">
            <div class="faq-answer-content" data-i18n="pdp_faq_a1">
                LuxHaven360 Ã¨ un ecosistema luxury...
            </div>
        </div>
    </div>
    
    <div class="faq-item">
        <button class="faq-question" onclick="toggleFaq(this)">
            <span data-i18n="pdp_faq_q2">I prodotti venduti...</span>
            <span class="faq-icon">â–¼</span>
        </button>
        <div class="faq-answer">
            <div class="faq-answer-content" data-i18n="pdp_faq_a2">
                SÃ¬. Ogni prodotto LuxHaven360...
            </div>
        </div>
    </div>
    
    <div class="faq-item">
        <button class="faq-question" onclick="toggleFaq(this)">
            <span data-i18n="pdp_faq_q3">Acquistare un prodotto...</span>
            <span class="faq-icon">â–¼</span>
        </button>
        <div class="faq-answer">
            <div class="faq-answer-content" data-i18n="pdp_faq_a3">
                LuxHaven360 Ã¨ un brand experience-driven...
            </div>
        </div>
    </div>
</div>
    
    <!-- Modal per recensioni duplicate -->
    <div id="duplicateReviewModal" class="custom-modal">
    <div class="modal-content">
        <div class="modal-icon">âš ï¸</div>
        <h3 class="modal-title">Attenzione</h3>
        <p class="modal-message">Abbiamo notato che hai giÃ  inviato una recensione per questo prodotto di recente.</p>
        <p class="modal-submessage">Per garantire la qualitÃ  delle opinioni, Ã¨ consentita una sola recensione per articolo.</p>
        <button class="modal-btn" onclick="closeModal('duplicateReviewModal')">Ho capito</button>
    </div>
</div>

    <!-- Modal per email non consentite -->
<div id="invalidEmailModal" class="custom-modal">
  <div class="modal-content">
    <div class="modal-icon">âœ‰ï¸</div>
    <h3 class="modal-title">Email non consentita</h3>
    <p class="modal-message">âš ï¸ L'indirizzo email inserito non Ã¨ accettato. Usa un indirizzo personale (Gmail, Outlook, Yahoo, ecc.).</p>
    <p class="modal-submessage">Se ritieni che si tratti di un errore, contatta il supporto.</p>
    <button class="modal-btn" onclick="closeModal('invalidEmailModal')">Ho capito</button>
  </div>
</div>

        <script src="../connection-monitor.js"></script>

    <script>
        /* ======================================
           CONFIGURAZIONE & VARIABILI GLOBALI
           ====================================== */
        
        // URL dello script Apps Script
        const REVIEWS_API_URL = 'https://script.google.com/macros/s/AKfycbwr79RkXIEocpuOKaM6uMJqE6VFs9wjlUPvrr__FvDbDDrD2ELB1NbfrWP3BCYpHj2u/exec';
        // URL Web App
        const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbwr79RkXIEocpuOKaM6uMJqE6VFs9wjlUPvrr__FvDbDDrD2ELB1NbfrWP3BCYpHj2u/exec';
        
        let currentProductSku = '';
        let selectedColor = '';
        let selectedSize = '';  
        let deviceFingerprint = null;
        let deviceType = 'O'; // Default: Other
        let selectedReviewRating = 0;
        let userCountryCode = ''; // Codice ISO paese utente (es: "IT", "US")
        let currentReviewsData = [];
        let productLoaded = false;
        let reviewsLoaded = false;

        // --- VARIABILI GLOBALI AGGIUNTE ---
        let currentReviewPage = 0;
        const REVIEWS_PER_PAGE = 4;
        let allReviewsCache = []; // Memorizza tutte le recensioni scaricate

        /* ====== Loader Dinamico ====== */
        function getLoadingMessages() {
    const i18n = window.i18nPDP();
    if (!i18n) return [
        'Loading...', 'Please wait...', 'Almost ready...'
    ];
    
    return [
        i18n.t('pdp_loader_step1'),
        i18n.t('pdp_loader_step2'),
        i18n.t('pdp_loader_step3'),
        i18n.t('pdp_loader_step4'),
        i18n.t('pdp_loader_step5'),
        i18n.t('pdp_loader_step6'),
        i18n.t('pdp_loader_step7')
    ];
}

        let currentMessageIndex = 0;
        let loaderInterval;
        let progressInterval;

        function startDynamicLoader() {
            const loadingMessages = getLoadingMessages();
            const messageEl = document.getElementById('loader-message');
            const progressEl = document.getElementById('loader-progress');
            
            if (!messageEl || !progressEl) return;
            
            messageEl.textContent = loadingMessages[0];
            messageEl.style.opacity = '1';
            
            let progress = 0;
            progressInterval = setInterval(() => {
                progress += Math.random() * 15;
                if (progress > 85) progress = 85; 
                progressEl.style.width = progress + '%';
            }, 400);
            
            loaderInterval = setInterval(() => {
                currentMessageIndex++;
                if (currentMessageIndex >= loadingMessages.length) {
                    currentMessageIndex = loadingMessages.length - 1;
                    return;
                }
                messageEl.style.opacity = '0';
                setTimeout(() => {
                    messageEl.textContent = loadingMessages[currentMessageIndex];
                    messageEl.style.opacity = '1';
                }, 300);
            }, 1200);
        }

        function completeLoader() {
            if (!productLoaded || !reviewsLoaded) return;
            
            clearInterval(loaderInterval);
            clearInterval(progressInterval);
            
            const progressEl = document.getElementById('loader-progress');
            const messageEl = document.getElementById('loader-message');
            
            if (progressEl) progressEl.style.width = '100%';
if (messageEl) {
    messageEl.style.opacity = '0';
    setTimeout(() => {
        const i18n = window.i18nPDP();
        messageEl.textContent = i18n ? i18n.t('pdp_loader_complete') : 'Completato';
        messageEl.style.opacity = '1';
    }, 200);
}
            
            setTimeout(() => {
                const loader = document.getElementById('luxhaven-loader');
                if(loader) {
                    loader.style.opacity = '0';
                    setTimeout(() => loader.style.display = 'none', 500);
                }
            }, 800);
        }

        /* ====== UtilitÃ  ====== */
        function qs(name) {
            return new URLSearchParams(window.location.search).get(name);
        }

        function formatCount(n) {
            try { return new Intl.NumberFormat('it-IT').format(n); } 
            catch (e) { return n; }
        }

        function safeText(s){
            if (s == null) return '';
            return String(s).replace(/[&<>"']/g, function(m){
                return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[m];
            });
        }

        /* ====== Gallery ====== */
        let images = ['https://images.unsplash.com/photo-1591047139829-d91aecb6caea?w=800&h=1000&fit=crop'];
        let currentImage = 0;

        function renderGallery() {
    const mainImg = document.getElementById('mainImageImg');
    
    // Check sicurezza: se non ci sono immagini, usa placeholder o esci
    if (!images || images.length === 0) {
        // Opzionale: imposta un placeholder se vuoi
        // mainImg.src = 'assets/placeholder.jpg'; 
        return;
    }

    // Assicurati che l'indice sia valido
    if (currentImage < 0) currentImage = 0;
    if (currentImage >= images.length) currentImage = 0;

    // Prendi l'URL (con fallback sulla prima immagine se l'indice Ã¨ strano)
    const imgUrl = images[currentImage] || images[0];

    // FIX 404: Se imgUrl Ã¨ undefined o null, non assegnarlo a src
    if (imgUrl) {
        mainImg.src = imgUrl;
    }

    const thumbs = document.getElementById('thumbnailsContainer');
    thumbs.innerHTML = '';
    
    // Genera miniature
    images.forEach((src, i) => {
        if (!src) return; // Salta url vuoti
        const div = document.createElement('div');
        div.className = 'thumbnail' + (i === currentImage ? ' active' : '');
        div.innerHTML = `<img src="${src}" alt="Vista ${i+1}" />`;
        div.addEventListener('click', () => { selectImage(i); });
        thumbs.appendChild(div);
    });
}

        function selectImage(index) {
            currentImage = index;
            renderGallery();
        }

        document.getElementById('nextBtn').addEventListener('click', () => {
            currentImage = (currentImage + 1) % images.length;
            renderGallery();
        });
        document.getElementById('prevBtn').addEventListener('click', () => {
            currentImage = (currentImage - 1 + images.length) % images.length;
            renderGallery();
        });

        /* ====== Colori e Taglie (AGGIORNATO) ====== */

// Mappa colori Italiano/Inglese -> CSS Hex/Valido
const COLOR_MAP = {
    // Italiani
    'Nero': '#000000',
    'Bianco': '#FFFFFF',
    'Grigio': '#808080',
    'Blu': '#0000FF',
    'Blu Navy Scuro': '#202835',   // variante originale dal foglio Google
    'Blu navy scuro': '#202835',   // variante normalizzata da renderColors()
    'Rosso': '#FF0000',
    'Verde': '#008000',
    'Giallo': '#FFFF00',
    'Viola': '#800080',
    'Arancione': '#FFA500',
    'Marrone': '#A52A2A',
    'Oro': '#FFD700',
    'Argento': '#C0C0C0',
    'Beige': '#F5F5DC',
    'Rosa': '#FFC0CB',
    'Celeste': '#87CEEB',
    
    // Inglesi (Fallback)
    'Black': '#000000',
    'White': '#FFFFFF',
    'Grey': '#808080',
    'Blue': '#0000FF',
    'Red': '#FF0000'
};

function renderColors(colors) {
    const container = document.getElementById('colorOptions');
    container.innerHTML = '';
    
    if (!colors || colors.length === 0) {
        document.getElementById('colorSection').style.display = 'none';
        return;
    }
    document.getElementById('colorSection').style.display = 'block';
    
    colors.forEach((rawColor, i) => {
        let colorName = rawColor.trim();
        colorName = colorName.charAt(0).toUpperCase() + colorName.slice(1).toLowerCase();

        const cssColor = COLOR_MAP[colorName] || colorName;

        const btn = document.createElement('button');
        btn.className = 'color-btn' + (i === 0 ? ' active' : '');
        btn.style.background = cssColor;
        
        // --- MODIFICA RICHIESTA ---
        const lowerColor = cssColor.toLowerCase();
        
        // 1. Logica per Colori Chiari (Bianco, Beige, ecc.)
        // Aggiunge classe 'is-light' per far diventare la spunta nera
        if (['#ffffff', 'white', '#f5f5dc', 'beige', 'cream'].includes(lowerColor)) {
            btn.classList.add('is-light');
            // Mantiene il bordino leggero esistente per il bianco
            btn.style.boxShadow = 'inset 0 0 0 1px rgba(255,255,255,0.3)';
        }

        // 2. Logica per Colori Scuri (Nero, Blu Navy Scuro)
        // Aggiunge classe 'is-dark' per il bordo esterno visibile
        if (['#000000', 'black', '#09090b', 'nero', '#202835'].includes(lowerColor)) {
            btn.classList.add('is-dark');
        }
        // --------------------------
        
        btn.dataset.color = colorName;
        btn.setAttribute('aria-label', 'Colore ' + colorName);
        
        btn.addEventListener('click', () => selectColor(btn));
        
        container.appendChild(btn);
    });
}

        function renderSizes(sizes) {
            const container = document.getElementById('sizeGrid');
            container.innerHTML = '';
            if (!sizes || sizes.length === 0) {
                document.getElementById('sizeSection').style.display = 'none';
                return;
            }
            document.getElementById('sizeSection').style.display = 'block';

            // Set di valori "one size" in tutte le lingue per riconoscimento robusto
            const ONE_SIZE_VALUES = new Set([
                'Unica', 'Taglia Unica', 'One Size',
                'Unique', 'Taille Unique',
                'EinheitsgrÃ¶ÃŸe',
                'Ãšnica', 'Talla Ãšnica'
            ]);
            // Mappa forma breve per il pulsante sul sito
            const SHORT_FORM = { it:'Unica', en:'One Size', fr:'Unique', de:'EinheitsgrÃ¶ÃŸe', es:'Ãšnica' };

            const currentLang = (typeof i18n !== 'undefined' && i18n && i18n.currentLang)
                ? i18n.currentLang
                : (localStorage.getItem('lh360_lang') || 'it');

            sizes.forEach((size, i) => {
                const btn = document.createElement('button');
                btn.className = 'size-btn' + (i === 0 ? ' active' : '');
                // Salva sempre il valore canonico italiano nel dataset
                btn.dataset.sizeIt = size;
                // Mostra la forma breve se Ã¨ taglia unica, altrimenti il valore invariato
                btn.textContent = ONE_SIZE_VALUES.has(size)
                    ? (SHORT_FORM[currentLang] || 'Unica')
                    : size;
                btn.onclick = () => selectSize(btn);
                container.appendChild(btn);
            });
        }

        function selectColor(btn) {
    // 1. Gestione UI bottone
    document.querySelectorAll('.color-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    
    // 2. Aggiorna variabile globale
    const colorName = btn.dataset.color; // Es: "Nero"
    selectedColor = colorName;

    // 3. --- LOGICA CAMBIO IMMAGINI DINAMICO ---
    // Verifica se abbiamo il mapping per questo colore specifico
    if (currentProduct && currentProduct.images_by_color && currentProduct.images_by_color[colorName]) {
        const newImages = currentProduct.images_by_color[colorName];
        
        // Aggiorna solo se ci sono immagini valide
        if (newImages && newImages.length > 0) {
            images = newImages.slice(); // Clona l'array per sicurezza
            currentImage = 0;           // Reset alla prima immagine (Copertina)
            renderGallery();            // Ridisegna la galleria
        }
    } 
    // Fallback opzionale: se il colore selezionato non ha immagini mappate, 
    // potresti decidere di non fare nulla o mostrare quelle di default.
    // In questo caso, non facendo nulla, rimangono le immagini precedenti.
}

        function selectSize(btn) {
            document.querySelectorAll('.size-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            // Usa sempre il valore canonico italiano, cosÃ¬ il backend/carrello riceve sempre "Unica"
            selectedSize = btn.dataset.sizeIt || btn.textContent;
        }

        /* ====== Tabs & FAQ ====== */
        function switchTab(tabName, btn) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            if (btn) btn.classList.add('active');
            const target = document.getElementById(tabName);
            if (target) target.classList.add('active');
        }

        function toggleFaq(btn){
            const faqItem = btn.parentElement;
            const isActive = faqItem.classList.contains('active');
            document.querySelectorAll('.faq-item').forEach(item=>item.classList.remove('active'));
            if(!isActive) faqItem.classList.add('active');
        }

        /* ====== Stelle (Logica Numeri Interi) ====== */
        // Renderizza stelle con porzioni (usata per la valutazione media) â€” version "piÃ¹ vicine"
function renderStars(containerId, ratingValue) {
    const container = document.getElementById(containerId);
    if (!container) return;
    container.innerHTML = '';

    const avg = Math.max(0, Math.min(5, parseFloat(ratingValue) || 0));

    for (let i = 1; i <= 5; i++) {
        const fillPercent = Math.max(0, Math.min(100, (avg - (i - 1)) * 100)); // percentuale per questa stella

        const starWrap = document.createElement('span');
        starWrap.className = 'star';
        starWrap.style.display = 'inline-block';
        starWrap.style.position = 'relative';
        starWrap.style.fontSize = '1.25rem';
        starWrap.style.lineHeight = '1';
        // â†“ valore ridotto qui per avvicinare le stelle
        starWrap.style.marginRight = '0.00rem';
        starWrap.setAttribute('aria-hidden', 'true');

        const filled = document.createElement('span');
        filled.style.position = 'absolute';
        filled.style.left = '0';
        filled.style.top = '0';
        filled.style.overflow = 'hidden';
        filled.style.width = `${fillPercent}%`;
        filled.style.color = '#fbbf24';
        filled.style.pointerEvents = 'none';
        filled.textContent = 'â˜…';

        const base = document.createElement('span');
        base.style.color = '#27272a';
        base.textContent = 'â˜…';

        starWrap.appendChild(filled);
        starWrap.appendChild(base);
        container.appendChild(starWrap);
    }
}

        // Genera HTML stelle per la lista (Solo piene/vuote)
        function generateCompactStars(rating) {
            const fullStars = Math.round(rating); // Arrotonda sempre
            let html = '';
            for(let i=1; i<=5; i++) {
                if (i <= fullStars) html += 'â˜…';
                else html += '<span class="empty">â˜…</span>';
            }
            return `<span class="stars-compact">${html}</span>`;
        }

        /* ====== Specifiche ====== */
        function renderSpecsGrid(specs) {
    const specsGrid = document.getElementById('specsGrid');
    const tabSpecs = document.getElementById('specs'); // Il container tab
    if (!specsGrid) return;
    
    specsGrid.innerHTML = '';
    
    // Rimuovi eventuali messaggi "no-specs" precedenti
    const existingMsg = document.querySelector('.no-specs-container');
    if (existingMsg) existingMsg.remove();

    // Check se l'oggetto specs Ã¨ vuoto o null
    if (!specs || Object.keys(specs).length === 0) {
        specsGrid.style.display = 'none';
        
        // --- MODIFICA: Messaggio professionale semplice ---
        const i18n = window.i18nPDP();
        const noSpecsTitle = i18n ? i18n.t('pdp_spec_no_specs_title') : 'Specifiche non disponibili';
        const noSpecsText = i18n ? i18n.t('pdp_spec_no_specs_text') : 'Al momento non sono presenti dettagli tecnici aggiuntivi per questo prodotto.';
        
        const noSpecsHtml = `
            <div class="no-specs-container" style="border: 1px solid rgba(255,255,255,0.1); background: rgba(255,255,255,0.02);">
                <div class="no-specs-icon" style="color: #a1a1aa; font-size: 1.5rem; animation: none;">â“˜</div>
                <div class="no-specs-title" style="color: #fafafa; font-family: inherit; font-size: 1.1rem; margin-bottom: 0.5rem;">${noSpecsTitle}</div>
                <div class="no-specs-text" style="color: #a1a1aa;">
                    ${noSpecsText}
                </div>
            </div>
        `;
        // --------------------------------------------------
        
        // Inserisce il messaggio nel tab (dopo la griglia nascosta)
        if (tabSpecs) tabSpecs.insertAdjacentHTML('beforeend', noSpecsHtml);
        
        // Nasconde anche la tabella taglie se non ci sono specs
        const sizeTitle = document.getElementById('sizeGuideTitle');
        const sizeTable = document.getElementById('sizeTable');
        if (sizeTitle) sizeTitle.style.display = 'none';
        if (sizeTable) sizeTable.style.display = 'none';
        
        return;
    }
    
    // Se ci sono specifiche, mostra la griglia normalmente
    specsGrid.style.display = 'grid';

    const order = ['composition', 'weight', 'origin', 'fit'];

    // Mappa chiave â†’ chiave di translationsSpecLabels
    const labelKeyMap = {
      composition: 'spec_composition',
      weight:      'spec_weight',
      origin:      'spec_origin',
      fit:         'spec_fit'
    };

    // Lingua corrente
    const _specLang = (typeof i18nPDPInstance !== 'undefined' && i18nPDPInstance && i18nPDPInstance.currentLang)
        ? i18nPDPInstance.currentLang
        : (localStorage.getItem('lh360_lang') || 'it');

    // Dizionario etichette tradotte
    const _specLabels = (window.translationsSpecLabels && window.translationsSpecLabels[_specLang])
        ? window.translationsSpecLabels[_specLang]
        : {};

    // Dizionario valori tradotti
    const _specValues = window.translationsSpecValues || {};

    // Etichette fallback italiano
    const _labelsFallback = { composition: 'Composizione', weight: 'Peso', origin: 'Origine', fit: 'VestibilitÃ ' };

    order.forEach(key => {
        if (specs[key]) {
            const div = document.createElement('div');
            div.className = 'spec-row';
            div.dataset.specKey = key;

            // Etichetta tradotta
            const labelKey = labelKeyMap[key];
            const labelText = _specLabels[labelKey] || _labelsFallback[key] || key;

            // Valore: se Ã¨ italiano e ha traduzione, la usa; altrimenti mostra invariato
            const rawValue = specs[key];
            let displayValue = rawValue;
            if (_specLang !== 'it' && _specValues[rawValue] && _specValues[rawValue][_specLang]) {
                displayValue = _specValues[rawValue][_specLang];
            }

            div.innerHTML = `<span class="spec-label" data-spec-label-key="${labelKey}">${labelText}</span>`
                          + `<span data-spec-value-key="${rawValue}">${safeText(displayValue)}</span>`;
            specsGrid.appendChild(div);
        }
    });
}

        function renderSizeGuide(sizeGuide) {
            const titleEl = document.getElementById('sizeGuideTitle');
            const table   = document.getElementById('sizeTable');
            const thead   = document.getElementById('sizeTableHead');
            const tbody   = document.getElementById('sizeTableBody');
            if (!tbody) return;
            tbody.innerHTML = '';

            if (!sizeGuide || !Array.isArray(sizeGuide) || sizeGuide.length === 0) {
                if (titleEl) titleEl.style.display = 'none';
                if (table)   table.style.display   = 'none';
                return;
            }

            // â”€â”€ Lingua corrente â”€â”€
            const lang = (typeof i18nPDPInstance !== 'undefined' && i18nPDPInstance && i18nPDPInstance.currentLang)
                ? i18nPDPInstance.currentLang
                : (localStorage.getItem('lh360_lang') || 'it');

            // â”€â”€ Colonne per-SKU (con fallback _default) â”€â”€
            const sku = currentProduct ? currentProduct.sku : null;
            const colDict = _getSizeColumns(sku, lang);

            // â”€â”€ Traduzione valori (es. "Unica" â†’ "One Size") â”€â”€
            const specValues = window.translationsSpecValues || {};

            // â”€â”€ Titolo â”€â”€
            const specLabels = (window.translationsSpecLabels && window.translationsSpecLabels[lang])
                ? window.translationsSpecLabels[lang] : {};
            if (titleEl) {
                titleEl.textContent = specLabels['size_guide_title'] || 'Guida alle Taglie';
                titleEl.style.display = 'block';
            }

            // â”€â”€ Intestazioni colonne â”€â”€
            if (thead) {
                const tr = document.createElement('tr');
                ['taglia', 'petto', 'vita', 'lunghezza'].forEach(field => {
                    const label = colDict[field];
                    if (label === '') return; // salta colonne vuote (es. ME-02-A)
                    const th = document.createElement('th');
                    th.dataset.colKey = field;
                    th.textContent = label;
                    tr.appendChild(th);
                });
                thead.innerHTML = '';
                thead.appendChild(tr);
            }

            // â”€â”€ Righe dati â”€â”€
            if (table) table.style.display = 'table';
            sizeGuide.forEach(row => {
                const tr = document.createElement('tr');

                // Valore taglia (tradotto se "Unica")
                const rawTaglia = safeText(row.taglia);
                let displayTaglia = rawTaglia;
                if (lang !== 'it' && specValues[rawTaglia] && specValues[rawTaglia][lang]) {
                    displayTaglia = specValues[rawTaglia][lang];
                }
                const tdTaglia = document.createElement('td');
                tdTaglia.dataset.specValueKey = rawTaglia;
                tdTaglia.textContent = displayTaglia;
                tr.appendChild(tdTaglia);

                // Petto, Vita, Lunghezza (solo se il campo ha un'etichetta non vuota)
                ['petto', 'vita', 'lunghezza'].forEach(field => {
                    if (colDict[field] === '') return;
                    const td = document.createElement('td');
                    td.textContent = safeText(row[field]);
                    tr.appendChild(td);
                });

                tbody.appendChild(tr);
            });
        }

        /* â”€â”€ Helper: restituisce il dizionario colonne per-SKU nella lingua corrente â”€â”€ */
        function _getSizeColumns(sku, lang) {
            const dict = window.translationsSpecColumns;
            if (!dict) {
                // Fallback hardcoded italiano
                return { taglia: 'Taglia', petto: 'Petto (cm)', vita: 'Vita (cm)', lunghezza: 'Lunghezza (cm)' };
            }
            const skuDict = dict[sku] || dict['_default'] || {};
            return skuDict[lang] || skuDict['it'] || { taglia: 'Taglia', petto: 'Petto (cm)', vita: 'Vita (cm)', lunghezza: 'Lunghezza (cm)' };
        }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           updateTableLabels()
           Aggiorna al volo etichette e intestazioni senza ri-renderizzare
           i dati. Chiamata da i18n-pdp.js ad ogni cambio lingua.
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        function updateTableLabels() {
            const i18nInst = window.i18nPDP ? window.i18nPDP() : null;
            const lang = (i18nInst && i18nInst.currentLang)
                ? i18nInst.currentLang
                : (localStorage.getItem('lh360_lang') || 'it');

            const specLabels  = (window.translationsSpecLabels  && window.translationsSpecLabels[lang])  ? window.translationsSpecLabels[lang]  : {};
            const specValues  = window.translationsSpecValues  || {};
            const sku         = currentProduct ? currentProduct.sku : null;
            const colDict     = _getSizeColumns(sku, lang);

            // â”€â”€ Titolo guida taglie â”€â”€
            const titleEl = document.getElementById('sizeGuideTitle');
            if (titleEl && titleEl.style.display !== 'none') {
                titleEl.textContent = specLabels['size_guide_title'] || 'Guida alle Taglie';
            }

            // â”€â”€ Intestazioni colonne tabella â”€â”€
            document.querySelectorAll('#sizeTableHead th[data-col-key]').forEach(th => {
                const field = th.dataset.colKey;
                if (colDict[field] !== undefined) th.textContent = colDict[field];
            });

            // â”€â”€ Valori taglia nella prima colonna (es. "Unica" â†’ "One Size") â”€â”€
            document.querySelectorAll('#sizeTableBody td[data-spec-value-key]').forEach(td => {
                const rawVal = td.dataset.specValueKey;
                if (rawVal && lang !== 'it' && specValues[rawVal] && specValues[rawVal][lang]) {
                    td.textContent = specValues[rawVal][lang];
                } else if (rawVal && lang === 'it') {
                    td.textContent = rawVal; // ripristina italiano
                }
            });

            // â”€â”€ Etichette specifiche (Composizione, Pesoâ€¦) â”€â”€
            document.querySelectorAll('[data-spec-label-key]').forEach(el => {
                const labelKey = el.dataset.specLabelKey;
                if (labelKey && specLabels[labelKey]) el.textContent = specLabels[labelKey];
            });

            // â”€â”€ Valori specifiche (VestibilitÃ , Origineâ€¦) â”€â”€
            document.querySelectorAll('[data-spec-value-key]').forEach(el => {
                const rawVal = el.dataset.specValueKey;
                if (!rawVal) return;
                if (lang !== 'it' && specValues[rawVal] && specValues[rawVal][lang]) {
                    el.textContent = specValues[rawVal][lang];
                } else if (lang === 'it') {
                    el.textContent = rawVal;
                }
            });
        }

        // Rendi disponibile globalmente (richiesto da i18n-pdp.js)
        window.updateTableLabels = updateTableLabels;

/* --- LOGICA TEMPORALE AGGIORNATA --- */
function getDynamicTime(dateTimeStr) {
    if (!dateTimeStr) return '';
    
    try {
        const i18n = window.i18nPDP();
        const parts = dateTimeStr.split(' - ');
        if (parts.length !== 2) return dateTimeStr;
        
        const datePart = parts[0];
        const timePart = parts[1];
        
        const reviewDate = new Date(datePart + ' ' + timePart);
        
        if (isNaN(reviewDate.getTime())) return dateTimeStr;
        
        const now = Date.now();
        const reviewTimestamp = reviewDate.getTime();
        const diff = now - reviewTimestamp;
        
        const oneMinute = 60 * 1000;
        const oneHour = 60 * oneMinute;
        const oneDay = 24 * oneHour;

        if (diff < 0) return i18n ? i18n.t('pdp_review_time_now') : 'ora';

        if (diff < oneMinute) {
            return i18n ? i18n.t('pdp_review_time_now') : 'ora';
        }
        
        if (diff < oneHour) {
            const minutes = Math.floor(diff / oneMinute);
            const key = minutes === 1 ? 'pdp_review_time_minutes_one' : 'pdp_review_time_minutes_many';
            return i18n ? i18n.t(key, { n: minutes }) : `${minutes} minuti fa`;
        }
        
        if (diff < oneDay) {
            const hours = Math.floor(diff / oneHour);
            const key = hours === 1 ? 'pdp_review_time_hours_one' : 'pdp_review_time_hours_many';
            return i18n ? i18n.t(key, { n: hours }) : `${hours} ore fa`;
        }
        
        return formatDateWithLocale(reviewDate);
        
    } catch (e) {
        console.error('Errore parsing data:', e);
        return dateTimeStr;
    }
}

// Funzione helper per formattare la data in italiano con maiuscole
function formatDateWithLocale(dateObj) {
    const i18n = window.i18nPDP();
    if (!i18n) return dateObj.toLocaleDateString('it-IT');
    
    const giorno = dateObj.getDate();
    const mese = dateObj.getMonth() + 1; // 1-12
    const anno = dateObj.getFullYear();
    
    // Ottieni nome mese tradotto
    const monthNames = [
        'gennaio', 'febbraio', 'marzo', 'aprile', 'maggio', 'giugno',
        'luglio', 'agosto', 'settembre', 'ottobre', 'novembre', 'dicembre'
    ];
    const monthKey = `pdp_month_${monthNames[dateObj.getMonth()]}`;
    const monthName = i18n.t(monthKey);
    
    return `${giorno} ${monthName} ${anno}`;
}

// Funzione per aggiornare le etichette di tempo in tempo reale
function updateTimeLabels() {
    const timeLabels = document.querySelectorAll('.dynamic-time');
    timeLabels.forEach(label => {
        const item = label.closest('.review-item');
        if (item) {
            const dateTimeStr = item.dataset.datetime;
            if (dateTimeStr) {
                const newTime = getDynamicTime(dateTimeStr);

                // Costruisci la parte paese (stessa logica di renderReviewsPage)
                let countryPart = '';
                const countryCode = item.dataset.country;
                if (countryCode) {
                    const i18nInst = window.i18nPDP();
                    const currentLangCode = i18nInst ? i18nInst.currentLang : 'it';
                    const countryTranslated = (typeof translateCountryName === 'function')
                        ? translateCountryName(countryCode, currentLangCode)
                        : countryCode;
                    if (countryTranslated) countryPart = ' \u2022 ' + countryTranslated;
                }

                const newText = newTime + countryPart;
                if (label.textContent !== newText) {
                    label.textContent = newText;
                }
            }
        }
    });
}

/* --- FETCH RECENSIONI (POLLING INCLUSO) --- */
let reviewsPollingInterval;
let timeUpdateInterval; // Variabile per gestire l'intervallo del tempo

async function loadReviews(sku, isPolling = false) {
    if (!sku) {
        reviewsLoaded = true;
        completeLoader();
        return;
    }

    const url = `${REVIEWS_API_URL}?action=get_reviews&sku=${encodeURIComponent(sku)}&_=${Date.now()}`;

    try {
        const response = await fetch(url);
        if (!response.ok) throw new Error('Network response was not ok');
        
        const data = await response.json();
        
        if (data && data.success) {
            const newReviews = data.reviews || [];
            
            if (isPolling) {
                if (newReviews.length !== currentReviewsData.length || 
                   (newReviews.length > 0 && currentReviewsData.length > 0 && newReviews[0].timestamp !== currentReviewsData[0].timestamp)) {
                    
                    currentReviewsData = newReviews;
                    displayReviews(currentReviewsData, true); 
                    console.log('Recensioni aggiornate in tempo reale via polling');
                }
            } else {
                currentReviewsData = newReviews;
                displayReviews(currentReviewsData);
            }
        }
    } catch (error) {
        console.error("Errore fetch recensioni:", error);
    } finally {
        if (!isPolling) {
            reviewsLoaded = true;
            completeLoader();
            
            // Polling per nuove recensioni dal server (ogni 10 sec)
            if (!reviewsPollingInterval) {
                reviewsPollingInterval = setInterval(() => loadReviews(currentProductSku, true), 10000); 
            }
            
            // Timer dedicato per aggiornare le scritte "X minuti fa" (ogni 30 secondi per precisione)
            if (!timeUpdateInterval) {
                timeUpdateInterval = setInterval(updateTimeLabels, 30000);
            }
        }
    }
}

/* --- 4. RENDERIZZAZIONE AGGIORNATA --- */
function displayReviews(reviews, keepPage = false) {
    allReviewsCache = reviews || [];
    if (!keepPage) currentReviewPage = 0;
    
    renderReviewsPage();
    updateReviewsSummaryData(allReviewsCache);
}

function renderReviewsPage() {
    const container = document.getElementById('reviewsList');
    const navContainer = document.getElementById('reviewsPagination');
    if (!container) return;
    
    // Salviamo la posizione di scroll attuale se stiamo aggiornando
    const scrollPos = container.scrollTop;

    container.innerHTML = '';

    if (allReviewsCache.length === 0) {
        const i18nInst = window.i18nPDP();
        const emptyIcon = i18nInst ? i18nInst.t('pdp_reviews_empty_icon') : 'â˜…';
        const emptyText = i18nInst ? i18nInst.t('pdp_reviews_empty_text') : 'Nessuna recensione ancora. Sii il primo!';
        container.innerHTML = `<div class="no-reviews"><div class="no-reviews-icon">${emptyIcon}</div><p id="noReviewsText">${emptyText}</p></div>`;
        if(navContainer) navContainer.style.display = 'none';
        return;
    }

    const start = currentReviewPage * REVIEWS_PER_PAGE;
    const end = start + REVIEWS_PER_PAGE;
    const pageReviews = allReviewsCache.slice(start, end);

    pageReviews.forEach(review => {
    const dateTimeStr = review.dateTime || ''; // "07 December 2025 - 17:46"
    const timeDisplay = getDynamicTime(dateTimeStr);

    // Paese: tradotto nella lingua corrente
    let countryDisplay = '';
    if (review.country) {
        const i18nInst = window.i18nPDP();
        const currentLangCode = i18nInst ? i18nInst.currentLang : 'it';
        const countryTranslated = (typeof translateCountryName === 'function')
            ? translateCountryName(review.country, currentLangCode)
            : review.country;
        if (countryTranslated) countryDisplay = ` â€¢ ${countryTranslated}`;
    }
    
    const reviewEl = document.createElement('div');
    reviewEl.className = 'review-item';
    reviewEl.dataset.datetime = dateTimeStr; // Salviamo la data+ora completa
    if (review.country) reviewEl.dataset.country = review.country;

    reviewEl.innerHTML = `
        <div class="review-header">
            <div>
                <div class="review-author">${safeText(review.name)}</div>
                <div class="review-date dynamic-time">${timeDisplay}${countryDisplay}</div> 
            </div>
            <div>${generateCompactStars(review.rating)}</div>
        </div>
        ${review.title ? `<div class="review-title">${safeText(review.title)}</div>` : ''}
        <p class="review-text">${safeText(review.comment)}</p>
    `;
    container.appendChild(reviewEl);
});

    // Gestione paginazione (invariata)
    if (allReviewsCache.length >= 4) {
        navContainer.style.display = 'flex';
        document.getElementById('prevReviewPage').disabled = currentReviewPage === 0;
        document.getElementById('nextReviewPage').disabled = end >= allReviewsCache.length;
        document.getElementById('pageIndicator').textContent = `${currentReviewPage + 1} / ${Math.ceil(allReviewsCache.length / REVIEWS_PER_PAGE)}`;
        
        // Assegnazione handler click (IMPORTANTE: ricreare per aggiornare lo stato scope)
        document.getElementById('prevReviewPage').onclick = () => {
             if (currentReviewPage > 0) { currentReviewPage--; renderReviewsPage(); document.getElementById('reviewsSummary').scrollIntoView({behavior: 'smooth'}); }
        };
        document.getElementById('nextReviewPage').onclick = () => {
             if (end < allReviewsCache.length) { currentReviewPage++; renderReviewsPage(); document.getElementById('reviewsSummary').scrollIntoView({behavior: 'smooth'}); }
        };
    } else {
        navContainer.style.display = 'none';
    }
}

// Funzione helper estratta per pulizia codice (Statistiche)
function updateReviewsSummaryData(reviews) {
    const totalReviews = reviews.length;
    const totalRating = reviews.reduce((sum, r) => sum + parseFloat(r.rating), 0);
    const averageRating = totalReviews > 0 ? (totalRating / totalReviews) : 0;
    
    const distribution = { 5: 0, 4: 0, 3: 0, 2: 0, 1: 0 };
    reviews.forEach(r => {
        let bucket = Math.round(r.rating);
        if (bucket < 1) bucket = 1;
        if (bucket > 5) bucket = 5;
        distribution[bucket]++;
    });

    updateReviewsSummary(averageRating, totalReviews, distribution);
}

    function updateReviewsSummary(avgRating, count, distribution) {
    const ratingNumber = document.getElementById('ratingNumber');
    const reviewsCount = document.getElementById('reviewsCount');
    const ratingText = document.getElementById('ratingText');
    const i18n = window.i18nPDP();
    const formattedRating = i18n ? i18n.formatNumber(avgRating, 1) : avgRating.toFixed(1);
    
    if (ratingNumber) ratingNumber.textContent = formattedRating;
    
    if (reviewsCount && i18n) {
        let reviewsKey = count === 0 ? 'pdp_reviews_count_zero' : 
                        count === 1 ? 'pdp_reviews_count_one' : 
                        'pdp_reviews_count_many';
        reviewsCount.textContent = i18n.t(reviewsKey, { n: count });
    }
    
    if (ratingText && i18n) {
    // âœ… FIX: Ottieni il suffisso plurale/singolare con fallback sicuro
    let pluralSuffix = '';
    try {
        const key = count === 1 ? 'pdp_rating_reviews_one' : 'pdp_rating_reviews_many';
        const translation = i18n.translations[i18n.currentLang]?.[key];
        // Se la traduzione esiste ed Ã¨ una stringa, usala; altrimenti usa fallback
        pluralSuffix = (typeof translation === 'string') ? translation : (count === 1 ? '' : 's');
    } catch (e) {
        pluralSuffix = count === 1 ? '' : 's';
    }
    
    ratingText.textContent = i18n.t('pdp_rating_text', { 
        rating: formattedRating, 
        count: formatCount(count),
        plural: pluralSuffix
    });
}

    renderStars('reviewsStarsContainer', avgRating);
    renderStars('starsContainer', avgRating);

    if (count > 0) {
        for (let i = 5; i >= 1; i--) {
            const percentage = ((distribution[i] || 0) / count) * 100;
            const bar = document.querySelectorAll('.rating-bar')[5 - i]; 
            if (bar) {
                const fill = bar.querySelector('.rating-bar-fill');
                if (fill) fill.style.width = percentage + '%';
            }
        }
    }
}

        /* --- INVIO RECENSIONE (FETCH) & INPUT INTERO --- */
        function setupReviewForm() {
    const container = document.getElementById('ratingSelector');
    const stars = container.querySelectorAll('.rating-star');
    
    function highlightStars(count) {
        stars.forEach((star, index) => {
            if (index < count) star.classList.add('full');
            else star.classList.remove('full');
        });
    }

    stars.forEach((star, index) => {
        star.addEventListener('mouseenter', () => { highlightStars(index + 1); });
        star.addEventListener('click', () => {
            selectedReviewRating = index + 1;
            highlightStars(selectedReviewRating);
        });
    });

    container.addEventListener('mouseleave', () => {
        highlightStars(selectedReviewRating);
    });

    const form = document.getElementById('reviewForm');
    form.addEventListener('submit', async (e) => {
    e.preventDefault();
    
    if (selectedReviewRating === 0) { 
        alert('Seleziona una valutazione'); 
        return; 
    }
    
    // Validazione dominio email (mostra modal invece di alert)
const emailInput = document.getElementById('reviewEmail').value.toLowerCase();
const validDomains = ['gmail.com', 'outlook.com', 'hotmail.com', 'yahoo.com', 'yahoo.it', 
                      'libero.it', 'virgilio.it', 'icloud.com', 'protonmail.com', 'live.com',
                      'msn.com', 'alice.it', 'tim.it', 'vodafone.it', 'fastwebnet.it'];

const emailDomain = (emailInput || '').split('@')[1];
if (!emailDomain || !validDomains.includes(emailDomain)) {
    // mostra un popup nello stile del modal delle recensioni duplicate
    const m = document.getElementById('invalidEmailModal');
    if (m) m.classList.add('active');
    // non procedere con l'invio
    return;
}
    
    if (!deviceFingerprint) {
        alert('âš ï¸ Errore di sicurezza. Ricarica la pagina e riprova.');
        return;
    }

        const submitBtn = document.getElementById('submitReviewBtn');
        submitBtn.disabled = true;
        submitBtn.textContent = 'Invio in corso...';

        const formData = new URLSearchParams();
        formData.append('action', 'submit_review');
        formData.append('sku', currentProductSku);
        formData.append('name', document.getElementById('reviewName').value);
        formData.append('email', document.getElementById('reviewEmail').value);
        formData.append('rating', selectedReviewRating);
        formData.append('title', document.getElementById('reviewTitle').value);
        formData.append('comment', document.getElementById('reviewComment').value);
        formData.append('device_id', deviceFingerprint || 'UNKNOWN');
        formData.append('country', userCountryCode || '');

        try {
            const response = await fetch(REVIEWS_API_URL, {
                method: 'POST',
                body: formData
            });

            if (!response.ok) throw new Error('Network response was not ok');
            const result = await response.json();

            if (result.success) {
    // Usa la data+ora ritornata dal server
    const newReview = {
        name: document.getElementById('reviewName').value,
        dateTime: result.dateTime, // Es: "07 December 2025 - 17:46"
        rating: selectedReviewRating,
        title: document.getElementById('reviewTitle').value,
        comment: document.getElementById('reviewComment').value,
        country: userCountryCode || ''
    };

    // Inserimento in cima
    currentReviewsData.unshift(newReview);
    displayReviews(currentReviewsData, true);

    // Reset interfaccia
    form.reset();
    selectedReviewRating = 0;
    document.querySelectorAll('.rating-star').forEach(s => s.classList.remove('full')); 
    submitBtn.textContent = 'Recensione Inviata!';

    // Animazione scroll & evidenziazione
    setTimeout(() => {
        const listContainer = document.getElementById('reviewsList');
        if (listContainer && listContainer.firstElementChild) {
            const newElement = listContainer.firstElementChild;
            
            newElement.scrollIntoView({ 
                behavior: 'smooth', 
                block: 'center' 
            });

            newElement.classList.remove('review-highlight-premium');
            void newElement.offsetWidth;
            newElement.classList.add('review-highlight-premium');
        }
    }, 100);

    setTimeout(() => {
        submitBtn.disabled = false;
        submitBtn.textContent = 'Pubblica Recensione';
    }, 2000);
} else {
                // Gestione Errori (Duplicato ecc.)
                if (result.error === 'DUPLICATE_REVIEW' || (result.message && result.message.includes('giÃ  recensito'))) {
                   document.getElementById('duplicateReviewModal').classList.add('active');
    
                   // Reset completo del form
                   form.reset();
                   selectedReviewRating = 0;
                   document.querySelectorAll('.rating-star').forEach(s => s.classList.remove('full'));
    
                   submitBtn.disabled = false;
                   submitBtn.textContent = 'Pubblica Recensione';
                } else {
                    throw new Error(result.error || 'Errore sconosciuto');
                }
            }
        } catch (error) {
            console.error(error);
            if (!document.getElementById('duplicateReviewModal').classList.contains('active')) {
                alert('Errore invio: ' + error.message);
            }
            submitBtn.disabled = false;
            submitBtn.textContent = 'Pubblica Recensione';
        }
    });
}

        /* ====== Caricamento Prodotto ====== */
        async function loadProduct() {
        const skuFromQs = qs('sku');
        const skuFromLS = localStorage.getItem('lh360_selected_sku');
        const sku = skuFromQs || skuFromLS;

        if (!sku) {
            document.querySelector('.container').innerHTML = '<div style="padding:4rem;color:#fca5a5;text-align:center;">SKU prodotto mancante.</div>';
            hideGlobalLoader();
            return;
        }

        currentProductSku = sku;

        const CACHE_KEY = 'lh360_pdp_' + sku;
        const CACHE_TTL = 600000; // 10 minuti

        // â”€â”€ 1. Serve dalla cache se fresca (risposta istantanea) â”€â”€
        try {
            const raw = localStorage.getItem(CACHE_KEY);
            if (raw) {
                const { data, ts } = JSON.parse(raw);
                if (Date.now() - ts < CACHE_TTL && data.success && data.product) {
                    populateProduct(data.product);
                    productLoaded = true;
                    loadReviews(sku);
                    completeLoader();
                    // Aggiorna in background senza bloccare l'utente
                    _fetchProductAndCache(sku, CACHE_KEY).catch(() => {});
                    return;
                }
            }
        } catch (_) {}

        // â”€â”€ 2. Nessuna cache valida: carica dal server â”€â”€
        try {
            const data = await _fetchProductAndCache(sku, CACHE_KEY);
            if (!data.success || !data.product) {
                console.error('Errore API:', data.error);
                document.querySelector('.container').innerHTML = `<div style="padding:4rem;color:#fca5a5;text-align:center;">Prodotto non trovato o errore server.<br><small>${data.error || ''}</small></div>`;
                hideGlobalLoader();
                return;
            }
            populateProduct(data.product);
            productLoaded = true;
            loadReviews(sku);
            completeLoader();
        } catch (error) {
            console.error('Errore LoadProduct:', error);
            if (window.LuxError) {
                LuxError.show('loading', () => window.location.reload());
            } else {
                document.querySelector('.container').innerHTML = `
                    <div style="padding:4rem;color:#fca5a5;text-align:center;">
                        <h3 style="margin-bottom:1rem">Errore di connessione</h3>
                        <p>Impossibile recuperare i dettagli del prodotto.</p>
                        <button onclick="window.location.reload()" class="btn btn-secondary" style="margin-top:1rem; padding: 0.5rem 1rem;">Riprova</button>
                    </div>`;
            }
            hideGlobalLoader();
        }
    }

        async function _fetchProductAndCache(sku, cacheKey) {
            const apiUrl = `${WEB_APP_URL}?action=get_product_details&sku=${encodeURIComponent(sku)}`;
            const response = await fetch(apiUrl, { method: 'GET', redirect: 'follow' });
            if (!response.ok) throw new Error(`Errore HTTP: ${response.status}`);
            const data = await response.json();
            if (data.success && data.product) {
                try { localStorage.setItem(cacheKey, JSON.stringify({ data, ts: Date.now() })); } catch(_) {}
            }
            return data;
        }

        // Helper per nascondere il loader in caso di errore immediato
        function hideGlobalLoader() {
             const loader = document.getElementById('luxhaven-loader');
             if(loader) loader.style.display = 'none';
             clearInterval(loaderInterval);
             clearInterval(progressInterval);
        }

        function populateProduct(prod) {
            document.getElementById('productTitle').textContent = prod.title || 'Prodotto';

            // â”€â”€ Breve descrizione: usa traduzione se disponibile, altrimenti fallback backend â”€â”€
            const _i18nNow  = window.i18nPDP();
            const _langNow  = _i18nNow ? _i18nNow.currentLang : 'it';
            const _descMap  = window.translationsDescriptions || {};
            const _descEntry = _descMap[prod.sku];
            const _shortDesc = (_descEntry && _descEntry.shortDesc)
                ? (_descEntry.shortDesc[_langNow] || _descEntry.shortDesc['it'] || prod.desc || '')
                : (prod.desc || '');
            document.getElementById('productDesc').textContent = _shortDesc;
            
            // === GESTIONE PREZZO CON/SENZA SCONTO ===
const priceContainer = document.getElementById('productPrice');
const i18n = window.i18nPDP(); // âœ… AGGIUNTO

if (prod.discountPrice && prod.discountPrice < prod.price) {
    // PRODOTTO IN SCONTO
    const discountPercent = Math.round(((prod.price - prod.discountPrice) / prod.price) * 100);
    
    priceContainer.innerHTML = `
        <div class="price-container">
            <div class="price-original">${i18n ? i18n.formatPrice(prod.price, prod.currency || 'EUR') : 'â‚¬ ' + prod.price.toFixed(2)}</div>
            <div class="price-row">
                <div class="price-discounted">${i18n ? i18n.formatPrice(prod.discountPrice, prod.currency || 'EUR') : 'â‚¬ ' + prod.discountPrice.toFixed(2)}</div>
                <span class="discount-badge">-${discountPercent}%</span>
            </div>
        </div>
    `;
} else {
    // PREZZO NORMALE (senza sconto)
    priceContainer.innerHTML = `<div class="price">${i18n ? i18n.formatPrice(prod.price, prod.currency || 'EUR') : 'â‚¬ ' + prod.price.toFixed(2)}</div>`;
}
            document.title = `${prod.title || 'Prodotto'} â€” Dettaglio`;

            if (prod.longDescription) {
                const formattedHtml = formatLongDescription(prod.sku || '', prod.longDescription);
                if (window.DOMPurify) {
                    document.getElementById('longDescription').innerHTML = DOMPurify.sanitize(formattedHtml);
                } else {
                    document.getElementById('longDescription').innerHTML = formattedHtml;
                }
            }

            renderSpecsGrid(prod.specs || {});
            // â”€â”€ DELIVERY ESTIMATOR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            // La funzione Ã¨ async: dopo che Printful risponde, ri-applica la lingua attiva
            initDeliveryEstimator(prod.delivery).then(() => {
                const _inst = window.i18nPDP ? window.i18nPDP() : null;
                const _lang = (_inst && _inst.currentLang) ? _inst.currentLang : 'it';
                if (typeof updateDeliveryEstimatorLanguage === 'function') {
                    updateDeliveryEstimatorLanguage(_lang);
                }
            });
            // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

/**
 * ============================================================
 *  DELIVERY ESTIMATOR â€” LuxHaven360 Ã— Printful (API reale)
 *
 *  Flusso:
 *   1. Geolocalizzazione IP â†’ countryCode
 *   2. Chiamata GAS â†’ action=get_shipping_estimate&sku=...&country=...
 *      (GAS â†’ Printful API â†’ min/max giorni lavorativi reali)
 *   3. Fallback statico se GAS o Printful non rispondono
 * ============================================================ */

const PRINTFUL_FALLBACK_ZONES = {
    'EU_CORE': { countries: ['DE','FR','ES','AT','BE','NL','PT','LU','FI','SE','DK','IE','GR','CY','MT'], offset: { min: 1, max: 4 } },
    'EU_EXT':  { countries: ['PL','CZ','SK','HU','RO','BG','HR','SI','EE','LV','LT'], offset: { min: 2, max: 6 } },
    'UK':      { countries: ['GB'],                         offset: { min: 3, max: 7 } },
    'CH_NO':   { countries: ['CH','NO','IS','LI'],          offset: { min: 5, max: 10 } },
    'NA':      { countries: ['US','CA','MX'],               offset: { min: 10, max: 18 } },
    'AU_NZ':   { countries: ['AU','NZ'],                    offset: { min: 12, max: 20 } }
};

function parseItalyRange(deliveryText) {
    if (!deliveryText) return null;
    const t = deliveryText.trim().toLowerCase();
    if (!t || t === 'da definire' || t === '-' || t === 'n/a' || t === 'tbd') return null;
    const rangeM = t.match(/(\d{1,2})\s*[-â€“]\s*(\d{1,2})/);
    if (rangeM) return { min: parseInt(rangeM[1]), max: parseInt(rangeM[2]) };
    const singleM = t.match(/^(\d{1,2})/);
    if (singleM) { const d = parseInt(singleM[1]); return { min: d, max: d + Math.max(3, Math.ceil(d * 0.4)) }; }
    return null;
}

function getFallbackDays(itRange, countryCode) {
    if (!itRange) return null;
    if (!countryCode || countryCode === 'IT') return { min: itRange.min, max: itRange.max };
    const code = countryCode.toUpperCase();
    let offset = { min: 7, max: 20 }; // WORLD default
    for (const zone of Object.values(PRINTFUL_FALLBACK_ZONES)) {
        if (zone.countries.includes(code)) { offset = zone.offset; break; }
    }
    return { min: itRange.min + offset.min, max: itRange.max + offset.max };
}

function buildDeliveryText(minDays, maxDays, countryCode, lang, source) {
    const T = (window.translationsDelivery && window.translationsDelivery[lang])
        ? window.translationsDelivery[lang]
        : window.translationsDelivery['it'];
    const countryName = (typeof translateCountryName === 'function')
        ? translateCountryName(countryCode || 'IT', lang)
        : (countryCode || 'Italia');

    if (minDays === null || maxDays === null) {
        return { label: T.label, time: `<strong>${countryName}</strong> â€” ${T.tbd}`, note: T.legal_note, icon: 'ðŸ•', isTbd: true };
    }
    const daysText = T.days_range.replace('{min}', minDays).replace('{max}', maxDays);
    return {
        label: T.label,
        time:  `<strong>${countryName}</strong> â€” <strong>${daysText}</strong>`,
        note:  T.legal_note,
        icon:  'ðŸ“¦',
        isTbd: false
    };
}

function renderDeliveryEstimator(data) {
    const estimator = document.getElementById('deliveryEstimator');
    const iconEl    = document.getElementById('deliveryIcon');
    const labelEl   = document.getElementById('deliveryLabel');
    const timeEl    = document.getElementById('deliveryTime');
    const noteEl    = document.getElementById('deliveryNote');
    if (!estimator) return;
    estimator.classList.remove('delivery-estimator--loading', 'delivery-estimator--tbd');
    if (data.isTbd) estimator.classList.add('delivery-estimator--tbd');
    if (iconEl)  iconEl.textContent  = data.icon;
    if (labelEl) labelEl.textContent = data.label;
    if (timeEl)  timeEl.innerHTML    = data.time;
    if (noteEl)  noteEl.textContent  = data.note;
}

async function initDeliveryEstimator(deliveryText) {
    window._lh360_deliveryText = deliveryText;
    const itRange = parseItalyRange(deliveryText);

    // 1. Geolocalizzazione
    let countryCode = 'IT';
    try {
        const geoRes = await fetch('https://ipapi.co/json/');
        if (geoRes.ok) {
            const geo = await geoRes.json();
            if (geo && geo.country_code) countryCode = geo.country_code.toUpperCase();
        }
    } catch (_) {}
    window._lh360_userCountry = countryCode;

    // âœ… FIX: usa i18nPDP (non window.i18n che Ã¨ undefined in questo contesto)
    const _i18nInst = window.i18nPDP ? window.i18nPDP() : null;
    const lang = (_i18nInst && _i18nInst.currentLang) ? _i18nInst.currentLang : 'it';

    // 2. Chiama GAS â†’ Printful API
    const sku = new URLSearchParams(window.location.search).get('sku') || '';
    const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbwr79RkXIEocpuOKaM6uMJqE6VFs9wjlUPvrr__FvDbDDrD2ELB1NbfrWP3BCYpHj2u/exec';

    let minDays = null, maxDays = null, source = 'fallback';

    if (sku) {
        try {
            const apiUrl = `${WEB_APP_URL}?action=get_shipping_estimate&sku=${encodeURIComponent(sku)}&country=${countryCode}&t=${Date.now()}`;
            const apiRes = await fetch(apiUrl);
            if (apiRes.ok) {
                const apiData = await apiRes.json();
                if (apiData.success && apiData.min_days !== null && apiData.min_days !== undefined) {
                    minDays = apiData.min_days;
                    maxDays = apiData.max_days;
                    source  = apiData.source || 'printful';
                    console.log(`âœ… [DeliveryEstimator] Printful (${source}): ${minDays}â€“${maxDays} gg â†’ ${countryCode}`);
                } else {
                    console.warn('[DeliveryEstimator] GAS error:', apiData.error);
                }
            }
        } catch (err) {
            console.warn('[DeliveryEstimator] Chiamata GAS fallita, uso fallback:', err);
        }
    }

    // 3. Fallback statico se Printful non risponde
    if (minDays === null) {
        const fallback = getFallbackDays(itRange, countryCode);
        if (fallback) { minDays = fallback.min; maxDays = fallback.max; }
        source = 'fallback';
        console.log(`âš ï¸ [DeliveryEstimator] Fallback statico: ${minDays}â€“${maxDays} gg â†’ ${countryCode}`);
    }

    window._lh360_deliveryDays   = { min: minDays, max: maxDays };
    window._lh360_deliverySource = source;

    const data = buildDeliveryText(minDays, maxDays, countryCode, lang, source);
    renderDeliveryEstimator(data);
}

function updateDeliveryEstimatorLanguage(lang) {
    const days    = window._lh360_deliveryDays   || { min: null, max: null };
    const country = window._lh360_userCountry    || 'IT';
    const source  = window._lh360_deliverySource || 'fallback';
    const data    = buildDeliveryText(days.min, days.max, country, lang, source);
    renderDeliveryEstimator(data);
}

window.updateDeliveryEstimatorLanguage = updateDeliveryEstimatorLanguage;
            currentProduct = prod;

            // Trova queste righe (circa riga 1120-1140):
if (prod.images_by_color && Object.keys(prod.images_by_color).length > 0) {
    const initialColor = (prod.colors && prod.colors.length > 0) ? prod.colors[0] : Object.keys(prod.images_by_color)[0];
    selectedColor = initialColor || null;
    // AGGIUNTO .filter(Boolean) per rimuovere null/undefined
    images = (selectedColor && prod.images_by_color[selectedColor]) ? prod.images_by_color[selectedColor].filter(Boolean) : [];
} else if (Array.isArray(prod.images) && prod.images.length > 0) {
    // AGGIUNTO .filter(Boolean)
    images = prod.images.filter(Boolean).slice(0, 4);
}

            currentImage = 0;
            renderGallery();

            renderColors(prod.colors);
            renderSizes(prod.sizes);

            // Imposta colore iniziale (primo della lista)
if (prod.colors && prod.colors.length > 0) {
    selectedColor = prod.colors[0];
}

// Imposta immagini iniziali
// La logica backend restituisce giÃ  in prod.images il set del primo colore
if (prod.images && prod.images.length > 0) {
    images = prod.images.slice(); 
} else {
    images = []; // Nessuna immagine
}

// ... renderizza tutto ...
currentImage = 0;
renderGallery();
renderColors(prod.colors);

             if (prod.sizes && prod.sizes.length > 0) {
                  selectedSize = prod.sizes[0];
             }
            // ------------------------------

            const colorBtns = document.querySelectorAll('.color-btn');
            colorBtns.forEach(btn => {
                btn.addEventListener('click', () => selectColor(btn));
            });

            if (prod.sizeGuide) {
                renderSizeGuide(prod.sizeGuide);
            }

            const buyNowBtn = document.getElementById('buyNowBtn');
const addCartBtn = document.getElementById('addCartBtn');

buyNowBtn.textContent = prod.cta || (i18n ? i18n.t('pdp_buy_now') : 'Acquista Ora');
            buyNowBtn.dataset.stripeLink = prod.stripe_link || '';

            // --- INIZIO NUOVA LOGICA ACQUISTA ORA ---
            buyNowBtn.onclick = async function () {
                // 1. Validazione Taglia
                if (currentProduct.sizes && currentProduct.sizes.length > 0 && !selectedSize) {
                    alert('Per favore, seleziona una taglia prima di procedere.');
                    const sizeSection = document.getElementById('sizeSection');
                    if(sizeSection) sizeSection.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    return;
                }

                // 2. Feedback UI (Loader)
                const originalText = buyNowBtn.textContent;
                const i18n = window.i18nPDP();
                buyNowBtn.disabled = true;
                buyNowBtn.innerHTML = `<span class="loader-dot" style="display:inline-block;width:10px;height:10px;background:black;border-radius:50%;margin-right:5px;animation:pulse 1s infinite"></span> ${i18n ? i18n.t('pdp_processing') : 'Elaborazione...'}`;

                const globalLoader = document.getElementById('luxhaven-loader');
                if(globalLoader) {
                   document.getElementById('loader-message').textContent = i18n ? i18n.t('pdp_loader_checkout') : 'Preparazione Checkout Sicuro...';
                   globalLoader.style.display = 'flex';
                   globalLoader.style.opacity = '1';
                }

                try {
                    // 3. Preparazione Dati
                    let checkoutImage = images[0] || ''; 
    
                    // --- CALCOLO PREZZO FINALE (con sconto se presente) ---
                    const itemPrice = (currentProduct.discountPrice && currentProduct.discountPrice < currentProduct.price) 
                    ? parseFloat(currentProduct.discountPrice) 
                    : parseFloat(currentProduct.price) || 0;
    
                    // --- CALCOLO SPEDIZIONE ---
                    // Se prezzo < 150â‚¬ aggiungi 15â‚¬, altrimenti 0
                    const shippingCost = itemPrice < 150 ? 15 : 0;

                    const singleItemCart = [{
                        sku: currentProduct.sku,
                        title: currentProduct.title,
                        category: currentProduct.category || 'Prodotto', // âœ… AGGIUNTO
                        price: itemPrice,
                        currency: currentProduct.currency || 'EUR',
                        qty: 1,
                        color: selectedColor || '',
                        size: selectedSize || '',
                        image: checkoutImage
                    }];
 
                    // 4. Costruzione Payload
                    // âœ… RECUPERA LINGUA CORRENTE
const i18n = window.i18nPDP();
const currentLang = i18n ? i18n.currentLang : 'it';

console.log('ðŸŒ Lingua corrente pdp-products.html:', currentLang); // DEBUG

const payload = {
    action: 'create_checkout_session',
    data: JSON.stringify({
        cart: singleItemCart,
        shipping: shippingCost,
        cancel_url: window.location.href,
        is_buy_now: true,
        lang: currentLang,  // âœ… AGGIUNGI PARAMETRO LINGUA
        checkout_metadata: {
            product_sku: currentProduct.sku,
            selected_color: selectedColor || '',
            selected_size: selectedSize || ''
        }
    })
};

console.log('ðŸ“¦ Payload inviato:', payload); // DEBUG
                    
// 6. SALVA IN LOCALSTORAGE PER SUCCESS.HTML
const tempCart = [{
    sku: currentProduct.sku,
    title: currentProduct.title,
    category: currentProduct.category || 'Prodotto', // âœ… AGGIUNTO
    price: currentProduct.price || 0,
    discountPrice: currentProduct.discountPrice || null,
    currency: currentProduct.currency || 'EUR',
    qty: 1,
    color: selectedColor || '',
    size: selectedSize || '',
    image: checkoutImage
}];

localStorage.setItem('lh360_cart', JSON.stringify(tempCart));
localStorage.setItem('lh360_applied_discounts', JSON.stringify({
    comboDiscount: 0,
    couponDiscount: 0,
    couponCode: null,
    isComboActive: false,
    totalDiscount: 0,
    timestamp: Date.now()
}));
                    
                    // 5. Chiamata API Backend
                    const queryParams = new URLSearchParams(payload).toString();
                    const response = await fetch(`${WEB_APP_URL}?${queryParams}`, {
                        method: 'GET',
                        redirect: 'follow'
                    });

                    if (!response.ok) throw new Error('Errore di rete');
                    const result = await response.json();

                    if (result.success && result.url) {
                        window.location.href = result.url;
                    } else {
                        throw new Error(result.error || 'Impossibile creare la sessione');
                    }

                } catch (error) {
                    console.error('Errore Checkout:', error);
                    alert('Si Ã¨ verificato un errore durante l\'avvio del pagamento. Riprova.');
                    
                    buyNowBtn.disabled = false;
                    buyNowBtn.textContent = originalText;
                    if(globalLoader) {
                        globalLoader.style.opacity = '0';
                        setTimeout(() => globalLoader.style.display = 'none', 500);
                    }
                }
            };
            // --- FINE NUOVA LOGICA ACQUISTA ORA ---

            addCartBtn.onclick = function () {
    const cartRaw = localStorage.getItem('lh360_cart');
    let cart = [];
    try { cart = cartRaw ? JSON.parse(cartRaw) : []; } catch(e){ cart = []; }
    
    // --- MODIFICA QUI ---
    // Ora cerchiamo un prodotto che abbia lo stesso SKU E lo stesso colore E la stessa taglia
    const existing = cart.find(i => 
        i.sku === prod.sku && 
        i.color === (selectedColor || '') && 
        i.size === (selectedSize || '')
    );
    // --------------------

    if (existing) {
        existing.qty = (existing.qty || 1) + 1;
    } else {
        cart.push({
          sku: prod.sku,
          title: prod.title,
          category: prod.category || 'Prodotto', // âœ… AGGIUNTO
          price: prod.price || 0,
          discountPrice: prod.discountPrice || null,
          currency: prod.currency || 'EUR',
          qty: 1,
          color: selectedColor || '',
          size: selectedSize || '',
          image: images[0] || '',
          timestamp: Date.now()
       });
    }
    localStorage.setItem('lh360_cart', JSON.stringify(cart));
    
    const i18n = window.i18nPDP();
    addCartBtn.textContent = i18n ? i18n.t('pdp_added_to_cart') : 'Aggiunto âœ“';
    setTimeout(() => {
        addCartBtn.textContent = i18n ? i18n.t('pdp_add_to_cart') : 'Aggiungi al Carrello';
    }, 1500);
    updateCartIcon();
};
        }

        function updateCartIcon() {
            const cart = JSON.parse(localStorage.getItem('lh360_cart')) || [];
            const cartIcon = document.getElementById('cartIcon');
            if (cart.length > 0) {
                cartIcon.classList.add('show');
            } else {
                cartIcon.classList.remove('show');
            }
        }

        // Genera Device Fingerprint Unificato
async function generateDeviceFingerprint() {
    try {
        const fp = await FingerprintJS.load();
        const result = await fp.get();
        
        // Estrae i primi 8 caratteri dell'hash
        const hash8 = result.visitorId.substring(0, 8).toUpperCase();
        
        // Determina il tipo di dispositivo
        const ua = navigator.userAgent.toLowerCase();
        if (/(tablet|ipad|playbook|silk)|(android(?!.*mobi))/i.test(ua)) {
            deviceType = 'T'; // Tablet
        } else if (/mobile|iphone|ipod|android|blackberry|opera mini|iemobile/i.test(ua)) {
            deviceType = 'M'; // Mobile
        } else {
            deviceType = 'D'; // Desktop
        }
        
        // Formato: LH360-<8char>-<Tipo>
        deviceFingerprint = `LH360-${hash8}-${deviceType}`;
        
        console.log('ðŸ” Device ID generato:', deviceFingerprint);
    } catch (error) {
        console.error('âŒ Errore generazione fingerprint:', error);
        // Fallback: usa timestamp + random
        const fallback = Math.random().toString(36).substring(2, 10).toUpperCase();
        deviceFingerprint = `LH360-${fallback}-${deviceType}`;
    }
}

        /* ====== Rilevamento Paese Utente (IP Geolocation) ====== */
        async function detectUserCountry() {
            try {
                const res = await fetch('https://ipapi.co/json/', { signal: AbortSignal.timeout(5000) });
                if (!res.ok) return;
                const data = await res.json();
                if (data && data.country_code) {
                    userCountryCode = data.country_code.toUpperCase();
                    console.log('ðŸŒ Paese rilevato:', userCountryCode);
                }
            } catch (e) {
                console.warn('âš ï¸ Impossibile rilevare il paese:', e);
            }
        }

        /* ====== Init ====== */
        document.addEventListener('DOMContentLoaded', () => {
            startDynamicLoader();
            // Genera Device Fingerprint
            generateDeviceFingerprint();
            // Rileva paese utente in background
            detectUserCountry();
            renderGallery();
            loadProduct();
            setupReviewForm();
            
            // Ricalcola specifiche al cambio lingua
document.addEventListener('languageChanged', (e) => {
    if (currentProduct) {
        // âœ… Re-renderizza specifiche (etichette + valori tradotti)
        renderSpecsGrid(currentProduct.specs || {});
        // âœ… Re-renderizza guida taglie (intestazioni + valori per-SKU tradotti)
        if (currentProduct.sizeGuide) {
            renderSizeGuide(currentProduct.sizeGuide);
        } else {
            // Aggiorna solo le etichette se la guida Ã¨ giÃ  visibile
            if (typeof updateTableLabels === 'function') updateTableLabels();
        }
        // âœ… Re-renderizza i bottoni taglia con la nuova lingua
        if (currentProduct.sizes && currentProduct.sizes.length > 0) {
            renderSizes(currentProduct.sizes);
            // Ripristina il bottone attivo in base alla selezione corrente
            if (selectedSize) {
                document.querySelectorAll('.size-btn').forEach(btn => {
                    if ((btn.dataset.sizeIt || '') === selectedSize) {
                        btn.classList.add('active');
                    }
                });
            }
        }
    }
    // âœ… Aggiorna delivery estimator nella nuova lingua
    const lang = (e.detail && e.detail.lang) || (window.i18n && window.i18n.currentLang) || 'it';
    if (typeof updateDeliveryEstimatorLanguage === 'function') {
        updateDeliveryEstimatorLanguage(lang);
    }
});
            
            updateCartIcon();
            
            const cartIcon = document.getElementById('cartIcon');
            if (cartIcon) {
                cartIcon.addEventListener('click', () => {
                    window.location.href = 'cart.html';
                });
            }

            // --- LOGICA CUORE / PREFERITI ---
    const favBtn = document.getElementById('favBtn');
    if (favBtn) {
        favBtn.addEventListener('click', function() {
            this.classList.toggle('active');
            
            // Cambia il simbolo (opzionale, CSS gestisce il colore)
            if (this.classList.contains('active')) {
                this.textContent = 'â™¥'; // Cuore pieno
                // Qui potresti salvare nei localStorage o inviare API
                console.log('Aggiunto ai preferiti');
            } else {
                this.textContent = 'â™¡'; // Cuore vuoto
                console.log('Rimosso dai preferiti');
            }
        });
    }
        });

        // FIX: Ripristina stato pulsanti quando si torna indietro con il browser
window.addEventListener('pageshow', function(event) {
    if (event.persisted) {
        const loader = document.getElementById('luxhaven-loader');
        const buyBtn = document.getElementById('buyNowBtn');
        
        if (loader) loader.style.display = 'none';
        if (buyBtn) {
            buyBtn.disabled = false;
            buyBtn.textContent = currentProduct?.cta || 'Acquista Ora';
        }
    }
});

        // --- FIX: Funzione per chiudere le modali (Risolve errore console) ---
function closeModal(modalId) {
    const modal = document.getElementById(modalId);
    if (modal) {
        modal.classList.remove('active');
    }
}

        /**
 * Aggiorna tutti i prezzi con la nuova lingua/valuta
 */
/**
 * Aggiorna breve descrizione e descrizione lunga nella lingua corrente.
 * Viene chiamata da updateAllPricesForLanguage() ad ogni cambio lingua.
 * Funziona solo se currentProduct Ã¨ definito (pagina pdp-products.html).
 */
function updateDescriptionsForLanguage() {
    if (typeof currentProduct === 'undefined' || !currentProduct || !currentProduct.sku) return;

    const i18n = window.i18nPDP();
    const lang = i18n ? i18n.currentLang : 'it';
    const descMap = window.translationsDescriptions || {};
    const entry = descMap[currentProduct.sku];

    if (!entry) return; // SKU non presente nel file traduzioni â†’ nessuna azione

    // â”€â”€ Breve descrizione â”€â”€
    const shortDescEl = document.getElementById('productDesc');
    if (shortDescEl && entry.shortDesc) {
        const translated = entry.shortDesc[lang] || entry.shortDesc['it'] || '';
        if (translated) shortDescEl.textContent = translated;
    }

    // â”€â”€ Descrizione lunga â”€â”€
    const longDescEl = document.getElementById('longDescription');
    if (longDescEl && entry.longDesc) {
        const blocks = entry.longDesc[lang] || entry.longDesc['it'] || null;
        if (blocks && blocks.length) {
            const html = _renderDescriptionBlocks(blocks);
            if (window.DOMPurify) {
                longDescEl.innerHTML = DOMPurify.sanitize(html);
            } else {
                longDescEl.innerHTML = html;
            }
        }
    }
}

function updateAllPricesForLanguage() {
    const i18n = window.i18nPDP();
    if (!i18n) return;
    
    // In cart.html: aggiorna summary
    if (typeof updateSummary === 'function') {
        updateSummary();
    }
    
    // âœ… AGGIUNTO: Verifica che currentProduct esista (solo in pdp-products.html)
    if (typeof currentProduct !== 'undefined' && currentProduct && currentProduct.price) {
        const priceContainer = document.getElementById('productPrice');
        if (priceContainer) {
            if (currentProduct.discountPrice && currentProduct.discountPrice < currentProduct.price) {
                const discountPercent = Math.round(((currentProduct.price - currentProduct.discountPrice) / currentProduct.price) * 100);
                
                priceContainer.innerHTML = `
                    <div class="price-container">
                        <div class="price-original">${i18n.formatPrice(currentProduct.price, currentProduct.currency || 'EUR')}</div>
                        <div class="price-row">
                            <div class="price-discounted">${i18n.formatPrice(currentProduct.discountPrice, currentProduct.currency || 'EUR')}</div>
                            <span class="discount-badge">-${discountPercent}%</span>
                        </div>
                    </div>
                `;
            } else {
                priceContainer.innerHTML = `<div class="price">${i18n.formatPrice(currentProduct.price, currentProduct.currency || 'EUR')}</div>`;
            }
        }
    }

    // â”€â”€ Aggiorna descrizioni tradotte al cambio lingua â”€â”€
    updateDescriptionsForLanguage();
    
    // Aggiorna prezzi nelle card (se presenti)
    document.querySelectorAll('.card').forEach(card => {
        const originalPrice = parseFloat(card.dataset.originalPrice);
        const originalCurrency = card.dataset.originalCurrency || 'EUR';
        
        if (!originalPrice) return;
        
        const discountPrice = parseFloat(card.dataset.discountPrice);
        const hasDiscount = discountPrice && discountPrice < originalPrice;
        
        if (hasDiscount) {
            const originalPriceEl = card.querySelector('div[style*="text-decoration: line-through"]');
            if (originalPriceEl) {
                originalPriceEl.textContent = i18n.formatPrice(originalPrice, originalCurrency);
            }
            
            const discountedPriceEl = card.querySelector('div[style*="background-clip: text"]');
            if (discountedPriceEl && discountedPriceEl.parentElement.style.display === 'flex') {
                discountedPriceEl.textContent = i18n.formatPrice(discountPrice, originalCurrency);
            }
        } else {
            const priceElement = card.querySelector('.card-price');
            if (priceElement) {
                priceElement.textContent = i18n.formatPrice(originalPrice, originalCurrency);
            }
        }
    });
}
        // Ascolta cambio lingua da altre pagine
window.addEventListener('storage', (event) => {
    if (event.key === 'lh360_lang' && event.newValue) {
        const i18n = window.i18nPDP();
        if (i18n && i18n.currentLang !== event.newValue) {
            i18n.changeLanguage(event.newValue);
        }
    }
});
        // Ricalcola recensioni al cambio lingua
document.addEventListener('languageChanged', () => {
    if (currentReviewsData && currentReviewsData.length > 0) {
        displayReviews(currentReviewsData, true);
    }
});
        
        // ============================================================
        //  FORMATTAZIONE DESCRIZIONE LUNGA
        //  1. Cerca traduzioni in translationsDescriptions (per SKU noti)
        //  2. Fallback: SKU hardcoded (italiano)
        //  3. Fallback finale: parser automatico sul testo grezzo
        // ============================================================

        function formatLongDescription(sku, rawText) {
            if (!rawText && !sku) return '';

            // â”€â”€ 1. Cerca nella mappa traduzioni per la lingua corrente â”€â”€
            const i18n = window.i18nPDP();
            const lang = i18n ? i18n.currentLang : 'it';
            const descMap = window.translationsDescriptions || {};

            if (descMap[sku] && descMap[sku].longDesc && descMap[sku].longDesc[lang]) {
                return _renderDescriptionBlocks(descMap[sku].longDesc[lang]);
            }

            // â”€â”€ 2. Fallback: blocchi IT (se non Ã¨ disponibile la lingua richiesta) â”€â”€
            if (descMap[sku] && descMap[sku].longDesc && descMap[sku].longDesc['it']) {
                return _renderDescriptionBlocks(descMap[sku].longDesc['it']);
            }

            // â”€â”€ 3. Fallback finale: parser generico sul testo grezzo â”€â”€
            if (!rawText) return '';
            return _parseDescriptionToHtml(rawText);
        }

        /**
         * Converte un array di blocchi tipizzati in HTML.
         * Supporta **bold** inline â†’ <strong>
         */
        function _renderDescriptionBlocks(blocks) {
            if (!blocks || !blocks.length) return '';

            const _b = (text) => String(text || '').replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');

            return blocks.map(block => {
                switch (block.type) {
                    case 'single':
                        return `<p class="desc-single">${_b(block.text)}</p>`;
                    case 'single-tight-bottom':
                        return `<p class="desc-single tight-bottom">${_b(block.text)}</p>`;
                    case 'para':
                        return `<p class="desc-para">${_b(block.text)}</p>`;
                    case 'para-tight-top':
                        return `<p class="desc-para tight-top">${_b(block.text)}</p>`;
                    case 'italic':
                        return `<p class="desc-italic">${_b(block.text)}</p>`;
                    case 'list-header':
                        return `<p class="desc-list-header">${_b(block.text)}</p>`;
                    case 'list':
                        return `<ul class="desc-list">${(block.items || []).map(i => `<li>${_b(i)}</li>`).join('')}</ul>`;
                    case 'size-note':
                        return `<p class="desc-size-note">${_b(block.text)}</p>`;
                    case 'divider':
                        return `<div class="desc-divider"><span class="desc-divider-dot"></span></div>`;
                    default:
                        return block.text ? `<p class="desc-para">${_b(block.text)}</p>` : '';
                }
            }).join('\n');
        }

        /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
           HARDCODED: ME-01-LE  (Vault Keys Hoodie)
        â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        function _buildME01LE() {
            return `
<p class="desc-single">Alcune felpe si indossano. Questa si abita.</p>
<p class="desc-para">La <strong>Vault Keys Hoodie</strong> non Ã¨ un capo qualunque: Ã¨ il primo oggetto da collezione firmato LuxHaven360, nato per chi non si accontenta dell'ordinario e vuole portare con sÃ© ogni giorno l'estetica di un mondo fatto di proprietÃ  straordinarie, chiavi simboliche e architetture senza tempo.</p>
<p class="desc-para">La grafica all over, esclusiva e progettata nei minimi dettagli, avvolge ogni centimetro del tessuto con un pattern di chiavi dorate e facciate nobiliari su fondo blu notte. Un'opera d'arte che si indossa.</p>
<div class="desc-divider"><span class="desc-divider-dot"></span></div>
<p class="desc-single">Il tessuto fa la differenza.</p>
<p class="desc-para">Realizzata in misto poliestere riciclato e spandex (95/5), offre una vestibilitÃ  rilassata e una morbidezza inaspettata, grazie all'esterno effetto cotone e all'interno in pile spazzolato. Calda quando serve. Leggera quando vuoi.</p>
<p class="desc-single">I dettagli rivelano l'ossessione per la qualitÃ .</p>
<p class="desc-para">Cappuccio a doppio strato con grafica su entrambi i lati, cordini con occhielli ed estremitÃ  in metallo, cuciture overlock. Ogni pezzo Ã¨ stampato, tagliato e cucito a mano da un team specializzato.</p>
<p class="desc-single">Rispetto per il pianeta, senza compromessi.</p>
<p class="desc-para">Il contenuto riciclato Ã¨ certificato GRS (Global Recycled Standard). Il tessuto Ã¨ certificato OEKO-TEX Standard 100.</p>
<div class="desc-divider"><span class="desc-divider-dot"></span></div>
<p class="desc-italic">Grammatura: 308 g/mÂ² Â· Stile unisex Â· Edizione limitata LuxHaven360</p>
<p class="desc-single">Questa non Ã¨ una felpa. Ãˆ il tuo biglietto d'ingresso.</p>`;
        }

        /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
           HARDCODED: ME-01-L&A  (Cappello)
        â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        function _buildME01LA() {
            return `
<p class="desc-single">Alcune cose parlano da sole. Questo cappello Ã¨ una di quelle.</p>
<p class="desc-para">Realizzato in twill di chino 100% cotone, strutturato per durare e pensato per chi non scende a compromessi sull'estetica. Il ricamo delle iniziali LuxHaven360 â€” posizionato sulla calotta con precisione artigianale â€” non Ã¨ una decorazione: Ã¨ un riconoscimento. Un dettaglio che chi sa, nota.</p>
<p class="desc-para">La visiera curva, i 6 pannelli a profilo basso e la fascia regolabile con fibbia anticata restituiscono una vestibilitÃ  impeccabile, adatta a ogni occasione â€” che tu stia visitando una villa sul lago o guidando lungo la costiera.</p>
<div class="desc-divider"><span class="desc-divider-dot"></span></div>
<p class="desc-list-header">Dettagli costruttivi:</p>
<ul class="desc-list">
  <li>100% twill di chino di cotone</li>
  <li>Struttura a 6 pannelli, profilo basso</li>
  <li>6 occhielli ricamati</li>
  <li>Calotta da 3 â…›"</li>
  <li>Fascetta regolabile con fibbia anticata in finitura vintage</li>
  <li>Ricamo esclusivo con le iniziali del brand</li>
</ul>
<div class="desc-divider"><span class="desc-divider-dot"></span></div>
<p class="desc-single">Portare LuxHaven360 non Ã¨ una scelta di stile. Ãˆ una dichiarazione di appartenenza.</p>`;
        }

        /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
           HARDCODED: ME-01-A  (Signature Long Sleeve)
        â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        function _buildME01A() {
            return `
<p class="desc-single">Indossare un'idea. Rappresentare uno stile.</p>
<p class="desc-para">Questa non Ã¨ semplicemente una maglietta a maniche lunghe. Ãˆ un contatto fisico con il mondo LuxHaven360, un brand nato per chi sa riconoscere il valore delle cose senza dover alzare la voce.</p>
<p class="desc-para">Realizzata in 100% cotone filato ad anello da 206,8 g/mÂ², la Signature Long Sleeve ha un peso e una morbidezza che si sentono al primo tocco. Il processo di tintura in capo le conferisce un carattere visivo ricercato, volutamente vissuto, impossibile da replicare: ogni capo Ã¨ unico, come lo Ã¨ chi lo sceglie.</p>
<p class="desc-para">Prelevata per mantenere forma e colore nel tempo, costruita con nastro in twill da spalla a spalla e polsini a costine per una vestibilitÃ  che non tradisce mai. Dettagli pensati per durare, non per fare scena.</p>
<div class="desc-divider"><span class="desc-divider-dot"></span></div>
<p class="desc-list-header">Caratteristiche principali:</p>
<ul class="desc-list">
  <li>100% cotone morbido filato ad anello</li>
  <li>Peso: 206,8 g/mÂ² â€” consistente al tatto, confortevole tutto il giorno</li>
  <li>Tessuto tinto in capo, prelavato â€” aspetto ricercato, forma duratura</li>
  <li>Colletto classico con cucitura a vista</li>
  <li>Rinforzo in twill su colletto, spalle e nastro interno</li>
  <li>Polsini a costine dal fit preciso</li>
  <li>VestibilitÃ  unisex comoda e versatile</li>
</ul>`;
        }

        /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
           HARDCODED: ME-02-LE  (LH-EST 001)
        â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        function _buildME02LE() {
            return `
<p class="desc-single">Il tuo punto di partenza verso qualcosa di piÃ¹ grande.</p>
<p class="desc-para">LH-EST 001 non Ã¨ una semplice maglietta. Ãˆ il primo pezzo di una collezione pensata per chi sa riconoscere il valore delle cose nel modo in cui si veste, nei luoghi che abita, nelle scelte che fa.</p>
<p class="desc-para">Sul retro, le coordinate 45Â°49N | 7Â°22'E segnano un punto preciso nel mondo. La rosa dei venti incisa in oro antico richiama l'orientamento, la direzione, l'intenzione. Il tutto su un fondo nero intenso che parla da solo.</p>
<div class="desc-divider"><span class="desc-divider-dot"></span></div>
<p class="desc-single">Indossarla Ã¨ prendere posizione.</p>
<p class="desc-single tight-bottom">Costruita per durare, progettata per distinguere.</p>
<p class="desc-para tight-top">Realizzata in 100% cotone biologico ring-spun con grammatura da 180 g/mÂ², questa t-shirt offre una vestibilitÃ  regular pulita e una mano morbida che migliora con ogni lavaggio. Non si restringe al primo utilizzo. Non perde forma con il tempo.</p>
<ul class="desc-list">
  <li><strong>Tessuto certificato GOTS e OCS</strong> â€” cotone biologico verificato dalla filiera</li>
  <li><strong>Certificazione OEKO-TEX Standard 100</strong> â€” nessuna sostanza nociva</li>
  <li><strong>Approvato come vegano da PETA</strong></li>
  <li>Collo a costine 1Ã—1 rinforzato | Maniche riportate | Impunture a doppio ago</li>
  <li>Produzione controllata e tracciabile</li>
</ul>
<div class="desc-divider"><span class="desc-divider-dot"></span></div>
<p class="desc-single">Edizione Limitata. Una volta esaurita, non torna.</p>
<p class="desc-para">LH-EST 001 Ã¨ il numero uno di una serie riservata a chi entra a far parte del mondo LuxHaven360 fin dall'inizio. Non ci sono restock programmati. Non ci sono seconde opportunitÃ .</p>
<p class="desc-size-note"><strong>Nota sulle taglie:</strong> Se acquisti negli Stati Uniti, ti consigliamo di scegliere una taglia in piÃ¹ rispetto alla tua abituale.</p>`;
        }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           PARSER GENERICO â€” prodotti futuri
           Applica formattazione luxury automatica partendo dal
           testo grezzo della colonna "Descrizione Lunga".
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

        function _parseDescriptionToHtml(rawText) {
            // â”€â”€ 1. Estrai "Nota sulle taglie:" prima di qualsiasi altra elaborazione â”€â”€
            const SIZE_NOTE_RE = /Nota sulle taglie\s*:/i;
            let mainText = rawText;
            let sizeNoteContent = null;

            const snIdx = rawText.search(SIZE_NOTE_RE);
            if (snIdx !== -1) {
                mainText = rawText.slice(0, snIdx).replace(/[\s<br\/>]+$/gi, '');
                sizeNoteContent = rawText.slice(snIdx).replace(/<br\s*\/?>/gi, ' ').trim();
            }

            // â”€â”€ 2. Spezza il testo nelle sezioni separate da <br><br> â”€â”€
            const rawSections = mainText
                .split(/(?:<br\s*\/?>)\s*(?:<br\s*\/?>)/gi)
                .map(s => s.replace(/<br\s*\/?>/gi, '\n').trim())
                .filter(Boolean);

            // â”€â”€ 3. Converti ogni sezione in blocchi semantici â”€â”€
            let blocks = [];
            for (const section of rawSections) {
                blocks = blocks.concat(_sectionToBlocks(section));
            }

            // â”€â”€ 4. Inserisci separatori decorativi tra macro-sezioni distanti â”€â”€
            blocks = _insertDividers(blocks);

            // â”€â”€ 5. Accoda la nota taglie se presente â”€â”€
            if (sizeNoteContent) {
                blocks.push({ type: 'size-note', content: sizeNoteContent });
            }

            return _renderBlocks(blocks);
        }

        /**
         * Analizza una singola sezione e la converte in blocchi tipizzati.
         * Tipi: 'hook', 'para', 'list-header', 'list-items'
         *
         * Casi gestiti:
         *  A) Lista multiriga  â†’ "Intestazione:\nitem1\nitem2"  (Alt+Enter nel foglio)
         *  B) Lista su riga singola â†’ "Intestazione: item1 Item2 Item3"
         *     dove gli item non terminano con punto (segnale distintivo dalla prosa)
         */
        function _sectionToBlocks(text) {
            if (!text) return [];

            // â”€â”€ CASO A: lista multiriga "Header:\nitem1\nitem2â€¦" â”€â”€
            const multiLineList = text.match(/^([^\n:]{1,80}):\n([\s\S]+)$/);
            if (multiLineList) {
                const header = multiLineList[1].trim();
                if (header.split(/\s+/).length <= 5) {
                    const items = multiLineList[2].split('\n').map(x => x.trim()).filter(Boolean);
                    return [
                        { type: 'list-header', content: header },
                        { type: 'list-items',  items }
                    ];
                }
            }

            // â”€â”€ CASO B: lista inline (header ovunque nel testo, non solo in cima) â”€â”€
            // Cerca "Header breve (â‰¤5 parole):" preceduto da inizio o fine frase,
            // seguito da contenuto che inizia con maiuscola/cifra/simbolo.
            const inline = _findInlineList(text);
            if (inline) {
                const blocks = [];
                if (inline.before) blocks.push(..._proseToBlocks(inline.before));
                blocks.push({ type: 'list-header', content: inline.header });
                blocks.push({ type: 'list-items',  items: inline.items });
                if (inline.after)  blocks.push(..._proseToBlocks(inline.after));
                return blocks;
            }

            // â”€â”€ Fallback: prosa â”€â”€ individua hook e paragrafi
            return _proseToBlocks(text);
        }

        /**
         * Individua una lista inline nel testo.
         * Formato tipico: "...prosa. Header: voce1 Voce2 Voce3 ...prosa."
         *
         * Il header puÃ² stare ovunque: in apertura, in mezzo o alla fine del testo.
         * Restituisce { before, header, items, after } oppure null se non trovata.
         */
        function _findInlineList(text) {
            // Pattern: (inizio | fine-frase ". ") + "Header (â‰¤5 parole):" + spazio + contenuto-uppercase
            const m = text.match(/((?:^|\.\s+))([A-ZÃ€ÃˆÃ‰ÃŒÃ’Ã™Ã‡][^.:\n]{2,60}):\s+([A-ZÃ€ÃˆÃ‰ÃŒÃ’Ã™Ã‡0-9%'""Â«].+)/s);
            if (!m) return null;

            const header = m[2].trim();
            if (header.split(/\s+/).length > 5) return null;

            // Testo prima dell'intestazione (include il "." della frase precedente)
            const before = text.slice(0, m.index + m[1].trimEnd().length).trim();

            // Tutto quello che viene dopo "Header: "
            const afterColon = m[3];

            // â”€â”€ Split sulle frontiere lowercaseâ†’uppercase: segnale di nuova voce â”€â”€
            const parts = afterColon
                .split(/(?<=[a-zÃ -Ã¿0-9"''%Â°Â²Â³â´â…›â…œâ…â…žÂ»Â·â€”])\s+(?=[A-ZÃ€ÃˆÃ‰ÃŒÃ’Ã™Ã‡])/)
                .map(s => s.trim())
                .filter(Boolean);

            if (parts.length < 2) return null;

            // â”€â”€ Separa prosa finale dalle voci lista â”€â”€
            // Dalla fine, se una parte termina con "." e ha â‰¥ 4 parole
            // Ã¨ una frase di prosa, non una voce: la sposta in "after".
            let splitAt = parts.length;
            for (let i = parts.length - 1; i >= 0; i--) {
                if (parts[i].endsWith('.') && parts[i].split(/\s+/).length >= 4) {
                    splitAt = i;
                } else {
                    break;
                }
            }

            const items = parts.slice(0, splitAt).filter(Boolean);
            const after = parts.slice(splitAt).join(' ').trim();

            if (items.length < 2) return null;

            return { before, header, items, after };
        }

        /**
         * Data una sezione di prosa, rileva hook (frasi brevi, â‰¤ 11 parole)
         * in apertura e chiusura, e raggruppa il resto in paragrafi.
         */
        function _proseToBlocks(text) {
            const MAX_HOOK = 11;
            const sentences = _splitSentences(text);
            if (!sentences.length) return [{ type: 'para', content: text }];

            const isHook = s => s.split(/\s+/).filter(Boolean).length <= MAX_HOOK;

            // Hook di apertura
            let start = 0;
            while (start < sentences.length && isHook(sentences[start])) start++;
            const openHooks = sentences.slice(0, start);

            // Hook di chiusura
            let end = sentences.length - 1;
            while (end >= start && isHook(sentences[end])) end--;
            const closeHooks = sentences.slice(end + 1);

            // Corpo
            const body = sentences.slice(start, end + 1);

            const blocks = [];
            if (openHooks.length)  blocks.push({ type: 'hook', sentences: openHooks });

            // Raggruppa corpo in paragrafi da 2-3 frasi
            const CHUNK = 3;
            for (let i = 0; i < body.length; i += CHUNK) {
                blocks.push({ type: 'para', content: body.slice(i, i + CHUNK).join(' ') });
            }

            if (closeHooks.length) blocks.push({ type: 'hook', sentences: closeHooks });
            return blocks;
        }

        /**
         * Spezza un testo in frasi: ". " seguito da lettera maiuscola o cifra.
         */
        function _splitSentences(text) {
            const clean = text.replace(/\n/g, ' ').replace(/\s{2,}/g, ' ').trim();
            return clean
                .split(/(?<=\.)\s+(?=[A-ZÃ€ÃˆÃ‰ÃŒÃ’Ã™Ã‡0-9"Â«])/)
                .map(s => s.trim())
                .filter(Boolean)
                .map(s => s.endsWith('.') ? s : s + '.');
        }

        /**
         * Inserisce un separatore decorativo (.desc-divider) tra un hook-group
         * di chiusura e il blocco successivo (o tra macro-sezioni distanti).
         */
        function _insertDividers(blocks) {
            const out = [];
            for (let i = 0; i < blocks.length; i++) {
                out.push(blocks[i]);
                const curr = blocks[i];
                const next = blocks[i + 1];
                if (!next) continue;

                // Inserisci divisore dopo lista, prima di un hook, o prima di list-header
                const afterList  = curr.type === 'list-items';
                const beforeHook = next.type === 'hook' && next.sentences.length >= 1;
                const beforeListH = next.type === 'list-header';

                if (afterList || (beforeHook && i > 0) || beforeListH) {
                    out.push({ type: 'divider' });
                }
            }
            return out;
        }

        /**
         * Converte l'array di blocchi in HTML finale.
         */
        function _renderBlocks(blocks) {
            let html = '';

            for (let i = 0; i < blocks.length; i++) {
                const block = blocks[i];
                const prev  = blocks[i - 1];
                const next  = blocks[i + 1];

                // â”€â”€ hook / frase singola in evidenza â”€â”€
                if (block.type === 'hook' || block.type === 'single-group') {
                    const sents = block.sentences || block.sentences;
                    const isPair = sents.length >= 2;
                    const nextIsPara = next && (next.type === 'para' || next.type === 'list-items');

                    for (let j = 0; j < sents.length; j++) {
                        const last = j === sents.length - 1;
                        const tightBottom = isPair && last && nextIsPara;
                        const cls = 'desc-single' + (tightBottom ? ' tight-bottom' : '');
                        html += `<p class="${cls}">${sents[j]}</p>`;
                    }

                // â”€â”€ paragrafo di corpo â”€â”€
                } else if (block.type === 'para') {
                    const prevIsPair = prev &&
                        (prev.type === 'hook' || prev.type === 'single-group') &&
                        (prev.sentences || []).length >= 2;
                    const cls = 'desc-para' + (prevIsPair ? ' tight-top' : '');
                    html += `<p class="${cls}">${block.content}</p>`;

                // â”€â”€ intestazione lista â”€â”€
                } else if (block.type === 'list-header') {
                    html += `<p class="desc-list-header">${block.content}:</p>`;

                // â”€â”€ voci lista â”€â”€
                } else if (block.type === 'list-items') {
                    html += '<ul class="desc-list">';
                    for (const item of block.items) {
                        html += `<li>${item}</li>`;
                    }
                    html += '</ul>';

                // â”€â”€ separatore decorativo â”€â”€
                } else if (block.type === 'divider') {
                    html += '<div class="desc-divider"><span class="desc-divider-dot"></span></div>';

                // â”€â”€ corsivo generico â”€â”€
                } else if (block.type === 'italic') {
                    html += `<p class="desc-italic">${block.content}</p>`;

                // â”€â”€ nota sulle taglie â”€â”€
                } else if (block.type === 'size-note') {
                    const noteHtml = block.content.replace(
                        /^(Nota sulle taglie\s*:)\s*/i,
                        '<strong>$1</strong> '
                    );
                    html += `<p class="desc-size-note">${noteHtml}</p>`;
                }
            }

            return html;
        }

    </script>

    <script>
        /* â”€â”€ Refund Policy Toggle â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        function toggleRefundPolicy() {
            const box = document.getElementById('refundPolicy');
            if (box) box.classList.toggle('open');
        }
    </script>
</body>
</html>
