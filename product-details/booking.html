<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prenota il Tuo Test Drive</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        // Suppress Tailwind CDN warning
        tailwind.config = {
            theme: {
                extend: {}
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600;700&family=Inter:wght@300;400;500;600&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #0a0a0a 0%, #1a1412 30%, #2d1810 60%, #0a0a0a 100%);
            min-height: 100vh;
            color: #f5f5f0;
        }
        
        h1, h2, h3 {
            font-family: 'Playfair Display', serif;
        }
        
        .gradient-text {
            background: linear-gradient(135deg, #d4af37 0%, #f4e4c1 30%, #c9a02c 60%, #e5c87f 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            background-size: 200% auto;
            animation: shimmer 3s linear infinite;
        }
        
        @keyframes shimmer {
            to {
                background-position: 200% center;
            }
        }
        
        .glass-card {
            background: rgba(20, 15, 12, 0.7);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(212, 175, 55, 0.15);
            border-radius: 24px;
            transition: all 0.4s ease;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
        }
        
        .glass-card:hover {
            border-color: rgba(212, 175, 55, 0.4);
            transform: translateY(-4px);
            box-shadow: 0 20px 60px rgba(212, 175, 55, 0.15);
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #d4af37 0%, #c9a02c 50%, #b8941f 100%);
            color: #0a0a0a;
            font-weight: 600;
            padding: 18px 40px;
            border: none;
            border-radius: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 16px;
            letter-spacing: 1px;
            text-transform: uppercase;
            box-shadow: 0 4px 20px rgba(212, 175, 55, 0.3);
        }
        
        .btn-primary:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 30px rgba(212, 175, 55, 0.5);
            background: linear-gradient(135deg, #e5c047 0%, #d4af37 50%, #c9a02c 100%);
        }
        
        .btn-secondary {
            background: rgba(212, 175, 55, 0.08);
            color: #d4af37;
            border: 1.5px solid #d4af37;
            padding: 12px 30px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
        }
        
        .btn-secondary:hover {
            background: rgba(212, 175, 55, 0.18);
            transform: translateX(-4px);
        }
        
        .distance-option {
            padding: 24px;
            border: 2px solid rgba(80, 60, 45, 0.4);
            border-radius: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            background: rgba(10, 10, 10, 0.6);
        }
        
        .distance-option:hover {
            border-color: rgba(212, 175, 55, 0.6);
            transform: scale(1.03);
            background: rgba(45, 24, 16, 0.4);
        }
        
        .distance-option.selected {
            border-color: #d4af37;
            background: linear-gradient(135deg, rgba(212, 175, 55, 0.15), rgba(201, 160, 44, 0.08));
            box-shadow: 0 0 30px rgba(212, 175, 55, 0.2);
        }
        
        .feature-badge {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 10px 18px;
            background: rgba(34, 197, 94, 0.08);
            border: 1px solid rgba(34, 197, 94, 0.3);
            border-radius: 10px;
            font-size: 14px;
            color: #86efac;
        }
        
        /* increased left padding for better placeholder spacing */
        input, select, textarea {
            background: rgba(10, 10, 10, 0.9);
            border: 1.5px solid rgba(80, 60, 45, 0.4);
            color: #f5f5f0;
            padding: 16px 20px;
            padding-left: 24px; /* <-- moved placeholders a bit to the right */
            border-radius: 12px;
            width: 100%;
            transition: all 0.3s ease;
            font-family: 'Inter', sans-serif;
        }

        /* fix select right padding to keep dropdown icon visible */
        select {
            padding-right: 45px;
        }
        
        input::placeholder, textarea::placeholder {
            color: rgba(165, 145, 115, 0.5);
            font-size: 14px;
        }
        
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #d4af37;
            box-shadow: 0 0 0 4px rgba(212, 175, 55, 0.12);
            background: rgba(20, 15, 12, 0.95);
        }
        
        .hero-image {
            width: 100%;
            height: 500px;
            object-fit: cover;
            border-radius: 24px;
            box-shadow: 0 30px 80px rgba(0, 0, 0, 0.6);
        }
        
        .spec-item {
            display: flex;
            justify-content: space-between;
            padding: 14px 0;
            border-bottom: 1px solid rgba(80, 60, 45, 0.25);
        }
        
        .spec-item:last-child {
            border-bottom: none;
        }
        
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .animate-fade-in {
            animation: fadeInUp 0.6s ease forwards;
        }
        
        .checkbox-container {
            display: flex;
            align-items: flex-start;
            gap: 14px;
            padding: 18px;
            background: rgba(10, 10, 10, 0.6);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 1px solid rgba(80, 60, 45, 0.2);
        }
        
        .checkbox-container:hover {
            background: rgba(212, 175, 55, 0.06);
            border-color: rgba(212, 175, 55, 0.3);
        }
        
        input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
            accent-color: #d4af37;
        }
        
        /* removed sticky from single summary and made sidebar sticky */
        /* .price-summary { position: sticky; top: 20px; } */ 

        .sidebar {
            position: sticky;
            top: 20px;
            align-self: start; /* keeps sidebar aligned at top of grid column */
        }
        
        .policies-card {
            position: relative;
        }
        
        /* Custom Date Picker Styles */
        .date-picker-container {
            position: relative;
        }
        
        .date-picker-input {
            cursor: pointer;
            position: relative;
        }
        
        .date-icon {
            position: absolute;
            right: 16px;
            top: 50%;
            transform: translateY(-50%);
            color: #f5f5f0;
            pointer-events: none;
        }
        
        .custom-calendar {
            position: absolute; /* will be positioned via JS relative to body */
            margin-top: 8px;
            background: linear-gradient(135deg, rgba(20, 15, 12, 0.98), rgba(30, 20, 15, 0.98));
            border: 2px solid rgba(212, 175, 55, 0.3);
            border-radius: 16px;
            padding: 20px;
            z-index: 99999; /* very high so it overlays everything */
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(20px);
        }
        
        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .calendar-nav {
            background: rgba(212, 175, 55, 0.1);
            border: 1px solid rgba(212, 175, 55, 0.3);
            color: #d4af37;
            padding: 8px 12px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .calendar-nav:hover {
            background: rgba(212, 175, 55, 0.2);
        }
        
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 8px;
        }
        
        .calendar-day-header {
            text-align: center;
            padding: 8px;
            color: #d4af37;
            font-weight: 600;
            font-size: 12px;
        }
        
        .calendar-day {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            background: rgba(20, 15, 12, 0.6);
            border: 1px solid rgba(80, 60, 45, 0.3);
        }
        
        .calendar-day:hover:not(.disabled):not(.empty) {
            background: rgba(212, 175, 55, 0.2);
            border-color: #d4af37;
        }
        
        .calendar-day.selected {
            background: linear-gradient(135deg, #d4af37, #c9a02c);
            color: #0a0a0a;
            font-weight: 700;
        }
        
        .calendar-day.disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }
        
        .calendar-day.empty {
            background: transparent;
            border: none;
            cursor: default;
        }
        
        select {
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23f5f5f0' d='M6 9L1 4h10z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 16px center;
            /* padding-right set above */
        }

        .calendar-nav.disabled {
           opacity: 0.35;
           pointer-events: none;
        }

        /* Override mirato e pi√π specifico per forzare padding sul testo e placeholder */
.date-picker-container input.date-picker-input,
.glass-card input[type="text"],
.glass-card input[type="email"],
.glass-card input[type="tel"],
.glass-card select,
.glass-card textarea {
  box-sizing: border-box !important;
  padding-top: 16px !important;
  padding-bottom: 16px !important;
  padding-right: 20px !important;
  padding-left: 15px !important; /* aumenta qui se vuoi pi√π spazio */
}

/* Select: mantieni icona e spingi il testo da sinistra */
.glass-card select {
  padding-left: 15px !important;
  padding-right: 48px !important; /* lascia spazio per l'icona a destra */
}

/* Ensuring placeholder cross-browser visibility (optional) */
.glass-card input::placeholder,
.glass-card textarea::placeholder {
  color: rgba(165,145,115,0.5) !important;
  opacity: 1 !important; /* alcuni browser applicano opacity ridotta */
}

/* Forza colore testo (se qualche regola lo sovrascrive) */
.glass-card input,
.glass-card select,
.glass-card textarea {
  color: #f5f5f0 !important;
}

/* Caso estremo: se ancora non funziona, usa selettori pi√π specifici con attributi */
input[placeholder="Il tuo nome"],
input[placeholder="Il tuo cognome"],
input[placeholder="tua@email.com"],
input[placeholder="+39 123 456 7890"],
textarea[placeholder="Hai richieste particolari?"] {
  padding-left: 15px !important;
  box-sizing: border-box !important;
}

        /* ===== PHONE INPUT PREMIUM ===== */
.phone-input-wrapper {
    position: relative;
    display: flex;
    gap: 12px;
}

.country-selector {
    position: relative;
    min-width: 140px;
    cursor: pointer;
}

.country-display {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 16px 20px;
    background: rgba(10, 10, 10, 0.9);
    border: 1.5px solid rgba(80, 60, 45, 0.4);
    border-radius: 12px;
    transition: all 0.3s ease;
    font-family: 'Inter', sans-serif;
}

.country-display:hover {
    border-color: #d4af37;
}

.country-flag {
    font-size: 24px;
}

.country-code {
    color: #f5f5f0;
    font-weight: 500;
}

.country-dropdown {
    position: absolute;
    top: calc(100% + 8px);
    left: 0;
    right: 0;
    max-height: 300px;
    overflow-y: auto;
    background: linear-gradient(135deg, rgba(20, 15, 12, 0.98), rgba(30, 20, 15, 0.98));
    border: 2px solid rgba(212, 175, 55, 0.3);
    border-radius: 12px;
    z-index: 9999;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.8);
    backdrop-filter: blur(20px);
    display: none;
}

.country-dropdown.active {
    display: block;
}

.country-option {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 12px 16px;
    cursor: pointer;
    transition: all 0.2s ease;
    border-bottom: 1px solid rgba(80, 60, 45, 0.2);
}

.country-option:hover {
    background: rgba(212, 175, 55, 0.15);
}

.country-option:last-child {
    border-bottom: none;
}

.country-name {
    flex: 1;
    color: #f5f5f0;
    font-size: 14px;
}

.phone-number-input {
    flex: 1;
}

/* ===== EMAIL VALIDATION ALERT ===== */
.email-alert {
    position: fixed;
    top: 20px;
    right: 20px;
    background: linear-gradient(135deg, rgba(239, 68, 68, 0.95), rgba(185, 28, 28, 0.95));
    border: 2px solid rgba(239, 68, 68, 0.6);
    border-radius: 16px;
    padding: 20px 24px;
    max-width: 400px;
    box-shadow: 0 20px 60px rgba(239, 68, 68, 0.4);
    backdrop-filter: blur(20px);
    z-index: 99999;
    animation: slideInRight 0.4s ease;
}

@keyframes slideInRight {
    from {
        opacity: 0;
        transform: translateX(100px);
    }
    to {
        opacity: 1;
        transform: translateX(0);
    }
}

.email-alert-header {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 12px;
}

.email-alert-icon {
    width: 24px;
    height: 24px;
    color: #fef2f2;
}

.email-alert-title {
    color: #fef2f2;
    font-weight: 700;
    font-size: 16px;
}

.email-alert-message {
    color: #fee2e2;
    font-size: 14px;
    line-height: 1.5;
}
    </style>
</head>
<body>
    <div class="container mx-auto px-4 py-8 max-w-7xl">
        <!-- Header -->
        <header class="mb-12 animate-fade-in">
            <div class="flex items-center justify-between mb-6">
                <button onclick="window.history.back()" class="btn-secondary">
                    ‚Üê Indietro
                </button>
                <div class="text-right">
                    <div class="text-sm badge-text" style="color: #d4af37;">Esperienza Esclusiva</div>
                </div>
            </div>
            <h1 class="text-5xl md:text-6xl font-bold gradient-text mb-4 hero-title">Prenota il Tuo Test Drive</h1>
            <p class="text-xl hero-subtitle" style="color: #c9a891;">Un'esperienza indimenticabile ti aspetta</p>
        </header>

        <div class="grid lg:grid-cols-3 gap-8">
            <!-- Main Content -->
            <div class="lg:col-span-2 space-y-8">
                <!-- Car Hero Section -->
                <div class="glass-card p-8 animate-fade-in">
                    <img src="https://images.unsplash.com/photo-1605559424843-9e4c228bf1c2?w=1200&h=500&fit=crop" alt="Ferrari SF90" class="hero-image mb-6">
                    
                    <div class="flex items-start justify-between mb-6">
                        <div>
                            <h2 class="text-4xl font-bold mb-2 product-title">Ferrari SF90 Stradale</h2>
                            <div class="flex items-center gap-2 product-location" style="color: #c9a891;">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                   <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/>
                                   <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/>
                                </svg>
                                Milano, Italia
                            </div>
                        </div>
                        <div class="text-right">
                           <div class="text-3xl font-bold gradient-text product-price">‚Ç¨890</div>
                           <div class="text-sm price-label" style="color: #a59173;">da / esperienza</div>
                        </div>
                    </div>

                    <!-- Features -->
                    <div class="flex flex-wrap gap-3 mb-6 benefit-badges">
                        <!-- Popolato dinamicamente -->
                    </div>

                    <p style="color: #c9a891;" class="leading-relaxed mb-6 product-description">
                        La SF90 Stradale rappresenta l'apice dell'innovazione Ferrari, combinando un motore V8 biturbo da 780 CV con tre motori elettrici per una potenza totale di 1000 CV. Un capolavoro di ingegneria che ridefinisce il concetto di supercar ibrida.
                    </p>

                    <!-- Technical Specs -->
                    <div class="grid md:grid-cols-2 gap-6">
                        <div class="glass-card p-6">
                            <h3 class="text-xl font-bold mb-4 gradient-text table-1-title">Prestazioni</h3>
                            <div class="space-y-2 table-1-body">
                                 <!-- Popolato dinamicamente -->
                            </div>
                        </div>

                        <div class="glass-card p-6">
                            <h3 class="text-xl font-bold mb-4 gradient-text table-2-title">Caratteristiche</h3>
                            <div class="space-y-2 table-2-body">
                                 <!-- Popolato dinamicamente -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Distance Selection -->
                <div class="glass-card p-8 animate-fade-in">
                    <h3 class="text-2xl font-bold mb-6">Scegli il Tuo Percorso</h3>
                    <div class="grid md:grid-cols-3 gap-4" id="distanceOptions">
                        <div class="distance-option" data-km="10" data-price="890">
                            <div class="text-2xl font-bold gradient-text mb-2">10 km</div>
                            <div class="text-xl font-semibold mb-1">‚Ç¨890</div>
                            <div class="text-sm" style="color: #a59173;">Esperienza rapida</div>
                        </div>
                        <div class="distance-option" data-km="20" data-price="1290">
                            <div class="text-2xl font-bold gradient-text mb-2">20 km</div>
                            <div class="text-xl font-semibold mb-1">‚Ç¨1.290</div>
                            <div class="text-sm" style="color: #a59173;">Pi√π popolare</div>
                        </div>
                        <div class="distance-option" data-km="30" data-price="1690">
                            <div class="text-2xl font-bold gradient-text mb-2">30 km</div>
                            <div class="text-xl font-semibold mb-1">‚Ç¨1.690</div>
                            <div class="text-sm" style="color: #a59173;">Esperienza completa</div>
                        </div>
                        <div class="distance-option" data-km="60" data-price="2990">
                            <div class="text-2xl font-bold gradient-text mb-2">60 km</div>
                            <div class="text-xl font-semibold mb-1">‚Ç¨2.990</div>
                            <div class="text-sm" style="color: #a59173;">Tour esteso</div>
                        </div>
                        <div class="distance-option" data-km="70" data-price="3490">
                            <div class="text-2xl font-bold gradient-text mb-2">70 km</div>
                            <div class="text-xl font-semibold mb-1">‚Ç¨3.490</div>
                            <div class="text-sm" style="color: #a59173;">Avventura lunga</div>
                        </div>
                        <div class="distance-option" data-km="120" data-price="5990">
                            <div class="text-2xl font-bold gradient-text mb-2">120 km</div>
                            <div class="text-xl font-semibold mb-1">‚Ç¨5.990</div>
                            <div class="text-sm" style="color: #a59173;">Esperienza definitiva</div>
                        </div>
                    </div>
                </div>

                <!-- Second Car Option -->
                <!-- ‚úÖ CARD 1: Aggiungi Seconda Supercar (solo per prodotti con combo) -->
<div class="glass-card p-8 animate-fade-in" id="secondCarSection" style="display: none;">
    <h3 class="text-2xl font-bold mb-4">Aggiungi Una Seconda Supercar</h3>
    <p style="color: #c9a891;" class="mb-6">Vivi un'esperienza ancora pi√π straordinaria combinando due vetture iconiche</p>
    
    <label class="checkbox-container">
        <input type="checkbox" id="secondCarCheckbox">
        <div>
            <div class="font-semibold mb-1">Aggiungi Seconda Supercar</div>
            <div class="text-sm" style="color: #a59173;">Include servizi fotografici e video</div>
        </div>
    </label>
</div>

<!-- ‚úÖ CARD 2: Servizi Aggiuntivi (sempre visibile per SC, tranne Hurac√°n) -->
<div class="glass-card p-8 animate-fade-in" id="extraServicesSection" style="display: none;">
    <div class="flex items-center justify-between mb-6">
        <div>
            <h3 class="text-2xl font-bold gradient-text">Servizi Aggiuntivi Disponibili</h3>
            <p style="color: #c9a891;" class="text-sm mt-2">Personalizza la tua esperienza con servizi esclusivi</p>
        </div>
        <div style="width: 60px; height: 60px; background: linear-gradient(135deg, rgba(212, 175, 55, 0.1), rgba(255, 215, 0, 0.05)); border: 2px solid rgba(212, 175, 55, 0.3); border-radius: 50%; display: flex; align-items: center; justify-content: center;">
            <svg style="width: 30px; height: 30px; color: #D4AF37;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z"/>
            </svg>
        </div>
    </div>
    
    <div id="extraServicesContainer" class="space-y-4">
        <!-- Checkbox servizi popolati dinamicamente qui -->
    </div>
</div>

                <!-- Date and Time -->
                <div class="glass-card p-8 animate-fade-in">
                    <h3 class="text-2xl font-bold mb-6">Data e Orario</h3>
                    <div class="grid md:grid-cols-2 gap-6">
                        <div class="date-picker-container">
                            <label class="block text-sm font-medium mb-2" style="color: #c9a891;">Data</label>
                            <div style="position: relative;">
                                <input type="text" id="bookingDate" class="date-picker-input" placeholder="Seleziona data" readonly required>
                                <svg class="date-icon w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                                </svg>
                            </div>
                            <!-- calendar is now rendered/positioned via JS into body -->
                            <p class="text-xs mt-2" style="color: #a59173;">Prenotazione da 48-72 ore prima, fino a 6 mesi</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2" style="color: #c9a891;">Orario</label>
                            <select id="bookingTime" required>
                                <option value="">Seleziona orario</option>
                                <option value="09:00">09:00</option>
                                <option value="10:00">10:00</option>
                                <option value="11:00">11:00</option>
                                <option value="14:00">14:00</option>
                                <option value="15:00">15:00</option>
                                <option value="16:00">16:00</option>
                                <option value="17:00">17:00</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Personal Information -->
<div class="glass-card p-8 animate-fade-in">
    <h3 class="text-2xl font-bold mb-6">I Tuoi Dati</h3>
    <div class="grid md:grid-cols-2 gap-6">
        <div>
            <label class="block text-sm font-medium mb-2" style="color: #c9a891;">Nome</label>
            <input type="text" id="firstName" placeholder="Il tuo nome" required>
        </div>
        <div>
            <label class="block text-sm font-medium mb-2" style="color: #c9a891;">Cognome</label>
            <input type="text" id="lastName" placeholder="Il tuo cognome" required>
        </div>
        <div>
            <label class="block text-sm font-medium mb-2" style="color: #c9a891;">Email</label>
            <input type="email" id="userEmail" placeholder="tua@email.com" required>
        </div>
        <div>
            <label class="block text-sm font-medium mb-2" style="color: #c9a891;">Telefono</label>
            <div class="phone-input-wrapper">
                <div class="country-selector" id="countrySelector">
                    <div class="country-display">
                        <span class="country-flag" id="selectedFlag">üáÆüáπ</span>
                        <span class="country-code" id="selectedCode">+39</span>
                        <svg style="width: 16px; height: 16px; color: #f5f5f0;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                        </svg>
                    </div>
                    <div class="country-dropdown" id="countryDropdown">
                        <!-- Popolato dinamicamente da JS -->
                    </div>
                </div>
                <input type="tel" id="userPhone" class="phone-number-input" placeholder="123 456 7890" required>
            </div>
        </div>
        <div class="md:col-span-2">
            <label class="block text-sm font-medium mb-2" style="color: #c9a891;">Note Aggiuntive (opzionale)</label>
            <textarea id="userNotes" rows="3" placeholder="Hai richieste particolari?"></textarea>
        </div>
    </div>
</div>

                <!-- Terms -->
                <div class="glass-card p-6 animate-fade-in">
                    <label class="checkbox-container">
                        <input type="checkbox" id="termsCheckbox" required>
                        <div class="text-sm" style="color: #c9a891;">
                            Accetto i <a href="#" class="text-[#d4af37] hover:underline">termini e condizioni</a> e la 
                            <a href="#" class="text-[#d4af37] hover:underline">politica sulla privacy</a>
                        </div>
                    </label>
                </div>
            </div>

            <!-- Sidebar - Price Summary -->
            <div class="lg:col-span-1 sidebar"> <!-- <-- wrapper reso sticky -->
                <div class="glass-card p-8 price-summary animate-fade-in">
                    <h3 class="text-2xl font-bold mb-6 gradient-text">Riepilogo</h3>
                    
                    <div class="space-y-4 mb-6 pb-6 border-b" style="border-color: rgba(80, 60, 45, 0.3);">
                        <div class="flex justify-between">
                           <span style="color: #c9a891;" class="summary-product-title">Ferrari SF90 Stradale</span>
                           <span class="font-semibold" id="basePrice">‚Ç¨0</span>
                        </div>
                        
                        <div class="flex justify-between hidden" id="secondCarPrice">
                             <span style="color: #c9a891;" id="secondCarName">Seconda Supercar</span>
                             <span class="font-semibold" id="secondCarPriceAmount">‚Ç¨0</span>
                        </div>
                        <div id="extraServicesPrice" class="space-y-2"></div>
                    </div>

                    <div class="space-y-3 mb-6 summary-benefits">
                         <!-- Popolato dinamicamente -->
                    </div>

                    <div class="p-4 rounded-lg mb-6" style="background: linear-gradient(to right, rgba(212, 175, 55, 0.12), transparent);">
                        <div class="flex justify-between items-center">
                            <span class="text-lg font-semibold">Totale</span>
                            <span class="text-3xl font-bold gradient-text" id="totalPrice">‚Ç¨0</span>
                        </div>
                    </div>

                    <button class="btn-primary w-full" onclick="confirmBooking()">
                        Conferma Prenotazione
                    </button>

                    <p class="text-xs text-center mt-4" style="color: #a59173;">
                        Prenotazione sicura e protetta
                    </p>
                </div>

                <!-- Policies -->
                <div class="glass-card p-6 mt-6 animate-fade-in policies-card">
                    <h4 class="font-semibold mb-4 gradient-text">Politiche</h4>
                    <div class="space-y-3 text-sm" style="color: #c9a891;">
                        <div>
                            <strong style="color: #f5f5f0;">Rimborso:</strong> Rimborso completo fino a 48 ore prima della prenotazione.
                        </div>
                        <div>
                            <strong style="color: #f5f5f0;">Annullamento:</strong> Annullamento gratuito fino a 24 ore prima. Oltre tale termine, verr√† trattenuto il 50% dell'importo.
                        </div>
                        <div>
                            <strong style="color: #f5f5f0;">Cambio Data:</strong> Modifica gratuita della data fino a 72 ore prima dell'esperienza.
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
    // ========================================
    // CONFIGURAZIONE GLOBALE
    // ========================================
    const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbwr79RkXIEocpuOKaM6uMJqE6VFs9wjlUPvrr__FvDbDDrD2ELB1NbfrWP3BCYpHj2u/exec';

    // ========================================
// GESTIONE RITORNO POST-PAGAMENTO
// ========================================
function checkBookingSuccess() {
    const urlParams = new URLSearchParams(window.location.search);
    const bookingSuccess = urlParams.get('booking_success');
    const sessionId = urlParams.get('session_id');
    
    if (bookingSuccess === 'true' && sessionId) {
        // Mostra messaggio di successo
        showSuccessMessage();
        
        // Pulisci URL rimuovendo parametri di successo
        const sku = urlParams.get('sku');
        const cleanUrl = window.location.pathname + (sku ? `?sku=${sku}` : '');
        
        // Sostituisci URL senza ricaricare pagina
        window.history.replaceState({}, document.title, cleanUrl);
        
        // Reset completo dello stato (come prima visita)
        resetBookingState();
    }
}

function showSuccessMessage() {
    const successBanner = document.createElement('div');
    successBanner.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        background: linear-gradient(135deg, rgba(34, 197, 94, 0.95), rgba(22, 163, 74, 0.95));
        color: white;
        padding: 20px;
        text-align: center;
        z-index: 999999;
        box-shadow: 0 8px 32px rgba(34, 197, 94, 0.4);
        animation: slideDown 0.5s ease;
    `;
    
    successBanner.innerHTML = `
        <div style="max-width: 800px; margin: 0 auto;">
            <div style="font-size: 24px; font-weight: 700; margin-bottom: 8px; display: flex; align-items: center; justify-content: center; gap: 12px;">
                <svg style="width: 32px; height: 32px;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                </svg>
                Prenotazione Confermata!
            </div>
            <div style="font-size: 16px; opacity: 0.95;">
                Riceverai una email di conferma a breve con tutti i dettagli della tua esperienza.
            </div>
        </div>
    `;
    
    document.body.appendChild(successBanner);
    
    setTimeout(() => {
        successBanner.style.animation = 'slideUp 0.5s ease';
        setTimeout(() => successBanner.remove(), 500);
    }, 5000);
}

function resetBookingState() {
    // Reset stato globale
    bookingData = {
        sku: bookingData.sku, // Mantieni solo SKU
        productData: bookingData.productData, // Mantieni dati prodotto
        distance: null,
        basePrice: 0,
        secondCar: false,
        extraServices: [],
        total: 0,
        selectedDate: null
    };
    
    // Reset UI - Distanze
    document.querySelectorAll('.distance-option').forEach(opt => {
        opt.classList.remove('selected');
    });
    
    // Reset UI - Seconda supercar
    const secondCarCheckbox = document.getElementById('secondCarCheckbox');
    if (secondCarCheckbox) {
        secondCarCheckbox.checked = false;
        document.getElementById('secondCarPrice').classList.add('hidden');
    }
    
    // Reset UI - Servizi extra
    document.querySelectorAll('.extra-service, .huracan-service-checkbox').forEach(cb => {
        cb.checked = false;
    });
    
    // Reset UI - Passeggeri
    document.querySelectorAll('.passenger-radio, .huracan-passenger-radio').forEach(radio => {
        radio.checked = false;
    });
    
    // Reset form dati personali
    const firstName = document.getElementById('firstName');
    const lastName = document.getElementById('lastName');
    const userEmail = document.getElementById('userEmail');
    const userPhone = document.getElementById('userPhone');
    const userNotes = document.getElementById('userNotes');
    const bookingDate = document.getElementById('bookingDate');
    const bookingTime = document.getElementById('bookingTime');
    const termsCheckbox = document.getElementById('termsCheckbox');
    
    if (firstName) firstName.value = '';
    if (lastName) lastName.value = '';
    if (userEmail) userEmail.value = '';
    if (userPhone) userPhone.value = '';
    if (userNotes) userNotes.value = '';
    if (bookingDate) bookingDate.value = '';
    if (bookingTime) bookingTime.value = '';
    if (termsCheckbox) termsCheckbox.checked = false;
    
    // Ripristina paese telefono default
    selectedCountry = COUNTRIES[0]; // Italia
    document.getElementById('selectedFlag').textContent = 'üáÆüáπ';
    document.getElementById('selectedCode').textContent = '+39';
    
    // Nascondi servizi Hurac√°n se visibili
    const huracanServices = document.getElementById('huracanExtraServices');
    if (huracanServices) {
        huracanServices.style.display = 'none';
    }
    
    // Aggiorna riepilogo prezzi
    updatePriceSummary();
    
    // Scroll to top smooth
    window.scrollTo({ top: 0, behavior: 'smooth' });
    
    Logger.log('‚úÖ Stato booking resettato completamente');
}

// Aggiungi animazioni CSS per banner successo
const style = document.createElement('style');
style.textContent = `
    @keyframes slideDown {
        from {
            transform: translateY(-100%);
            opacity: 0;
        }
        to {
            transform: translateY(0);
            opacity: 1;
        }
    }
    
    @keyframes slideUp {
        from {
            transform: translateY(0);
            opacity: 1;
        }
        to {
            transform: translateY(-100%);
            opacity: 0;
        }
    }
`;
document.head.appendChild(style);
        
    /**
 * Formatta il prezzo per booking.html
 * Output: "‚Ç¨1.265" (euro PRIMA del numero)
 */
function formatPrice(price, currency = 'EUR') {
    const amount = parseFloat(price) || 0;
    
    // Determina decimali
    let decimals = 0;
    if (amount < 100) decimals = 2;
    else if (amount < 500) decimals = 2;
    else if (amount < 1000) decimals = amount % 1 !== 0 ? 2 : 0;
    else decimals = 0;
    
    // Formatta manualmente
    let formatted = amount.toFixed(decimals);
    
    // Sostituisci punto decimale con virgola
    formatted = formatted.replace('.', ',');
    
    // Aggiungi separatore migliaia (punto)
    let parts = formatted.split(',');
    parts[0] = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, '.');
    
    // Simbolo valuta PRIMA del numero
    const symbol = currency === 'EUR' ? '‚Ç¨' : currency;
    
    return `${symbol}${parts.join(',')}`;
}
    
    let bookingData = {
        sku: null,
        productData: null,
        distance: null,
        basePrice: 0,
        secondCar: false,
        extraServices: [],
        total: 0,
        selectedDate: null
    };

    // Set min and max dates
    const now = new Date();
    const minDateTime = new Date(now.getTime() + 48 * 60 * 60 * 1000);
    const minDate = new Date(minDateTime.getFullYear(), minDateTime.getMonth(), minDateTime.getDate());
    const maxDate = new Date(now);
    maxDate.setMonth(maxDate.getMonth() + 6);
    const earliestAllowed = new Date(now.getFullYear(), now.getMonth() - 2, 1);

    // ========================================
    // INIZIALIZZAZIONE PAGINA
    // ========================================
    window.addEventListener('DOMContentLoaded', async () => {
        // Controlla se si sta tornando da pagamento
        checkBookingSuccess();
        
        // 1. Estrai SKU dall'URL
        const urlParams = new URLSearchParams(window.location.search);
        const sku = urlParams.get('sku');
        
        if (!sku) {
            alert('Errore: SKU prodotto mancante');
            window.history.back();
            return;
        }
        
        bookingData.sku = sku;
        
        // 2. Mostra loader
        showPageLoader();
        
        // 3. Fetch dati prodotto
        try {
            const productData = await fetchProductDetails(sku);
            bookingData.productData = productData;
            
            // 4. Renderizza pagina dinamicamente
            renderPage(productData);
            
            // 5. Inizializza componenti interattivi
            initializeComponents(productData);
            
        } catch (error) {
            console.error('Errore caricamento prodotto:', error);
            alert('Impossibile caricare i dettagli del prodotto. Riprova.');
            window.history.back();
        } finally {
            hidePageLoader();
        }
    });

    // ========================================
    // FETCH DATI BACKEND
    // ========================================
    async function fetchProductDetails(sku) {
        const url = `${WEB_APP_URL}?action=get_bookable_product_details&sku=${encodeURIComponent(sku)}&t=${Date.now()}`;
        
        const response = await fetch(url);
        const data = await response.json();
        
        if (!data.success) {
            throw new Error(data.error || 'Errore recupero dati');
        }
        
        return data.product;
    }

    // ========================================
    // RENDERING DINAMICO PAGINA
    // ========================================
    function renderPage(product) {
    const config = product.typeConfig;
    
    // ‚úÖ 1. HEADER
    document.querySelector('.hero-title').textContent = config.pageTitle;
    document.querySelector('.hero-subtitle').textContent = config.pageSubtitle;
    document.querySelector('.badge-text').textContent = config.badge;
    
    // ‚úÖ 2. IMMAGINE HERO
    const heroImg = document.querySelector('.hero-image');
    if (product.mainImage) {
        heroImg.src = product.mainImage;
        heroImg.alt = product.title;
    }
    
    // ‚úÖ 3. DETTAGLI PRODOTTO
    document.querySelectorAll('.product-title').forEach(el => {
        el.textContent = product.title;
    });
    
    document.querySelector('.product-location').innerHTML = `
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/>
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/>
        </svg>
        ${product.luogo}
    `;
    
    // ‚úÖ 4. PREZZO (con formattazione italiana)
    const priceEl = document.querySelector('.product-price');
    const priceLabelEl = document.querySelector('.price-label');
    
    if (config.showDynamicPrice) {
        priceEl.textContent = formatPrice(product.price);
        priceLabelEl.textContent = config.priceLabel;
    } else {
        priceEl.textContent = config.fixedPrice;
        priceLabelEl.textContent = config.priceLabel;
    }
    
    // ‚úÖ 5. BENEFIT (primi 3 come badge)
    const benefitContainer = document.querySelector('.benefit-badges');
    benefitContainer.innerHTML = '';
    
    product.benefit.slice(0, 3).forEach(benefit => {
        benefitContainer.innerHTML += `
            <span class="feature-badge">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                </svg>
                ${benefit}
            </span>
        `;
    });
    
    // ‚úÖ 6. DESCRIZIONE
    document.querySelector('.product-description').textContent = product.desc;
    
    // ‚úÖ 7. TABELLA PRESTAZIONI
    const table1Title = document.querySelector('.table-1-title');
    const table1Body = document.querySelector('.table-1-body');
    
    table1Title.textContent = config.tables.first.title;
    table1Body.innerHTML = '';
    
    product.prestazioni.forEach((value, index) => {
        const label = config.tables.first.labels[index] || `Campo ${index + 1}`;
        table1Body.innerHTML += `
            <div class="spec-item">
                <span style="color: #a59173;">${label}</span>
                <span class="font-semibold">${value}</span>
            </div>
        `;
    });
    
    // ‚úÖ 8. TABELLA CARATTERISTICHE
    const table2Title = document.querySelector('.table-2-title');
    const table2Body = document.querySelector('.table-2-body');
    
    table2Title.textContent = config.tables.second.title;
    table2Body.innerHTML = '';
    
    product.caratteristiche.forEach((value, index) => {
        const label = config.tables.second.labels[index] || `Campo ${index + 1}`;
        table2Body.innerHTML += `
            <div class="spec-item">
                <span style="color: #a59173;">${label}</span>
                <span class="font-semibold">${value}</span>
            </div>
        `;
    });
    
    // ‚úÖ 9. ORARI DISPONIBILI
    const timeSelect = document.getElementById('bookingTime');
    if (timeSelect) {
        timeSelect.innerHTML = '<option value="">Seleziona orario</option>';
        
        console.log('üìÖ Orari ricevuti:', product.orari);
        
        if (product.orari && Array.isArray(product.orari) && product.orari.length > 0) {
            product.orari.forEach(orario => {
                if (orario) {
                    console.log('  ‚úÖ Aggiunto orario:', orario);
                    timeSelect.innerHTML += `<option value="${orario}">${orario}</option>`;
                }
            });
        } else {
            console.warn('‚ö†Ô∏è Nessun orario disponibile per questo prodotto');
            const defaultTimes = ['09:00', '10:00', '11:00', '14:00', '15:00', '16:00', '17:00'];
            defaultTimes.forEach(time => {
                timeSelect.innerHTML += `<option value="${time}">${time}</option>`;
            });
        }
    }

    // ‚úÖ 10a. CHILOMETRAGGIO DINAMICO (SOLO SUPERCAR)
    const skuPrefix = product.sku.split('-')[0].toUpperCase();

    if (skuPrefix === 'SC' && product.chilometraggioPrices && product.chilometraggioPrices.length > 0) {
        const distanceGrid = document.getElementById('distanceOptions');
        if (distanceGrid) {
            distanceGrid.innerHTML = '';
            
            const distanceConfig = getDistanceConfigForProduct(product);
            
            distanceConfig.options.forEach((distance, index) => {
                if (index < product.chilometraggioPrices.length) {
                    const price = product.chilometraggioPrices[index];
                    
                    const option = document.createElement('div');
                    option.className = 'distance-option';
                    option.dataset.km = distance.value;
                    option.dataset.price = price;
                    
                    option.innerHTML = `
                        <div class="text-2xl font-bold gradient-text mb-2">${distance.value} ${distance.unit}</div>
                        <div class="text-xl font-semibold mb-1">${formatPrice(price)}</div>
                        <div class="text-sm" style="color: #a59173;">${distance.label}</div>
                    `;
                    
                    distanceGrid.appendChild(option);
                }
            });
            
            initDistanceSelection(product);
        }
    }
    
    // ‚úÖ 10b. BENEFIT NEL RIEPILOGO (restanti)
    const summaryBenefits = document.querySelector('.summary-benefits');
    summaryBenefits.innerHTML = '';

    product.benefit.slice(3).forEach(benefit => {
        summaryBenefits.innerHTML += `
            <div class="flex items-center gap-2 text-sm" style="color: #c9a891;">
                <svg class="w-5 h-5 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                </svg>
                ${benefit}
            </div>
        `;
    });

    // ‚úÖ 10c. CARD SECONDA SUPERCAR DINAMICA (con nome corretto)
    if (skuPrefix === 'SC' && product.supercarComboSku) {
    fetchProductDetails(product.supercarComboSku)
        .then(secondCar => {
            const secondCarSection = document.getElementById('secondCarSection');
            const isHuracanSpyder = product.title && 
                                    product.title.toLowerCase().includes('lamborghini') && 
                                    product.title.toLowerCase().includes('hurac√°n spyder');
            
            if (secondCarSection) {
                const basePrice = product.price || 0;
                const comboPrice = product.supercarComboPrice || 0;
                const additionalPrice = Math.max(0, comboPrice - basePrice);

                const comboHas4Seats = secondCar.numPosti >= 4;
                
                let labelHTML = `
                    <div class="font-semibold mb-1">Aggiungi ${secondCar.title}</div>
                    <div class="text-sm" style="color: #a59173;">${formatPrice(additionalPrice)} aggiuntivi - Include servizi fotografici e video</div>
                `;
                
                // ‚úÖ HURAC√ÅN: Servizi PREMIUM dentro la card
                if (isHuracanSpyder) {
                    labelHTML += `
                    <div class="huracan-services-wrapper" id="huracanExtraServices" style="display: none; margin-top: 20px; padding-top: 20px; border-top: 1px solid rgba(212, 175, 55, 0.2);">
                        
                        <!-- Header servizi con icona -->
                        <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 20px;">
                            <div style="width: 40px; height: 40px; background: linear-gradient(135deg, rgba(212, 175, 55, 0.15), rgba(255, 215, 0, 0.08)); border: 1.5px solid rgba(212, 175, 55, 0.4); border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                                <svg style="width: 20px; height: 20px; color: #D4AF37;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z"/>
                                </svg>
                            </div>
                            <div>
                                <h3 class="text-2xl font-bold gradient-text mb-2">Servizi Aggiuntivi Disponibili</h3>
                                <div style="font-size: 0.875rem; color: #c9a891;">Personalizza la tua esperienza</div>
                            </div>
                        </div>
                        
                        <!-- Servizi con design lussuoso -->
                        <div style="display: flex; flex-direction: column; gap: 12px;">
                            
                            <!-- Servizio Fotografico -->
                            <label class="huracan-service-card" style="display: flex; align-items: center; gap: 15px; padding: 16px; background: linear-gradient(135deg, rgba(26, 26, 26, 0.8), rgba(15, 15, 15, 0.9)); border: 1.5px solid rgba(80, 60, 45, 0.4); border-radius: 12px; cursor: pointer; transition: all 0.3s ease; position: relative; overflow: hidden;">
                                <input type="checkbox" class="extra-service huracan-service-checkbox" data-price="290" data-service="photo" style="width: 20px; height: 20px; accent-color: #D4AF37; cursor: pointer; z-index: 2;">
                                <div style="flex: 1; z-index: 2;">
                                    <div style="font-size: 0.95rem; font-weight: 600; color: #fff; margin-bottom: 4px; display: flex; align-items: center; gap: 8px;">
                                        <svg style="width: 18px; height: 18px; color: #D4AF37;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"/>
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"/>
                                        </svg>
                                        Servizio Fotografico Professionale
                                    </div>
                                    <div style="font-size: 0.8rem; color: #a59173;">Su una vettura a scelta</div>
                                </div>
                                <div style="font-size: 1.1rem; font-weight: 700; color: #D4AF37; z-index: 2;">${formatPrice(290)}</div>
                                <div class="service-glow" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(135deg, transparent 0%, rgba(212, 175, 55, 0.1) 50%, transparent 100%); opacity: 0; transition: opacity 0.3s ease;"></div>
                            </label>
                            
                            <!-- Video HD -->
                            <label class="huracan-service-card" style="display: flex; align-items: center; gap: 15px; padding: 16px; background: linear-gradient(135deg, rgba(26, 26, 26, 0.8), rgba(15, 15, 15, 0.9)); border: 1.5px solid rgba(80, 60, 45, 0.4); border-radius: 12px; cursor: pointer; transition: all 0.3s ease; position: relative; overflow: hidden;">
                                <input type="checkbox" class="extra-service huracan-service-checkbox" data-price="490" data-service="video-hd" style="width: 20px; height: 20px; accent-color: #D4AF37; cursor: pointer; z-index: 2;">
                                <div style="flex: 1; z-index: 2;">
                                    <div style="font-size: 0.95rem; font-weight: 600; color: #fff; margin-bottom: 4px; display: flex; align-items: center; gap: 8px;">
                                        <svg style="width: 18px; height: 18px; color: #D4AF37;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"/>
                                        </svg>
                                        Video HD Professionale
                                    </div>
                                    <div style="font-size: 0.8rem; color: #a59173;">Disponibile su entrambe le vetture</div>
                                </div>
                                <div style="font-size: 1.1rem; font-weight: 700; color: #D4AF37; z-index: 2;">${formatPrice(490)}</div>
                                <div class="service-glow" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(135deg, transparent 0%, rgba(212, 175, 55, 0.1) 50%, transparent 100%); opacity: 0; transition: opacity 0.3s ease;"></div>
                            </label>
                            
                            <!-- Video 360¬∞ -->
                            <label class="huracan-service-card" style="display: flex; align-items: center; gap: 15px; padding: 16px; background: linear-gradient(135deg, rgba(26, 26, 26, 0.8), rgba(15, 15, 15, 0.9)); border: 1.5px solid rgba(80, 60, 45, 0.4); border-radius: 12px; cursor: pointer; transition: all 0.3s ease; position: relative; overflow: hidden;">
                                <input type="checkbox" class="extra-service huracan-service-checkbox" data-price="690" data-service="video-360" style="width: 20px; height: 20px; accent-color: #D4AF37; cursor: pointer; z-index: 2;">
                                <div style="flex: 1; z-index: 2;">
                                    <div style="font-size: 0.95rem; font-weight: 600; color: #fff; margin-bottom: 4px; display: flex; align-items: center; gap: 8px;">
                                        <svg style="width: 18px; height: 18px; color: #D4AF37;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"/>
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                        </svg>
                                        Video 360¬∞ Immersivo
                                    </div>
                                    <div style="font-size: 0.8rem; color: #a59173;">Su una vettura (marchi diversi)</div>
                                </div>
                                <div style="font-size: 1.1rem; font-weight: 700; color: #D4AF37; z-index: 2;">${formatPrice(690)}</div>
                                <div class="service-glow" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(135deg, transparent 0%, rgba(212, 175, 55, 0.1) 50%, transparent 100%); opacity: 0; transition: opacity 0.3s ease;"></div>
                            </label>

                            ${comboHas4Seats ? `
                            <!-- Passeggeri Extra -->
                            <div style="border-top: 1px solid rgba(212, 175, 55, 0.2); padding-top: 16px; margin-top: 16px;">
                                <div style="font-size: 0.9rem; font-weight: 600; color: #fff; margin-bottom: 12px;">Aggiungi Passeggeri</div>
                                <div style="display: flex; gap: 12px;">
                                    <label class="huracan-passenger-option" style="display: flex; align-items: center; gap: 10px; padding: 14px 18px; background: rgba(20, 15, 12, 0.8); border: 2px solid rgba(80, 60, 45, 0.4); border-radius: 10px; cursor: pointer; flex: 1; transition: all 0.3s ease;">
                                        <input type="radio" name="huracanPassengers" value="1" class="huracan-passenger-radio" style="width: 18px; height: 18px; accent-color: #D4AF37;">
                                        <div>
                                            <div style="font-size: 0.875rem; font-weight: 600; color: #fff;">1 Passeggero</div>
                                            <div style="font-size: 0.75rem; color: #a59173;">+${formatPrice(50)}</div>
                                        </div>
                                    </label>
                                    <label class="huracan-passenger-option" style="display: flex; align-items: center; gap: 10px; padding: 14px 18px; background: rgba(20, 15, 12, 0.8); border: 2px solid rgba(80, 60, 45, 0.4); border-radius: 10px; cursor: pointer; flex: 1; transition: all 0.3s ease;">
                                        <input type="radio" name="huracanPassengers" value="2" class="huracan-passenger-radio" style="width: 18px; height: 18px; accent-color: #D4AF37;">
                                        <div>
                                            <div style="font-size: 0.875rem; font-weight: 600; color: #fff;">2 Passeggeri</div>
                                            <div style="font-size: 0.75rem; color: #a59173;">+${formatPrice(100)}</div>
                                        </div>
                                    </label>
                                </div>
                            </div>
                            ` : ''}
                            
                        </div>
                    </div>
                            
                        </div>
                    </div>
                    
                    <style>
                        .huracan-service-card:hover {
                            border-color: rgba(212, 175, 55, 0.6);
                            transform: translateY(-2px);
                            box-shadow: 0 8px 25px rgba(212, 175, 55, 0.2);
                        }
                        
                        .huracan-service-card:hover .service-glow {
                            opacity: 1;
                        }
                        
                        .huracan-service-checkbox:checked ~ * {
                            color: #D4AF37 !important;
                        }

                        .huracan-passenger-option:hover {
    border-color: rgba(212, 175, 55, 0.6);
    background: rgba(45, 24, 16, 0.4);
}

.huracan-passenger-radio:checked + div {
    color: #D4AF37 !important;
}
                    </style>
                    `;
                }
                
                const checkboxLabel = secondCarSection.querySelector('.checkbox-container div');
                if (checkboxLabel) {
                    checkboxLabel.innerHTML = labelHTML;
                }
                
                const checkbox = document.getElementById('secondCarCheckbox');
                if (checkbox) {
                    checkbox.dataset.comboPrice = additionalPrice;
                    checkbox.dataset.comboName = secondCar.title;
                }
                
                secondCarSection.style.display = 'block';
            }
        })
        .catch(err => {
            console.log('Supercar Combo non trovata, card nascosta');
            const secondCarSection = document.getElementById('secondCarSection');
            if (secondCarSection) secondCarSection.style.display = 'none';
        });
} else {
        const secondCarSection = document.getElementById('secondCarSection');
        if (secondCarSection) secondCarSection.style.display = 'none';
    }

    // ‚úÖ 11. GESTIONE SERVIZI AGGIUNTIVI (NUOVA LOGICA UI)
    if (skuPrefix === 'SC') {
        const isHuracanSpyder = product.title && 
                                product.title.toLowerCase().includes('lamborghini') && 
                                product.title.toLowerCase().includes('hurac√°n spyder');
        
        const extraServicesSection = document.getElementById('extraServicesSection');
        const extraServicesContainer = document.getElementById('extraServicesContainer');
        
        if (!isHuracanSpyder) {
            // ‚úÖ Per tutte le SC tranne Hurac√°n: mostra servizi sempre
            if (extraServicesSection && extraServicesContainer) {
                extraServicesContainer.innerHTML = '';
                
                // Aggiungi checkbox servizi standard
                const services = [
                    { id: 'photo', label: 'Servizio Fotografico Professionale', price: 290, desc: 'Su una vettura a scelta' },
                    { id: 'video-hd', label: 'Video HD Professionale', price: 490, desc: 'Disponibile su entrambe le vetture' },
                    { id: 'video-360', label: 'Video 360¬∞ Immersivo', price: 690, desc: 'Su una vettura (marchi diversi)' }
                ];
                
                services.forEach(service => {
                    const checkbox = document.createElement('label');
                    checkbox.className = 'checkbox-container';
                    checkbox.innerHTML = `
                       <input type="checkbox" class="extra-service" data-price="${service.price}" data-service="${service.id}">
                       <div>
                          <div class="font-semibold mb-1">${service.label}</div>
                          <div class="text-sm" style="color: #a59173;">+${formatPrice(service.price)} - ${service.desc}</div>
                       </div>
                    `;
                    extraServicesContainer.appendChild(checkbox);
                });
                
                // ‚úÖ Aggiungi passeggeri se 4 posti (con scelta quantit√†)
if (product.numPosti >= 4) {
    const maxExtraPassengers = product.numPosti - 2;
    const pricePerPassenger = 50;
    
    const passengerContainer = document.createElement('div');
    passengerContainer.className = 'checkbox-container';
    passengerContainer.style.display = 'block';
    passengerContainer.innerHTML = `
        <div>
            <div class="font-semibold mb-3">Passeggeri Extra</div>
            <div style="display: flex; gap: 15px; margin-top: 15px;">
                <label style="display: flex; align-items: center; gap: 10px; cursor: pointer; padding: 12px 20px; background: rgba(212, 175, 55, 0.08); border: 2px solid rgba(212, 175, 55, 0.3); border-radius: 10px; transition: all 0.3s ease; flex: 1;">
                    <input type="radio" name="extraPassengers" value="1" class="passenger-radio" style="width: 18px; height: 18px; accent-color: #D4AF37; cursor: pointer;">
                    <div>
                        <div style="font-size: 14px; font-weight: 600; color: #fff;">1 Passeggero</div>
                        <div style="font-size: 12px; color: #a59173;">+${formatPrice(pricePerPassenger)}</div>
                    </div>
                </label>
                <label style="display: flex; align-items: center; gap: 10px; cursor: pointer; padding: 12px 20px; background: rgba(212, 175, 55, 0.08); border: 2px solid rgba(212, 175, 55, 0.3); border-radius: 10px; transition: all 0.3s ease; flex: 1;">
                    <input type="radio" name="extraPassengers" value="2" class="passenger-radio" style="width: 18px; height: 18px; accent-color: #D4AF37; cursor: pointer;">
                    <div>
                        <div style="font-size: 14px; font-weight: 600; color: #fff;">${maxExtraPassengers} Passeggeri</div>
                        <div style="font-size: 12px; color: #a59173;">+${formatPrice(pricePerPassenger * maxExtraPassengers)}</div>
                    </div>
                </label>
            </div>
        </div>
    `;
    extraServicesContainer.appendChild(passengerContainer);
}
                
                extraServicesSection.style.display = 'block';
            }
        } else {
            // ‚úÖ Hurac√°n Spyder: nasconde servizi (saranno mostrati dal checkbox combo)
            if (extraServicesSection) extraServicesSection.style.display = 'none';
        }
    } else {
        const extraServicesSection = document.getElementById('extraServicesSection');
        if (extraServicesSection) extraServicesSection.style.display = 'none';
    }

    // ‚úÖ 12. AGGIORNA NOME PRODOTTO NEL RIEPILOGO (SIDEBAR)
    const summaryTitle = document.querySelector('.summary-product-title');
    if (summaryTitle) {
        summaryTitle.textContent = product.title;
    }

    // ‚úÖ 13. POLITICHE DINAMICHE
    const policiesCard = document.querySelector('.policies-card');
    if (policiesCard && product.politiche && Array.isArray(product.politiche)) {
        const policiesBody = policiesCard.querySelector('.space-y-3');
        if (policiesBody) {
            policiesBody.innerHTML = '';
            
            product.politiche.forEach(policy => {
                const policyDiv = document.createElement('div');
                policyDiv.innerHTML = `
                    <strong style="color: #f5f5f0;">${policy.label}:</strong> 
                    ${policy.description}
                `;
                policiesBody.appendChild(policyDiv);
            });
        }
    }

    // ‚úÖ 14. GESTIONE PREZZO SU RICHIESTA PER IMMOBILI
    const isPriceOnRequest = !config.showDynamicPrice && config.fixedPrice === '‚Ç¨ ‚Äî';
    if (isPriceOnRequest) {
        const distanceSection = document.querySelector('.glass-card:has(#distanceOptions)');
        if (distanceSection) distanceSection.style.display = 'none';

        const secondCarSection = document.getElementById('secondCarSection');
        if (secondCarSection) secondCarSection.style.display = 'none';
    }

    // ‚úÖ 15. GESTIONE ESPERIENZE (EX) - Nascondi sezioni non applicabili
    if (skuPrefix === 'EX') {
        const distanceSection = document.querySelector('.glass-card:has(#distanceOptions)');
        if (distanceSection) distanceSection.style.display = 'none';

        const secondCarSection = document.getElementById('secondCarSection');
        if (secondCarSection) secondCarSection.style.display = 'none';

        bookingData.basePrice = product.price || 0;
    }

    // ‚úÖ 16. GESTIONE SUPERCAR (SC) - Usa prezzo base prodotto
    if (skuPrefix === 'SC') {
        bookingData.basePrice = product.price || 0;
    }

    updatePriceSummary();
}

    // ========================================
    // LOADER UTILITIES
    // ========================================
    function showPageLoader() {
        document.body.style.overflow = 'hidden';
        document.body.insertAdjacentHTML('beforeend', `
            <div id="pageLoader" style="position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(10,10,10,0.95); z-index: 99999; display: flex; align-items: center; justify-content: center;">
                <div style="text-align: center;">
                    <div style="width: 80px; height: 80px; border: 3px solid #2a2a2a; border-top-color: #D4AF37; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 20px;"></div>
                    <div style="color: #D4AF37; font-size: 16px; letter-spacing: 2px;">Caricamento...</div>
                </div>
            </div>
            <style>@keyframes spin { to { transform: rotate(360deg); }}</style>
        `);
    }

    function hidePageLoader() {
        const loader = document.getElementById('pageLoader');
        if (loader) {
            loader.style.opacity = '0';
            loader.style.transition = 'opacity 0.3s';
            setTimeout(() => loader.remove(), 300);
            document.body.style.overflow = '';
        }
    }

        /**
 * Determina configurazione chilometraggio in base a SKU e Nome Prodotto
 */
function getDistanceConfigForProduct(product) {
    const sku = product.sku.toUpperCase();
    const title = product.title.toLowerCase();
    
    // Caso 1: Ferrari 458 Spider
    if (title.includes('ferrari 458 spider')) {
        return {
            options: [
                { value: 9, unit: 'km', label: 'Esperienza rapida' },
                { value: 16, unit: 'km', label: 'Pi√π popolare' },
                { value: 32, unit: 'km', label: 'Esperienza completa' },
                { value: 65, unit: 'km', label: 'Tour esteso' },
                { value: 80, unit: 'km', label: 'Avventura lunga' },
                { value: 100, unit: 'km', label: 'Esperienza definitiva' }
            ]
        };
    }
    
    // Caso 2: McLaren 720s Performance
    if (title.includes('mclaren 720s')) {
        return {
            options: [
                { value: 10, unit: 'min', label: 'Esperienza rapida' },
                { value: 20, unit: 'min', label: 'Pi√π popolare' },
                { value: 30, unit: 'min', label: 'Esperienza completa' },
                { value: 60, unit: 'min', label: 'Tour esteso' },
                { value: 90, unit: 'min', label: 'Avventura lunga' },
                { value: 120, unit: 'min', label: 'Esperienza definitiva' }
            ]
        };
    }
    
    // Caso 3/4/5: Combo Supercar (Ferrari + Lamborghini)
    if (title.includes('ferrari') && title.includes('lamborghini')) {
        return {
            options: [
                { value: 10, unit: 'km', label: 'Esperienza rapida' },
                { value: 20, unit: 'km', label: 'Pi√π popolare' },
                { value: 30, unit: 'km', label: 'Esperienza completa' },
                { value: 60, unit: 'km', label: 'Tour esteso' },
                { value: 90, unit: 'km', label: 'Avventura lunga' },
                { value: 120, unit: 'km', label: 'Esperienza definitiva' }
            ]
        };
    }
    
    // Default: km standard
    return {
        options: [
            { value: 10, unit: 'km', label: 'Esperienza rapida' },
            { value: 20, unit: 'km', label: 'Pi√π popolare' },
            { value: 30, unit: 'km', label: 'Esperienza completa' },
            { value: 60, unit: 'km', label: 'Tour esteso' },
            { value: 70, unit: 'km', label: 'Avventura lunga' },
            { value: 120, unit: 'km', label: 'Esperienza definitiva' }
        ]
    };
}

        // ========================================
// EMAIL VALIDATION
// ========================================
const TRUSTED_EMAIL_PROVIDERS = [
    'gmail.com', 'yahoo.com', 'outlook.com', 'hotmail.com', 'icloud.com',
    'protonmail.com', 'aol.com', 'mail.com', 'zoho.com', 'fastmail.com',
    'gmx.com', 'yandex.com', 'live.com', 'msn.com', 'libero.it', 
    'virgilio.it', 'alice.it', 'tin.it', 'tiscali.it', 'email.it',
    'pec.it', 'aruba.it', 'register.it'
];

const DISPOSABLE_EMAIL_DOMAINS = [
    'tempmail.com', '10minutemail.com', 'guerrillamail.com', 'mailinator.com',
    'throwaway.email', 'getnada.com', 'temp-mail.org', 'mohmal.com'
];

function validateEmail(email) {
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    
    if (!emailRegex.test(email)) {
        return { valid: false, message: 'Formato email non valido' };
    }
    
    const domain = email.split('@')[1].toLowerCase();
    
    if (DISPOSABLE_EMAIL_DOMAINS.some(d => domain.includes(d))) {
        return { 
            valid: false, 
            message: 'Email temporanea non consentita. Utilizza un indirizzo permanente.' 
        };
    }
    
    if (!TRUSTED_EMAIL_PROVIDERS.includes(domain)) {
        const commonTLDs = ['.com', '.it', '.net', '.org', '.edu', '.gov'];
        const hasTLD = commonTLDs.some(tld => domain.endsWith(tld));
        
        if (!hasTLD) {
            return { 
                valid: false, 
                message: 'Provider email non riconosciuto. Utilizza un indirizzo affidabile.' 
            };
        }
    }
    
    return { valid: true };
}

function showEmailAlert(message) {
    // Rimuovi alert esistenti
    const existing = document.querySelector('.email-alert');
    if (existing) existing.remove();
    
    const alert = document.createElement('div');
    alert.className = 'email-alert';
    alert.innerHTML = `
        <div class="email-alert-header">
            <svg class="email-alert-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
            </svg>
            <div class="email-alert-title">Email Non Valida</div>
        </div>
        <div class="email-alert-message">${message}</div>
    `;
    
    document.body.appendChild(alert);
    
    setTimeout(() => {
        alert.style.animation = 'slideInRight 0.4s ease reverse';
        setTimeout(() => alert.remove(), 400);
    }, 5000);
}

// ========================================
// PHONE INPUT COUNTRIES
// ========================================
const COUNTRIES = [
    { code: '+39', flag: 'üáÆüáπ', name: 'Italia', format: '### ### ####' },
    { code: '+1', flag: 'üá∫üá∏', name: 'Stati Uniti', format: '(###) ###-####' },
    { code: '+44', flag: 'üá¨üáß', name: 'Regno Unito', format: '#### ### ####' },
    { code: '+33', flag: 'üá´üá∑', name: 'Francia', format: '## ## ## ## ##' },
    { code: '+49', flag: 'üá©üá™', name: 'Germania', format: '### #######' },
    { code: '+34', flag: 'üá™üá∏', name: 'Spagna', format: '### ## ## ##' },
    { code: '+41', flag: 'üá®üá≠', name: 'Svizzera', format: '## ### ## ##' },
    { code: '+43', flag: 'üá¶üáπ', name: 'Austria', format: '### ######' },
    { code: '+31', flag: 'üá≥üá±', name: 'Paesi Bassi', format: '## ########' },
    { code: '+32', flag: 'üáßüá™', name: 'Belgio', format: '### ## ## ##' },
    { code: '+351', flag: 'üáµüáπ', name: 'Portogallo', format: '### ### ###' },
    { code: '+7', flag: 'üá∑üá∫', name: 'Russia', format: '(###) ###-##-##' },
    { code: '+86', flag: 'üá®üá≥', name: 'Cina', format: '### #### ####' },
    { code: '+81', flag: 'üáØüáµ', name: 'Giappone', format: '##-####-####' },
    { code: '+82', flag: 'üá∞üá∑', name: 'Corea del Sud', format: '##-####-####' },
    { code: '+91', flag: 'üáÆüá≥', name: 'India', format: '##### #####' },
    { code: '+61', flag: 'üá¶üá∫', name: 'Australia', format: '#### ### ###' },
    { code: '+55', flag: 'üáßüá∑', name: 'Brasile', format: '(##) #####-####' },
    { code: '+52', flag: 'üá≤üáΩ', name: 'Messico', format: '## #### ####' },
    { code: '+971', flag: 'üá¶üá™', name: 'Emirati Arabi', format: '## ### ####' }
];

let selectedCountry = COUNTRIES[0]; // Default: Italia

function initPhoneInput() {
    const selector = document.getElementById('countrySelector');
    const dropdown = document.getElementById('countryDropdown');
    const phoneInput = document.getElementById('userPhone');
    
    // Popola dropdown
    dropdown.innerHTML = COUNTRIES.map(country => `
        <div class="country-option" data-code="${country.code}">
            <span class="country-flag">${country.flag}</span>
            <span class="country-name">${country.name}</span>
            <span class="country-code" style="color: #a59173;">${country.code}</span>
        </div>
    `).join('');
    
    // Toggle dropdown
    selector.addEventListener('click', (e) => {
        e.stopPropagation();
        dropdown.classList.toggle('active');
    });
    
    // Selezione paese
    dropdown.querySelectorAll('.country-option').forEach(option => {
        option.addEventListener('click', function() {
            const code = this.dataset.code;
            selectedCountry = COUNTRIES.find(c => c.code === code);
            
            document.getElementById('selectedFlag').textContent = selectedCountry.flag;
            document.getElementById('selectedCode').textContent = selectedCountry.code;
            
            dropdown.classList.remove('active');
            phoneInput.value = '';
            phoneInput.focus();
        });
    });
    
    // Formattazione real-time
    phoneInput.addEventListener('input', function() {
        let value = this.value.replace(/\D/g, '');
        const format = selectedCountry.format;
        let formatted = '';
        let valueIndex = 0;
        
        for (let i = 0; i < format.length && valueIndex < value.length; i++) {
            if (format[i] === '#') {
                formatted += value[valueIndex];
                valueIndex++;
            } else {
                formatted += format[i];
            }
        }
        
        this.value = formatted;
    });
    
    // Chiudi dropdown al click esterno
    document.addEventListener('click', () => {
        dropdown.classList.remove('active');
    });
}

    // ========================================
    // INIZIALIZZAZIONE COMPONENTI
    // ========================================
    function initializeComponents(product) {
        // Inizializza input telefono premium
initPhoneInput();

// Validazione email real-time
const emailInput = document.getElementById('userEmail');
if (emailInput) {
    emailInput.addEventListener('blur', function() {
        const validation = validateEmail(this.value);
        if (!validation.valid) {
            showEmailAlert(validation.message);
            this.style.borderColor = '#ef4444';
        } else {
            this.style.borderColor = 'rgba(80, 60, 45, 0.4)';
        }
    });
}
    const skuPrefix = product.sku.split('-')[0].toUpperCase();
    
    // Distance selection (se non gi√† gestito dinamicamente)
    if (skuPrefix !== 'SC' || !product.chilometraggioPrices) {
        document.querySelectorAll('.distance-option').forEach(option => {
            option.addEventListener('click', function() {
                document.querySelectorAll('.distance-option').forEach(opt => opt.classList.remove('selected'));
                this.classList.add('selected');
                
                bookingData.distance = this.dataset.km;
                
                if (skuPrefix !== 'SC' && skuPrefix !== 'EX') {
                    bookingData.basePrice = parseInt(this.dataset.price);
                }
                
                updatePriceSummary();
            });
        });
        
        // Auto-select first option
        const firstOption = document.querySelector('.distance-option');
        if (firstOption && skuPrefix !== 'EX' && skuPrefix !== 'SC') {
            firstOption.classList.add('selected');
            bookingData.distance = firstOption.dataset.km;
            bookingData.basePrice = parseInt(firstOption.dataset.price);
            updatePriceSummary();
        }
    }

        // Second car checkbox
const secondCarCheckbox = document.getElementById('secondCarCheckbox');
const isHuracanSpyder = product.title && 
                        product.title.toLowerCase().includes('lamborghini') && 
                        product.title.toLowerCase().includes('hurac√°n spyder');

if (skuPrefix === 'SC') {
    const isHuracanSpyder = product.title && 
                            product.title.toLowerCase().includes('lamborghini') && 
                            product.title.toLowerCase().includes('hurac√°n spyder');
    
    if (isHuracanSpyder) {
        // ‚úÖ Hurac√°n: toggle servizi nella card combo
        if (secondCarCheckbox) {
    secondCarCheckbox.addEventListener('change', async function() {
        bookingData.secondCar = this.checked;
        const comboPrice = parseInt(this.dataset.comboPrice) || 1490;
        const comboName = this.dataset.comboName || 'Seconda Supercar';
        
        // ‚úÖ NUOVA LOGICA: Verifica combo speciale e aggiorna prezzi km
        if (this.checked) {
            const secondCarSku = bookingData.productData.supercarComboSku;
            
            if (secondCarSku) {
                try {
                    // Recupera dati seconda supercar
                    const secondCar = await fetchProductDetails(secondCarSku);
                    
                    // Verifica se √® una combo speciale
                    const specialPrices = getComboSpecialPrices(
                        bookingData.productData.title,
                        secondCar.title
                    );
                    
                    if (specialPrices) {
                        console.log('üéØ Combo speciale rilevata! Aggiornamento prezzi...');
                        
                        // Ricostruisci grid distanze con prezzi speciali
                        const distanceGrid = document.getElementById('distanceOptions');
                        if (distanceGrid) {
                            distanceGrid.innerHTML = '';
                            
                            const labels = [
                                'Esperienza rapida',
                                'Pi√π popolare',
                                'Esperienza completa',
                                'Tour esteso',
                                'Avventura lunga',
                                'Esperienza definitiva'
                            ];
                            
                            specialPrices.km.forEach((km, index) => {
                                const price = specialPrices.prices[index];
                                
                                const option = document.createElement('div');
                                option.className = 'distance-option';
                                option.dataset.km = km;
                                option.dataset.price = price;
                                
                                option.innerHTML = `
                                    <div class="text-2xl font-bold gradient-text mb-2">${km} km</div>
                                    <div class="text-xl font-semibold mb-1">${formatPrice(price)}</div>
                                    <div class="text-sm" style="color: #a59173;">${labels[index]}</div>
                                `;
                                
                                // Listener per selezione distanza
                                option.addEventListener('click', function() {
                                    document.querySelectorAll('.distance-option').forEach(opt => 
                                        opt.classList.remove('selected')
                                    );
                                    this.classList.add('selected');
                                    bookingData.distance = this.dataset.km;
                                    bookingData.basePrice = parseInt(this.dataset.price);
                                    updatePriceSummary();
                                });
                                
                                distanceGrid.appendChild(option);
                            });
                            
                            // Auto-seleziona prima opzione
                            const firstOption = distanceGrid.querySelector('.distance-option');
                            if (firstOption) {
                                firstOption.classList.add('selected');
                                bookingData.distance = firstOption.dataset.km;
                                bookingData.basePrice = parseInt(firstOption.dataset.price);
                            }
                        }
                    }
                } catch (err) {
                    console.error('Errore recupero seconda supercar:', err);
                }
            }
        } else {
            // ‚úÖ Ripristina prezzi originali quando deselezionato
            const originalPrices = bookingData.productData.chilometraggioPrices;
            if (originalPrices && originalPrices.length > 0) {
                const distanceGrid = document.getElementById('distanceOptions');
                if (distanceGrid) {
                    distanceGrid.innerHTML = '';
                    
                    const distanceConfig = getDistanceConfigForProduct(bookingData.productData);
                    
                    distanceConfig.options.forEach((distance, index) => {
                        if (index < originalPrices.length) {
                            const price = originalPrices[index];
                            
                            const option = document.createElement('div');
                            option.className = 'distance-option';
                            option.dataset.km = distance.value;
                            option.dataset.price = price;
                            
                            option.innerHTML = `
                                <div class="text-2xl font-bold gradient-text mb-2">${distance.value} ${distance.unit}</div>
                                <div class="text-xl font-semibold mb-1">${formatPrice(price)}</div>
                                <div class="text-sm" style="color: #a59173;">${distance.label}</div>
                            `;
                            
                            option.addEventListener('click', function() {
                                document.querySelectorAll('.distance-option').forEach(opt => 
                                    opt.classList.remove('selected')
                                );
                                this.classList.add('selected');
                                bookingData.distance = this.dataset.km;
                                bookingData.basePrice = parseInt(this.dataset.price);
                                updatePriceSummary();
                            });
                            
                            distanceGrid.appendChild(option);
                        }
                    });
                    
                    const firstOption = distanceGrid.querySelector('.distance-option');
                    if (firstOption) {
                        firstOption.classList.add('selected');
                        bookingData.distance = firstOption.dataset.km;
                        bookingData.basePrice = parseInt(firstOption.dataset.price);
                    }
                }
            }
        }
        
        // Toggle visibilit√† servizi Hurac√°n (logica esistente)
        const huracanServices = document.getElementById('huracanExtraServices');
        if (huracanServices) {
            huracanServices.style.display = this.checked ? 'block' : 'none';
            
            if (this.checked) {
                setTimeout(() => {
                    huracanServices.style.animation = 'fadeIn 0.4s ease';
                    
                    // Re-bind listeners servizi
                    document.querySelectorAll('.huracan-service-checkbox').forEach(cb => {
                        const newCb = cb.cloneNode(true);
                        cb.parentNode.replaceChild(newCb, cb);
                        
                        newCb.addEventListener('change', function() {
                            const price = parseInt(this.dataset.price);
                            const service = this.dataset.service;
                            
                            if (this.checked) {
                                if (!bookingData.extraServices.find(s => s.service === service)) {
                                    bookingData.extraServices.push({ service, price });
                                }
                            } else {
                                bookingData.extraServices = bookingData.extraServices.filter(s => s.service !== service);
                            }
                            
                            updatePriceSummary();
                        });
                    });
                    
                    // Listener passeggeri Hurac√°n
                    document.querySelectorAll('.huracan-passenger-radio').forEach(radio => {
                        radio.addEventListener('change', function() {
                            const quantity = parseInt(this.value);
                            const pricePerPassenger = 50;
                            const totalPrice = pricePerPassenger * quantity;
                            
                            bookingData.extraServices = bookingData.extraServices.filter(s => s.service !== 'extra-passengers');
                            
                            if (this.checked) {
                                bookingData.extraServices.push({ 
                                    service: 'extra-passengers', 
                                    price: totalPrice,
                                    quantity: quantity
                                });
                            }
                            
                            document.querySelectorAll('.huracan-passenger-option').forEach(lbl => {
                                lbl.style.borderColor = 'rgba(80, 60, 45, 0.4)';
                                lbl.style.background = 'rgba(20, 15, 12, 0.8)';
                            });
                            
                            const selectedLabel = this.closest('.huracan-passenger-option');
                            if (selectedLabel) {
                                selectedLabel.style.borderColor = '#D4AF37';
                                selectedLabel.style.background = 'rgba(212, 175, 55, 0.12)';
                            }
                            
                            updatePriceSummary();
                        });
                    });
                }, 100);
            }
            
            if (!this.checked) {
                huracanServices.querySelectorAll('.huracan-service-checkbox').forEach(cb => {
                    cb.checked = false;
                });
                bookingData.extraServices = [];
            }
        }
        
        // Aggiorna riepilogo
        document.getElementById('secondCarPrice').classList.toggle('hidden', !this.checked);
        
        const secondCarNameSpan = document.getElementById('secondCarName');
        const secondCarPriceSpan = document.getElementById('secondCarPriceAmount');
        
        if (secondCarNameSpan) secondCarNameSpan.textContent = comboName;
        if (secondCarPriceSpan) secondCarPriceSpan.textContent = formatPrice(comboPrice);
        
        updatePriceSummary();
    });
}
    } else {
        // ‚úÖ Altre supercar: comportamento standard
        if (secondCarCheckbox) {
            secondCarCheckbox.addEventListener('change', function() {
                bookingData.secondCar = this.checked;
                const comboPrice = parseInt(this.dataset.comboPrice) || 1490;
                const comboName = this.dataset.comboName || 'Seconda Supercar';
                
                document.getElementById('secondCarPrice').classList.toggle('hidden', !this.checked);
                
                const secondCarNameSpan = document.getElementById('secondCarName');
                const secondCarPriceSpan = document.getElementById('secondCarPriceAmount');
                
                if (secondCarNameSpan) secondCarNameSpan.textContent = comboName;
                if (secondCarPriceSpan) secondCarPriceSpan.textContent = formatPrice(comboPrice);
                
                updatePriceSummary();
            });
        }
    }
}

        // Extra services
        document.querySelectorAll('.extra-service').forEach(checkbox => {
            checkbox.addEventListener('change', function() {
                const price = parseInt(this.dataset.price);
                const service = this.dataset.service;
                
                if (this.checked) {
                    bookingData.extraServices.push({ service, price });
                } else {
                    bookingData.extraServices = bookingData.extraServices.filter(s => s.service !== service);
                }
                
                updatePriceSummary();
            });
        });

        // ‚úÖ Re-bind listener per servizi Hurac√°n (TUTTI i checkbox con classe .extra-service)
// Questo gestisce sia servizi standard che Hurac√°n
setTimeout(() => {
    const allServiceCheckboxes = document.querySelectorAll('.extra-service');
    
    allServiceCheckboxes.forEach(checkbox => {
        // Rimuovi listener duplicati clonando elemento
        const newCheckbox = checkbox.cloneNode(true);
        checkbox.parentNode.replaceChild(newCheckbox, checkbox);
        
        // Aggiungi listener pulito
        newCheckbox.addEventListener('change', function() {
            const price = parseInt(this.dataset.price);
            const service = this.dataset.service;
            
            if (this.checked) {
                // Aggiungi servizio se non presente
                if (!bookingData.extraServices.find(s => s.service === service)) {
                    bookingData.extraServices.push({ service, price });
                }
            } else {
                // Rimuovi servizio
                bookingData.extraServices = bookingData.extraServices.filter(s => s.service !== service);
            }
            
            console.log('üìä Servizi attivi:', bookingData.extraServices); // Debug
            updatePriceSummary();
        });
    });
}, 600); // Attendi rendering completo

        // ‚úÖ Gestione Passeggeri Extra (radio buttons)
document.querySelectorAll('.passenger-radio').forEach(radio => {
    radio.addEventListener('change', function() {
        const quantity = parseInt(this.value);
        const pricePerPassenger = 50;
        const totalPrice = pricePerPassenger * quantity;
        
        // Rimuovi eventuali servizi passeggeri precedenti
        bookingData.extraServices = bookingData.extraServices.filter(s => s.service !== 'extra-passengers');
        
        // Aggiungi nuovo servizio
        if (this.checked) {
    // ‚úÖ RESET STILI TUTTI I LABEL
    document.querySelectorAll('label:has(.passenger-radio)').forEach(lbl => {
        lbl.style.borderColor = 'rgba(212, 175, 55, 0.3)';
        lbl.style.background = 'rgba(212, 175, 55, 0.08)';
    });
    
    // Evidenzia label selezionato
    const selectedLabel = this.closest('label');
    if (selectedLabel) {
        selectedLabel.style.borderColor = '#D4AF37';
        selectedLabel.style.background = 'rgba(212, 175, 55, 0.18)';
    }
    
    bookingData.extraServices.push({ 
                service: 'extra-passengers', 
                price: totalPrice,
                quantity: quantity
            });
        }
        
        updatePriceSummary();
    });
});

// ‚úÖ Stile hover per radio passengers
document.querySelectorAll('label:has(.passenger-radio)').forEach(label => {
    label.addEventListener('mouseenter', function() {
        this.style.borderColor = '#D4AF37';
        this.style.background = 'rgba(212, 175, 55, 0.15)';
    });
    label.addEventListener('mouseleave', function() {
        const radio = this.querySelector('.passenger-radio');
        if (!radio.checked) {
            this.style.borderColor = 'rgba(212, 175, 55, 0.3)';
            this.style.background = 'rgba(212, 175, 55, 0.08)';
        }
    });
});

        // Initialize calendar
        initCalendar();
    }

        /**
 * Definisce i prezzi speciali per combo specifiche Ferrari + Hurac√°n
 */
function getComboSpecialPrices(mainCarTitle, secondCarTitle) {
    const main = mainCarTitle.toLowerCase();
    const second = secondCarTitle.toLowerCase();
    
    // Identifica se c'√® una combo valida (in entrambi gli ordini)
    const isHuracan = main.includes('lamborghini') && main.includes('hurac√°n') || 
                      second.includes('lamborghini') && second.includes('hurac√°n');
    
    if (!isHuracan) return null; // Nessuna combo speciale
    
    // Caso 1: Ferrari California
    if (main.includes('ferrari california') || second.includes('ferrari california')) {
        return {
            km: [10, 20, 30, 60, 90, 120],
            prices: [176, 312, 424, 784, 1096, 1368]
        };
    }
    
    // Caso 2: Ferrari Portofino
    if (main.includes('ferrari portofino') || second.includes('ferrari portofino')) {
        return {
            km: [10, 20, 30, 60, 90, 120],
            prices: [208, 368, 528, 929, 1315, 1528]
        };
    }
    
    // Caso 3: Ferrari 488 Spider
    if (main.includes('ferrari 488 spider') || second.includes('ferrari 488 spider')) {
        return {
            km: [10, 20, 30, 60, 90, 120],
            prices: [224, 399, 575, 1040, 1460, 1800]
        };
    }
    
    return null; // Nessuna combo speciale
}

        /**
 * Inizializza selezione distanza per prodotti con chilometraggio dinamico
 */
function initDistanceSelection(product) {
    const skuPrefix = product.sku.split('-')[0].toUpperCase();
    
    document.querySelectorAll('.distance-option').forEach(option => {
        option.addEventListener('click', function() {
            document.querySelectorAll('.distance-option').forEach(opt => opt.classList.remove('selected'));
            this.classList.add('selected');
            
            bookingData.distance = this.dataset.km;
            
            // Per SC ed EX, non sovrascrivere il prezzo base con quello della distanza
            if (skuPrefix !== 'SC' && skuPrefix !== 'EX') {
                bookingData.basePrice = parseInt(this.dataset.price);
            } else {
                // Per SC, aggiorna il prezzo base con quello selezionato
                bookingData.basePrice = parseInt(this.dataset.price);
            }
            
            updatePriceSummary();
        });
    });
    
    // Auto-select prima opzione se presente
    const firstOption = document.querySelector('.distance-option');
    if (firstOption) {
        firstOption.classList.add('selected');
        bookingData.distance = firstOption.dataset.km;
        
        if (skuPrefix === 'SC' || skuPrefix === 'EX') {
            bookingData.basePrice = parseInt(firstOption.dataset.price);
        }
        
        updatePriceSummary();
    }
}

    // ========================================
    // PRICE SUMMARY UPDATE
    // ========================================
    function updatePriceSummary() {
        const isPriceOnRequest = bookingData.productData?.typeConfig && 
                                 !bookingData.productData.typeConfig.showDynamicPrice &&
                                  bookingData.productData.typeConfig.fixedPrice === '‚Ç¨ ‚Äî';
    
        if (isPriceOnRequest) {
            // Prezzo su richiesta per IMMOBILI
            document.getElementById('basePrice').textContent = '‚Ç¨ ‚Äî';
            document.getElementById('totalPrice').textContent = '‚Ç¨ ‚Äî';
            return; // Esce senza calcolare totali
        }
    
        // ASSICURA CHE IL PREZZO BASE SIA SEMPRE VALORIZZATO
        // Per SC ed EX, usa sempre il prezzo dal prodotto se non impostato
        if (!bookingData.basePrice && bookingData.productData) {
            const skuPrefix = bookingData.productData.sku.split('-')[0].toUpperCase();
            if (skuPrefix === 'SC' || skuPrefix === 'EX') {
                bookingData.basePrice = bookingData.productData.price || 0;
            }
        }
    
        let total = bookingData.basePrice;
    
        document.getElementById('basePrice').textContent = formatPrice(bookingData.basePrice);
        
        if (bookingData.secondCar) {
    const checkbox = document.getElementById('secondCarCheckbox');
    const comboPrice = checkbox ? parseInt(checkbox.dataset.comboPrice) || 1490 : 1490;
    total += comboPrice;
}
        
        const extraServicesDiv = document.getElementById('extraServicesPrice');
        extraServicesDiv.innerHTML = '';
        
        bookingData.extraServices.forEach(service => {
    total += service.price;
    const serviceNames = {
        'photo': 'Servizio Fotografico',
        'video-hd': 'Video HD',
        'video-360': 'Video 360¬∞',
        'extra-passengers': 'Passeggeri Extra'
    };
    
    let serviceName = serviceNames[service.service];
    
    // ‚úÖ Aggiungi quantit√† per passeggeri
    if (service.service === 'extra-passengers' && service.quantity) {
        serviceName += ` (${service.quantity})`;
    }
    
    const div = document.createElement('div');
    div.className = 'flex justify-between';
    div.innerHTML = `
        <span class="text-sm" style="color: #c9a891;">${serviceName}</span>
        <span class="font-semibold text-sm">${formatPrice(service.price)}</span>
    `;
    extraServicesDiv.appendChild(div);
});
        
        bookingData.total = total;
        document.getElementById('totalPrice').textContent = formatPrice(total);
    }

    // ========================================
    // CONFERMA PRENOTAZIONE
    // ========================================
    async function confirmBooking() {
    const skuPrefix = bookingData.productData?.sku.split('-')[0].toUpperCase();
    const requiresDistance = skuPrefix !== 'EX' && skuPrefix !== 'SC';

    // ===== VALIDAZIONI =====
    if (requiresDistance && !bookingData.distance) {
        alert('Seleziona un percorso prima di procedere');
        return;
    }

    const firstName = document.getElementById('firstName')?.value.trim();
    const lastName = document.getElementById('lastName')?.value.trim();
    const email = document.getElementById('userEmail')?.value.trim();
    const phone = selectedCountry.code + ' ' + document.getElementById('userPhone')?.value.trim();
    const date = bookingData.selectedDate;
    const time = document.getElementById('bookingTime')?.value;
    const notes = document.getElementById('userNotes')?.value.trim();
    const terms = document.getElementById('termsCheckbox')?.checked;

    if (!firstName || !lastName) {
        alert('Inserisci nome e cognome');
        return;
    }

    // Validazione email avanzata
    const emailValidation = validateEmail(email);
    if (!emailValidation.valid) {
        showEmailAlert(emailValidation.message);
        document.getElementById('userEmail').focus();
        return;
    }

    if (!phone || phone.length < 10) {
        alert('Inserisci un numero di telefono valido');
        return;
    }

    if (!date || !time) {
        alert('Seleziona data e orario');
        return;
    }

    if (!terms) {
        alert('Accetta i termini e condizioni per procedere');
        return;
    }

    // ===== PREPARAZIONE LINE ITEMS STRIPE =====
    const lineItems = [];

    // Item principale
    lineItems.push({
        price_data: {
            currency: 'eur',
            product_data: {
                name: bookingData.productData.title,
                description: `Prenotazione per ${date.toLocaleDateString('it-IT')} alle ${time}` + 
                            (bookingData.distance ? ` - Percorso: ${bookingData.distance} km` : ''),
                images: bookingData.productData.mainImage ? [bookingData.productData.mainImage] : []
            },
            unit_amount: Math.round(bookingData.basePrice * 100)
        },
        quantity: 1
    });

    // Seconda supercar (se selezionata)
    if (bookingData.secondCar) {
        const checkbox = document.getElementById('secondCarCheckbox');
        const comboPrice = parseInt(checkbox?.dataset.comboPrice) || 0;
        const comboName = checkbox?.dataset.comboName || 'Seconda Supercar';

        if (comboPrice > 0) {
            lineItems.push({
                price_data: {
                    currency: 'eur',
                    product_data: {
                        name: comboName,
                        description: 'Esperienza doppia supercar con servizi premium inclusi'
                    },
                    unit_amount: Math.round(comboPrice * 100)
                },
                quantity: 1
            });
        }
    }

    // Servizi aggiuntivi
    const serviceNames = {
        'photo': 'Servizio Fotografico Professionale',
        'video-hd': 'Video HD Professionale',
        'video-360': 'Video 360¬∞ Immersivo',
        'extra-passengers': 'Passeggeri Extra'
    };

    bookingData.extraServices.forEach(service => {
        let serviceName = serviceNames[service.service] || service.service;
        if (service.service === 'extra-passengers' && service.quantity) {
            serviceName += ` (${service.quantity})`;
        }

        lineItems.push({
            price_data: {
                currency: 'eur',
                product_data: {
                    name: serviceName
                },
                unit_amount: Math.round(service.price * 100)
            },
            quantity: 1
        });
    });

    // ===== CREAZIONE CHECKOUT SESSION =====
    const checkoutData = {
        line_items: lineItems,
        metadata: {
            sku: bookingData.sku,
            product_title: bookingData.productData.title,
            booking_date: date.toLocaleDateString('it-IT'),
            booking_time: time,
            distance_km: bookingData.distance || 'N/A',
            customer_name: `${firstName} ${lastName}`,
            customer_phone: phone,
            customer_notes: notes || 'Nessuna',
            second_car: bookingData.secondCar ? 'S√¨' : 'No'
        },
        customer_email: email,
        phone_number_collection: { enabled: true }
    };

    // Mostra loader
    showCheckoutLoader();

    try {
        const response = await fetch(`${WEB_APP_URL}?action=create_bookable_checkout`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(checkoutData)
        });

        const result = await response.json();

        if (result.success && result.url) {
            // Redirect a Stripe Checkout
            window.location.href = result.url;
        } else {
            throw new Error(result.error || 'Errore creazione checkout');
        }
    } catch (error) {
        console.error('Errore checkout:', error);
        alert('Errore durante la creazione del checkout. Riprova.');
    } finally {
        hideCheckoutLoader();
    }
}

function showCheckoutLoader() {
    document.body.insertAdjacentHTML('beforeend', `
        <div id="checkoutLoader" style="position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(10,10,10,0.95); z-index: 999999; display: flex; align-items: center; justify-content: center;">
            <div style="text-align: center;">
                <div style="width: 80px; height: 80px; border: 3px solid #2a2a2a; border-top-color: #D4AF37; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 20px;"></div>
                <div style="color: #D4AF37; font-size: 18px; letter-spacing: 2px;">Preparazione Checkout...</div>
                <div style="color: #a59173; font-size: 14px; margin-top: 10px;">Non chiudere questa pagina</div>
            </div>
        </div>
    `);
}

function hideCheckoutLoader() {
    const loader = document.getElementById('checkoutLoader');
    if (loader) loader.remove();
}

    // ========================================
    // CUSTOM CALENDAR
    // ========================================
    let currentMonth = new Date();
    const dateInput = document.getElementById('bookingDate');
    const calendar = document.createElement('div');
    calendar.id = 'customCalendar';
    calendar.className = 'custom-calendar';
    calendar.style.display = 'none';
    document.body.appendChild(calendar);

    function initCalendar() {
        dateInput.addEventListener('click', function(e) {
            e.stopPropagation();
            if (currentMonth < earliestAllowed) {
                currentMonth = new Date(earliestAllowed.getFullYear(), earliestAllowed.getMonth(), 1);
            }
            calendar.style.display = (calendar.style.display === 'none' || !calendar.style.display) ? 'block' : 'none';
            renderCalendar();
            positionCalendar();
        });

        document.addEventListener('click', function(e) {
            if (!calendar.contains(e.target) && e.target !== dateInput) {
                calendar.style.display = 'none';
            }
        });

        window.addEventListener('resize', () => {
            if (calendar.style.display === 'block') positionCalendar();
        });
        
        window.addEventListener('scroll', () => {
            if (calendar.style.display === 'block') positionCalendar();
        }, true);
    }

    function positionCalendar() {
        const rect = dateInput.getBoundingClientRect();
        const left = rect.left + window.scrollX;
        const top = rect.bottom + window.scrollY + 8;
        calendar.style.left = left + 'px';
        calendar.style.top = top + 'px';
        calendar.style.minWidth = rect.width + 'px';
        calendar.style.maxWidth = '480px';
    }

    function renderCalendar() {
        const year = currentMonth.getFullYear();
        const month = currentMonth.getMonth();
        
        const firstDay = new Date(year, month, 1);
        const lastDay = new Date(year, month + 1, 0);
        const daysInMonth = lastDay.getDate();
        const startingDayOfWeek = firstDay.getDay();

        const monthNames = ['Gennaio', 'Febbraio', 'Marzo', 'Aprile', 'Maggio', 'Giugno',
                          'Luglio', 'Agosto', 'Settembre', 'Ottobre', 'Novembre', 'Dicembre'];
        
        let html = `
            <div class="calendar-header">
                <button id="calendarPrevBtn" class="calendar-nav" onclick="previousMonth(event)">‚óÑ</button>
                <div class="text-lg font-bold gradient-text">${monthNames[month]} ${year}</div>
                <button id="calendarNextBtn" class="calendar-nav" onclick="nextMonth(event)">‚ñ∫</button>
            </div>
            <div class="calendar-grid">
                <div class="calendar-day-header">Dom</div>
                <div class="calendar-day-header">Lun</div>
                <div class="calendar-day-header">Mar</div>
                <div class="calendar-day-header">Mer</div>
                <div class="calendar-day-header">Gio</div>
                <div class="calendar-day-header">Ven</div>
                <div class="calendar-day-header">Sab</div>
        `;

        // Empty cells before first day
        for (let i = 0; i < startingDayOfWeek; i++) {
            html += '<div class="calendar-day empty"></div>';
        }

        // Days of the month
        for (let day = 1; day <= daysInMonth; day++) {
            const currentDate = new Date(year, month, day);
            const isDisabled = currentDate < minDate || currentDate > maxDate;
            const isSelected = bookingData.selectedDate && 
                             currentDate.toDateString() === bookingData.selectedDate.toDateString();
            
            const classes = ['calendar-day'];
            if (isDisabled) classes.push('disabled');
            if (isSelected) classes.push('selected');

            html += `<div class="${classes.join(' ')}" 
                         onclick="selectDate(${year}, ${month}, ${day}, ${isDisabled})">${day}</div>`;
        }

        html += '</div>';
        calendar.innerHTML = html;
        updateCalendarNavButtons();
    }

    function monthIsBefore(aYear, aMonth, bYear, bMonth) {
        return aYear < bYear || (aYear === bYear && aMonth < bMonth);
    }
    
    function monthIsAfter(aYear, aMonth, bYear, bMonth) {
        return aYear > bYear || (aYear === bYear && aMonth > bMonth);
    }

    function updateCalendarNavButtons() {
        const prev = document.getElementById('calendarPrevBtn');
        const next = document.getElementById('calendarNextBtn');
        if (!prev || !next) return;
        
        const displayYear = currentMonth.getFullYear();
        const displayMonth = currentMonth.getMonth();

        const earliestYear = earliestAllowed.getFullYear();
        const earliestMonth = earliestAllowed.getMonth();

        const maxYear = maxDate.getFullYear();
        const maxMonth = maxDate.getMonth();

        const canPrev = monthIsAfter(displayYear, displayMonth, earliestYear, earliestMonth);
        const canNext = monthIsBefore(displayYear, displayMonth, maxYear, maxMonth);

        if (canPrev) prev.classList.remove('disabled'); 
        else prev.classList.add('disabled');
        
        if (canNext) next.classList.remove('disabled'); 
        else next.classList.add('disabled');
    }

    function previousMonth(e) {
        e.preventDefault();
        e.stopPropagation();
        const curYear = currentMonth.getFullYear();
        const curMonth = currentMonth.getMonth();
        const earliestYear = earliestAllowed.getFullYear();
        const earliestMonth = earliestAllowed.getMonth();
        
        if (!(curYear > earliestYear || (curYear === earliestYear && curMonth > earliestMonth))) return;
        
        currentMonth.setMonth(curMonth - 1);
        renderCalendar();
        positionCalendar();
    }

    function nextMonth(e) {
        e.preventDefault();
        e.stopPropagation();
        const curYear = currentMonth.getFullYear();
        const curMonth = currentMonth.getMonth();
        const maxYear = maxDate.getFullYear();
        const maxMonth = maxDate.getMonth();
        
        if (!(curYear < maxYear || (curYear === maxYear && curMonth < maxMonth))) return;
        
        currentMonth.setMonth(curMonth + 1);
        renderCalendar();
        positionCalendar();
    }

    function selectDate(year, month, day, isDisabled) {
        if (isDisabled) return;
        
        bookingData.selectedDate = new Date(year, month, day);
        const formatted = bookingData.selectedDate.toLocaleDateString('it-IT', {
            day: '2-digit',
            month: '2-digit',
            year: 'numeric'
        });
        dateInput.value = formatted;
        calendar.style.display = 'none';
        renderCalendar();
    }

    // ========================================
    // ANIMATION ON SCROLL
    // ========================================
    const observerOptions = {
        threshold: 0.1,
        rootMargin: '0px 0px -50px 0px'
    };

    const observer = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
            if (entry.isIntersecting) {
                entry.target.style.opacity = '1';
                entry.target.style.transform = 'translateY(0)';
            }
        });
    }, observerOptions);

    document.querySelectorAll('.animate-fade-in').forEach(el => {
        el.style.opacity = '0';
        el.style.transform = 'translateY(30px)';
        el.style.transition = 'all 0.6s ease';
        observer.observe(el);
    });
</script>
</body>
</html>
