<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prenota il Tuo Test Drive</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- âœ… Flag Icons CSS per bandiere SVG cross-platform -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/lipis/flag-icons@7.2.3/css/flag-icons.min.css"/>
    <!-- Connection Monitor Styles -->
<link rel="stylesheet" href="../connection-monitor.css" />

    <!-- I18N System Scripts -->
<script src="translations-pdp.js"></script>
<script src="i18n-pdp.js"></script>
    
    <script>
        // Suppress Tailwind CDN warning
        tailwind.config = {
            theme: {
                extend: {}
            }
        }
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600;700&family=Inter:wght@300;400;500;600&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #0a0a0a 0%, #1a1412 30%, #2d1810 60%, #0a0a0a 100%);
            min-height: 100vh;
            color: #f5f5f0;
        }
        
        h1, h2, h3 {
            font-family: 'Playfair Display', serif;
        }
        
        .gradient-text {
            background: linear-gradient(135deg, #d4af37 0%, #f4e4c1 30%, #c9a02c 60%, #e5c87f 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            background-size: 200% auto;
            animation: shimmer 3s linear infinite;
        }
        
        @keyframes shimmer {
            to {
                background-position: 200% center;
            }
        }
        
        .glass-card {
            background: rgba(20, 15, 12, 0.7);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(212, 175, 55, 0.15);
            border-radius: 24px;
            transition: all 0.4s ease;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
        }
        
        .glass-card:hover {
            border-color: rgba(212, 175, 55, 0.4);
            transform: translateY(-4px);
            box-shadow: 0 20px 60px rgba(212, 175, 55, 0.15);
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #d4af37 0%, #c9a02c 50%, #b8941f 100%);
            color: #0a0a0a;
            font-weight: 600;
            padding: 18px 40px;
            border: none;
            border-radius: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 16px;
            letter-spacing: 1px;
            text-transform: uppercase;
            box-shadow: 0 4px 20px rgba(212, 175, 55, 0.3);
        }
        
        .btn-primary:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 30px rgba(212, 175, 55, 0.5);
            background: linear-gradient(135deg, #e5c047 0%, #d4af37 50%, #c9a02c 100%);
        }
        
        .btn-secondary {
            background: rgba(212, 175, 55, 0.08);
            color: #d4af37;
            border: 1.5px solid #d4af37;
            padding: 12px 30px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
        }
        
        .btn-secondary:hover {
            background: rgba(212, 175, 55, 0.18);
            transform: translateX(-4px);
        }
        
        .distance-option {
            padding: 24px;
            border: 2px solid rgba(80, 60, 45, 0.4);
            border-radius: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            background: rgba(10, 10, 10, 0.6);
        }
        
        .distance-option:hover {
            border-color: rgba(212, 175, 55, 0.6);
            transform: scale(1.03);
            background: rgba(45, 24, 16, 0.4);
        }
        
        .distance-option.selected {
            border-color: #d4af37;
            background: linear-gradient(135deg, rgba(212, 175, 55, 0.15), rgba(201, 160, 44, 0.08));
            box-shadow: 0 0 30px rgba(212, 175, 55, 0.2);
        }
        
        .feature-badge {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 10px 18px;
            background: rgba(34, 197, 94, 0.08);
            border: 1px solid rgba(34, 197, 94, 0.3);
            border-radius: 10px;
            font-size: 14px;
            color: #86efac;
        }
        
        /* increased left padding for better placeholder spacing */
        input, select, textarea {
            background: rgba(10, 10, 10, 0.9);
            border: 1.5px solid rgba(80, 60, 45, 0.4);
            color: #f5f5f0;
            padding: 16px 20px;
            padding-left: 24px; /* <-- moved placeholders a bit to the right */
            border-radius: 12px;
            width: 100%;
            transition: all 0.3s ease;
            font-family: 'Inter', sans-serif;
        }

        /* fix select right padding to keep dropdown icon visible */
        select {
            padding-right: 45px;
        }
        
        input::placeholder, textarea::placeholder {
            color: rgba(165, 145, 115, 0.5);
            font-size: 14px;
        }
        
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #d4af37;
            box-shadow: 0 0 0 4px rgba(212, 175, 55, 0.12);
            background: rgba(20, 15, 12, 0.95);
        }
        
        .hero-image {
            width: 100%;
            height: 500px;
            object-fit: cover;
            border-radius: 24px;
            box-shadow: 0 30px 80px rgba(0, 0, 0, 0.6);
        }
        
        .spec-item {
            display: flex;
            justify-content: space-between;
            padding: 14px 0;
            border-bottom: 1px solid rgba(80, 60, 45, 0.25);
        }
        
        .spec-item:last-child {
            border-bottom: none;
        }
        
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .animate-fade-in {
            animation: fadeInUp 0.6s ease forwards;
        }
        
        .checkbox-container {
            display: flex;
            align-items: flex-start;
            gap: 14px;
            padding: 18px;
            background: rgba(10, 10, 10, 0.6);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 1px solid rgba(80, 60, 45, 0.2);
        }
        
        .checkbox-container:hover {
            background: rgba(212, 175, 55, 0.06);
            border-color: rgba(212, 175, 55, 0.3);
        }
        
        input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
            accent-color: #d4af37;
        }
        
        /* removed sticky from single summary and made sidebar sticky */
        /* .price-summary { position: sticky; top: 20px; } */ 

        .sidebar {
            position: sticky;
            top: 20px;
            align-self: start; /* keeps sidebar aligned at top of grid column */
        }
        
        .policies-card {
            position: relative;
        }
        
        /* Custom Date Picker Styles */
        .date-picker-container {
            position: relative;
        }
        
        .date-picker-input {
            cursor: pointer;
            position: relative;
        }
        
        .date-icon {
            position: absolute;
            right: 16px;
            top: 50%;
            transform: translateY(-50%);
            color: #f5f5f0;
            pointer-events: none;
        }
        
        .custom-calendar {
            position: absolute; /* will be positioned via JS relative to body */
            margin-top: 8px;
            background: linear-gradient(135deg, rgba(20, 15, 12, 0.98), rgba(30, 20, 15, 0.98));
            border: 2px solid rgba(212, 175, 55, 0.3);
            border-radius: 16px;
            padding: 20px;
            z-index: 99999; /* very high so it overlays everything */
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(20px);
        }
        
        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .calendar-nav {
            background: rgba(212, 175, 55, 0.1);
            border: 1px solid rgba(212, 175, 55, 0.3);
            color: #d4af37;
            padding: 8px 12px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .calendar-nav:hover {
            background: rgba(212, 175, 55, 0.2);
        }
        
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 8px;
        }
        
        .calendar-day-header {
            text-align: center;
            padding: 8px;
            color: #d4af37;
            font-weight: 600;
            font-size: 12px;
        }
        
        .calendar-day {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            background: rgba(20, 15, 12, 0.6);
            border: 1px solid rgba(80, 60, 45, 0.3);
        }
        
        .calendar-day:hover:not(.disabled):not(.empty) {
            background: rgba(212, 175, 55, 0.2);
            border-color: #d4af37;
        }
        
        .calendar-day.selected {
            background: linear-gradient(135deg, #d4af37, #c9a02c);
            color: #0a0a0a;
            font-weight: 700;
        }
        
        .calendar-day.disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }
        
        .calendar-day.empty {
            background: transparent;
            border: none;
            cursor: default;
        }
        
        select {
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23f5f5f0' d='M6 9L1 4h10z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 16px center;
            /* padding-right set above */
        }

        .calendar-nav.disabled {
           opacity: 0.35;
           pointer-events: none;
        }

        /* ===================================
   ğŸ¨ IMAGE SLIDER STYLES
   =================================== */

.image-nav-btn {
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    width: 56px;
    height: 56px;
    background: linear-gradient(135deg, rgba(10, 10, 10, 0.85), rgba(20, 15, 12, 0.90));
    backdrop-filter: blur(12px);
    border: 2px solid rgba(212, 175, 55, 0.4);
    border-radius: 50%;
    color: #D4AF37;
    cursor: pointer;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    z-index: 10;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4);
}

.image-nav-btn:hover {
    background: linear-gradient(135deg, rgba(212, 175, 55, 0.25), rgba(255, 215, 0, 0.15));
    border-color: #D4AF37;
    box-shadow: 0 0 30px rgba(212, 175, 55, 0.5), 0 12px 32px rgba(0, 0, 0, 0.6);
    transform: translateY(-50%) scale(1.08);
}

.image-nav-btn:active {
    transform: translateY(-50%) scale(0.95);
}

.image-nav-left {
    left: 20px;
}

.image-nav-right {
    right: 20px;
}

.image-nav-btn svg {
    filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.3));
}

.image-counter {
    position: absolute;
    bottom: 20px;
    left: 50%;
    transform: translateX(-50%);
    background: linear-gradient(135deg, rgba(10, 10, 10, 0.90), rgba(20, 15, 12, 0.95));
    backdrop-filter: blur(16px);
    border: 1.5px solid rgba(212, 175, 55, 0.4);
    border-radius: 24px;
    padding: 10px 24px;
    font-size: 14px;
    font-weight: 600;
    color: #D4AF37;
    letter-spacing: 1px;
    box-shadow: 0 4px 16px rgba(0, 0, 0, 0.5);
    z-index: 10;
}

/* Responsive: riduci dimensioni su mobile */
@media (max-width: 768px) {
    .image-nav-btn {
        width: 44px;
        height: 44px;
    }
    
    .image-nav-left {
        left: 12px;
    }
    
    .image-nav-right {
        right: 12px;
    }
    
    .image-counter {
        font-size: 12px;
        padding: 8px 18px;
    }
}

/* Animazione transizione immagine */
#mainProductImage {
    transition: opacity 0.25s ease-in-out;
}

#mainProductImage.changing {
    opacity: 0.6;
}

        /* Override mirato e piÃ¹ specifico per forzare padding sul testo e placeholder */
.date-picker-container input.date-picker-input,
.glass-card input[type="text"],
.glass-card input[type="email"],
.glass-card input[type="tel"],
.glass-card select,
.glass-card textarea {
  box-sizing: border-box !important;
  padding-top: 16px !important;
  padding-bottom: 16px !important;
  padding-right: 20px !important;
  padding-left: 15px !important; /* aumenta qui se vuoi piÃ¹ spazio */
}

/* Select: mantieni icona e spingi il testo da sinistra */
.glass-card select {
  padding-left: 15px !important;
  padding-right: 48px !important; /* lascia spazio per l'icona a destra */
}

/* Ensuring placeholder cross-browser visibility (optional) */
.glass-card input::placeholder,
.glass-card textarea::placeholder {
  color: rgba(165,145,115,0.5) !important;
  opacity: 1 !important; /* alcuni browser applicano opacity ridotta */
}

/* Forza colore testo (se qualche regola lo sovrascrive) */
.glass-card input,
.glass-card select,
.glass-card textarea {
  color: #f5f5f0 !important;
}

/* Caso estremo: se ancora non funziona, usa selettori piÃ¹ specifici con attributi */
input[placeholder="Il tuo nome"],
input[placeholder="Il tuo cognome"],
input[placeholder="tua@email.com"],
input[placeholder="+39 123 456 7890"],
textarea[placeholder="Hai richieste particolari?"] {
  padding-left: 15px !important;
  box-sizing: border-box !important;
}

/* ============================================
   SELETTORE LINGUA PREMIUM (PDP PAGES)
   ============================================ */

.pdp-lang-selector {
    position: fixed !important;
    top: 5rem !important;
    right: 2.5rem !important;
    z-index: 99999 !important; /* Aumentato da 9999 */
    transform: none !important; /* Previeni trasformazioni */
    display: flex;
    align-items: center;
    gap: 0.25rem;
    background: rgba(9, 9, 11, 0.85);
    backdrop-filter: blur(20px);
    border: 1px solid rgba(212, 175, 55, 0.2);
    border-radius: 2rem;
    padding: 0.625rem 1.25rem;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

.pdp-lang-selector:hover {
    border-color: rgba(212, 175, 55, 0.5);
    box-shadow: 0 12px 48px rgba(212, 175, 55, 0.15);
}

.pdp-lang-option {
    background: none;
    border: none;
    color: #71717a;
    font-size: 0.875rem;
    font-weight: 500;
    letter-spacing: 0.05em;
    padding: 0.5rem 0.75rem;
    cursor: pointer;
    transition: all 0.3s;
    border-radius: 1rem;
    position: relative;
}

.pdp-lang-option:hover {
    color: #d4d4d8;
    background: rgba(255, 255, 255, 0.05);
}

.pdp-lang-option.active {
    color: #D4AF37;
    font-weight: 600;
    background: linear-gradient(135deg, rgba(212, 175, 55, 0.1), rgba(255, 215, 0, 0.05));
}

.pdp-lang-option.active::after {
    content: '';
    position: absolute;
    bottom: 0.25rem;
    left: 50%;
    transform: translateX(-50%);
    width: 1.25rem;
    height: 2px;
    background: linear-gradient(90deg, #D4AF37, #FFD700);
    border-radius: 2px;
    box-shadow: 0 0 8px rgba(212, 175, 55, 0.6);
}

.pdp-lang-divider {
    width: 1px;
    height: 1rem;
    background: rgba(113, 113, 122, 0.3);
    margin: 0 0.125rem;
}

/* Responsive Mobile */
@media (max-width: 768px) {
    .pdp-lang-selector {
        position: fixed;
        top: 1rem;
        right: 1rem;
        padding: 0.5rem 1rem;
    }
    
    .pdp-lang-option {
        font-size: 0.8125rem;
        padding: 0.375rem 0.5rem;
    }
}
        
    </style>
</head>
<body>
    <div class="container mx-auto px-4 py-8 max-w-7xl">
        <!-- Header -->
        <header class="mb-12 animate-fade-in">
            <div class="flex items-center justify-between mb-6">
                <button onclick="window.history.back()" class="btn-secondary" data-i18n="booking_back_btn">
    â† Indietro
</button>
                <div class="text-right">
                    <div class="text-sm badge-text" style="color: #d4af37;" data-i18n="booking_badge">Esperienza Esclusiva</div>
                       <!-- Selettore Lingua Premium -->
                       <div class="pdp-lang-selector" id="pdpLanguageSelector">
                          <button class="pdp-lang-option active" data-lang="it">IT</button>
                          <span class="pdp-lang-divider"></span>
                          <button class="pdp-lang-option" data-lang="en">EN</button>
                          <span class="pdp-lang-divider"></span>
                          <button class="pdp-lang-option" data-lang="fr">FR</button>
                          <span class="pdp-lang-divider"></span>
                          <button class="pdp-lang-option" data-lang="de">DE</button>
                          <span class="pdp-lang-divider"></span>
                          <button class="pdp-lang-option" data-lang="es">ES</button>
                       </div>
                </div>
            </div>
            <h1 class="text-5xl md:text-6xl font-bold gradient-text mb-4 hero-title">Prenota il Tuo Test Drive</h1>
            <p class="text-xl hero-subtitle" style="color: #c9a891;">Un'esperienza indimenticabile ti aspetta</p>
        </header>

        <div class="grid lg:grid-cols-3 gap-8">
            <!-- Main Content -->
            <div class="lg:col-span-2 space-y-8">
                <!-- Car Hero Section -->
                <div class="glass-card p-8 animate-fade-in">
                    <!-- âœ… NUOVO: Container slider con frecce -->
<div style="position: relative; width: 100%; margin-bottom: 24px;">
    <img src="https://images.unsplash.com/..." 
         alt="Ferrari SF90" 
         class="hero-image" 
         id="mainProductImage">
    
    <!-- Freccia Sinistra -->
    <button id="prevImageBtn" 
            class="image-nav-btn image-nav-left" 
            style="display: none;"
            aria-label="Immagine precedente">
        <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M15 19l-7-7 7-7"/>
        </svg>
    </button>
    
    <!-- Freccia Destra -->
    <button id="nextImageBtn" 
            class="image-nav-btn image-nav-right" 
            style="display: none;"
            aria-label="Immagine successiva">
        <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M9 5l7 7-7 7"/>
        </svg>
    </button>
    
    <!-- Indicatore posizione (opzionale) -->
    <div id="imageCounter" 
         class="image-counter" 
         style="display: none;">
        <span id="currentImageIndex">1</span> / <span id="totalImages">1</span>
    </div>
</div>
                    
                    <div class="flex items-start justify-between mb-6">
                        <div>
                            <h2 class="text-4xl font-bold mb-2 product-title">Ferrari SF90 Stradale</h2>
                            <div class="flex items-center gap-2 product-location" style="color: #c9a891;">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                   <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/>
                                   <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/>
                                </svg>
                                Milano, Italia
                            </div>
                        </div>
                        <div class="text-right">
                           <div class="text-3xl font-bold gradient-text product-price">â‚¬890</div>
                           <div class="text-sm price-label" style="color: #a59173;" data-i18n="booking_price_label"></div>
                        </div>
                    </div>

                    <!-- Features -->
                    <div class="flex flex-wrap gap-3 mb-6 benefit-badges">
                        <!-- Popolato dinamicamente -->
                    </div>

                    <p style="color: #c9a891;" class="leading-relaxed mb-6 product-description">
                        La SF90 Stradale rappresenta l'apice dell'innovazione Ferrari, combinando un motore V8 biturbo da 780 CV con tre motori elettrici per una potenza totale di 1000 CV. Un capolavoro di ingegneria che ridefinisce il concetto di supercar ibrida.
                    </p>

                    <!-- Technical Specs -->
                    <div class="grid md:grid-cols-2 gap-6">
                        <div class="glass-card p-6">
                            <h3 class="text-xl font-bold mb-4 gradient-text table-1-title">Prestazioni</h3>
                            <div class="space-y-2 table-1-body">
                                 <!-- Popolato dinamicamente -->
                            </div>
                        </div>

                        <div class="glass-card p-6">
                            <h3 class="text-xl font-bold mb-4 gradient-text table-2-title">Caratteristiche</h3>
                            <div class="space-y-2 table-2-body">
                                 <!-- Popolato dinamicamente -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Distance Selection -->
                <div class="glass-card p-8 animate-fade-in">
                    <h3 class="text-2xl font-bold mb-6" data-i18n="booking_distance_title">Scegli il Tuo Percorso</h3>
                    <div class="grid md:grid-cols-3 gap-4" id="distanceOptions">
                        <div class="distance-option" data-km="10" data-price="890">
                            <div class="text-2xl font-bold gradient-text mb-2">10 km</div>
                            <div class="text-xl font-semibold mb-1">â‚¬890</div>
                            <div class="text-sm" style="color: #a59173;">Esperienza rapida</div>
                        </div>
                        <div class="distance-option" data-km="20" data-price="1290">
                            <div class="text-2xl font-bold gradient-text mb-2">20 km</div>
                            <div class="text-xl font-semibold mb-1">â‚¬1.290</div>
                            <div class="text-sm" style="color: #a59173;">PiÃ¹ popolare</div>
                        </div>
                        <div class="distance-option" data-km="30" data-price="1690">
                            <div class="text-2xl font-bold gradient-text mb-2">30 km</div>
                            <div class="text-xl font-semibold mb-1">â‚¬1.690</div>
                            <div class="text-sm" style="color: #a59173;">Esperienza completa</div>
                        </div>
                        <div class="distance-option" data-km="60" data-price="2990">
                            <div class="text-2xl font-bold gradient-text mb-2">60 km</div>
                            <div class="text-xl font-semibold mb-1">â‚¬2.990</div>
                            <div class="text-sm" style="color: #a59173;">Tour esteso</div>
                        </div>
                        <div class="distance-option" data-km="70" data-price="3490">
                            <div class="text-2xl font-bold gradient-text mb-2">70 km</div>
                            <div class="text-xl font-semibold mb-1">â‚¬3.490</div>
                            <div class="text-sm" style="color: #a59173;">Avventura lunga</div>
                        </div>
                        <div class="distance-option" data-km="120" data-price="5990">
                            <div class="text-2xl font-bold gradient-text mb-2">120 km</div>
                            <div class="text-xl font-semibold mb-1">â‚¬5.990</div>
                            <div class="text-sm" style="color: #a59173;">Esperienza definitiva</div>
                        </div>
                    </div>
                </div>

                <!-- Second Car Option -->
                <!-- âœ… CARD 1: Aggiungi Seconda Supercar (solo per prodotti con combo) -->
<div class="glass-card p-8 animate-fade-in" id="secondCarSection" style="display: none;">
    <h3 class="text-2xl font-bold mb-4" data-i18n="booking_second_car_title">Aggiungi Una Seconda Supercar</h3>
    <p style="color: #c9a891;" class="mb-6" data-i18n="booking_second_car_subtitle">Vivi un'esperienza ancora piÃ¹ straordinaria combinando due vetture iconiche</p>
    
    <label class="checkbox-container">
        <input type="checkbox" id="secondCarCheckbox">
        <div>
            <div class="font-semibold mb-1">Aggiungi Seconda Supercar</div>
            <div class="text-sm" style="color: #a59173;">Include servizi fotografici e video</div>
        </div>
    </label>
</div>

<!-- âœ… CARD 2: Servizi Aggiuntivi (sempre visibile per SC, tranne HuracÃ¡n) -->
<div class="glass-card p-8 animate-fade-in" id="extraServicesSection" style="display: none;">
    <div class="flex items-center justify-between mb-6">
        <div>
            <h3 class="text-2xl font-bold gradient-text" data-i18n="booking_services_title">Servizi Aggiuntivi Disponibili</h3>
            <p style="color: #c9a891;" class="text-sm mt-2" data-i18n="booking_services_subtitle">Personalizza la tua esperienza con servizi esclusivi</p>
        </div>
        <div style="width: 60px; height: 60px; background: linear-gradient(135deg, rgba(212, 175, 55, 0.1), rgba(255, 215, 0, 0.05)); border: 2px solid rgba(212, 175, 55, 0.3); border-radius: 50%; display: flex; align-items: center; justify-content: center;">
            <svg style="width: 30px; height: 30px; color: #D4AF37;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z"/>
            </svg>
        </div>
    </div>
    
    <div id="extraServicesContainer" class="space-y-4">
        <!-- Checkbox servizi popolati dinamicamente qui -->
    </div>
</div>

                <!-- Date and Time -->
                <div class="glass-card p-8 animate-fade-in">
                    <h3 class="text-2xl font-bold mb-6" data-i18n="booking_datetime_title">Data e Orario</h3>
                    <div class="grid md:grid-cols-2 gap-6">
                        <div class="date-picker-container">
                            <label class="block text-sm font-medium mb-2" style="color: #c9a891;" data-i18n="booking_date_label">Data</label>
                            <div style="position: relative;">
                                <input type="text" id="bookingDate" class="date-picker-input" data-i18n-placeholder="booking_date_placeholder" placeholder="Seleziona data" readonly required>
                                <svg class="date-icon w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                                </svg>
                            </div>
                            <!-- calendar is now rendered/positioned via JS into body -->
                            <p id="bookingAdviceText" class="text-xs mt-2" style="color: #a59173;">Prenotazione da 48-72 ore prima, fino a 6 mesi</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2" style="color: #c9a891;" data-i18n="booking_time_label">Orario</label>
                            <select id="bookingTime" required>
                                <option value="" data-i18n="booking_time_placeholder">Seleziona orario</option>
                                <option value="09:00">09:00</option>
                                <option value="10:00">10:00</option>
                                <option value="11:00">11:00</option>
                                <option value="14:00">14:00</option>
                                <option value="15:00">15:00</option>
                                <option value="16:00">16:00</option>
                                <option value="17:00">17:00</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Personal Information -->
                <div class="glass-card p-8 animate-fade-in">
                    <h3 class="text-2xl font-bold mb-6" data-i18n="booking_personal_title">I Tuoi Dati</h3>
<div class="grid md:grid-cols-2 gap-6">
    <div>
        <label class="block text-sm font-medium mb-2" style="color: #c9a891;" data-i18n="booking_first_name">Nome</label>
        <input type="text" data-i18n-placeholder="booking_first_name_placeholder" placeholder="Il tuo nome" required>
    </div>
    <div>
        <label class="block text-sm font-medium mb-2" style="color: #c9a891;" data-i18n="booking_last_name">Cognome</label>
        <input type="text" data-i18n-placeholder="booking_last_name_placeholder" placeholder="Il tuo cognome" required>
    </div>
    <div>
        <label class="block text-sm font-medium mb-2" style="color: #c9a891;" data-i18n="booking_email">Email</label>
        <input type="email" data-i18n-placeholder="booking_email_placeholder" placeholder="tua@email.com" required>
    </div>
    <div>
        <label class="block text-sm font-medium mb-2" style="color: #c9a891;" data-i18n="booking_phone">Telefono</label>
        <input type="tel" data-i18n-placeholder="booking_phone_placeholder" placeholder="+39 123 456 7890" required>
    </div>
    <div class="md:col-span-2">
        <label class="block text-sm font-medium mb-2" style="color: #c9a891;" data-i18n="booking_notes_label">Note Aggiuntive (opzionale)</label>
        <textarea rows="3" data-i18n-placeholder="booking_notes_placeholder" placeholder="Hai richieste particolari?"></textarea>
    </div>
</div>
                </div>

                <!-- Terms -->
                <div class="glass-card p-6 animate-fade-in">
                    <label class="checkbox-container">
                        <input type="checkbox" id="termsCheckbox" required>
                        <div class="text-sm" style="color: #c9a891;">
    <span data-i18n="booking_terms_accept">Accetto i</span> 
    <a href="#" class="text-[#d4af37] hover:underline" data-i18n="booking_terms_link">termini e condizioni</a> 
    <span data-i18n="booking_terms_and">e la</span> 
    <a href="#" class="text-[#d4af37] hover:underline" data-i18n="booking_privacy_link">politica sulla privacy</a>
</div>
                    </label>
                </div>
            </div>

            <!-- Sidebar - Price Summary -->
            <div class="lg:col-span-1 sidebar"> <!-- <-- wrapper reso sticky -->
                <div class="glass-card p-8 price-summary animate-fade-in">
                    <h3 class="text-2xl font-bold mb-6 gradient-text" data-i18n="booking_summary_title">Riepilogo</h3>
                    
                    <div class="space-y-4 mb-6 pb-6 border-b" style="border-color: rgba(80, 60, 45, 0.3);">
                        <div class="flex justify-between">
                           <span style="color: #c9a891;" class="summary-product-title"></span>
                           <span class="font-semibold" id="basePrice">â‚¬0</span>
                        </div>
                        
                        <div class="flex justify-between hidden" id="secondCarPrice">
                             <span style="color: #c9a891;" id="secondCarName">Seconda Supercar</span>
                             <span class="font-semibold" id="secondCarPriceAmount">â‚¬0</span>
                        </div>
                        <div id="extraServicesPrice" class="space-y-2"></div>
                    </div>

                    <div class="space-y-3 mb-6 summary-benefits">
                         <!-- Popolato dinamicamente -->
                    </div>

                    <div class="p-4 rounded-lg mb-6" style="background: linear-gradient(to right, rgba(212, 175, 55, 0.12), transparent);">
                        <div class="flex justify-between items-center">
                            <span class="text-lg font-semibold" data-i18n="booking_summary_total">Totale</span>
                            <span class="text-3xl font-bold gradient-text" id="totalPrice">â‚¬0</span>
                        </div>
                    </div>

                    <button class="btn-primary w-full" onclick="confirmBooking()" data-i18n="booking_summary_btn">
    Conferma Prenotazione
</button>
<p class="text-xs text-center mt-4" style="color: #a59173;" data-i18n="booking_summary_secure">
    Prenotazione sicura e protetta
</p>
                </div>

                <!-- Policies -->
                <div class="glass-card p-6 mt-6 animate-fade-in policies-card">
                    <h4 class="font-semibold mb-4 gradient-text" data-i18n="booking_policies_title">Politiche</h4>
<div class="space-y-3 text-sm" style="color: #c9a891;">
    <div>
        <strong style="color: #f5f5f0;" data-i18n="booking_policy_refund_label">Rimborso:</strong> 
        <span data-i18n="booking_policy_refund_text">Rimborso completo fino a 48 ore prima della prenotazione.</span>
    </div>
    <div>
        <strong style="color: #f5f5f0;" data-i18n="booking_policy_cancel_label">Annullamento:</strong> 
        <span data-i18n="booking_policy_cancel_text">Annullamento gratuito fino a 24 ore prima. Oltre tale termine, verrÃ  trattenuto il 50% dell'importo.</span>
    </div>
    <div>
        <strong style="color: #f5f5f0;" data-i18n="booking_policy_reschedule_label">Cambio Data:</strong> 
        <span data-i18n="booking_policy_reschedule_text">Modifica gratuita della data fino a 72 ore prima dell'esperienza.</span>
    </div>
</div>       
                </div>
            </div>
        </div>
    </div>

   <!-- Connection Monitor Script -->
<script src="../connection-monitor.js"></script>

    <script>
    // ========================================
    // CONFIGURAZIONE GLOBALE
    // ========================================
    const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbwr79RkXIEocpuOKaM6uMJqE6VFs9wjlUPvrr__FvDbDDrD2ELB1NbfrWP3BCYpHj2u/exec';

        // ========================================
// CONFIGURAZIONE PREZZI COMBO SUPERCAR
// ========================================
const COMBO_PRICING = {
    // California + HuracÃ¡n (entrambi gli ordini)
    'SC-001+SC-006': {
        km: [10, 20, 30, 60, 90, 120],
        prices: [176, 312, 424, 784, 1096, 1368],
        labels: ['Esperienza rapida', 'PiÃ¹ popolare', 'Esperienza completa', 'Tour esteso', 'Avventura lunga', 'Esperienza definitiva']
    },
    'SC-006+SC-001': {
        km: [10, 20, 30, 60, 90, 120],
        prices: [176, 312, 424, 784, 1096, 1368],
        labels: ['Esperienza rapida', 'PiÃ¹ popolare', 'Esperienza completa', 'Tour esteso', 'Avventura lunga', 'Esperienza definitiva']
    },
    
    // Portofino + HuracÃ¡n (entrambi gli ordini)
    'SC-002+SC-006': {
        km: [10, 20, 30, 60, 90, 120],
        prices: [208, 368, 528, 929, 1315, 1528],
        labels: ['Esperienza rapida', 'PiÃ¹ popolare', 'Esperienza completa', 'Tour esteso', 'Avventura lunga', 'Esperienza definitiva']
    },
    'SC-006+SC-002': {
        km: [10, 20, 30, 60, 90, 120],
        prices: [208, 368, 528, 929, 1315, 1528],
        labels: ['Esperienza rapida', 'PiÃ¹ popolare', 'Esperienza completa', 'Tour esteso', 'Avventura lunga', 'Esperienza definitiva']
    },
    
    // 488 Spider + HuracÃ¡n (entrambi gli ordini)
    'SC-003+SC-006': {
        km: [10, 20, 30, 60, 90, 120],
        prices: [224, 399, 575, 1040, 1460, 1800],
        labels: ['Esperienza rapida', 'PiÃ¹ popolare', 'Esperienza completa', 'Tour esteso', 'Avventura lunga', 'Esperienza definitiva']
    },
    'SC-006+SC-003': {
        km: [10, 20, 30, 60, 90, 120],
        prices: [224, 399, 575, 1040, 1460, 1800],
        labels: ['Esperienza rapida', 'PiÃ¹ popolare', 'Esperienza completa', 'Tour esteso', 'Avventura lunga', 'Esperienza definitiva']
    }
};

// ========================================
// CONFIGURAZIONE VALIDAZIONE EMAIL
// ========================================
const ALLOWED_EMAIL_PROVIDERS = [
    // Provider internazionali
    'gmail.com', 'yahoo.com', 'outlook.com', 'hotmail.com', 'live.com',
    'icloud.com', 'me.com', 'mac.com', 'protonmail.com', 'proton.me',
    'aol.com', 'zoho.com', 'mail.com', 'gmx.com', 'yandex.com',
    
    // Provider italiani
    'libero.it', 'virgilio.it', 'tiscali.it', 'alice.it', 'tin.it',
    'fastwebnet.it', 'tim.it', 'vodafone.it', 'wind.it', 'tre.it',
    'poste.it', 'email.it', 'pec.it', 'legalmail.it',
    
    // Provider aziendali comuni
    'outlook.it', 'hotmail.it', 'live.it', 'msn.com'
];

const TEMP_EMAIL_PATTERNS = [
    'tempmail', 'temp-mail', 'throwaway', 'disposable',
    '10minutemail', '10minute', 'guerrillamail', 'guerrilla',
    'mailinator', 'maildrop', 'sharklasers', 'getnada',
    'trashmail', 'fakeinbox', 'yopmail', 'mintemail',
    'dispostable', 'spamgourmet', 'mytemp', 'tempr'
];

/**
 * Valida email con provider check
 */
function validateEmail(email) {
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    
    if (!emailRegex.test(email)) {
        return { valid: false, message: 'Il formato dell\'indirizzo email non Ã¨ valido.' };
    }
    
    const domain = email.split('@')[1].toLowerCase();
    
    // Check email temporanee
    for (const pattern of TEMP_EMAIL_PATTERNS) {
        if (domain.includes(pattern)) {
            return { 
                valid: false, 
                message: 'Le email temporanee non sono consentite. Ti preghiamo di utilizzare un indirizzo email permanente e affidabile.' 
            };
        }
    }
    
    // Check provider noti
    if (!ALLOWED_EMAIL_PROVIDERS.includes(domain)) {
        return { 
            valid: false, 
            message: `Il provider "${domain}" non Ã¨ riconosciuto nel nostro sistema. Ti preghiamo di utilizzare un indirizzo email da un provider affidabile (es. Gmail, Outlook, Libero, Virgilio).` 
        };
    }
    
    return { valid: true };
}

/**
 * Mostra notifica errore elegante
 */
function showEmailError(message) {
    const toast = document.createElement('div');
    toast.style.cssText = `
        position: fixed;
        top: 30px;
        right: 30px;
        background: linear-gradient(135deg, rgba(20, 15, 12, 0.98), rgba(30, 20, 15, 0.98));
        backdrop-filter: blur(20px);
        color: #f5f5f0;
        padding: 24px 32px;
        border-radius: 16px;
        box-shadow: 0 20px 60px rgba(239, 68, 68, 0.3), 0 0 0 1px rgba(239, 68, 68, 0.2);
        z-index: 100000;
        font-size: 15px;
        max-width: 420px;
        border: 1.5px solid rgba(239, 68, 68, 0.4);
        animation: slideInRight 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
    `;
    
    toast.innerHTML = `
        <div style="display: flex; align-items: flex-start; gap: 16px;">
            <div style="flex-shrink: 0; width: 28px; height: 28px; background: rgba(239, 68, 68, 0.15); border-radius: 50%; display: flex; align-items: center; justify-content: center; border: 1.5px solid rgba(239, 68, 68, 0.4);">
                <svg style="width: 16px; height: 16px; color: #ef4444;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                </svg>
            </div>
            <div style="flex: 1;">
                <div style="font-weight: 600; margin-bottom: 6px; color: #D4AF37; font-size: 14px; text-transform: uppercase; letter-spacing: 1px;">Email Non Valida</div>
                <div style="line-height: 1.6; color: #c9a891;">${message}</div>
            </div>
        </div>
    `;
    
    // Aggiungi stile animazione
    if (!document.getElementById('toastAnimationStyle')) {
        const style = document.createElement('style');
        style.id = 'toastAnimationStyle';
        style.textContent = `
            @keyframes slideInRight {
                from {
                    opacity: 0;
                    transform: translateX(100px);
                }
                to {
                    opacity: 1;
                    transform: translateX(0);
                }
            }
        `;
        document.head.appendChild(style);
    }
    
    document.body.appendChild(toast);
    
    // Rimuovi dopo 5 secondi
    setTimeout(() => {
        toast.style.transition = 'opacity 0.4s ease, transform 0.4s ease';
        toast.style.opacity = '0';
        toast.style.transform = 'translateX(50px)';
        setTimeout(() => toast.remove(), 400);
    }, 5000);
}

// ========================================
// CONFIGURAZIONE PREFISSI INTERNAZIONALI
// ========================================

// Mappatura emoji bandiere â†’ codici ISO 3166-1 alpha-2 (per Flag Icons CSS)
const FLAG_EMOJI_TO_ISO = {
    'ğŸ‡®ğŸ‡¹': 'it', 'ğŸ‡ºğŸ‡¸': 'us', 'ğŸ‡¬ğŸ‡§': 'gb', 'ğŸ‡«ğŸ‡·': 'fr', 'ğŸ‡©ğŸ‡ª': 'de', 'ğŸ‡ªğŸ‡¸': 'es',
    'ğŸ‡¨ğŸ‡­': 'ch', 'ğŸ‡¦ğŸ‡¹': 'at', 'ğŸ‡§ğŸ‡ª': 'be', 'ğŸ‡³ğŸ‡±': 'nl', 'ğŸ‡µğŸ‡¹': 'pt', 'ğŸ‡¬ğŸ‡·': 'gr',
    'ğŸ‡®ğŸ‡ª': 'ie', 'ğŸ‡©ğŸ‡°': 'dk', 'ğŸ‡¸ğŸ‡ª': 'se', 'ğŸ‡³ğŸ‡´': 'no', 'ğŸ‡«ğŸ‡®': 'fi', 'ğŸ‡µğŸ‡±': 'pl',
    'ğŸ‡¨ğŸ‡¿': 'cz', 'ğŸ‡·ğŸ‡º': 'ru', 'ğŸ‡¨ğŸ‡³': 'cn', 'ğŸ‡¯ğŸ‡µ': 'jp', 'ğŸ‡°ğŸ‡·': 'kr', 'ğŸ‡®ğŸ‡³': 'in',
    'ğŸ‡¦ğŸ‡º': 'au', 'ğŸ‡³ğŸ‡¿': 'nz', 'ğŸ‡¿ğŸ‡¦': 'za', 'ğŸ‡§ğŸ‡·': 'br', 'ğŸ‡¦ğŸ‡·': 'ar', 'ğŸ‡²ğŸ‡½': 'mx',
    'ğŸ‡¦ğŸ‡ª': 'ae', 'ğŸ‡¸ğŸ‡¦': 'sa', 'ğŸ‡¹ğŸ‡·': 'tr'
};
        
const COUNTRY_CODES = [
    { code: '+39', country: 'Italia', flag: 'ğŸ‡®ğŸ‡¹', format: '### ### ####', maxLength: 10 },
    { code: '+1', country: 'Stati Uniti', flag: 'ğŸ‡ºğŸ‡¸', format: '(###) ###-####', maxLength: 10 },
    { code: '+44', country: 'Regno Unito', flag: 'ğŸ‡¬ğŸ‡§', format: '#### ### ####', maxLength: 10 },
    { code: '+33', country: 'Francia', flag: 'ğŸ‡«ğŸ‡·', format: '# ## ## ## ##', maxLength: 9 },
    { code: '+49', country: 'Germania', flag: 'ğŸ‡©ğŸ‡ª', format: '### ########', maxLength: 11 },
    { code: '+34', country: 'Spagna', flag: 'ğŸ‡ªğŸ‡¸', format: '### ## ## ##', maxLength: 9 },
    { code: '+41', country: 'Svizzera', flag: 'ğŸ‡¨ğŸ‡­', format: '## ### ## ##', maxLength: 9 },
    { code: '+43', country: 'Austria', flag: 'ğŸ‡¦ğŸ‡¹', format: '#### ######', maxLength: 10 },
    { code: '+32', country: 'Belgio', flag: 'ğŸ‡§ğŸ‡ª', format: '### ## ## ##', maxLength: 9 },
    { code: '+31', country: 'Paesi Bassi', flag: 'ğŸ‡³ğŸ‡±', format: '## ########', maxLength: 9 },
    { code: '+351', country: 'Portogallo', flag: 'ğŸ‡µğŸ‡¹', format: '### ### ###', maxLength: 9 },
    { code: '+30', country: 'Grecia', flag: 'ğŸ‡¬ğŸ‡·', format: '### ### ####', maxLength: 10 },
    { code: '+353', country: 'Irlanda', flag: 'ğŸ‡®ğŸ‡ª', format: '## ### ####', maxLength: 9 },
    { code: '+45', country: 'Danimarca', flag: 'ğŸ‡©ğŸ‡°', format: '## ## ## ##', maxLength: 8 },
    { code: '+46', country: 'Svezia', flag: 'ğŸ‡¸ğŸ‡ª', format: '## ### ## ##', maxLength: 9 },
    { code: '+47', country: 'Norvegia', flag: 'ğŸ‡³ğŸ‡´', format: '### ## ###', maxLength: 8 },
    { code: '+358', country: 'Finlandia', flag: 'ğŸ‡«ğŸ‡®', format: '## ### ####', maxLength: 9 },
    { code: '+48', country: 'Polonia', flag: 'ğŸ‡µğŸ‡±', format: '### ### ###', maxLength: 9 },
    { code: '+420', country: 'Rep. Ceca', flag: 'ğŸ‡¨ğŸ‡¿', format: '### ### ###', maxLength: 9 },
    { code: '+7', country: 'Russia', flag: 'ğŸ‡·ğŸ‡º', format: '### ###-##-##', maxLength: 10 },
    { code: '+86', country: 'Cina', flag: 'ğŸ‡¨ğŸ‡³', format: '### #### ####', maxLength: 11 },
    { code: '+81', country: 'Giappone', flag: 'ğŸ‡¯ğŸ‡µ', format: '## #### ####', maxLength: 10 },
    { code: '+82', country: 'Corea del Sud', flag: 'ğŸ‡°ğŸ‡·', format: '## #### ####', maxLength: 10 },
    { code: '+91', country: 'India', flag: 'ğŸ‡®ğŸ‡³', format: '##### #####', maxLength: 10 },
    { code: '+61', country: 'Australia', flag: 'ğŸ‡¦ğŸ‡º', format: '### ### ###', maxLength: 9 },
    { code: '+64', country: 'Nuova Zelanda', flag: 'ğŸ‡³ğŸ‡¿', format: '## ### ####', maxLength: 9 },
    { code: '+27', country: 'Sudafrica', flag: 'ğŸ‡¿ğŸ‡¦', format: '## ### ####', maxLength: 9 },
    { code: '+55', country: 'Brasile', flag: 'ğŸ‡§ğŸ‡·', format: '## #####-####', maxLength: 11 },
    { code: '+54', country: 'Argentina', flag: 'ğŸ‡¦ğŸ‡·', format: '## ####-####', maxLength: 10 },
    { code: '+52', country: 'Messico', flag: 'ğŸ‡²ğŸ‡½', format: '## #### ####', maxLength: 10 },
    { code: '+971', country: 'Emirati Arabi', flag: 'ğŸ‡¦ğŸ‡ª', format: '## ### ####', maxLength: 9 },
    { code: '+966', country: 'Arabia Saudita', flag: 'ğŸ‡¸ğŸ‡¦', format: '## ### ####', maxLength: 9 },
    { code: '+90', country: 'Turchia', flag: 'ğŸ‡¹ğŸ‡·', format: '### ### ####', maxLength: 10 }
];

let selectedCountry = COUNTRY_CODES[0]; // Default: Italia

/**
 * Formatta numero telefono in base al paese selezionato
 */
function formatPhoneNumber(value, format) {
    // Rimuovi tutto tranne numeri
    const numbers = value.replace(/\D/g, '');
    
    let formatted = '';
    let numberIndex = 0;
    
    for (let i = 0; i < format.length && numberIndex < numbers.length; i++) {
        if (format[i] === '#') {
            formatted += numbers[numberIndex];
            numberIndex++;
        } else {
            formatted += format[i];
        }
    }
    
    return formatted;
}

/**
 * Inizializza selector prefisso telefonico
 */
function initPhoneSelector() {
    const phoneInput = document.querySelector('input[type="tel"]');
    if (!phoneInput) return;
    
    const container = phoneInput.parentElement;
    
    // Crea wrapper per input e selector
    const wrapper = document.createElement('div');
    wrapper.style.cssText = 'position: relative; display: flex; gap: 0;';
    
    // Crea selector prefisso
    const selector = document.createElement('div');
    selector.style.cssText = 'position: relative; z-index: 10;';
    
    // Crea selector con solo il button
    selector.innerHTML = `
    <button type="button" class="country-selector-btn" style="
        background: rgba(10, 10, 10, 0.9);
        border: 1.5px solid rgba(80, 60, 45, 0.4);
        border-right: none;
        color: #f5f5f0;
        padding: 16px 18px;
        border-radius: 12px 0 0 12px;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 10px;
        font-family: 'Inter', sans-serif;
        font-size: 15px;
        white-space: nowrap;
        min-width: 135px;
    ">
        <span class="flag-icon-container">
            <span class="fi fi-it"></span>
        </span>
        <span class="selected-code" style="font-weight: 600; color: #D4AF37; font-size: 15px; line-height: 1; display: inline-flex; align-items: center;">+39</span>
        <svg class="w-4 h-4" style="width: 14px; height: 14px; margin-left: auto; color: #c9a891; transition: transform 0.3s;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
        </svg>
    </button>
`;

    // Crea dropdown SEPARATO e appendilo al body
    const dropdown = document.createElement('div');
    dropdown.className = 'country-dropdown';
    dropdown.style.cssText = `
        display: none;
        position: absolute;
        background: linear-gradient(135deg, rgba(20, 15, 12, 0.98), rgba(30, 20, 15, 0.98));
        backdrop-filter: blur(20px);
        border: 2px solid rgba(212, 175, 55, 0.3);
        border-radius: 16px;
        padding: 12px;
        z-index: 999999;
        min-width: 320px;
        max-height: 400px;
        overflow-y: auto;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.8);
    `;

    dropdown.innerHTML = `
    <div style="padding: 8px 12px; margin-bottom: 8px;">
        <input type="text" placeholder="Cerca paese..." class="country-search" style="
            width: 100%;
            background: rgba(10, 10, 10, 0.6);
            border: 1px solid rgba(80, 60, 45, 0.4);
            color: #f5f5f0;
            padding: 10px 14px;
            border-radius: 10px;
            font-size: 14px;
            outline: none;
            transition: all 0.3s ease;
        " />
    </div>
    <div class="country-list">
        ${COUNTRY_CODES.map(c => {
    const isoCode = FLAG_EMOJI_TO_ISO[c.flag] || 'xx';
    const i18n = window.i18nPDP();
    const countryName = i18n ? i18n.t(`booking_countries.${isoCode}`) : c.country;
    return `
            <div class="country-option" data-code="${c.code}" data-format="${c.format}" data-max="${c.maxLength}" data-iso="${isoCode}" style="
                display: flex;
                align-items: center;
                gap: 12px;
                padding: 12px 14px;
                cursor: pointer;
                border-radius: 10px;
                transition: all 0.3s ease;
                margin-bottom: 4px;
            ">
                <span class="flag-icon-container">
                    <span class="fi fi-${isoCode}"></span>
                </span>
                <span class="country-name" style="flex: 1; color: #f5f5f0; font-size: 14px;">${countryName}</span>
                <span class="country-code" style="color: #D4AF37; font-weight: 600; font-size: 14px;">${c.code}</span>
            </div>
        `;
        }).join('')}
    </div>
`;

    document.body.appendChild(dropdown);
    
    // Sostituisci struttura
    container.insertBefore(wrapper, phoneInput);
    wrapper.appendChild(selector);
    wrapper.appendChild(phoneInput);
    
    // âœ… DEFINISCI VARIABILI DOPO AVER CREATO GLI ELEMENTI
    const btn = selector.querySelector('.country-selector-btn');
    const search = dropdown.querySelector('.country-search');
    
    // Aggiorna stile input telefono
    phoneInput.style.borderRadius = '0 12px 12px 0';
    phoneInput.style.borderLeft = '1.5px solid rgba(80, 60, 45, 0.4)';
    phoneInput.style.flex = '1';
    phoneInput.style.marginLeft = '0';
    phoneInput.placeholder = selectedCountry.format.replace(/#/g, '0'); // Es: "000 000 0000" per Italia

    // Effetto hover coordinato
    btn.addEventListener('mouseenter', () => {
        btn.style.borderColor = 'rgba(212, 175, 55, 0.6)';
        phoneInput.style.borderColor = 'rgba(212, 175, 55, 0.6)';
    });

    btn.addEventListener('mouseleave', () => {
        if (!phoneInput.matches(':focus')) {
            btn.style.borderColor = 'rgba(80, 60, 45, 0.4)';
            phoneInput.style.borderColor = 'rgba(80, 60, 45, 0.4)';
        }
    /**
 * ğŸŒ Aggiorna nomi paesi nel dropdown telefono
 */
function updatePhoneDropdownLanguage() {
    const i18n = window.i18nPDP();
    if (!i18n) return;
    
    document.querySelectorAll('.country-option').forEach(option => {
        const isoCode = option.dataset.iso;
        const nameSpan = option.querySelector('.country-name');
        if (nameSpan && isoCode) {
            nameSpan.textContent = i18n.t(`booking_countries.${isoCode}`);
        }
    });
}

/**
 * ğŸŒ Aggiorna etichette distanze per nuova lingua
 */
function updateDistanceLabels() {
    const i18n = window.i18nPDP();
    if (!i18n || !bookingData.productData) return;
    
    document.querySelectorAll('.distance-option').forEach(option => {
        const km = option.dataset.km;
        const unit = option.dataset.unit || 'km';
        const labelDiv = option.querySelector('.text-sm[style*="color: #a59173"]');
        
        if (!labelDiv) return;
        
        // Mappa km â†’ chiave traduzione
        const labelMap = {
            '10': 'booking_distance_rapid',
            '20': 'booking_distance_popular',
            '30': 'booking_distance_complete',
            '60': 'booking_distance_extended',
            '70': 'booking_distance_long',
            '90': 'booking_distance_long',
            '120': 'booking_distance_ultimate'
        };
        
        const labelKey = labelMap[km];
        if (labelKey) {
            labelDiv.textContent = i18n.t(labelKey);
        }
    });
}
        
    });

    phoneInput.addEventListener('focus', () => {
        btn.style.borderColor = '#d4af37';
        phoneInput.style.borderColor = '#d4af37';
    });

    phoneInput.addEventListener('blur', () => {
        btn.style.borderColor = 'rgba(80, 60, 45, 0.4)';
        phoneInput.style.borderColor = 'rgba(80, 60, 45, 0.4)';
    });

    // Toggle dropdown
btn.addEventListener('click', (e) => {
    e.stopPropagation();
    const isVisible = dropdown.style.display === 'block';
    
    if (isVisible) {
        dropdown.style.display = 'none';
        btn.querySelector('svg').style.transform = 'rotate(0deg)';
    } else {
        // âœ… POSIZIONAMENTO MIGLIORATO
        const rect = btn.getBoundingClientRect();
        
        // Imposta display prima per calcoli corretti
        dropdown.style.display = 'block';
        dropdown.style.visibility = 'hidden'; // Nascosto durante calcolo
        
        // Calcola posizione
        const left = rect.left + window.scrollX;
        const top = rect.bottom + window.scrollY + 8;
        
        dropdown.style.left = left + 'px';
        dropdown.style.top = top + 'px';
        dropdown.style.minWidth = Math.max(320, rect.width) + 'px';
        
        // Debug logging (rimuovi dopo test)
        console.log('ğŸ“ Dropdown position:', {
            left: left,
            top: top,
            btnRect: rect,
            dropdownDisplay: dropdown.style.display,
            dropdownZIndex: dropdown.style.zIndex
        });
        
        // Rendi visibile
        dropdown.style.visibility = 'visible';
        
        btn.querySelector('svg').style.transform = 'rotate(180deg)';
        
        search.value = '';
        setTimeout(() => search.focus(), 50); // Delay per iOS
        filterCountries('');
    }
});
    
    // Chiudi dropdown al click fuori
    document.addEventListener('click', (e) => {
        if (!dropdown.contains(e.target) && !btn.contains(e.target)) {
            dropdown.style.display = 'none';
            btn.querySelector('svg').style.transform = 'rotate(0deg)';
        }
    });

    // Riposiziona dropdown on scroll/resize
    window.addEventListener('resize', () => {
        if (dropdown.style.display === 'block') {
            const rect = btn.getBoundingClientRect();
            dropdown.style.position = 'absolute';
            dropdown.style.left = rect.left + window.scrollX + 'px';
            dropdown.style.top = (rect.bottom + window.scrollY + 8) + 'px';
        }
    });

    window.addEventListener('scroll', () => {
        if (dropdown.style.display === 'block') {
            const rect = btn.getBoundingClientRect();
            dropdown.style.left = rect.left + window.scrollX + 'px';
            dropdown.style.top = (rect.bottom + window.scrollY + 8) + 'px';
        }
    }, true);
    
    // Ricerca paese
    search.addEventListener('input', (e) => {
        filterCountries(e.target.value.toLowerCase());
    });
    
    // Selezione paese
dropdown.querySelectorAll('.country-option').forEach(option => {
    option.addEventListener('click', () => {
        const code = option.dataset.code;
        const format = option.dataset.format;
        const maxLength = parseInt(option.dataset.max);
        const isoCode = option.dataset.iso;
        
        selectedCountry = COUNTRY_CODES.find(c => c.code === code);
        
        // âœ… Aggiorna UI selector con bandiera SVG
        const btnFlagContainer = btn.querySelector('.flag-icon-container');
        if (btnFlagContainer) {
            btnFlagContainer.innerHTML = `<span class="fi fi-${isoCode}"></span>`;
        }
        
        btn.querySelector('.selected-code').textContent = code;

            // Aggiorna placeholder con formattazione del paese
            phoneInput.placeholder = format.replace(/#/g, '0');
            
            // Reset e focus input
            phoneInput.value = '';
            phoneInput.focus();
            
            dropdown.style.display = 'none';
            btn.querySelector('svg').style.transform = 'rotate(0deg)';
        });
        
        // Hover effect
        option.addEventListener('mouseenter', () => {
            option.style.background = 'rgba(212, 175, 55, 0.15)';
        });
        
        option.addEventListener('mouseleave', () => {
            option.style.background = 'transparent';
        });
    });
    
    // Formattazione in tempo reale
    phoneInput.addEventListener('input', (e) => {
        let value = e.target.value.replace(/\D/g, '');
        
        // Limita lunghezza
        if (value.length > selectedCountry.maxLength) {
            value = value.substring(0, selectedCountry.maxLength);
        }
        
        // Applica formato
        e.target.value = formatPhoneNumber(value, selectedCountry.format);
    });
    
    // Previeni paste non numerici
    phoneInput.addEventListener('paste', (e) => {
        e.preventDefault();
        const pastedText = (e.clipboardData || window.clipboardData).getData('text');
        const numbers = pastedText.replace(/\D/g, '');
        
        if (numbers.length > selectedCountry.maxLength) {
            phoneInput.value = formatPhoneNumber(numbers.substring(0, selectedCountry.maxLength), selectedCountry.format);
        } else {
            phoneInput.value = formatPhoneNumber(numbers, selectedCountry.format);
        }
    });
    
    // Funzione filtro paesi
    function filterCountries(query) {
        dropdown.querySelectorAll('.country-option').forEach(option => {
            const country = option.querySelector('.country-name').textContent.toLowerCase();
            const code = option.querySelector('.country-code').textContent.toLowerCase();
            
            if (country.includes(query) || code.includes(query)) {
                option.style.display = 'flex';
            } else {
                option.style.display = 'none';
            }
        });
    }
}

// Aggiungi stile scroll personalizzato dropdown
const dropdownScrollStyle = document.createElement('style');
dropdownScrollStyle.textContent = `
    .country-dropdown::-webkit-scrollbar {
        width: 8px;
    }
    .country-dropdown::-webkit-scrollbar-track {
        background: rgba(10, 10, 10, 0.4);
        border-radius: 10px;
    }
    .country-dropdown::-webkit-scrollbar-thumb {
        background: rgba(212, 175, 55, 0.3);
        border-radius: 10px;
    }
    .country-dropdown::-webkit-scrollbar-thumb:hover {
        background: rgba(212, 175, 55, 0.5);
    }

    /* ===================================
   ğŸŒ BANDIERE SVG (Flag Icons CSS)
   =================================== */

/* Container bandiera nel button */
.country-selector-btn .flag-icon-container {
    display: inline-flex !important;
    align-items: center;
    justify-content: center;
    width: 28px !important;
    height: 28px !important;
    flex-shrink: 0;
    overflow: hidden;
    border-radius: 4px; /* Arrotonda leggermente i bordi */
}

/* Bandiera SVG nel button */
.country-selector-btn .fi {
    font-size: 24px !important;
    line-height: 1 !important;
    width: 28px !important;
    height: 21px !important; /* Proporzione 4:3 standard */
    display: block !important;
}

/* Container bandiera nel dropdown */
.country-option .flag-icon-container {
    display: inline-flex !important;
    align-items: center;
    justify-content: center;
    width: 32px !important;
    height: 32px !important;
    flex-shrink: 0;
    overflow: hidden;
    border-radius: 4px;
}

/* Bandiera SVG nel dropdown */
.country-option .fi {
    font-size: 28px !important;
    line-height: 1 !important;
    width: 32px !important;
    height: 24px !important;
    display: block !important;
}

/* Responsive mobile */
@media (max-width: 768px) {
    .country-selector-btn .flag-icon-container {
        width: 24px !important;
        height: 24px !important;
    }
    
    .country-selector-btn .fi {
        width: 24px !important;
        height: 18px !important;
    }
    
    .country-option .flag-icon-container {
        width: 28px !important;
        height: 28px !important;
    }
    
    .country-option .fi {
        width: 28px !important;
        height: 21px !important;
    }
}    

    .country-search:focus {
        border-color: #D4AF37;
        box-shadow: 0 0 0 3px rgba(212, 175, 55, 0.15);
    }
    .country-selector-btn:hover {
        border-color: rgba(212, 175, 55, 0.6);
        background: rgba(20, 15, 12, 0.95);
    }

    .country-selector-btn:focus,
.country-selector-btn:focus-within {
    border-color: rgba(212, 175, 55, 0.6);
    background: rgba(20, 15, 12, 0.95);
}

input[type="tel"]:focus + .country-selector-btn {
    border-color: rgba(212, 175, 55, 0.6);
}
`;
document.head.appendChild(dropdownScrollStyle);

/**
 * Genera chiave combo da due SKU (ordine-indipendente)
 */
function getComboKey(sku1, sku2) {
    return `${sku1}+${sku2}`;
}

/**
 * Verifica se la combo corrente ha prezzi custom
 */
function hasCustomComboPricing() {
    if (!bookingData.secondCar || !bookingData.productData) {
        console.log('âŒ Combo check fallito: dati mancanti');
        return false;
    }
    
    const mainSku = bookingData.productData.sku;
    const comboCheckbox = document.getElementById('secondCarCheckbox');
    
    if (!comboCheckbox) {
        console.log('âŒ Checkbox combo non trovato');
        return false;
    }
    
    const comboSku = comboCheckbox.dataset.comboSku;
    if (!comboSku) {
        console.log('âŒ Combo SKU non presente nel dataset');
        return false;
    }
    
    const comboKey = getComboKey(mainSku, comboSku);
    const hasCombo = COMBO_PRICING.hasOwnProperty(comboKey);
    
    console.log('ğŸ” Combo check:', {
        mainSku,
        comboSku,
        comboKey,
        hasCombo
    });
    
    return hasCombo;
}

/**
 * Applica prezzi combo custom alla griglia distanze
 */
function applyComboDistancePricing() {
    const mainSku = bookingData.productData.sku;
    const comboCheckbox = document.getElementById('secondCarCheckbox');
    
    if (!comboCheckbox) return;
    
    const comboSku = comboCheckbox.dataset.comboSku;
    if (!comboSku) return;
    
    const comboKey = getComboKey(mainSku, comboSku);
    const comboPricing = COMBO_PRICING[comboKey];
    
    if (!comboPricing) {
        console.log('âš ï¸ Combo non speciale, prezzi standard mantenuti');
        return;
    }
    
    console.log(`âœ… Applicando prezzi combo per: ${comboKey}`);
    
    const distanceGrid = document.getElementById('distanceOptions');
    if (!distanceGrid) return;
    
    // Salva selezione corrente
    const currentSelection = document.querySelector('.distance-option.selected');
    const currentKm = currentSelection ? currentSelection.dataset.km : null;
    
    // Rigenera griglia con prezzi combo
    distanceGrid.innerHTML = '';
    
    comboPricing.km.forEach((km, index) => {
        const price = comboPricing.prices[index];
        const label = comboPricing.labels[index];
        
        const option = document.createElement('div');
        option.className = 'distance-option';
        option.dataset.km = km;
        option.dataset.price = price;
        
        option.innerHTML = `
            <div class="text-2xl font-bold gradient-text mb-2">${km} km</div>
            <div class="text-xl font-semibold mb-1">${formatPrice(price)}</div>
            <div class="text-sm" style="color: #a59173;">${label}</div>
        `;
        
        distanceGrid.appendChild(option);
    });
    
    // Re-bind listeners
    initDistanceSelection(bookingData.productData);
    
    // Ripristina selezione se possibile, altrimenti prima opzione
    let optionToSelect = null;
    
    if (currentKm) {
        optionToSelect = distanceGrid.querySelector(`[data-km="${currentKm}"]`);
    }
    
    if (!optionToSelect) {
        optionToSelect = distanceGrid.querySelector('.distance-option');
    }
    
    if (optionToSelect) {
        optionToSelect.click();
    }
}

/**
 * Ripristina prezzi originali del prodotto
 */
function restoreOriginalDistancePricing() {
    const product = bookingData.productData;
    if (!product) return;
    
    console.log('ğŸ”„ Ripristino prezzi originali prodotto');
    
    const distanceGrid = document.getElementById('distanceOptions');
    if (!distanceGrid) return;
    
    // Salva selezione
    const currentSelection = document.querySelector('.distance-option.selected');
    const currentKm = currentSelection ? currentSelection.dataset.km : null;
    
    // Rigenera con prezzi originali
    distanceGrid.innerHTML = '';
    
    const distanceConfig = getDistanceConfigForProduct(product);
    
    distanceConfig.options.forEach((distance, index) => {
        if (index < product.chilometraggioPrices.length) {
            const price = product.chilometraggioPrices[index];
            
            const option = document.createElement('div');
            option.className = 'distance-option';
            option.dataset.km = distance.value;
            option.dataset.price = price;
            
            option.innerHTML = `
                <div class="text-2xl font-bold gradient-text mb-2">${distance.value} ${distance.unit}</div>
                <div class="text-xl font-semibold mb-1">${formatPrice(price)}</div>
                <div class="text-sm" style="color: #a59173;">${distance.label}</div>
            `;
            
            distanceGrid.appendChild(option);
        }
    });
    
    // Re-bind listeners
    initDistanceSelection(product);
    
    // Ripristina selezione
    let optionToSelect = null;
    
    if (currentKm) {
        optionToSelect = distanceGrid.querySelector(`[data-km="${currentKm}"]`);
    }
    
    if (!optionToSelect) {
        optionToSelect = distanceGrid.querySelector('.distance-option');
    }
    
    if (optionToSelect) {
        optionToSelect.click();
    }
}

    /**
 * Formatta il prezzo per booking.html
 * Output: "â‚¬1.265" (euro PRIMA del numero)
 */
function formatPrice(price, currency = 'EUR') {
    const amount = parseFloat(price) || 0;
    
    // Determina decimali
    let decimals = 0;
    if (amount < 100) decimals = 2;
    else if (amount < 500) decimals = 2;
    else if (amount < 1000) decimals = amount % 1 !== 0 ? 2 : 0;
    else decimals = 0;
    
    // Formatta manualmente
    let formatted = amount.toFixed(decimals);
    
    // Sostituisci punto decimale con virgola
    formatted = formatted.replace('.', ',');
    
    // Aggiungi separatore migliaia (punto)
    let parts = formatted.split(',');
    parts[0] = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, '.');
    
    // Simbolo valuta PRIMA del numero
    const symbol = currency === 'EUR' ? 'â‚¬' : currency;
    
    return `${symbol}${parts.join(',')}`;
}
    
    let bookingData = {
        sku: null,
        productData: null,
        distance: null,
        basePrice: 0,
        secondCar: false,
        extraServices: [],
        total: 0,
        selectedDate: null
    };

    // Set min and max dates
    const now = new Date();
    const minDateTime = new Date(now.getTime() + 48 * 60 * 60 * 1000);
    const minDate = new Date(minDateTime.getFullYear(), minDateTime.getMonth(), minDateTime.getDate());
    const maxDate = new Date(now);
    maxDate.setMonth(maxDate.getMonth() + 6);
    const earliestAllowed = new Date(now.getFullYear(), now.getMonth() - 2, 1);

    // ========================================
    // INIZIALIZZAZIONE PAGINA
    // ========================================
    window.addEventListener('DOMContentLoaded', async () => {
    // âœ… ATTENDI INIZIALIZZAZIONE i18n
    await new Promise(resolve => {
        const checkI18n = setInterval(() => {
            if (window.i18nPDP && window.i18nPDP()) {
                clearInterval(checkI18n);
                resolve();
            }
        }, 50);
        
        // Timeout sicurezza (max 2 secondi)
        setTimeout(() => {
            clearInterval(checkI18n);
            resolve();
        }, 2000);
    });
    
    // 1. Estrai SKU dall'URL
    const urlParams = new URLSearchParams(window.location.search);
    const sku = urlParams.get('sku');
        
        if (!sku) {
            alert('Errore: SKU prodotto mancante');
            window.history.back();
            return;
        }
        
        bookingData.sku = sku;
        
        // 2. Mostra loader
        showPageLoader();
        
        // 3. Fetch dati prodotto
        try {
            const productData = await fetchProductDetails(sku);
            bookingData.productData = productData;
            
            // 4. Renderizza pagina dinamicamente
            renderPage(productData);
            
            // 5. Inizializza componenti interattivi
            initializeComponents(productData);
            
        } catch (error) {
            console.error('Errore caricamento prodotto:', error);
            alert('Impossibile caricare i dettagli del prodotto. Riprova.');
            window.history.back();
        } finally {
            hidePageLoader();
        }
    });

    // ========================================
    // FETCH DATI BACKEND
    // ========================================
    async function fetchProductDetails(sku) {
    const url = `${WEB_APP_URL}?action=get_bookable_product_details&sku=${encodeURIComponent(sku)}&t=${Date.now()}`;
    
    console.log('ğŸ”— Fetching product details:', url);
    
    try {
        const response = await fetch(url);
        
        console.log('ğŸ“¡ Response status:', response.status);
        console.log('ğŸ“¡ Response ok:', response.ok);
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();
        
        console.log('ğŸ“¦ Data received:', data);
        
        if (!data.success) {
            throw new Error(data.error || 'Errore recupero dati');
        }
        
        return data.product;
    } catch (error) {
        console.error('âŒ Fetch error details:', {
            message: error.message,
            stack: error.stack,
            url: url
        });
        throw error;
    }
}

    // ========================================
    // RENDERING DINAMICO PAGINA
    // ========================================
    function renderPage(product) {
    const config = product.typeConfig;
    
    // âœ… 1. HEADER (usa traduzioni dinamiche)
const i18n = window.i18nPDP();
document.querySelector('.hero-title').textContent = i18n.t(config.type === 'supercar' ? 'booking_config_sc_title' : 
                                                            config.type === 'immobili' ? 'booking_config_pr_title' : 
                                                            'booking_config_ex_title');
document.querySelector('.hero-subtitle').textContent = i18n.t(config.type === 'supercar' ? 'booking_config_sc_subtitle' : 
                                                               config.type === 'immobili' ? 'booking_config_pr_subtitle' : 
                                                               'booking_config_ex_subtitle');
document.querySelector('.badge-text').textContent = i18n.t(config.type === 'supercar' ? 'booking_config_sc_badge' : 
                                                            config.type === 'immobili' ? 'booking_config_pr_badge' : 
                                                            'booking_config_ex_badge');
    
    // âœ… 2. IMMAGINE HERO + INIZIALIZZA SLIDER
const heroImg = document.querySelector('#mainProductImage');
if (product.mainImage) {
    heroImg.src = product.mainImage;
    heroImg.alt = product.title;
}

// âœ… INIZIALIZZA SLIDER IMMAGINI
if (product.images && product.images.length > 0) {
    initImageSlider(product.images, product.title);
}
    
    // âœ… 3. DETTAGLI PRODOTTO
    document.querySelectorAll('.product-title').forEach(el => {
        el.textContent = product.title;
    });
    
    document.querySelector('.product-location').innerHTML = `
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/>
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/>
        </svg>
        ${product.luogo}
    `;
    
    // âœ… 4. PREZZO (con formattazione italiana E traduzione DINAMICA)
const priceEl = document.querySelector('.product-price');
const priceLabelEl = document.querySelector('.price-label');

// Determina chiave traduzione in base al tipo prodotto
let priceLabelKey = 'booking_price_label'; // Fallback generico
if (config.type === 'supercar') {
    priceLabelKey = 'booking_price_sc_label';
} else if (config.type === 'immobili') {
    priceLabelKey = 'booking_price_pr_label';
} else if (config.type === 'esperienze') {
    priceLabelKey = 'booking_price_ex_label';
}

if (config.showDynamicPrice) {
    priceEl.textContent = i18n.formatPrice(product.price);
    priceLabelEl.textContent = i18n.t(priceLabelKey);
} else {
    priceEl.textContent = config.fixedPrice;
    priceLabelEl.textContent = i18n.t(priceLabelKey);
}
    
    // âœ… 5. BENEFIT (primi 3 come badge)
    const benefitContainer = document.querySelector('.benefit-badges');
    benefitContainer.innerHTML = '';
    
    product.benefit.slice(0, 3).forEach(benefit => {
        benefitContainer.innerHTML += `
            <span class="feature-badge">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                </svg>
                ${benefit}
            </span>
        `;
    });
    
    // âœ… 6. DESCRIZIONE
    document.querySelector('.product-description').textContent = product.desc;
    
    // âœ… 7. TABELLA PRESTAZIONI
    const table1Title = document.querySelector('.table-1-title');
    const table1Body = document.querySelector('.table-1-body');
    
    table1Title.textContent = config.tables.first.title;
    table1Body.innerHTML = '';
    
    product.prestazioni.forEach((value, index) => {
        const label = config.tables.first.labels[index] || `Campo ${index + 1}`;
        table1Body.innerHTML += `
            <div class="spec-item">
                <span style="color: #a59173;">${label}</span>
                <span class="font-semibold">${value}</span>
            </div>
        `;
    });
    
    // âœ… 8. TABELLA CARATTERISTICHE
    const table2Title = document.querySelector('.table-2-title');
    const table2Body = document.querySelector('.table-2-body');
    
    table2Title.textContent = config.tables.second.title;
    table2Body.innerHTML = '';
    
    product.caratteristiche.forEach((value, index) => {
        const label = config.tables.second.labels[index] || `Campo ${index + 1}`;
        table2Body.innerHTML += `
            <div class="spec-item">
                <span style="color: #a59173;">${label}</span>
                <span class="font-semibold">${value}</span>
            </div>
        `;
    });
    
    // âœ… 9. ORARI DISPONIBILI
    const timeSelect = document.getElementById('bookingTime');
    if (timeSelect) {
        timeSelect.innerHTML = '<option value="">Seleziona orario</option>';
        
        console.log('ğŸ“… Orari ricevuti:', product.orari);
        
        if (product.orari && Array.isArray(product.orari) && product.orari.length > 0) {
            product.orari.forEach(orario => {
                if (orario) {
                    console.log('  âœ… Aggiunto orario:', orario);
                    timeSelect.innerHTML += `<option value="${orario}">${orario}</option>`;
                }
            });
        } else {
            console.warn('âš ï¸ Nessun orario disponibile per questo prodotto');
            const defaultTimes = ['09:00', '10:00', '11:00', '14:00', '15:00', '16:00', '17:00'];
            defaultTimes.forEach(time => {
                timeSelect.innerHTML += `<option value="${time}">${time}</option>`;
            });
        }
    }

    // âœ… 10a. CHILOMETRAGGIO DINAMICO (SOLO SUPERCAR)
const skuPrefix = product.sku.split('-')[0].toUpperCase();

if (skuPrefix === 'SC') {
    const distanceGrid = document.getElementById('distanceOptions');
    if (!distanceGrid) return;
    
    distanceGrid.innerHTML = '';
    
    // ğŸ†• RILEVA SE COMBO (doppia supercar)
    const isCombo = product.sku.includes(' + ') || product.sku.includes('+');
    
    // ğŸ†• USA PREZZI COMBO SE DISPONIBILI, ALTRIMENTI NORMALI
    const prices = (isCombo && product.comboPrices && product.comboPrices.length > 0) 
        ? product.comboPrices 
        : product.chilometraggioPrices;
    
    if (!prices || prices.length === 0) {
        console.warn('âš ï¸ Prezzi non disponibili per questa supercar');
        return;
    }
    
    // âœ… USA CONFIGURAZIONE PERSONALIZZATA (gestisce km/minuti e valori custom)
    const distanceConfig = getDistanceConfigForProduct(product);
    const kmOptions = distanceConfig.options;
    
   kmOptions.forEach((distance, index) => {
    if (index < prices.length) {
        const price = prices[index];
        
        const option = document.createElement('div');
        option.className = 'distance-option';
        option.dataset.km = distance.value;
        option.dataset.price = price;
        option.dataset.unit = distance.unit; // âœ… AGGIUNGI UNITÃ€
        
        option.innerHTML = `
            <div class="text-2xl font-bold gradient-text mb-2">${distance.value} ${distance.unit}</div>
            <div class="text-xl font-semibold mb-1">${formatPrice(price)}</div>
            <div class="text-sm" style="color: #a59173;">${distance.label}</div>
        `;
        
        distanceGrid.appendChild(option);
    }
});
    
    initDistanceSelection(product);
    
    console.log(`ğŸï¸ Prezzi ${isCombo ? 'COMBO' : 'SINGOLA'} caricati:`, prices);
}
    
    // âœ… 10b. BENEFIT NEL RIEPILOGO (restanti)
    const summaryBenefits = document.querySelector('.summary-benefits');
    summaryBenefits.innerHTML = '';

    product.benefit.slice(3).forEach(benefit => {
        summaryBenefits.innerHTML += `
            <div class="flex items-center gap-2 text-sm" style="color: #c9a891;">
                <svg class="w-5 h-5 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                </svg>
                ${benefit}
            </div>
        `;
    });

    // âœ… 10c. CARD SECONDA SUPERCAR DINAMICA (SKIP se giÃ  combo)
const isExistingCombo = product.isExistingCombo === true || product.sku.includes('+');

if (skuPrefix === 'SC' && product.supercarComboSku && !isExistingCombo) {
    // â­ IMPOSTA SUBITO IL COMBO SKU NEL DATASET (PRIMA DEL FETCH)
    const checkbox = document.getElementById('secondCarCheckbox');
    if (checkbox) {
        checkbox.dataset.comboSku = product.supercarComboSku;
        console.log('âœ… Combo SKU impostato:', product.supercarComboSku);
    }
    
    fetchProductDetails(product.supercarComboSku)
        .then(secondCar => {
            const secondCarSection = document.getElementById('secondCarSection');
            const isHuracanSpyder = product.title && 
                                    product.title.toLowerCase().includes('lamborghini') && 
                                    product.title.toLowerCase().includes('huracÃ¡n spyder');
            
            if (secondCarSection) {
                const basePrice = product.price || 0;
                const comboPrice = product.supercarComboPrice || 0;
                const additionalPrice = Math.max(0, comboPrice - basePrice);

                const comboHas4Seats = secondCar.numPosti >= 4;
                
                let labelHTML = `
                    <div class="font-semibold mb-1">Aggiungi ${secondCar.title}</div>
                    <div class="text-sm" style="color: #a59173;">${formatPrice(additionalPrice)} aggiuntivi - Include servizi fotografici e video</div>
                `;
                
                // âœ… HURACÃN: Servizi PREMIUM dentro la card
                if (isHuracanSpyder) {
                    labelHTML += `
                    <div class="huracan-services-wrapper" id="huracanExtraServices" style="display: none; margin-top: 20px; padding-top: 20px; border-top: 1px solid rgba(212, 175, 55, 0.2);">
                        
                        <!-- Header servizi con icona -->
                        <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 20px;">
                            <div style="width: 40px; height: 40px; background: linear-gradient(135deg, rgba(212, 175, 55, 0.15), rgba(255, 215, 0, 0.08)); border: 1.5px solid rgba(212, 175, 55, 0.4); border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                                <svg style="width: 20px; height: 20px; color: #D4AF37;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z"/>
                                </svg>
                            </div>
                            <div>
                                <h3 class="text-2xl font-bold gradient-text mb-2">Servizi Aggiuntivi Disponibili</h3>
                                <div style="font-size: 0.875rem; color: #c9a891;">Personalizza la tua esperienza</div>
                            </div>
                        </div>
                        
                        <!-- Servizi con design lussuoso -->
                        <div style="display: flex; flex-direction: column; gap: 12px;">
                            
                            <!-- Servizio Fotografico -->
                            <label class="huracan-service-card" style="display: flex; align-items: center; gap: 15px; padding: 16px; background: linear-gradient(135deg, rgba(26, 26, 26, 0.8), rgba(15, 15, 15, 0.9)); border: 1.5px solid rgba(80, 60, 45, 0.4); border-radius: 12px; cursor: pointer; transition: all 0.3s ease; position: relative; overflow: hidden;">
                                <input type="checkbox" class="extra-service huracan-service-checkbox" data-price="290" data-service="photo" style="width: 20px; height: 20px; accent-color: #D4AF37; cursor: pointer; z-index: 2;">
                                <div style="flex: 1; z-index: 2;">
                                    <div style="font-size: 0.95rem; font-weight: 600; color: #fff; margin-bottom: 4px; display: flex; align-items: center; gap: 8px;">
                                        <svg style="width: 18px; height: 18px; color: #D4AF37;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"/>
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"/>
                                        </svg>
                                        Servizio Fotografico Professionale
                                    </div>
                                    <div style="font-size: 0.8rem; color: #a59173;">Su una vettura a scelta</div>
                                </div>
                                <div style="font-size: 1.1rem; font-weight: 700; color: #D4AF37; z-index: 2;">${formatPrice(290)}</div>
                                <div class="service-glow" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(135deg, transparent 0%, rgba(212, 175, 55, 0.1) 50%, transparent 100%); opacity: 0; transition: opacity 0.3s ease;"></div>
                            </label>
                            
                            <!-- Video HD -->
                            <label class="huracan-service-card" style="display: flex; align-items: center; gap: 15px; padding: 16px; background: linear-gradient(135deg, rgba(26, 26, 26, 0.8), rgba(15, 15, 15, 0.9)); border: 1.5px solid rgba(80, 60, 45, 0.4); border-radius: 12px; cursor: pointer; transition: all 0.3s ease; position: relative; overflow: hidden;">
                                <input type="checkbox" class="extra-service huracan-service-checkbox" data-price="490" data-service="video-hd" style="width: 20px; height: 20px; accent-color: #D4AF37; cursor: pointer; z-index: 2;">
                                <div style="flex: 1; z-index: 2;">
                                    <div style="font-size: 0.95rem; font-weight: 600; color: #fff; margin-bottom: 4px; display: flex; align-items: center; gap: 8px;">
                                        <svg style="width: 18px; height: 18px; color: #D4AF37;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"/>
                                        </svg>
                                        Video HD Professionale
                                    </div>
                                    <div style="font-size: 0.8rem; color: #a59173;">Disponibile su entrambe le vetture</div>
                                </div>
                                <div style="font-size: 1.1rem; font-weight: 700; color: #D4AF37; z-index: 2;">${formatPrice(490)}</div>
                                <div class="service-glow" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(135deg, transparent 0%, rgba(212, 175, 55, 0.1) 50%, transparent 100%); opacity: 0; transition: opacity 0.3s ease;"></div>
                            </label>
                            
                            <!-- Video 360Â° -->
                            <label class="huracan-service-card" style="display: flex; align-items: center; gap: 15px; padding: 16px; background: linear-gradient(135deg, rgba(26, 26, 26, 0.8), rgba(15, 15, 15, 0.9)); border: 1.5px solid rgba(80, 60, 45, 0.4); border-radius: 12px; cursor: pointer; transition: all 0.3s ease; position: relative; overflow: hidden;">
                                <input type="checkbox" class="extra-service huracan-service-checkbox" data-price="690" data-service="video-360" style="width: 20px; height: 20px; accent-color: #D4AF37; cursor: pointer; z-index: 2;">
                                <div style="flex: 1; z-index: 2;">
                                    <div style="font-size: 0.95rem; font-weight: 600; color: #fff; margin-bottom: 4px; display: flex; align-items: center; gap: 8px;">
                                        <svg style="width: 18px; height: 18px; color: #D4AF37;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"/>
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                        </svg>
                                        Video 360Â° Immersivo
                                    </div>
                                    <div style="font-size: 0.8rem; color: #a59173;">Su una vettura (marchi diversi)</div>
                                </div>
                                <div style="font-size: 1.1rem; font-weight: 700; color: #D4AF37; z-index: 2;">${formatPrice(690)}</div>
                                <div class="service-glow" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(135deg, transparent 0%, rgba(212, 175, 55, 0.1) 50%, transparent 100%); opacity: 0; transition: opacity 0.3s ease;"></div>
                            </label>

                            ${comboHas4Seats ? `
                            <!-- Passeggeri Extra -->
                            <div style="border-top: 1px solid rgba(212, 175, 55, 0.2); padding-top: 16px; margin-top: 16px;">
                                <div style="font-size: 0.9rem; font-weight: 600; color: #fff; margin-bottom: 12px;">Aggiungi Passeggeri</div>
                                <div style="display: flex; gap: 12px;">
                                    <label class="huracan-passenger-option" style="display: flex; align-items: center; gap: 10px; padding: 14px 18px; background: rgba(20, 15, 12, 0.8); border: 2px solid rgba(80, 60, 45, 0.4); border-radius: 10px; cursor: pointer; flex: 1; transition: all 0.3s ease;">
                                        <input type="radio" name="huracanPassengers" value="1" class="huracan-passenger-radio" style="width: 18px; height: 18px; accent-color: #D4AF37;">
                                        <div>
                                            <div style="font-size: 0.875rem; font-weight: 600; color: #fff;">1 Passeggero</div>
                                            <div style="font-size: 0.75rem; color: #a59173;">+${formatPrice(50)}</div>
                                        </div>
                                    </label>
                                    <label class="huracan-passenger-option" style="display: flex; align-items: center; gap: 10px; padding: 14px 18px; background: rgba(20, 15, 12, 0.8); border: 2px solid rgba(80, 60, 45, 0.4); border-radius: 10px; cursor: pointer; flex: 1; transition: all 0.3s ease;">
                                        <input type="radio" name="huracanPassengers" value="2" class="huracan-passenger-radio" style="width: 18px; height: 18px; accent-color: #D4AF37;">
                                        <div>
                                            <div style="font-size: 0.875rem; font-weight: 600; color: #fff;">2 Passeggeri</div>
                                            <div style="font-size: 0.75rem; color: #a59173;">+${formatPrice(100)}</div>
                                        </div>
                                    </label>
                                </div>
                            </div>
                            ` : ''}
                            
                        </div>
                    </div>
                            
                        </div>
                    </div>
                    
                    <style>
                        .huracan-service-card:hover {
                            border-color: rgba(212, 175, 55, 0.6);
                            transform: translateY(-2px);
                            box-shadow: 0 8px 25px rgba(212, 175, 55, 0.2);
                        }
                        
                        .huracan-service-card:hover .service-glow {
                            opacity: 1;
                        }
                        
                        .huracan-service-checkbox:checked ~ * {
                            color: #D4AF37 !important;
                        }

                        .huracan-passenger-option:hover {
    border-color: rgba(212, 175, 55, 0.6);
    background: rgba(45, 24, 16, 0.4);
}

.huracan-passenger-radio:checked + div {
    color: #D4AF37 !important;
}
                    </style>
                    `;
                }
                
                const checkboxLabel = secondCarSection.querySelector('.checkbox-container div');
                if (checkboxLabel) {
                    checkboxLabel.innerHTML = labelHTML;
                }
                
                const checkbox = document.getElementById('secondCarCheckbox');
                if (checkbox) {
                    checkbox.dataset.comboPrice = additionalPrice;
                    checkbox.dataset.comboName = secondCar.title;
                }
                
                secondCarSection.style.display = 'block';
            }
        })
        .catch(err => {
            console.log('Supercar Combo non trovata, card nascosta');
            const secondCarSection = document.getElementById('secondCarSection');
            if (secondCarSection) secondCarSection.style.display = 'none';
        });
} else {
        const secondCarSection = document.getElementById('secondCarSection');
        if (secondCarSection) secondCarSection.style.display = 'none';
    }

    // âœ… 11. GESTIONE SERVIZI AGGIUNTIVI (LOGICA COMBO MIGLIORATA)
if (skuPrefix === 'SC') {
    const isHuracanSpyder = product.title && 
                            product.title.toLowerCase().includes('lamborghini') && 
                            product.title.toLowerCase().includes('huracÃ¡n spyder');
    
    // âœ… NUOVO: Rileva combo esistenti (SKU con "+")
    const isExistingCombo = product.isExistingCombo === true || product.sku.includes('+');
    
    const extraServicesSection = document.getElementById('extraServicesSection');
    const extraServicesContainer = document.getElementById('extraServicesContainer');
    
    // âœ… Mostra servizi se:
    // 1. NON Ã¨ HuracÃ¡n (servizi sempre visibili)
    // 2. Ãˆ combo esistente (servizi sempre visibili)
    const shouldShowServices = !isHuracanSpyder || isExistingCombo;
    
    if (shouldShowServices) {
        if (extraServicesSection && extraServicesContainer) {
            extraServicesContainer.innerHTML = '';
            
            // Aggiungi checkbox servizi standard
            const services = [
                { id: 'photo', label: 'Servizio Fotografico Professionale', price: 290, desc: 'Su una vettura a scelta' },
                { id: 'video-hd', label: 'Video HD Professionale', price: 490, desc: 'Disponibile su entrambe le vetture' },
                { id: 'video-360', label: 'Video 360Â° Immersivo', price: 690, desc: 'Su una vettura (marchi diversi)' }
            ];
            
            services.forEach(service => {
                const checkbox = document.createElement('label');
                checkbox.className = 'checkbox-container';
                checkbox.innerHTML = `
                   <input type="checkbox" class="extra-service" data-price="${service.price}" data-service="${service.id}">
                   <div>
                      <div class="font-semibold mb-1">${service.label}</div>
                      <div class="text-sm" style="color: #a59173;">+${formatPrice(service.price)} - ${service.desc}</div>
                   </div>
                `;
                extraServicesContainer.appendChild(checkbox);
            });
            
            // âœ… Aggiungi passeggeri se 4 posti
            if (product.numPosti >= 4) {
                const maxExtraPassengers = product.numPosti - 2;
                const pricePerPassenger = 50;
                
                const passengerContainer = document.createElement('div');
                passengerContainer.className = 'checkbox-container';
                passengerContainer.style.display = 'block';
                passengerContainer.innerHTML = `
                    <div>
                        <div class="font-semibold mb-3">Passeggeri Extra</div>
                        <div style="display: flex; gap: 15px; margin-top: 15px;">
                            <label style="display: flex; align-items: center; gap: 10px; cursor: pointer; padding: 12px 20px; background: rgba(212, 175, 55, 0.08); border: 2px solid rgba(212, 175, 55, 0.3); border-radius: 10px; transition: all 0.3s ease; flex: 1;">
                                <input type="radio" name="extraPassengers" value="1" class="passenger-radio" style="width: 18px; height: 18px; accent-color: #D4AF37; cursor: pointer;">
                                <div>
                                    <div style="font-size: 14px; font-weight: 600; color: #fff;">1 Passeggero</div>
                                    <div style="font-size: 12px; color: #a59173;">+${formatPrice(pricePerPassenger)}</div>
                                </div>
                            </label>
                            <label style="display: flex; align-items: center; gap: 10px; cursor: pointer; padding: 12px 20px; background: rgba(212, 175, 55, 0.08); border: 2px solid rgba(212, 175, 55, 0.3); border-radius: 10px; transition: all 0.3s ease; flex: 1;">
                                <input type="radio" name="extraPassengers" value="2" class="passenger-radio" style="width: 18px; height: 18px; accent-color: #D4AF37; cursor: pointer;">
                                <div>
                                    <div style="font-size: 14px; font-weight: 600; color: #fff;">${maxExtraPassengers} Passeggeri</div>
                                    <div style="font-size: 12px; color: #a59173;">+${formatPrice(pricePerPassenger * maxExtraPassengers)}</div>
                                </div>
                            </label>
                        </div>
                    </div>
                `;
                extraServicesContainer.appendChild(passengerContainer);
            }
            
            extraServicesSection.style.display = 'block';
            
            // âœ… LOG per debug
            console.log(`âœ… Servizi mostrati per ${isExistingCombo ? 'COMBO ESISTENTE' : 'supercar singola'}`);
        }
    } else {
        // Nasconde servizi (solo per HuracÃ¡n NON combo)
        if (extraServicesSection) extraServicesSection.style.display = 'none';
    }
} else {
    const extraServicesSection = document.getElementById('extraServicesSection');
    if (extraServicesSection) extraServicesSection.style.display = 'none';
}

    // âœ… 12. AGGIORNA NOME PRODOTTO NEL RIEPILOGO (SIDEBAR)
    const summaryTitle = document.querySelector('.summary-product-title');
    if (summaryTitle) {
        summaryTitle.textContent = product.title;
    }

    // âœ… 13. POLITICHE DINAMICHE
    const policiesCard = document.querySelector('.policies-card');
    if (policiesCard && product.politiche && Array.isArray(product.politiche)) {
        const policiesBody = policiesCard.querySelector('.space-y-3');
        if (policiesBody) {
            policiesBody.innerHTML = '';
            
            product.politiche.forEach(policy => {
                const policyDiv = document.createElement('div');
                policyDiv.innerHTML = `
                    <strong style="color: #f5f5f0;">${policy.label}:</strong> 
                    ${policy.description}
                `;
                policiesBody.appendChild(policyDiv);
            });
        }
    }

        // ========================================
// âœ… GESTIONE STATI ESPERIENZE (BOOKING.HTML)
// ========================================
const isExperience = skuPrefix === 'EX';

if (isExperience) {
  const stato = product.stato || 'Disponibile';
  
  // CASO 1: Esperienza SCADUTA (giÃ  bloccata in index, ma failsafe)
  if (product.isScaduta) {
    showValidationError('Questa esperienza Ã¨ conclusa e non Ã¨ piÃ¹ prenotabile.', 'expired');
    setTimeout(() => window.history.back(), 2000);
    return;
  }
  
  // CASO 2: Esperienza PRESTO DISPONIBILE / IN ARRIVO
  if (stato === 'Presto Disponibile' || stato === 'In Arrivo') {
    disableBookingForComingSoon();
  }
}

    // âœ… 14. GESTIONE PREZZO SU RICHIESTA PER IMMOBILI
    const isPriceOnRequest = !config.showDynamicPrice && config.fixedPrice === 'â‚¬ â€”';
    if (isPriceOnRequest) {
        const distanceSection = document.querySelector('.glass-card:has(#distanceOptions)');
        if (distanceSection) distanceSection.style.display = 'none';

        const secondCarSection = document.getElementById('secondCarSection');
        if (secondCarSection) secondCarSection.style.display = 'none';
    }

    // âœ… Resetta distance a N/A per immobili
    bookingData.distance = 'N/A';

    // âœ… 15. GESTIONE ESPERIENZE (EX) - Nascondi sezioni non applicabili
if (skuPrefix === 'EX') {
    const distanceSection = document.querySelector('.glass-card:has(#distanceOptions)');
    if (distanceSection) distanceSection.style.display = 'none';

    const secondCarSection = document.getElementById('secondCarSection');
    if (secondCarSection) secondCarSection.style.display = 'none';

    const extraServicesSection = document.getElementById('extraServicesSection');
    if (extraServicesSection) extraServicesSection.style.display = 'none';

    // âœ… IMPORTANTE: Setta distance a N/A per esperienze
    bookingData.distance = 'N/A';
    
    // âœ… Setta prezzo base da prodotto
    bookingData.basePrice = product.price || 0;
    
    // âœ… NUOVO: Auto-setta data e orario se presenti nel prodotto
    if (product.data_esperienza) {
        try {
            const expDate = new Date(product.data_esperienza);
            if (!isNaN(expDate.getTime())) {
                bookingData.selectedDate = expDate;
                console.log(`âœ… Data esperienza auto-impostata: ${expDate.toISOString()}`);
            }
        } catch (e) {
            console.warn('âš ï¸ Data esperienza non valida:', product.data_esperienza);
        }
    }
}

    // âœ… 16. GESTIONE SUPERCAR (SC) - Usa prezzo base prodotto
    if (skuPrefix === 'SC') {
        bookingData.basePrice = product.price || 0;
    }

    updatePriceSummary();
}

    /**
 * ğŸ’° Aggiorna tutti i prezzi per la lingua corrente
 */
function updateAllPricesForLanguage() {
    const i18n = window.i18nPDP();
    if (!i18n || !bookingData.productData) return;
    
    const config = bookingData.productData.typeConfig;
    const product = bookingData.productData;
    
    // 1. Aggiorna label prezzo principale (con chiave dinamica)
const priceLabelEl = document.querySelector('.price-label');
if (priceLabelEl && config) {
    let priceLabelKey = 'booking_price_label';
    if (config.type === 'supercar') {
        priceLabelKey = 'booking_price_sc_label';
    } else if (config.type === 'immobili') {
        priceLabelKey = 'booking_price_pr_label';
    } else if (config.type === 'esperienze') {
        priceLabelKey = 'booking_price_ex_label';
    }
    
    priceLabelEl.textContent = i18n.t(priceLabelKey);
}
    
    // 2. Aggiorna valore prezzo con formattazione corretta
    const priceEl = document.querySelector('.product-price');
    if (priceEl && product.price) {
        priceEl.textContent = i18n.formatPrice(product.price, 'EUR');
    }
    
    // 3. Aggiorna prezzi nella griglia distanze
    document.querySelectorAll('.distance-option').forEach(option => {
        const price = parseInt(option.dataset.price);
        const priceSpan = option.querySelector('.text-xl.font-semibold');
        if (priceSpan && price) {
            priceSpan.textContent = i18n.formatPrice(price, 'EUR');
        }
    });
    
    // 4. Aggiorna riepilogo prezzi sidebar
    updatePriceSummary();
}

    // ========================================
    // LOADER UTILITIES
    // ========================================
    function showPageLoader() {
    document.body.style.overflow = 'hidden';
    document.body.insertAdjacentHTML('beforeend', `
        <div id="pageLoader" style="
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; 
            background: linear-gradient(135deg, #0a0a0a 0%, #1a1412 50%, #0a0a0a 100%);
            z-index: 99999; display: flex; align-items: center; justify-content: center;
            animation: fadeIn 0.3s ease;
        ">
            <div style="text-align: center; position: relative; z-index: 2;">
                
                <!-- Logo Animato -->
                <div style="
                    width: 140px; height: 140px; margin: 0 auto 40px;
                    position: relative;
                ">
                    <!-- Ring Esterno Rotante -->
                    <div style="
                        position: absolute; inset: 0;
                        border: 3px solid transparent;
                        border-top-color: #D4AF37;
                        border-right-color: rgba(212, 175, 55, 0.3);
                        border-radius: 50%;
                        animation: spin 2s linear infinite;
                    "></div>
                    
                    <!-- Ring Interno Rotante (opposto) -->
                    <div style="
                        position: absolute; inset: 10px;
                        border: 2px solid transparent;
                        border-bottom-color: #FFD700;
                        border-left-color: rgba(255, 215, 0, 0.3);
                        border-radius: 50%;
                        animation: spin 3s linear infinite reverse;
                    "></div>
                    
                    <!-- Glow Effect -->
                    <div style="
                        position: absolute; inset: 20px;
                        background: radial-gradient(circle, rgba(212, 175, 55, 0.2), transparent);
                        border-radius: 50%;
                        animation: pulse 2s ease-in-out infinite;
                    "></div>
                    
                    <!-- Icona Centrale -->
                    <div style="
                        position: absolute; inset: 0;
                        display: flex; align-items: center; justify-content: center;
                    ">
                        <svg width="60" height="60" viewBox="0 0 24 24" fill="none" stroke="#D4AF37">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" 
                                  d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5" 
                                  style="animation: fadeInOut 2s ease-in-out infinite;"/>
                        </svg>
                    </div>
                </div>
                
                <!-- Testo Elegante -->
                <h2 style="
                    color: #f5f5f0; font-size: 24px; font-weight: 600; 
                    letter-spacing: 2px; margin-bottom: 12px;
                    font-family: 'Playfair Display', serif;
                    animation: slideUp 0.6s ease-out;
                ">Preparazione Esperienza</h2>
                
                <p style="
                    color: #c9a891; font-size: 14px; letter-spacing: 1px;
                    opacity: 0.9; animation: slideUp 0.8s ease-out;
                ">Stiamo personalizzando ogni dettaglio per te</p>
                
                <!-- Progress Bar Premium -->
                <div style="
                    width: 280px; height: 3px; 
                    background: rgba(212, 175, 55, 0.1);
                    border-radius: 10px; margin: 32px auto 0;
                    overflow: hidden; position: relative;
                ">
                    <div style="
                        height: 100%; width: 60%;
                        background: linear-gradient(90deg, 
                            transparent 0%, 
                            #D4AF37 20%, 
                            #FFD700 50%, 
                            #D4AF37 80%, 
                            transparent 100%
                        );
                        background-size: 200% 100%;
                        animation: shimmer 2s linear infinite;
                        box-shadow: 0 0 20px rgba(212, 175, 55, 0.6);
                    "></div>
                </div>
                
                <!-- Particelle Decorative -->
                <div style="
                    position: absolute; top: 50%; left: 50%;
                    transform: translate(-50%, -50%);
                    width: 400px; height: 400px;
                    pointer-events: none;
                ">
                    <div class="particle" style="
                        position: absolute; width: 4px; height: 4px;
                        background: #D4AF37; border-radius: 50%;
                        top: 20%; left: 10%;
                        animation: float 4s ease-in-out infinite;
                    "></div>
                    <div class="particle" style="
                        position: absolute; width: 3px; height: 3px;
                        background: #FFD700; border-radius: 50%;
                        top: 70%; left: 80%;
                        animation: float 5s ease-in-out infinite 1s;
                    "></div>
                    <div class="particle" style="
                        position: absolute; width: 5px; height: 5px;
                        background: rgba(212, 175, 55, 0.6); border-radius: 50%;
                        top: 40%; left: 85%;
                        animation: float 6s ease-in-out infinite 2s;
                    "></div>
                </div>
            </div>
        </div>
        
        <style>
            @keyframes spin {
                to { transform: rotate(360deg); }
            }
            
            @keyframes pulse {
                0%, 100% { opacity: 0.4; transform: scale(1); }
                50% { opacity: 0.8; transform: scale(1.1); }
            }
            
            @keyframes fadeInOut {
                0%, 100% { opacity: 0.4; }
                50% { opacity: 1; }
            }
            
            @keyframes shimmer {
                0% { background-position: -200% center; }
                100% { background-position: 200% center; }
            }
            
            @keyframes slideUp {
                from { opacity: 0; transform: translateY(20px); }
                to { opacity: 1; transform: translateY(0); }
            }
            
            @keyframes float {
                0%, 100% { transform: translateY(0) translateX(0); opacity: 0; }
                10% { opacity: 1; }
                50% { transform: translateY(-30px) translateX(10px); opacity: 0.8; }
                90% { opacity: 1; }
            }
            
            @keyframes fadeIn {
                from { opacity: 0; }
                to { opacity: 1; }
            }
        </style>
    `);
}

    function hidePageLoader() {
        const loader = document.getElementById('pageLoader');
        if (loader) {
            loader.style.opacity = '0';
            loader.style.transition = 'opacity 0.3s';
            setTimeout(() => loader.remove(), 300);
            document.body.style.overflow = '';
        }
    }

    /**
 * Determina configurazione chilometraggio in base a SKU e Nome Prodotto
 * âœ… LOGICA CORRETTA:
 * - Combo specifiche (California/Portofino/488 + HuracÃ¡n) â†’ km personalizzati (90)
 * - Altre combo â†’ km default (70)
 * - Singole auto â†’ configurazione specifica o default
 */
function getDistanceConfigForProduct(product) {
    const sku = product.sku.toUpperCase();
    const title = product.title.toLowerCase();
    
    // ğŸ”¥ CASO 1: COMBO DIRETTE (SKU con "+") - PRIORITÃ€ MASSIMA
    const isCombo = sku.includes('+');
    
    if (isCombo) {
        // Normalizza SKU per check (rimuovi spazi)
        const normalizedSku = sku.replace(/\s+/g, '');
        
        // âœ… Verifica se Ã¨ una delle 3 combo specifiche in COMBO_PRICING
        const hasCustomPricing = Object.keys(COMBO_PRICING).some(key => {
            const normalizedKey = key.replace(/\s+/g, '');
            return normalizedKey === normalizedSku;
        });
        
        if (hasCustomPricing) {
            // ğŸ¯ COMBO SPECIALI (California/Portofino/488 + HuracÃ¡n) â†’ km personalizzati
            console.log(`ğŸ¯ Combo speciale rilevata: ${sku}, uso km personalizzati (90)`);
            const i18n = window.i18nPDP();
            return {
                options: [
                    { value: 10, unit: 'km', label: i18n.t('booking_distance_rapid') },
                    { value: 20, unit: 'km', label: i18n.t('booking_distance_popular') },
                    { value: 30, unit: 'km', label: i18n.t('booking_distance_complete') },
                    { value: 60, unit: 'km', label: i18n.t('booking_distance_extended') },
                    { value: 90, unit: 'km', label: i18n.t('booking_distance_long') },
                    { value: 120, unit: 'km', label: i18n.t('booking_distance_ultimate') }
                ]
            };
        } else {
            // ğŸ”— ALTRE COMBO â†’ km default
            console.log(`ğŸ”— Combo standard rilevata: ${sku}, uso km default (70)`);
            return {
                options: [
                    { value: 10, unit: 'km', label: i18n.t('booking_distance_rapid') },
                    { value: 20, unit: 'km', label: i18n.t('booking_distance_popular') },
                    { value: 30, unit: 'km', label: i18n.t('booking_distance_complete') },
                    { value: 60, unit: 'km', label: i18n.t('booking_distance_extended') },
                    { value: 70, unit: 'km', label: 'Avventura lunga' },
                    { value: 120, unit: 'km', label: i18n.t('booking_distance_ultimate') }
                ]
            };
        }
    }
    
    // ğŸš— CASO 2: Ferrari 458 Spider (SOLO SE NON Ãˆ COMBO)
    if (title.includes('ferrari 458 spider')) {
        console.log('ğŸï¸ Ferrari 458 Spider, uso km custom');
        return {
            options: [
                { value: 9, unit: 'km', label: 'Esperienza rapida' },
                { value: 16, unit: 'km', label: 'PiÃ¹ popolare' },
                { value: 32, unit: 'km', label: 'Esperienza completa' },
                { value: 65, unit: 'km', label: 'Tour esteso' },
                { value: 80, unit: 'km', label: 'Avventura lunga' },
                { value: 100, unit: 'km', label: 'Esperienza definitiva' }
            ]
        };
    }
    
    // ğŸš— CASO 3: McLaren 720s Performance (SOLO SE NON Ãˆ COMBO)
    if (title.includes('mclaren 720s')) {
        console.log('ğŸï¸ McLaren 720s, uso minuti');
        return {
            options: [
                { value: 10, unit: 'min', label: 'Esperienza rapida' },
                { value: 20, unit: 'min', label: 'PiÃ¹ popolare' },
                { value: 30, unit: 'min', label: 'Esperienza completa' },
                { value: 60, unit: 'min', label: 'Tour esteso' },
                { value: 90, unit: 'min', label: 'Avventura lunga' },
                { value: 120, unit: 'min', label: 'Esperienza definitiva' }
            ]
        };
    }
    
    // ğŸ”¹ CASO 4: Default (km standard con 70)
    console.log('ğŸ“ Configurazione default, uso km standard (70)');
    return {
        options: [
            { value: 10, unit: 'km', label: i18n.t('booking_distance_rapid') },
            { value: 20, unit: 'km', label: i18n.t('booking_distance_popular') },
            { value: 30, unit: 'km', label: i18n.t('booking_distance_complete') },
            { value: 60, unit: 'km', label: i18n.t('booking_distance_extended') },
            { value: 70, unit: 'km', label: 'Avventura lunga' },
            { value: 120, unit: 'km', label: i18n.t('booking_distance_ultimate') }
        ]
    };
}

    // ========================================
    // INIZIALIZZAZIONE COMPONENTI
    // ========================================
    function initializeComponents(product) {
    // âœ… ATTENDI CHE i18n SIA PRONTO
    const i18n = window.i18nPDP();
    if (!i18n) {
        console.error('âŒ Sistema i18n non inizializzato');
        return;
    }
    
    const skuPrefix = product.sku.split('-')[0].toUpperCase();
    
    // Distance selection (se non giÃ  gestito dinamicamente)
    if (skuPrefix !== 'SC' || !product.chilometraggioPrices) {
        document.querySelectorAll('.distance-option').forEach(option => {
            option.addEventListener('click', function() {
                document.querySelectorAll('.distance-option').forEach(opt => opt.classList.remove('selected'));
                this.classList.add('selected');
                
                bookingData.distance = this.dataset.km;
                
                if (skuPrefix !== 'SC' && skuPrefix !== 'EX') {
                    bookingData.basePrice = parseInt(this.dataset.price);
                }
                
                updatePriceSummary();
            });
        });
        
        // Auto-select first option
        const firstOption = document.querySelector('.distance-option');
        if (firstOption && skuPrefix !== 'EX' && skuPrefix !== 'SC') {
            firstOption.classList.add('selected');
            bookingData.distance = firstOption.dataset.km;
            bookingData.basePrice = parseInt(firstOption.dataset.price);
            updatePriceSummary();
        }
    }

        // Second car checkbox
const secondCarCheckbox = document.getElementById('secondCarCheckbox');
const isHuracanSpyder = product.title && 
                        product.title.toLowerCase().includes('lamborghini') && 
                        product.title.toLowerCase().includes('huracÃ¡n spyder');

if (skuPrefix === 'SC') {
    const isHuracanSpyder = product.title && 
                            product.title.toLowerCase().includes('lamborghini') && 
                            product.title.toLowerCase().includes('huracÃ¡n spyder');
    
    if (isHuracanSpyder) {
        // âœ… HuracÃ¡n: toggle servizi nella card combo
        if (secondCarCheckbox) {
    secondCarCheckbox.addEventListener('change', function() {
        bookingData.secondCar = this.checked;
        const comboPrice = parseInt(this.dataset.comboPrice) || 1490;
        const comboName = this.dataset.comboName || 'Seconda Supercar';
        
        // â­ APPLICA/RIPRISTINA PREZZI COMBO IN TEMPO REALE
        if (this.checked) {
            if (hasCustomComboPricing()) {
                console.log('ğŸ¯ Combo speciale rilevata, aggiornamento prezzi immediato');
                applyComboDistancePricing();
            }
        } else {
            // Ripristina prezzi originali
            restoreOriginalDistancePricing();
        }
        
        // Toggle visibilitÃ  servizi HuracÃƒÂ¡n
        const huracanServices = document.getElementById('huracanExtraServices');
        if (huracanServices) {
            huracanServices.style.display = this.checked ? 'block' : 'none';

            if (this.checked) {
                setTimeout(() => {
                    document.querySelectorAll('.huracan-service-checkbox').forEach(cb => {
                        const newCb = cb.cloneNode(true);
                        cb.parentNode.replaceChild(newCb, cb);
                        
                        newCb.addEventListener('change', function() {
                            const price = parseInt(this.dataset.price);
                            const service = this.dataset.service;
                            
                            if (this.checked) {
                                if (!bookingData.extraServices.find(s => s.service === service)) {
                                    bookingData.extraServices.push({ service, price });
                                }
                            } else {
                                bookingData.extraServices = bookingData.extraServices.filter(s => s.service !== service);
                            }
                            
                            updatePriceSummary();
                        });
                    });

                    // âœ… NUOVO: Clona anche i radio per rimuovere listener duplicati
document.querySelectorAll('.huracan-passenger-radio').forEach(radio => {
  // Clona il radio e il suo parent label per evitare conflitti
  const label = radio.closest('.huracan-passenger-option');
  if (!label) return;
  
  const newLabel = label.cloneNode(true);
  label.parentNode.replaceChild(newLabel, label);
  
  const newRadio = newLabel.querySelector('.huracan-passenger-radio');
  
  newRadio.addEventListener('click', function(e) {
    const quantity = parseInt(this.value);
    const pricePerPassenger = 50;
    const totalPrice = pricePerPassenger * quantity;
    
    // âœ… NUOVO: Se giÃ  selezionato, deseleziona
    if (this.dataset.wasChecked === 'true') {
      this.checked = false;
      this.dataset.wasChecked = 'false';
      
      bookingData.extraServices = bookingData.extraServices.filter(s => s.service !== 'extra-passengers');
      
      document.querySelectorAll('.huracan-passenger-option').forEach(lbl => {
        lbl.style.borderColor = 'rgba(80, 60, 45, 0.4)';
        lbl.style.background = 'rgba(20, 15, 12, 0.8)';
      });
      
      updatePriceSummary();
      return;
    }
    
    // Rimuovi precedenti
    bookingData.extraServices = bookingData.extraServices.filter(s => s.service !== 'extra-passengers');
    
    // Aggiungi nuovo
    bookingData.extraServices.push({ 
      service: 'extra-passengers', 
      price: totalPrice,
      quantity: quantity
    });
    
    // Marca selezione
    document.querySelectorAll('.huracan-passenger-radio').forEach(r => {
      r.dataset.wasChecked = 'false';
    });
    this.dataset.wasChecked = 'true';
    
    // Reset stili
    document.querySelectorAll('.huracan-passenger-option').forEach(lbl => {
      lbl.style.borderColor = 'rgba(80, 60, 45, 0.4)';
      lbl.style.background = 'rgba(20, 15, 12, 0.8)';
    });
    
    const selectedLabel = this.closest('.huracan-passenger-option');
    if (selectedLabel) {
      selectedLabel.style.borderColor = '#D4AF37';
      selectedLabel.style.background = 'rgba(212, 175, 55, 0.12)';
    }
    
    updatePriceSummary();
  });
});
                }, 100);
            }
            
            if (this.checked) {
                setTimeout(() => {
                    huracanServices.style.animation = 'fadeIn 0.4s ease';
                }, 50);
            }
            
            if (!this.checked) {
                huracanServices.querySelectorAll('.huracan-service-checkbox').forEach(cb => {
                    cb.checked = false;
                });
                bookingData.extraServices = [];
            }
        }
        
        // Aggiorna riepilogo
        document.getElementById('secondCarPrice').classList.toggle('hidden', !this.checked);
        
        const secondCarNameSpan = document.getElementById('secondCarName');
        const secondCarPriceSpan = document.getElementById('secondCarPriceAmount');
        
        if (secondCarNameSpan) secondCarNameSpan.textContent = comboName;
        if (secondCarPriceSpan) secondCarPriceSpan.textContent = formatPrice(comboPrice);
        
        updatePriceSummary();
    });
}
    } else {
    // âœ… Altre supercar: comportamento standard CON gestione prezzi combo
    if (secondCarCheckbox) {
        secondCarCheckbox.addEventListener('change', function() {
            bookingData.secondCar = this.checked;
            const comboPrice = parseInt(this.dataset.comboPrice) || 1490;
            const comboName = this.dataset.comboName || 'Seconda Supercar';
            
            // â­ APPLICA/RIPRISTINA PREZZI COMBO IN TEMPO REALE
            if (this.checked) {
                if (hasCustomComboPricing()) {
                    console.log('ğŸ¯ Combo speciale rilevata, aggiornamento prezzi immediato');
                    applyComboDistancePricing();
                }
            } else {
                // Ripristina prezzi originali quando si deseleziona
                restoreOriginalDistancePricing();
            }
            
            document.getElementById('secondCarPrice').classList.toggle('hidden', !this.checked);
            
            const secondCarNameSpan = document.getElementById('secondCarName');
            const secondCarPriceSpan = document.getElementById('secondCarPriceAmount');
            
            if (secondCarNameSpan) secondCarNameSpan.textContent = comboName;
            if (secondCarPriceSpan) secondCarPriceSpan.textContent = formatPrice(comboPrice);
            
            updatePriceSummary();
        });
    }
}
}

        // Extra services
        document.querySelectorAll('.extra-service').forEach(checkbox => {
            checkbox.addEventListener('change', function() {
                const price = parseInt(this.dataset.price);
                const service = this.dataset.service;
                
                if (this.checked) {
                    bookingData.extraServices.push({ service, price });
                } else {
                    bookingData.extraServices = bookingData.extraServices.filter(s => s.service !== service);
                }
                
                updatePriceSummary();
            });
        });

        // âœ… Re-bind listener per servizi HuracÃ¡n (TUTTI i checkbox con classe .extra-service)
// Questo gestisce sia servizi standard che HuracÃ¡n
setTimeout(() => {
    const allServiceCheckboxes = document.querySelectorAll('.extra-service');
    
    allServiceCheckboxes.forEach(checkbox => {
        // Rimuovi listener duplicati clonando elemento
        const newCheckbox = checkbox.cloneNode(true);
        checkbox.parentNode.replaceChild(newCheckbox, checkbox);
        
        // Aggiungi listener pulito
        newCheckbox.addEventListener('change', function() {
            const price = parseInt(this.dataset.price);
            const service = this.dataset.service;
            
            if (this.checked) {
                // Aggiungi servizio se non presente
                if (!bookingData.extraServices.find(s => s.service === service)) {
                    bookingData.extraServices.push({ service, price });
                }
            } else {
                // Rimuovi servizio
                bookingData.extraServices = bookingData.extraServices.filter(s => s.service !== service);
            }
            
            console.log('ğŸ“Š Servizi attivi:', bookingData.extraServices); // Debug
            updatePriceSummary();
        });
    });
}, 600); // Attendi rendering completo

        // âœ… Gestione Passeggeri Extra (radio buttons)
        document.querySelectorAll('.passenger-radio').forEach(radio => {
    radio.addEventListener('click', function(e) {
        const quantity = parseInt(this.value);
        const pricePerPassenger = 50;
        const totalPrice = pricePerPassenger * quantity;
        
        // âœ… NUOVO: Se giÃ  selezionato, deseleziona
        if (this.dataset.wasChecked === 'true') {
            this.checked = false;
            this.dataset.wasChecked = 'false';
            
            // Rimuovi servizio passeggeri
            bookingData.extraServices = bookingData.extraServices.filter(s => s.service !== 'extra-passengers');
            
            // Reset stili tutti i label
            document.querySelectorAll('label:has(.passenger-radio)').forEach(lbl => {
                lbl.style.borderColor = 'rgba(212, 175, 55, 0.3)';
                lbl.style.background = 'rgba(212, 175, 55, 0.08)';
            });
            
            updatePriceSummary();
            return;
        }
        
        // Rimuovi eventuali servizi passeggeri precedenti
        bookingData.extraServices = bookingData.extraServices.filter(s => s.service !== 'extra-passengers');
        
        // Aggiungi nuovo servizio
        bookingData.extraServices.push({ 
            service: 'extra-passengers', 
            price: totalPrice,
            quantity: quantity
        });
        
        // Marca questo come selezionato, gli altri no
        document.querySelectorAll('.passenger-radio').forEach(r => {
            r.dataset.wasChecked = 'false';
        });
        this.dataset.wasChecked = 'true';
        
        // âœ… Reset stili tutti i label
        document.querySelectorAll('label:has(.passenger-radio)').forEach(lbl => {
            lbl.style.borderColor = 'rgba(212, 175, 55, 0.3)';
            lbl.style.background = 'rgba(212, 175, 55, 0.08)';
        });
        
        // Evidenzia label selezionato
        const selectedLabel = this.closest('label');
        if (selectedLabel) {
            selectedLabel.style.borderColor = '#D4AF37';
            selectedLabel.style.background = 'rgba(212, 175, 55, 0.18)';
        }
        
        updatePriceSummary();
    });
});

// âœ… Stile hover per radio passengers
document.querySelectorAll('label:has(.passenger-radio)').forEach(label => {
    label.addEventListener('mouseenter', function() {
        this.style.borderColor = '#D4AF37';
        this.style.background = 'rgba(212, 175, 55, 0.15)';
    });
    label.addEventListener('mouseleave', function() {
        const radio = this.querySelector('.passenger-radio');
        if (!radio.checked) {
            this.style.borderColor = 'rgba(212, 175, 55, 0.3)';
            this.style.background = 'rgba(212, 175, 55, 0.08)';
        }
    });
});

        // Auto-lowercase email input
const emailInput = document.querySelector('input[type="email"]');
if (emailInput) {
    emailInput.addEventListener('input', function(e) {
        const start = this.selectionStart;
        const end = this.selectionEnd;
        
        // Converti in minuscolo
        this.value = this.value.toLowerCase();
        
        // Ripristina posizione cursore
        this.setSelectionRange(start, end);
    });
    
    // Anche su paste
    emailInput.addEventListener('paste', function(e) {
        e.preventDefault();
        const pastedText = (e.clipboardData || window.clipboardData).getData('text');
        const start = this.selectionStart;
        
        // Inserisci testo in minuscolo
        const currentValue = this.value;
        this.value = currentValue.substring(0, start) + 
                     pastedText.toLowerCase() + 
                     currentValue.substring(this.selectionEnd);
        
        // Posiziona cursore
        this.selectionStart = this.selectionEnd = start + pastedText.length;
    });
}
        
        // Initialize phone
        initPhoneSelector();
        
        // Initialize calendar
        initCalendar();

        // âœ… BLOCCO DATA/ORARIO PER ESPERIENZE (SKU "EX")
        handleExperienceDateLock(product);

        finalizeLoaderHide();       

document.addEventListener('languageChanged', function(e) {
    const summaryTitle = document.querySelector('.summary-product-title');
    if (summaryTitle && bookingData.productData) {
        // Il nome prodotto Ã¨ giÃ  nella lingua corretta dal backend
        summaryTitle.textContent = bookingData.productData.title;
    }
});
    }

        function finalizeLoaderHide() {
    const skuPrefix = bookingData.productData?.sku.split('-')[0].toUpperCase();
    
    // Per Supercar, attendi caricamento card combo
    if (skuPrefix === 'SC') {
        const checkComboCard = setInterval(() => {
            const comboSection = document.getElementById('secondCarSection');
            const comboCheckbox = document.getElementById('secondCarCheckbox');
            
            // Se la card combo Ã¨ stata processata (visibile o nascosta)
            if (comboSection && comboSection.style.display !== '') {
                clearInterval(checkComboCard);
                hidePageLoader();
            }
        }, 100);
        
        // Timeout sicurezza (max 3 secondi)
        setTimeout(() => {
            clearInterval(checkComboCard);
            hidePageLoader();
        }, 3000);
    } else {
        // Per altri prodotti, nascondi subito
        hidePageLoader();
    }
}

        // ========================================
// AUTO-CAPITALIZE NOME E COGNOME
// ========================================
document.addEventListener('DOMContentLoaded', () => {
    const firstNameInput = document.querySelector('input[placeholder="Il tuo nome"]');
    const lastNameInput = document.querySelector('input[placeholder="Il tuo cognome"]');
    
    [firstNameInput, lastNameInput].forEach(input => {
        if (input) {
            input.addEventListener('input', function(e) {
                const start = this.selectionStart;
                const end = this.selectionEnd;
                
                // Capitalizza prima lettera
                if (this.value.length > 0) {
                    this.value = this.value.charAt(0).toUpperCase() + this.value.slice(1);
                }
                
                // Ripristina posizione cursore
                this.setSelectionRange(start, end);
            });
        }
    });
});

        /**
 * Inizializza selezione distanza per prodotti con chilometraggio dinamico
 */
function initDistanceSelection(product) {
    const skuPrefix = product.sku.split('-')[0].toUpperCase();
    
    document.querySelectorAll('.distance-option').forEach(option => {
        option.addEventListener('click', function() {
            document.querySelectorAll('.distance-option').forEach(opt => opt.classList.remove('selected'));
            this.classList.add('selected');
            
            // âœ… SALVA ANCHE L'UNITÃ€ DI MISURA
            const value = this.dataset.km;
            const unit = this.dataset.unit || 'km'; // Default: km
            
            // Formato: "10 km" o "20 min"
            bookingData.distance = `${value} ${unit}`;
            
            // Per SC, aggiorna il prezzo base con quello selezionato
            if (skuPrefix === 'SC' || skuPrefix === 'EX') {
                bookingData.basePrice = parseInt(this.dataset.price);
            }
            
            updatePriceSummary();
        });
    });
    
    // Auto-select prima opzione se presente
    const firstOption = document.querySelector('.distance-option');
    if (firstOption) {
        firstOption.classList.add('selected');
        
        const value = firstOption.dataset.km;
        const unit = firstOption.dataset.unit || 'km';
        bookingData.distance = `${value} ${unit}`;
        
        if (skuPrefix === 'SC' || skuPrefix === 'EX') {
            bookingData.basePrice = parseInt(firstOption.dataset.price);
        }
        
        updatePriceSummary();
    }
}

    // ========================================
    // PRICE SUMMARY UPDATE
    // ========================================
    function updatePriceSummary() {
        const isPriceOnRequest = bookingData.productData?.typeConfig && 
                                 !bookingData.productData.typeConfig.showDynamicPrice &&
                                  bookingData.productData.typeConfig.fixedPrice === 'â‚¬ â€”';
    
        if (isPriceOnRequest) {
            // Prezzo su richiesta per IMMOBILI
            document.getElementById('basePrice').textContent = 'â‚¬ â€”';
            document.getElementById('totalPrice').textContent = 'â‚¬ â€”';
            return; // Esce senza calcolare totali
        }
    
        // ASSICURA CHE IL PREZZO BASE SIA SEMPRE VALORIZZATO
        // Per SC ed EX, usa sempre il prezzo dal prodotto se non impostato
        if (!bookingData.basePrice && bookingData.productData) {
            const skuPrefix = bookingData.productData.sku.split('-')[0].toUpperCase();
            if (skuPrefix === 'SC' || skuPrefix === 'EX') {
                bookingData.basePrice = bookingData.productData.price || 0;
            }
        }
    
        let total = bookingData.basePrice;
    
        document.getElementById('basePrice').textContent = formatPrice(bookingData.basePrice);
        
        if (bookingData.secondCar) {
    const checkbox = document.getElementById('secondCarCheckbox');
    const comboPrice = checkbox ? parseInt(checkbox.dataset.comboPrice) || 1490 : 1490;
    total += comboPrice;
}
        
        const extraServicesDiv = document.getElementById('extraServicesPrice');
        extraServicesDiv.innerHTML = '';
        
        bookingData.extraServices.forEach(service => {
    total += service.price;
    const serviceNames = {
        'photo': 'Servizio Fotografico',
        'video-hd': 'Video HD',
        'video-360': 'Video 360Â°',
        'extra-passengers': 'Passeggeri Extra'
    };
    
    let serviceName = serviceNames[service.service];
    
    // âœ… Aggiungi quantitÃ  per passeggeri
    if (service.service === 'extra-passengers' && service.quantity) {
        serviceName += ` (${service.quantity})`;
    }
    
    const div = document.createElement('div');
    div.className = 'flex justify-between';
    div.innerHTML = `
        <span class="text-sm" style="color: #c9a891;">${serviceName}</span>
        <span class="font-semibold text-sm">${formatPrice(service.price)}</span>
    `;
    extraServicesDiv.appendChild(div);
});
        
        bookingData.total = total;
        document.getElementById('totalPrice').textContent = formatPrice(total);
    }

        // âœ… GESTIONE RITORNO DA CHECKOUT STRIPE
window.addEventListener('pageshow', function(event) {
    // Se l'utente torna indietro dal checkout
    if (event.persisted || (window.performance && window.performance.navigation.type === 2)) {
        hideBookingLoader();
        enableForm();
        
        console.log('ğŸ‘ˆ Utente tornato dal checkout');
    }
});

// Rileva quando la pagina perde focus (apertura checkout)
let checkoutOpened = false;
window.addEventListener('blur', function() {
    const loader = document.getElementById('bookingLoader');
    if (loader && loader.style.display !== 'none') {
        checkoutOpened = true;
    }
});

// Rileva quando la pagina riprende focus (ritorno da checkout)
window.addEventListener('focus', function() {
    if (checkoutOpened) {
        setTimeout(() => {
            const loader = document.getElementById('bookingLoader');
            if (loader && window.location.href.includes('booking.html')) {
                hideBookingLoader();
                enableForm();
                reapplyExperienceLock(); // âœ… AGGIUNGI QUESTA RIGA
                
                showValidationError(
                    'Checkout annullato. Puoi modificare i dati e riprovare quando vuoi.',
                    'checkout'
                );
            }
            checkoutOpened = false;
        }, 500);
    }
});

        /**
 * ğŸ“… Formatta data per invio backend SENZA conversioni timezone
 * Risolve problema shift -1 giorno causato da toISOString()
 */
function formatDateForBooking(date) {
    if (!date) return '';
    
    const year = date.getFullYear();
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const day = String(date.getDate()).padStart(2, '0');
    
    // Formato: "yyyy-MM-dd" senza conversione UTC
    return `${year}-${month}-${day}`;
}

    // ========================================
    // CONFERMA PRENOTAZIONE
    // ========================================
    async function confirmBooking() {
    const skuPrefix = bookingData.productData?.sku.split('-')[0].toUpperCase();
    const requiresDistance = skuPrefix !== 'EX' && skuPrefix !== 'SC';

    // âœ… 1. VALIDAZIONE DISTANZA
    if (requiresDistance && !bookingData.distance) {
        showValidationError('Seleziona un percorso prima di procedere', 'distance');
        return;
    }

    // âœ… 2. VALIDAZIONE DATA E ORARIO
const isExperience = skuPrefix === 'EX';

let date = bookingData.selectedDate;
const time = document.getElementById('bookingTime')?.value;

// âœ… Per esperienze con data fissa, usa la data dal prodotto
if (isExperience && bookingData.productData?.data_esperienza) {
  try {
    const dataEsperienza = bookingData.productData.data_esperienza;
    
    if (typeof dataEsperienza === 'string') {
      if (dataEsperienza.includes('-')) {
        date = new Date(dataEsperienza + 'T00:00:00');
      } else if (dataEsperienza.includes('/')) {
        const parts = dataEsperienza.split('/');
        date = new Date(parts[2], parts[1] - 1, parts[0]);
      }
    } else if (dataEsperienza instanceof Date) {
      date = dataEsperienza;
    }
    
    if (date && !isNaN(date.getTime())) {
      bookingData.selectedDate = date;
      console.log(`âœ… Data esperienza recuperata: ${date.toISOString()}`);
    }
  } catch (e) {
    console.error('âš ï¸ Errore parsing data esperienza:', e);
  }
}

// âœ… VALIDAZIONE: Permetti prenotazione se Ã¨ esperienza con data bloccata
const isFixedDateExperience = isExperience && bookingData.productData?.data_esperienza;

if (!date && !isFixedDateExperience) {
  showValidationError('Seleziona una data per la tua esperienza.', 'date');
  document.getElementById('bookingDate')?.focus();
  return;
}

// âœ… Validazione orario (permetti se esperienza con orario bloccato)
if (!time) {
  showValidationError('Seleziona un orario per la tua esperienza.', 'time');
  document.getElementById('bookingTime')?.focus();
  return;
}
    
    // âœ… 3. VALIDAZIONE DATI PERSONALI
    const firstName = document.querySelector('input[placeholder="Il tuo nome"]');
    const lastName = document.querySelector('input[placeholder="Il tuo cognome"]');
    
    if (!firstName || !firstName.value.trim()) {
        showValidationError('Inserisci il tuo nome per procedere.', 'name');
        firstName?.focus();
        return;
    }
    
    if (!lastName || !lastName.value.trim()) {
        showValidationError('Inserisci il tuo cognome per procedere.', 'surname');
        lastName?.focus();
        return;
    }
    
    // âœ… 4. VALIDAZIONE EMAIL
    const emailInput = document.querySelector('input[type="email"]');
    if (!emailInput || !emailInput.value.trim()) {
        showEmailError('Inserisci il tuo indirizzo email per procedere.');
        emailInput?.focus();
        return;
    }
    
    const emailValidation = validateEmail(emailInput.value.trim());
    if (!emailValidation.valid) {
        showEmailError(emailValidation.message);
        emailInput.focus();
        return;
    }
    
    // âœ… 5. VALIDAZIONE TELEFONO
    const phoneInput = document.querySelector('input[type="tel"]');
    if (!phoneInput || !phoneInput.value.trim()) {
        showValidationError('Inserisci il tuo numero di telefono per procedere.', 'phone');
        phoneInput?.focus();
        return;
    }
    
    const phoneDigits = phoneInput.value.replace(/\D/g, '');
    if (phoneDigits.length < 6) {
        showValidationError('Il numero di telefono inserito non Ã¨ valido. Inserisci un numero completo.', 'phone');
        phoneInput.focus();
        return;
    }
    
    if (phoneDigits.length < selectedCountry.maxLength - 2) {
        showValidationError(`Il numero deve contenere almeno ${selectedCountry.maxLength - 2} cifre per ${selectedCountry.country}.`, 'phone');
        phoneInput.focus();
        return;
    }
    
    // âœ… 6. VALIDAZIONE TERMINI E CONDIZIONI
    const terms = document.getElementById('termsCheckbox')?.checked;
    if (!terms) {
        showValidationError('Devi accettare i termini e condizioni per procedere con la prenotazione.', 'terms');
        document.getElementById('termsCheckbox')?.focus();
        return;
    }
    
    // âœ… 7. RECUPERA NOTE (OPZIONALI)
    const notesTextarea = document.querySelector('textarea[placeholder*="richieste"]');
    const notes = notesTextarea ? notesTextarea.value.trim() : '';
    
        // âœ… 8. PREPARAZIONE LINE ITEMS
    const lineItems = [];

    // ğŸ“¦ SEZIONE PRENOTAZIONE
if (bookingData.secondCar) {
    const checkbox = document.getElementById('secondCarCheckbox');
    if (checkbox) {
        const comboPrice = parseInt(checkbox.dataset.comboPrice) || 0;
        const comboName = checkbox.dataset.comboName || '';
        const comboSku = checkbox.dataset.comboSku || '';
        
        const mainCarName = bookingData.productData.title;
        const comboFullName = `${mainCarName} + ${comboName}`;
        const totalComboPrice = bookingData.basePrice + comboPrice;
        
        lineItems.push({
            sku: `${bookingData.sku}+${comboSku}`,
            title: `${comboFullName}`,
            price: totalComboPrice,
            qty: 1,
            currency: 'EUR',
            image: bookingData.productData.mainImage || '',
            description: bookingData.distance || ''
        });
    }
} else {
    // âœ… DESCRIZIONE: solo se km validi (non N/A e non EX)
    const hasValidDistance = bookingData.distance && 
                             bookingData.distance !== 'N/A' && 
                             skuPrefix !== 'EX';
    
    lineItems.push({
        sku: bookingData.sku,
        title: `${bookingData.productData.title}`,
        price: bookingData.basePrice,
        qty: 1,
        currency: 'EUR',
        image: bookingData.productData.mainImage || '',
        description: hasValidDistance ? bookingData.distance : ''
    });
}

    // ğŸ¯ SEZIONE SERVIZI AGGIUNTIVI (SE PRESENTI)
    if (bookingData.extraServices.length > 0) {
        const serviceNames = {
            'photo': 'Servizio Fotografico',
            'video-hd': 'Video HD',
            'video-360': 'Video 360Â°',
            'extra-passengers': 'Passeggeri Extra'
        };
        
        bookingData.extraServices.forEach(service => {
            let serviceName = serviceNames[service.service] || service.service;
            if (service.quantity) serviceName += ` (${service.quantity})`;
            
            // âœ… PREFISSO VISIVO PER SERVIZI
            lineItems.push({
                sku: `SVC-${service.service}`,
                title: `Â» ${serviceName}`,
                price: service.price,
                qty: 1,
                currency: 'EUR',
                description: 'servizio extra'  // âœ… MINUSCOLO
            });
        });
    }
    
    // âœ… 9. LOGICA DIFFERENZIATA PER TIPO PRODOTTO
    showBookingLoader();
    disableForm();
    
    try {
        // âœ… CASO 1: IMMOBILI (PR) - NO STRIPE, SOLO EMAIL
        if (skuPrefix === 'PR') {
            const bookingPayload = {
                sku: bookingData.sku,
                product_title: bookingData.productData.title,
                date: formatDateForBooking(date),
                time: time,
                distance: 'N/A',  // âœ… FORZATO a N/A per immobili (PR)
                customer_name: `${firstName.value.trim()} ${lastName.value.trim()}`,
                customer_email: emailInput.value.trim().toLowerCase(),
                customer_phone: `${selectedCountry.code} ${phoneInput.value.trim()}`,
                customer_country: selectedCountry.country,
                notes: notes,
                location: bookingData.productData.luogo || '',
                total: 0  // Immobili senza prezzo
            };
            
            const response = await fetch(WEB_APP_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: new URLSearchParams({
                    action: 'send_property_booking',
                    data: JSON.stringify(bookingPayload)
                })
            });
            
            const result = await response.json();
            
            if (result.success) {
                // âœ… USA URL REDIRECT DAL BACKEND
                const redirectUrl = result.redirect_url || 
                `${window.location.origin}/luxhaven360-site/product-details/success-booking.html?booking_id=${result.booking_id}`;
  
                console.log('âœ… Redirect IMMOBILI:', redirectUrl);
                window.location.href = redirectUrl;
            } else {
                throw new Error(result.error || 'Errore invio prenotazione');
            }
            
        } 
        // âœ… CASO 2: SUPERCAR/ESPERIENZE (SC/EX) - CON STRIPE
        else if (skuPrefix === 'SC' || skuPrefix === 'EX') {
            const checkoutData = {
                cart: lineItems,
                shipping: 0,
                is_booking: true,
                booking_metadata: {
    sku: (() => {
        // âœ… Se combo attiva, passa SKU combinato
        if (bookingData.secondCar) {
            const checkbox = document.getElementById('secondCarCheckbox');
            const comboSku = checkbox ? checkbox.dataset.comboSku : '';
            return comboSku ? `${bookingData.sku}+${comboSku}` : bookingData.sku;
        }
        return bookingData.sku;
    })(),
    product_title: (() => {
        // âœ… Se combo attiva, passa nome combinato
        if (bookingData.secondCar) {
            const checkbox = document.getElementById('secondCarCheckbox');
            const comboName = checkbox ? checkbox.dataset.comboName : '';
            return comboName ? `${bookingData.productData.title} + ${comboName}` : bookingData.productData.title;
        }
        return bookingData.productData.title;
    })(),
    date: formatDateForBooking(date),
    time: time,
    distance: bookingData.distance || 'N/A',
    customer_name: `${firstName.value.trim()} ${lastName.value.trim()}`,
    customer_email: emailInput.value.trim().toLowerCase(),
    customer_phone: `${selectedCountry.code} ${phoneInput.value.trim()}`,
    customer_country: selectedCountry.country,
    notes: notes,
    second_car: bookingData.secondCar,
    extra_services: JSON.stringify(bookingData.extraServices),
    total_amount: bookingData.total  // âœ… ASSICURATI CHE SIA total_amount non solo total
},
                cancel_url: window.location.href,
                success_url: `${window.location.origin}/luxhaven360-site/success-booking.html`
            };
            
            const response = await fetch(WEB_APP_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: new URLSearchParams({
                    action: 'create_booking_checkout',
                    data: JSON.stringify(checkoutData)
                })
            });
            
            const result = await response.json();
            
            if (result.success && result.url) {
                console.log('âœ… Checkout creato con successo');
                console.log('ğŸ“‹ Session ID:', result.session_id);
                console.log('ğŸ”— Redirect URL:', result.url);
                window.location.href = result.url;
            } else {
                throw new Error(result.error || 'Errore creazione checkout');
            }
        }
        
    } catch (error) {
        console.error('Errore checkout:', error);
        showBookingError('Si Ã¨ verificato un errore durante la creazione del checkout. Riprova.');
        hideBookingLoader();
        enableForm();
    }
}

// ========================================
// FUNZIONI UTILITY PER VALIDAZIONE
// ========================================

/**
 * Mostra errore di validazione generico
 */
function showValidationError(message, field) {
    const toast = document.createElement('div');
    toast.style.cssText = `
        position: fixed;
        top: 30px;
        right: 30px;
        background: linear-gradient(135deg, rgba(20, 15, 12, 0.98), rgba(30, 20, 15, 0.98));
        backdrop-filter: blur(20px);
        color: #f5f5f0;
        padding: 24px 32px;
        border-radius: 16px;
        box-shadow: 0 20px 60px rgba(239, 68, 68, 0.3), 0 0 0 1px rgba(239, 68, 68, 0.2);
        z-index: 100000;
        font-size: 15px;
        max-width: 420px;
        border: 1.5px solid rgba(239, 68, 68, 0.4);
        animation: slideInRight 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
    `;
    
    toast.innerHTML = `
        <div style="display: flex; align-items: flex-start; gap: 16px;">
            <div style="flex-shrink: 0; width: 28px; height: 28px; background: rgba(239, 68, 68, 0.15); border-radius: 50%; display: flex; align-items: center; justify-content: center; border: 1.5px solid rgba(239, 68, 68, 0.4);">
                <svg style="width: 16px; height: 16px; color: #ef4444;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                </svg>
            </div>
            <div style="flex: 1;">
                <div style="font-weight: 600; margin-bottom: 6px; color: #D4AF37; font-size: 14px; text-transform: uppercase; letter-spacing: 1px;">Campo Richiesto</div>
                <div style="line-height: 1.6; color: #c9a891;">${message}</div>
            </div>
        </div>
    `;
    
    document.body.appendChild(toast);
    
    setTimeout(() => {
        toast.style.transition = 'opacity 0.4s ease, transform 0.4s ease';
        toast.style.opacity = '0';
        toast.style.transform = 'translateX(50px)';
        setTimeout(() => toast.remove(), 400);
    }, 5000);
}

/**
 * Mostra loader durante invio prenotazione
 */
function showBookingLoader() {
    const loader = document.createElement('div');
    loader.id = 'bookingLoader';
    loader.style.cssText = `
        position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
        background: linear-gradient(135deg, rgba(10, 10, 10, 0.98) 0%, rgba(26, 20, 18, 0.98) 100%);
        backdrop-filter: blur(20px);
        z-index: 100001; display: flex; align-items: center; justify-content: center;
        animation: fadeIn 0.4s ease;
    `;
    
    loader.innerHTML = `
        <div style="text-align: center; position: relative;">
            
            <!-- Cerchio Principale con Glow -->
            <div style="
                position: relative; width: 160px; height: 160px; 
                margin: 0 auto 48px;
            ">
                <!-- Ring 1 -->
                <div style="
                    position: absolute; inset: 0;
                    border: 4px solid transparent;
                    border-top-color: #D4AF37;
                    border-right-color: #FFD700;
                    border-radius: 50%;
                    animation: spin 2s cubic-bezier(0.68, -0.55, 0.265, 1.55) infinite;
                    filter: drop-shadow(0 0 20px rgba(212, 175, 55, 0.6));
                "></div>
                
                <!-- Ring 2 -->
                <div style="
                    position: absolute; inset: 12px;
                    border: 3px solid transparent;
                    border-bottom-color: #c9a02c;
                    border-left-color: rgba(212, 175, 55, 0.4);
                    border-radius: 50%;
                    animation: spin 3s linear infinite reverse;
                "></div>
                
                <!-- Glow Centrale -->
                <div style="
                    position: absolute; inset: 30px;
                    background: radial-gradient(circle, rgba(212, 175, 55, 0.3), transparent 70%);
                    border-radius: 50%;
                    animation: pulse 2s ease-in-out infinite;
                "></div>
                
                <!-- Icona Checkout -->
                <div style="
                    position: absolute; inset: 0;
                    display: flex; align-items: center; justify-content: center;
                ">
                    <svg width="70" height="70" viewBox="0 0 24 24" fill="none" stroke="#D4AF37" stroke-width="1.5">
                        <path stroke-linecap="round" stroke-linejoin="round" 
                              d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"
                              style="animation: checkPulse 2s ease-in-out infinite;" />
                    </svg>
                </div>
            </div>
            
            <!-- Testo Principale -->
            <h2 style="
                color: #f5f5f0; font-size: 28px; font-weight: 700;
                letter-spacing: 2px; margin-bottom: 16px;
                background: linear-gradient(135deg, #D4AF37, #FFD700);
                -webkit-background-clip: text; -webkit-text-fill-color: transparent;
                font-family: 'Playfair Display', serif;
                animation: slideUp 0.6s ease-out;
            ">Finalizzazione Prenotazione</h2>
            
            <p style="
                color: #c9a891; font-size: 16px; letter-spacing: 1px;
                margin-bottom: 12px; font-weight: 500;
                animation: slideUp 0.8s ease-out;
            ">Accesso al checkout sicuro in corso...</p>
            
            <p style="
                color: rgba(201, 168, 145, 0.6); font-size: 13px;
                animation: slideUp 1s ease-out;
            ">âœ“ Connessione crittografata SSL</p>
            
            <!-- Progress Bar Animata -->
            <div style="
                width: 320px; height: 4px;
                background: rgba(212, 175, 55, 0.12);
                border-radius: 10px; margin: 40px auto 0;
                overflow: hidden; position: relative;
                box-shadow: inset 0 2px 8px rgba(0, 0, 0, 0.3);
            ">
                <div style="
                    height: 100%; width: 70%;
                    background: linear-gradient(90deg, 
                        transparent 0%, 
                        #D4AF37 30%, 
                        #FFD700 50%, 
                        #D4AF37 70%, 
                        transparent 100%
                    );
                    background-size: 200% 100%;
                    animation: shimmer 2s ease-in-out infinite;
                    box-shadow: 0 0 25px rgba(212, 175, 55, 0.8);
                "></div>
            </div>
            
            <!-- Stelline Decorative -->
            <div style="position: absolute; top: 20%; left: 20%; animation: twinkle 3s infinite;">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="#D4AF37" opacity="0.4">
                    <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
                </svg>
            </div>
            <div style="position: absolute; top: 60%; right: 15%; animation: twinkle 4s infinite 1s;">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="#FFD700" opacity="0.3">
                    <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
                </svg>
            </div>
        </div>
    `;
    
    // Aggiungi animazioni CSS
    const style = document.createElement('style');
    style.textContent = `
        @keyframes checkPulse {
            0%, 100% { opacity: 0.5; stroke-dashoffset: 0; }
            50% { opacity: 1; stroke-dashoffset: 10; }
        }
        
        @keyframes twinkle {
            0%, 100% { opacity: 0.2; transform: scale(1); }
            50% { opacity: 0.8; transform: scale(1.3); }
        }
    `;
    document.head.appendChild(style);
    
    document.body.appendChild(loader);
}

/**
 * Nasconde loader
 */
function hideBookingLoader() {
    const loader = document.getElementById('bookingLoader');
    if (loader) {
        loader.style.opacity = '0';
        setTimeout(() => loader.remove(), 300);
    }
}

/**
 * Disabilita tutti i campi del form durante invio
 */
function disableForm() {
    document.querySelectorAll('input, select, textarea, button').forEach(el => {
        el.disabled = true;
        el.style.opacity = '0.6';
        el.style.pointerEvents = 'none';
    });
}

/**
 * Riabilita form
 */
function enableForm() {
    const isExperience = bookingData.productData && 
                        bookingData.productData.sku.toUpperCase().startsWith('EX');
    
    document.querySelectorAll('input, select, textarea, button').forEach(el => {
        // âœ… NON riabilitare data/orario per esperienze
        if (isExperience && (el.id === 'bookingDate' || el.id === 'bookingTime')) {
            return; // Mantiene il blocco
        }
        
        el.disabled = false;
        el.style.opacity = '1';
        el.style.pointerEvents = 'auto';
    });
}

/**
 * ğŸ”’ Ri-applica il blocco data/orario per esperienze dopo ritorno da checkout
 */
function reapplyExperienceLock() {
    const isExperience = bookingData.productData && 
                        bookingData.productData.sku.toUpperCase().startsWith('EX');
    
    if (!isExperience) return;
    
    console.log('ğŸ”’ Ri-applicazione blocco esperienze dopo ritorno checkout');
    
    const dateInput = document.getElementById('bookingDate');
    const timeSelect = document.getElementById('bookingTime');
    const calendar = document.getElementById('customCalendar');
    
    // Blocca campo data
    if (dateInput) {
        dateInput.disabled = true;
        dateInput.readOnly = true;
        dateInput.style.cursor = 'not-allowed';
        dateInput.style.opacity = '0.7';
        dateInput.style.pointerEvents = 'none'; // âœ… IMPEDISCE QUALSIASI CLICK
        
        // Previeni apertura calendario anche se qualcuno tenta di forzare
        dateInput.onclick = (e) => { 
            e.preventDefault(); 
            e.stopPropagation(); 
            return false;
        };
        dateInput.addEventListener('click', (e) => {
            e.preventDefault();
            e.stopPropagation();
        }, true); // Capture phase per bloccare prima
    }
    
    // Blocca select orario
    if (timeSelect) {
        timeSelect.disabled = true;
        timeSelect.style.cursor = 'not-allowed';
        timeSelect.style.opacity = '0.7';
        timeSelect.style.pointerEvents = 'none'; // âœ… IMPEDISCE APERTURA DROPDOWN
    }
    
    // Chiudi calendario se aperto
    if (calendar) {
        calendar.style.display = 'none';
    }
}

/**
 * Mostra messaggio di successo
 */
function showBookingSuccess(data) {
    const modal = document.createElement('div');
    modal.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        background: rgba(10, 10, 10, 0.95);
        backdrop-filter: blur(10px);
        z-index: 100002;
        display: flex;
        align-items: center;
        justify-content: center;
        animation: fadeIn 0.3s ease;
    `;
    
    const formatted = new Date(data.date).toLocaleDateString('it-IT', {
        day: '2-digit',
        month: 'long',
        year: 'numeric'
    });
    
    modal.innerHTML = `
        <div style="
            background: linear-gradient(135deg, rgba(20, 15, 12, 0.98), rgba(30, 20, 15, 0.98));
            backdrop-filter: blur(20px);
            border: 2px solid rgba(34, 197, 94, 0.4);
            border-radius: 24px;
            padding: 48px;
            max-width: 600px;
            width: 90%;
            box-shadow: 0 30px 80px rgba(0, 0, 0, 0.8);
            animation: scaleIn 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        ">
            <div style="text-align: center; margin-bottom: 32px;">
                <div style="width: 80px; height: 80px; background: rgba(34, 197, 94, 0.15); border: 2px solid rgba(34, 197, 94, 0.4); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 24px;">
                    <svg style="width: 40px; height: 40px; color: #22c55e;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M5 13l4 4L19 7"/>
                    </svg>
                </div>
                <h2 style="font-size: 32px; font-weight: 700; background: linear-gradient(135deg, #D4AF37, #F4E4C1); -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin-bottom: 12px;">Prenotazione Confermata!</h2>
                <p style="color: #c9a891; font-size: 16px; line-height: 1.6;">La tua esperienza esclusiva Ã¨ stata prenotata con successo.</p>
            </div>
            
            <div style="background: rgba(10, 10, 10, 0.6); border: 1px solid rgba(80, 60, 45, 0.4); border-radius: 16px; padding: 24px; margin-bottom: 32px;">
                <div style="display: grid; gap: 16px;">
                    <div style="display: flex; justify-content: space-between; padding-bottom: 12px; border-bottom: 1px solid rgba(80, 60, 45, 0.3);">
                        <span style="color: #a59173;">Esperienza</span>
                        <span style="color: #f5f5f0; font-weight: 600;">${data.productTitle}</span>
                    </div>
                    ${data.distance !== 'N/A' ? `
                    <div style="display: flex; justify-content: space-between; padding-bottom: 12px; border-bottom: 1px solid rgba(80, 60, 45, 0.3);">
                        <span style="color: #a59173;">Percorso</span>
                        <span style="color: #f5f5f0; font-weight: 600;">${data.distance} km</span>
                    </div>
                    ` : ''}
                    <div style="display: flex; justify-content: space-between; padding-bottom: 12px; border-bottom: 1px solid rgba(80, 60, 45, 0.3);">
                        <span style="color: #a59173;">Data e Orario</span>
                        <span style="color: #f5f5f0; font-weight: 600;">${formatted} - ${data.time}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; padding-top: 8px;">
                        <span style="color: #a59173; font-size: 18px;">Totale</span>
                        <span style="font-size: 28px; font-weight: 700; background: linear-gradient(135deg, #D4AF37, #F4E4C1); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">${formatPrice(data.total)}</span>
                    </div>
                </div>
            </div>
            
            <div style="text-align: center;">
                <p style="color: #c9a891; font-size: 14px; margin-bottom: 24px; line-height: 1.6;">
                    Riceverai una email di conferma all'indirizzo <strong style="color: #D4AF37;">${data.email}</strong> con tutti i dettagli della tua prenotazione.
                </p>
                <button onclick="window.location.href='/'" style="
                    background: linear-gradient(135deg, #d4af37 0%, #c9a02c 50%, #b8941f 100%);
                    color: #0a0a0a;
                    font-weight: 600;
                    padding: 18px 48px;
                    border: none;
                    border-radius: 14px;
                    cursor: pointer;
                    font-size: 16px;
                    letter-spacing: 1px;
                    text-transform: uppercase;
                    box-shadow: 0 4px 20px rgba(212, 175, 55, 0.3);
                    transition: all 0.3s ease;
                ">Torna alla Home</button>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
}

/**
 * Mostra messaggio di errore
 */
function showBookingError(message) {
    const modal = document.createElement('div');
    modal.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        background: rgba(10, 10, 10, 0.95);
        backdrop-filter: blur(10px);
        z-index: 100002;
        display: flex;
        align-items: center;
        justify-content: center;
        animation: fadeIn 0.3s ease;
    `;
    
    modal.innerHTML = `
        <div style="
            background: linear-gradient(135deg, rgba(20, 15, 12, 0.98), rgba(30, 20, 15, 0.98));
            backdrop-filter: blur(20px);
            border: 2px solid rgba(239, 68, 68, 0.4);
            border-radius: 24px;
            padding: 48px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 30px 80px rgba(0, 0, 0, 0.8);
            animation: scaleIn 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        ">
            <div style="text-align: center; margin-bottom: 32px;">
                <div style="width: 80px; height: 80px; background: rgba(239, 68, 68, 0.15); border: 2px solid rgba(239, 68, 68, 0.4); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 24px;">
                    <svg style="width: 40px; height: 40px; color: #ef4444;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </div>
                <h2 style="font-size: 28px; font-weight: 700; color: #ef4444; margin-bottom: 12px;">Errore Prenotazione</h2>
                <p style="color: #c9a891; font-size: 15px; line-height: 1.6;">${message}</p>
            </div>
            
            <div style="text-align: center;">
                <button onclick="this.closest('div[style*=\\'position: fixed\\']').remove()" style="
                    background: linear-gradient(135deg, #d4af37 0%, #c9a02c 50%, #b8941f 100%);
                    color: #0a0a0a;
                    font-weight: 600;
                    padding: 16px 40px;
                    border: none;
                    border-radius: 14px;
                    cursor: pointer;
                    font-size: 15px;
                    letter-spacing: 1px;
                    text-transform: uppercase;
                    box-shadow: 0 4px 20px rgba(212, 175, 55, 0.3);
                    transition: all 0.3s ease;
                ">Riprova</button>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
}

// Aggiungi animazioni CSS se non presenti
if (!document.getElementById('bookingAnimations')) {
    const style = document.createElement('style');
    style.id = 'bookingAnimations';
    style.textContent = `
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        @keyframes scaleIn {
            from {
                opacity: 0;
                transform: scale(0.9);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    `;
    document.head.appendChild(style);
}

    // ========================================
    // CUSTOM CALENDAR
    // ========================================
    let currentMonth = new Date();
    const dateInput = document.getElementById('bookingDate');
    const calendar = document.createElement('div');
    calendar.id = 'customCalendar';
    calendar.className = 'custom-calendar';
    calendar.style.display = 'none';
    document.body.appendChild(calendar);

    function initCalendar() {
        dateInput.addEventListener('click', function(e) {
            e.stopPropagation();
            if (currentMonth < earliestAllowed) {
                currentMonth = new Date(earliestAllowed.getFullYear(), earliestAllowed.getMonth(), 1);
            }
            calendar.style.display = (calendar.style.display === 'none' || !calendar.style.display) ? 'block' : 'none';
            renderCalendar();
            positionCalendar();
        });

        document.addEventListener('click', function(e) {
            if (!calendar.contains(e.target) && e.target !== dateInput) {
                calendar.style.display = 'none';
            }
        });

        window.addEventListener('resize', () => {
            if (calendar.style.display === 'block') positionCalendar();
        });
        
        window.addEventListener('scroll', () => {
            if (calendar.style.display === 'block') positionCalendar();
        }, true);
    }

    function positionCalendar() {
        const rect = dateInput.getBoundingClientRect();
        const left = rect.left + window.scrollX;
        const top = rect.bottom + window.scrollY + 8;
        calendar.style.left = left + 'px';
        calendar.style.top = top + 'px';
        calendar.style.minWidth = rect.width + 'px';
        calendar.style.maxWidth = '480px';
    }

    function renderCalendar() {
    const i18n = window.i18nPDP(); // âœ… RECUPERA ISTANZA i18n
    const year = currentMonth.getFullYear();
    const month = currentMonth.getMonth();
    
    const firstDay = new Date(year, month, 1);
    const lastDay = new Date(year, month + 1, 0);
    const daysInMonth = lastDay.getDate();
    const startingDayOfWeek = firstDay.getDay();

    // âœ… MESI TRADOTTI (usa i18n invece di array fissi)
    const monthNames = [
        i18n.t('booking_calendar_months.gennaio'),
        i18n.t('booking_calendar_months.febbraio'),
        i18n.t('booking_calendar_months.marzo'),
        i18n.t('booking_calendar_months.aprile'),
        i18n.t('booking_calendar_months.maggio'),
        i18n.t('booking_calendar_months.giugno'),
        i18n.t('booking_calendar_months.luglio'),
        i18n.t('booking_calendar_months.agosto'),
        i18n.t('booking_calendar_months.settembre'),
        i18n.t('booking_calendar_months.ottobre'),
        i18n.t('booking_calendar_months.novembre'),
        i18n.t('booking_calendar_months.dicembre')
    ];
    
    // âœ… GIORNI TRADOTTI
    const dayNames = [
        i18n.t('booking_calendar_days.sun'),
        i18n.t('booking_calendar_days.mon'),
        i18n.t('booking_calendar_days.tue'),
        i18n.t('booking_calendar_days.wed'),
        i18n.t('booking_calendar_days.thu'),
        i18n.t('booking_calendar_days.fri'),
        i18n.t('booking_calendar_days.sat')
    ];
    
    let html = `
        <div class="calendar-header">
            <button id="calendarPrevBtn" class="calendar-nav" onclick="previousMonth(event)">â—„</button>
            <div class="text-lg font-bold gradient-text">${monthNames[month]} ${year}</div>
            <button id="calendarNextBtn" class="calendar-nav" onclick="nextMonth(event)">â–º</button>
        </div>
        <div class="calendar-grid">
    `;
    
    // âœ… AGGIUNGI HEADER GIORNI TRADOTTI
    dayNames.forEach(day => {
        html += `<div class="calendar-day-header">${day}</div>`;
    });

    // Empty cells before first day
    for (let i = 0; i < startingDayOfWeek; i++) {
        html += '<div class="calendar-day empty"></div>';
    }

    // Days of the month
    for (let day = 1; day <= daysInMonth; day++) {
        const currentDate = new Date(year, month, day);
        const isDisabled = currentDate < minDate || currentDate > maxDate;
        const isSelected = bookingData.selectedDate && 
                         currentDate.toDateString() === bookingData.selectedDate.toDateString();
        
        const classes = ['calendar-day'];
        if (isDisabled) classes.push('disabled');
        if (isSelected) classes.push('selected');

        html += `<div class="${classes.join(' ')}" 
                     onclick="selectDate(${year}, ${month}, ${day}, ${isDisabled})">${day}</div>`;
    }

    html += '</div>';
    calendar.innerHTML = html;
    updateCalendarNavButtons();
}

    /**
 * ğŸŒ Aggiorna calendario per nuova lingua
 */
function updateCalendarLanguage() {
    if (calendar && calendar.style.display === 'block') {
        renderCalendar();
        positionCalendar();
    }
}

    function monthIsBefore(aYear, aMonth, bYear, bMonth) {
        return aYear < bYear || (aYear === bYear && aMonth < bMonth);
    }
    
    function monthIsAfter(aYear, aMonth, bYear, bMonth) {
        return aYear > bYear || (aYear === bYear && aMonth > bMonth);
    }

    function updateCalendarNavButtons() {
        const prev = document.getElementById('calendarPrevBtn');
        const next = document.getElementById('calendarNextBtn');
        if (!prev || !next) return;
        
        const displayYear = currentMonth.getFullYear();
        const displayMonth = currentMonth.getMonth();

        const earliestYear = earliestAllowed.getFullYear();
        const earliestMonth = earliestAllowed.getMonth();

        const maxYear = maxDate.getFullYear();
        const maxMonth = maxDate.getMonth();

        const canPrev = monthIsAfter(displayYear, displayMonth, earliestYear, earliestMonth);
        const canNext = monthIsBefore(displayYear, displayMonth, maxYear, maxMonth);

        if (canPrev) prev.classList.remove('disabled'); 
        else prev.classList.add('disabled');
        
        if (canNext) next.classList.remove('disabled'); 
        else next.classList.add('disabled');
    }

    function previousMonth(e) {
        e.preventDefault();
        e.stopPropagation();
        const curYear = currentMonth.getFullYear();
        const curMonth = currentMonth.getMonth();
        const earliestYear = earliestAllowed.getFullYear();
        const earliestMonth = earliestAllowed.getMonth();
        
        if (!(curYear > earliestYear || (curYear === earliestYear && curMonth > earliestMonth))) return;
        
        currentMonth.setMonth(curMonth - 1);
        renderCalendar();
        positionCalendar();
    }

    function nextMonth(e) {
        e.preventDefault();
        e.stopPropagation();
        const curYear = currentMonth.getFullYear();
        const curMonth = currentMonth.getMonth();
        const maxYear = maxDate.getFullYear();
        const maxMonth = maxDate.getMonth();
        
        if (!(curYear < maxYear || (curYear === maxYear && curMonth < maxMonth))) return;
        
        currentMonth.setMonth(curMonth + 1);
        renderCalendar();
        positionCalendar();
    }

    function selectDate(year, month, day, isDisabled) {
        if (isDisabled) return;
        
        bookingData.selectedDate = new Date(year, month, day);
        const formatted = bookingData.selectedDate.toLocaleDateString('it-IT', {
            day: '2-digit',
            month: '2-digit',
            year: 'numeric'
        });
        dateInput.value = formatted;
        calendar.style.display = 'none';
        renderCalendar();
    }

    // ========================================
    // ANIMATION ON SCROLL
    // ========================================
    const observerOptions = {
        threshold: 0.1,
        rootMargin: '0px 0px -50px 0px'
    };

    const observer = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
            if (entry.isIntersecting) {
                entry.target.style.opacity = '1';
                entry.target.style.transform = 'translateY(0)';
            }
        });
    }, observerOptions);

    document.querySelectorAll('.animate-fade-in').forEach(el => {
        el.style.opacity = '0';
        el.style.transform = 'translateY(30px)';
        el.style.transition = 'all 0.6s ease';
        observer.observe(el);
    });

        // ===================================
// ğŸ–¼ï¸ IMAGE SLIDER MANAGEMENT
// ===================================

let currentImageIndex = 0;
let productImages = [];

/**
 * Inizializza lo slider immagini
 */
function initImageSlider(images, productTitle) {
    productImages = images || [];
    currentImageIndex = 0;
    
    const prevBtn = document.getElementById('prevImageBtn');
    const nextBtn = document.getElementById('nextImageBtn');
    const counter = document.getElementById('imageCounter');
    const totalSpan = document.getElementById('totalImages');
    
    // Se c'Ã¨ solo 1 immagine, nascondi tutto
    if (productImages.length <= 1) {
        if (prevBtn) prevBtn.style.display = 'none';
        if (nextBtn) nextBtn.style.display = 'none';
        if (counter) counter.style.display = 'none';
        return;
    }
    
    // Mostra frecce e contatore
    if (prevBtn) prevBtn.style.display = 'flex';
    if (nextBtn) nextBtn.style.display = 'flex';
    if (counter) counter.style.display = 'block';
    if (totalSpan) totalSpan.textContent = productImages.length;
    
    // Event listeners
    if (prevBtn) {
        prevBtn.addEventListener('click', () => navigateImage(-1, productTitle));
    }
    
    if (nextBtn) {
        nextBtn.addEventListener('click', () => navigateImage(1, productTitle));
    }
    
    // Supporto tastiera (frecce sinistra/destra)
    document.addEventListener('keydown', (e) => {
        if (e.key === 'ArrowLeft') navigateImage(-1, productTitle);
        if (e.key === 'ArrowRight') navigateImage(1, productTitle);
    });
    
    updateImageCounter();
}

/**
 * Naviga tra le immagini
 */
function navigateImage(direction, productTitle) {
    if (productImages.length <= 1) return;
    
    const img = document.getElementById('mainProductImage');
    if (!img) return;
    
    // Animazione fade
    img.classList.add('changing');
    
    setTimeout(() => {
        // Calcola nuovo indice (con wrap-around)
        currentImageIndex = (currentImageIndex + direction + productImages.length) % productImages.length;
        
        // Aggiorna immagine
        img.src = productImages[currentImageIndex];
        img.alt = `${productTitle} - Foto ${currentImageIndex + 1}`;
        
        // Aggiorna contatore
        updateImageCounter();
        
        // Rimuovi animazione
        setTimeout(() => img.classList.remove('changing'), 50);
    }, 150);
}

/**
 * Aggiorna contatore immagini
 */
function updateImageCounter() {
    const currentSpan = document.getElementById('currentImageIndex');
    if (currentSpan) {
        currentSpan.textContent = currentImageIndex + 1;
    }
}

// ===================================
// ğŸ”’ BLOCCO DATA/ORARIO PER ESPERIENZE
// ===================================

/**
 * Formatta la data esperienza in formato italiano (dd/MM/yyyy) - VERSIONE ROBUSTA
 */
function formatExperienceDate(dateValue) {
    if (!dateValue) return 'Data da confermare';
    
    // Caso 1: Ãˆ giÃ  una stringa formattata
    if (typeof dateValue === 'string') {
        const trimmed = dateValue.trim();
        
        // Se Ã¨ giÃ  dd/MM/yyyy
        if (trimmed.match(/^\d{2}\/\d{2}\/\d{4}$/)) {
            return trimmed;
        }
        
        // Se contiene "GMT" o timestamp, prova a parsare
        if (trimmed.includes('GMT') || trimmed.includes('T')) {
            try {
                const date = new Date(trimmed);
                if (!isNaN(date.getTime())) {
                    const day = String(date.getDate()).padStart(2, '0');
                    const month = String(date.getMonth() + 1).padStart(2, '0');
                    const year = date.getFullYear();
                    return `${day}/${month}/${year}`;
                }
            } catch (e) {
                console.warn('Errore parsing data stringa:', e);
            }
        }
        
        // Se Ã¨ ISO date (YYYY-MM-DD)
        if (trimmed.match(/^\d{4}-\d{2}-\d{2}/)) {
            try {
                const date = new Date(trimmed + 'T00:00:00');
                const day = String(date.getDate()).padStart(2, '0');
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const year = date.getFullYear();
                return `${day}/${month}/${year}`;
            } catch (e) {
                console.warn('Errore parsing ISO date:', e);
            }
        }
        
        // Fallback: ritorna stringa originale se non parsabile
        return trimmed;
    }
    
    // Caso 2: Ãˆ un oggetto Date
    if (dateValue instanceof Date) {
        if (isNaN(dateValue.getTime())) return 'Data da confermare';
        
        const day = String(dateValue.getDate()).padStart(2, '0');
        const month = String(dateValue.getMonth() + 1).padStart(2, '0');
        const year = dateValue.getFullYear();
        return `${day}/${month}/${year}`;
    }
    
    // Caso 3: Prova conversione generica
    try {
        const date = new Date(dateValue);
        if (!isNaN(date.getTime())) {
            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const year = date.getFullYear();
            return `${day}/${month}/${year}`;
        }
    } catch (e) {
        console.warn('Errore conversione data:', e);
    }
    
    // Fallback finale
    return 'Data da confermare';
}
        
/**
 * ğŸ”’ BLOCCO DATA/ORARIO PER ESPERIENZE (SKU "EX") - VERSIONE ROBUSTA
 */
function handleExperienceDateLock(product) {
    // Controlla se Ã¨ un prodotto "ESPERIENZE"
    const isExperience = product.sku && product.sku.toUpperCase().startsWith('EX');
    
    if (!isExperience) return; // Se non Ã¨ EX, esci
    
    console.log('ğŸ”’ Prodotto ESPERIENZE rilevato, blocco data/orario attivo');
    
    const dateInput = document.getElementById('bookingDate');
    const timeSelect = document.getElementById('bookingTime');
    
    // === BLOCCO DATA ===
    if (dateInput) {
        // âœ… GESTIONE ROBUSTA: Usa data da prodotto o placeholder
        if (product.data_esperienza) {
            try {
                const formattedDate = formatExperienceDate(product.data_esperienza);
                dateInput.value = formattedDate;
                
                // âœ… Imposta anche bookingData.selectedDate
                const dateObj = new Date(product.data_esperienza);
                if (!isNaN(dateObj.getTime())) {
                    bookingData.selectedDate = dateObj;
                    console.log(`âœ… Data esperienza impostata: ${dateObj}`);
                }
            } catch (e) {
                console.warn('âš ï¸ Errore formattazione data esperienza:', e);
                dateInput.value = 'Data da confermare';
            }
        } else {
            // Fallback se data mancante
            dateInput.value = 'Data da confermare';
            console.warn('âš ï¸ Data esperienza mancante dal prodotto');
        }
        
        // Disabilita input
dateInput.disabled = true;
dateInput.readOnly = true;
dateInput.style.cursor = 'not-allowed';
dateInput.style.opacity = '0.7';
dateInput.style.background = 'rgba(30, 30, 30, 0.6)';
dateInput.style.pointerEvents = 'none'; // âœ… AGGIUNGI QUESTA RIGA

// âœ… AGGIUNGI: Previeni click in capture phase
dateInput.addEventListener('click', (e) => {
    e.preventDefault();
    e.stopPropagation();
}, true);
        
        // Nascondi icona calendario
        const dateIcon = dateInput.parentElement?.querySelector('.date-icon');
        if (dateIcon) dateIcon.style.display = 'none';
        
        // Disabilita apertura calendario
        dateInput.onclick = null;
        
        // Aggiungi tooltip
        const dateContainer = dateInput.parentElement;
        if (dateContainer && !dateContainer.querySelector('.experience-date-tooltip')) {
            const tooltip = document.createElement('div');
            tooltip.className = 'experience-date-tooltip';
            tooltip.style.cssText = `
                font-size: 11px;
                color: #D4AF37;
                margin-top: 6px;
                font-weight: 500;
                letter-spacing: 0.5px;
            `;
            tooltip.textContent = 'ğŸ“… Data fissa per questa esperienza';
            dateContainer.appendChild(tooltip);
        }
    }
    
    // === BLOCCO ORARIO ===
    if (timeSelect) {
        // âœ… GESTIONE ROBUSTA: Usa orari da prodotto o fallback
        if (product.orari && Array.isArray(product.orari) && product.orari.length > 0) {
            const fixedTime = product.orari[0]; // Primo orario disponibile
            timeSelect.value = fixedTime;
            console.log(`âœ… Orario bloccato: ${fixedTime}`);
        } else {
            console.warn('âš ï¸ Orari mancanti dal prodotto, mantieni selezione manuale');
            // Non bloccare se mancano orari
            return;
        }
        
        // Disabilita select
timeSelect.disabled = true;
timeSelect.style.cursor = 'not-allowed';
timeSelect.style.opacity = '0.7';
timeSelect.style.background = 'rgba(30, 30, 30, 0.6)';
timeSelect.style.pointerEvents = 'none'; // âœ… AGGIUNGI QUESTA RIGA
        
        // Aggiungi tooltip
        const timeContainer = timeSelect.parentElement;
        if (timeContainer && !timeContainer.querySelector('.experience-time-tooltip')) {
            const tooltip = document.createElement('div');
            tooltip.className = 'experience-time-tooltip';
            tooltip.style.cssText = `
                font-size: 11px;
                color: #D4AF37;
                margin-top: 6px;
                font-weight: 500;
                letter-spacing: 0.5px;
            `;
            tooltip.textContent = 'ğŸ• Orario fisso per questa esperienza';
            timeContainer.appendChild(tooltip);
        }
    }

    // === NASCONDI TESTO PRENOTAZIONE ===
    const adviceText = document.getElementById('bookingAdviceText');
    if (adviceText) {
        adviceText.style.display = 'none';
        console.log('âœ… Testo prenotazione nascosto per esperienza');
    }
}

        /**
 * Disabilita prenotazione per esperienze "Presto Disponibili"
 */
function disableBookingForComingSoon() {
  console.log('ğŸ”’ Esperienza Presto Disponibile: disabilito prenotazione');
  
  // 1. Disabilita pulsante conferma
  const confirmBtn = document.querySelector('button[onclick="confirmBooking()"]');
  if (confirmBtn) {
    confirmBtn.disabled = true;
    confirmBtn.style.opacity = '0.5';
    confirmBtn.style.cursor = 'not-allowed';
    confirmBtn.style.background = 'linear-gradient(135deg, #71717a, #52525b)';
    confirmBtn.textContent = 'Prenotazione Non Ancora Disponibile';
  }
  
  // 2. Aggiungi banner informativo
  const sidebar = document.querySelector('.sidebar');
  if (sidebar) {
    const banner = document.createElement('div');
    banner.style.cssText = `
      background: linear-gradient(135deg, rgba(212, 175, 55, 0.12), rgba(255, 215, 0, 0.05));
      border: 2px solid #D4AF37;
      border-radius: 16px;
      padding: 24px;
      margin-bottom: 24px;
      animation: fadeIn 0.5s ease;
    `;
    
    banner.innerHTML = `
      <div style="display: flex; align-items: flex-start; gap: 16px;">
        <div style="flex-shrink: 0; width: 48px; height: 48px; background: rgba(212, 175, 55, 0.2); border-radius: 50%; display: flex; align-items: center; justify-content: center;">
          <svg style="width: 24px; height: 24px; color: #D4AF37;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
          </svg>
        </div>
        <div style="flex: 1;">
          <h4 style="color: #D4AF37; font-size: 16px; font-weight: 600; margin-bottom: 8px; letter-spacing: 1px;">
            Esperienza In Arrivo
          </h4>
          <p style="color: #c9a891; font-size: 14px; line-height: 1.6; margin: 0;">
            Questa esperienza sarÃ  presto disponibile per la prenotazione. 
            Torna a visitare questa pagina prossimamente per assicurarti il tuo posto.
          </p>
        </div>
      </div>
    `;
    
    sidebar.insertBefore(banner, sidebar.firstChild);
  }
}

        // ========================================
// ğŸŒ LANGUAGE CHANGE LISTENER
// ========================================
document.addEventListener('languageChanged', function(e) {
    console.log('ğŸŒ Lingua cambiata:', e.detail.lang);
    
    // Riapplica traduzioni dinamiche se necessario
    if (bookingData.productData) {
        const config = bookingData.productData.typeConfig;
        const i18n = window.i18nPDP();
        
        // Aggiorna header
        const heroTitle = document.querySelector('.hero-title');
        const heroSubtitle = document.querySelector('.hero-subtitle');
        const badgeText = document.querySelector('.badge-text');
        
        if (heroTitle) {
            heroTitle.textContent = i18n.t(config.type === 'supercar' ? 'booking_config_sc_title' : 
                                          config.type === 'immobili' ? 'booking_config_pr_title' : 
                                          'booking_config_ex_title');
        }
        
        if (heroSubtitle) {
            heroSubtitle.textContent = i18n.t(config.type === 'supercar' ? 'booking_config_sc_subtitle' : 
                                             config.type === 'immobili' ? 'booking_config_pr_subtitle' : 
                                             'booking_config_ex_subtitle');
        }
        
        if (badgeText) {
            badgeText.textContent = i18n.t(config.type === 'supercar' ? 'booking_config_sc_badge' : 
                                           config.type === 'immobili' ? 'booking_config_pr_badge' : 
                                           'booking_config_ex_badge');
        }
        
                // âœ… AGGIUNGI: Aggiorna tabelle prestazioni/caratteristiche
        const table1Title = document.querySelector('.table-1-title');
        const table2Title = document.querySelector('.table-2-title');
        
        if (table1Title) {
            table1Title.textContent = i18n.t(config.type === 'supercar' ? 'booking_config_sc_table1' :
                                             config.type === 'immobili' ? 'booking_config_pr_table1' :
                                             'booking_config_ex_table1');
        }
        
        if (table2Title) {
            table2Title.textContent = i18n.t(config.type === 'supercar' ? 'booking_config_sc_table2' :
                                             config.type === 'immobili' ? 'booking_config_pr_table2' :
                                             'booking_config_ex_table2');
        }
        
        // âœ… Aggiorna label nelle tabelle
        updateTableLabels();
        
        // Aggiorna prezzi con nuova valuta
        updatePriceSummary();
    }

        // âœ… Aggiorna dropdown paesi
        updatePhoneDropdownLanguage();

        // âœ… Aggiorna etichette distanze
        updateDistanceLabels();
});

/**
 * ğŸ·ï¸ Aggiorna label tabelle prestazioni/caratteristiche
 */
function updateTableLabels() {
    const i18n = window.i18nPDP();
    const config = bookingData.productData?.typeConfig;
    if (!config) return;
    
    const product = bookingData.productData;
    
    // Tabella 1
    const table1Body = document.querySelector('.table-1-body');
    if (table1Body && product.prestazioni) {
        table1Body.innerHTML = '';
        product.prestazioni.forEach((value, index) => {
            const labelKey = `booking_config_${config.type === 'supercar' ? 'sc' : config.type === 'immobili' ? 'pr' : 'ex'}_specs`;
            const labels = i18n.t(labelKey);
            const label = Array.isArray(labels) ? labels[index] : `Campo ${index + 1}`;
            
            table1Body.innerHTML += `
                <div class="spec-item">
                    <span style="color: #a59173;">${label}</span>
                    <span class="font-semibold">${value}</span>
                </div>
            `;
        });
    }
    
    // Tabella 2
    const table2Body = document.querySelector('.table-2-body');
    if (table2Body && product.caratteristiche) {
        table2Body.innerHTML = '';
        product.caratteristiche.forEach((value, index) => {
            const labelKey = `booking_config_${config.type === 'supercar' ? 'sc' : config.type === 'immobili' ? 'pr' : 'ex'}_specs`;
            const labels = i18n.t(labelKey);
            const label = Array.isArray(labels) ? labels[index + 4] : `Campo ${index + 5}`; // +4 offset per tabella 2
            
            table2Body.innerHTML += `
                <div class="spec-item">
                    <span style="color: #a59173;">${label}</span>
                    <span class="font-semibold">${value}</span>
                </div>
            `;
        });
    }
}

        /**
 * ğŸ• Aggiorna formattazione orari nel dropdown
 */
function updateTimeFormatLanguage() {
    const i18n = window.i18nPDP();
    const timeSelect = document.getElementById('bookingTime');
    
    if (!timeSelect || !bookingData.productData) return;
    
    const product = bookingData.productData;
    const currentValue = timeSelect.value;
    
    // Ricostruisci options con formattazione corretta
    timeSelect.innerHTML = `<option value="">${i18n.t('booking_time_placeholder')}</option>`;
    
    if (product.orari && Array.isArray(product.orari) && product.orari.length > 0) {
        product.orari.forEach(orario => {
            if (orario) {
                const formattedTime = i18n.formatTime(orario);
                timeSelect.innerHTML += `<option value="${orario}">${formattedTime}</option>`;
            }
        });
    }
    
    // Ripristina selezione precedente
    if (currentValue) {
        timeSelect.value = currentValue;
    }
}
</script>
</body>
</html>
