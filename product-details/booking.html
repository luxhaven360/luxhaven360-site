<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prenota il Tuo Test Drive</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        // Suppress Tailwind CDN warning
        tailwind.config = {
            theme: {
                extend: {}
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600;700&family=Inter:wght@300;400;500;600&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #0a0a0a 0%, #1a1412 30%, #2d1810 60%, #0a0a0a 100%);
            min-height: 100vh;
            color: #f5f5f0;
        }
        
        h1, h2, h3 {
            font-family: 'Playfair Display', serif;
        }
        
        .gradient-text {
            background: linear-gradient(135deg, #d4af37 0%, #f4e4c1 30%, #c9a02c 60%, #e5c87f 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            background-size: 200% auto;
            animation: shimmer 3s linear infinite;
        }
        
        @keyframes shimmer {
            to {
                background-position: 200% center;
            }
        }
        
        .glass-card {
            background: rgba(20, 15, 12, 0.7);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(212, 175, 55, 0.15);
            border-radius: 24px;
            transition: all 0.4s ease;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
        }
        
        .glass-card:hover {
            border-color: rgba(212, 175, 55, 0.4);
            transform: translateY(-4px);
            box-shadow: 0 20px 60px rgba(212, 175, 55, 0.15);
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #d4af37 0%, #c9a02c 50%, #b8941f 100%);
            color: #0a0a0a;
            font-weight: 600;
            padding: 18px 40px;
            border: none;
            border-radius: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 16px;
            letter-spacing: 1px;
            text-transform: uppercase;
            box-shadow: 0 4px 20px rgba(212, 175, 55, 0.3);
        }
        
        .btn-primary:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 30px rgba(212, 175, 55, 0.5);
            background: linear-gradient(135deg, #e5c047 0%, #d4af37 50%, #c9a02c 100%);
        }
        
        .btn-secondary {
            background: rgba(212, 175, 55, 0.08);
            color: #d4af37;
            border: 1.5px solid #d4af37;
            padding: 12px 30px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
        }
        
        .btn-secondary:hover {
            background: rgba(212, 175, 55, 0.18);
            transform: translateX(-4px);
        }
        
        .distance-option {
            padding: 24px;
            border: 2px solid rgba(80, 60, 45, 0.4);
            border-radius: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            background: rgba(10, 10, 10, 0.6);
        }
        
        .distance-option:hover {
            border-color: rgba(212, 175, 55, 0.6);
            transform: scale(1.03);
            background: rgba(45, 24, 16, 0.4);
        }
        
        .distance-option.selected {
            border-color: #d4af37;
            background: linear-gradient(135deg, rgba(212, 175, 55, 0.15), rgba(201, 160, 44, 0.08));
            box-shadow: 0 0 30px rgba(212, 175, 55, 0.2);
        }
        
        .feature-badge {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 10px 18px;
            background: rgba(34, 197, 94, 0.08);
            border: 1px solid rgba(34, 197, 94, 0.3);
            border-radius: 10px;
            font-size: 14px;
            color: #86efac;
        }
        
        /* increased left padding for better placeholder spacing */
        input, select, textarea {
            background: rgba(10, 10, 10, 0.9);
            border: 1.5px solid rgba(80, 60, 45, 0.4);
            color: #f5f5f0;
            padding: 16px 20px;
            padding-left: 24px; /* <-- moved placeholders a bit to the right */
            border-radius: 12px;
            width: 100%;
            transition: all 0.3s ease;
            font-family: 'Inter', sans-serif;
        }

        /* fix select right padding to keep dropdown icon visible */
        select {
            padding-right: 45px;
        }
        
        input::placeholder, textarea::placeholder {
            color: rgba(165, 145, 115, 0.5);
            font-size: 14px;
        }
        
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #d4af37;
            box-shadow: 0 0 0 4px rgba(212, 175, 55, 0.12);
            background: rgba(20, 15, 12, 0.95);
        }
        
        .hero-image {
            width: 100%;
            height: 500px;
            object-fit: cover;
            border-radius: 24px;
            box-shadow: 0 30px 80px rgba(0, 0, 0, 0.6);
        }
        
        .spec-item {
            display: flex;
            justify-content: space-between;
            padding: 14px 0;
            border-bottom: 1px solid rgba(80, 60, 45, 0.25);
        }
        
        .spec-item:last-child {
            border-bottom: none;
        }
        
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .animate-fade-in {
            animation: fadeInUp 0.6s ease forwards;
        }
        
        .checkbox-container {
            display: flex;
            align-items: flex-start;
            gap: 14px;
            padding: 18px;
            background: rgba(10, 10, 10, 0.6);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 1px solid rgba(80, 60, 45, 0.2);
        }
        
        .checkbox-container:hover {
            background: rgba(212, 175, 55, 0.06);
            border-color: rgba(212, 175, 55, 0.3);
        }
        
        input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
            accent-color: #d4af37;
        }
        
        /* removed sticky from single summary and made sidebar sticky */
        /* .price-summary { position: sticky; top: 20px; } */ 

        .sidebar {
            position: sticky;
            top: 20px;
            align-self: start; /* keeps sidebar aligned at top of grid column */
        }
        
        .policies-card {
            position: relative;
        }
        
        /* Custom Date Picker Styles */
        .date-picker-container {
            position: relative;
        }
        
        .date-picker-input {
            cursor: pointer;
            position: relative;
        }
        
        .date-icon {
            position: absolute;
            right: 16px;
            top: 50%;
            transform: translateY(-50%);
            color: #f5f5f0;
            pointer-events: none;
        }
        
        .custom-calendar {
            position: absolute; /* will be positioned via JS relative to body */
            margin-top: 8px;
            background: linear-gradient(135deg, rgba(20, 15, 12, 0.98), rgba(30, 20, 15, 0.98));
            border: 2px solid rgba(212, 175, 55, 0.3);
            border-radius: 16px;
            padding: 20px;
            z-index: 99999; /* very high so it overlays everything */
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(20px);
        }
        
        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .calendar-nav {
            background: rgba(212, 175, 55, 0.1);
            border: 1px solid rgba(212, 175, 55, 0.3);
            color: #d4af37;
            padding: 8px 12px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .calendar-nav:hover {
            background: rgba(212, 175, 55, 0.2);
        }
        
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 8px;
        }
        
        .calendar-day-header {
            text-align: center;
            padding: 8px;
            color: #d4af37;
            font-weight: 600;
            font-size: 12px;
        }
        
        .calendar-day {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            background: rgba(20, 15, 12, 0.6);
            border: 1px solid rgba(80, 60, 45, 0.3);
        }
        
        .calendar-day:hover:not(.disabled):not(.empty) {
            background: rgba(212, 175, 55, 0.2);
            border-color: #d4af37;
        }
        
        .calendar-day.selected {
            background: linear-gradient(135deg, #d4af37, #c9a02c);
            color: #0a0a0a;
            font-weight: 700;
        }
        
        .calendar-day.disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }
        
        .calendar-day.empty {
            background: transparent;
            border: none;
            cursor: default;
        }
        
        select {
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23f5f5f0' d='M6 9L1 4h10z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 16px center;
            /* padding-right set above */
        }

        .calendar-nav.disabled {
           opacity: 0.35;
           pointer-events: none;
        }

        /* Override mirato e pi√π specifico per forzare padding sul testo e placeholder */
.date-picker-container input.date-picker-input,
.glass-card input[type="text"],
.glass-card input[type="email"],
.glass-card input[type="tel"],
.glass-card select,
.glass-card textarea {
  box-sizing: border-box !important;
  padding-top: 16px !important;
  padding-bottom: 16px !important;
  padding-right: 20px !important;
  padding-left: 15px !important; /* aumenta qui se vuoi pi√π spazio */
}

/* Select: mantieni icona e spingi il testo da sinistra */
.glass-card select {
  padding-left: 15px !important;
  padding-right: 48px !important; /* lascia spazio per l'icona a destra */
}

/* Ensuring placeholder cross-browser visibility (optional) */
.glass-card input::placeholder,
.glass-card textarea::placeholder {
  color: rgba(165,145,115,0.5) !important;
  opacity: 1 !important; /* alcuni browser applicano opacity ridotta */
}

/* Forza colore testo (se qualche regola lo sovrascrive) */
.glass-card input,
.glass-card select,
.glass-card textarea {
  color: #f5f5f0 !important;
}

/* Caso estremo: se ancora non funziona, usa selettori pi√π specifici con attributi */
input[placeholder="Il tuo nome"],
input[placeholder="Il tuo cognome"],
input[placeholder="tua@email.com"],
input[placeholder="+39 123 456 7890"],
textarea[placeholder="Hai richieste particolari?"] {
  padding-left: 15px !important;
  box-sizing: border-box !important;
}
    </style>
</head>
<body>
    <div class="container mx-auto px-4 py-8 max-w-7xl">
        <!-- Header -->
        <header class="mb-12 animate-fade-in">
            <div class="flex items-center justify-between mb-6">
                <button onclick="window.history.back()" class="btn-secondary">
                    ‚Üê Indietro
                </button>
                <div class="text-right">
                    <div class="text-sm badge-text" style="color: #d4af37;">Esperienza Esclusiva</div>
                </div>
            </div>
            <h1 class="text-5xl md:text-6xl font-bold gradient-text mb-4 hero-title">Prenota il Tuo Test Drive</h1>
            <p class="text-xl hero-subtitle" style="color: #c9a891;">Un'esperienza indimenticabile ti aspetta</p>
        </header>

        <div class="grid lg:grid-cols-3 gap-8">
            <!-- Main Content -->
            <div class="lg:col-span-2 space-y-8">
                <!-- Car Hero Section -->
                <div class="glass-card p-8 animate-fade-in">
                    <img src="https://images.unsplash.com/photo-1605559424843-9e4c228bf1c2?w=1200&h=500&fit=crop" alt="Ferrari SF90" class="hero-image mb-6">
                    
                    <div class="flex items-start justify-between mb-6">
                        <div>
                            <h2 class="text-4xl font-bold mb-2 product-title">Ferrari SF90 Stradale</h2>
                            <div class="flex items-center gap-2 product-location" style="color: #c9a891;">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                   <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/>
                                   <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/>
                                </svg>
                                Milano, Italia
                            </div>
                        </div>
                        <div class="text-right">
                           <div class="text-3xl font-bold gradient-text product-price">‚Ç¨890</div>
                           <div class="text-sm price-label" style="color: #a59173;">da / esperienza</div>
                        </div>
                    </div>

                    <!-- Features -->
                    <div class="flex flex-wrap gap-3 mb-6 benefit-badges">
                        <!-- Popolato dinamicamente -->
                    </div>

                    <p style="color: #c9a891;" class="leading-relaxed mb-6 product-description">
                        La SF90 Stradale rappresenta l'apice dell'innovazione Ferrari, combinando un motore V8 biturbo da 780 CV con tre motori elettrici per una potenza totale di 1000 CV. Un capolavoro di ingegneria che ridefinisce il concetto di supercar ibrida.
                    </p>

                    <!-- Technical Specs -->
                    <div class="grid md:grid-cols-2 gap-6">
                        <div class="glass-card p-6">
                            <h3 class="text-xl font-bold mb-4 gradient-text table-1-title">Prestazioni</h3>
                            <div class="space-y-2 table-1-body">
                                 <!-- Popolato dinamicamente -->
                            </div>
                        </div>

                        <div class="glass-card p-6">
                            <h3 class="text-xl font-bold mb-4 gradient-text table-2-title">Caratteristiche</h3>
                            <div class="space-y-2 table-2-body">
                                 <!-- Popolato dinamicamente -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Distance Selection -->
                <div class="glass-card p-8 animate-fade-in">
                    <h3 class="text-2xl font-bold mb-6">Scegli il Tuo Percorso</h3>
                    <div class="grid md:grid-cols-3 gap-4" id="distanceOptions">
                        <div class="distance-option" data-km="10" data-price="890">
                            <div class="text-2xl font-bold gradient-text mb-2">10 km</div>
                            <div class="text-xl font-semibold mb-1">‚Ç¨890</div>
                            <div class="text-sm" style="color: #a59173;">Esperienza rapida</div>
                        </div>
                        <div class="distance-option" data-km="20" data-price="1290">
                            <div class="text-2xl font-bold gradient-text mb-2">20 km</div>
                            <div class="text-xl font-semibold mb-1">‚Ç¨1.290</div>
                            <div class="text-sm" style="color: #a59173;">Pi√π popolare</div>
                        </div>
                        <div class="distance-option" data-km="30" data-price="1690">
                            <div class="text-2xl font-bold gradient-text mb-2">30 km</div>
                            <div class="text-xl font-semibold mb-1">‚Ç¨1.690</div>
                            <div class="text-sm" style="color: #a59173;">Esperienza completa</div>
                        </div>
                        <div class="distance-option" data-km="60" data-price="2990">
                            <div class="text-2xl font-bold gradient-text mb-2">60 km</div>
                            <div class="text-xl font-semibold mb-1">‚Ç¨2.990</div>
                            <div class="text-sm" style="color: #a59173;">Tour esteso</div>
                        </div>
                        <div class="distance-option" data-km="70" data-price="3490">
                            <div class="text-2xl font-bold gradient-text mb-2">70 km</div>
                            <div class="text-xl font-semibold mb-1">‚Ç¨3.490</div>
                            <div class="text-sm" style="color: #a59173;">Avventura lunga</div>
                        </div>
                        <div class="distance-option" data-km="120" data-price="5990">
                            <div class="text-2xl font-bold gradient-text mb-2">120 km</div>
                            <div class="text-xl font-semibold mb-1">‚Ç¨5.990</div>
                            <div class="text-sm" style="color: #a59173;">Esperienza definitiva</div>
                        </div>
                    </div>
                </div>

                <!-- Second Car Option -->
                <div class="glass-card p-8 animate-fade-in">
                    <h3 class="text-2xl font-bold mb-4">Aggiungi Una Seconda Supercar</h3>
                    <p style="color: #c9a891;" class="mb-6">Vivi un'esperienza ancora pi√π straordinaria combinando due vetture iconiche</p>
                    
                    <label class="checkbox-container">
                        <input type="checkbox" id="secondCarCheckbox">
                        <div id="supercarComboContent">
                            <div class="font-semibold mb-1" id="supercarComboTitle">Aggiungi Supercar</div>
                            <div class="text-sm" style="color: #a59173;" id="supercarComboPrice">‚Ç¨0 aggiuntivi</div>
                        </div>
                    </label>

                    <!-- ‚úÖ NUOVA SEZIONE: Servizi aggiuntivi (disponibili anche per singole supercar) -->
                    <div class="glass-card p-8 animate-fade-in" id="extraServicesSection" style="display: none;">
                         <h3 class="text-2xl font-bold mb-4 gradient-text">Servizi Aggiuntivi Disponibili</h3>
                         <p style="color: #c9a891;" class="mb-6">Rendi la tua esperienza ancora pi√π memorabile</p>
    
                         <div class="space-y-4" id="extraServicesContainer">
                             <!-- Popolato dinamicamente -->
                         </div>
                    </div>
                </div>

                <!-- Date and Time -->
                <div class="glass-card p-8 animate-fade-in">
                    <h3 class="text-2xl font-bold mb-6">Data e Orario</h3>
                    <div class="grid md:grid-cols-2 gap-6">
                        <div class="date-picker-container">
                            <label class="block text-sm font-medium mb-2" style="color: #c9a891;">Data</label>
                            <div style="position: relative;">
                                <input type="text" id="bookingDate" class="date-picker-input" placeholder="Seleziona data" readonly required>
                                <svg class="date-icon w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                                </svg>
                            </div>
                            <!-- calendar is now rendered/positioned via JS into body -->
                            <p class="text-xs mt-2" style="color: #a59173;">Prenotazione da 48-72 ore prima, fino a 6 mesi</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2" style="color: #c9a891;">Orario</label>
                            <select id="bookingTime" required>
                                <option value="">Seleziona orario</option>
                                <option value="09:00">09:00</option>
                                <option value="10:00">10:00</option>
                                <option value="11:00">11:00</option>
                                <option value="14:00">14:00</option>
                                <option value="15:00">15:00</option>
                                <option value="16:00">16:00</option>
                                <option value="17:00">17:00</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Personal Information -->
                <div class="glass-card p-8 animate-fade-in">
                    <h3 class="text-2xl font-bold mb-6">I Tuoi Dati</h3>
                    <div class="grid md:grid-cols-2 gap-6">
                        <div>
                            <label class="block text-sm font-medium mb-2" style="color: #c9a891;">Nome</label>
                            <input type="text" placeholder="Il tuo nome" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2" style="color: #c9a891;">Cognome</label>
                            <input type="text" placeholder="Il tuo cognome" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2" style="color: #c9a891;">Email</label>
                            <input type="email" placeholder="tua@email.com" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2" style="color: #c9a891;">Telefono</label>
                            <input type="tel" placeholder="+39 123 456 7890" required>
                        </div>
                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium mb-2" style="color: #c9a891;">Note Aggiuntive (opzionale)</label>
                            <textarea rows="3" placeholder="Hai richieste particolari?"></textarea>
                        </div>
                    </div>
                </div>

                <!-- Terms -->
                <div class="glass-card p-6 animate-fade-in">
                    <label class="checkbox-container">
                        <input type="checkbox" id="termsCheckbox" required>
                        <div class="text-sm" style="color: #c9a891;">
                            Accetto i <a href="#" class="text-[#d4af37] hover:underline">termini e condizioni</a> e la 
                            <a href="#" class="text-[#d4af37] hover:underline">politica sulla privacy</a>
                        </div>
                    </label>
                </div>
            </div>

            <!-- Sidebar - Price Summary -->
            <div class="lg:col-span-1 sidebar"> <!-- <-- wrapper reso sticky -->
                <div class="glass-card p-8 price-summary animate-fade-in">
                    <h3 class="text-2xl font-bold mb-6 gradient-text">Riepilogo</h3>
                    
                    <div class="space-y-4 mb-6 pb-6 border-b" style="border-color: rgba(80, 60, 45, 0.3);">
                        <div class="flex justify-between">
                           <span style="color: #c9a891;" class="summary-product-title">Ferrari SF90 Stradale</span>
                           <span class="font-semibold" id="basePrice">‚Ç¨0</span>
                        </div>
                        <div class="flex justify-between hidden" id="secondCarPrice">
                            <span style="color: #c9a891;">Lamborghini Hurac√°n</span>
                            <span class="font-semibold">‚Ç¨1.490</span>
                        </div>
                        <div id="extraServicesPrice" class="space-y-2"></div>
                    </div>

                    <div class="space-y-3 mb-6 summary-benefits">
                         <!-- Popolato dinamicamente -->
                    </div>

                    <div class="p-4 rounded-lg mb-6" style="background: linear-gradient(to right, rgba(212, 175, 55, 0.12), transparent);">
                        <div class="flex justify-between items-center">
                            <span class="text-lg font-semibold">Totale</span>
                            <span class="text-3xl font-bold gradient-text" id="totalPrice">‚Ç¨0</span>
                        </div>
                    </div>

                    <button class="btn-primary w-full" onclick="confirmBooking()">
                        Conferma Prenotazione
                    </button>

                    <p class="text-xs text-center mt-4" style="color: #a59173;">
                        Prenotazione sicura e protetta
                    </p>
                </div>

                <!-- Policies -->
                <div class="glass-card p-6 mt-6 animate-fade-in policies-card">
                   <h4 class="font-semibold mb-4 gradient-text">Politiche</h4>
                   <div class="space-y-3 text-sm" style="color: #c9a891;" id="politicheContainer">
                       <!-- ‚úÖ Popolato dinamicamente -->
                   </div>
                </div>
            </div>
        </div>
    </div>

    <script>
    // ========================================
    // CONFIGURAZIONE GLOBALE
    // ========================================
    const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbwr79RkXIEocpuOKaM6uMJqE6VFs9wjlUPvrr__FvDbDDrD2ELB1NbfrWP3BCYpHj2u/exec';
    
    let bookingData = {
        sku: null,
        productData: null,
        distance: null,
        basePrice: 0,
        secondCar: false,
        extraServices: [],
        total: 0,
        selectedDate: null
    };

    // Set min and max dates
    const now = new Date();
    const minDateTime = new Date(now.getTime() + 48 * 60 * 60 * 1000);
    const minDate = new Date(minDateTime.getFullYear(), minDateTime.getMonth(), minDateTime.getDate());
    const maxDate = new Date(now);
    maxDate.setMonth(maxDate.getMonth() + 6);
    const earliestAllowed = new Date(now.getFullYear(), now.getMonth() - 2, 1);

    // ========================================
    // INIZIALIZZAZIONE PAGINA
    // ========================================
    window.addEventListener('DOMContentLoaded', async () => {
        // 1. Estrai SKU dall'URL
        const urlParams = new URLSearchParams(window.location.search);
        const sku = urlParams.get('sku');
        
        if (!sku) {
            alert('Errore: SKU prodotto mancante');
            window.history.back();
            return;
        }
        
        bookingData.sku = sku;
        
        // 2. Mostra loader
        showPageLoader();
        
        // 3. Fetch dati prodotto
        try {
            const productData = await fetchProductDetails(sku);
            bookingData.productData = productData;
            
            // 4. Renderizza pagina dinamicamente
            renderPage(productData);
            
            // 5. Inizializza componenti interattivi
            initializeComponents(productData);
            
        } catch (error) {
            console.error('Errore caricamento prodotto:', error);
            alert('Impossibile caricare i dettagli del prodotto. Riprova.');
            window.history.back();
        } finally {
            hidePageLoader();
        }
    });

    // ========================================
    // FETCH DATI BACKEND
    // ========================================
    async function fetchProductDetails(sku) {
        const url = `${WEB_APP_URL}?action=get_bookable_product_details&sku=${encodeURIComponent(sku)}&t=${Date.now()}`;
        
        const response = await fetch(url);
        const data = await response.json();
        
        if (!data.success) {
            throw new Error(data.error || 'Errore recupero dati');
        }
        
        return data.product;
    }

    // ========================================
    // RENDERING DINAMICO PAGINA
    // ========================================
    function renderPage(product) {
        const config = product.typeConfig;
        
        // 1. HEADER
        document.querySelector('.hero-title').textContent = config.pageTitle;
        document.querySelector('.hero-subtitle').textContent = config.pageSubtitle;
        document.querySelector('.badge-text').textContent = config.badge;
        
        // 2. IMMAGINE HERO
        const heroImg = document.querySelector('.hero-image');
        if (product.mainImage) {
            heroImg.src = product.mainImage;
            heroImg.alt = product.title;
        }
        
        // 3. DETTAGLI PRODOTTO
        document.querySelectorAll('.product-title').forEach(el => {
            el.textContent = product.title;
        });
        
        document.querySelector('.product-location').innerHTML = `
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/>
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/>
            </svg>
            ${product.luogo}
        `;
        
        // 4. PREZZO
        const priceEl = document.querySelector('.product-price');
        const priceLabelEl = document.querySelector('.price-label');
        
        if (config.showDynamicPrice) {
            priceEl.textContent = `‚Ç¨${product.price.toLocaleString()}`;
            priceLabelEl.textContent = config.priceLabel;
        } else {
            priceEl.textContent = config.fixedPrice;
            priceLabelEl.textContent = config.priceLabel;
        }
        
        // 5. BENEFIT (primi 3 come badge)
        const benefitContainer = document.querySelector('.benefit-badges');
        benefitContainer.innerHTML = '';
        
        product.benefit.slice(0, 3).forEach(benefit => {
            benefitContainer.innerHTML += `
                <span class="feature-badge">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                    ${benefit}
                </span>
            `;
        });
        
        // 6. DESCRIZIONE (usa campo 'desc' completo per booking.html)
        document.querySelector('.product-description').textContent = product.desc;
        
        // 7. TABELLA PRESTAZIONI
        const table1Title = document.querySelector('.table-1-title');
        const table1Body = document.querySelector('.table-1-body');
        
        table1Title.textContent = config.tables.first.title;
        table1Body.innerHTML = '';
        
        product.prestazioni.forEach((value, index) => {
            const label = config.tables.first.labels[index] || `Campo ${index + 1}`;
            table1Body.innerHTML += `
                <div class="spec-item">
                    <span style="color: #a59173;">${label}</span>
                    <span class="font-semibold">${value}</span>
                </div>
            `;
        });
        
        // 8. TABELLA CARATTERISTICHE
        const table2Title = document.querySelector('.table-2-title');
        const table2Body = document.querySelector('.table-2-body');
        
        table2Title.textContent = config.tables.second.title;
        table2Body.innerHTML = '';
        
        product.caratteristiche.forEach((value, index) => {
            const label = config.tables.second.labels[index] || `Campo ${index + 1}`;
            table2Body.innerHTML += `
                <div class="spec-item">
                    <span style="color: #a59173;">${label}</span>
                    <span class="font-semibold">${value}</span>
                </div>
            `;
        });
        
        // 9. ORARI DISPONIBILI (con debug)
        const timeSelect = document.getElementById('bookingTime');
        if (timeSelect) {
          timeSelect.innerHTML = '<option value="">Seleziona orario</option>';
    
          console.log('üìÖ Orari ricevuti:', product.orari);
    
          if (product.orari && Array.isArray(product.orari) && product.orari.length > 0) {
              product.orari.forEach(orario => {
                  if (orario) {
                      console.log('  ‚úÖ Aggiunto orario:', orario);
                      timeSelect.innerHTML += `<option value="${orario}">${orario}</option>`;
                  }
              });
          } else {
              console.warn('‚ö†Ô∏è Nessun orario disponibile per questo prodotto');
              // Fallback: orari predefiniti
              const defaultTimes = ['09:00', '10:00', '11:00', '14:00', '15:00', '16:00', '17:00'];
              defaultTimes.forEach(time => {
                timeSelect.innerHTML += `<option value="${time}">${time}</option>`;
              });
          }
        }
        
        // 10. BENEFIT NEL RIEPILOGO (restanti)
        const summaryBenefits = document.querySelector('.summary-benefits');
        summaryBenefits.innerHTML = '';

        product.benefit.slice(3).forEach(benefit => {
           summaryBenefits.innerHTML += `
                <div class="flex items-center gap-2 text-sm" style="color: #c9a891;">
                   <svg class="w-5 h-5 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                   </svg>
                   ${benefit}
                </div>
           `;
        });

        // 11. SUPERCAR COMBO DINAMICA
        if (skuPrefix === 'SC' && product.supercarCombo && product.supercarCombo.length >= 2) {
            renderSupercarCombo(product);
        } else {
           // Nascondi sezione se non disponibile
           const secondCarSection = document.querySelector('.glass-card:has(#secondCarCheckbox)');
           if (secondCarSection) secondCarSection.style.display = 'none';
        }

        // 12. AGGIORNA NOME PRODOTTO NEL RIEPILOGO (SIDEBAR)
        const summaryTitle = document.querySelector('.summary-product-title');
        if (summaryTitle) {
            summaryTitle.textContent = product.title;
        }

        // ‚úÖ 13. POLITICHE DINAMICHE
        renderPolitiche(product.politiche);

        // 14. GESTIONE PREZZO SU RICHIESTA PER IMMOBILI
        const isPriceOnRequest = !config.showDynamicPrice && config.fixedPrice === '‚Ç¨ ‚Äî';
        if (isPriceOnRequest) {
            // Nascondi sezione selezione percorso per IMMOBILI
            const distanceSection = document.querySelector('.glass-card:has(#distanceOptions)');
            if (distanceSection) distanceSection.style.display = 'none';
    
            // Nascondi checkbox seconda supercar (non applicabile a IMMOBILI)
            const secondCarSection = document.querySelector('.glass-card:has(#secondCarCheckbox)');
            if (secondCarSection) secondCarSection.style.display = 'none';
        }

        // 15. GESTIONE ESPERIENZE (EX) - Nascondi sezioni non applicabili
        const skuPrefix = product.sku.split('-')[0].toUpperCase();
        if (skuPrefix === 'EX') {
            // Nascondi "Scegli il tuo percorso"
            const distanceSection = document.querySelector('.glass-card:has(#distanceOptions)');
            if (distanceSection) distanceSection.style.display = 'none';
    
            // Nascondi "Aggiungi una seconda supercar"
            const secondCarSection = document.querySelector('.glass-card:has(#secondCarCheckbox)');
            if (secondCarSection) secondCarSection.style.display = 'none';
    
            // Imposta prezzo base dal prodotto (colonna Prezzo del foglio)
            bookingData.basePrice = product.price || 0;
        }

        // 16. GESTIONE SUPERCAR (SC) - Usa prezzo base prodotto
        if (skuPrefix === 'SC') {
            bookingData.basePrice = product.price || 0;
        }

        updatePriceSummary();
    }

    /**
     * Renderizza politiche dinamicamente
     * @param {Array} politiche - Array politiche dal foglio
     */
     function renderPolitiche(politiche) {
         const container = document.getElementById('politicheContainer');
         if (!container) return;
    
            container.innerHTML = '';
    
            if (!politiche || !Array.isArray(politiche) || politiche.length === 0) {
                container.innerHTML = '<div style="color: #a59173;">Politiche non disponibili</div>';
                return;
            }
    
            politiche.forEach(politica => {
                const parts = politica.split(':');
                if (parts.length < 2) return;
        
                const titolo = parts[0].trim();
                const descrizione = parts.slice(1).join(':').trim();
        
                const div = document.createElement('div');
                div.innerHTML = `
                   <strong style="color: #f5f5f0;">${titolo}:</strong> ${descrizione}
                `;
                container.appendChild(div);
            });
     }

    // ========================================
    // LOADER UTILITIES
    // ========================================
    function showPageLoader() {
        document.body.style.overflow = 'hidden';
        document.body.insertAdjacentHTML('beforeend', `
            <div id="pageLoader" style="position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(10,10,10,0.95); z-index: 99999; display: flex; align-items: center; justify-content: center;">
                <div style="text-align: center;">
                    <div style="width: 80px; height: 80px; border: 3px solid #2a2a2a; border-top-color: #D4AF37; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 20px;"></div>
                    <div style="color: #D4AF37; font-size: 16px; letter-spacing: 2px;">Caricamento...</div>
                </div>
            </div>
            <style>@keyframes spin { to { transform: rotate(360deg); }}</style>
        `);
    }

    function hidePageLoader() {
        const loader = document.getElementById('pageLoader');
        if (loader) {
            loader.style.opacity = '0';
            loader.style.transition = 'opacity 0.3s';
            setTimeout(() => loader.remove(), 300);
            document.body.style.overflow = '';
        }
    }

    // ========================================
    // INIZIALIZZAZIONE COMPONENTI
    // ========================================
    function initializeComponents(product) {
        const skuPrefix = product.sku.split('-')[0].toUpperCase();

        // ‚úÖ RENDERING PREZZI DINAMICI SUPERCAR
        if (skuPrefix === 'SC' && product.chilometraggio && product.chilometraggio.length > 0) {
            renderDynamicPricesForSupercar(product);
        }
    
        // Distance selection (solo per prodotti che NON sono EX o SC)
        document.querySelectorAll('.distance-option').forEach(option => {
            option.addEventListener('click', function() {
                document.querySelectorAll('.distance-option').forEach(opt => opt.classList.remove('selected'));
                this.classList.add('selected');
            
                bookingData.distance = this.dataset.km;
            
                // Per SC ed EX, non sovrascrivere il prezzo base con quello della distanza
                if (skuPrefix !== 'SC' && skuPrefix !== 'EX') {
                    bookingData.basePrice = parseInt(this.dataset.price);
                }
            
                updatePriceSummary();
            });
        });

        // Auto-select first distance option SOLO se non √® EX o SC
        if (skuPrefix !== 'EX' && skuPrefix !== 'SC') {
            const firstOption = document.querySelector('.distance-option');
            if (firstOption) {
                firstOption.classList.add('selected');
                bookingData.distance = firstOption.dataset.km;
                bookingData.basePrice = parseInt(firstOption.dataset.price);
                updatePriceSummary();
            }
        }

        // Second car checkbox
        const secondCarCheckbox = document.getElementById('secondCarCheckbox');
        if (secondCarCheckbox) {
            secondCarCheckbox.addEventListener('change', function() {
                bookingData.secondCar = this.checked;
                document.getElementById('extraServices').classList.toggle('hidden', !this.checked);
                document.getElementById('secondCarPrice').classList.toggle('hidden', !this.checked);
                
                if (!this.checked) {
                    document.querySelectorAll('.extra-service').forEach(cb => cb.checked = false);
                    bookingData.extraServices = [];
                }
                
                updatePriceSummary();
            });
        }

        // Extra services
        document.querySelectorAll('.extra-service').forEach(checkbox => {
            checkbox.addEventListener('change', function() {
                const price = parseInt(this.dataset.price);
                const service = this.dataset.service;
                
                if (this.checked) {
                    bookingData.extraServices.push({ service, price });
                } else {
                    bookingData.extraServices = bookingData.extraServices.filter(s => s.service !== service);
                }
                
                updatePriceSummary();
            });
        });

        // Initialize calendar
        initCalendar();

        // ‚úÖ Rendering servizi aggiuntivi
            renderExtraServices(product);

        // ‚úÖ GESTIONE VISIBILIT√Ä DINAMICA (Hurac√°n exception)
        // Rimuovi listener esistenti e aggiungi nuovo
        const checkbox = document.getElementById('secondCarCheckbox');
        if (checkbox) {
           // Clona il checkbox per rimuovere tutti i listener precedenti
           const newCheckbox = checkbox.cloneNode(true);
           checkbox.parentNode.replaceChild(newCheckbox, checkbox);
    
           // Aggiungi il nuovo listener
           newCheckbox.addEventListener('change', function() {
               bookingData.secondCar = this.checked;
               renderExtraServices(bookingData.productData);
               updatePriceSummary();
           });
        }
    }

    /**
     * Renderizza prezzi dinamici per SUPERCAR
     * @param {Object} product - Dati prodotto completi
     */
     function renderDynamicPricesForSupercar(product) {
        const distanceOptions = document.querySelectorAll('.distance-option');
        if (distanceOptions.length === 0) return;
    
            const prices = product.chilometraggio; // Array prezzi dal foglio
            const title = product.title.toLowerCase();
     
            // ‚úÖ LOGICA CASI SPECIALI
            let distanceValues = [10, 20, 30, 60, 70, 120]; // Default
            let distanceUnit = 'km';
    
            // CASO 1: Ferrari 458 Spider
            if (title.includes('ferrari 458 spider')) {
                distanceValues = [9, 16, 32, 65, 80, 100];
            }
            // CASO 2: McLaren 720s Performance  
            else if (title.includes('mclaren 720s performance')) {
                distanceValues = [10, 20, 30, 60, 90, 120];
                distanceUnit = 'min';
            }
            // CASO 3-4-5: Combo doppie supercar
            else if (title.includes('+') || product.supercarCombo) {
                distanceValues = [10, 20, 30, 60, 90, 120];
            }
    
            // ‚úÖ APPLICA VALORI ALLE CARD
            distanceOptions.forEach((option, index) => {
            if (index >= prices.length || index >= distanceValues.length) return;
        
                const distance = distanceValues[index];
                const price = parseFloat(prices[index]);
        
                if (isNaN(price)) return;
        
                // Aggiorna km/minuti
                const distanceEl = option.querySelector('.text-2xl');
                if (distanceEl) {
                   distanceEl.textContent = `${distance} ${distanceUnit}`;
                }
        
                // ‚úÖ Aggiorna prezzo con formattazione italiana
                const priceEl = option.querySelector('.text-xl');
                if (priceEl) {
                    priceEl.textContent = `‚Ç¨${formatItalianNumber(price)}`;
                }
        
                // Aggiorna data-price
                option.dataset.price = price;
        
                // ‚úÖ IMPORTANTE: Se √® la prima opzione, impostala come prezzo base
                if (index === 0) {
                    bookingData.basePrice = price;
                }
            });
    
            // Aggiorna riepilogo con primo prezzo
            updatePriceSummary();
    }

    /**
     * Renderizza Supercar Combo dinamicamente
     * @param {Object} product - Prodotto principale
     */
     async function renderSupercarCombo(product) {
        const comboSku = product.supercarCombo[0];
        const comboPrezzoTotale = parseFloat(product.supercarCombo[1]) || 0;
    
        if (!comboSku || !comboPrezzoTotale) {
            document.querySelector('.glass-card:has(#secondCarCheckbox)').style.display = 'none';
            return;
        }
    
        try {
            // Fetch dati supercar combo
            const comboData = await fetchProductDetails(comboSku);
        
            // Calcola prezzo aggiuntivo
            const prezzoAggiuntivo = comboPrezzoTotale - product.price;
        
            // Aggiorna UI
            document.getElementById('supercarComboTitle').textContent = 
                `Aggiungi ${comboData.title}`;
        
            document.getElementById('supercarComboPrice').textContent = 
                `‚Ç¨${formatItalianNumber(prezzoAggiuntivo)} aggiuntivi - Include servizi fotografici e video`;
        
            // Salva nei bookingData
            bookingData.comboAdditionalPrice = prezzoAggiuntivo;
        
           // Aggiorna logica checkbox
           const checkbox = document.getElementById('secondCarCheckbox');
              checkbox.addEventListener('change', function() {
                 if (this.checked) {
                     bookingData.secondCar = true;
                     bookingData.secondCarPrice = prezzoAggiuntivo;
                 } else {
                     bookingData.secondCar = false;
                     bookingData.secondCarPrice = 0;
                 }
                 updatePriceSummary();
              });
        
        } catch (e) {
            console.error('Errore caricamento combo:', e);
            document.querySelector('.glass-card:has(#secondCarCheckbox)').style.display = 'none';
        }
     }

    /**
 * Renderizza servizi aggiuntivi per SUPERCAR
 * @param {Object} product - Dati prodotto
 */
function renderExtraServices(product) {
    const section = document.getElementById('extraServicesSection');
    const container = document.getElementById('extraServicesContainer');
    
    if (!section || !container) return;
    
    const skuPrefix = product.sku.split('-')[0].toUpperCase();
    if (skuPrefix !== 'SC') return;
    
    const title = product.title.toLowerCase();
    
    // ‚úÖ ECCEZIONE: Lamborghini Hurac√°n Spyder (solo se combo)
    const isHuracan = title.includes('lamborghini') && title.includes('hurac√°n');
    
    if (isHuracan && !bookingData.secondCar) {
        section.style.display = 'none';
        return; // Non mostrare se √® singola
    }
    
    // Mostra sezione
    section.style.display = 'block';
    
    // ‚úÖ SERVIZI BASE
    const servizi = [
        {
            id: 'photo',
            title: 'Servizio Fotografico Professionale',
            desc: 'Servizio fotografico professionale durante l\'esperienza',
            price: 290
        },
        {
            id: 'video-hd',
            title: 'Video HD Professionale',
            desc: 'Video HD della tua esperienza di guida',
            price: 490
        },
        {
            id: 'video-360',
            title: 'Video 360¬∞ Immersivo',
            desc: 'Esperienza immersiva con video a 360 gradi',
            price: 690
        }
    ];
    
    // ‚úÖ NUOVO SERVIZIO: Passeggeri extra
    const seats = getSeatsFromCaratteristiche(product.caratteristiche);
    if (seats === 4) {
        servizi.push({
            id: 'extra-passengers',
            title: 'Passeggeri Extra (+2)',
            desc: 'Aggiungi fino a 2 passeggeri extra (‚Ç¨120 ciascuno)',
            price: 120,
            maxQty: 2
        });
    }
    
    // Renderizza HTML servizi
    container.innerHTML = '';
    servizi.forEach(servizio => {
        const maxQty = servizio.maxQty || 1;
        
        const serviceHTML = `
            <label class="checkbox-container">
                <input type="checkbox" class="extra-service" 
                       data-price="${servizio.price}" 
                       data-service="${servizio.id}"
                       ${maxQty > 1 ? 'data-max-qty="' + maxQty + '"' : ''}>
                <div style="flex: 1;">
                    <div class="font-semibold mb-1">${servizio.title}</div>
                    <div class="text-sm" style="color: #a59173;">${servizio.desc}</div>
                </div>
                <div style="text-align: right; color: #d4af37; font-weight: 600;">
                    +‚Ç¨${formatItalianNumber(servizio.price)}${maxQty > 1 ? ' cad.' : ''}
                </div>
            </label>
            ${maxQty > 1 ? `
                <div class="ml-12 mb-4" id="qty-${servizio.id}" style="display:none;">
                    <label class="text-sm" style="color: #c9a891;">Quantit√†:</label>
                    <select class="qty-selector" data-service="${servizio.id}" style="background: rgba(10,10,10,0.9); border: 1px solid rgba(212,175,55,0.3); color: #f5f5f0; padding: 0.5rem; border-radius: 8px; margin-left: 0.5rem;">
                        ${Array.from({length: maxQty}, (_, i) => `<option value="${i+1}">${i+1}</option>`).join('')}
                    </select>
                </div>
            ` : ''}
        `;
        
        container.insertAdjacentHTML('beforeend', serviceHTML);
    });
    
    // Event listeners
    container.querySelectorAll('.extra-service').forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            const price = parseFloat(this.dataset.price);
            const service = this.dataset.service;
            const maxQty = parseInt(this.dataset.maxQty) || 1;
            
            if (this.checked) {
                let qty = 1;
                
                // Mostra selettore qty se necessario
                if (maxQty > 1) {
                    const qtyDiv = document.getElementById(`qty-${service}`);
                    if (qtyDiv) qtyDiv.style.display = 'block';
                }
                
                bookingData.extraServices.push({ service, price, qty });
            } else {
                // Nascondi qty selector
                const qtyDiv = document.getElementById(`qty-${service}`);
                if (qtyDiv) qtyDiv.style.display = 'none';
                
                bookingData.extraServices = bookingData.extraServices.filter(s => s.service !== service);
            }
            
            updatePriceSummary();
        });
    });
    
    // Qty selectors
    container.querySelectorAll('.qty-selector').forEach(selector => {
        selector.addEventListener('change', function() {
            const service = this.dataset.service;
            const qty = parseInt(this.value);
            
            const serviceObj = bookingData.extraServices.find(s => s.service === service);
            if (serviceObj) {
                serviceObj.qty = qty;
                updatePriceSummary();
            }
        });
    });
}

/**
 * Helper: Estrae posti da array caratteristiche
 */
function getSeatsFromCaratteristiche(caratteristiche) {
    if (!caratteristiche || !Array.isArray(caratteristiche) || caratteristiche.length === 0) {
        return null;
    }
    const lastValue = caratteristiche[caratteristiche.length - 1];
    const seats = parseInt(lastValue);
    return !isNaN(seats) ? seats : null;
}

    /**
     * Helper: Formattazione italiana numeri
     */
      function formatItalianNumber(num) {
          return num.toLocaleString('it-IT');
    }

    // ========================================
    // PRICE SUMMARY UPDATE
    // ========================================
    function updatePriceSummary() {
        const isPriceOnRequest = bookingData.productData?.typeConfig && 
                                 !bookingData.productData.typeConfig.showDynamicPrice &&
                                  bookingData.productData.typeConfig.fixedPrice === '‚Ç¨ ‚Äî';
    
        if (isPriceOnRequest) {
            // Prezzo su richiesta per IMMOBILI
            document.getElementById('basePrice').textContent = '‚Ç¨ ‚Äî';
            document.getElementById('totalPrice').textContent = '‚Ç¨ ‚Äî';
            return; // Esce senza calcolare totali
        }
    
        // ASSICURA CHE IL PREZZO BASE SIA SEMPRE VALORIZZATO
        // Per SC ed EX, usa sempre il prezzo dal prodotto se non impostato
        if (!bookingData.basePrice && bookingData.productData) {
            const skuPrefix = bookingData.productData.sku.split('-')[0].toUpperCase();
            if (skuPrefix === 'SC' || skuPrefix === 'EX') {
                bookingData.basePrice = bookingData.productData.price || 0;
            }
        }
    
        let total = bookingData.basePrice;
    
        document.getElementById('basePrice').textContent = `‚Ç¨${formatItalianNumber(bookingData.basePrice)}`;
        
        if (bookingData.secondCar) {
            const comboPrice = bookingData.secondCarPrice || 1490; // Fallback
            total += comboPrice;
        }
        
        const extraServicesDiv = document.getElementById('extraServicesPrice');
        extraServicesDiv.innerHTML = '';
        
        bookingData.extraServices.forEach(service => {
           const qty = service.qty || 1;
           const serviceTotal = service.price * qty;
           total += serviceTotal;
    
           const serviceNames = {
               'photo': 'Servizio Fotografico',
               'video-hd': 'Video HD',
               'video-360': 'Video 360¬∞',
               'extra-passengers': `Passeggeri Extra (√ó${qty})`
           };
    
           const div = document.createElement('div');
           div.className = 'flex justify-between';
           div.innerHTML = `
               <span class="text-sm" style="color: #c9a891;">${serviceNames[service.service]}</span>
               <span class="font-semibold text-sm">‚Ç¨${formatItalianNumber(serviceTotal)}</span>
           `;
           extraServicesDiv.appendChild(div);
        });
        
        bookingData.total = total;
        document.getElementById('totalPrice').textContent = `‚Ç¨${formatItalianNumber(total)}`;
    }

    // ========================================
    // CONFERMA PRENOTAZIONE
    // ========================================
    function confirmBooking() {
        // ‚úÖ DICHIARAZIONE UNICA DI skuPrefix
        const skuPrefix = bookingData.productData?.sku.split('-')[0].toUpperCase();
        const requiresDistance = skuPrefix !== 'EX' && skuPrefix !== 'SC';
    
        // Validazione distanza (solo per prodotti che la richiedono)
        if (requiresDistance && !bookingData.distance) {
            alert('Seleziona un percorso prima di procedere');
            return;
        }
    
        const date = bookingData.selectedDate;
        const time = document.getElementById('bookingTime').value;
        const terms = document.getElementById('termsCheckbox').checked;
    
        if (!date || !time) {
            alert('Seleziona data e orario');
            return;
        }
    
        if (!terms) {
            alert('Accetta i termini e condizioni per procedere');
            return;
        }
    
        const formatted = date.toLocaleDateString('it-IT', {
            day: '2-digit',
            month: '2-digit',
            year: 'numeric'
        });
    
        const isPriceOnRequest = bookingData.productData?.typeConfig && 
                                 !bookingData.productData.typeConfig.showDynamicPrice;

        // ‚úÖ RIUTILIZZO skuPrefix (gi√† dichiarato sopra)
        const showDistance = skuPrefix !== 'EX' && skuPrefix !== 'SC' && bookingData.distance;

        const priceDisplay = isPriceOnRequest ? 'Su richiesta' : `‚Ç¨${bookingData.total.toLocaleString()}`;
        const distanceInfo = showDistance ? `- Percorso: ${bookingData.distance} km\n` : '';

        alert(`Prenotazione confermata!\n\nRiepilogo:\n- Prodotto: ${bookingData.productData.title}\n${distanceInfo}- Data: ${formatted} alle ${time}\n- Totale: ${priceDisplay}\n\nRiceverai una conferma via email.`);
    }

    // ========================================
    // CUSTOM CALENDAR
    // ========================================
    let currentMonth = new Date();
    const dateInput = document.getElementById('bookingDate');
    const calendar = document.createElement('div');
    calendar.id = 'customCalendar';
    calendar.className = 'custom-calendar';
    calendar.style.display = 'none';
    document.body.appendChild(calendar);

    function initCalendar() {
        dateInput.addEventListener('click', function(e) {
            e.stopPropagation();
            if (currentMonth < earliestAllowed) {
                currentMonth = new Date(earliestAllowed.getFullYear(), earliestAllowed.getMonth(), 1);
            }
            calendar.style.display = (calendar.style.display === 'none' || !calendar.style.display) ? 'block' : 'none';
            renderCalendar();
            positionCalendar();
        });

        document.addEventListener('click', function(e) {
            if (!calendar.contains(e.target) && e.target !== dateInput) {
                calendar.style.display = 'none';
            }
        });

        window.addEventListener('resize', () => {
            if (calendar.style.display === 'block') positionCalendar();
        });
        
        window.addEventListener('scroll', () => {
            if (calendar.style.display === 'block') positionCalendar();
        }, true);
    }

    function positionCalendar() {
        const rect = dateInput.getBoundingClientRect();
        const left = rect.left + window.scrollX;
        const top = rect.bottom + window.scrollY + 8;
        calendar.style.left = left + 'px';
        calendar.style.top = top + 'px';
        calendar.style.minWidth = rect.width + 'px';
        calendar.style.maxWidth = '480px';
    }

    function renderCalendar() {
        const year = currentMonth.getFullYear();
        const month = currentMonth.getMonth();
        
        const firstDay = new Date(year, month, 1);
        const lastDay = new Date(year, month + 1, 0);
        const daysInMonth = lastDay.getDate();
        const startingDayOfWeek = firstDay.getDay();

        const monthNames = ['Gennaio', 'Febbraio', 'Marzo', 'Aprile', 'Maggio', 'Giugno',
                          'Luglio', 'Agosto', 'Settembre', 'Ottobre', 'Novembre', 'Dicembre'];
        
        let html = `
            <div class="calendar-header">
                <button id="calendarPrevBtn" class="calendar-nav" onclick="previousMonth(event)">‚óÑ</button>
                <div class="text-lg font-bold gradient-text">${monthNames[month]} ${year}</div>
                <button id="calendarNextBtn" class="calendar-nav" onclick="nextMonth(event)">‚ñ∫</button>
            </div>
            <div class="calendar-grid">
                <div class="calendar-day-header">Dom</div>
                <div class="calendar-day-header">Lun</div>
                <div class="calendar-day-header">Mar</div>
                <div class="calendar-day-header">Mer</div>
                <div class="calendar-day-header">Gio</div>
                <div class="calendar-day-header">Ven</div>
                <div class="calendar-day-header">Sab</div>
        `;

        // Empty cells before first day
        for (let i = 0; i < startingDayOfWeek; i++) {
            html += '<div class="calendar-day empty"></div>';
        }

        // Days of the month
        for (let day = 1; day <= daysInMonth; day++) {
            const currentDate = new Date(year, month, day);
            const isDisabled = currentDate < minDate || currentDate > maxDate;
            const isSelected = bookingData.selectedDate && 
                             currentDate.toDateString() === bookingData.selectedDate.toDateString();
            
            const classes = ['calendar-day'];
            if (isDisabled) classes.push('disabled');
            if (isSelected) classes.push('selected');

            html += `<div class="${classes.join(' ')}" 
                         onclick="selectDate(${year}, ${month}, ${day}, ${isDisabled})">${day}</div>`;
        }

        html += '</div>';
        calendar.innerHTML = html;
        updateCalendarNavButtons();
    }

    function monthIsBefore(aYear, aMonth, bYear, bMonth) {
        return aYear < bYear || (aYear === bYear && aMonth < bMonth);
    }
    
    function monthIsAfter(aYear, aMonth, bYear, bMonth) {
        return aYear > bYear || (aYear === bYear && aMonth > bMonth);
    }

    function updateCalendarNavButtons() {
        const prev = document.getElementById('calendarPrevBtn');
        const next = document.getElementById('calendarNextBtn');
        if (!prev || !next) return;
        
        const displayYear = currentMonth.getFullYear();
        const displayMonth = currentMonth.getMonth();

        const earliestYear = earliestAllowed.getFullYear();
        const earliestMonth = earliestAllowed.getMonth();

        const maxYear = maxDate.getFullYear();
        const maxMonth = maxDate.getMonth();

        const canPrev = monthIsAfter(displayYear, displayMonth, earliestYear, earliestMonth);
        const canNext = monthIsBefore(displayYear, displayMonth, maxYear, maxMonth);

        if (canPrev) prev.classList.remove('disabled'); 
        else prev.classList.add('disabled');
        
        if (canNext) next.classList.remove('disabled'); 
        else next.classList.add('disabled');
    }

    function previousMonth(e) {
        e.preventDefault();
        e.stopPropagation();
        const curYear = currentMonth.getFullYear();
        const curMonth = currentMonth.getMonth();
        const earliestYear = earliestAllowed.getFullYear();
        const earliestMonth = earliestAllowed.getMonth();
        
        if (!(curYear > earliestYear || (curYear === earliestYear && curMonth > earliestMonth))) return;
        
        currentMonth.setMonth(curMonth - 1);
        renderCalendar();
        positionCalendar();
    }

    function nextMonth(e) {
        e.preventDefault();
        e.stopPropagation();
        const curYear = currentMonth.getFullYear();
        const curMonth = currentMonth.getMonth();
        const maxYear = maxDate.getFullYear();
        const maxMonth = maxDate.getMonth();
        
        if (!(curYear < maxYear || (curYear === maxYear && curMonth < maxMonth))) return;
        
        currentMonth.setMonth(curMonth + 1);
        renderCalendar();
        positionCalendar();
    }

    function selectDate(year, month, day, isDisabled) {
        if (isDisabled) return;
        
        bookingData.selectedDate = new Date(year, month, day);
        const formatted = bookingData.selectedDate.toLocaleDateString('it-IT', {
            day: '2-digit',
            month: '2-digit',
            year: 'numeric'
        });
        dateInput.value = formatted;
        calendar.style.display = 'none';
        renderCalendar();
    }

    // ========================================
    // ANIMATION ON SCROLL
    // ========================================
    const observerOptions = {
        threshold: 0.1,
        rootMargin: '0px 0px -50px 0px'
    };

    const observer = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
            if (entry.isIntersecting) {
                entry.target.style.opacity = '1';
                entry.target.style.transform = 'translateY(0)';
            }
        });
    }, observerOptions);

    document.querySelectorAll('.animate-fade-in').forEach(el => {
        el.style.opacity = '0';
        el.style.transform = 'translateY(30px)';
        el.style.transition = 'all 0.6s ease';
        observer.observe(el);
    });
</script>
</body>
</html>
