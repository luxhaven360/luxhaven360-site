<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prenota il Tuo Test Drive</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        // Suppress Tailwind CDN warning
        tailwind.config = {
            theme: {
                extend: {}
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600;700&family=Inter:wght@300;400;500;600&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #0a0a0a 0%, #1a1412 30%, #2d1810 60%, #0a0a0a 100%);
            min-height: 100vh;
            color: #f5f5f0;
        }
        
        h1, h2, h3 {
            font-family: 'Playfair Display', serif;
        }
        
        .gradient-text {
            background: linear-gradient(135deg, #d4af37 0%, #f4e4c1 30%, #c9a02c 60%, #e5c87f 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            background-size: 200% auto;
            animation: shimmer 3s linear infinite;
        }
        
        @keyframes shimmer {
            to {
                background-position: 200% center;
            }
        }
        
        .glass-card {
            background: rgba(20, 15, 12, 0.7);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(212, 175, 55, 0.15);
            border-radius: 24px;
            transition: all 0.4s ease;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
        }
        
        .glass-card:hover {
            border-color: rgba(212, 175, 55, 0.4);
            transform: translateY(-4px);
            box-shadow: 0 20px 60px rgba(212, 175, 55, 0.15);
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #d4af37 0%, #c9a02c 50%, #b8941f 100%);
            color: #0a0a0a;
            font-weight: 600;
            padding: 18px 40px;
            border: none;
            border-radius: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 16px;
            letter-spacing: 1px;
            text-transform: uppercase;
            box-shadow: 0 4px 20px rgba(212, 175, 55, 0.3);
        }
        
        .btn-primary:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 30px rgba(212, 175, 55, 0.5);
            background: linear-gradient(135deg, #e5c047 0%, #d4af37 50%, #c9a02c 100%);
        }
        
        .btn-secondary {
            background: rgba(212, 175, 55, 0.08);
            color: #d4af37;
            border: 1.5px solid #d4af37;
            padding: 12px 30px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
        }
        
        .btn-secondary:hover {
            background: rgba(212, 175, 55, 0.18);
            transform: translateX(-4px);
        }
        
        .distance-option {
            padding: 24px;
            border: 2px solid rgba(80, 60, 45, 0.4);
            border-radius: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            background: rgba(10, 10, 10, 0.6);
        }
        
        .distance-option:hover {
            border-color: rgba(212, 175, 55, 0.6);
            transform: scale(1.03);
            background: rgba(45, 24, 16, 0.4);
        }
        
        .distance-option.selected {
            border-color: #d4af37;
            background: linear-gradient(135deg, rgba(212, 175, 55, 0.15), rgba(201, 160, 44, 0.08));
            box-shadow: 0 0 30px rgba(212, 175, 55, 0.2);
        }
        
        .feature-badge {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 10px 18px;
            background: rgba(34, 197, 94, 0.08);
            border: 1px solid rgba(34, 197, 94, 0.3);
            border-radius: 10px;
            font-size: 14px;
            color: #86efac;
        }
        
        /* increased left padding for better placeholder spacing */
        input, select, textarea {
            background: rgba(10, 10, 10, 0.9);
            border: 1.5px solid rgba(80, 60, 45, 0.4);
            color: #f5f5f0;
            padding: 16px 20px;
            padding-left: 24px; /* <-- moved placeholders a bit to the right */
            border-radius: 12px;
            width: 100%;
            transition: all 0.3s ease;
            font-family: 'Inter', sans-serif;
        }

        /* fix select right padding to keep dropdown icon visible */
        select {
            padding-right: 45px;
        }
        
        input::placeholder, textarea::placeholder {
            color: rgba(165, 145, 115, 0.5);
            font-size: 14px;
        }
        
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #d4af37;
            box-shadow: 0 0 0 4px rgba(212, 175, 55, 0.12);
            background: rgba(20, 15, 12, 0.95);
        }
        
        .hero-image {
            width: 100%;
            height: 500px;
            object-fit: cover;
            border-radius: 24px;
            box-shadow: 0 30px 80px rgba(0, 0, 0, 0.6);
        }
        
        .spec-item {
            display: flex;
            justify-content: space-between;
            padding: 14px 0;
            border-bottom: 1px solid rgba(80, 60, 45, 0.25);
        }
        
        .spec-item:last-child {
            border-bottom: none;
        }
        
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .animate-fade-in {
            animation: fadeInUp 0.6s ease forwards;
        }
        
        .checkbox-container {
            display: flex;
            align-items: flex-start;
            gap: 14px;
            padding: 18px;
            background: rgba(10, 10, 10, 0.6);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 1px solid rgba(80, 60, 45, 0.2);
        }
        
        .checkbox-container:hover {
            background: rgba(212, 175, 55, 0.06);
            border-color: rgba(212, 175, 55, 0.3);
        }
        
        input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
            accent-color: #d4af37;
        }
        
        /* removed sticky from single summary and made sidebar sticky */
        /* .price-summary { position: sticky; top: 20px; } */ 

        .sidebar {
            position: sticky;
            top: 20px;
            align-self: start; /* keeps sidebar aligned at top of grid column */
        }
        
        .policies-card {
            position: relative;
        }
        
        /* Custom Date Picker Styles */
        .date-picker-container {
            position: relative;
        }
        
        .date-picker-input {
            cursor: pointer;
            position: relative;
        }
        
        .date-icon {
            position: absolute;
            right: 16px;
            top: 50%;
            transform: translateY(-50%);
            color: #f5f5f0;
            pointer-events: none;
        }
        
        .custom-calendar {
            position: absolute; /* will be positioned via JS relative to body */
            margin-top: 8px;
            background: linear-gradient(135deg, rgba(20, 15, 12, 0.98), rgba(30, 20, 15, 0.98));
            border: 2px solid rgba(212, 175, 55, 0.3);
            border-radius: 16px;
            padding: 20px;
            z-index: 99999; /* very high so it overlays everything */
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(20px);
        }
        
        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .calendar-nav {
            background: rgba(212, 175, 55, 0.1);
            border: 1px solid rgba(212, 175, 55, 0.3);
            color: #d4af37;
            padding: 8px 12px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .calendar-nav:hover {
            background: rgba(212, 175, 55, 0.2);
        }
        
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 8px;
        }
        
        .calendar-day-header {
            text-align: center;
            padding: 8px;
            color: #d4af37;
            font-weight: 600;
            font-size: 12px;
        }
        
        .calendar-day {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            background: rgba(20, 15, 12, 0.6);
            border: 1px solid rgba(80, 60, 45, 0.3);
        }
        
        .calendar-day:hover:not(.disabled):not(.empty) {
            background: rgba(212, 175, 55, 0.2);
            border-color: #d4af37;
        }
        
        .calendar-day.selected {
            background: linear-gradient(135deg, #d4af37, #c9a02c);
            color: #0a0a0a;
            font-weight: 700;
        }
        
        .calendar-day.disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }
        
        .calendar-day.empty {
            background: transparent;
            border: none;
            cursor: default;
        }
        
        select {
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23f5f5f0' d='M6 9L1 4h10z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 16px center;
            /* padding-right set above */
        }

        .calendar-nav.disabled {
           opacity: 0.35;
           pointer-events: none;
        }

        /* Override mirato e pi√π specifico per forzare padding sul testo e placeholder */
.date-picker-container input.date-picker-input,
.glass-card input[type="text"],
.glass-card input[type="email"],
.glass-card input[type="tel"],
.glass-card select,
.glass-card textarea {
  box-sizing: border-box !important;
  padding-top: 16px !important;
  padding-bottom: 16px !important;
  padding-right: 20px !important;
  padding-left: 15px !important; /* aumenta qui se vuoi pi√π spazio */
}

/* Select: mantieni icona e spingi il testo da sinistra */
.glass-card select {
  padding-left: 15px !important;
  padding-right: 48px !important; /* lascia spazio per l'icona a destra */
}

/* Ensuring placeholder cross-browser visibility (optional) */
.glass-card input::placeholder,
.glass-card textarea::placeholder {
  color: rgba(165,145,115,0.5) !important;
  opacity: 1 !important; /* alcuni browser applicano opacity ridotta */
}

/* Forza colore testo (se qualche regola lo sovrascrive) */
.glass-card input,
.glass-card select,
.glass-card textarea {
  color: #f5f5f0 !important;
}

/* Caso estremo: se ancora non funziona, usa selettori pi√π specifici con attributi */
input[placeholder="Il tuo nome"],
input[placeholder="Il tuo cognome"],
input[placeholder="tua@email.com"],
input[placeholder="+39 123 456 7890"],
textarea[placeholder="Hai richieste particolari?"] {
  padding-left: 15px !important;
  box-sizing: border-box !important;
}
    </style>
</head>
<body>
    <div class="container mx-auto px-4 py-8 max-w-7xl">
        <!-- Header -->
        <header class="mb-12 animate-fade-in">
            <div class="flex items-center justify-between mb-6">
                <button onclick="window.history.back()" class="btn-secondary">
                    ‚Üê Indietro
                </button>
                <div class="text-right">
                    <div class="text-sm badge-text" style="color: #d4af37;">Esperienza Esclusiva</div>
                </div>
            </div>
            <h1 class="text-5xl md:text-6xl font-bold gradient-text mb-4 hero-title">Prenota il Tuo Test Drive</h1>
            <p class="text-xl hero-subtitle" style="color: #c9a891;">Un'esperienza indimenticabile ti aspetta</p>
        </header>

        <div class="grid lg:grid-cols-3 gap-8">
            <!-- Main Content -->
            <div class="lg:col-span-2 space-y-8">
                <!-- Car Hero Section -->
                <div class="glass-card p-8 animate-fade-in">
                    <img src="https://images.unsplash.com/photo-1605559424843-9e4c228bf1c2?w=1200&h=500&fit=crop" alt="Ferrari SF90" class="hero-image mb-6">
                    
                    <div class="flex items-start justify-between mb-6">
                        <div>
                            <h2 class="text-4xl font-bold mb-2 product-title">Ferrari SF90 Stradale</h2>
                            <div class="flex items-center gap-2 product-location" style="color: #c9a891;">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                   <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/>
                                   <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/>
                                </svg>
                                Milano, Italia
                            </div>
                        </div>
                        <div class="text-right">
                           <div class="text-3xl font-bold gradient-text product-price">‚Ç¨890</div>
                           <div class="text-sm price-label" style="color: #a59173;">da / esperienza</div>
                        </div>
                    </div>

                    <!-- Features -->
                    <div class="flex flex-wrap gap-3 mb-6 benefit-badges">
                        <!-- Popolato dinamicamente -->
                    </div>

                    <p style="color: #c9a891;" class="leading-relaxed mb-6 product-description">
                        La SF90 Stradale rappresenta l'apice dell'innovazione Ferrari, combinando un motore V8 biturbo da 780 CV con tre motori elettrici per una potenza totale di 1000 CV. Un capolavoro di ingegneria che ridefinisce il concetto di supercar ibrida.
                    </p>

                    <!-- Technical Specs -->
                    <div class="grid md:grid-cols-2 gap-6">
                        <div class="glass-card p-6">
                            <h3 class="text-xl font-bold mb-4 gradient-text table-1-title">Prestazioni</h3>
                            <div class="space-y-2 table-1-body">
                                 <!-- Popolato dinamicamente -->
                            </div>
                        </div>

                        <div class="glass-card p-6">
                            <h3 class="text-xl font-bold mb-4 gradient-text table-2-title">Caratteristiche</h3>
                            <div class="space-y-2 table-2-body">
                                 <!-- Popolato dinamicamente -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Distance Selection -->
                <div class="glass-card p-8 animate-fade-in">
                    <h3 class="text-2xl font-bold mb-6">Scegli il Tuo Percorso</h3>
                    <div class="grid md:grid-cols-3 gap-4" id="distanceOptions">
                        <div class="distance-option" data-km="10" data-price="890">
                            <div class="text-2xl font-bold gradient-text mb-2">10 km</div>
                            <div class="text-xl font-semibold mb-1">‚Ç¨890</div>
                            <div class="text-sm" style="color: #a59173;">Esperienza rapida</div>
                        </div>
                        <div class="distance-option" data-km="20" data-price="1290">
                            <div class="text-2xl font-bold gradient-text mb-2">20 km</div>
                            <div class="text-xl font-semibold mb-1">‚Ç¨1.290</div>
                            <div class="text-sm" style="color: #a59173;">Pi√π popolare</div>
                        </div>
                        <div class="distance-option" data-km="30" data-price="1690">
                            <div class="text-2xl font-bold gradient-text mb-2">30 km</div>
                            <div class="text-xl font-semibold mb-1">‚Ç¨1.690</div>
                            <div class="text-sm" style="color: #a59173;">Esperienza completa</div>
                        </div>
                        <div class="distance-option" data-km="60" data-price="2990">
                            <div class="text-2xl font-bold gradient-text mb-2">60 km</div>
                            <div class="text-xl font-semibold mb-1">‚Ç¨2.990</div>
                            <div class="text-sm" style="color: #a59173;">Tour esteso</div>
                        </div>
                        <div class="distance-option" data-km="70" data-price="3490">
                            <div class="text-2xl font-bold gradient-text mb-2">70 km</div>
                            <div class="text-xl font-semibold mb-1">‚Ç¨3.490</div>
                            <div class="text-sm" style="color: #a59173;">Avventura lunga</div>
                        </div>
                        <div class="distance-option" data-km="120" data-price="5990">
                            <div class="text-2xl font-bold gradient-text mb-2">120 km</div>
                            <div class="text-xl font-semibold mb-1">‚Ç¨5.990</div>
                            <div class="text-sm" style="color: #a59173;">Esperienza definitiva</div>
                        </div>
                    </div>
                </div>

                <!-- Second Car Option -->
                <!-- ‚úÖ CARD 1: Aggiungi Seconda Supercar (solo per prodotti con combo) -->
<div class="glass-card p-8 animate-fade-in" id="secondCarSection" style="display: none;">
    <h3 class="text-2xl font-bold mb-4">Aggiungi Una Seconda Supercar</h3>
    <p style="color: #c9a891;" class="mb-6">Vivi un'esperienza ancora pi√π straordinaria combinando due vetture iconiche</p>
    
    <label class="checkbox-container">
        <input type="checkbox" id="secondCarCheckbox">
        <div>
            <div class="font-semibold mb-1">Aggiungi Seconda Supercar</div>
            <div class="text-sm" style="color: #a59173;">Include servizi fotografici e video</div>
        </div>
    </label>
</div>

<!-- ‚úÖ CARD 2: Servizi Aggiuntivi (sempre visibile per SC, tranne Hurac√°n) -->
<div class="glass-card p-8 animate-fade-in" id="extraServicesSection" style="display: none;">
    <div class="flex items-center justify-between mb-6">
        <div>
            <h3 class="text-2xl font-bold gradient-text">Servizi Aggiuntivi Disponibili</h3>
            <p style="color: #c9a891;" class="text-sm mt-2">Personalizza la tua esperienza con servizi esclusivi</p>
        </div>
        <div style="width: 60px; height: 60px; background: linear-gradient(135deg, rgba(212, 175, 55, 0.1), rgba(255, 215, 0, 0.05)); border: 2px solid rgba(212, 175, 55, 0.3); border-radius: 50%; display: flex; align-items: center; justify-content: center;">
            <svg style="width: 30px; height: 30px; color: #D4AF37;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z"/>
            </svg>
        </div>
    </div>
    
    <div id="extraServicesContainer" class="space-y-4">
        <!-- Checkbox servizi popolati dinamicamente qui -->
    </div>
</div>

                <!-- Date and Time -->
                <div class="glass-card p-8 animate-fade-in">
                    <h3 class="text-2xl font-bold mb-6">Data e Orario</h3>
                    <div class="grid md:grid-cols-2 gap-6">
                        <div class="date-picker-container">
                            <label class="block text-sm font-medium mb-2" style="color: #c9a891;">Data</label>
                            <div style="position: relative;">
                                <input type="text" id="bookingDate" class="date-picker-input" placeholder="Seleziona data" readonly required>
                                <svg class="date-icon w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                                </svg>
                            </div>
                            <!-- calendar is now rendered/positioned via JS into body -->
                            <p class="text-xs mt-2" style="color: #a59173;">Prenotazione da 48-72 ore prima, fino a 6 mesi</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2" style="color: #c9a891;">Orario</label>
                            <select id="bookingTime" required>
                                <option value="">Seleziona orario</option>
                                <option value="09:00">09:00</option>
                                <option value="10:00">10:00</option>
                                <option value="11:00">11:00</option>
                                <option value="14:00">14:00</option>
                                <option value="15:00">15:00</option>
                                <option value="16:00">16:00</option>
                                <option value="17:00">17:00</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Personal Information -->
                <div class="glass-card p-8 animate-fade-in">
                    <h3 class="text-2xl font-bold mb-6">I Tuoi Dati</h3>
                    <div class="grid md:grid-cols-2 gap-6">
                        <div>
                            <label class="block text-sm font-medium mb-2" style="color: #c9a891;">Nome</label>
                            <input type="text" placeholder="Il tuo nome" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2" style="color: #c9a891;">Cognome</label>
                            <input type="text" placeholder="Il tuo cognome" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2" style="color: #c9a891;">Email</label>
                            <input type="email" placeholder="tua@email.com" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2" style="color: #c9a891;">Telefono</label>
                            <input type="tel" placeholder="+39 123 456 7890" required>
                        </div>
                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium mb-2" style="color: #c9a891;">Note Aggiuntive (opzionale)</label>
                            <textarea rows="3" placeholder="Hai richieste particolari?"></textarea>
                        </div>
                    </div>
                </div>

                <!-- Terms -->
                <div class="glass-card p-6 animate-fade-in">
                    <label class="checkbox-container">
                        <input type="checkbox" id="termsCheckbox" required>
                        <div class="text-sm" style="color: #c9a891;">
                            Accetto i <a href="#" class="text-[#d4af37] hover:underline">termini e condizioni</a> e la 
                            <a href="#" class="text-[#d4af37] hover:underline">politica sulla privacy</a>
                        </div>
                    </label>
                </div>
            </div>

            <!-- Sidebar - Price Summary -->
            <div class="lg:col-span-1 sidebar"> <!-- <-- wrapper reso sticky -->
                <div class="glass-card p-8 price-summary animate-fade-in">
                    <h3 class="text-2xl font-bold mb-6 gradient-text">Riepilogo</h3>
                    
                    <div class="space-y-4 mb-6 pb-6 border-b" style="border-color: rgba(80, 60, 45, 0.3);">
                        <div class="flex justify-between">
                           <span style="color: #c9a891;" class="summary-product-title">Ferrari SF90 Stradale</span>
                           <span class="font-semibold" id="basePrice">‚Ç¨0</span>
                        </div>
                        
                        <div class="flex justify-between hidden" id="secondCarPrice">
                             <span style="color: #c9a891;" id="secondCarName">Seconda Supercar</span>
                             <span class="font-semibold" id="secondCarPriceAmount">‚Ç¨0</span>
                        </div>
                        <div id="extraServicesPrice" class="space-y-2"></div>
                    </div>

                    <div class="space-y-3 mb-6 summary-benefits">
                         <!-- Popolato dinamicamente -->
                    </div>

                    <div class="p-4 rounded-lg mb-6" style="background: linear-gradient(to right, rgba(212, 175, 55, 0.12), transparent);">
                        <div class="flex justify-between items-center">
                            <span class="text-lg font-semibold">Totale</span>
                            <span class="text-3xl font-bold gradient-text" id="totalPrice">‚Ç¨0</span>
                        </div>
                    </div>

                    <button class="btn-primary w-full" onclick="confirmBooking()">
                        Conferma Prenotazione
                    </button>

                    <p class="text-xs text-center mt-4" style="color: #a59173;">
                        Prenotazione sicura e protetta
                    </p>
                </div>

                <!-- Policies -->
                <div class="glass-card p-6 mt-6 animate-fade-in policies-card">
                    <h4 class="font-semibold mb-4 gradient-text">Politiche</h4>
                    <div class="space-y-3 text-sm" style="color: #c9a891;">
                        <div>
                            <strong style="color: #f5f5f0;">Rimborso:</strong> Rimborso completo fino a 48 ore prima della prenotazione.
                        </div>
                        <div>
                            <strong style="color: #f5f5f0;">Annullamento:</strong> Annullamento gratuito fino a 24 ore prima. Oltre tale termine, verr√† trattenuto il 50% dell'importo.
                        </div>
                        <div>
                            <strong style="color: #f5f5f0;">Cambio Data:</strong> Modifica gratuita della data fino a 72 ore prima dell'esperienza.
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
    // ========================================
    // CONFIGURAZIONE GLOBALE
    // ========================================
    const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbwr79RkXIEocpuOKaM6uMJqE6VFs9wjlUPvrr__FvDbDDrD2ELB1NbfrWP3BCYpHj2u/exec';

        // ========================================
// CONFIGURAZIONE PREZZI COMBO SUPERCAR
// ========================================
const COMBO_PRICING = {
    // California + Hurac√°n (entrambi gli ordini)
    'SC-001+SC-006': {
        km: [10, 20, 30, 60, 90, 120],
        prices: [176, 312, 424, 784, 1096, 1368],
        labels: ['Esperienza rapida', 'Pi√π popolare', 'Esperienza completa', 'Tour esteso', 'Avventura lunga', 'Esperienza definitiva']
    },
    'SC-006+SC-001': {
        km: [10, 20, 30, 60, 90, 120],
        prices: [176, 312, 424, 784, 1096, 1368],
        labels: ['Esperienza rapida', 'Pi√π popolare', 'Esperienza completa', 'Tour esteso', 'Avventura lunga', 'Esperienza definitiva']
    },
    
    // Portofino + Hurac√°n (entrambi gli ordini)
    'SC-002+SC-006': {
        km: [10, 20, 30, 60, 90, 120],
        prices: [208, 368, 528, 929, 1315, 1528],
        labels: ['Esperienza rapida', 'Pi√π popolare', 'Esperienza completa', 'Tour esteso', 'Avventura lunga', 'Esperienza definitiva']
    },
    'SC-006+SC-002': {
        km: [10, 20, 30, 60, 90, 120],
        prices: [208, 368, 528, 929, 1315, 1528],
        labels: ['Esperienza rapida', 'Pi√π popolare', 'Esperienza completa', 'Tour esteso', 'Avventura lunga', 'Esperienza definitiva']
    },
    
    // 488 Spider + Hurac√°n (entrambi gli ordini)
    'SC-003+SC-006': {
        km: [10, 20, 30, 60, 90, 120],
        prices: [224, 399, 575, 1040, 1460, 1800],
        labels: ['Esperienza rapida', 'Pi√π popolare', 'Esperienza completa', 'Tour esteso', 'Avventura lunga', 'Esperienza definitiva']
    },
    'SC-006+SC-003': {
        km: [10, 20, 30, 60, 90, 120],
        prices: [224, 399, 575, 1040, 1460, 1800],
        labels: ['Esperienza rapida', 'Pi√π popolare', 'Esperienza completa', 'Tour esteso', 'Avventura lunga', 'Esperienza definitiva']
    }
};

// ========================================
// CONFIGURAZIONE VALIDAZIONE EMAIL
// ========================================
const ALLOWED_EMAIL_PROVIDERS = [
    // Provider internazionali
    'gmail.com', 'yahoo.com', 'outlook.com', 'hotmail.com', 'live.com',
    'icloud.com', 'me.com', 'mac.com', 'protonmail.com', 'proton.me',
    'aol.com', 'zoho.com', 'mail.com', 'gmx.com', 'yandex.com',
    
    // Provider italiani
    'libero.it', 'virgilio.it', 'tiscali.it', 'alice.it', 'tin.it',
    'fastwebnet.it', 'tim.it', 'vodafone.it', 'wind.it', 'tre.it',
    'poste.it', 'email.it', 'pec.it', 'legalmail.it',
    
    // Provider aziendali comuni
    'outlook.it', 'hotmail.it', 'live.it', 'msn.com'
];

const TEMP_EMAIL_PATTERNS = [
    'tempmail', 'temp-mail', 'throwaway', 'disposable',
    '10minutemail', '10minute', 'guerrillamail', 'guerrilla',
    'mailinator', 'maildrop', 'sharklasers', 'getnada',
    'trashmail', 'fakeinbox', 'yopmail', 'mintemail',
    'dispostable', 'spamgourmet', 'mytemp', 'tempr'
];

/**
 * Valida email con provider check
 */
function validateEmail(email) {
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    
    if (!emailRegex.test(email)) {
        return { valid: false, message: 'Il formato dell\'indirizzo email non √® valido.' };
    }
    
    const domain = email.split('@')[1].toLowerCase();
    
    // Check email temporanee
    for (const pattern of TEMP_EMAIL_PATTERNS) {
        if (domain.includes(pattern)) {
            return { 
                valid: false, 
                message: 'Le email temporanee non sono consentite. Ti preghiamo di utilizzare un indirizzo email permanente e affidabile.' 
            };
        }
    }
    
    // Check provider noti
    if (!ALLOWED_EMAIL_PROVIDERS.includes(domain)) {
        return { 
            valid: false, 
            message: `Il provider "${domain}" non √® riconosciuto nel nostro sistema. Ti preghiamo di utilizzare un indirizzo email da un provider affidabile (es. Gmail, Outlook, Libero, Virgilio).` 
        };
    }
    
    return { valid: true };
}

/**
 * Mostra notifica errore elegante
 */
function showEmailError(message) {
    const toast = document.createElement('div');
    toast.style.cssText = `
        position: fixed;
        top: 30px;
        right: 30px;
        background: linear-gradient(135deg, rgba(20, 15, 12, 0.98), rgba(30, 20, 15, 0.98));
        backdrop-filter: blur(20px);
        color: #f5f5f0;
        padding: 24px 32px;
        border-radius: 16px;
        box-shadow: 0 20px 60px rgba(239, 68, 68, 0.3), 0 0 0 1px rgba(239, 68, 68, 0.2);
        z-index: 100000;
        font-size: 15px;
        max-width: 420px;
        border: 1.5px solid rgba(239, 68, 68, 0.4);
        animation: slideInRight 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
    `;
    
    toast.innerHTML = `
        <div style="display: flex; align-items: flex-start; gap: 16px;">
            <div style="flex-shrink: 0; width: 28px; height: 28px; background: rgba(239, 68, 68, 0.15); border-radius: 50%; display: flex; align-items: center; justify-content: center; border: 1.5px solid rgba(239, 68, 68, 0.4);">
                <svg style="width: 16px; height: 16px; color: #ef4444;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                </svg>
            </div>
            <div style="flex: 1;">
                <div style="font-weight: 600; margin-bottom: 6px; color: #D4AF37; font-size: 14px; text-transform: uppercase; letter-spacing: 1px;">Email Non Valida</div>
                <div style="line-height: 1.6; color: #c9a891;">${message}</div>
            </div>
        </div>
    `;
    
    // Aggiungi stile animazione
    if (!document.getElementById('toastAnimationStyle')) {
        const style = document.createElement('style');
        style.id = 'toastAnimationStyle';
        style.textContent = `
            @keyframes slideInRight {
                from {
                    opacity: 0;
                    transform: translateX(100px);
                }
                to {
                    opacity: 1;
                    transform: translateX(0);
                }
            }
        `;
        document.head.appendChild(style);
    }
    
    document.body.appendChild(toast);
    
    // Rimuovi dopo 5 secondi
    setTimeout(() => {
        toast.style.transition = 'opacity 0.4s ease, transform 0.4s ease';
        toast.style.opacity = '0';
        toast.style.transform = 'translateX(50px)';
        setTimeout(() => toast.remove(), 400);
    }, 5000);
}

// ========================================
// CONFIGURAZIONE PREFISSI INTERNAZIONALI
// ========================================
const COUNTRY_CODES = [
    { code: '+39', country: 'Italia', flag: 'üáÆüáπ', format: '### ### ####', maxLength: 10 },
    { code: '+1', country: 'Stati Uniti', flag: 'üá∫üá∏', format: '(###) ###-####', maxLength: 10 },
    { code: '+44', country: 'Regno Unito', flag: 'üá¨üáß', format: '#### ### ####', maxLength: 10 },
    { code: '+33', country: 'Francia', flag: 'üá´üá∑', format: '# ## ## ## ##', maxLength: 9 },
    { code: '+49', country: 'Germania', flag: 'üá©üá™', format: '### ########', maxLength: 11 },
    { code: '+34', country: 'Spagna', flag: 'üá™üá∏', format: '### ## ## ##', maxLength: 9 },
    { code: '+41', country: 'Svizzera', flag: 'üá®üá≠', format: '## ### ## ##', maxLength: 9 },
    { code: '+43', country: 'Austria', flag: 'üá¶üáπ', format: '#### ######', maxLength: 10 },
    { code: '+32', country: 'Belgio', flag: 'üáßüá™', format: '### ## ## ##', maxLength: 9 },
    { code: '+31', country: 'Paesi Bassi', flag: 'üá≥üá±', format: '## ########', maxLength: 9 },
    { code: '+351', country: 'Portogallo', flag: 'üáµüáπ', format: '### ### ###', maxLength: 9 },
    { code: '+30', country: 'Grecia', flag: 'üá¨üá∑', format: '### ### ####', maxLength: 10 },
    { code: '+353', country: 'Irlanda', flag: 'üáÆüá™', format: '## ### ####', maxLength: 9 },
    { code: '+45', country: 'Danimarca', flag: 'üá©üá∞', format: '## ## ## ##', maxLength: 8 },
    { code: '+46', country: 'Svezia', flag: 'üá∏üá™', format: '## ### ## ##', maxLength: 9 },
    { code: '+47', country: 'Norvegia', flag: 'üá≥üá¥', format: '### ## ###', maxLength: 8 },
    { code: '+358', country: 'Finlandia', flag: 'üá´üáÆ', format: '## ### ####', maxLength: 9 },
    { code: '+48', country: 'Polonia', flag: 'üáµüá±', format: '### ### ###', maxLength: 9 },
    { code: '+420', country: 'Rep. Ceca', flag: 'üá®üáø', format: '### ### ###', maxLength: 9 },
    { code: '+7', country: 'Russia', flag: 'üá∑üá∫', format: '### ###-##-##', maxLength: 10 },
    { code: '+86', country: 'Cina', flag: 'üá®üá≥', format: '### #### ####', maxLength: 11 },
    { code: '+81', country: 'Giappone', flag: 'üáØüáµ', format: '## #### ####', maxLength: 10 },
    { code: '+82', country: 'Corea del Sud', flag: 'üá∞üá∑', format: '## #### ####', maxLength: 10 },
    { code: '+91', country: 'India', flag: 'üáÆüá≥', format: '##### #####', maxLength: 10 },
    { code: '+61', country: 'Australia', flag: 'üá¶üá∫', format: '### ### ###', maxLength: 9 },
    { code: '+64', country: 'Nuova Zelanda', flag: 'üá≥üáø', format: '## ### ####', maxLength: 9 },
    { code: '+27', country: 'Sudafrica', flag: 'üáøüá¶', format: '## ### ####', maxLength: 9 },
    { code: '+55', country: 'Brasile', flag: 'üáßüá∑', format: '## #####-####', maxLength: 11 },
    { code: '+54', country: 'Argentina', flag: 'üá¶üá∑', format: '## ####-####', maxLength: 10 },
    { code: '+52', country: 'Messico', flag: 'üá≤üáΩ', format: '## #### ####', maxLength: 10 },
    { code: '+971', country: 'Emirati Arabi', flag: 'üá¶üá™', format: '## ### ####', maxLength: 9 },
    { code: '+966', country: 'Arabia Saudita', flag: 'üá∏üá¶', format: '## ### ####', maxLength: 9 },
    { code: '+90', country: 'Turchia', flag: 'üáπüá∑', format: '### ### ####', maxLength: 10 }
];

let selectedCountry = COUNTRY_CODES[0]; // Default: Italia

/**
 * Formatta numero telefono in base al paese selezionato
 */
function formatPhoneNumber(value, format) {
    // Rimuovi tutto tranne numeri
    const numbers = value.replace(/\D/g, '');
    
    let formatted = '';
    let numberIndex = 0;
    
    for (let i = 0; i < format.length && numberIndex < numbers.length; i++) {
        if (format[i] === '#') {
            formatted += numbers[numberIndex];
            numberIndex++;
        } else {
            formatted += format[i];
        }
    }
    
    return formatted;
}

/**
 * Inizializza selector prefisso telefonico
 */
function initPhoneSelector() {
    const phoneInput = document.querySelector('input[type="tel"]');
    if (!phoneInput) return;
    
    const container = phoneInput.parentElement;
    
    // Crea wrapper per input e selector
    const wrapper = document.createElement('div');
    wrapper.style.cssText = 'position: relative; display: flex; gap: 0;';
    
    // Crea selector prefisso
    const selector = document.createElement('div');
    selector.style.cssText = 'position: relative; z-index: 10;';
    
    // Crea selector con solo il button
    selector.innerHTML = `
        <button type="button" class="country-selector-btn" style="
            background: rgba(10, 10, 10, 0.9);
            border: 1.5px solid rgba(80, 60, 45, 0.4);
            border-right: none;
            color: #f5f5f0;
            padding: 16px 18px;
            border-radius: 12px 0 0 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            font-family: 'Inter', sans-serif;
            font-size: 15px;
            white-space: nowrap;
            min-width: 135px;
        ">
            <span class="selected-flag" style="font-size: 20px; line-height: 1; display: inline-flex; align-items: center; justify-content: center; height: 20px;">üáÆüáπ</span>
            <span class="selected-code" style="font-weight: 600; color: #D4AF37; font-size: 15px; line-height: 1; display: inline-flex; align-items: center; height: 20px;">+39</span>
            <svg class="w-4 h-4" style="width: 14px; height: 14px; margin-left: auto; color: #c9a891; transition: transform 0.3s;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
            </svg>
        </button>
    `;

    // Crea dropdown SEPARATO e appendilo al body
    const dropdown = document.createElement('div');
    dropdown.className = 'country-dropdown';
    dropdown.style.cssText = `
        display: none;
        position: fixed;
        background: linear-gradient(135deg, rgba(20, 15, 12, 0.98), rgba(30, 20, 15, 0.98));
        backdrop-filter: blur(20px);
        border: 2px solid rgba(212, 175, 55, 0.3);
        border-radius: 16px;
        padding: 12px;
        z-index: 999999;
        min-width: 320px;
        max-height: 400px;
        overflow-y: auto;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.8);
    `;

    dropdown.innerHTML = `
        <div style="padding: 8px 12px; margin-bottom: 8px;">
            <input type="text" placeholder="Cerca paese..." class="country-search" style="
                width: 100%;
                background: rgba(10, 10, 10, 0.6);
                border: 1px solid rgba(80, 60, 45, 0.4);
                color: #f5f5f0;
                padding: 10px 14px;
                border-radius: 10px;
                font-size: 14px;
                outline: none;
                transition: all 0.3s ease;
            " />
        </div>
        <div class="country-list">
            ${COUNTRY_CODES.map(c => `
                <div class="country-option" data-code="${c.code}" data-format="${c.format}" data-max="${c.maxLength}" style="
                    display: flex;
                    align-items: center;
                    gap: 12px;
                    padding: 12px 14px;
                    cursor: pointer;
                    border-radius: 10px;
                    transition: all 0.3s ease;
                    margin-bottom: 4px;
                ">
                    <span class="flag" style="font-size: 22px;">${c.flag}</span>
                    <span class="country-name" style="flex: 1; color: #f5f5f0; font-size: 14px;">${c.country}</span>
                    <span class="country-code" style="color: #D4AF37; font-weight: 600; font-size: 14px;">${c.code}</span>
                </div>
            `).join('')}
        </div>
    `;

    document.body.appendChild(dropdown);
    
    // Sostituisci struttura
    container.insertBefore(wrapper, phoneInput);
    wrapper.appendChild(selector);
    wrapper.appendChild(phoneInput);
    
    // ‚úÖ DEFINISCI VARIABILI DOPO AVER CREATO GLI ELEMENTI
    const btn = selector.querySelector('.country-selector-btn');
    const search = dropdown.querySelector('.country-search');
    
    // Aggiorna stile input telefono
    phoneInput.style.borderRadius = '0 12px 12px 0';
    phoneInput.style.borderLeft = '1.5px solid rgba(80, 60, 45, 0.4)';
    phoneInput.style.flex = '1';
    phoneInput.style.marginLeft = '0';
    phoneInput.placeholder = '123 456 7890';

    // Effetto hover coordinato
    btn.addEventListener('mouseenter', () => {
        btn.style.borderColor = 'rgba(212, 175, 55, 0.6)';
        phoneInput.style.borderColor = 'rgba(212, 175, 55, 0.6)';
    });

    btn.addEventListener('mouseleave', () => {
        if (!phoneInput.matches(':focus')) {
            btn.style.borderColor = 'rgba(80, 60, 45, 0.4)';
            phoneInput.style.borderColor = 'rgba(80, 60, 45, 0.4)';
        }
    });

    phoneInput.addEventListener('focus', () => {
        btn.style.borderColor = '#d4af37';
        phoneInput.style.borderColor = '#d4af37';
    });

    phoneInput.addEventListener('blur', () => {
        btn.style.borderColor = 'rgba(80, 60, 45, 0.4)';
        phoneInput.style.borderColor = 'rgba(80, 60, 45, 0.4)';
    });

    // Toggle dropdown
btn.addEventListener('click', (e) => {
    e.stopPropagation();
    const isVisible = dropdown.style.display === 'block';
    
    if (isVisible) {
        dropdown.style.display = 'none';
        btn.querySelector('svg').style.transform = 'rotate(0deg)';
    } else {
        // ‚úÖ POSIZIONAMENTO MIGLIORATO
        const rect = btn.getBoundingClientRect();
        
        // Imposta display prima per calcoli corretti
        dropdown.style.display = 'block';
        dropdown.style.visibility = 'hidden'; // Nascosto durante calcolo
        
        // Calcola posizione
        const left = rect.left + window.scrollX;
        const top = rect.bottom + window.scrollY + 8;
        
        dropdown.style.left = left + 'px';
        dropdown.style.top = top + 'px';
        dropdown.style.minWidth = Math.max(320, rect.width) + 'px';
        
        // Debug logging (rimuovi dopo test)
        console.log('üìç Dropdown position:', {
            left: left,
            top: top,
            btnRect: rect,
            dropdownDisplay: dropdown.style.display,
            dropdownZIndex: dropdown.style.zIndex
        });
        
        // Rendi visibile
        dropdown.style.visibility = 'visible';
        
        btn.querySelector('svg').style.transform = 'rotate(180deg)';
        
        search.value = '';
        setTimeout(() => search.focus(), 50); // Delay per iOS
        filterCountries('');
    }
});
    
    // Chiudi dropdown al click fuori
    document.addEventListener('click', (e) => {
        if (!dropdown.contains(e.target) && !btn.contains(e.target)) {
            dropdown.style.display = 'none';
            btn.querySelector('svg').style.transform = 'rotate(0deg)';
        }
    });

    // Riposiziona dropdown on scroll/resize
    window.addEventListener('resize', () => {
        if (dropdown.style.display === 'block') {
            const rect = btn.getBoundingClientRect();
            dropdown.style.left = rect.left + window.scrollX + 'px';
            dropdown.style.top = (rect.bottom + window.scrollY + 8) + 'px';
        }
    });

    window.addEventListener('scroll', () => {
        if (dropdown.style.display === 'block') {
            const rect = btn.getBoundingClientRect();
            dropdown.style.left = rect.left + window.scrollX + 'px';
            dropdown.style.top = (rect.bottom + window.scrollY + 8) + 'px';
        }
    }, true);
    
    // Ricerca paese
    search.addEventListener('input', (e) => {
        filterCountries(e.target.value.toLowerCase());
    });
    
    // Selezione paese
    dropdown.querySelectorAll('.country-option').forEach(option => {
        option.addEventListener('click', () => {
            const code = option.dataset.code;
            const format = option.dataset.format;
            const maxLength = parseInt(option.dataset.max);
            
            selectedCountry = COUNTRY_CODES.find(c => c.code === code);
            
            // Aggiorna UI selector
            btn.querySelector('.selected-flag').textContent = option.querySelector('.flag').textContent;
            btn.querySelector('.selected-code').textContent = code;
            
            // Reset e focus input
            phoneInput.value = '';
            phoneInput.focus();
            
            dropdown.style.display = 'none';
            btn.querySelector('svg').style.transform = 'rotate(0deg)';
        });
        
        // Hover effect
        option.addEventListener('mouseenter', () => {
            option.style.background = 'rgba(212, 175, 55, 0.15)';
        });
        
        option.addEventListener('mouseleave', () => {
            option.style.background = 'transparent';
        });
    });
    
    // Formattazione in tempo reale
    phoneInput.addEventListener('input', (e) => {
        let value = e.target.value.replace(/\D/g, '');
        
        // Limita lunghezza
        if (value.length > selectedCountry.maxLength) {
            value = value.substring(0, selectedCountry.maxLength);
        }
        
        // Applica formato
        e.target.value = formatPhoneNumber(value, selectedCountry.format);
    });
    
    // Previeni paste non numerici
    phoneInput.addEventListener('paste', (e) => {
        e.preventDefault();
        const pastedText = (e.clipboardData || window.clipboardData).getData('text');
        const numbers = pastedText.replace(/\D/g, '');
        
        if (numbers.length > selectedCountry.maxLength) {
            phoneInput.value = formatPhoneNumber(numbers.substring(0, selectedCountry.maxLength), selectedCountry.format);
        } else {
            phoneInput.value = formatPhoneNumber(numbers, selectedCountry.format);
        }
    });
    
    // Funzione filtro paesi
    function filterCountries(query) {
        dropdown.querySelectorAll('.country-option').forEach(option => {
            const country = option.querySelector('.country-name').textContent.toLowerCase();
            const code = option.querySelector('.country-code').textContent.toLowerCase();
            
            if (country.includes(query) || code.includes(query)) {
                option.style.display = 'flex';
            } else {
                option.style.display = 'none';
            }
        });
    }
}

// Aggiungi stile scroll personalizzato dropdown
const dropdownScrollStyle = document.createElement('style');
dropdownScrollStyle.textContent = `
    .country-dropdown::-webkit-scrollbar {
        width: 8px;
    }
    .country-dropdown::-webkit-scrollbar-track {
        background: rgba(10, 10, 10, 0.4);
        border-radius: 10px;
    }
    .country-dropdown::-webkit-scrollbar-thumb {
        background: rgba(212, 175, 55, 0.3);
        border-radius: 10px;
    }
    .country-dropdown::-webkit-scrollbar-thumb:hover {
        background: rgba(212, 175, 55, 0.5);
    }
    .country-search:focus {
        border-color: #D4AF37;
        box-shadow: 0 0 0 3px rgba(212, 175, 55, 0.15);
    }
    .country-selector-btn:hover {
        border-color: rgba(212, 175, 55, 0.6);
        background: rgba(20, 15, 12, 0.95);
    }

    .country-selector-btn:focus,
.country-selector-btn:focus-within {
    border-color: rgba(212, 175, 55, 0.6);
    background: rgba(20, 15, 12, 0.95);
}

input[type="tel"]:focus + .country-selector-btn {
    border-color: rgba(212, 175, 55, 0.6);
}
`;
document.head.appendChild(dropdownScrollStyle);

/**
 * Genera chiave combo da due SKU (ordine-indipendente)
 */
function getComboKey(sku1, sku2) {
    return `${sku1}+${sku2}`;
}

/**
 * Verifica se la combo corrente ha prezzi custom
 */
function hasCustomComboPricing() {
    if (!bookingData.secondCar || !bookingData.productData) {
        console.log('‚ùå Combo check fallito: dati mancanti');
        return false;
    }
    
    const mainSku = bookingData.productData.sku;
    const comboCheckbox = document.getElementById('secondCarCheckbox');
    
    if (!comboCheckbox) {
        console.log('‚ùå Checkbox combo non trovato');
        return false;
    }
    
    const comboSku = comboCheckbox.dataset.comboSku;
    if (!comboSku) {
        console.log('‚ùå Combo SKU non presente nel dataset');
        return false;
    }
    
    const comboKey = getComboKey(mainSku, comboSku);
    const hasCombo = COMBO_PRICING.hasOwnProperty(comboKey);
    
    console.log('üîç Combo check:', {
        mainSku,
        comboSku,
        comboKey,
        hasCombo
    });
    
    return hasCombo;
}

/**
 * Applica prezzi combo custom alla griglia distanze
 */
function applyComboDistancePricing() {
    const mainSku = bookingData.productData.sku;
    const comboCheckbox = document.getElementById('secondCarCheckbox');
    
    if (!comboCheckbox) return;
    
    const comboSku = comboCheckbox.dataset.comboSku;
    if (!comboSku) return;
    
    const comboKey = getComboKey(mainSku, comboSku);
    const comboPricing = COMBO_PRICING[comboKey];
    
    if (!comboPricing) {
        console.log('‚ö†Ô∏è Combo non speciale, prezzi standard mantenuti');
        return;
    }
    
    console.log(`‚úÖ Applicando prezzi combo per: ${comboKey}`);
    
    const distanceGrid = document.getElementById('distanceOptions');
    if (!distanceGrid) return;
    
    // Salva selezione corrente
    const currentSelection = document.querySelector('.distance-option.selected');
    const currentKm = currentSelection ? currentSelection.dataset.km : null;
    
    // Rigenera griglia con prezzi combo
    distanceGrid.innerHTML = '';
    
    comboPricing.km.forEach((km, index) => {
        const price = comboPricing.prices[index];
        const label = comboPricing.labels[index];
        
        const option = document.createElement('div');
        option.className = 'distance-option';
        option.dataset.km = km;
        option.dataset.price = price;
        
        option.innerHTML = `
            <div class="text-2xl font-bold gradient-text mb-2">${km} km</div>
            <div class="text-xl font-semibold mb-1">${formatPrice(price)}</div>
            <div class="text-sm" style="color: #a59173;">${label}</div>
        `;
        
        distanceGrid.appendChild(option);
    });
    
    // Re-bind listeners
    initDistanceSelection(bookingData.productData);
    
    // Ripristina selezione se possibile, altrimenti prima opzione
    let optionToSelect = null;
    
    if (currentKm) {
        optionToSelect = distanceGrid.querySelector(`[data-km="${currentKm}"]`);
    }
    
    if (!optionToSelect) {
        optionToSelect = distanceGrid.querySelector('.distance-option');
    }
    
    if (optionToSelect) {
        optionToSelect.click();
    }
}

/**
 * Ripristina prezzi originali del prodotto
 */
function restoreOriginalDistancePricing() {
    const product = bookingData.productData;
    if (!product) return;
    
    console.log('üîÑ Ripristino prezzi originali prodotto');
    
    const distanceGrid = document.getElementById('distanceOptions');
    if (!distanceGrid) return;
    
    // Salva selezione
    const currentSelection = document.querySelector('.distance-option.selected');
    const currentKm = currentSelection ? currentSelection.dataset.km : null;
    
    // Rigenera con prezzi originali
    distanceGrid.innerHTML = '';
    
    const distanceConfig = getDistanceConfigForProduct(product);
    
    distanceConfig.options.forEach((distance, index) => {
        if (index < product.chilometraggioPrices.length) {
            const price = product.chilometraggioPrices[index];
            
            const option = document.createElement('div');
            option.className = 'distance-option';
            option.dataset.km = distance.value;
            option.dataset.price = price;
            
            option.innerHTML = `
                <div class="text-2xl font-bold gradient-text mb-2">${distance.value} ${distance.unit}</div>
                <div class="text-xl font-semibold mb-1">${formatPrice(price)}</div>
                <div class="text-sm" style="color: #a59173;">${distance.label}</div>
            `;
            
            distanceGrid.appendChild(option);
        }
    });
    
    // Re-bind listeners
    initDistanceSelection(product);
    
    // Ripristina selezione
    let optionToSelect = null;
    
    if (currentKm) {
        optionToSelect = distanceGrid.querySelector(`[data-km="${currentKm}"]`);
    }
    
    if (!optionToSelect) {
        optionToSelect = distanceGrid.querySelector('.distance-option');
    }
    
    if (optionToSelect) {
        optionToSelect.click();
    }
}

    /**
 * Formatta il prezzo per booking.html
 * Output: "‚Ç¨1.265" (euro PRIMA del numero)
 */
function formatPrice(price, currency = 'EUR') {
    const amount = parseFloat(price) || 0;
    
    // Determina decimali
    let decimals = 0;
    if (amount < 100) decimals = 2;
    else if (amount < 500) decimals = 2;
    else if (amount < 1000) decimals = amount % 1 !== 0 ? 2 : 0;
    else decimals = 0;
    
    // Formatta manualmente
    let formatted = amount.toFixed(decimals);
    
    // Sostituisci punto decimale con virgola
    formatted = formatted.replace('.', ',');
    
    // Aggiungi separatore migliaia (punto)
    let parts = formatted.split(',');
    parts[0] = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, '.');
    
    // Simbolo valuta PRIMA del numero
    const symbol = currency === 'EUR' ? '‚Ç¨' : currency;
    
    return `${symbol}${parts.join(',')}`;
}
    
    let bookingData = {
        sku: null,
        productData: null,
        distance: null,
        basePrice: 0,
        secondCar: false,
        extraServices: [],
        total: 0,
        selectedDate: null
    };

    // Set min and max dates
    const now = new Date();
    const minDateTime = new Date(now.getTime() + 48 * 60 * 60 * 1000);
    const minDate = new Date(minDateTime.getFullYear(), minDateTime.getMonth(), minDateTime.getDate());
    const maxDate = new Date(now);
    maxDate.setMonth(maxDate.getMonth() + 6);
    const earliestAllowed = new Date(now.getFullYear(), now.getMonth() - 2, 1);

    // ========================================
    // INIZIALIZZAZIONE PAGINA
    // ========================================
    window.addEventListener('DOMContentLoaded', async () => {
        // 1. Estrai SKU dall'URL
        const urlParams = new URLSearchParams(window.location.search);
        const sku = urlParams.get('sku');
        
        if (!sku) {
            alert('Errore: SKU prodotto mancante');
            window.history.back();
            return;
        }
        
        bookingData.sku = sku;
        
        // 2. Mostra loader
        showPageLoader();
        
        // 3. Fetch dati prodotto
        try {
            const productData = await fetchProductDetails(sku);
            bookingData.productData = productData;
            
            // 4. Renderizza pagina dinamicamente
            renderPage(productData);
            
            // 5. Inizializza componenti interattivi
            initializeComponents(productData);
            
        } catch (error) {
            console.error('Errore caricamento prodotto:', error);
            alert('Impossibile caricare i dettagli del prodotto. Riprova.');
            window.history.back();
        } finally {
            hidePageLoader();
        }
    });

    // ========================================
    // FETCH DATI BACKEND
    // ========================================
    async function fetchProductDetails(sku) {
        const url = `${WEB_APP_URL}?action=get_bookable_product_details&sku=${encodeURIComponent(sku)}&t=${Date.now()}`;
        
        const response = await fetch(url);
        const data = await response.json();
        
        if (!data.success) {
            throw new Error(data.error || 'Errore recupero dati');
        }
        
        return data.product;
    }

    // ========================================
    // RENDERING DINAMICO PAGINA
    // ========================================
    function renderPage(product) {
    const config = product.typeConfig;
    
    // ‚úÖ 1. HEADER
    document.querySelector('.hero-title').textContent = config.pageTitle;
    document.querySelector('.hero-subtitle').textContent = config.pageSubtitle;
    document.querySelector('.badge-text').textContent = config.badge;
    
    // ‚úÖ 2. IMMAGINE HERO
    const heroImg = document.querySelector('.hero-image');
    if (product.mainImage) {
        heroImg.src = product.mainImage;
        heroImg.alt = product.title;
    }
    
    // ‚úÖ 3. DETTAGLI PRODOTTO
    document.querySelectorAll('.product-title').forEach(el => {
        el.textContent = product.title;
    });
    
    document.querySelector('.product-location').innerHTML = `
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/>
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/>
        </svg>
        ${product.luogo}
    `;
    
    // ‚úÖ 4. PREZZO (con formattazione italiana)
    const priceEl = document.querySelector('.product-price');
    const priceLabelEl = document.querySelector('.price-label');
    
    if (config.showDynamicPrice) {
        priceEl.textContent = formatPrice(product.price);
        priceLabelEl.textContent = config.priceLabel;
    } else {
        priceEl.textContent = config.fixedPrice;
        priceLabelEl.textContent = config.priceLabel;
    }
    
    // ‚úÖ 5. BENEFIT (primi 3 come badge)
    const benefitContainer = document.querySelector('.benefit-badges');
    benefitContainer.innerHTML = '';
    
    product.benefit.slice(0, 3).forEach(benefit => {
        benefitContainer.innerHTML += `
            <span class="feature-badge">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                </svg>
                ${benefit}
            </span>
        `;
    });
    
    // ‚úÖ 6. DESCRIZIONE
    document.querySelector('.product-description').textContent = product.desc;
    
    // ‚úÖ 7. TABELLA PRESTAZIONI
    const table1Title = document.querySelector('.table-1-title');
    const table1Body = document.querySelector('.table-1-body');
    
    table1Title.textContent = config.tables.first.title;
    table1Body.innerHTML = '';
    
    product.prestazioni.forEach((value, index) => {
        const label = config.tables.first.labels[index] || `Campo ${index + 1}`;
        table1Body.innerHTML += `
            <div class="spec-item">
                <span style="color: #a59173;">${label}</span>
                <span class="font-semibold">${value}</span>
            </div>
        `;
    });
    
    // ‚úÖ 8. TABELLA CARATTERISTICHE
    const table2Title = document.querySelector('.table-2-title');
    const table2Body = document.querySelector('.table-2-body');
    
    table2Title.textContent = config.tables.second.title;
    table2Body.innerHTML = '';
    
    product.caratteristiche.forEach((value, index) => {
        const label = config.tables.second.labels[index] || `Campo ${index + 1}`;
        table2Body.innerHTML += `
            <div class="spec-item">
                <span style="color: #a59173;">${label}</span>
                <span class="font-semibold">${value}</span>
            </div>
        `;
    });
    
    // ‚úÖ 9. ORARI DISPONIBILI
    const timeSelect = document.getElementById('bookingTime');
    if (timeSelect) {
        timeSelect.innerHTML = '<option value="">Seleziona orario</option>';
        
        console.log('üìÖ Orari ricevuti:', product.orari);
        
        if (product.orari && Array.isArray(product.orari) && product.orari.length > 0) {
            product.orari.forEach(orario => {
                if (orario) {
                    console.log('  ‚úÖ Aggiunto orario:', orario);
                    timeSelect.innerHTML += `<option value="${orario}">${orario}</option>`;
                }
            });
        } else {
            console.warn('‚ö†Ô∏è Nessun orario disponibile per questo prodotto');
            const defaultTimes = ['09:00', '10:00', '11:00', '14:00', '15:00', '16:00', '17:00'];
            defaultTimes.forEach(time => {
                timeSelect.innerHTML += `<option value="${time}">${time}</option>`;
            });
        }
    }

    // ‚úÖ 10a. CHILOMETRAGGIO DINAMICO (SOLO SUPERCAR)
    const skuPrefix = product.sku.split('-')[0].toUpperCase();

    if (skuPrefix === 'SC' && product.chilometraggioPrices && product.chilometraggioPrices.length > 0) {
        const distanceGrid = document.getElementById('distanceOptions');
        if (distanceGrid) {
            distanceGrid.innerHTML = '';
            
            const distanceConfig = getDistanceConfigForProduct(product);
            
            distanceConfig.options.forEach((distance, index) => {
                if (index < product.chilometraggioPrices.length) {
                    const price = product.chilometraggioPrices[index];
                    
                    const option = document.createElement('div');
                    option.className = 'distance-option';
                    option.dataset.km = distance.value;
                    option.dataset.price = price;
                    
                    option.innerHTML = `
                        <div class="text-2xl font-bold gradient-text mb-2">${distance.value} ${distance.unit}</div>
                        <div class="text-xl font-semibold mb-1">${formatPrice(price)}</div>
                        <div class="text-sm" style="color: #a59173;">${distance.label}</div>
                    `;
                    
                    distanceGrid.appendChild(option);
                }
            });
            
            initDistanceSelection(product);
        }
    }
    
    // ‚úÖ 10b. BENEFIT NEL RIEPILOGO (restanti)
    const summaryBenefits = document.querySelector('.summary-benefits');
    summaryBenefits.innerHTML = '';

    product.benefit.slice(3).forEach(benefit => {
        summaryBenefits.innerHTML += `
            <div class="flex items-center gap-2 text-sm" style="color: #c9a891;">
                <svg class="w-5 h-5 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                </svg>
                ${benefit}
            </div>
        `;
    });

    // ‚úÖ 10c. CARD SECONDA SUPERCAR DINAMICA (con nome corretto)
    if (skuPrefix === 'SC' && product.supercarComboSku) {
    // ‚≠ê IMPOSTA SUBITO IL COMBO SKU NEL DATASET (PRIMA DEL FETCH)
    const checkbox = document.getElementById('secondCarCheckbox');
    if (checkbox) {
        checkbox.dataset.comboSku = product.supercarComboSku;
        console.log('‚úÖ Combo SKU impostato:', product.supercarComboSku);
    }
    
    fetchProductDetails(product.supercarComboSku)
        .then(secondCar => {
            const secondCarSection = document.getElementById('secondCarSection');
            const isHuracanSpyder = product.title && 
                                    product.title.toLowerCase().includes('lamborghini') && 
                                    product.title.toLowerCase().includes('hurac√°n spyder');
            
            if (secondCarSection) {
                const basePrice = product.price || 0;
                const comboPrice = product.supercarComboPrice || 0;
                const additionalPrice = Math.max(0, comboPrice - basePrice);

                const comboHas4Seats = secondCar.numPosti >= 4;
                
                let labelHTML = `
                    <div class="font-semibold mb-1">Aggiungi ${secondCar.title}</div>
                    <div class="text-sm" style="color: #a59173;">${formatPrice(additionalPrice)} aggiuntivi - Include servizi fotografici e video</div>
                `;
                
                // ‚úÖ HURAC√ÅN: Servizi PREMIUM dentro la card
                if (isHuracanSpyder) {
                    labelHTML += `
                    <div class="huracan-services-wrapper" id="huracanExtraServices" style="display: none; margin-top: 20px; padding-top: 20px; border-top: 1px solid rgba(212, 175, 55, 0.2);">
                        
                        <!-- Header servizi con icona -->
                        <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 20px;">
                            <div style="width: 40px; height: 40px; background: linear-gradient(135deg, rgba(212, 175, 55, 0.15), rgba(255, 215, 0, 0.08)); border: 1.5px solid rgba(212, 175, 55, 0.4); border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                                <svg style="width: 20px; height: 20px; color: #D4AF37;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z"/>
                                </svg>
                            </div>
                            <div>
                                <h3 class="text-2xl font-bold gradient-text mb-2">Servizi Aggiuntivi Disponibili</h3>
                                <div style="font-size: 0.875rem; color: #c9a891;">Personalizza la tua esperienza</div>
                            </div>
                        </div>
                        
                        <!-- Servizi con design lussuoso -->
                        <div style="display: flex; flex-direction: column; gap: 12px;">
                            
                            <!-- Servizio Fotografico -->
                            <label class="huracan-service-card" style="display: flex; align-items: center; gap: 15px; padding: 16px; background: linear-gradient(135deg, rgba(26, 26, 26, 0.8), rgba(15, 15, 15, 0.9)); border: 1.5px solid rgba(80, 60, 45, 0.4); border-radius: 12px; cursor: pointer; transition: all 0.3s ease; position: relative; overflow: hidden;">
                                <input type="checkbox" class="extra-service huracan-service-checkbox" data-price="290" data-service="photo" style="width: 20px; height: 20px; accent-color: #D4AF37; cursor: pointer; z-index: 2;">
                                <div style="flex: 1; z-index: 2;">
                                    <div style="font-size: 0.95rem; font-weight: 600; color: #fff; margin-bottom: 4px; display: flex; align-items: center; gap: 8px;">
                                        <svg style="width: 18px; height: 18px; color: #D4AF37;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"/>
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"/>
                                        </svg>
                                        Servizio Fotografico Professionale
                                    </div>
                                    <div style="font-size: 0.8rem; color: #a59173;">Su una vettura a scelta</div>
                                </div>
                                <div style="font-size: 1.1rem; font-weight: 700; color: #D4AF37; z-index: 2;">${formatPrice(290)}</div>
                                <div class="service-glow" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(135deg, transparent 0%, rgba(212, 175, 55, 0.1) 50%, transparent 100%); opacity: 0; transition: opacity 0.3s ease;"></div>
                            </label>
                            
                            <!-- Video HD -->
                            <label class="huracan-service-card" style="display: flex; align-items: center; gap: 15px; padding: 16px; background: linear-gradient(135deg, rgba(26, 26, 26, 0.8), rgba(15, 15, 15, 0.9)); border: 1.5px solid rgba(80, 60, 45, 0.4); border-radius: 12px; cursor: pointer; transition: all 0.3s ease; position: relative; overflow: hidden;">
                                <input type="checkbox" class="extra-service huracan-service-checkbox" data-price="490" data-service="video-hd" style="width: 20px; height: 20px; accent-color: #D4AF37; cursor: pointer; z-index: 2;">
                                <div style="flex: 1; z-index: 2;">
                                    <div style="font-size: 0.95rem; font-weight: 600; color: #fff; margin-bottom: 4px; display: flex; align-items: center; gap: 8px;">
                                        <svg style="width: 18px; height: 18px; color: #D4AF37;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"/>
                                        </svg>
                                        Video HD Professionale
                                    </div>
                                    <div style="font-size: 0.8rem; color: #a59173;">Disponibile su entrambe le vetture</div>
                                </div>
                                <div style="font-size: 1.1rem; font-weight: 700; color: #D4AF37; z-index: 2;">${formatPrice(490)}</div>
                                <div class="service-glow" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(135deg, transparent 0%, rgba(212, 175, 55, 0.1) 50%, transparent 100%); opacity: 0; transition: opacity 0.3s ease;"></div>
                            </label>
                            
                            <!-- Video 360¬∞ -->
                            <label class="huracan-service-card" style="display: flex; align-items: center; gap: 15px; padding: 16px; background: linear-gradient(135deg, rgba(26, 26, 26, 0.8), rgba(15, 15, 15, 0.9)); border: 1.5px solid rgba(80, 60, 45, 0.4); border-radius: 12px; cursor: pointer; transition: all 0.3s ease; position: relative; overflow: hidden;">
                                <input type="checkbox" class="extra-service huracan-service-checkbox" data-price="690" data-service="video-360" style="width: 20px; height: 20px; accent-color: #D4AF37; cursor: pointer; z-index: 2;">
                                <div style="flex: 1; z-index: 2;">
                                    <div style="font-size: 0.95rem; font-weight: 600; color: #fff; margin-bottom: 4px; display: flex; align-items: center; gap: 8px;">
                                        <svg style="width: 18px; height: 18px; color: #D4AF37;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"/>
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                        </svg>
                                        Video 360¬∞ Immersivo
                                    </div>
                                    <div style="font-size: 0.8rem; color: #a59173;">Su una vettura (marchi diversi)</div>
                                </div>
                                <div style="font-size: 1.1rem; font-weight: 700; color: #D4AF37; z-index: 2;">${formatPrice(690)}</div>
                                <div class="service-glow" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(135deg, transparent 0%, rgba(212, 175, 55, 0.1) 50%, transparent 100%); opacity: 0; transition: opacity 0.3s ease;"></div>
                            </label>

                            ${comboHas4Seats ? `
                            <!-- Passeggeri Extra -->
                            <div style="border-top: 1px solid rgba(212, 175, 55, 0.2); padding-top: 16px; margin-top: 16px;">
                                <div style="font-size: 0.9rem; font-weight: 600; color: #fff; margin-bottom: 12px;">Aggiungi Passeggeri</div>
                                <div style="display: flex; gap: 12px;">
                                    <label class="huracan-passenger-option" style="display: flex; align-items: center; gap: 10px; padding: 14px 18px; background: rgba(20, 15, 12, 0.8); border: 2px solid rgba(80, 60, 45, 0.4); border-radius: 10px; cursor: pointer; flex: 1; transition: all 0.3s ease;">
                                        <input type="radio" name="huracanPassengers" value="1" class="huracan-passenger-radio" style="width: 18px; height: 18px; accent-color: #D4AF37;">
                                        <div>
                                            <div style="font-size: 0.875rem; font-weight: 600; color: #fff;">1 Passeggero</div>
                                            <div style="font-size: 0.75rem; color: #a59173;">+${formatPrice(50)}</div>
                                        </div>
                                    </label>
                                    <label class="huracan-passenger-option" style="display: flex; align-items: center; gap: 10px; padding: 14px 18px; background: rgba(20, 15, 12, 0.8); border: 2px solid rgba(80, 60, 45, 0.4); border-radius: 10px; cursor: pointer; flex: 1; transition: all 0.3s ease;">
                                        <input type="radio" name="huracanPassengers" value="2" class="huracan-passenger-radio" style="width: 18px; height: 18px; accent-color: #D4AF37;">
                                        <div>
                                            <div style="font-size: 0.875rem; font-weight: 600; color: #fff;">2 Passeggeri</div>
                                            <div style="font-size: 0.75rem; color: #a59173;">+${formatPrice(100)}</div>
                                        </div>
                                    </label>
                                </div>
                            </div>
                            ` : ''}
                            
                        </div>
                    </div>
                            
                        </div>
                    </div>
                    
                    <style>
                        .huracan-service-card:hover {
                            border-color: rgba(212, 175, 55, 0.6);
                            transform: translateY(-2px);
                            box-shadow: 0 8px 25px rgba(212, 175, 55, 0.2);
                        }
                        
                        .huracan-service-card:hover .service-glow {
                            opacity: 1;
                        }
                        
                        .huracan-service-checkbox:checked ~ * {
                            color: #D4AF37 !important;
                        }

                        .huracan-passenger-option:hover {
    border-color: rgba(212, 175, 55, 0.6);
    background: rgba(45, 24, 16, 0.4);
}

.huracan-passenger-radio:checked + div {
    color: #D4AF37 !important;
}
                    </style>
                    `;
                }
                
                const checkboxLabel = secondCarSection.querySelector('.checkbox-container div');
                if (checkboxLabel) {
                    checkboxLabel.innerHTML = labelHTML;
                }
                
                const checkbox = document.getElementById('secondCarCheckbox');
                if (checkbox) {
                    checkbox.dataset.comboPrice = additionalPrice;
                    checkbox.dataset.comboName = secondCar.title;
                }
                
                secondCarSection.style.display = 'block';
            }
        })
        .catch(err => {
            console.log('Supercar Combo non trovata, card nascosta');
            const secondCarSection = document.getElementById('secondCarSection');
            if (secondCarSection) secondCarSection.style.display = 'none';
        });
} else {
        const secondCarSection = document.getElementById('secondCarSection');
        if (secondCarSection) secondCarSection.style.display = 'none';
    }

    // ‚úÖ 11. GESTIONE SERVIZI AGGIUNTIVI (NUOVA LOGICA UI)
    if (skuPrefix === 'SC') {
        const isHuracanSpyder = product.title && 
                                product.title.toLowerCase().includes('lamborghini') && 
                                product.title.toLowerCase().includes('hurac√°n spyder');
        
        const extraServicesSection = document.getElementById('extraServicesSection');
        const extraServicesContainer = document.getElementById('extraServicesContainer');
        
        if (!isHuracanSpyder) {
            // ‚úÖ Per tutte le SC tranne Hurac√°n: mostra servizi sempre
            if (extraServicesSection && extraServicesContainer) {
                extraServicesContainer.innerHTML = '';
                
                // Aggiungi checkbox servizi standard
                const services = [
                    { id: 'photo', label: 'Servizio Fotografico Professionale', price: 290, desc: 'Su una vettura a scelta' },
                    { id: 'video-hd', label: 'Video HD Professionale', price: 490, desc: 'Disponibile su entrambe le vetture' },
                    { id: 'video-360', label: 'Video 360¬∞ Immersivo', price: 690, desc: 'Su una vettura (marchi diversi)' }
                ];
                
                services.forEach(service => {
                    const checkbox = document.createElement('label');
                    checkbox.className = 'checkbox-container';
                    checkbox.innerHTML = `
                       <input type="checkbox" class="extra-service" data-price="${service.price}" data-service="${service.id}">
                       <div>
                          <div class="font-semibold mb-1">${service.label}</div>
                          <div class="text-sm" style="color: #a59173;">+${formatPrice(service.price)} - ${service.desc}</div>
                       </div>
                    `;
                    extraServicesContainer.appendChild(checkbox);
                });
                
                // ‚úÖ Aggiungi passeggeri se 4 posti (con scelta quantit√†)
if (product.numPosti >= 4) {
    const maxExtraPassengers = product.numPosti - 2;
    const pricePerPassenger = 50;
    
    const passengerContainer = document.createElement('div');
    passengerContainer.className = 'checkbox-container';
    passengerContainer.style.display = 'block';
    passengerContainer.innerHTML = `
        <div>
            <div class="font-semibold mb-3">Passeggeri Extra</div>
            <div style="display: flex; gap: 15px; margin-top: 15px;">
                <label style="display: flex; align-items: center; gap: 10px; cursor: pointer; padding: 12px 20px; background: rgba(212, 175, 55, 0.08); border: 2px solid rgba(212, 175, 55, 0.3); border-radius: 10px; transition: all 0.3s ease; flex: 1;">
                    <input type="radio" name="extraPassengers" value="1" class="passenger-radio" style="width: 18px; height: 18px; accent-color: #D4AF37; cursor: pointer;">
                    <div>
                        <div style="font-size: 14px; font-weight: 600; color: #fff;">1 Passeggero</div>
                        <div style="font-size: 12px; color: #a59173;">+${formatPrice(pricePerPassenger)}</div>
                    </div>
                </label>
                <label style="display: flex; align-items: center; gap: 10px; cursor: pointer; padding: 12px 20px; background: rgba(212, 175, 55, 0.08); border: 2px solid rgba(212, 175, 55, 0.3); border-radius: 10px; transition: all 0.3s ease; flex: 1;">
                    <input type="radio" name="extraPassengers" value="2" class="passenger-radio" style="width: 18px; height: 18px; accent-color: #D4AF37; cursor: pointer;">
                    <div>
                        <div style="font-size: 14px; font-weight: 600; color: #fff;">${maxExtraPassengers} Passeggeri</div>
                        <div style="font-size: 12px; color: #a59173;">+${formatPrice(pricePerPassenger * maxExtraPassengers)}</div>
                    </div>
                </label>
            </div>
        </div>
    `;
    extraServicesContainer.appendChild(passengerContainer);
}
                
                extraServicesSection.style.display = 'block';
            }
        } else {
            // ‚úÖ Hurac√°n Spyder: nasconde servizi (saranno mostrati dal checkbox combo)
            if (extraServicesSection) extraServicesSection.style.display = 'none';
        }
    } else {
        const extraServicesSection = document.getElementById('extraServicesSection');
        if (extraServicesSection) extraServicesSection.style.display = 'none';
    }

    // ‚úÖ 12. AGGIORNA NOME PRODOTTO NEL RIEPILOGO (SIDEBAR)
    const summaryTitle = document.querySelector('.summary-product-title');
    if (summaryTitle) {
        summaryTitle.textContent = product.title;
    }

    // ‚úÖ 13. POLITICHE DINAMICHE
    const policiesCard = document.querySelector('.policies-card');
    if (policiesCard && product.politiche && Array.isArray(product.politiche)) {
        const policiesBody = policiesCard.querySelector('.space-y-3');
        if (policiesBody) {
            policiesBody.innerHTML = '';
            
            product.politiche.forEach(policy => {
                const policyDiv = document.createElement('div');
                policyDiv.innerHTML = `
                    <strong style="color: #f5f5f0;">${policy.label}:</strong> 
                    ${policy.description}
                `;
                policiesBody.appendChild(policyDiv);
            });
        }
    }

    // ‚úÖ 14. GESTIONE PREZZO SU RICHIESTA PER IMMOBILI
    const isPriceOnRequest = !config.showDynamicPrice && config.fixedPrice === '‚Ç¨ ‚Äî';
    if (isPriceOnRequest) {
        const distanceSection = document.querySelector('.glass-card:has(#distanceOptions)');
        if (distanceSection) distanceSection.style.display = 'none';

        const secondCarSection = document.getElementById('secondCarSection');
        if (secondCarSection) secondCarSection.style.display = 'none';
    }

    // ‚úÖ 15. GESTIONE ESPERIENZE (EX) - Nascondi sezioni non applicabili
    if (skuPrefix === 'EX') {
        const distanceSection = document.querySelector('.glass-card:has(#distanceOptions)');
        if (distanceSection) distanceSection.style.display = 'none';

        const secondCarSection = document.getElementById('secondCarSection');
        if (secondCarSection) secondCarSection.style.display = 'none';

        bookingData.basePrice = product.price || 0;
    }

    // ‚úÖ 16. GESTIONE SUPERCAR (SC) - Usa prezzo base prodotto
    if (skuPrefix === 'SC') {
        bookingData.basePrice = product.price || 0;
    }

    updatePriceSummary();
}

    // ========================================
    // LOADER UTILITIES
    // ========================================
    function showPageLoader() {
        document.body.style.overflow = 'hidden';
        document.body.insertAdjacentHTML('beforeend', `
            <div id="pageLoader" style="position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(10,10,10,0.95); z-index: 99999; display: flex; align-items: center; justify-content: center;">
                <div style="text-align: center;">
                    <div style="width: 80px; height: 80px; border: 3px solid #2a2a2a; border-top-color: #D4AF37; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 20px;"></div>
                    <div style="color: #D4AF37; font-size: 16px; letter-spacing: 2px;">Caricamento...</div>
                </div>
            </div>
            <style>@keyframes spin { to { transform: rotate(360deg); }}</style>
        `);
    }

    function hidePageLoader() {
        const loader = document.getElementById('pageLoader');
        if (loader) {
            loader.style.opacity = '0';
            loader.style.transition = 'opacity 0.3s';
            setTimeout(() => loader.remove(), 300);
            document.body.style.overflow = '';
        }
    }

        /**
 * Determina configurazione chilometraggio in base a SKU e Nome Prodotto
 */
function getDistanceConfigForProduct(product) {
    const sku = product.sku.toUpperCase();
    const title = product.title.toLowerCase();
    
    // Caso 1: Ferrari 458 Spider
    if (title.includes('ferrari 458 spider')) {
        return {
            options: [
                { value: 9, unit: 'km', label: 'Esperienza rapida' },
                { value: 16, unit: 'km', label: 'Pi√π popolare' },
                { value: 32, unit: 'km', label: 'Esperienza completa' },
                { value: 65, unit: 'km', label: 'Tour esteso' },
                { value: 80, unit: 'km', label: 'Avventura lunga' },
                { value: 100, unit: 'km', label: 'Esperienza definitiva' }
            ]
        };
    }
    
    // Caso 2: McLaren 720s Performance
    if (title.includes('mclaren 720s')) {
        return {
            options: [
                { value: 10, unit: 'min', label: 'Esperienza rapida' },
                { value: 20, unit: 'min', label: 'Pi√π popolare' },
                { value: 30, unit: 'min', label: 'Esperienza completa' },
                { value: 60, unit: 'min', label: 'Tour esteso' },
                { value: 90, unit: 'min', label: 'Avventura lunga' },
                { value: 120, unit: 'min', label: 'Esperienza definitiva' }
            ]
        };
    }
    
    // Caso 3/4/5: Combo Supercar (Ferrari + Lamborghini)
    if (title.includes('ferrari') && title.includes('lamborghini')) {
        return {
            options: [
                { value: 10, unit: 'km', label: 'Esperienza rapida' },
                { value: 20, unit: 'km', label: 'Pi√π popolare' },
                { value: 30, unit: 'km', label: 'Esperienza completa' },
                { value: 60, unit: 'km', label: 'Tour esteso' },
                { value: 90, unit: 'km', label: 'Avventura lunga' },
                { value: 120, unit: 'km', label: 'Esperienza definitiva' }
            ]
        };
    }
    
    // Default: km standard
    return {
        options: [
            { value: 10, unit: 'km', label: 'Esperienza rapida' },
            { value: 20, unit: 'km', label: 'Pi√π popolare' },
            { value: 30, unit: 'km', label: 'Esperienza completa' },
            { value: 60, unit: 'km', label: 'Tour esteso' },
            { value: 70, unit: 'km', label: 'Avventura lunga' },
            { value: 120, unit: 'km', label: 'Esperienza definitiva' }
        ]
    };
}

    // ========================================
    // INIZIALIZZAZIONE COMPONENTI
    // ========================================
    function initializeComponents(product) {
    const skuPrefix = product.sku.split('-')[0].toUpperCase();
    
    // Distance selection (se non gi√† gestito dinamicamente)
    if (skuPrefix !== 'SC' || !product.chilometraggioPrices) {
        document.querySelectorAll('.distance-option').forEach(option => {
            option.addEventListener('click', function() {
                document.querySelectorAll('.distance-option').forEach(opt => opt.classList.remove('selected'));
                this.classList.add('selected');
                
                bookingData.distance = this.dataset.km;
                
                if (skuPrefix !== 'SC' && skuPrefix !== 'EX') {
                    bookingData.basePrice = parseInt(this.dataset.price);
                }
                
                updatePriceSummary();
            });
        });
        
        // Auto-select first option
        const firstOption = document.querySelector('.distance-option');
        if (firstOption && skuPrefix !== 'EX' && skuPrefix !== 'SC') {
            firstOption.classList.add('selected');
            bookingData.distance = firstOption.dataset.km;
            bookingData.basePrice = parseInt(firstOption.dataset.price);
            updatePriceSummary();
        }
    }

        // Second car checkbox
const secondCarCheckbox = document.getElementById('secondCarCheckbox');
const isHuracanSpyder = product.title && 
                        product.title.toLowerCase().includes('lamborghini') && 
                        product.title.toLowerCase().includes('hurac√°n spyder');

if (skuPrefix === 'SC') {
    const isHuracanSpyder = product.title && 
                            product.title.toLowerCase().includes('lamborghini') && 
                            product.title.toLowerCase().includes('hurac√°n spyder');
    
    if (isHuracanSpyder) {
        // ‚úÖ Hurac√°n: toggle servizi nella card combo
        if (secondCarCheckbox) {
    secondCarCheckbox.addEventListener('change', function() {
        bookingData.secondCar = this.checked;
        const comboPrice = parseInt(this.dataset.comboPrice) || 1490;
        const comboName = this.dataset.comboName || 'Seconda Supercar';
        
        // ‚≠ê APPLICA/RIPRISTINA PREZZI COMBO IN TEMPO REALE
        if (this.checked) {
            if (hasCustomComboPricing()) {
                console.log('üéØ Combo speciale rilevata, aggiornamento prezzi immediato');
                applyComboDistancePricing();
            }
        } else {
            // Ripristina prezzi originali
            restoreOriginalDistancePricing();
        }
        
        // Toggle visibilit√† servizi Hurac√É¬°n
        const huracanServices = document.getElementById('huracanExtraServices');
        if (huracanServices) {
            huracanServices.style.display = this.checked ? 'block' : 'none';

            if (this.checked) {
                setTimeout(() => {
                    document.querySelectorAll('.huracan-service-checkbox').forEach(cb => {
                        const newCb = cb.cloneNode(true);
                        cb.parentNode.replaceChild(newCb, cb);
                        
                        newCb.addEventListener('change', function() {
                            const price = parseInt(this.dataset.price);
                            const service = this.dataset.service;
                            
                            if (this.checked) {
                                if (!bookingData.extraServices.find(s => s.service === service)) {
                                    bookingData.extraServices.push({ service, price });
                                }
                            } else {
                                bookingData.extraServices = bookingData.extraServices.filter(s => s.service !== service);
                            }
                            
                            updatePriceSummary();
                        });
                    });

                    document.querySelectorAll('.huracan-passenger-radio').forEach(radio => {
                        radio.addEventListener('change', function() {
                            const quantity = parseInt(this.value);
                            const pricePerPassenger = 50;
                            const totalPrice = pricePerPassenger * quantity;
                            
                            bookingData.extraServices = bookingData.extraServices.filter(s => s.service !== 'extra-passengers');
                            
                            if (this.checked) {
                                bookingData.extraServices.push({ 
                                    service: 'extra-passengers', 
                                    price: totalPrice,
                                    quantity: quantity
                                });
                            }
                            
                            document.querySelectorAll('.huracan-passenger-option').forEach(lbl => {
                                lbl.style.borderColor = 'rgba(80, 60, 45, 0.4)';
                                lbl.style.background = 'rgba(20, 15, 12, 0.8)';
                            });
                            
                            const selectedLabel = this.closest('.huracan-passenger-option');
                            if (selectedLabel) {
                                selectedLabel.style.borderColor = '#D4AF37';
                                selectedLabel.style.background = 'rgba(212, 175, 55, 0.12)';
                            }
                            
                            updatePriceSummary();
                        });
                    });
                }, 100);
            }
            
            if (this.checked) {
                setTimeout(() => {
                    huracanServices.style.animation = 'fadeIn 0.4s ease';
                }, 50);
            }
            
            if (!this.checked) {
                huracanServices.querySelectorAll('.huracan-service-checkbox').forEach(cb => {
                    cb.checked = false;
                });
                bookingData.extraServices = [];
            }
        }
        
        // Aggiorna riepilogo
        document.getElementById('secondCarPrice').classList.toggle('hidden', !this.checked);
        
        const secondCarNameSpan = document.getElementById('secondCarName');
        const secondCarPriceSpan = document.getElementById('secondCarPriceAmount');
        
        if (secondCarNameSpan) secondCarNameSpan.textContent = comboName;
        if (secondCarPriceSpan) secondCarPriceSpan.textContent = formatPrice(comboPrice);
        
        updatePriceSummary();
    });
}
    } else {
    // ‚úÖ Altre supercar: comportamento standard CON gestione prezzi combo
    if (secondCarCheckbox) {
        secondCarCheckbox.addEventListener('change', function() {
            bookingData.secondCar = this.checked;
            const comboPrice = parseInt(this.dataset.comboPrice) || 1490;
            const comboName = this.dataset.comboName || 'Seconda Supercar';
            
            // ‚≠ê APPLICA/RIPRISTINA PREZZI COMBO IN TEMPO REALE
            if (this.checked) {
                if (hasCustomComboPricing()) {
                    console.log('üéØ Combo speciale rilevata, aggiornamento prezzi immediato');
                    applyComboDistancePricing();
                }
            } else {
                // Ripristina prezzi originali quando si deseleziona
                restoreOriginalDistancePricing();
            }
            
            document.getElementById('secondCarPrice').classList.toggle('hidden', !this.checked);
            
            const secondCarNameSpan = document.getElementById('secondCarName');
            const secondCarPriceSpan = document.getElementById('secondCarPriceAmount');
            
            if (secondCarNameSpan) secondCarNameSpan.textContent = comboName;
            if (secondCarPriceSpan) secondCarPriceSpan.textContent = formatPrice(comboPrice);
            
            updatePriceSummary();
        });
    }
}
}

        // Extra services
        document.querySelectorAll('.extra-service').forEach(checkbox => {
            checkbox.addEventListener('change', function() {
                const price = parseInt(this.dataset.price);
                const service = this.dataset.service;
                
                if (this.checked) {
                    bookingData.extraServices.push({ service, price });
                } else {
                    bookingData.extraServices = bookingData.extraServices.filter(s => s.service !== service);
                }
                
                updatePriceSummary();
            });
        });

        // ‚úÖ Re-bind listener per servizi Hurac√°n (TUTTI i checkbox con classe .extra-service)
// Questo gestisce sia servizi standard che Hurac√°n
setTimeout(() => {
    const allServiceCheckboxes = document.querySelectorAll('.extra-service');
    
    allServiceCheckboxes.forEach(checkbox => {
        // Rimuovi listener duplicati clonando elemento
        const newCheckbox = checkbox.cloneNode(true);
        checkbox.parentNode.replaceChild(newCheckbox, checkbox);
        
        // Aggiungi listener pulito
        newCheckbox.addEventListener('change', function() {
            const price = parseInt(this.dataset.price);
            const service = this.dataset.service;
            
            if (this.checked) {
                // Aggiungi servizio se non presente
                if (!bookingData.extraServices.find(s => s.service === service)) {
                    bookingData.extraServices.push({ service, price });
                }
            } else {
                // Rimuovi servizio
                bookingData.extraServices = bookingData.extraServices.filter(s => s.service !== service);
            }
            
            console.log('üìä Servizi attivi:', bookingData.extraServices); // Debug
            updatePriceSummary();
        });
    });
}, 600); // Attendi rendering completo

        // ‚úÖ Gestione Passeggeri Extra (radio buttons)
document.querySelectorAll('.passenger-radio').forEach(radio => {
    radio.addEventListener('change', function() {
        const quantity = parseInt(this.value);
        const pricePerPassenger = 50;
        const totalPrice = pricePerPassenger * quantity;
        
        // Rimuovi eventuali servizi passeggeri precedenti
        bookingData.extraServices = bookingData.extraServices.filter(s => s.service !== 'extra-passengers');
        
        // Aggiungi nuovo servizio
        if (this.checked) {
    // ‚úÖ RESET STILI TUTTI I LABEL
    document.querySelectorAll('label:has(.passenger-radio)').forEach(lbl => {
        lbl.style.borderColor = 'rgba(212, 175, 55, 0.3)';
        lbl.style.background = 'rgba(212, 175, 55, 0.08)';
    });
    
    // Evidenzia label selezionato
    const selectedLabel = this.closest('label');
    if (selectedLabel) {
        selectedLabel.style.borderColor = '#D4AF37';
        selectedLabel.style.background = 'rgba(212, 175, 55, 0.18)';
    }
    
    bookingData.extraServices.push({ 
                service: 'extra-passengers', 
                price: totalPrice,
                quantity: quantity
            });
        }
        
        updatePriceSummary();
    });
});

// ‚úÖ Stile hover per radio passengers
document.querySelectorAll('label:has(.passenger-radio)').forEach(label => {
    label.addEventListener('mouseenter', function() {
        this.style.borderColor = '#D4AF37';
        this.style.background = 'rgba(212, 175, 55, 0.15)';
    });
    label.addEventListener('mouseleave', function() {
        const radio = this.querySelector('.passenger-radio');
        if (!radio.checked) {
            this.style.borderColor = 'rgba(212, 175, 55, 0.3)';
            this.style.background = 'rgba(212, 175, 55, 0.08)';
        }
    });
});
        // Initialize phone
        initPhoneSelector();
        
        // Initialize calendar
        initCalendar();
    }

        /**
 * Inizializza selezione distanza per prodotti con chilometraggio dinamico
 */
function initDistanceSelection(product) {
    const skuPrefix = product.sku.split('-')[0].toUpperCase();
    
    document.querySelectorAll('.distance-option').forEach(option => {
        option.addEventListener('click', function() {
            document.querySelectorAll('.distance-option').forEach(opt => opt.classList.remove('selected'));
            this.classList.add('selected');
            
            bookingData.distance = this.dataset.km;
            
            // Per SC ed EX, non sovrascrivere il prezzo base con quello della distanza
            if (skuPrefix !== 'SC' && skuPrefix !== 'EX') {
                bookingData.basePrice = parseInt(this.dataset.price);
            } else {
                // Per SC, aggiorna il prezzo base con quello selezionato
                bookingData.basePrice = parseInt(this.dataset.price);
            }
            
            updatePriceSummary();
        });
    });
    
    // Auto-select prima opzione se presente
    const firstOption = document.querySelector('.distance-option');
    if (firstOption) {
        firstOption.classList.add('selected');
        bookingData.distance = firstOption.dataset.km;
        
        if (skuPrefix === 'SC' || skuPrefix === 'EX') {
            bookingData.basePrice = parseInt(firstOption.dataset.price);
        }
        
        updatePriceSummary();
    }
}

    // ========================================
    // PRICE SUMMARY UPDATE
    // ========================================
    function updatePriceSummary() {
        const isPriceOnRequest = bookingData.productData?.typeConfig && 
                                 !bookingData.productData.typeConfig.showDynamicPrice &&
                                  bookingData.productData.typeConfig.fixedPrice === '‚Ç¨ ‚Äî';
    
        if (isPriceOnRequest) {
            // Prezzo su richiesta per IMMOBILI
            document.getElementById('basePrice').textContent = '‚Ç¨ ‚Äî';
            document.getElementById('totalPrice').textContent = '‚Ç¨ ‚Äî';
            return; // Esce senza calcolare totali
        }
    
        // ASSICURA CHE IL PREZZO BASE SIA SEMPRE VALORIZZATO
        // Per SC ed EX, usa sempre il prezzo dal prodotto se non impostato
        if (!bookingData.basePrice && bookingData.productData) {
            const skuPrefix = bookingData.productData.sku.split('-')[0].toUpperCase();
            if (skuPrefix === 'SC' || skuPrefix === 'EX') {
                bookingData.basePrice = bookingData.productData.price || 0;
            }
        }
    
        let total = bookingData.basePrice;
    
        document.getElementById('basePrice').textContent = formatPrice(bookingData.basePrice);
        
        if (bookingData.secondCar) {
    const checkbox = document.getElementById('secondCarCheckbox');
    const comboPrice = checkbox ? parseInt(checkbox.dataset.comboPrice) || 1490 : 1490;
    total += comboPrice;
}
        
        const extraServicesDiv = document.getElementById('extraServicesPrice');
        extraServicesDiv.innerHTML = '';
        
        bookingData.extraServices.forEach(service => {
    total += service.price;
    const serviceNames = {
        'photo': 'Servizio Fotografico',
        'video-hd': 'Video HD',
        'video-360': 'Video 360¬∞',
        'extra-passengers': 'Passeggeri Extra'
    };
    
    let serviceName = serviceNames[service.service];
    
    // ‚úÖ Aggiungi quantit√† per passeggeri
    if (service.service === 'extra-passengers' && service.quantity) {
        serviceName += ` (${service.quantity})`;
    }
    
    const div = document.createElement('div');
    div.className = 'flex justify-between';
    div.innerHTML = `
        <span class="text-sm" style="color: #c9a891;">${serviceName}</span>
        <span class="font-semibold text-sm">${formatPrice(service.price)}</span>
    `;
    extraServicesDiv.appendChild(div);
});
        
        bookingData.total = total;
        document.getElementById('totalPrice').textContent = formatPrice(total);
    }

    // ========================================
    // CONFERMA PRENOTAZIONE
    // ========================================
    async function confirmBooking() {
    const skuPrefix = bookingData.productData?.sku.split('-')[0].toUpperCase();
    const requiresDistance = skuPrefix !== 'EX' && skuPrefix !== 'SC';

    // ‚úÖ 1. VALIDAZIONE DISTANZA
    if (requiresDistance && !bookingData.distance) {
        showValidationError('Seleziona un percorso prima di procedere', 'distance');
        return;
    }

    // ‚úÖ 2. VALIDAZIONE DATA E ORARIO
    const date = bookingData.selectedDate;
    const time = document.getElementById('bookingTime').value;
    
    if (!date) {
        showValidationError('Seleziona una data per la tua esperienza.', 'date');
        document.getElementById('bookingDate')?.focus();
        return;
    }
    
    if (!time) {
        showValidationError('Seleziona un orario per la tua esperienza.', 'time');
        document.getElementById('bookingTime')?.focus();
        return;
    }
    
    // ‚úÖ 3. VALIDAZIONE DATI PERSONALI
    const firstName = document.querySelector('input[placeholder="Il tuo nome"]');
    const lastName = document.querySelector('input[placeholder="Il tuo cognome"]');
    
    if (!firstName || !firstName.value.trim()) {
        showValidationError('Inserisci il tuo nome per procedere.', 'name');
        firstName?.focus();
        return;
    }
    
    if (!lastName || !lastName.value.trim()) {
        showValidationError('Inserisci il tuo cognome per procedere.', 'surname');
        lastName?.focus();
        return;
    }
    
    // ‚úÖ 4. VALIDAZIONE EMAIL
    const emailInput = document.querySelector('input[type="email"]');
    if (!emailInput || !emailInput.value.trim()) {
        showEmailError('Inserisci il tuo indirizzo email per procedere.');
        emailInput?.focus();
        return;
    }
    
    const emailValidation = validateEmail(emailInput.value.trim());
    if (!emailValidation.valid) {
        showEmailError(emailValidation.message);
        emailInput.focus();
        return;
    }
    
    // ‚úÖ 5. VALIDAZIONE TELEFONO
    const phoneInput = document.querySelector('input[type="tel"]');
    if (!phoneInput || !phoneInput.value.trim()) {
        showValidationError('Inserisci il tuo numero di telefono per procedere.', 'phone');
        phoneInput?.focus();
        return;
    }
    
    // Verifica lunghezza minima (almeno 6 cifre)
    const phoneDigits = phoneInput.value.replace(/\D/g, '');
    if (phoneDigits.length < 6) {
        showValidationError('Il numero di telefono inserito non √® valido. Inserisci un numero completo.', 'phone');
        phoneInput.focus();
        return;
    }
    
    // Verifica che corrisponda alla lunghezza del paese selezionato
    if (phoneDigits.length < selectedCountry.maxLength - 2) {
        showValidationError(`Il numero deve contenere almeno ${selectedCountry.maxLength - 2} cifre per ${selectedCountry.country}.`, 'phone');
        phoneInput.focus();
        return;
    }
    
    // ‚úÖ 6. VALIDAZIONE TERMINI E CONDIZIONI
    const terms = document.getElementById('termsCheckbox')?.checked;
    if (!terms) {
        showValidationError('Devi accettare i termini e condizioni per procedere con la prenotazione.', 'terms');
        document.getElementById('termsCheckbox')?.focus();
        return;
    }
    
    // ‚úÖ 7. PREPARAZIONE DATI PRENOTAZIONE
    const notes = document.querySelector('textarea[placeholder="Hai richieste particolari?"]')?.value || '';
    
    const bookingPayload = {
        action: 'create_booking',
        sku: bookingData.sku,
        productTitle: bookingData.productData.title,
        firstName: firstName.value.trim(),
        lastName: lastName.value.trim(),
        email: emailInput.value.trim().toLowerCase(),
        phone: `${selectedCountry.code} ${phoneInput.value.trim()}`,
        phoneCountry: selectedCountry.country,
        date: date.toISOString().split('T')[0],
        time: time,
        distance: bookingData.distance || 'N/A',
        basePrice: bookingData.basePrice,
        secondCar: bookingData.secondCar,
        secondCarName: bookingData.secondCar ? (document.getElementById('secondCarCheckbox')?.dataset.comboName || 'N/A') : null,
        secondCarPrice: bookingData.secondCar ? (parseInt(document.getElementById('secondCarCheckbox')?.dataset.comboPrice) || 0) : 0,
        extraServices: bookingData.extraServices,
        total: bookingData.total,
        notes: notes,
        timestamp: new Date().toISOString()
    };
    
    // ‚úÖ 8. MOSTRA LOADER E DISABILITA FORM
    showBookingLoader();
    disableForm();
    
    try {
        // ‚úÖ 9. INVIO DATI AL BACKEND
        const response = await fetch(WEB_APP_URL, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: new URLSearchParams(bookingPayload)
        });
        
        const result = await response.json();
        
        // ‚úÖ 10. GESTIONE RISPOSTA
        if (result.success) {
            showBookingSuccess(bookingPayload);
        } else {
            throw new Error(result.error || 'Errore durante la prenotazione');
        }
        
    } catch (error) {
        console.error('Errore prenotazione:', error);
        showBookingError(error.message);
    } finally {
        hideBookingLoader();
        enableForm();
    }
}

// ========================================
// FUNZIONI UTILITY PER VALIDAZIONE
// ========================================

/**
 * Mostra errore di validazione generico
 */
function showValidationError(message, field) {
    const toast = document.createElement('div');
    toast.style.cssText = `
        position: fixed;
        top: 30px;
        right: 30px;
        background: linear-gradient(135deg, rgba(20, 15, 12, 0.98), rgba(30, 20, 15, 0.98));
        backdrop-filter: blur(20px);
        color: #f5f5f0;
        padding: 24px 32px;
        border-radius: 16px;
        box-shadow: 0 20px 60px rgba(239, 68, 68, 0.3), 0 0 0 1px rgba(239, 68, 68, 0.2);
        z-index: 100000;
        font-size: 15px;
        max-width: 420px;
        border: 1.5px solid rgba(239, 68, 68, 0.4);
        animation: slideInRight 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
    `;
    
    toast.innerHTML = `
        <div style="display: flex; align-items: flex-start; gap: 16px;">
            <div style="flex-shrink: 0; width: 28px; height: 28px; background: rgba(239, 68, 68, 0.15); border-radius: 50%; display: flex; align-items: center; justify-content: center; border: 1.5px solid rgba(239, 68, 68, 0.4);">
                <svg style="width: 16px; height: 16px; color: #ef4444;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                </svg>
            </div>
            <div style="flex: 1;">
                <div style="font-weight: 600; margin-bottom: 6px; color: #D4AF37; font-size: 14px; text-transform: uppercase; letter-spacing: 1px;">Campo Richiesto</div>
                <div style="line-height: 1.6; color: #c9a891;">${message}</div>
            </div>
        </div>
    `;
    
    document.body.appendChild(toast);
    
    setTimeout(() => {
        toast.style.transition = 'opacity 0.4s ease, transform 0.4s ease';
        toast.style.opacity = '0';
        toast.style.transform = 'translateX(50px)';
        setTimeout(() => toast.remove(), 400);
    }, 5000);
}

/**
 * Mostra loader durante invio prenotazione
 */
function showBookingLoader() {
    const loader = document.createElement('div');
    loader.id = 'bookingLoader';
    loader.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        background: rgba(10, 10, 10, 0.95);
        backdrop-filter: blur(10px);
        z-index: 100001;
        display: flex;
        align-items: center;
        justify-content: center;
        animation: fadeIn 0.3s ease;
    `;
    
    loader.innerHTML = `
        <div style="text-align: center;">
            <div style="width: 80px; height: 80px; border: 3px solid rgba(212, 175, 55, 0.2); border-top-color: #D4AF37; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 24px;"></div>
            <div style="color: #D4AF37; font-size: 18px; font-weight: 600; letter-spacing: 2px; margin-bottom: 8px;">Conferma in Corso</div>
            <div style="color: #c9a891; font-size: 14px;">Stiamo elaborando la tua prenotazione...</div>
        </div>
    `;
    
    document.body.appendChild(loader);
}

/**
 * Nasconde loader
 */
function hideBookingLoader() {
    const loader = document.getElementById('bookingLoader');
    if (loader) {
        loader.style.opacity = '0';
        setTimeout(() => loader.remove(), 300);
    }
}

/**
 * Disabilita tutti i campi del form durante invio
 */
function disableForm() {
    document.querySelectorAll('input, select, textarea, button').forEach(el => {
        el.disabled = true;
        el.style.opacity = '0.6';
        el.style.pointerEvents = 'none';
    });
}

/**
 * Riabilita form
 */
function enableForm() {
    document.querySelectorAll('input, select, textarea, button').forEach(el => {
        el.disabled = false;
        el.style.opacity = '1';
        el.style.pointerEvents = 'auto';
    });
}

/**
 * Mostra messaggio di successo
 */
function showBookingSuccess(data) {
    const modal = document.createElement('div');
    modal.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        background: rgba(10, 10, 10, 0.95);
        backdrop-filter: blur(10px);
        z-index: 100002;
        display: flex;
        align-items: center;
        justify-content: center;
        animation: fadeIn 0.3s ease;
    `;
    
    const formatted = new Date(data.date).toLocaleDateString('it-IT', {
        day: '2-digit',
        month: 'long',
        year: 'numeric'
    });
    
    modal.innerHTML = `
        <div style="
            background: linear-gradient(135deg, rgba(20, 15, 12, 0.98), rgba(30, 20, 15, 0.98));
            backdrop-filter: blur(20px);
            border: 2px solid rgba(34, 197, 94, 0.4);
            border-radius: 24px;
            padding: 48px;
            max-width: 600px;
            width: 90%;
            box-shadow: 0 30px 80px rgba(0, 0, 0, 0.8);
            animation: scaleIn 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        ">
            <div style="text-align: center; margin-bottom: 32px;">
                <div style="width: 80px; height: 80px; background: rgba(34, 197, 94, 0.15); border: 2px solid rgba(34, 197, 94, 0.4); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 24px;">
                    <svg style="width: 40px; height: 40px; color: #22c55e;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M5 13l4 4L19 7"/>
                    </svg>
                </div>
                <h2 style="font-size: 32px; font-weight: 700; background: linear-gradient(135deg, #D4AF37, #F4E4C1); -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin-bottom: 12px;">Prenotazione Confermata!</h2>
                <p style="color: #c9a891; font-size: 16px; line-height: 1.6;">La tua esperienza esclusiva √® stata prenotata con successo.</p>
            </div>
            
            <div style="background: rgba(10, 10, 10, 0.6); border: 1px solid rgba(80, 60, 45, 0.4); border-radius: 16px; padding: 24px; margin-bottom: 32px;">
                <div style="display: grid; gap: 16px;">
                    <div style="display: flex; justify-content: space-between; padding-bottom: 12px; border-bottom: 1px solid rgba(80, 60, 45, 0.3);">
                        <span style="color: #a59173;">Esperienza</span>
                        <span style="color: #f5f5f0; font-weight: 600;">${data.productTitle}</span>
                    </div>
                    ${data.distance !== 'N/A' ? `
                    <div style="display: flex; justify-content: space-between; padding-bottom: 12px; border-bottom: 1px solid rgba(80, 60, 45, 0.3);">
                        <span style="color: #a59173;">Percorso</span>
                        <span style="color: #f5f5f0; font-weight: 600;">${data.distance} km</span>
                    </div>
                    ` : ''}
                    <div style="display: flex; justify-content: space-between; padding-bottom: 12px; border-bottom: 1px solid rgba(80, 60, 45, 0.3);">
                        <span style="color: #a59173;">Data e Orario</span>
                        <span style="color: #f5f5f0; font-weight: 600;">${formatted} - ${data.time}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; padding-top: 8px;">
                        <span style="color: #a59173; font-size: 18px;">Totale</span>
                        <span style="font-size: 28px; font-weight: 700; background: linear-gradient(135deg, #D4AF37, #F4E4C1); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">${formatPrice(data.total)}</span>
                    </div>
                </div>
            </div>
            
            <div style="text-align: center;">
                <p style="color: #c9a891; font-size: 14px; margin-bottom: 24px; line-height: 1.6;">
                    Riceverai una email di conferma all'indirizzo <strong style="color: #D4AF37;">${data.email}</strong> con tutti i dettagli della tua prenotazione.
                </p>
                <button onclick="window.location.href='/'" style="
                    background: linear-gradient(135deg, #d4af37 0%, #c9a02c 50%, #b8941f 100%);
                    color: #0a0a0a;
                    font-weight: 600;
                    padding: 18px 48px;
                    border: none;
                    border-radius: 14px;
                    cursor: pointer;
                    font-size: 16px;
                    letter-spacing: 1px;
                    text-transform: uppercase;
                    box-shadow: 0 4px 20px rgba(212, 175, 55, 0.3);
                    transition: all 0.3s ease;
                ">Torna alla Home</button>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
}

/**
 * Mostra messaggio di errore
 */
function showBookingError(message) {
    const modal = document.createElement('div');
    modal.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        background: rgba(10, 10, 10, 0.95);
        backdrop-filter: blur(10px);
        z-index: 100002;
        display: flex;
        align-items: center;
        justify-content: center;
        animation: fadeIn 0.3s ease;
    `;
    
    modal.innerHTML = `
        <div style="
            background: linear-gradient(135deg, rgba(20, 15, 12, 0.98), rgba(30, 20, 15, 0.98));
            backdrop-filter: blur(20px);
            border: 2px solid rgba(239, 68, 68, 0.4);
            border-radius: 24px;
            padding: 48px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 30px 80px rgba(0, 0, 0, 0.8);
            animation: scaleIn 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        ">
            <div style="text-align: center; margin-bottom: 32px;">
                <div style="width: 80px; height: 80px; background: rgba(239, 68, 68, 0.15); border: 2px solid rgba(239, 68, 68, 0.4); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 24px;">
                    <svg style="width: 40px; height: 40px; color: #ef4444;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </div>
                <h2 style="font-size: 28px; font-weight: 700; color: #ef4444; margin-bottom: 12px;">Errore Prenotazione</h2>
                <p style="color: #c9a891; font-size: 15px; line-height: 1.6;">${message}</p>
            </div>
            
            <div style="text-align: center;">
                <button onclick="this.closest('div[style*=\\'position: fixed\\']').remove()" style="
                    background: linear-gradient(135deg, #d4af37 0%, #c9a02c 50%, #b8941f 100%);
                    color: #0a0a0a;
                    font-weight: 600;
                    padding: 16px 40px;
                    border: none;
                    border-radius: 14px;
                    cursor: pointer;
                    font-size: 15px;
                    letter-spacing: 1px;
                    text-transform: uppercase;
                    box-shadow: 0 4px 20px rgba(212, 175, 55, 0.3);
                    transition: all 0.3s ease;
                ">Riprova</button>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
}

// Aggiungi animazioni CSS se non presenti
if (!document.getElementById('bookingAnimations')) {
    const style = document.createElement('style');
    style.id = 'bookingAnimations';
    style.textContent = `
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        @keyframes scaleIn {
            from {
                opacity: 0;
                transform: scale(0.9);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    `;
    document.head.appendChild(style);
}

    // ========================================
    // CUSTOM CALENDAR
    // ========================================
    let currentMonth = new Date();
    const dateInput = document.getElementById('bookingDate');
    const calendar = document.createElement('div');
    calendar.id = 'customCalendar';
    calendar.className = 'custom-calendar';
    calendar.style.display = 'none';
    document.body.appendChild(calendar);

    function initCalendar() {
        dateInput.addEventListener('click', function(e) {
            e.stopPropagation();
            if (currentMonth < earliestAllowed) {
                currentMonth = new Date(earliestAllowed.getFullYear(), earliestAllowed.getMonth(), 1);
            }
            calendar.style.display = (calendar.style.display === 'none' || !calendar.style.display) ? 'block' : 'none';
            renderCalendar();
            positionCalendar();
        });

        document.addEventListener('click', function(e) {
            if (!calendar.contains(e.target) && e.target !== dateInput) {
                calendar.style.display = 'none';
            }
        });

        window.addEventListener('resize', () => {
            if (calendar.style.display === 'block') positionCalendar();
        });
        
        window.addEventListener('scroll', () => {
            if (calendar.style.display === 'block') positionCalendar();
        }, true);
    }

    function positionCalendar() {
        const rect = dateInput.getBoundingClientRect();
        const left = rect.left + window.scrollX;
        const top = rect.bottom + window.scrollY + 8;
        calendar.style.left = left + 'px';
        calendar.style.top = top + 'px';
        calendar.style.minWidth = rect.width + 'px';
        calendar.style.maxWidth = '480px';
    }

    function renderCalendar() {
        const year = currentMonth.getFullYear();
        const month = currentMonth.getMonth();
        
        const firstDay = new Date(year, month, 1);
        const lastDay = new Date(year, month + 1, 0);
        const daysInMonth = lastDay.getDate();
        const startingDayOfWeek = firstDay.getDay();

        const monthNames = ['Gennaio', 'Febbraio', 'Marzo', 'Aprile', 'Maggio', 'Giugno',
                          'Luglio', 'Agosto', 'Settembre', 'Ottobre', 'Novembre', 'Dicembre'];
        
        let html = `
            <div class="calendar-header">
                <button id="calendarPrevBtn" class="calendar-nav" onclick="previousMonth(event)">‚óÑ</button>
                <div class="text-lg font-bold gradient-text">${monthNames[month]} ${year}</div>
                <button id="calendarNextBtn" class="calendar-nav" onclick="nextMonth(event)">‚ñ∫</button>
            </div>
            <div class="calendar-grid">
                <div class="calendar-day-header">Dom</div>
                <div class="calendar-day-header">Lun</div>
                <div class="calendar-day-header">Mar</div>
                <div class="calendar-day-header">Mer</div>
                <div class="calendar-day-header">Gio</div>
                <div class="calendar-day-header">Ven</div>
                <div class="calendar-day-header">Sab</div>
        `;

        // Empty cells before first day
        for (let i = 0; i < startingDayOfWeek; i++) {
            html += '<div class="calendar-day empty"></div>';
        }

        // Days of the month
        for (let day = 1; day <= daysInMonth; day++) {
            const currentDate = new Date(year, month, day);
            const isDisabled = currentDate < minDate || currentDate > maxDate;
            const isSelected = bookingData.selectedDate && 
                             currentDate.toDateString() === bookingData.selectedDate.toDateString();
            
            const classes = ['calendar-day'];
            if (isDisabled) classes.push('disabled');
            if (isSelected) classes.push('selected');

            html += `<div class="${classes.join(' ')}" 
                         onclick="selectDate(${year}, ${month}, ${day}, ${isDisabled})">${day}</div>`;
        }

        html += '</div>';
        calendar.innerHTML = html;
        updateCalendarNavButtons();
    }

    function monthIsBefore(aYear, aMonth, bYear, bMonth) {
        return aYear < bYear || (aYear === bYear && aMonth < bMonth);
    }
    
    function monthIsAfter(aYear, aMonth, bYear, bMonth) {
        return aYear > bYear || (aYear === bYear && aMonth > bMonth);
    }

    function updateCalendarNavButtons() {
        const prev = document.getElementById('calendarPrevBtn');
        const next = document.getElementById('calendarNextBtn');
        if (!prev || !next) return;
        
        const displayYear = currentMonth.getFullYear();
        const displayMonth = currentMonth.getMonth();

        const earliestYear = earliestAllowed.getFullYear();
        const earliestMonth = earliestAllowed.getMonth();

        const maxYear = maxDate.getFullYear();
        const maxMonth = maxDate.getMonth();

        const canPrev = monthIsAfter(displayYear, displayMonth, earliestYear, earliestMonth);
        const canNext = monthIsBefore(displayYear, displayMonth, maxYear, maxMonth);

        if (canPrev) prev.classList.remove('disabled'); 
        else prev.classList.add('disabled');
        
        if (canNext) next.classList.remove('disabled'); 
        else next.classList.add('disabled');
    }

    function previousMonth(e) {
        e.preventDefault();
        e.stopPropagation();
        const curYear = currentMonth.getFullYear();
        const curMonth = currentMonth.getMonth();
        const earliestYear = earliestAllowed.getFullYear();
        const earliestMonth = earliestAllowed.getMonth();
        
        if (!(curYear > earliestYear || (curYear === earliestYear && curMonth > earliestMonth))) return;
        
        currentMonth.setMonth(curMonth - 1);
        renderCalendar();
        positionCalendar();
    }

    function nextMonth(e) {
        e.preventDefault();
        e.stopPropagation();
        const curYear = currentMonth.getFullYear();
        const curMonth = currentMonth.getMonth();
        const maxYear = maxDate.getFullYear();
        const maxMonth = maxDate.getMonth();
        
        if (!(curYear < maxYear || (curYear === maxYear && curMonth < maxMonth))) return;
        
        currentMonth.setMonth(curMonth + 1);
        renderCalendar();
        positionCalendar();
    }

    function selectDate(year, month, day, isDisabled) {
        if (isDisabled) return;
        
        bookingData.selectedDate = new Date(year, month, day);
        const formatted = bookingData.selectedDate.toLocaleDateString('it-IT', {
            day: '2-digit',
            month: '2-digit',
            year: 'numeric'
        });
        dateInput.value = formatted;
        calendar.style.display = 'none';
        renderCalendar();
    }

    // ========================================
    // ANIMATION ON SCROLL
    // ========================================
    const observerOptions = {
        threshold: 0.1,
        rootMargin: '0px 0px -50px 0px'
    };

    const observer = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
            if (entry.isIntersecting) {
                entry.target.style.opacity = '1';
                entry.target.style.transform = 'translateY(0)';
            }
        });
    }, observerOptions);

    document.querySelectorAll('.animate-fade-in').forEach(el => {
        el.style.opacity = '0';
        el.style.transform = 'translateY(30px)';
        el.style.transition = 'all 0.6s ease';
        observer.observe(el);
    });
</script>
</body>
</html>
