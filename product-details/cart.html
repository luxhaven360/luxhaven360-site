<!DOCTYPE html>
<html lang="it">
<head>
    <script src="../error-handler.js" defer></script>
<script src="../siteguard-client.js"></script>
    <meta charset="UTF-8">
    <!-- PERFORMANCE: preconnect GAS -->
    <link rel="preconnect" href="https://script.google.com" crossorigin>
    <link rel="dns-prefetch" href="https://www.google.com">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Il Tuo Carrello</title>
    <!-- Connection Monitor Styles -->
    <link rel="stylesheet" href="../connection-monitor.css" />

    <!-- Sistema i18n -->
<script src="../translations.js"></script>
<script src="../translations-brief-descriptions.js"></script>
<script src="translations-pdp.js"></script>
<script src="translations-descriptions.js"></script>
<script src="i18n-pdp.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(to bottom, #09090b, #18181b, #09090b);
            color: #fafafa;
            line-height: 1.6;
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 3rem 1.5rem;
        }

        /* Header */
        .cart-header {
            margin-bottom: 3rem;
            padding-bottom: 2rem;
            border-bottom: 1px solid #27272a;
        }

        .cart-title {
            font-size: 3rem;
            font-weight: 300;
            letter-spacing: -0.02em;
            margin-bottom: 0.5rem;
        }

        .cart-subtitle {
            color: #a1a1aa;
            font-size: 1.125rem;
        }

        /* Cart Layout */
        .cart-layout {
            display: grid;
            grid-template-columns: 1fr 400px;
            gap: 4rem;
            align-items: start;
        }

        /* Cart Items */
        .cart-items {
            display: flex;
            flex-direction: column;
            gap: 2rem;
        }

        .cart-item {
            display: grid;
            grid-template-columns: 140px 1fr auto;
            gap: 2rem;
            padding: 2rem;
            background: rgba(24, 24, 27, 0.3);
            border: 1px solid rgba(39, 39, 42, 0.5);
            border-radius: 1.5rem;
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
        }

        .cart-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
            opacity: 0;
            transition: opacity 0.3s;
        }

        .cart-item:hover {
            border-color: rgba(255, 255, 255, 0.1);
            background: rgba(24, 24, 27, 0.5);
        }

        .cart-item:hover::before {
            opacity: 1;
        }

        .item-image {
            aspect-ratio: 3/4;
            border-radius: 1rem;
            overflow: hidden;
            background: #18181b;
        }

        .item-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.5s;
        }

        .cart-item:hover .item-image img {
            transform: scale(1.05);
        }

        .item-details {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            justify-content: center;
        }

        .item-name {
            font-size: 1.25rem;
            font-weight: 500;
            letter-spacing: -0.01em;
        }

        /* Badge quantit√† prodotto premium */
.item-quantity-badge {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    margin-left: 0.75rem;
    padding: 0.25rem 0.75rem;
    background: linear-gradient(135deg, rgba(212, 175, 55, 0.15), rgba(255, 215, 0, 0.1));
    border: 1px solid rgba(212, 175, 55, 0.3);
    border-radius: 1.5rem;
    font-size: 0.875rem;
    font-weight: 600;
    color: #D4AF37;
    letter-spacing: 0.05em;
    box-shadow: 0 2px 8px rgba(212, 175, 55, 0.2);
    transition: all 0.3s ease;
}

.cart-item:hover .item-quantity-badge {
    background: linear-gradient(135deg, rgba(212, 175, 55, 0.25), rgba(255, 215, 0, 0.15));
    border-color: rgba(212, 175, 55, 0.5);
    box-shadow: 0 4px 12px rgba(212, 175, 55, 0.3);
    transform: scale(1.05);
}

        .item-variant {
            color: #a1a1aa;
            font-size: 0.875rem;
            display: flex;
            gap: 1rem;
        }

        .variant-detail {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .color-dot {
            width: 1rem;
            height: 1rem;
            border-radius: 50%;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .item-actions {
            display: flex;
            gap: 1rem;
            margin-top: 0.5rem;
        }

        .remove-btn {
            background: none;
            border: none;
            color: #71717a;
            cursor: pointer;
            font-size: 0.875rem;
            text-decoration: underline;
            transition: color 0.3s;
        }

        .remove-btn:hover {
            color: #ef4444;
        }

        .item-price-section {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            justify-content: center;
            gap: 0.5rem;
        }

        .item-price {
            font-size: 1.5rem;
            font-weight: 300;
            letter-spacing: 0.02em;
        }

        .item-original-price {
            color: #71717a;
            font-size: 0.875rem;
            text-decoration: line-through;
        }

        /* Empty Cart */
        .empty-cart {
            text-align: center;
            padding: 6rem 2rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            width: 100%;
            margin: 0 auto;
        }

        .empty-cart-icon {
            font-size: 4rem;
            margin-bottom: 1.5rem;
            opacity: 0.3;
        }

        .empty-cart h2 {
            font-size: 2rem;
            font-weight: 300;
            margin-bottom: 1rem;
        }

        .empty-cart p {
            color: #a1a1aa;
            margin-bottom: 2rem;
        }

        .btn-continue {
            display: inline-block;
            padding: 1rem 2.5rem;
            background: white;
            color: #09090b;
            text-decoration: none;
            border-radius: 1rem;
            font-weight: 500;
            transition: all 0.3s;
        }

        .btn-continue:hover {
            background: #f4f4f5;
            transform: scale(1.02);
        }

        /* Summary Sidebar */
        .cart-summary {
            position: sticky;
            top: 2rem;
            background: rgba(24, 24, 27, 0.5);
            border: 1px solid rgba(39, 39, 42, 0.8);
            border-radius: 1.5rem;
            padding: 2rem;
            backdrop-filter: blur(20px);
        }

        .summary-title {
            font-size: 1.5rem;
            font-weight: 500;
            margin-bottom: 1.5rem;
            letter-spacing: -0.01em;
        }

        .summary-row {
            display: flex;
            justify-content: space-between;
            padding: 1rem 0;
            border-bottom: 1px solid rgba(39, 39, 42, 0.5);
        }

        .summary-row:last-of-type {
            border-bottom: none;
        }

        .summary-label {
            color: #a1a1aa;
            font-size: 0.9375rem;
        }

        .summary-value {
            font-weight: 500;
        }

        .summary-total {
            padding: 1.5rem 0;
            border-top: 2px solid rgba(255, 255, 255, 0.1);
            margin-top: 1rem;
        }

        .summary-total .summary-label {
            color: white;
            font-size: 1.125rem;
            font-weight: 500;
        }

        .summary-total .summary-value {
            font-size: 1.75rem;
            font-weight: 300;
            letter-spacing: 0.02em;
        }

        /* Indicatore calcolo sconto premium */
.discount-calculating {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    color: #D4AF37;
    font-size: 0.875rem;
    font-weight: 400;
    letter-spacing: 0.05em;
}

.discount-calculating::before {
    content: '';
    width: 12px;
    height: 12px;
    border: 2px solid #D4AF37;
    border-top-color: transparent;
    border-radius: 50%;
    animation: discountSpin 0.8s linear infinite;
}

@keyframes discountSpin {
    to { transform: rotate(360deg); }
}

.discount-calculating-text {
    background: linear-gradient(90deg, #D4AF37, #FFD700, #D4AF37);
    background-size: 200% auto;
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    animation: discountShimmer 2s linear infinite;
}

@keyframes discountShimmer {
    to { background-position: 200% center; }
}

        .progress-section {
            margin-bottom: 1.5rem;
        }

        .progress-text {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.5rem;
            font-size: 0.875rem;
            color: #a1a1aa;
        }

        .progress-highlight {
            color: #34d399;
        }

        .progress-bar {
            height: 4px;
            background: #27272a;
            border-radius: 2px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #34d399, #10b981);
            transition: width 0.3s ease;
        }

        /* Promo Code */
        .promo-code {
            margin: 1.5rem 0;
        }

        .promo-label {
            display: block;
            font-size: 0.875rem;
            color: #a1a1aa;
            margin-bottom: 0.5rem;
        }

        .promo-input-wrapper {
            display: flex;
            gap: 0.5rem;
        }

        .promo-input {
            flex: 1;
            padding: 0.75rem 1rem;
            background: rgba(39, 39, 42, 0.5);
            border: none;
            border-radius: 0.75rem;
            color: white;
            font-size: 0.875rem;
        }

        .promo-input::placeholder {
            color: #71717a;
        }

        .promo-apply {
            padding: 0.75rem 1.5rem;
            background: white;
            color: #09090b;
            border: none;
            border-radius: 0.75rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
        }

        .promo-apply:hover {
            background: #f4f4f5;
        }

        /* ‚úÖ Feedback validazione coupon - Design Premium */
.promo-message {
    margin-top: 0.75rem;
    font-size: 0.875rem;
    padding: 0.875rem 1.125rem;
    border-radius: 0.75rem;
    display: none;
    font-weight: 500;
    letter-spacing: 0.01em;
    line-height: 1.5;
    animation: messageSlideIn 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
}

@keyframes messageSlideIn {
    from {
        opacity: 0;
        transform: translateY(-0.5rem);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.promo-message.success {
    background: linear-gradient(135deg, rgba(212, 175, 55, 0.12), rgba(255, 215, 0, 0.08));
    color: #D4AF37;
    border: 1px solid rgba(212, 175, 55, 0.4);
}

.promo-message.success::before {
    content: '‚úì ';
    font-weight: 700;
    margin-right: 0.5rem;
    font-size: 1.1em;
}

.promo-message.error {
    background: linear-gradient(135deg, rgba(239, 68, 68, 0.12), rgba(220, 38, 38, 0.08));
    color: #ef4444;
    border: 1px solid rgba(239, 68, 68, 0.4);
}

.promo-message.error::before {
    content: '‚úï ';
    font-weight: 700;
    margin-right: 0.5rem;
    font-size: 1.1em;
}

.promo-message.warning {
    background: linear-gradient(135deg, rgba(251, 191, 36, 0.12), rgba(245, 158, 11, 0.08));
    color: #f59e0b;
    border: 1px solid rgba(251, 191, 36, 0.4);
}

.promo-message.warning::before {
    content: '‚ö† ';
    font-weight: 700;
    margin-right: 0.5rem;
    font-size: 1.1em;
}

        /* Checkout Button */
        .checkout-btn {
            width: 100%;
            padding: 1.25rem;
            background: white;
            color: #09090b;
            border: none;
            border-radius: 1rem;
            font-size: 1.125rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 2rem;
        }

        .checkout-btn:hover {
            background: #f4f4f5;
            transform: scale(1.02);
        }

        /* Trust Badges */
        .trust-badges {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .trust-badge {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            color: #a1a1aa;
            font-size: 0.875rem;
        }

        .trust-icon {
            font-size: 1.25rem;
            opacity: 0.8;
        }

        /* ‚îÄ‚îÄ Refund Policy Box ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
        .refund-policy {
            margin-top: 1.75rem;
            border: 1px solid #27272a;
            border-radius: 1rem;
            background: #111113;
            overflow: hidden;
        }

        .refund-policy__header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 1rem 1.25rem;
            cursor: pointer;
            user-select: none;
            border-bottom: 1px solid transparent;
            transition: border-color 0.25s;
        }

        .refund-policy.open .refund-policy__header {
            border-color: #27272a;
        }

        .refund-policy__icon {
            width: 1.75rem;
            height: 1.75rem;
            border-radius: 50%;
            background: #1c1c1f;
            border: 1px solid #3f3f46;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            font-size: 0.8rem;
        }

        .refund-policy__title {
            font-size: 0.8125rem;
            font-weight: 600;
            letter-spacing: 0.06em;
            text-transform: uppercase;
            color: #d4d4d8;
            flex: 1;
        }

        .refund-policy__chevron {
            color: #52525b;
            font-size: 0.7rem;
            transition: transform 0.25s ease;
        }

        .refund-policy.open .refund-policy__chevron {
            transform: rotate(180deg);
        }

        .refund-policy__body {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.35s ease;
        }

        .refund-policy.open .refund-policy__body {
            max-height: 600px;
        }

        .refund-policy__inner {
            padding: 1.25rem 1.25rem 1.5rem;
            display: grid;
            gap: 1rem;
        }

        .refund-policy__block {
            display: flex;
            gap: 0.75rem;
            align-items: flex-start;
        }

        .refund-policy__dot {
            width: 0.35rem;
            height: 0.35rem;
            border-radius: 50%;
            margin-top: 0.5rem;
            flex-shrink: 0;
        }

        .refund-policy__dot--green  { background: #4ade80; }
        .refund-policy__dot--red    { background: #f87171; }
        .refund-policy__dot--amber  { background: #fbbf24; }

        .refund-policy__block-text {
            font-size: 0.8125rem;
            color: #a1a1aa;
            line-height: 1.65;
        }

        .refund-policy__block-text strong {
            color: #d4d4d8;
            font-weight: 600;
        }

        .refund-policy__steps {
            margin-top: 0.4rem;
            padding-left: 0;
            list-style: none;
            display: flex;
            flex-direction: column;
            gap: 0.35rem;
        }

        .refund-policy__steps li {
            display: flex;
            gap: 0.6rem;
            font-size: 0.8125rem;
            color: #a1a1aa;
            line-height: 1.55;
        }

        .refund-policy__step-num {
            width: 1.15rem;
            height: 1.15rem;
            border-radius: 50%;
            background: #1c1c1f;
            border: 1px solid #3f3f46;
            font-size: 0.625rem;
            color: #fbbf24;
            font-weight: 700;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            margin-top: 0.15rem;
        }

        /* Recommended Section */
        .recommended-section {
            margin-top: 6rem;
        }

        .recommended-title {
            font-size: 2rem;
            font-weight: 300;
            margin-bottom: 2rem;
        }

        .recommended-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 2rem;
        }

        .recommended-item {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .recommended-image {
            aspect-ratio: 3/4;
            border-radius: 1rem;
            overflow: hidden;
            background: #18181b;
        }

        .recommended-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.5s;
        }

        .recommended-item:hover img {
            transform: scale(1.05);
        }

        .recommended-name {
            font-size: 1rem;
            font-weight: 500;
        }

        .recommended-price {
            color: #a1a1aa;
            font-size: 0.875rem;
        }

        /* Descrizione prodotti consigliati */
.recommended-desc {
    font-size: 0.875rem;
    color: #71717a;
    margin-top: 0.25rem;
    margin-bottom: 0.5rem;
    line-height: 1.3;
    min-height: 2.6em;
    overflow: hidden;
    text-overflow: ellipsis;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
}

/* ‚úÖ NUOVO: Padding tra nome e immagine */
.recommended-name {
    font-size: 1rem;
    font-weight: 500;
    margin-top: 1rem; /* ‚Üê Aggiunto padding */
}

/* Hover effect migliorato */
.recommended-item {
    transition: transform 0.3s, box-shadow 0.3s;
    cursor: pointer;
}

.recommended-item:hover {
    transform: translateY(-0.5rem);
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
}

/* ‚úÖ RIMOSSO: Hover oro dal titolo normale */
/* .recommended-item:hover .recommended-name {
    color: #D4AF37;
} */

/* ‚úÖ NUOVO: Hover oro SOLO per prodotti featured */
.recommended-item.featured:hover .recommended-name {
    color: #FFD700;
}

/* Badge "Consigliato" Premium (invariato) */
.recommended-item.featured {
    position: relative;
    border: 2px solid #D4AF37;
    border-radius: 1rem;
    padding: 0.5rem;
    background: linear-gradient(135deg, rgba(212, 175, 55, 0.05), rgba(0, 0, 0, 0));
    transform: scale(1.05);
    box-shadow: 0 8px 30px rgba(212, 175, 55, 0.3);
}

.recommended-badge {
    position: absolute;
    top: 10px;
    right: 10px;
    background: linear-gradient(135deg, #D4AF37, #FFD700);
    color: #09090b;
    padding: 0.375rem 0.875rem;
    border-radius: 2rem;
    font-size: 0.75rem;
    font-weight: 700;
    letter-spacing: 0.05em;
    text-transform: uppercase;
    box-shadow: 0 4px 12px rgba(212, 175, 55, 0.4);
    z-index: 10;
}

.recommended-item.featured .recommended-name {
    color: #D4AF37;
    font-weight: 600;
}

.recommended-item.featured .recommended-image {
    border: 1px solid rgba(212, 175, 55, 0.3);
}

        @media (max-width: 768px) {
            .cart-layout {
                grid-template-columns: 1fr;
            }

            .cart-item {
                grid-template-columns: 120px 1fr;
                gap: 1.5rem;
            }

            .item-price-section {
                grid-column: 2;
                align-items: flex-start;
            }

            .recommended-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        /* Evidenziazione riga sconto attivo */
.summary-row.discount-active .summary-value {
    color: #34d399 !important;
    font-weight: 600;
    font-size: 1.125rem;
}

/* Badge combo applicata */
.combo-badge {
    display: inline-block;
    background: rgba(52, 211, 153, 0.1);
    border: 1px solid #34d399;
    color: #34d399;
    padding: 0.25rem 0.75rem;
    border-radius: 1rem;
    font-size: 0.75rem;
    margin-left: 0.5rem;
    font-weight: 500;
}

/* Animazione comparsa sconto */
@keyframes discountPulse {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.05); }
}

.discount-active {
    animation: discountPulse 0.6s ease-in-out;
}

        /* ============================================
   SELETTORE LINGUA PREMIUM (PDP PAGES)
   ============================================ */

.pdp-lang-selector {
    position: fixed;
    top: 2rem;
    right: 2rem;
    z-index: 9999;
    display: flex;
    align-items: center;
    gap: 0.25rem;
    background: rgba(9, 9, 11, 0.85);
    backdrop-filter: blur(20px);
    border: 1px solid rgba(212, 175, 55, 0.2);
    border-radius: 2rem;
    padding: 0.625rem 1.25rem;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

.pdp-lang-selector:hover {
    border-color: rgba(212, 175, 55, 0.5);
    box-shadow: 0 12px 48px rgba(212, 175, 55, 0.15);
}

.pdp-lang-option {
    background: none;
    border: none;
    color: #71717a;
    font-size: 0.875rem;
    font-weight: 500;
    letter-spacing: 0.05em;
    padding: 0.5rem 0.75rem;
    cursor: pointer;
    transition: all 0.3s;
    border-radius: 1rem;
    position: relative;
}

.pdp-lang-option:hover {
    color: #d4d4d8;
    background: rgba(255, 255, 255, 0.05);
}

.pdp-lang-option.active {
    color: #D4AF37;
    font-weight: 600;
    background: linear-gradient(135deg, rgba(212, 175, 55, 0.1), rgba(255, 215, 0, 0.05));
}

.pdp-lang-option.active::after {
    content: '';
    position: absolute;
    bottom: 0.25rem;
    left: 50%;
    transform: translateX(-50%);
    width: 1.25rem;
    height: 2px;
    background: linear-gradient(90deg, #D4AF37, #FFD700);
    border-radius: 2px;
    box-shadow: 0 0 8px rgba(212, 175, 55, 0.6);
}

.pdp-lang-divider {
    width: 1px;
    height: 1rem;
    background: rgba(113, 113, 122, 0.3);
    margin: 0 0.125rem;
}

/* Responsive Mobile */
@media (max-width: 768px) {
    .pdp-lang-selector {
        top: 1rem;
        right: 1rem;
        padding: 0.5rem 1rem;
    }
    
    .pdp-lang-option {
        font-size: 0.8125rem;
        padding: 0.375rem 0.5rem;
    }
}
    </style>

    <!-- √¢¬≠ LOADER PREMIUM INTERATTIVO -->
<div id="cartLoader" style="position:fixed;top:0;left:0;width:100%;height:100%;background:linear-gradient(135deg, #09090b 0%, #18181b 50%, #09090b 100%);z-index:99999;display:flex;align-items:center;justify-content:center;transition:opacity 0.6s ease;overflow:hidden;">
    
    <!-- Particelle fluttuanti -->
    <div style="position:absolute;width:100%;height:100%;overflow:hidden;opacity:0.15;">
        <div class="particle" style="position:absolute;width:4px;height:4px;background:#D4AF37;border-radius:50%;top:20%;left:10%;animation:float 8s ease-in-out infinite;"></div>
        <div class="particle" style="position:absolute;width:6px;height:6px;background:#FFD700;border-radius:50%;top:60%;left:80%;animation:float 6s ease-in-out infinite 1s;"></div>
        <div class="particle" style="position:absolute;width:3px;height:3px;background:#D4AF37;border-radius:50%;top:40%;left:30%;animation:float 10s ease-in-out infinite 2s;"></div>
        <div class="particle" style="position:absolute;width:5px;height:5px;background:#FFD700;border-radius:50%;top:80%;left:60%;animation:float 7s ease-in-out infinite 0.5s;"></div>
        <div class="particle" style="position:absolute;width:4px;height:4px;background:#D4AF37;border-radius:50%;top:15%;left:70%;animation:float 9s ease-in-out infinite 1.5s;"></div>
    </div>
    
    <div style="text-align:center;max-width:480px;padding:2rem;position:relative;z-index:2;">
        
        <!-- Icona carrello -->
        <div style="position:relative;display:inline-block;margin-bottom:2rem;">
            <svg width="80" height="80" viewBox="0 0 24 24" fill="none" stroke="url(#cartGradient)" stroke-width="1.5" style="filter:drop-shadow(0 0 20px rgba(212,175,55,0.5));animation:cartBounce 2s ease-in-out infinite;">
                <defs>
                    <linearGradient id="cartGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                        <stop offset="0%" style="stop-color:#D4AF37;stop-opacity:1" />
                        <stop offset="100%" style="stop-color:#FFD700;stop-opacity:1" />
                    </linearGradient>
                </defs>
                <circle cx="9" cy="21" r="1"/>
                <circle cx="20" cy="21" r="1"/>
                <path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"/>
            </svg>
            
            <div style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);width:100px;height:100px;border:2px solid rgba(212,175,55,0.3);border-radius:50%;animation:ripple 2s ease-out infinite;"></div>
            <div style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);width:100px;height:100px;border:2px solid rgba(255,215,0,0.2);border-radius:50%;animation:ripple 2s ease-out infinite 0.5s;"></div>
        </div>
        
        <!-- Titolo -->
        <div id="loaderTitle" style="font-size:1.5rem;font-weight:400;margin-bottom:1.5rem;background:linear-gradient(90deg,#D4AF37,#FFD700,#D4AF37);background-size:200% auto;-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;animation:shimmer 3s linear infinite;letter-spacing:0.05em;">
            Caricamento Carrello
        </div>
        
        <!-- Messaggio dinamico -->
        <div id="loaderMessage" style="font-size:0.9375rem;color:#a1a1aa;margin-bottom:2rem;min-height:1.5rem;transition:opacity 0.3s ease;font-weight:300;letter-spacing:0.02em;">
            Verifica prodotti disponibili...
        </div>
        
        <!-- Barra progresso -->
        <div style="position:relative;height:6px;background:rgba(39,39,42,0.8);border-radius:10px;overflow:visible;margin-bottom:1rem;box-shadow:inset 0 2px 4px rgba(0,0,0,0.3);">
            <div id="loaderBar" style="position:relative;height:100%;width:0%;background:linear-gradient(90deg, #D4AF37, #FFD700, #D4AF37);background-size:200% 100%;border-radius:10px;animation:fillBar 7.8s cubic-bezier(0.4, 0, 0.2, 1) forwards, shimmerBar 2s linear infinite;box-shadow:0 0 15px rgba(212,175,55,0.6);"></div>
            
            <div style="position:absolute;top:-8px;left:25%;width:2px;height:22px;background:rgba(212,175,55,0.4);border-radius:2px;"></div>
            <div style="position:absolute;top:-8px;left:50%;width:2px;height:22px;background:rgba(212,175,55,0.4);border-radius:2px;"></div>
            <div style="position:absolute;top:-8px;left:75%;width:2px;height:22px;background:rgba(212,175,55,0.4);border-radius:2px;"></div>
        </div>
        
        <!-- Percentuale -->
        <div id="loaderPercentage" style="font-size:0.875rem;color:#D4AF37;margin-bottom:1.5rem;font-weight:600;letter-spacing:0.1em;">
            0%
        </div>
        
        <!-- Dots animati -->
        <div style="display:flex;gap:0.75rem;justify-content:center;">
            <div style="width:10px;height:10px;background:linear-gradient(135deg,#D4AF37,#FFD700);border-radius:50%;animation:elegantPulse 1.8s ease-in-out infinite;box-shadow:0 0 10px rgba(212,175,55,0.5);"></div>
            <div style="width:10px;height:10px;background:linear-gradient(135deg,#D4AF37,#FFD700);border-radius:50%;animation:elegantPulse 1.8s ease-in-out 0.3s infinite;box-shadow:0 0 10px rgba(212,175,55,0.5);"></div>
            <div style="width:10px;height:10px;background:linear-gradient(135deg,#D4AF37,#FFD700);border-radius:50%;animation:elegantPulse 1.8s ease-in-out 0.6s infinite;box-shadow:0 0 10px rgba(212,175,55,0.5);"></div>
        </div>
        
        <!-- Suggerimento -->
        <div style="margin-top:2.5rem;padding:1rem 1.5rem;background:rgba(212,175,55,0.05);border:1px solid rgba(212,175,55,0.2);border-radius:1rem;backdrop-filter:blur(10px);">
            <div style="font-size:0.8125rem;color:#d4d4d8;line-height:1.6;display:flex;align-items:center;gap:0.75rem;justify-content:center;">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#D4AF37" stroke-width="2">
                    <path d="M12 2L2 7l10 5 10-5-10-5z"/>
                    <path d="M2 17l10 5 10-5"/>
                    <path d="M2 12l10 5 10-5"/>
                </svg>
                <span id="loaderHint">Preparazione del carrello in corso...</span>
            </div>
        </div>
    </div>
</div>

<script>
// √¢≈ì‚Ä¶ INIZIALIZZA TRADUZIONI LOADER APPENA i18n √É¬® PRONTO
function initLoaderTranslations() {
    const i18n = window.i18nPDP && window.i18nPDP();
    if (!i18n) {
        setTimeout(initLoaderTranslations, 50);
        return;
    }
    
    // Traduci titolo
    const titleEl = document.getElementById('loaderTitle');
    if (titleEl) titleEl.textContent = i18n.t('cart_loader_title');
    
    // Traduci hint
    const hintEl = document.getElementById('loaderHint');
    if (hintEl) hintEl.textContent = i18n.t('cart_loader_cart_preparing');
    
    // Avvia messaggi dinamici tradotti
    updateLoaderMessages();
}

// Messaggi dinamici tradotti
function updateLoaderMessages() {
    const i18n = window.i18nPDP && window.i18nPDP();
    if (!i18n) return;
    
    const loaderMessages = [
        { time: 0, key: 'cart_loader_msg1' },
        { time: 2000, key: 'cart_loader_msg2' },
        { time: 4000, key: 'cart_loader_msg3' },
        { time: 6000, key: 'cart_loader_msg4' },
        { time: 7200, key: 'cart_loader_msg5' }
    ];
    
    const messageEl = document.getElementById('loaderMessage');
    if (!messageEl) return;
    
    loaderMessages.forEach(msg => {
        setTimeout(() => {
            messageEl.style.opacity = '0';
            setTimeout(() => {
                messageEl.textContent = i18n.t(msg.key);
                messageEl.style.opacity = '1';
            }, 150);
        }, msg.time);
    });
}

// Percentuale
function updateLoaderPercentage() {
    const percentageEl = document.getElementById('loaderPercentage');
    if (!percentageEl) return;
    
    let progress = 0;
    const interval = setInterval(() => {
        progress += 1;
        if (percentageEl) percentageEl.textContent = `${progress}%`;
        if (progress >= 100) clearInterval(interval);
    }, 78);
}

// Avvia tutto
initLoaderTranslations();
updateLoaderPercentage();

// Nascondi loader dopo 7.8s
window.addEventListener('DOMContentLoaded', () => {
    setTimeout(() => {
        const loader = document.getElementById('cartLoader');
        if (loader) {
            loader.style.opacity = '0';
            setTimeout(() => loader.remove(), 600);
        }
    }, 7800);
});
</script>

<style>
/* Animazioni (invariate) */
@keyframes fillBar {
    0% { width: 0%; }
    100% { width: 100%; }
}

@keyframes shimmerBar {
    to { background-position: 200% center; }
}

@keyframes shimmer {
    to { background-position: 200% center; }
}

@keyframes cartBounce {
    0%, 100% { transform: translateY(0px) scale(1); }
    50% { transform: translateY(-8px) scale(1.05); }
}

@keyframes ripple {
    0% { 
        width: 80px; 
        height: 80px; 
        opacity: 0.6; 
    }
    100% { 
        width: 140px; 
        height: 140px; 
        opacity: 0; 
    }
}

@keyframes elegantPulse {
    0%, 100% { 
        opacity: 0.3; 
        transform: scale(0.8); 
    }
    50% { 
        opacity: 1; 
        transform: scale(1.3); 
    }
}

@keyframes float {
    0%, 100% { 
        transform: translateY(0px) translateX(0px); 
        opacity: 0.3; 
    }
    25% { 
        transform: translateY(-30px) translateX(15px); 
        opacity: 0.6; 
    }
    50% { 
        transform: translateY(-50px) translateX(-10px); 
        opacity: 0.8; 
    }
    75% { 
        transform: translateY(-30px) translateX(-20px); 
        opacity: 0.5; 
    }
}
</style>

</head>
<body>
    <!-- Selettore Lingua Premium -->
<div class="pdp-lang-selector" id="pdpLanguageSelector">
    <button class="pdp-lang-option active" data-lang="it">IT</button>
    <span class="pdp-lang-divider"></span>
    <button class="pdp-lang-option" data-lang="en">EN</button>
    <span class="pdp-lang-divider"></span>
    <button class="pdp-lang-option" data-lang="fr">FR</button>
    <span class="pdp-lang-divider"></span>
    <button class="pdp-lang-option" data-lang="de">DE</button>
    <span class="pdp-lang-divider"></span>
    <button class="pdp-lang-option" data-lang="es">ES</button>
</div>
    
    <div class="container">
        <div class="cart-header">
    <h1 class="cart-title" data-i18n="cart_title">Il Tuo Carrello</h1>
    <p class="cart-subtitle" id="itemCount">0 Articoli</p>
</div>

        <div class="cart-layout">
            <div class="cart-items" id="cartItems">
                </div>

            <div class="cart-summary">
    <h2 class="summary-title" data-i18n="cart_summary_title">Riepilogo Ordine</h2>

    <div class="progress-section">
        <div class="progress-text">
            <span data-i18n="cart_summary_shipping_progress">Spedizione gratuita a</span>
            <span class="progress-highlight" id="shippingThreshold">‚Ç¨ 150</span>
        </div>
        <div class="progress-bar">
            <div class="progress-fill" id="progressFill" style="width: 0%;"></div>
        </div>
    </div>

    <div class="summary-row">
        <span class="summary-label" data-i18n="cart_summary_subtotal">Subtotale</span>
        <span class="summary-value" id="subtotal">‚Ç¨ 0,00</span>
    </div>
    <div class="summary-row">
        <span class="summary-label" data-i18n="cart_summary_shipping">Spedizione</span>
        <span class="summary-value" id="shipping">‚Ç¨ 15,00</span>
    </div>
    <div class="summary-row" id="discountRow">
        <span class="summary-label">
           <span data-i18n="cart_summary_discount">Sconto</span>
           <span class="combo-badge" id="comboBadge" style="display: none;" data-i18n="cart_combo_badge">COMBO</span>
        </span>
        <span class="summary-value" id="discount">- ‚Ç¨ 0,00</span>
    </div>

    <div class="promo-code">
       <label class="promo-label" data-i18n="cart_coupon_label">Codice Promozionale</label>
       <div class="promo-input-wrapper">
           <input type="text" class="promo-input" id="couponInput" data-i18n-placeholder="cart_coupon_placeholder" placeholder="Inserisci codice">
           <button class="promo-apply" id="applyCouponBtn" data-i18n="cart_coupon_apply_btn">Applica</button>
       </div>
       <div class="promo-message" id="couponMessage"></div>
    </div>

    <div class="summary-row summary-total">
        <span class="summary-label" data-i18n="cart_summary_total">Totale</span>
        <span class="summary-value" id="total">‚Ç¨ 0,00</span>
    </div>

    <div id="lhCartEarlyWrap">
      <div class="lh-ea-badge" style="margin-bottom:0.7rem">
        <span class="lh-pulse"></span>
        <span>ü•á Founder Reservation Program</span>
      </div>
      <button type="button" id="cartReserveBtn" class="btn-reserve">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg>
        <span data-i18n="reserve_btn_cart">Prenota Ora ‚Äî Early Access</span>
      </button>
    </div>
    <button type="button" class="checkout-btn" id="checkoutBtn" data-i18n="cart_checkout_btn" style="display:none">Procedi al Checkout</button>

    <div class="trust-badges">
        <div class="trust-badge">
            <span class="trust-icon">üîí</span>
            <span data-i18n="cart_trust_secure">Pagamenti sicuri e protetti</span>
        </div>
        <div class="trust-badge">
            <span class="trust-icon">‚Üª</span>
            <span data-i18n="cart_trust_return">Rimborso in caso di difetto accertato</span>
        </div>
        <div class="trust-badge">
            <span class="trust-icon">‚úî</span>
            <span data-i18n="cart_trust_guarantee">Garanzia su difetti di produzione</span>
        </div>
    </div>

    <!-- ‚îÄ‚îÄ Refund Policy ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
    <div class="refund-policy" id="refundPolicy">
        <div class="refund-policy__header" onclick="toggleRefundPolicy()">
            <div class="refund-policy__icon">üîÑ</div>
            <span class="refund-policy__title" data-i18n="refund_title">Politica di Rimborso</span>
            <span class="refund-policy__chevron">‚ñº</span>
        </div>
        <div class="refund-policy__body">
            <div class="refund-policy__inner">

                <!-- Quando √® possibile -->
                <div class="refund-policy__block">
                    <div class="refund-policy__dot refund-policy__dot--green"></div>
                    <div class="refund-policy__block-text">
                        <strong data-i18n="refund_when_title">Quando hai diritto al rimborso</strong><br>
                        <span data-i18n="refund_when_text">Accettiamo richieste di rimborso esclusivamente per prodotti difettosi, danneggiati alla consegna o con errori documentati di produzione.</span>
                    </div>
                </div>

                <!-- Quando NON √® possibile -->
                <div class="refund-policy__block">
                    <div class="refund-policy__dot refund-policy__dot--red"></div>
                    <div class="refund-policy__block-text">
                        <strong data-i18n="refund_not_title">Cosa non d√† diritto al rimborso</strong><br>
                        <span data-i18n="refund_not_text">Cambi di taglia, variazioni di colore, preferenze estetiche o ripensamenti personali non costituiscono motivo di rimborso.</span>
                    </div>
                </div>

                <!-- Come procedere -->
                <div class="refund-policy__block">
                    <div class="refund-policy__dot refund-policy__dot--amber"></div>
                    <div class="refund-policy__block-text">
                        <strong data-i18n="refund_how_title">Come richiedere un rimborso</strong>
                        <ul class="refund-policy__steps">
                            <li>
                                <span class="refund-policy__step-num">1</span>
                                <span data-i18n="refund_step1">Fotografa il difetto entro 48 ore dalla ricezione del pacco.</span>
                            </li>
                            <li>
                                <span class="refund-policy__step-num">2</span>
                                <span data-i18n="refund_step2">Contattaci via email con numero d'ordine e foto allegate.</span>
                            </li>
                            <li>
                                <span class="refund-policy__step-num">3</span>
                                <span data-i18n="refund_step3">Il nostro team valuter√† la richiesta entro 2 giorni lavorativi e ti guider√† nella procedura.</span>
                            </li>
                        </ul>
                    </div>
                </div>

            </div>
        </div>
    </div>
</div>
        </div>

        <div class="recommended-section">
    <h2 class="recommended-title" data-i18n="cart_recommended_title">Potrebbero interessarti anche</h2>
    <div class="recommended-grid" id="recommendedGrid">
        <div id="recommendedLoader" style="grid-column: 1/-1; text-align: center; padding: 4rem 2rem;">
            <div style="display: inline-block; margin-bottom: 1.5rem;">
                <svg width="50" height="50" viewBox="0 0 50 50" style="animation: spin 1s linear infinite;">
                    <circle cx="25" cy="25" r="20" fill="none" stroke="#D4AF37" stroke-width="3" stroke-dasharray="80, 200" stroke-linecap="round"/>
                </svg>
            </div>
            <div style="font-size: 1.125rem; color: #d4d4d8; font-weight: 300; margin-bottom: 0.5rem; letter-spacing: -0.01em;" data-i18n="cart_recommended_loading">
                Selezioniamo i migliori prodotti per te
            </div>
            <div style="font-size: 0.875rem; color: #71717a;" data-i18n="cart_recommended_loading_sub">
                In base ai tuoi gusti e agli articoli nel carrello
            </div>
        </div>
    </div>
</div>

<style>
@keyframes spin {
    to { transform: rotate(360deg); }
}
</style>
        </div>
    </div>

    <!-- Connection Monitor Script -->
    <script src="../connection-monitor.js"></script>

    <!-- ‚≠ê SCRIPT PRINCIPALE CORRETTO (Sostituisci l'intero <script> dopo il body) -->
<script>
    let cart = JSON.parse(localStorage.getItem('lh360_cart')) || [];
    const webAppUrl = 'https://script.google.com/macros/s/AKfycbwr79RkXIEocpuOKaM6uMJqE6VFs9wjlUPvrr__FvDbDDrD2ELB1NbfrWP3BCYpHj2u/exec';
    let appliedCoupon = null;

    // === FUNZIONI TRACKING COUPON (invariate) ===
    function getUserId() {
        let userId = localStorage.getItem('lh360_user_id');
        if (!userId) {
            userId = 'USER_' + Date.now() + '_' + Math.random().toString(36).substring(2, 15);
            localStorage.setItem('lh360_user_id', userId);
        }
        return userId;
    }

    /**
 * ‚úÖ Calcola soglia spedizione convertita nella valuta corrente
 */
function getShippingThreshold() {
    const baseThreshold = 150; // Sempre in EUR
    const i18n = window.i18nPDP();
    
    if (!i18n) return baseThreshold;
    
    // Configurazione valute per lingua
    const currencyConfig = {
        it: { currency: 'EUR', rate: 1 },
        fr: { currency: 'EUR', rate: 1 },
        de: { currency: 'EUR', rate: 1 },
        es: { currency: 'EUR', rate: 1 },
        en: { currency: 'USD', rate: 1.17 }
    };
    
    const config = currencyConfig[i18n.currentLang] || { currency: 'EUR', rate: 1 };
    return baseThreshold * config.rate;
}

    function hasCouponBeenUsed(couponCode) {
        const usedCoupons = JSON.parse(localStorage.getItem('lh360_used_coupons') || '{}');
        const userId = getUserId();
        return usedCoupons[userId]?.includes(couponCode.toUpperCase());
    }

    function markCouponAsUsed(couponCode) {
        const usedCoupons = JSON.parse(localStorage.getItem('lh360_used_coupons') || '{}');
        const userId = getUserId();
        if (!usedCoupons[userId]) usedCoupons[userId] = [];
        if (!usedCoupons[userId].includes(couponCode.toUpperCase())) {
            usedCoupons[userId].push(couponCode.toUpperCase());
            localStorage.setItem('lh360_used_coupons', JSON.stringify(usedCoupons));
        }
    }

    // ‚úÖ Aggiungi questa funzione PRIMA di renderCart()
    function validateCartPrices() {
    let hasChanges = false;
    
    cart = cart.map(item => {
        // Se esiste un discountPrice, verifica la coerenza del rapporto prezzo/sconto
        if (item.discountPrice && item.price) {
            const ratio = item.price / item.discountPrice;
            
            // Se il rapporto √® > 2.5x, il prezzo originale √® probabilmente errato
            // (uno sconto del 60%+ sarebbe ratio = 2.5)
            if (ratio > 2.5) {
                console.warn(`‚ö†Ô∏è Prezzo sospetto per ${item.title}:`);
                console.warn(`   - Prezzo mostrato: ‚Ç¨${item.price}`);
                console.warn(`   - Prezzo scontato: ‚Ç¨${item.discountPrice}`);
                console.warn(`   - Rapporto: ${ratio.toFixed(2)}x`);
                
                // Stima il prezzo corretto: assumiamo sconto standard del 35-40%
                // Se discountPrice = 75‚Ç¨ e sconto = 37.5%, allora price = 75 / 0.625 = 120‚Ç¨
                const estimatedPrice = Math.round(item.discountPrice / 0.625);
                
                console.warn(`   - Prezzo corretto stimato: ‚Ç¨${estimatedPrice}`);
                item.price = estimatedPrice;
                hasChanges = true;
            }
        }
        
        return item;
    });
    
    if (hasChanges) {
        localStorage.setItem('lh360_cart', JSON.stringify(cart));
        console.log('‚úÖ Prezzi carrello corretti e salvati');
    }
}

    // === RENDERING CARRELLO ===
    function renderCart(skipPriceUpdate = false, preserveDiscount = false) {
    validateCartPrices();
    
    const cartItemsContainer = document.getElementById('cartItems');
    cartItemsContainer.innerHTML = '';
        
    if (cart.length === 0) {
        checkEmptyCart();
        } else {
            cart.forEach((item, index) => {
                let variantHTML = '';
if (item.color || item.size) {
    const variantParts = [];
    if (item.color) {
        // ‚úÖ Traduce il colore nella lingua corrente
        const i18nInst = window.i18nPDP();
        const currentLang = i18nInst ? i18nInst.currentLang : 'it';
        const translatedColor = (typeof translateColorName === 'function')
            ? translateColorName(item.color, currentLang)
            : item.color;
        variantParts.push(translatedColor);
    }
    
    if (item.size) {
    const i18n = window.i18nPDP();
    const currentLang = i18n ? i18n.currentLang : (localStorage.getItem('lh360_lang') || 'it');

    // Riconosce "taglia unica" in qualsiasi lingua (anche se salvata gi√† tradotta)
    const ONE_SIZE_VALUES = new Set([
        'Unica', 'Taglia Unica',
        'One Size',
        'Unique', 'Taille Unique',
        'Einheitsgr√∂√üe',
        '√önica', 'Talla √önica'
    ]);

    if (ONE_SIZE_VALUES.has(item.size)) {
        // ‚úÖ One size: mostra solo il valore completo tradotto, senza prefisso
        const oneSizeFullMap = { it:'Taglia Unica', en:'One Size', fr:'Taille Unique', de:'Einheitsgr√∂√üe', es:'Talla √önica' };
        variantParts.push(oneSizeFullMap[currentLang] || 'Taglia Unica');
    } else {
        // ‚úÖ Taglia normale: prefisso tradotto + valore taglia
        const sizeLabel = i18n ? i18n.t('cart_item_size_label') : 'Taglia';
        variantParts.push(`${sizeLabel} ${item.size}`);
    }
}
    const variantText = variantParts.join(' ¬∑ '); // Middot Unicode: U+00B7
    
    variantHTML = '<div class="item-variant">';
    if (item.color) {
        const colorMap = {
            // Italiano
            'Nero': '#000000', 'Bianco': '#FFFFFF', 'Grigio': '#808080',
            'Grigio Chiaro': '#C0C0C0', 'Grigio Scuro': '#404040',
            'Blu': '#0000FF', 'Blu Navy': '#001F5B', 'Blu Navy Scuro': '#202835',
            'Blu Scuro': '#00008B', 'Blu Reale': '#4169E1', 'Celeste': '#87CEEB',
            'Rosso': '#FF0000', 'Rosso Scuro': '#8B0000', 'Bordeaux': '#800020',
            'Verde': '#008000', 'Verde Oliva': '#808000', 'Verde Bosco': '#228B22',
            'Giallo': '#FFFF00', 'Giallo Ocra': '#CC7722',
            'Arancione': '#FFA500', 'Viola': '#800080', 'Lilla': '#C8A2C8',
            'Marrone': '#A52A2A', 'Camel': '#C19A6B', 'Cammello': '#C19A6B',
            'Oro': '#FFD700', 'Argento': '#C0C0C0',
            'Beige': '#F5F5DC', 'Sabbia': '#C2B280', 'Panna': '#FFFDD0',
            'Rosa': '#FFC0CB', 'Rosa Antico': '#DB7093',
            'Bianco Sporco': '#FAF0E6', '√âcru': '#F0EAD6',
            'Antracite': '#2F2F2F', 'Grafite': '#383838',
            // Inglese
            'Black': '#000000', 'White': '#FFFFFF', 'Grey': '#808080',
            'Blue': '#0000FF', 'Navy Blue': '#001F5B', 'Dark Navy Blue': '#202835',
            'Red': '#FF0000', 'Green': '#008000', 'Yellow': '#FFFF00',
            'Orange': '#FFA500', 'Purple': '#800080', 'Brown': '#A52A2A',
            'Gold': '#FFD700', 'Silver': '#C0C0C0', 'Beige': '#F5F5DC',
            'Pink': '#FFC0CB', 'Cream': '#FFFDD0', 'Sand': '#C2B280'
        };
        const cssColor = colorMap[item.color] || item.color;
        const isLight = ['#FFFFFF', 'white', '#F5F5DC', 'beige'].includes(cssColor.toLowerCase());
        const borderStyle = isLight ? 'border: 1px solid rgba(255,255,255,0.3);' : '';
        variantHTML += `<div class="variant-detail"><span class="color-dot" style="background-color: ${cssColor}; ${borderStyle}"></span><span>${variantText}</span></div>`;
    } else {
        variantHTML += `<div class="variant-detail"><span>${variantText}</span></div>`;
    }
    variantHTML += '</div>';
}
                
                const finalPrice = (item.discountPrice && item.discountPrice < item.price) ? item.discountPrice : item.price;
const hasDiscount = item.discountPrice && item.discountPrice < item.price;

// ‚úÖ FORMATTA PREZZI CON i18n SUBITO
const i18n = window.i18nPDP();
const formattedOriginalPrice = i18n ? i18n.formatPrice(item.price, item.currency || 'EUR') : `‚Ç¨ ${item.price.toFixed(2).replace('.', ',')}`;
const formattedFinalPrice = i18n ? i18n.formatPrice(finalPrice, item.currency || 'EUR') : `‚Ç¨ ${finalPrice.toFixed(2).replace('.', ',')}`;

// Calcola quantit√† badge
const qtyBadge = (item.qty && item.qty > 1) 
    ? `<span class="item-quantity-badge">x${item.qty}</span>` 
    : '';

const itemElement = document.createElement('div');
itemElement.className = 'cart-item';
itemElement.dataset.id = index;
itemElement.innerHTML = `
    <div class="item-image">
        <img src="${item.image || 'https://via.placeholder.com/140x186?text=' + encodeURIComponent(item.title)}" alt="${item.title}">
    </div>
    <div class="item-details">
        <div class="item-name">
            ${item.title}${qtyBadge}
        </div>
        ${variantHTML}
        <div class="item-actions">
            <button class="remove-btn" onclick="removeItem(${index})" data-i18n="cart_item_remove">Rimuovi</button>
        </div>
    </div>
    <div class="item-price-section">
        ${hasDiscount ? `<div class="item-original-price">${formattedOriginalPrice}</div>` : ''}
        <div class="item-price">${formattedFinalPrice}</div>
    </div>
`;
cartItemsContainer.appendChild(itemElement);
            });

            // ‚úÖ AGGIORNA CONTEGGIO ARTICOLI PRIMA DELLE TRADUZIONI
const itemCount = cart.reduce((sum, item) => sum + (item.qty || 1), 0);
const itemCountEl = document.getElementById('itemCount');

        const i18n = window.i18nPDP();
if (i18n) {
    // ‚úÖ AGGIORNA CONTEGGIO CON TRADUZIONE CORRETTA
    if (itemCountEl && itemCount > 0) {
        const itemCountText = itemCount === 1 
            ? i18n.t('cart_items_count_one') 
            : i18n.t('cart_items_count_many', { n: itemCount });
        itemCountEl.textContent = itemCountText;
    }
    
    // Traduci elementi dinamici
    document.querySelectorAll('[data-i18n]').forEach(el => {
        const key = el.getAttribute('data-i18n');
        const translation = i18n.t(key);
        if (translation) {
            if (el.tagName === 'INPUT' && el.hasAttribute('data-i18n-placeholder')) {
                el.placeholder = translation;
            } else {
                el.textContent = translation;
            }
        }
    });
    
    // ‚úÖ AGGIUNGI FORMATTAZIONE SOGLIA SPEDIZIONE QUI ‚¨áÔ∏è
    const shippingThresholdEl = document.getElementById('shippingThreshold');
    if (shippingThresholdEl) {
        shippingThresholdEl.textContent = i18n.formatPrice(150);
    }
} // ‚¨ÖÔ∏è Questa chiude if (i18n)
        }  // ‚¨ÖÔ∏è Questa chiude l'else
        
        // Evita loop infinito
        if (!skipPriceUpdate) {
            updateSummaryImmediate(!preserveDiscount); // ‚úÖ Passa il flag
            
            if (typeof updateAllPricesForLanguage === 'function') {
                updateAllPricesForLanguage();
            }
        }
    }

    /**
 * ‚úÖ Ripristina coupon salvato (OTTIMIZZATO - evita calcoli multipli)
 */
  async function restoreAppliedCoupon() {
  const savedCoupon = localStorage.getItem('lh360_applied_coupon');
  
  if (!savedCoupon) return;

  try {
    const couponData = JSON.parse(savedCoupon);
    const { code, discountPercent } = couponData;

    if (!code || !discountPercent) {
      localStorage.removeItem('lh360_applied_coupon');
      return;
    }

    // ‚úÖ AGGIORNA SUBITO IL CONTEGGIO ARTICOLI PRIMA DELLA VALIDAZIONE
    const i18n = window.i18nPDP();
    if (i18n) {
        const itemCount = cart.reduce((sum, item) => sum + (item.qty || 1), 0);
        const itemCountText = itemCount === 1 
            ? i18n.t('cart_items_count_one') 
            : i18n.t('cart_items_count_many', { n: itemCount });
        document.getElementById('itemCount').textContent = itemCountText;
    }

    // Valida coupon con backend
    const response = await fetch(`${webAppUrl}?action=validate_coupon&code=${encodeURIComponent(code)}&t=${Date.now()}`);
    const result = await response.json();

    if (result.success && result.valid) {
      appliedCoupon = { 
        code: code, 
        discountPercent: discountPercent,
        appliedAt: Date.now()
      };
      
      document.getElementById('couponInput').value = code;
      
      await updateSummaryWithCoupon();
      
      // ‚úÖ Mostra messaggio ripristino TRADOTTO
      if (i18n) {
        showCouponMessage('cart_coupon_restored', 'success', {
          code: code,
          percent: discountPercent
        });
      }
      
    } else {
      localStorage.removeItem('lh360_applied_coupon');
      appliedCoupon = null;
      
      const errorMsg = (result.error && result.error.includes('utilizzato')) 
        ? 'cart_coupon_used' 
        : 'cart_coupon_expired';
      
      showCouponMessage(errorMsg, 'error', { code: code });
      
      await updateSummary();
    }
  } catch (error) {
    console.error('‚ùå Errore recupero coupon:', error);
    localStorage.removeItem('lh360_applied_coupon');
    appliedCoupon = null;
  }
}

    // ‚úÖ RIMOZIONE IMMEDIATA con aggiornamento completo instantaneo
    async function removeItem(index) {
    const itemElement = document.querySelector(`[data-id="${index}"]`);
    if (!itemElement) return;
    
    // 1. RIMOZIONE IMMEDIATA dal carrello
    cart.splice(index, 1);
    localStorage.setItem('lh360_cart', JSON.stringify(cart));
    
    // 2. ‚úÖ AGGIORNAMENTO COMPLETO IMMEDIATO (con sconti combo)
    if (cart.length > 0) {
        showDiscountCalculating();
        
        const i18n = window.i18nPDP();
        const itemCount = cart.reduce((sum, item) => sum + (item.qty || 1), 0);
        const itemCountEl = document.getElementById('itemCount');
        if (itemCountEl && i18n) {
            let itemCountText;
            if (itemCount === 0) {
                itemCountText = i18n.t('cart_items_count_zero');
            } else if (itemCount === 1) {
                itemCountText = i18n.t('cart_items_count_one');
            } else {
                itemCountText = i18n.t('cart_items_count_many', { n: itemCount });
            }
            itemCountEl.textContent = itemCountText;
        }
        
        await updateSummary();
    }
    
    // 3. ‚úÖ Animazione fade out PARALLELA
    itemElement.style.transition = 'opacity 0.2s, transform 0.2s';
    itemElement.style.opacity = '0';
    itemElement.style.transform = 'translateX(-1rem)';
    
    // 4. Rimuovi elemento DOM e ri-renderizza
    setTimeout(() => {
        if (cart.length === 0) {
            checkEmptyCart();
        } else {
            renderCart(false, true); // ‚úÖ MODIFICA: passa true per preservare lo sconto
        }
    }, 200);
}

   async function updateSummary() {
    let subtotal = 0;
    let itemCount = 0;
    
    cart.forEach(item => {
        const finalPrice = (item.discountPrice && item.discountPrice < item.price) ? item.discountPrice : item.price;
        subtotal += finalPrice * (item.qty || 1);
        itemCount += (item.qty || 1);
    });

    // Verifica sconti combo
    let discount = 0;
    let isComboDiscount = false;

    try {
        const skuList = cart.map(item => item.sku).join(',');
        const response = await fetch(`${webAppUrl}?action=check_combo&skus=${encodeURIComponent(skuList)}&t=${Date.now()}`);
        const result = await response.json();

        if (result.success && result.comboDiscount > 0) {
            discount = result.comboDiscount;
            isComboDiscount = true;
        }
    } catch (error) {
        console.error('Errore verifica combo:', error);
    }

    // Considera coupon se applicato
    if (appliedCoupon) {
        const couponDiscount = (subtotal * appliedCoupon.discountPercent) / 100;
        discount += couponDiscount;
    }

    // Calcola spedizione
    const shippingThreshold = getShippingThreshold();
const totalAfterDiscounts = subtotal - discount;
const shipping = totalAfterDiscounts >= shippingThreshold ? 0 : 15;
const total = subtotal + shipping - discount;

    // Aggiorna UI con prezzi formattati
    const i18n = window.i18nPDP();
    if (i18n) {
        document.getElementById('subtotal').textContent = i18n.formatPrice(subtotal);
        document.getElementById('shipping').textContent = shipping === 0 
            ? i18n.t('cart_summary_shipping_free') 
            : i18n.formatPrice(shipping);
        document.getElementById('total').textContent = i18n.formatPrice(total);
        
        // Aggiorna conteggio articoli
        const itemCountText = itemCount === 1 
            ? i18n.t('cart_items_count_one') 
            : i18n.t('cart_items_count_many', { n: itemCount });
        document.getElementById('itemCount').textContent = itemCountText;
    }
    
    showDiscountValue(discount, isComboDiscount);

       localStorage.setItem('lh360_applied_discounts', JSON.stringify({
    comboDiscount: isComboDiscount ? discount : 0,
    couponDiscount: appliedCoupon ? (subtotal * appliedCoupon.discountPercent) / 100 : 0,
    couponCode: appliedCoupon ? appliedCoupon.code : null,
    isComboActive: isComboDiscount,
    totalDiscount: discount,
    timestamp: Date.now()
}));

    const progress = Math.min(100, (totalAfterDiscounts / 150) * 100);
const progressBar = document.getElementById('progressFill');

// ‚úÖ GESTIONE COMPLETAMENTO BARRA
if (totalAfterDiscounts >= 150) {
    progressBar.style.width = '100%';
    progressBar.style.background = 'linear-gradient(90deg, #34d399, #10b981)';
} else {
    progressBar.style.width = `${progress}%`;
    progressBar.style.background = 'linear-gradient(90deg, #34d399, #10b981)';
}
}

    /**
 * ‚úÖ AGGIORNAMENTO IMMEDIATO UI (senza chiamate async)
 * Calcola e mostra istantaneamente: subtotale, articoli, barra progresso
 */
  function updateSummaryImmediate(showCalculating = true) {
    const i18n = window.i18nPDP(); 
    
    let subtotal = 0;
    let itemCount = 0;
    
    cart.forEach(item => {
        const finalPrice = (item.discountPrice && item.discountPrice < item.price) 
            ? item.discountPrice 
            : item.price;
        subtotal += finalPrice * (item.qty || 1);
        itemCount += (item.qty || 1);
    });

    const shippingThreshold = getShippingThreshold();
    const shipping = subtotal >= shippingThreshold ? 0 : 15;
    
    let couponDiscount = 0;
    if (appliedCoupon) {
        couponDiscount = (subtotal * appliedCoupon.discountPercent) / 100;
    }
    
    const totalWithCoupon = subtotal + shipping - couponDiscount;

    if (i18n) {
        document.getElementById('subtotal').textContent = i18n.formatPrice(subtotal);
        document.getElementById('shipping').textContent = shipping === 0 
            ? i18n.t('cart_summary_shipping_free') 
            : i18n.formatPrice(shipping);
        document.getElementById('total').textContent = i18n.formatPrice(totalWithCoupon);
        
        const itemCountText = itemCount === 1 
            ? i18n.t('cart_items_count_one') 
            : i18n.t('cart_items_count_many', { n: itemCount });
        document.getElementById('itemCount').textContent = itemCountText;
    } else {
        document.getElementById('subtotal').textContent = `‚Ç¨ ${subtotal.toFixed(2).replace('.', ',')}`;
        document.getElementById('shipping').textContent = shipping === 0 ? 'Gratuita' : `‚Ç¨ ${shipping.toFixed(2).replace('.', ',')}`;
        document.getElementById('total').textContent = `‚Ç¨ ${totalWithCoupon.toFixed(2).replace('.', ',')}`;
        document.getElementById('itemCount').textContent = itemCount === 1 ? '1 Articolo' : `${itemCount} Articoli`;
    }

    const progress = Math.min(100, (subtotal / 150) * 100);
    document.getElementById('progressFill').style.width = `${progress}%`;

    const shippingThresholdEl = document.getElementById('shippingThreshold');
    if (shippingThresholdEl && i18n) {
        shippingThresholdEl.textContent = i18n.formatPrice(getShippingThreshold());
    }
    
    // ‚úÖ MODIFICA: mostra "Calcolo..." solo se richiesto
    if (cart.length > 0 && showCalculating) {
        showDiscountCalculating();
    } else if (cart.length === 0) {
        showDiscountValue(0);
    }
    // Se showCalculating √® false, mantiene il valore esistente nello sconto
}

 /**
 * ‚úÖ Mostra indicatore "Calcolo..." per sconti in elaborazione
 */
  function showDiscountCalculating() {
    const discountEl = document.getElementById('discount');
    const discountRow = document.getElementById('discountRow');
    const comboBadge = document.getElementById('comboBadge');
    const i18n = window.i18nPDP();
    
    if (comboBadge) {
        comboBadge.style.display = 'none';
    }
    
    // ‚úÖ TRADUZIONE DINAMICA
    const calculatingText = i18n ? i18n.t('cart_coupon_calculating') : 'Calcolo...';
    
    discountEl.innerHTML = `
        <span class="discount-calculating">
            <span class="discount-calculating-text">${calculatingText}</span>
        </span>
    `;
    discountRow.classList.add('discount-active');
}

/**
 * ‚úÖ Mostra valore sconto finale (o nasconde se zero)
 */
 function showDiscountValue(totalDiscount, isCombo = false) {
    const discountEl = document.getElementById('discount');
    const discountRow = document.getElementById('discountRow');
    const comboBadge = document.getElementById('comboBadge');
    const i18n = window.i18nPDP();
    
    if (totalDiscount > 0) {
        discountEl.innerHTML = `- ${i18n ? i18n.formatPrice(totalDiscount) : '‚Ç¨ ' + totalDiscount.toFixed(2).replace('.', ',')}`;
        discountRow.classList.add('discount-active');
        
        if (comboBadge) {
            // ‚úÖ TRADUZIONE DINAMICA DEL BADGE
            if (isCombo) {
                comboBadge.textContent = i18n ? i18n.t('cart_combo_badge') : 'COMBO';
                comboBadge.style.display = 'inline-block';
            } else {
                comboBadge.style.display = 'none';
            }
        }
    } else {
        discountEl.textContent = `- ${i18n ? i18n.formatPrice(0) : '‚Ç¨ 0,00'}`;
        discountRow.classList.remove('discount-active');
        if (comboBadge) comboBadge.style.display = 'none';
    }
}

    function checkEmptyCart() {
    document.querySelector('.cart-layout').style.gridTemplateColumns = '1fr';
    const i18n = window.i18nPDP();
    
    document.getElementById('cartItems').innerHTML = `
        <div class="empty-cart">
            <div class="empty-cart-icon">${i18n.t('cart_empty_icon')}</div>
            <h2>${i18n.t('cart_empty_title')}</h2>
            <p>${i18n.t('cart_empty_subtitle')}</p>
            <a href="/luxhaven360-site/index.html#shop" class="btn-continue">${i18n.t('cart_empty_cta')}</a>
        </div>
    `;
    document.querySelector('.cart-summary').style.display = 'none';
}

    function updateShippingThreshold() {
    const i18n = window.i18nPDP();
    if (!i18n) return;
    
    const shippingThresholdEl = document.getElementById('shippingThreshold');
    if (shippingThresholdEl) {
        shippingThresholdEl.textContent = i18n.formatPrice(getShippingThreshold());
    }
}

    /**
 * ‚úÖ Inizializza carrello con sequenza ottimizzata
 * Evita calcoli multipli durante il ripristino coupon
 */
async function initializeCart() {
  const i18n = window.i18nPDP();
  if (!i18n) {
    console.error('‚ùå i18nPDP non inizializzato!');
    setTimeout(initializeCart, 100);
    return;
  }
  
  console.log(`‚úÖ Carrello inizializzato con lingua: ${i18n.currentLang.toUpperCase()}`);
  
  // 1. AGGIORNA CONTEGGIO ARTICOLI IMMEDIATO
  const itemCount = cart.reduce((sum, item) => sum + (item.qty || 1), 0);
  const itemCountEl = document.getElementById('itemCount');
  if (itemCountEl && itemCount > 0) {
    const itemCountText = itemCount === 1 
      ? i18n.t('cart_items_count_one') 
      : i18n.t('cart_items_count_many', { n: itemCount });
    itemCountEl.textContent = itemCountText;
  }
  
  // 1.5. ‚úÖ MOSTRA "Calcolo..." PRIMA DI QUALSIASI OPERAZIONE
  if (cart.length > 0) {
    showDiscountCalculating();
  }
  
  // 2 Rendering DOM
  renderCart(); 
  updateShippingThreshold();
  
  // 2a. Ripristina coupon (se presente) e calcola sconti
  await restoreAppliedCoupon();
  
  // 3. Se NON c'era coupon da ripristinare, calcola normalmente
  if (!appliedCoupon) {
    await updateSummary();
  }
  
  // 4. Carica prodotti consigliati
  loadRecommendedProducts();

  // 5. ‚úÖ Applica lo stato del pulsante di prenotazione DOPO che il rendering e
  // la traduzione i18n sono completati. La chiamata nel DOMContentLoaded non √®
  // sufficiente perch√© renderCart() + i18n.applyTranslations() vengono eseguiti
  // dentro initializeCart(), sovrascrivendo il testo del bottone con la chiave
  // generica data-i18n="reserve_btn_cart" ‚Üí "Prenota Ora ‚Äî Early Access".
  if (typeof window.lhApplyReservationUI === 'function') {
    let cartSku = null;
    try {
      const cartState = JSON.parse(localStorage.getItem('lh360_cart') || '[]');
      if (cartState.length === 1) cartSku = cartState[0].sku || null;
    } catch(e) {}
    window.lhApplyReservationUI(cartSku, 'cart');
  }
}

    /**
 * ‚úÖ Ricarica tassi di cambio e aggiorna UI
 */
async function reloadExchangeRates() {
  const i18n = window.i18nPDP();
  if (i18n && typeof i18n.loadExchangeRates === 'function') {
    await i18n.loadExchangeRates();
    console.log('‚úÖ Tassi ricaricati in cart.html');
  }
}

// Carica tassi all'avvio
document.addEventListener('DOMContentLoaded', () => {
  reloadExchangeRates();
});

// ‚úÖ ASPETTA CHE i18n SIA PRONTO
document.addEventListener('DOMContentLoaded', () => {
    // Aspetta un tick per assicurarsi che i18nPDP sia completamente inizializzato
    setTimeout(() => {
        initializeCart();
    }, 50);
});

/**
 * Carica prodotti consigliati basati sulla categoria del carrello
 */
async function loadRecommendedProducts() {
    // Mostra loader (se esiste gi√† nel DOM, altrimenti skip)
const loader = document.getElementById('recommendedLoader');
    try {
        const container = document.getElementById('recommendedGrid');
        if (!container) return;
        
        // Determina categoria prevalente nel carrello
        const categories = cart.map(item => {
            const skuPrefix = item.sku ? item.sku.split('-')[0] : 'ME';
            return { 'PR': 'properties', 'SC': 'supercars', 'EX': 'stays', 'ME': 'shop' }[skuPrefix] || 'shop';
        });
        
        const categoryCount = categories.reduce((acc, cat) => {
            acc[cat] = (acc[cat] || 0) + 1;
            return acc;
        }, {});
        
        const targetCategory = Object.keys(categoryCount).sort((a, b) => categoryCount[b] - categoryCount[a])[0] || 'shop';
        
        // Fetch prodotti dalla stessa categoria
        const response = await fetch(`${webAppUrl}?action=get_products&category=${targetCategory}`);
        const result = await response.json();
        
        if (!result.success || !result.products || result.products.length === 0) {
            container.innerHTML = '<p style="text-align:center;color:#71717a;">Nessun prodotto correlato disponibile</p>';
            return;
        }
        
        // Escludi prodotti gi√† nel carrello
        const cartSkus = cart.map(item => item.sku);
        let availableProducts = result.products.filter(p => !cartSkus.includes(p.sku));
        
        // Se dopo il filtro non rimangono prodotti, mostra comunque quelli del carrello
        if (availableProducts.length === 0) {
            availableProducts = result.products;
        }
        
        // Seleziona 4 prodotti casuali
        const shuffled = availableProducts.sort(() => 0.5 - Math.random());
        const selected = shuffled.slice(0, 4);
        
        // Genera HTML
        container.innerHTML = selected.map((product, index) => {
    const isFeatured = index === 0;
    const featuredClass = isFeatured ? ' featured' : '';
    const badgeHtml = isFeatured ? `<div class="recommended-badge" data-i18n="cart_recommended_badge">‚ú¶ Consigliato</div>` : '';
    
    // ‚úÖ Descrizione breve: lookup SKU su translationsBriefDescriptions, fallback su product.desc
    const i18n = window.i18nPDP();
    const currentLang = i18n ? i18n.currentLang : 'it';
    let rawDesc = product.desc || '';
    if (window.translationsBriefDescriptions && product.sku && window.translationsBriefDescriptions[product.sku]) {
        rawDesc = window.translationsBriefDescriptions[product.sku][currentLang]
               || window.translationsBriefDescriptions[product.sku]['it']
               || rawDesc;
    }
    const shortDesc = rawDesc.length > 60 ? rawDesc.substring(0, 60) + '...' : rawDesc;
    
    // ‚úÖ NUOVO: Logica Sconto
    const hasDiscount = product.discountPrice && product.discountPrice < product.price;
    const originalPrice = parseFloat(product.price) || 0;
    const finalPrice = hasDiscount ? parseFloat(product.discountPrice) : originalPrice;
    const discountPercent = hasDiscount ? Math.round(((originalPrice - finalPrice) / originalPrice) * 100) : 0;
    
    // ‚úÖ HTML Prezzo con Sconto (con data attributes per aggiornamento dinamico)
const priceHtml = hasDiscount 
    ? `
        <div style="display: flex; flex-direction: column; gap: 0.35rem; align-items: flex-start;">
            <div style="font-size: 0.75rem; color: #71717a; text-decoration: line-through; font-weight: 300;">
                ${i18n ? i18n.formatPrice(originalPrice, product.currency || 'EUR') : `‚Ç¨ ${originalPrice.toLocaleString('it-IT', {minimumFractionDigits: 2})}`}
            </div>
            <div style="display: flex; align-items: center; gap: 0.5rem;">
                <span style="font-size: 1.125rem; font-weight: 700; background: linear-gradient(135deg, #D4AF37, #FFD700); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;">
                    ${i18n ? i18n.formatPrice(finalPrice, product.currency || 'EUR') : `‚Ç¨ ${finalPrice.toLocaleString('it-IT', {minimumFractionDigits: 2})}`}
                </span>
                <span style="display: inline-block; background: linear-gradient(135deg, #D4AF37, #FFD700); color: #09090b; padding: 0.2rem 0.5rem; border-radius: 1rem; font-size: 0.65rem; font-weight: 700; letter-spacing: 0.05em; box-shadow: 0 2px 8px rgba(212, 175, 55, 0.3);">
                    -${discountPercent}%
                </span>
            </div>
        </div>
    `
    : `<div class="recommended-price">${i18n ? i18n.formatPrice(finalPrice, product.currency || 'EUR') : `‚Ç¨ ${finalPrice.toLocaleString('it-IT', {minimumFractionDigits: 2})}`}</div>`;
    
    return `
<a href="pdp-products.html?sku=${product.sku}" 
   class="recommended-item${featuredClass}"
   data-sku="${product.sku}"
   data-original-price="${originalPrice}"
   data-discount-price="${hasDiscount ? finalPrice : ''}"
   data-original-currency="${product.currency || 'EUR'}"
   style="text-decoration: none; color: inherit; display: block;">
            ${badgeHtml}
            <div class="recommended-image">
                <!-- Usa "Copertina 3" dal foglio Prodotti (campo icon3 nel backend).
                     Fallback: icon2 ‚Üí icon ‚Üí placeholder -->
                <img src="${product.icon3 || product.icon2 || product.icon || 'https://via.placeholder.com/300x400?text=No+Image'}" 
                     alt="${product.title}" 
                     style="width:100%;height:100%;object-fit:cover;" />
            </div>
            <div class="recommended-name">${product.title}</div>
            <div class="recommended-desc">${shortDesc}</div>
            ${priceHtml}
        </a>
    `;
}).join('');

        // Nascondi loader dopo aver popolato i prodotti
if (loader) {
    loader.style.display = 'none';
}
        
    } catch (error) {
        console.error('Errore caricamento prodotti consigliati:', error);
        // Nascondi loader anche in caso di errore
const loader = document.getElementById('recommendedLoader');
if (loader) {
    loader.style.display = 'none';
}
    }
}

    /* --- CHECKOUT (invariato) --- */
    async function initiateCheckout(e) {
    if (e) e.preventDefault();
    const btn = document.getElementById('checkoutBtn');
    if (!btn || btn.disabled) return;
    
    const freshCart = JSON.parse(localStorage.getItem('lh360_cart')) || [];
    const validItems = freshCart.filter(item => item && item.title && item.price);
    if (validItems.length === 0) { alert('Il carrello √® vuoto!'); return; }

    const i18n = window.i18nPDP();
    const originalText = btn.innerText;
    btn.innerText = i18n ? i18n.t('cart_checkout_processing') : 'Connessione sicura...';
    btn.style.opacity = '0.7';
    btn.disabled = true;

    // 1. Calcola subtotale (con prezzi finali dei prodotti, gi√† scontati se hanno discountPrice)
    let subtotal = 0;
    validItems.forEach(item => {
        const finalPrice = (item.discountPrice && item.discountPrice < item.price) ? item.discountPrice : item.price;
        subtotal += finalPrice * (item.qty || 1);
    });

    // 2. Calcola sconti aggiuntivi (combo + coupon)
    let comboDiscount = 0;
    try {
        const skuList = validItems.map(item => item.sku).join(',');
        const response = await fetch(`${webAppUrl}?action=check_combo&skus=${encodeURIComponent(skuList)}&t=${Date.now()}`);
        const result = await response.json();
        if (result.success && result.comboDiscount > 0) comboDiscount = result.comboDiscount;
    } catch (error) { console.error('Errore verifica combo:', error); }

    let couponDiscount = 0;
    if (appliedCoupon) {
        couponDiscount = (subtotal * appliedCoupon.discountPercent) / 100;
    }

    const totalDiscount = comboDiscount + couponDiscount;

    // 3. Calcola totale finale e spedizione
    const totalAfterDiscounts = subtotal - totalDiscount;
    const shipping = totalAfterDiscounts >= 150 ? 0 : 15;

    // ‚≠ê NUOVO: Salva dati sconti per success.html
localStorage.setItem('lh360_applied_discounts', JSON.stringify({
    comboDiscount: comboDiscount,
    couponDiscount: couponDiscount,
    couponCode: appliedCoupon ? appliedCoupon.code : null,
    isComboActive: comboDiscount > 0,
    totalDiscount: totalDiscount,
    timestamp: Date.now()
}));

    // 4. Costruisci payload per Stripe (con sconto applicato proporzionalmente ai prodotti)
    // ‚úÖ RECUPERA LINGUA CORRENTE
    const currentLang = i18n ? i18n.currentLang : 'it';

    const data = {
       cart: validItems.map(item => {
       const finalPrice = (item.discountPrice && item.discountPrice < item.price) ? item.discountPrice : item.price;
       
       // Applica sconto proporzionale al prezzo del singolo item
       let adjustedPrice = finalPrice;
       if (totalDiscount > 0 && subtotal > 0) {
           const itemSubtotal = finalPrice * (item.qty || 1);
           const discountRatio = itemSubtotal / subtotal;
           const itemDiscount = totalDiscount * discountRatio;
           adjustedPrice = finalPrice - (itemDiscount / (item.qty || 1));
           adjustedPrice = Math.max(0.50, adjustedPrice);
       }
       
       // ‚≠ê COSTRUZIONE DESCRIZIONE STRUTTURATA
       let structuredDesc = item.title;
       const variantParts = [];
       if (item.color) variantParts.push(item.color);
       if (item.size) variantParts.push(item.size);
       if (variantParts.length > 0) {
           structuredDesc += ' | ' + variantParts.join(' - ');
       }
       
       return {
           sku: item.sku || '',
           title: item.title,
           description: structuredDesc,  // ‚≠ê AGGIUNTO
           price: adjustedPrice,
           qty: item.qty || 1,
           color: item.color || '',
           size: item.size || '',
           currency: item.currency || 'EUR',
           image: item.image || ''
         };
    }),
    shipping: shipping,
    is_buy_now: false,
    cancel_url: window.location.href,
    lang: currentLang,  // ‚úÖ AGGIUNGI PARAMETRO LINGUA
    checkout_metadata: {
        used_coupon: appliedCoupon ? appliedCoupon.code : ''
    }
};

    console.log('üì¶ Payload inviato:', JSON.stringify(data)); // DEBUG

    try {
        const dataStr = encodeURIComponent(JSON.stringify(data));
        const callbackName = 'handleCheckoutResponse';
        const targetUrl = `${webAppUrl}?action=create_checkout_session&data=${dataStr}&callback=${callbackName}&t=${Date.now()}`;
        
        const response = await fetch(targetUrl, { method: 'GET', mode: 'cors', headers: { 'Content-Type': 'text/plain' }});
        if (!response.ok) throw new Error('Errore di rete Google');
        const textResponse = await response.text();
        const jsonString = textResponse.substring(textResponse.indexOf('(') + 1, textResponse.lastIndexOf(')'));
        const result = JSON.parse(jsonString);
        if (result.error) throw new Error(result.error);
else if (result.url) { 
    // ‚úÖ AGGIUNGI QUESTE RIGHE PRIMA DEL REDIRECT
    if (appliedCoupon) {
        markCouponAsUsed(appliedCoupon.code);
    }
    
    localStorage.removeItem('lh360_applied_coupon');
    btn.innerText = i18n ? i18n.t('cart_checkout_redirecting') : 'Reindirizzamento...'; 
    window.location.assign(result.url); 
}
        else throw new Error('Risposta non valida dal server');
    } catch (err) {
        console.error(err);
        if (window.LuxError) LuxError.show('generic');
        else alert("Impossibile avviare il pagamento: " + err.message);
        btn.innerText = originalText;
        btn.style.opacity = '1';
        btn.disabled = false;
    }
}

    const checkoutBtn = document.getElementById('checkoutBtn');
    if (checkoutBtn) checkoutBtn.onclick = initiateCheckout;

   // ‚úÖ Converti automaticamente input coupon in maiuscolo
document.getElementById('couponInput').addEventListener('input', function(e) {
  const cursorPosition = e.target.selectionStart; // Salva posizione cursore
  e.target.value = e.target.value.toUpperCase();
  e.target.setSelectionRange(cursorPosition, cursorPosition); // Ripristina cursore
});

// Evento applicazione coupon
document.getElementById('applyCouponBtn').addEventListener('click', async function() {
  const couponCode = document.getElementById('couponInput').value.trim().toUpperCase();
  const btn = this;
  const i18n = window.i18nPDP();

  if (!couponCode) { 
    showCouponMessage('cart_coupon_enter_valid', 'warning'); 
    return; 
  }

  if (appliedCoupon && appliedCoupon.code === couponCode) {
    showCouponMessage('cart_coupon_already_applied', 'success', { code: couponCode });
    
    setTimeout(() => {
      showCouponMessage('cart_coupon_restored', 'success', { 
        code: couponCode, 
        percent: appliedCoupon.discountPercent 
      });
    }, 3000);
    return;
  }
  
  if (appliedCoupon) {
    appliedCoupon = null;
    localStorage.removeItem('lh360_applied_coupon');
    updateSummaryImmediate();
    await updateSummaryWithCoupon();
  }

  btn.disabled = true;
  btn.textContent = i18n.t('cart_coupon_verifying');
  showCouponMessage('cart_coupon_verifying_progress', 'warning');

  try {
    const response = await fetch(`${webAppUrl}?action=validate_coupon&code=${encodeURIComponent(couponCode)}&t=${Date.now()}`);
    const result = await response.json();
    
    if (result.success && result.valid) {
      btn.textContent = i18n.t('cart_coupon_apply_btn');
      
      appliedCoupon = { 
        code: couponCode, 
        discountPercent: result.discountPercent,
        appliedAt: Date.now()
      };
      
      localStorage.setItem('lh360_applied_coupon', JSON.stringify(appliedCoupon));
      
      showDiscountCalculating();
      await updateSummaryWithCoupon();
      await new Promise(resolve => setTimeout(resolve, 400));
      
      showCouponMessage('cart_coupon_success', 'success', {
        code: couponCode,
        percent: result.discountPercent
      });
      
    } else {
      let errorKey = 'cart_coupon_invalid';
      
      if (result.error) {
        if (result.error.includes('scaduto')) {
          errorKey = 'cart_coupon_expired';
        } else if (result.error.includes('utilizzato')) {
          errorKey = 'cart_coupon_used';
        } else if (result.error.includes('non riconosciuto')) {
          errorKey = 'cart_coupon_not_found';
        }
      }
      
      showCouponMessage(errorKey, 'error', { code: couponCode });
      appliedCoupon = null;
      localStorage.removeItem('lh360_applied_coupon');
    }
  } catch (error) {
    console.error('Errore validazione coupon:', error);
    showCouponMessage('cart_coupon_connection_error', 'error');
    appliedCoupon = null;
    localStorage.removeItem('lh360_applied_coupon');
  } finally {
    btn.disabled = false;
    btn.textContent = i18n.t('cart_coupon_apply_btn');
  }
});

    /**
 * ‚úÖ Mostra messaggi coupon con design premium
 * @param {string} message - Testo del messaggio
 * @param {string} type - 'success' | 'error' | 'warning'
 */
function showCouponMessage(messageKey, type, replacements = {}) {
    const messageEl = document.getElementById('couponMessage');
    const i18n = window.i18nPDP();
    
    if (messageEl._hideTimeout) {
        clearTimeout(messageEl._hideTimeout);
    }
    
    const message = i18n ? i18n.t(messageKey, replacements) : messageKey;
    
    messageEl.textContent = message;
    messageEl.className = `promo-message ${type}`;
    messageEl.style.display = 'block';
    
    const hideDelay = type === 'success' ? 6000 : 8000;
    
    messageEl._hideTimeout = setTimeout(() => {
        messageEl.style.opacity = '0';
        messageEl.style.transform = 'translateY(-0.5rem)';
        messageEl.style.transition = 'opacity 0.3s, transform 0.3s';
        
        setTimeout(() => {
            messageEl.style.display = 'none';
            messageEl.style.opacity = '1';
            messageEl.style.transform = 'translateY(0)';
        }, 300);
    }, hideDelay);
}

    async function updateSummaryWithCoupon() {    
    let subtotal = 0;
    let itemCount = 0;
    
    cart.forEach(item => {
        const finalPrice = (item.discountPrice && item.discountPrice < item.price) 
            ? item.discountPrice 
            : item.price;
        subtotal += finalPrice * (item.qty || 1);
        itemCount += (item.qty || 1);
    });

    let discount = 0;
    let isComboDiscount = false;
    
    // Verifica sconti combo dal backend
    try {
        const skuList = cart.map(item => item.sku).join(',');
        const response = await fetch(`${webAppUrl}?action=check_combo&skus=${encodeURIComponent(skuList)}&t=${Date.now()}`);
        const result = await response.json();
        
        if (result.success && result.comboDiscount > 0) {
            discount = result.comboDiscount;
            isComboDiscount = true;
        }
    } catch (error) { 
        console.error('Errore verifica combo:', error); 
    }

    // Aggiungi sconto coupon se presente
let couponDiscount = 0; // ‚úÖ AGGIUNGI QUESTA RIGA
if (appliedCoupon) {
    couponDiscount = (subtotal * appliedCoupon.discountPercent) / 100;
    discount += couponDiscount;
}

    // ‚úÖ CALCOLA TOTALI FINALI PRIMA DI USARLI
    const shippingThreshold = getShippingThreshold();
const totalAfterDiscounts = subtotal - discount;
const shipping = totalAfterDiscounts >= shippingThreshold ? 0 : 15;
const total = subtotal + shipping - discount;

    // ‚úÖ ORA AGGIORNA UI (shipping e total sono definiti)
    const i18n = window.i18nPDP();

    if (i18n) {
        const itemCountText = itemCount === 1 
            ? i18n.t('cart_items_count_one') 
            : i18n.t('cart_items_count_many', { n: itemCount });
        document.getElementById('itemCount').textContent = itemCountText;
    }

    if (i18n) {
        document.getElementById('subtotal').textContent = i18n.formatPrice(subtotal);
        document.getElementById('shipping').textContent = shipping === 0 
            ? i18n.t('cart_summary_shipping_free') 
            : i18n.formatPrice(shipping);
        document.getElementById('total').textContent = i18n.formatPrice(total);
    }
    
    // Aggiorna barra progresso
    const progress = Math.min(100, (totalAfterDiscounts / 150) * 100);
    const progressBar = document.getElementById('progressFill');
    
    if (totalAfterDiscounts >= 150) {
        progressBar.style.width = '100%';
        progressBar.style.background = 'linear-gradient(90deg, #34d399, #10b981)';
    } else {
        progressBar.style.width = `${progress}%`;
        progressBar.style.background = 'linear-gradient(90deg, #34d399, #10b981)';
    }
    
    // Mostra valore sconto finale
    showDiscountValue(discount, isComboDiscount);

    // ‚úÖ SALVA SCONTI PER RIPRISTINO AL CAMBIO LINGUA
localStorage.setItem('lh360_applied_discounts', JSON.stringify({
    comboDiscount: isComboDiscount ? (discount - couponDiscount) : 0,
    couponDiscount: couponDiscount,
    couponCode: appliedCoupon ? appliedCoupon.code : null,
    isComboActive: isComboDiscount,
    totalDiscount: discount,
    timestamp: Date.now()
}));
}

    // ‚≠ê Nascondi loader dopo 7,8 secondi
window.addEventListener('DOMContentLoaded', () => {
    setTimeout(() => {
        const loader = document.getElementById('cartLoader');
        if (loader) {
            loader.style.opacity = '0';
            setTimeout(() => loader.remove(), 600);
        }
    }, 7800); // ‚≠ê Durata totale: 7,8 secondi (4200ms + 3600ms)
});

    // FIX: Ripristina stato bottone checkout quando si torna indietro
window.addEventListener('pageshow', function(event) {
    if (event.persisted) {
        const checkoutBtn = document.getElementById('checkoutBtn');
        if (checkoutBtn) {
            checkoutBtn.disabled = false;
            checkoutBtn.textContent = 'Procedi al Checkout';
            checkoutBtn.style.opacity = '1';
        }
    }
});

   /**
 * Aggiorna tutti i prezzi con la nuova lingua/valuta
 */
  function updateAllPricesForLanguage() {
    const i18n = window.i18nPDP();
    if (!i18n) return;
    
    // 1. CALCOLO CONTEGGIO ARTICOLI (SEMPRE)
    const itemCount = cart.reduce((sum, item) => sum + (item.qty || 1), 0);
    
    // 2. AGGIORNAMENTO IMMEDIATO CONTEGGIO ARTICOLI
const itemCountEl = document.getElementById('itemCount');
if (itemCountEl) {
    let itemCountText;
    if (itemCount === 0) {
        itemCountText = i18n.t('cart_items_count_zero');
    } else if (itemCount === 1) {
        itemCountText = i18n.t('cart_items_count_one');
    } else {
        itemCountText = i18n.t('cart_items_count_many', { n: itemCount });
    }
    itemCountEl.textContent = itemCountText;
}
    
    // 3. CALCOLO PREZZI (per summary sidebar)
    let subtotal = 0;
    cart.forEach(item => {
        const finalPrice = (item.discountPrice && item.discountPrice < item.price) 
            ? item.discountPrice 
            : item.price;
        subtotal += finalPrice * (item.qty || 1);
    });
    
    const savedDiscounts = JSON.parse(localStorage.getItem('lh360_applied_discounts') || '{}');
    const discount = savedDiscounts.totalDiscount || 0;
    
    const shippingThreshold = getShippingThreshold();
    const totalAfterDiscounts = subtotal - discount;
    const shipping = totalAfterDiscounts >= shippingThreshold ? 0 : 15;
    const total = subtotal + shipping - discount;
    
    // 4. AGGIORNA UI SUMMARY
    document.getElementById('subtotal').textContent = i18n.formatPrice(subtotal);
    document.getElementById('shipping').textContent = shipping === 0 
        ? i18n.t('cart_summary_shipping_free') 
        : i18n.formatPrice(shipping);
    document.getElementById('total').textContent = i18n.formatPrice(total);
    
    if (discount > 0) {
        document.getElementById('discount').textContent = `- ${i18n.formatPrice(discount)}`;
    }
    
    // 5. AGGIORNA SOGLIA SPEDIZIONE
    const shippingThresholdEl = document.getElementById('shippingThreshold');
    if (shippingThresholdEl) {
        shippingThresholdEl.textContent = i18n.formatPrice(getShippingThreshold());
    }
    
    // 6. ‚úÖ RI-RENDERIZZA LE CARD PRODOTTO
    renderCart(true); // ‚Üê passa true per evitare loop
    
    // 7. AGGIORNA PREZZI PRODOTTI CONSIGLIATI
    document.querySelectorAll('.recommended-item').forEach(card => {
        const originalPrice = parseFloat(card.dataset.originalPrice);
        const discountPrice = parseFloat(card.dataset.discountPrice);
        const originalCurrency = card.dataset.originalCurrency || 'EUR';
        
        if (!originalPrice) return;
        
        const hasDiscount = discountPrice && discountPrice < originalPrice;
        
        if (hasDiscount) {
            const originalPriceEl = card.querySelector('div[style*="text-decoration: line-through"]');
            if (originalPriceEl) {
                originalPriceEl.textContent = i18n.formatPrice(originalPrice, originalCurrency);
            }
            
            const discountedPriceEl = card.querySelector('span[style*="background-clip: text"]');
            if (discountedPriceEl) {
                discountedPriceEl.textContent = i18n.formatPrice(discountPrice, originalCurrency);
            }
        } else {
            const priceElements = card.querySelectorAll('.recommended-price');
            priceElements.forEach(el => {
                el.textContent = i18n.formatPrice(originalPrice, originalCurrency);
            });
        }
    });

    // 8. ‚úÖ AGGIORNA DESCRIZIONI BREVI PRODOTTI CONSIGLIATI
    if (window.translationsBriefDescriptions) {
        document.querySelectorAll('.recommended-item[data-sku]').forEach(card => {
            const sku = card.dataset.sku;
            const descEl = card.querySelector('.recommended-desc');
            if (!descEl || !sku) return;

            const entry = window.translationsBriefDescriptions[sku];
            if (!entry) return;

            const rawDesc = entry[i18n.currentLang] || entry['it'] || '';
            descEl.textContent = rawDesc.length > 60
                ? rawDesc.substring(0, 60) + '...'
                : rawDesc;
        });
    }
}
    
    // Ascolta cambio lingua da altre pagine
window.addEventListener('storage', (event) => {
    if (event.key === 'lh360_lang' && event.newValue) {
        const i18n = window.i18nPDP();
        if (i18n && i18n.currentLang !== event.newValue) {
            i18n.changeLanguage(event.newValue);
        }
    }
});
    
</script>

<script>
    /* ‚îÄ‚îÄ Refund Policy Toggle ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
    function toggleRefundPolicy() {
        const box = document.getElementById('refundPolicy');
        if (box) box.classList.toggle('open');
    }
</script>
<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     LH360 EARLY ACCESS SYSTEM ‚Äî v3.0
     ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
     ‚Ä¢ Pagamenti disabilitati globalmente (EARLY_ACCESS_MODE)
     ‚Ä¢ Admin mode via sequenza tastiera ‚Üí pannello con toggle
     ‚Ä¢ Toggle pagamenti in tempo reale, senza reload
     ‚Ä¢ Banner informativo multilingua su tutte le pagine
     ‚Ä¢ Prenotazione: solo su PDP e Cart (NON su Booking)
     ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->

<!-- ‚ïê‚ïê‚ïê STYLES ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<style>
/* ‚îÄ‚îÄ‚îÄ CSS Variables ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
:root {
  --lh-gold:        #c9a84c;
  --lh-gold-light:  #e8c97a;
  --lh-gold-dim:    rgba(201,168,76,0.12);
  --lh-gold-border: rgba(201,168,76,0.22);
  --lh-surface:     #111113;
  --lh-surface2:    rgba(255,255,255,0.04);
}

/* ‚îÄ‚îÄ‚îÄ Early Access Banner ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
#lhEaBanner {
  position: fixed;
  bottom: 0; left: 0; right: 0;
  z-index: 9000;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 1rem;
  padding: 0.7rem 1.5rem;
  background: rgba(10,10,11,0.96);
  border-top: 1px solid var(--lh-gold-border);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  transform: translateY(0);
  transition: transform 0.4s cubic-bezier(0.16,1,0.3,1);
  box-shadow: 0 -8px 32px rgba(0,0,0,0.4);
}
#lhEaBanner.lh-hidden { transform: translateY(100%); }
.lh-banner-dot {
  width: 7px; height: 7px; border-radius: 50%;
  background: var(--lh-gold); flex-shrink: 0;
  animation: lh-blink 2.5s infinite;
}
@keyframes lh-blink { 0%,100%{opacity:1;} 50%{opacity:0.3;} }
.lh-banner-text {
  font-size: 0.78rem; font-weight: 500;
  color: #a1a1aa; letter-spacing: 0.01em; line-height: 1.4;
}
.lh-banner-text strong { color: var(--lh-gold); font-weight: 700; }
.lh-banner-dismiss {
  background: none; border: none;
  color: #52525b; font-size: 1rem; line-height: 1;
  cursor: pointer; padding: 0.2rem 0.4rem;
  border-radius: 0.3rem; transition: color 0.2s;
  flex-shrink: 0; margin-left: 0.5rem;
}
.lh-banner-dismiss:hover { color: #a1a1aa; }

/* ‚îÄ‚îÄ‚îÄ Reserve Button (PDP + Cart) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
.btn-reserve {
  display: flex; align-items: center; justify-content: center;
  gap: 0.55rem; width: 100%;
  padding: 1.05rem 1.75rem;
  background: linear-gradient(135deg, #c9a84c 0%, #e8c97a 48%, #b8902e 100%);
  color: #0a0a0b; font-weight: 700; font-size: 0.97rem;
  letter-spacing: 0.05em; text-transform: uppercase;
  border: none; border-radius: 0.75rem; cursor: pointer;
  position: relative; overflow: hidden;
  transition: transform 0.3s cubic-bezier(0.16,1,0.3,1),
              box-shadow 0.3s cubic-bezier(0.16,1,0.3,1);
  box-shadow: 0 4px 24px rgba(201,168,76,0.28), 0 1px 3px rgba(0,0,0,0.4);
}

/* ‚îÄ‚îÄ‚îÄ Stato B: Prenotato su questo prodotto ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
.btn-reserve.btn-reserve-booked {
  background: linear-gradient(135deg, rgba(34,197,94,0.12), rgba(34,197,94,0.08));
  border: 1px solid rgba(34,197,94,0.3);
  color: #4ade80;
  cursor: not-allowed;
  box-shadow: none;
  transform: none !important;
}
.btn-reserve.btn-reserve-booked:hover {
  transform: none !important;
  box-shadow: none !important;
}

/* ‚îÄ‚îÄ‚îÄ Stato C: Gi√† prenotato su altro prodotto ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
.btn-reserve.btn-reserve-already-founder {
  background: linear-gradient(135deg, rgba(212,175,55,0.12), rgba(212,175,55,0.07));
  border: 1px dashed rgba(212,175,55,0.45);
  color: var(--lh-gold, #c9a84c);
  box-shadow: none;
}
.btn-reserve.btn-reserve-already-founder:hover {
  background: linear-gradient(135deg, rgba(212,175,55,0.18), rgba(212,175,55,0.1));
  box-shadow: 0 4px 16px rgba(201,168,76,0.2);
  transform: translateY(-1px);
}

/* ‚îÄ‚îÄ‚îÄ Change Product Modal ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
#lhChangeProductModal {
  position:fixed; inset:0; z-index:99991;
  display:none; align-items:center; justify-content:center; padding:1rem;
  opacity:0; transition:opacity 0.3s cubic-bezier(0.16,1,0.3,1);
}
#lhChangeProductModal.lh-open  { display:flex; }
#lhChangeProductModal.lh-vis   { opacity:1; }
#lhChangeProductModal .lh-rm-backdrop {
  position:absolute; inset:0;
  background:rgba(0,0,0,0.85); backdrop-filter:blur(14px); -webkit-backdrop-filter:blur(14px);
}
#lhChangeProductModal .lh-rm-card { max-width:480px; }
#lhChangeProductModal.lh-vis .lh-rm-card { transform:translateY(0) scale(1); }
.lh-cp-products {
  display:grid; grid-template-columns:1fr 1fr; gap:0.75rem; margin:1.2rem 0 1.5rem;
}
.lh-cp-product-box {
  padding:0.85rem 0.95rem; border-radius:0.75rem;
  background:rgba(255,255,255,0.03); border:1px solid rgba(255,255,255,0.07);
  display:flex; flex-direction:column; gap:0.3rem;
}
.lh-cp-product-box.current { border-color:rgba(212,175,55,0.35); background:rgba(212,175,55,0.05); }
.lh-cp-product-box.new     { border-color:rgba(125,211,252,0.3); background:rgba(125,211,252,0.04); }
.lh-cp-product-lbl { font-size:0.65rem; font-weight:700; letter-spacing:0.07em; text-transform:uppercase; }
.lh-cp-product-box.current .lh-cp-product-lbl { color:rgba(212,175,55,0.8); }
.lh-cp-product-box.new     .lh-cp-product-lbl { color:rgba(125,211,252,0.8); }
.lh-cp-product-name { font-size:0.84rem; font-weight:500; color:#e4e4e7; line-height:1.35; }
.lh-cp-arrow { display:flex; align-items:center; justify-content:center; color:#52525b; font-size:1.2rem; align-self:center; }
.lh-cp-info { font-size:0.78rem; color:#71717a; line-height:1.55; padding:0.65rem 0.85rem; background:rgba(255,255,255,0.025); border-radius:0.6rem; border:1px solid rgba(255,255,255,0.05); margin-bottom:1.2rem; text-align:center; }
.lh-cp-btns { display:flex; flex-direction:column; gap:0.65rem; }
.lh-cp-btn-keep { padding:0.85rem; border:1px solid rgba(255,255,255,0.1); background:rgba(255,255,255,0.04); color:#a1a1aa; font-size:0.88rem; font-weight:600; letter-spacing:0.03em; border-radius:0.72rem; cursor:pointer; transition:all 0.22s; }
.lh-cp-btn-keep:hover { background:rgba(255,255,255,0.08); color:#e4e4e7; }
.lh-cp-btn-switch { padding:0.9rem; background:linear-gradient(135deg,#c9a84c 0%,#e8c97a 50%,#b8902e 100%); color:#0a0a0b; font-weight:700; font-size:0.9rem; letter-spacing:0.05em; text-transform:uppercase; border:none; border-radius:0.72rem; cursor:pointer; transition:all 0.28s; box-shadow:0 4px 18px rgba(201,168,76,0.28); }
.lh-cp-btn-switch:hover { box-shadow:0 6px 26px rgba(201,168,76,0.42); transform:translateY(-1px); }
.lh-cp-btn-switch:disabled { opacity:0.55; cursor:not-allowed; transform:none; }
.lh-cp-feedback { font-size:0.8rem; text-align:center; margin-top:0.5rem; min-height:1.2em; }
.lh-cp-feedback.success { color:#4ade80; }
.lh-cp-feedback.error   { color:#f87171; }
@media(max-width:600px) { .lh-cp-products { grid-template-columns:1fr; } .lh-cp-arrow { transform:rotate(90deg); } }
.btn-reserve::before {
  content:''; position:absolute; inset:0;
  background: linear-gradient(135deg,rgba(255,255,255,0.18) 0%,transparent 55%);
  opacity:0; transition:opacity 0.28s;
}
.btn-reserve:hover { transform:translateY(-2px); box-shadow:0 8px 32px rgba(201,168,76,0.42),0 2px 8px rgba(0,0,0,0.45); }
.btn-reserve:hover::before { opacity:1; }
.btn-reserve:active { transform:translateY(0); }

/* Early Access badge */
.lh-ea-badge {
  display:flex; align-items:center; justify-content:center;
  gap:0.45rem; padding:0.42rem 0.95rem;
  background:var(--lh-gold-dim); border:1px solid var(--lh-gold-border);
  border-radius:2rem; font-size:0.7rem; font-weight:700;
  letter-spacing:0.07em; text-transform:uppercase; color:var(--lh-gold);
  margin-bottom:0.7rem;
}
.lh-ea-badge .lh-pulse {
  width:6px; height:6px; border-radius:50%;
  background:var(--lh-gold); flex-shrink:0;
  animation:lh-blink 2s infinite;
}

/* ‚îÄ‚îÄ‚îÄ Booking Disabled State ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
.lh-booking-disabled-wrap {
  display:flex; flex-direction:column; gap:0.65rem;
}
.lh-booking-disabled-btn {
  width:100%; padding:1rem; border-radius:0.75rem;
  background: rgba(255,255,255,0.04);
  border: 1px solid rgba(255,255,255,0.08);
  color: #52525b; font-size:0.92rem; font-weight:600;
  letter-spacing:0.03em; cursor:not-allowed;
  display:flex; align-items:center; justify-content:center; gap:0.6rem;
}
.lh-booking-notice {
  padding:0.75rem 1rem;
  background:var(--lh-gold-dim); border:1px solid var(--lh-gold-border);
  border-radius:0.65rem;
  font-size:0.78rem; color:#a1a1aa; line-height:1.5; text-align:center;
}
.lh-booking-notice strong { color:var(--lh-gold); }

/* ‚îÄ‚îÄ‚îÄ Reservation Modal ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
#lhReserveModal {
  position:fixed; inset:0; z-index:99990;
  display:none; align-items:center; justify-content:center; padding:1rem;
  opacity:0; transition:opacity 0.3s cubic-bezier(0.16,1,0.3,1);
}
#lhReserveModal.lh-open  { display:flex; }
#lhReserveModal.lh-vis   { opacity:1; }
.lh-rm-backdrop {
  position:absolute; inset:0;
  background:rgba(0,0,0,0.82); backdrop-filter:blur(14px); -webkit-backdrop-filter:blur(14px);
}
.lh-rm-card {
  position:relative; z-index:1; width:100%; max-width:510px;
  background:#111113; border:1px solid var(--lh-gold-border);
  border-radius:1.5rem; overflow:hidden;
  box-shadow:0 24px 80px rgba(0,0,0,0.75);
  transform:translateY(22px) scale(0.97);
  transition:transform 0.38s cubic-bezier(0.16,1,0.3,1);
}
#lhReserveModal.lh-vis .lh-rm-card { transform:translateY(0) scale(1); }
.lh-rm-bar { height:3px; background:linear-gradient(90deg,transparent,#c9a84c,#e8c97a,#c9a84c,transparent); }
.lh-rm-body { padding:1.9rem 2rem 2.1rem; }
.lh-rm-close {
  position:absolute; top:1.2rem; right:1.2rem;
  width:1.9rem; height:1.9rem; background:rgba(255,255,255,0.07);
  border:none; border-radius:50%; color:#71717a; font-size:0.9rem;
  cursor:pointer; display:flex; align-items:center; justify-content:center;
  transition:all 0.2s; z-index:2;
}
.lh-rm-close:hover { background:rgba(255,255,255,0.13); color:#fff; }
.lh-rm-pill {
  display:inline-flex; align-items:center; gap:0.38rem;
  padding:0.32rem 0.8rem; background:var(--lh-gold-dim);
  border:1px solid var(--lh-gold-border); border-radius:2rem;
  font-size:0.68rem; font-weight:700; letter-spacing:0.08em;
  text-transform:uppercase; color:var(--lh-gold); margin-bottom:1.1rem;
}
.lh-rm-title {
  font-size:1.6rem; font-weight:300; color:#fafafa;
  letter-spacing:-0.02em; line-height:1.2; margin-bottom:0.45rem;
}
.lh-rm-sub { font-size:0.86rem; color:#71717a; line-height:1.5; margin-bottom:1.4rem; }
.lh-rm-phases {
  display:grid; grid-template-columns:1fr 1fr; gap:0.7rem; margin-bottom:1.6rem;
}
.lh-rm-phase {
  padding:0.8rem 0.9rem; border-radius:0.7rem;
  border:1px solid rgba(255,255,255,0.06); background:rgba(255,255,255,0.025);
}
.lh-rm-phase.on { border-color:var(--lh-gold-border); background:var(--lh-gold-dim); }
.lh-rm-plabel { font-size:0.67rem; font-weight:700; letter-spacing:0.06em; text-transform:uppercase; color:var(--lh-gold); margin-bottom:0.28rem; }
.lh-rm-pdesc  { font-size:0.74rem; color:#a1a1aa; line-height:1.4; }
.lh-rm-product {
  display:flex; align-items:center; gap:0.7rem;
  padding:0.8rem 0.95rem; background:rgba(255,255,255,0.035);
  border:1px solid rgba(255,255,255,0.065); border-radius:0.7rem; margin-bottom:1.4rem;
}
.lh-rm-product .ico { font-size:1.4rem; flex-shrink:0; }
.lh-rm-product .lbl { font-size:0.67rem; font-weight:600; text-transform:uppercase; letter-spacing:0.06em; color:#52525b; margin-bottom:0.12rem; }
.lh-rm-product .nm  { font-size:0.87rem; font-weight:500; color:#e4e4e7; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
.lh-rm-form { display:flex; flex-direction:column; gap:0.9rem; }
.lh-rm-field { display:flex; flex-direction:column; gap:0.38rem; }
.lh-rm-field label { font-size:0.77rem; font-weight:600; letter-spacing:0.03em; color:#a1a1aa; }
.lh-rm-field input {
  padding:0.78rem 0.95rem; background:rgba(255,255,255,0.045);
  border:1px solid rgba(255,255,255,0.09); border-radius:0.62rem;
  color:#fafafa; font-size:0.94rem; transition:all 0.22s; outline:none; width:100%;
}
.lh-rm-field input::placeholder { color:#52525b; }
.lh-rm-field input:focus { border-color:rgba(201,168,76,0.48); background:rgba(201,168,76,0.05); box-shadow:0 0 0 3px rgba(201,168,76,0.09); }
.lh-rm-field input.err { border-color:#ef4444; }
.lh-rm-errmsg { font-size:0.77rem; color:#ef4444; display:none; margin-top:-0.3rem; }
.lh-rm-errmsg.show { display:block; }
.lh-rm-submit {
  margin-top:0.4rem; padding:0.92rem;
  background:linear-gradient(135deg,#c9a84c 0%,#e8c97a 50%,#b8902e 100%);
  color:#0a0a0b; font-weight:700; font-size:0.9rem;
  letter-spacing:0.05em; text-transform:uppercase;
  border:none; border-radius:0.72rem; cursor:pointer;
  transition:all 0.28s; box-shadow:0 4px 18px rgba(201,168,76,0.28);
}
.lh-rm-submit:hover { box-shadow:0 6px 26px rgba(201,168,76,0.42); transform:translateY(-1px); }
.lh-rm-submit:disabled { opacity:0.55; cursor:not-allowed; transform:none; }
.lh-rm-privacy { font-size:0.7rem; color:#3f3f46; text-align:center; line-height:1.5; margin-top:0.7rem; }
.lh-rm-success, .lh-rm-wait { display:none; text-align:center; padding:1.2rem 0 0.4rem; }
.lh-rm-success.show, .lh-rm-wait.show { display:block; }
.lh-big-ico { font-size:3.2rem; display:block; margin-bottom:0.9rem; animation:lh-pop 0.5s cubic-bezier(0.34,1.56,0.64,1) both; }
@keyframes lh-pop { from{transform:scale(0.4);opacity:0;} to{transform:scale(1);opacity:1;} }
.lh-suc-title  { font-size:1.35rem; font-weight:600; color:var(--lh-gold); margin-bottom:0.7rem; }
.lh-suc-msg    { font-size:0.86rem; color:#a1a1aa; line-height:1.6; margin-bottom:1.5rem; }
.lh-founder-pill {
  display:inline-flex; align-items:center; gap:0.45rem;
  padding:0.46rem 1.15rem; background:var(--lh-gold-dim); border:1px solid var(--lh-gold-border);
  border-radius:2rem; font-size:0.77rem; font-weight:700; letter-spacing:0.06em;
  color:var(--lh-gold); margin-bottom:1.5rem;
}
.lh-close-btn {
  padding:0.75rem 2rem; background:rgba(255,255,255,0.07);
  border:1px solid rgba(255,255,255,0.1); border-radius:0.65rem;
  color:#e4e4e7; font-size:0.88rem; font-weight:500;
  cursor:pointer; transition:all 0.22s;
}
.lh-close-btn:hover { background:rgba(255,255,255,0.12); }

/* ‚îÄ‚îÄ‚îÄ Admin Keyboard Panel ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
#lhAdminPanel {
  position:fixed; inset:0; z-index:999990;
  display:none; align-items:center; justify-content:center; padding:1rem;
  background:rgba(0,0,0,0.9); backdrop-filter:blur(18px);
  opacity:0; transition:opacity 0.25s;
}
#lhAdminPanel.lh-open  { display:flex; }
#lhAdminPanel.lh-vis   { opacity:1; }
.lh-adm-card {
  background:#0c0c0e; border:1px solid rgba(239,68,68,0.28);
  border-radius:1.2rem; padding:2rem 2rem 2rem;
  width:100%; max-width:380px;
  box-shadow:0 0 0 1px rgba(239,68,68,0.08), 0 28px 70px rgba(0,0,0,0.85);
  transform:scale(0.95); transition:transform 0.28s cubic-bezier(0.16,1,0.3,1);
}
#lhAdminPanel.lh-vis .lh-adm-card { transform:scale(1); }
.lh-adm-header {
  display:flex; align-items:center; justify-content:space-between;
  margin-bottom:1.6rem;
}
.lh-adm-title { font-size:0.85rem; font-weight:700; color:#f87171; letter-spacing:0.1em; text-transform:uppercase; }
.lh-adm-x {
  background:none; border:none; color:#52525b; font-size:1rem;
  cursor:pointer; padding:0.2rem; border-radius:0.3rem; transition:color 0.2s;
}
.lh-adm-x:hover { color:#a1a1aa; }

/* Auth step */
.lh-adm-auth { display:flex; flex-direction:column; gap:0.9rem; }
.lh-adm-auth-sub { font-size:0.8rem; color:#52525b; text-align:center; margin-bottom:0.2rem; }
.lh-adm-pwd {
  width:100%; padding:0.82rem 1rem;
  background:rgba(255,255,255,0.04); border:1px solid rgba(239,68,68,0.2);
  border-radius:0.6rem; color:#fafafa; font-size:1rem;
  letter-spacing:0.12em; text-align:center;
  outline:none; transition:all 0.2s;
}
.lh-adm-pwd:focus { border-color:rgba(239,68,68,0.45); box-shadow:0 0 0 3px rgba(239,68,68,0.1); }
.lh-adm-pwd.shake { animation:lh-shake 0.4s ease both; border-color:#ef4444; }
@keyframes lh-shake {
  10%,90%  { transform:translateX(-2px); }
  20%,80%  { transform:translateX(4px); }
  30%,50%,70% { transform:translateX(-5px); }
  40%,60%  { transform:translateX(5px); }
}
.lh-adm-auth-btns { display:grid; grid-template-columns:1fr 1fr; gap:0.6rem; }
.lh-adm-btn {
  padding:0.72rem; border:none; border-radius:0.6rem;
  font-size:0.82rem; font-weight:700; letter-spacing:0.04em;
  text-transform:uppercase; cursor:pointer; transition:all 0.2s;
}
.lh-adm-btn.ok  { background:rgba(239,68,68,0.14); border:1px solid rgba(239,68,68,0.28); color:#f87171; }
.lh-adm-btn.ok:hover  { background:rgba(239,68,68,0.24); }
.lh-adm-btn.no  { background:rgba(255,255,255,0.05); border:1px solid rgba(255,255,255,0.08); color:#71717a; }
.lh-adm-btn.no:hover  { background:rgba(255,255,255,0.09); }

/* Dashboard step */
.lh-adm-dash { display:none; flex-direction:column; gap:1.25rem; }
.lh-adm-dash.show { display:flex; }
.lh-adm-status-row {
  display:flex; align-items:center; justify-content:space-between;
  padding:0.9rem 1rem; border-radius:0.75rem;
  background:rgba(255,255,255,0.04); border:1px solid rgba(255,255,255,0.07);
}
.lh-adm-status-label { font-size:0.78rem; font-weight:600; color:#a1a1aa; letter-spacing:0.03em; }
.lh-adm-status-val {
  font-size:0.78rem; font-weight:700; letter-spacing:0.05em;
  text-transform:uppercase; padding:0.25rem 0.75rem;
  border-radius:2rem;
}
.lh-adm-status-val.off { background:rgba(239,68,68,0.12); color:#f87171; border:1px solid rgba(239,68,68,0.25); }
.lh-adm-status-val.on  { background:rgba(34,197,94,0.12); color:#4ade80; border:1px solid rgba(34,197,94,0.25); }

/* Payment toggle */
.lh-pay-toggle {
  display:flex; flex-direction:column; gap:0.6rem;
  padding:1rem; border-radius:0.75rem;
  border:1px solid rgba(255,255,255,0.07);
  background:rgba(255,255,255,0.03);
}
.lh-pay-toggle-label { font-size:0.75rem; color:#71717a; letter-spacing:0.03em; }
.lh-pay-toggle-btn {
  width:100%; padding:0.85rem; border:none; border-radius:0.65rem;
  font-size:0.88rem; font-weight:700; letter-spacing:0.05em;
  text-transform:uppercase; cursor:pointer; transition:all 0.28s;
  display:flex; align-items:center; justify-content:center; gap:0.55rem;
}
.lh-pay-toggle-btn.enable {
  background:linear-gradient(135deg,rgba(34,197,94,0.18),rgba(34,197,94,0.1));
  border:1px solid rgba(34,197,94,0.3); color:#4ade80;
}
.lh-pay-toggle-btn.enable:hover { background:linear-gradient(135deg,rgba(34,197,94,0.28),rgba(34,197,94,0.18)); }
.lh-pay-toggle-btn.disable {
  background:rgba(239,68,68,0.1); border:1px solid rgba(239,68,68,0.25); color:#f87171;
}
.lh-pay-toggle-btn.disable:hover { background:rgba(239,68,68,0.2); }
.lh-adm-logout {
  padding:0.65rem; background:none; border:1px solid rgba(255,255,255,0.07);
  border-radius:0.65rem; color:#3f3f46; font-size:0.78rem;
  font-weight:600; text-align:center; cursor:pointer; transition:all 0.2s;
  letter-spacing:0.04em; text-transform:uppercase;
}
.lh-adm-logout:hover { color:#71717a; border-color:rgba(255,255,255,0.13); }

/* ‚îÄ‚îÄ‚îÄ Admin Banner ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
#lhAdminBanner {
  position:fixed; bottom:3.5rem; right:1.2rem; z-index:9001;
  display:none; align-items:center; gap:0.6rem;
  padding:0.52rem 0.95rem 0.52rem 0.75rem;
  background:rgba(10,10,11,0.95); border:1px solid rgba(239,68,68,0.3);
  border-radius:2rem; backdrop-filter:blur(8px);
  font-size:0.69rem; font-weight:700; letter-spacing:0.05em;
  text-transform:uppercase; color:#f87171; cursor:pointer;
  transition:border-color 0.2s;
  box-shadow:0 4px 20px rgba(0,0,0,0.5);
}
#lhAdminBanner:hover { border-color:rgba(239,68,68,0.55); }
#lhAdminBanner .lh-rdot {
  width:6px; height:6px; border-radius:50%; background:#ef4444;
  animation:lh-blink 1.5s infinite;
}

@media(max-width:600px) {
  .lh-rm-body  { padding:1.5rem 1.2rem 1.75rem; }
  .lh-rm-title { font-size:1.3rem; }
  .lh-rm-phases { grid-template-columns:1fr; }
  #lhEaBanner  { padding:0.6rem 1rem; gap:0.7rem; }
  .lh-banner-text { font-size:0.73rem; }
}
</style>

<!-- ‚ïê‚ïê‚ïê RESERVATION MODAL ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="lhReserveModal" role="dialog" aria-modal="true" aria-labelledby="lhRmTitle">
  <div class="lh-rm-backdrop" id="lhRmBackdrop"></div>
  <div class="lh-rm-card">
    <div class="lh-rm-bar"></div>
    <button class="lh-rm-close" id="lhRmClose" aria-label="Chiudi">‚úï</button>
    <div class="lh-rm-body">
      <!-- FORM -->
      <div id="lhRmForm">
        <div class="lh-rm-pill" id="lhRmPill">ü•á Founder Reservation Program</div>
        <h2 class="lh-rm-title" id="lhRmTitle">Founder Reservation Program</h2>
        <p class="lh-rm-sub" id="lhRmSub">Entra tra i primi 200 Founder. Nessun pagamento richiesto ora.</p>
        <div class="lh-rm-phases">
          <div class="lh-rm-phase on">
            <div class="lh-rm-plabel" id="lhP1Label">Fase 1 ‚Äî Founder Candidate</div>
            <div class="lh-rm-pdesc"  id="lhP1Desc">Prenota il prodotto, entra nei primi 200, accedi a vantaggi esclusivi.</div>
          </div>
          <div class="lh-rm-phase">
            <div class="lh-rm-plabel" id="lhP2Label">Fase 2 ‚Äî Founder Verified</div>
            <div class="lh-rm-pdesc"  id="lhP2Desc">Conferma il pagamento quando disponibile, mantieni lo status per sempre.</div>
          </div>
        </div>
        <div class="lh-rm-product">
          <div class="ico">üì¶</div>
          <div>
            <div class="lbl" id="lhRmProdLabel">Prodotto selezionato</div>
            <div class="nm"  id="lhRmProdName">‚Äî</div>
          </div>
        </div>
        <div class="lh-rm-form">
          <div class="lh-rm-field">
            <label for="lhRmName"  id="lhLbName">Nome e Cognome</label>
            <input  type="text"  id="lhRmName"  autocomplete="name"  placeholder="Il tuo nome completo">
          </div>
          <div class="lh-rm-field">
            <label for="lhRmEmail" id="lhLbEmail">Indirizzo Email</label>
            <input  type="email" id="lhRmEmail" autocomplete="email" placeholder="la@tua.email">
          </div>
          <div class="lh-rm-errmsg" id="lhRmErr"></div>
          <button class="lh-rm-submit" id="lhRmSubmit">Conferma Prenotazione</button>
          <p class="lh-rm-privacy" id="lhRmPrivacy">I tuoi dati saranno usati esclusivamente per contattarti alla riapertura dei pagamenti.</p>
        </div>
      </div>
      <!-- SUCCESS -->
      <div class="lh-rm-success" id="lhRmSuccess">
        <span class="lh-big-ico">ü•á</span>
        <div class="lh-suc-title" id="lhRmSucTitle">Sei un Founder Candidate!</div>
        <p class="lh-suc-msg" id="lhRmSucMsg">La tua prenotazione √® confermata.</p>
        <div class="lh-founder-pill" id="lhRmFounderBadge">‚ú¶ Founder Candidate</div>
        <button class="lh-close-btn" id="lhRmSucClose">Chiudi</button>
      </div>
      <!-- WAITLIST -->
      <div class="lh-rm-wait" id="lhRmWait">
        <span class="lh-big-ico">‚è≥</span>
        <div class="lh-suc-title" id="lhRmWaitTitle" style="color:#e4e4e7">Sei in Lista d'Attesa</div>
        <p class="lh-suc-msg" id="lhRmWaitMsg">I 200 posti Founder sono esauriti.</p>
        <div class="lh-founder-pill" style="border-color:rgba(161,161,170,0.3);background:rgba(161,161,170,0.07);color:#a1a1aa">‚è≥ Waiting List</div>
        <button class="lh-close-btn" id="lhRmWaitClose">Chiudi</button>
      </div>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê CHANGE PRODUCT MODAL ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="lhChangeProductModal" role="dialog" aria-modal="true">
  <div class="lh-rm-backdrop" id="lhCpBackdrop"></div>
  <div class="lh-rm-card">
    <div class="lh-rm-bar"></div>
    <button class="lh-rm-close" id="lhCpClose" aria-label="Chiudi">‚úï</button>
    <div class="lh-rm-body">
      <div class="lh-rm-pill" id="lhCpPill">ü•á Founder Reservation Program</div>
      <h2 class="lh-rm-title" id="lhCpTitle">Sei gi√† un Founder Candidate</h2>
      <p class="lh-rm-sub" id="lhCpSubtitle"></p>
      <div class="lh-cp-products">
        <div class="lh-cp-product-box current">
          <div class="lh-cp-product-lbl" id="lhCpCurrentLabel">Prenotazione attuale</div>
          <div class="lh-cp-product-name" id="lhCpCurrentName">‚Äî</div>
        </div>
        <div class="lh-cp-arrow">‚Üí</div>
        <div class="lh-cp-product-box new">
          <div class="lh-cp-product-lbl" id="lhCpNewLabel">Nuovo prodotto</div>
          <div class="lh-cp-product-name" id="lhCpNewName">‚Äî</div>
        </div>
      </div>
      <div class="lh-cp-info" id="lhCpInfo"></div>
      <div class="lh-cp-btns">
        <button class="lh-cp-btn-switch" id="lhCpSwitchBtn">Cambia con questo prodotto</button>
        <button class="lh-cp-btn-keep"   id="lhCpKeepBtn">Mantieni prenotazione attuale</button>
      </div>
      <div class="lh-cp-feedback" id="lhCpFeedback"></div>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê ADMIN PANEL ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="lhAdminPanel">
  <div class="lh-adm-card">
    <div class="lh-adm-header">
      <span class="lh-adm-title">üîê Admin Control</span>
      <button class="lh-adm-x" id="lhAdmX">‚úï</button>
    </div>
    <!-- Auth -->
    <div class="lh-adm-auth" id="lhAdmAuth">
      <p class="lh-adm-auth-sub">Inserisci la password per accedere</p>
      <input type="password" class="lh-adm-pwd" id="lhAdmPwd" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="off">
      <div class="lh-adm-auth-btns">
        <button class="lh-adm-btn ok" id="lhAdmConfirm">Accedi</button>
        <button class="lh-adm-btn no" id="lhAdmCancel">Annulla</button>
      </div>
    </div>
    <!-- Dashboard -->
    <div class="lh-adm-dash" id="lhAdmDash">
      <div class="lh-adm-status-row">
        <span class="lh-adm-status-label">Pagamenti</span>
        <span class="lh-adm-status-val off" id="lhAdmStatusVal">Disabilitati</span>
      </div>
      <div class="lh-pay-toggle">
        <span class="lh-pay-toggle-label" id="lhPayToggleLabel">Clicca per cambiare lo stato dei pagamenti su tutte le pagine in tempo reale.</span>
        <button class="lh-pay-toggle-btn enable" id="lhPayToggleBtn">
          <span id="lhPayToggleIco">üîì</span>
          <span id="lhPayToggleTxt">Abilita Pagamenti</span>
        </button>
      </div>
      <button class="lh-adm-logout" id="lhAdmLogout">Esci da Admin Mode</button>
    </div>
  </div>
</div>

<!-- Admin active banner -->
<div id="lhAdminBanner">
  <span class="lh-rdot"></span>
  <span id="lhAdminBannerTxt">Admin Mode</span>
</div>

<!-- ‚ïê‚ïê‚ïê SCRIPT ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<script>
(function () {
  'use strict';

  /* ‚îÄ‚îÄ CONFIGURAZIONE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
     Hash SHA-256 di "TEST PAGAMENTI".
     Non modificare ‚Äî √® gi√† impostato sulla tua sequenza.           */
  const ADMIN_HASH = '8bfcd70fe0f401193fdf56cae7e025516f732da047219e669a99861b2c44123b';
  const GAS_URL    = 'https://script.google.com/macros/s/AKfycbwr79RkXIEocpuOKaM6uMJqE6VFs9wjlUPvrr__FvDbDDrD2ELB1NbfrWP3BCYpHj2u/exec';
  const RESERVATION_GAS_URL = 'https://script.google.com/macros/s/AKfycbwrDLCy9xO2mcX0ORieD5k9Ck7_6ysrnBfayWg_Gd_Pno4UrCa-2JuBTvkzBNvkfQ_xxQ/exec';
  const MAX_FOUNDERS = 200;
  const SEQ_LEN    = 14; // lunghezza "TEST PAGAMENTI"

  /* ‚îÄ‚îÄ SHA-256 ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
  async function sha256(str) {
    const buf  = new TextEncoder().encode(str);
    const hash = await crypto.subtle.digest('SHA-256', buf);
    return Array.from(new Uint8Array(hash)).map(b=>b.toString(16).padStart(2,'0')).join('');
  }

  /* ‚îÄ‚îÄ STATE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
  let _isAdmin        = false;
  let _adminTestPay   = false;
  let _paymentsEnabled   = false;
  let _remoteStatusLoaded = false;

  window.lh360AdminMode       = _isAdmin;
  window.lh360PaymentsEnabled = _paymentsEnabled;

  /* ‚îÄ‚îÄ TRANSLATIONS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
  const BANNER_TEXTS = {
    it: '<strong>Early Access</strong> ‚Äî I prezzi mostrati sono indicativi. I pagamenti non sono attivi in questa fase.',
    en: '<strong>Early Access</strong> ‚Äî Prices shown are indicative. Payments are not active at this stage.',
    fr: '<strong>Early Access</strong> ‚Äî Les prix affich√©s sont indicatifs. Les paiements ne sont pas actifs √† ce stade.',
    de: '<strong>Early Access</strong> ‚Äî Die angezeigten Preise sind Richtwerte. Zahlungen sind in dieser Phase nicht aktiv.',
    es: '<strong>Early Access</strong> ‚Äî Los precios mostrados son indicativos. Los pagos no est√°n activos en esta fase.',
  };

  const RM_STRINGS = {
    it: {
      pill:'ü•á Founder Reservation Program', title:'Founder Reservation Program',
      sub:'Entra tra i primi 200 Founder. Nessun pagamento richiesto ora.',
      p1label:'Fase 1 ‚Äî Founder Candidate', p1desc:'Prenota il prodotto, entra nei primi 200, accedi a vantaggi esclusivi.',
      p2label:'Fase 2 ‚Äî Founder Verified',  p2desc:'Conferma il pagamento quando disponibile, mantieni lo status per sempre.',
      prodlabel:'Prodotto selezionato', lbname:'Nome e Cognome', lbemail:'Indirizzo Email',
      phn:'Il tuo nome completo', phe:'la@tua.email',
      submit:'Conferma Prenotazione', submitting:'Salvataggio...',
      suctitle:'Sei un Founder Candidate!',
      sucmsg:'La tua prenotazione √® confermata. Sarai ricontattato via email quando i pagamenti saranno abilitati per finalizzare il tuo acquisto con tutti i vantaggi Founder.',
      waittitle:"Sei in Lista d'Attesa",
      waitmsg:'I 200 posti Founder sono esauriti. Sei stato aggiunto alla lista d\'attesa.',
      close:'Chiudi', errrequired:'Compila tutti i campi.', erremail:"Inserisci un'email valida.", errsrv:'Errore. Riprova.',
      privacy:'I tuoi dati saranno usati esclusivamente per contattarti alla riapertura dei pagamenti.',
      reservebtn:'Prenota il tuo Posto', reservecart:'Prenota Ora ‚Äî Early Access',
      bookingdisabled:'Prenotazioni non disponibili', bookingnotice:'<strong>Early Access</strong> ‚Äî Le prenotazioni per le esperienze saranno disponibili presto. Sarai avvisato per email.',
      booked:'Posto prenotato ‚úì',
      alreadyfounder:'Sei gi√† Founder Candidate',
      changetitle:'Sei gi√† un Founder Candidate',
      changesubtitle:'Hai gi√† prenotato: <strong>{product}</strong>',
      changeinfo:'Puoi mantenere la prenotazione attuale o cambiarla con il prodotto selezionato.',
      changekeep:'Mantieni prenotazione attuale',
      changeswitch:'Cambia con questo prodotto',
      changeswitching:'Aggiornamento in corso...',
      changesuccess:'Prenotazione aggiornata ‚úì',
      changeerror:"Errore durante l'aggiornamento. Riprova.",
      changecurrentlabel:'Prenotazione attuale',
      changenewlabel:'Nuovo prodotto',
    },
    en: {
      pill:'ü•á Founder Reservation Program', title:'Founder Reservation Program',
      sub:'Join the first 200 Founders. No payment required now.',
      p1label:'Phase 1 ‚Äî Founder Candidate', p1desc:'Reserve the product, join the first 200, access exclusive benefits.',
      p2label:'Phase 2 ‚Äî Founder Verified',  p2desc:'Confirm payment when available, keep the status forever.',
      prodlabel:'Selected product', lbname:'Full Name', lbemail:'Email Address',
      phn:'Your full name', phe:'your@email.com',
      submit:'Confirm Reservation', submitting:'Saving...',
      suctitle:"You're a Founder Candidate!",
      sucmsg:'Your reservation is confirmed. You will be contacted by email when payments are enabled to finalize your purchase with all Founder benefits.',
      waittitle:"You're on the Waiting List",
      waitmsg:"The 200 Founder spots are full. You've been added to the waiting list.",
      close:'Close', errrequired:'Please fill in all fields.', erremail:'Please enter a valid email.', errsrv:'Error. Please try again.',
      privacy:'Your data will be used exclusively to contact you when payments reopen.',
      reservebtn:'Reserve Your Spot', reservecart:'Reserve Now ‚Äî Early Access',
      bookingdisabled:'Bookings not available', bookingnotice:'<strong>Early Access</strong> ‚Äî Experience bookings will be available soon. You will be notified by email.',
      booked:'Spot reserved ‚úì',
      alreadyfounder:"You're already a Founder Candidate",
      changetitle:"You're already a Founder Candidate",
      changesubtitle:'You already reserved: <strong>{product}</strong>',
      changeinfo:'You can keep your current reservation or switch to the selected product.',
      changekeep:'Keep current reservation',
      changeswitch:'Switch to this product',
      changeswitching:'Updating...',
      changesuccess:'Reservation updated ‚úì',
      changeerror:'Update failed. Please try again.',
      changecurrentlabel:'Current reservation',
      changenewlabel:'New product',
    },
    fr: {
      pill:'ü•á Founder Reservation Program', title:'Founder Reservation Program',
      sub:'Rejoignez les 200 premiers Founders. Aucun paiement requis maintenant.',
      p1label:'Phase 1 ‚Äî Founder Candidate', p1desc:'R√©servez le produit, rejoignez les 200 premiers, acc√©dez aux avantages exclusifs.',
      p2label:'Phase 2 ‚Äî Founder Verified',  p2desc:'Confirmez le paiement quand disponible, conservez le statut pour toujours.',
      prodlabel:'Produit s√©lectionn√©', lbname:'Nom et Pr√©nom', lbemail:'Adresse Email',
      phn:'Votre nom complet', phe:'votre@email.com',
      submit:'Confirmer la R√©servation', submitting:'Enregistrement...',
      suctitle:'Vous √™tes Founder Candidate!',
      sucmsg:'Votre r√©servation est confirm√©e. Vous serez contact√© par email lorsque les paiements seront activ√©s.',
      waittitle:"Vous √™tes sur la Liste d'Attente",
      waitmsg:"Les 200 places Founder sont √©puis√©es. Vous avez √©t√© ajout√© √† la liste d'attente.",
      close:'Fermer', errrequired:'Veuillez remplir tous les champs.', erremail:'Veuillez entrer un email valide.', errsrv:'Erreur. Veuillez r√©essayer.',
      privacy:'Vos donn√©es seront utilis√©es exclusivement pour vous contacter √† la r√©ouverture des paiements.',
      reservebtn:'R√©server Votre Place', reservecart:'R√©server Maintenant ‚Äî Acc√®s Anticip√©',
      bookingdisabled:'R√©servations non disponibles', bookingnotice:'<strong>Early Access</strong> ‚Äî Les r√©servations d\'exp√©riences seront disponibles prochainement. Vous serez averti par email.',
      booked:'Place r√©serv√©e ‚úì',
      alreadyfounder:'Vous √™tes d√©j√† Founder Candidate',
      changetitle:'Vous √™tes d√©j√† Founder Candidate',
      changesubtitle:'Vous avez d√©j√† r√©serv√©: <strong>{product}</strong>',
      changeinfo:'Vous pouvez conserver votre r√©servation actuelle ou la changer pour le produit s√©lectionn√©.',
      changekeep:'Conserver la r√©servation actuelle',
      changeswitch:'Changer pour ce produit',
      changeswitching:'Mise √† jour en cours...',
      changesuccess:'R√©servation mise √† jour ‚úì',
      changeerror:'Erreur lors de la mise √† jour. R√©essayez.',
      changecurrentlabel:'R√©servation actuelle',
      changenewlabel:'Nouveau produit',
    },
    de: {
      pill:'ü•á Founder Reservation Program', title:'Founder Reservation Program',
      sub:'Werden Sie einer der ersten 200 Founder. Keine Zahlung jetzt erforderlich.',
      p1label:'Phase 1 ‚Äî Founder Candidate', p1desc:'Produkt reservieren, zu den ersten 200 geh√∂ren, exklusive Vorteile erhalten.',
      p2label:'Phase 2 ‚Äî Founder Verified',  p2desc:'Zahlung best√§tigen wenn verf√ºgbar, Status f√ºr immer behalten.',
      prodlabel:'Ausgew√§hltes Produkt', lbname:'Vor- und Nachname', lbemail:'E-Mail-Adresse',
      phn:'Ihr vollst√§ndiger Name', phe:'ihre@email.de',
      submit:'Reservierung Best√§tigen', submitting:'Wird gespeichert...',
      suctitle:'Sie sind Founder Candidate!',
      sucmsg:'Ihre Reservierung ist best√§tigt. Sie werden per E-Mail kontaktiert, wenn Zahlungen aktiviert werden.',
      waittitle:'Sie sind auf der Warteliste',
      waitmsg:'Die 200 Founder-Pl√§tze sind voll. Sie wurden auf die Warteliste gesetzt.',
      close:'Schlie√üen', errrequired:'Bitte f√ºllen Sie alle Felder aus.', erremail:'Bitte geben Sie eine g√ºltige E-Mail ein.', errsrv:'Fehler. Bitte versuchen Sie es erneut.',
      privacy:'Ihre Daten werden ausschlie√ülich verwendet, um Sie bei Wiederer√∂ffnung der Zahlungen zu kontaktieren.',
      reservebtn:'Platz Reservieren', reservecart:'Jetzt Reservieren ‚Äî Early Access',
      bookingdisabled:'Buchungen nicht verf√ºgbar', bookingnotice:'<strong>Early Access</strong> ‚Äî Erfahrungsbuchungen werden bald verf√ºgbar sein. Sie werden per E-Mail benachrichtigt.',
      booked:'Platz reserviert ‚úì',
      alreadyfounder:'Sie sind bereits Founder Candidate',
      changetitle:'Sie sind bereits Founder Candidate',
      changesubtitle:'Sie haben bereits reserviert: <strong>{product}</strong>',
      changeinfo:'Sie k√∂nnen Ihre aktuelle Reservierung behalten oder zum ausgew√§hlten Produkt wechseln.',
      changekeep:'Aktuelle Reservierung behalten',
      changeswitch:'Zu diesem Produkt wechseln',
      changeswitching:'Aktualisierung l√§uft...',
      changesuccess:'Reservierung aktualisiert ‚úì',
      changeerror:'Aktualisierung fehlgeschlagen. Bitte versuchen Sie es erneut.',
      changecurrentlabel:'Aktuelle Reservierung',
      changenewlabel:'Neues Produkt',
    },
    es: {
      pill:'ü•á Founder Reservation Program', title:'Founder Reservation Program',
      sub:'√önete a los primeros 200 Founders. Sin pago requerido ahora.',
      p1label:'Fase 1 ‚Äî Founder Candidate', p1desc:'Reserva el producto, √∫nete a los primeros 200, accede a beneficios exclusivos.',
      p2label:'Fase 2 ‚Äî Founder Verified',  p2desc:'Confirma el pago cuando est√© disponible, mant√©n el status para siempre.',
      prodlabel:'Producto seleccionado', lbname:'Nombre y Apellido', lbemail:'Direcci√≥n de Email',
      phn:'Tu nombre completo', phe:'tu@email.com',
      submit:'Confirmar Reserva', submitting:'Guardando...',
      suctitle:'¬°Eres Founder Candidate!',
      sucmsg:'Tu reserva est√° confirmada. Ser√°s contactado por email cuando los pagos est√©n habilitados para finalizar tu compra.',
      waittitle:'Est√°s en Lista de Espera',
      waitmsg:'Los 200 lugares Founder est√°n llenos. Has sido a√±adido a la lista de espera.',
      close:'Cerrar', errrequired:'Por favor completa todos los campos.', erremail:'Por favor ingresa un email v√°lido.', errsrv:'Error. Por favor int√©ntalo de nuevo.',
      privacy:'Tus datos ser√°n utilizados exclusivamente para contactarte cuando los pagos se reactiven.',
      reservebtn:'Reservar tu Lugar', reservecart:'Reservar Ahora ‚Äî Acceso Anticipado',
      bookingdisabled:'Reservas no disponibles', bookingnotice:'<strong>Early Access</strong> ‚Äî Las reservas de experiencias estar√°n disponibles pronto. Ser√°s notificado por email.',
      booked:'Lugar reservado ‚úì',
      alreadyfounder:'Ya eres Founder Candidate',
      changetitle:'Ya eres Founder Candidate',
      changesubtitle:'Ya reservaste: <strong>{product}</strong>',
      changeinfo:'Puedes mantener tu reserva actual o cambiarla por el producto seleccionado.',
      changekeep:'Mantener reserva actual',
      changeswitch:'Cambiar a este producto',
      changeswitching:'Actualizando...',
      changesuccess:'Reserva actualizada ‚úì',
      changeerror:'Error al actualizar. Int√©ntalo de nuevo.',
      changecurrentlabel:'Reserva actual',
      changenewlabel:'Nuevo producto',
    },
  };

  function getLang() {
    try { const i18n = window.i18nPDP && window.i18nPDP(); return (i18n&&i18n.currentLang)||'it'; } catch(e){return'it';}
  }
  function s(key) { return (RM_STRINGS[getLang()]||RM_STRINGS.it)[key]||key; }

  /* ‚îÄ‚îÄ BANNER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
  function initBanner() {
    const banner  = document.getElementById('lhEaBanner');
    const textEl  = document.getElementById('lhBannerText');
    const dismiss = document.getElementById('lhBannerDismiss');
    if (!banner) return;

    // Se dismissed in questa sessione, nascondi
    if (sessionStorage.getItem('lh_ban_dismissed') === '1') {
      banner.classList.add('lh-hidden'); return;
    }

    // Testo nella lingua corrente
    const lang = getLang();
    if (textEl) textEl.innerHTML = BANNER_TEXTS[lang]||BANNER_TEXTS.it;

    // Nasconde se pagamenti abilitati
    if (_paymentsEnabled) { banner.classList.add('lh-hidden'); return; }

    banner.classList.remove('lh-hidden');

    dismiss && dismiss.addEventListener('click', () => {
      banner.classList.add('lh-hidden');
      sessionStorage.setItem('lh_ban_dismissed', '1');
    });
  }


  /* ‚îÄ‚îÄ REMOTE PAYMENT STATE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
     Unica fonte di verit√†: Google Apps Script (PropertiesService).
     Cache di sessione 60s per non saturare la quota GAS.           */

  const _PAY_CACHE_KEY = 'lh360_pay_remote';
  const _PAY_CACHE_TS  = 'lh360_pay_remote_ts';
  const _PAY_CACHE_TTL = 60000; // 60 secondi

  async function fetchRemotePaymentStatus() {
    // 1. Risposta immediata da localStorage (UI non si blocca mai)
    const localFallback = localStorage.getItem('lh360_pay') === '1';

    // 2. Cache di sessione (< 60s) ‚Üí evita chiamate ripetute
    try {
      const ts = parseInt(sessionStorage.getItem(_PAY_CACHE_TS) || '0', 10);
      if (Date.now() - ts < _PAY_CACHE_TTL) {
        const cached = sessionStorage.getItem(_PAY_CACHE_KEY);
        if (cached !== null) return cached === '1';
      }
    } catch(e) {}

    // 3. Fetch con timeout 8s via AbortController ‚Äî evita RESULT_CODE_HUNG da GAS cold start
    try {
      const controller = new AbortController();
      const timeoutId  = setTimeout(() => controller.abort(), 8000);
      const r = await fetch(GAS_URL + '?action=get_payment_status&t=' + Date.now(), {
        signal: controller.signal
      });
      clearTimeout(timeoutId);
      const d = await r.json();
      const enabled = !!(d.success && d.enabled);
      // Aggiorna localStorage per il prossimo caricamento
      try { localStorage.setItem('lh360_pay', enabled ? '1' : '0'); } catch(e) {}
      try {
        sessionStorage.setItem(_PAY_CACHE_KEY, enabled ? '1' : '0');
        sessionStorage.setItem(_PAY_CACHE_TS, Date.now().toString());
      } catch(e) {}
      return enabled;
    } catch(e) {
      // Timeout o errore rete ‚Üí usa il valore locale (pagina sempre funzionante)
      console.warn('[LH] Payment status: timeout/errore GAS, uso localStorage:', e.message);
      return localFallback;
    }
  }

  async function setRemotePaymentStatus(enabled) {
    // Invalida cache
    try { sessionStorage.removeItem(_PAY_CACHE_KEY); sessionStorage.removeItem(_PAY_CACHE_TS); } catch(e) {}
    const res = await fetch(
      GAS_URL + '?action=set_payment_status&value=' + (enabled ? '1' : '0') +
      '&token=' + ADMIN_HASH + '&t=' + Date.now()
    );
    const d = await res.json();
    if (!d.success) throw new Error(d.error || 'Server error');
    // Aggiorna anche localStorage come backup locale
    localStorage.setItem('lh360_pay', enabled ? '1' : '0');
    return true;
  }


  /* ‚îÄ‚îÄ APPLY PAYMENT UI ‚Äî aggiorna solo DOM ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
  function applyPaymentUI(effective) {
    const earlyWrap  = document.getElementById('lhEarlyCtaWrap');
    const buyNowBtn  = document.getElementById('buyNowBtn');
    if (earlyWrap)  earlyWrap.style.display  = effective ? 'none' : '';
    if (buyNowBtn)  buyNowBtn.style.display   = effective ? ''     : 'none';
    const cartWrap    = document.getElementById('lhCartEarlyWrap');
    const checkoutBtn = document.getElementById('checkoutBtn');
    if (cartWrap)    cartWrap.style.display   = effective ? 'none' : '';
    if (checkoutBtn) {
      checkoutBtn.style.display = effective ? '' : 'none';
      if (effective && typeof initiateCheckout === 'function') checkoutBtn.onclick = initiateCheckout;
    }
    const bkDisabled = document.getElementById('lhBookingDisabledWrap');
    const bkBtn      = document.querySelector('button[onclick="confirmBooking()"]');
    if (bkDisabled) bkDisabled.style.display = effective ? 'none' : '';
    if (bkBtn)      bkBtn.style.display      = effective ? ''     : 'none';
    updateBanner(effective);
    updateAdminDash();
  }

  function updateBanner(paymentsEnabled) {
    const banner = document.getElementById('lhEaBanner');
    if (!banner) return;
    if (paymentsEnabled) {
      banner.classList.add('lh-hidden');
    } else {
      if (sessionStorage.getItem('lh_ban_dismissed') !== '1') {
        banner.classList.remove('lh-hidden');
      }
    }
  }

    /* ‚îÄ‚îÄ APPLY PAYMENT STATE ‚Äî salva su Google Apps Script (globale) ‚îÄ‚îÄ
     Unico punto di scrittura. Chiamato solo dall'admin.           */
  window.lhApplyPaymentState = async function(enabled) {
    const btn = document.getElementById('lhPayToggleBtn');
    const ico = document.getElementById('lhPayToggleIco');
    const txt = document.getElementById('lhPayToggleTxt');
    if (btn) btn.disabled = true;
    if (ico) ico.textContent = '‚è≥';
    if (txt) txt.textContent = enabled ? 'Abilitazione in corso...' : 'Disabilitazione in corso...';
    try {
      await setRemotePaymentStatus(enabled);
      _paymentsEnabled = enabled;
      _adminTestPay = false;
      window.lh360PaymentsEnabled = enabled;
      try {
        sessionStorage.setItem(_PAY_CACHE_KEY, enabled ? '1' : '0');
        sessionStorage.setItem(_PAY_CACHE_TS, Date.now().toString());
      } catch(e) {}
      applyPaymentUI(enabled);
      if (txt) {
        txt.textContent = enabled ? '‚úÖ Pagamenti abilitati per tutti gli utenti!' : '‚úÖ Pagamenti disabilitati per tutti gli utenti!';
        setTimeout(() => updateAdminDash(), 2500);
      }
    } catch(e) {
      console.error('[LH] Errore aggiornamento remoto:', e);
      if (ico) ico.textContent = '‚ùå';
      if (txt) txt.textContent = 'Errore: ' + e.message + ' ‚Äî riprova';
      if (btn) btn.disabled = false;
      setTimeout(() => updateAdminDash(), 3500);
    }
  };

  /* ‚îÄ‚îÄ ADMIN STATE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
  function setAdmin(val) {
    _isAdmin = val;
    window.lh360AdminMode = val;
    const banner = document.getElementById('lhAdminBanner');
    if (banner) {
      banner.style.display = val ? 'flex' : 'none';
      const txt = document.getElementById('lhAdminBannerTxt');
      if (txt) txt.textContent = 'Admin Mode ‚Äî Clicca per aprire';
    }
    if (val) {
      // Modalit√† admin: mostra i pagamenti attivi SOLO localmente (test)
      _adminTestPay = true;
      window.lh360PaymentsEnabled = true;
      applyPaymentUI(true);
      updateAdminDash();
      // Poi carica lo stato reale dal server (per il badge nel dashboard)
      fetchRemotePaymentStatus().then(remoteEnabled => {
        _paymentsEnabled = remoteEnabled;
        _remoteStatusLoaded = true;
        updateAdminDash(); // aggiorna etichette con stato reale
      });
    } else {
      _adminTestPay = false;
      window.lh360PaymentsEnabled = _paymentsEnabled;
      applyPaymentUI(_paymentsEnabled);
    }
  }

  function updateAdminDash() {
    const statusVal = document.getElementById('lhAdmStatusVal');
    const toggleBtn = document.getElementById('lhPayToggleBtn');
    const toggleIco = document.getElementById('lhPayToggleIco');
    const toggleTxt = document.getElementById('lhPayToggleTxt');
    if (statusVal) {
      if (!_remoteStatusLoaded) {
        statusVal.textContent = 'Caricamento...';
        statusVal.className   = 'lh-adm-status-val off';
      } else if (_paymentsEnabled) {
        statusVal.textContent = 'üåç Abilitati (tutti gli utenti)';
        statusVal.className   = 'lh-adm-status-val on';
      } else {
        statusVal.textContent = 'üîí Disabilitati ‚Äî Test Admin attivo';
        statusVal.className   = 'lh-adm-status-val off';
      }
    }
    if (toggleBtn) toggleBtn.disabled = false;
    if (toggleBtn) {
      toggleBtn.className = 'lh-pay-toggle-btn ' + (_paymentsEnabled ? 'disable' : 'enable');
    }
    if (toggleIco) toggleIco.textContent = _paymentsEnabled ? 'üîí' : 'üîì';
    if (toggleTxt) {
      toggleTxt.textContent = _paymentsEnabled
        ? 'Disabilita Pagamenti per Tutti'
        : 'Abilita Definitivamente per Tutti';
    }
  }

  /* ‚îÄ‚îÄ KEYBOARD SEQUENCE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
  let keyBuf = '';
  document.addEventListener('keydown', async function(e) {
    const tag = document.activeElement && document.activeElement.tagName;
    if (tag==='INPUT'||tag==='TEXTAREA'||tag==='SELECT') return;
    if (e.key.length === 1) {
      keyBuf += e.key.toUpperCase();
      if (keyBuf.length > SEQ_LEN * 2) keyBuf = keyBuf.slice(-SEQ_LEN * 2);
      if (keyBuf.length >= SEQ_LEN) {
        const slice = keyBuf.slice(-SEQ_LEN);
        const h = await sha256(slice);
        if (h === ADMIN_HASH) { keyBuf = ''; openAdminPanel(); }
      }
    }
  });

  /* ‚îÄ‚îÄ ADMIN PANEL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
  function openAdminPanel() {
    const panel  = document.getElementById('lhAdminPanel');
    const auth   = document.getElementById('lhAdmAuth');
    const dash   = document.getElementById('lhAdmDash');
    const pwd    = document.getElementById('lhAdmPwd');
    if (!panel) return;
    // Se gi√† admin, apri direttamente il dashboard
    if (_isAdmin) {
      auth.style.display = 'none';
      dash.classList.add('show');
      updateAdminDash();
    } else {
      auth.style.display = '';
      dash.classList.remove('show');
      if (pwd) pwd.value = '';
    }
    panel.classList.add('lh-open');
    requestAnimationFrame(() => {
      panel.classList.add('lh-vis');
      if (!_isAdmin && pwd) pwd.focus();
    });
  }

  function closeAdminPanel() {
    const panel = document.getElementById('lhAdminPanel');
    if (!panel) return;
    panel.classList.remove('lh-vis');
    setTimeout(() => panel.classList.remove('lh-open'), 260);
  }

  async function confirmAdminPwd() {
    const pwd = document.getElementById('lhAdmPwd');
    if (!pwd) return;
    const h = await sha256(pwd.value);
    if (h === ADMIN_HASH) {
      pwd.value = '';
      setAdmin(true);
      const auth = document.getElementById('lhAdmAuth');
      const dash = document.getElementById('lhAdmDash');
      if (auth) auth.style.display = 'none';
      if (dash) { dash.classList.add('show'); updateAdminDash(); }
    } else {
      pwd.classList.remove('shake');
      void pwd.offsetWidth;
      pwd.classList.add('shake');
      pwd.value = '';
      setTimeout(()=>pwd.classList.remove('shake'), 450);
    }
  }

  function logoutAdmin() {
    setAdmin(false);
    closeAdminPanel();
  }

  /* ‚îÄ‚îÄ RESERVATION MODAL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
  let _rProd='', _rSku='', _rPage='';

  /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     FOUNDER RESERVATION STATE MANAGER (Cart)
     Gestisce lo stato persistente per-utente in localStorage.
  ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
  const RESERVATION_KEY = 'lh_founder_reservation';

  function getReservationState() {
    try { const raw=localStorage.getItem(RESERVATION_KEY); return raw?JSON.parse(raw):null; } catch(e){return null;}
  }
  function setReservationState(data) {
    try { localStorage.setItem(RESERVATION_KEY, JSON.stringify(data)); } catch(e) {}
  }
  function clearReservationState() {
    try { localStorage.removeItem(RESERVATION_KEY); } catch(e) {}
  }

  /**
   * Verifica lo stato della prenotazione con il server GAS.
   * Se l'email locale non risulta pi√π nei fogli, cancella lo stato locale
   * e ripristina l'UI. In caso di errore di rete, mantiene lo stato locale.
   * @param {string|null} currentSku  SKU del prodotto corrente
   * @param {string}      context     'cart' | 'pdp'
   */
  async function verifyReservationState(currentSku, context) {
    const state = getReservationState();
    if (!state || !state.email) return;

    try {
      const res = await fetch(
        RESERVATION_GAS_URL + '?action=check_reservation&email=' + encodeURIComponent(state.email),
        { method: 'GET' }
      );
      if (!res.ok) throw new Error('HTTP ' + res.status);
      const result = await res.json();

      if (!result.success) return;

      if (!result.found) {
        // ‚îÄ‚îÄ Utente NON trovato nei fogli ‚Üí reset completo ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        console.info('[LH] Prenotazione non trovata nei fogli. Reset stato locale.');
        clearReservationState();
        applyReservationUI(currentSku, context);
      } else {
        // ‚îÄ‚îÄ Utente trovato ‚Üí aggiorna stato locale con dati server ‚îÄ
        const updated = Object.assign({}, state, {
          waitlist:         !!result.waitlist,
          founderPosition:  result.founder_position  || state.founderPosition  || null,
          waitlistPosition: result.waitlist_position || state.waitlistPosition || null,
          sku:     result.sku     || state.sku,
          product: result.product || state.product,
          serverVerifiedAt: new Date().toISOString()
        });
        setReservationState(updated);
        applyReservationUI(currentSku, context);
      }
    } catch(e) {
      console.warn('[LH] Verifica prenotazione fallita, stato locale mantenuto:', e.message);
    }
  }

  function applyReservationUI(currentSku, context) {
    context = context || 'cart';
    const state = getReservationState();
    const btnIds = context==='cart' ? ['cartReserveBtn'] : ['reserveNowBtn'];
    btnIds.forEach(function(btnId) {
      const btn = document.getElementById(btnId);
      if (!btn) return;
      const spanEl = btn.querySelector('span[data-i18n]') || btn.querySelector('span') || btn;

      if (!state) {
        btn.disabled = false;
        btn.classList.remove('btn-reserve-booked','btn-reserve-already-founder');
        spanEl.textContent = context==='cart' ? s('reservecart') : s('reservebtn');
        btn.onclick = null;
      } else if (currentSku && state.sku && state.sku === currentSku) {
        btn.disabled = true;
        btn.classList.remove('btn-reserve-already-founder');
        btn.classList.add('btn-reserve-booked');
        const svgEl = btn.querySelector('svg'); if(svgEl) svgEl.style.display='none';
        spanEl.textContent = s('booked');
        btn.onclick = null;
      } else {
        btn.disabled = false;
        btn.classList.remove('btn-reserve-booked');
        btn.classList.add('btn-reserve-already-founder');
        const svgEl = btn.querySelector('svg'); if(svgEl) svgEl.style.display='';
        spanEl.textContent = s('alreadyfounder');
        btn.onclick = function(e) {
          e.preventDefault(); e.stopPropagation();
          const cp = _getCurrentCartProduct();
          openChangeProductModal(cp.name, cp.sku, context);
        };
      }
    });
  }

  function _getCurrentCartProduct() {
    try {
      const cart=JSON.parse(localStorage.getItem('lh360_cart')||'[]');
      if(cart.length>=1) return {name:cart[0].title||'Prodotto',sku:cart[0].sku||''};
    } catch(e){}
    return {name:'Carrello',sku:''};
  }

  /* ‚îÄ‚îÄ CHANGE PRODUCT MODAL (Cart) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
  let _cpNewProd='', _cpNewSku='', _cpPage='';

  function openChangeProductModal(newProduct, newSku, page) {
    _cpNewProd=newProduct||'‚Äî'; _cpNewSku=newSku||''; _cpPage=page||'cart';
    const state=getReservationState();
    const currentProd=state?(state.product||'‚Äî'):'‚Äî';
    const set  = (id,v)=>{const el=document.getElementById(id);if(el)el.textContent=v;};
    const setH = (id,v)=>{const el=document.getElementById(id);if(el)el.innerHTML=v;};
    set('lhCpPill',  s('pill'));
    set('lhCpTitle', s('changetitle'));
    setH('lhCpSubtitle', s('changesubtitle').replace('{product}',currentProd));
    set('lhCpCurrentLabel', s('changecurrentlabel'));
    set('lhCpCurrentName',  currentProd);
    set('lhCpNewLabel',     s('changenewlabel'));
    set('lhCpNewName',      _cpNewProd);
    set('lhCpInfo',         s('changeinfo'));
    set('lhCpSwitchBtn',    s('changeswitch'));
    set('lhCpKeepBtn',      s('changekeep'));
    const fb=document.getElementById('lhCpFeedback');
    if(fb){fb.textContent='';fb.className='lh-cp-feedback';}
    const sb=document.getElementById('lhCpSwitchBtn'); if(sb) sb.disabled=false;
    const modal=document.getElementById('lhChangeProductModal');
    if(!modal) return;
    modal.classList.add('lh-open');
    requestAnimationFrame(()=>modal.classList.add('lh-vis'));
    document.body.style.overflow='hidden';
  }

  window.closeChangeProductModal = function() {
    const m=document.getElementById('lhChangeProductModal');
    if(!m) return;
    m.classList.remove('lh-vis');
    setTimeout(()=>{m.classList.remove('lh-open');document.body.style.overflow='';},340);
  };

  async function confirmChangeProduct() {
    const state=getReservationState();
    if(!state||!state.email) return;
    const sb=document.getElementById('lhCpSwitchBtn');
    const fb=document.getElementById('lhCpFeedback');
    const orig=sb?sb.textContent:'';
    if(sb){sb.disabled=true;sb.textContent=s('changeswitching');}
    if(fb){fb.textContent='';fb.className='lh-cp-feedback';}
    try {
      const res=await fetch(RESERVATION_GAS_URL,{method:'POST',headers:{'Content-Type':'application/x-www-form-urlencoded'},
        body:new URLSearchParams({action:'update_reservation',email:state.email,product:_cpNewProd,sku:_cpNewSku})});
      const result=await res.json();
      if(result.success){
        setReservationState(Object.assign({},state,{sku:_cpNewSku,product:_cpNewProd,ts:new Date().toISOString()}));
        if(fb){fb.textContent=s('changesuccess');fb.className='lh-cp-feedback success';}
        setTimeout(function(){applyReservationUI(_cpNewSku,_cpPage);window.closeChangeProductModal();},1400);
      } else { throw new Error(result.error||'server error'); }
    } catch(err) {
      if(fb){fb.textContent=s('changeerror');fb.className='lh-cp-feedback error';}
      if(sb){sb.disabled=false;sb.textContent=orig;}
    }
  }

  window.lhApplyReservationUI     = applyReservationUI;
  window.lhGetReservationState    = getReservationState;
  window.lhSetReservationState    = setReservationState;
  window.lhClearReservationState  = clearReservationState;
  window.lhVerifyReservationState = verifyReservationState;
  window.openChangeProductModal   = openChangeProductModal;

  window.openFounderModal = function(prodName, sku, page) {
    _rProd = prodName||'‚Äî'; _rSku = sku||''; _rPage = page||window.location.pathname;
    const L = s;
    const set = (id, val) => { const el=document.getElementById(id); if(el) el.textContent=val; };
    const setH= (id, val) => { const el=document.getElementById(id); if(el) el.innerHTML=val; };
    set('lhRmPill',       L('pill'));    set('lhRmTitle',   L('title'));
    set('lhRmSub',        L('sub'));     set('lhP1Label',   L('p1label'));
    set('lhP1Desc',       L('p1desc')); set('lhP2Label',   L('p2label'));
    set('lhP2Desc',       L('p2desc')); set('lhRmProdLabel',L('prodlabel'));
    set('lhRmProdName',   _rProd);
    set('lhLbName',       L('lbname')); set('lhLbEmail',   L('lbemail'));
    set('lhRmSubmit',     L('submit')); set('lhRmPrivacy',  L('privacy'));
    set('lhRmSucTitle',   L('suctitle')); setH('lhRmSucMsg', L('sucmsg'));
    set('lhRmWaitTitle',  L('waittitle')); setH('lhRmWaitMsg', L('waitmsg'));
    set('lhRmSucClose',   L('close'));   set('lhRmWaitClose', L('close'));
    const ni=document.getElementById('lhRmName'), ei=document.getElementById('lhRmEmail');
    if(ni){ni.placeholder=L('phn');ni.value='';}
    if(ei){ei.placeholder=L('phe');ei.value='';}
    const err=document.getElementById('lhRmErr'); if(err){err.textContent='';err.classList.remove('show');}
    if(ni) ni.classList.remove('err'); if(ei) ei.classList.remove('err');
    document.getElementById('lhRmForm').style.display='';
    document.getElementById('lhRmSuccess').classList.remove('show');
    document.getElementById('lhRmWait').classList.remove('show');
    const modal=document.getElementById('lhReserveModal');
    modal.classList.add('lh-open');
    requestAnimationFrame(()=>{modal.classList.add('lh-vis'); if(ni) ni.focus();});
    document.body.style.overflow='hidden';
  };

  window.closeFounderModal = function() {
    const m=document.getElementById('lhReserveModal');
    m.classList.remove('lh-vis');
    setTimeout(()=>{m.classList.remove('lh-open'); document.body.style.overflow='';}, 340);
  };

  async function submitReservation() {
    const ni=document.getElementById('lhRmName'), ei=document.getElementById('lhRmEmail');
    const btn=document.getElementById('lhRmSubmit'), err=document.getElementById('lhRmErr');
    const name=ni.value.trim(), email=ei.value.trim();
    err.classList.remove('show'); ni.classList.remove('err'); ei.classList.remove('err');
    if (!name||!email) {
      err.textContent=s('errrequired'); err.classList.add('show');
      if(!name)ni.classList.add('err'); if(!email)ei.classList.add('err'); return;
    }
    if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
      err.textContent=s('erremail'); err.classList.add('show'); ei.classList.add('err'); return;
    }
    const orig=btn.textContent; btn.disabled=true; btn.textContent=s('submitting');
    try {
      const res=await fetch(RESERVATION_GAS_URL,{method:'POST',headers:{'Content-Type':'application/x-www-form-urlencoded'},
        body:new URLSearchParams({action:'save_reservation',name,email,product:_rProd,sku:_rSku,lang:getLang(),page:_rPage,timestamp:new Date().toISOString(),max_founders:MAX_FOUNDERS})});
      const result=await res.json();
      document.getElementById('lhRmForm').style.display='none';
      if (result.waitlist) {
        document.getElementById('lhRmWait').classList.add('show');
        setReservationState({email,sku:_rSku,product:_rProd,waitlist:true,ts:new Date().toISOString()});
      } else {
        const badge=document.getElementById('lhRmFounderBadge');
        if(badge&&result.founder_position) badge.textContent=`‚ú¶ Founder #${result.founder_position} ‚Äî Candidate`;
        document.getElementById('lhRmSuccess').classList.add('show');
        // ‚îÄ‚îÄ Salva stato prenotazione in localStorage (persistente) ‚îÄ‚îÄ
        setReservationState({
          email, sku:_rSku, product:_rProd,
          founderPosition:result.founder_position||null,
          reservationId:result.reservation_id||null,
          waitlist:false, ts:new Date().toISOString()
        });
        applyReservationUI(_rSku, _rPage);
      }
    } catch(e) {
      err.textContent=s('errsrv'); err.classList.add('show');
      btn.disabled=false; btn.textContent=orig;
    }
  }

  /* ‚îÄ‚îÄ INIT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
  document.addEventListener('DOMContentLoaded', function() {
    initBanner();

    // Applica stato pagamenti iniziale
    // Stato pagamenti: carica dal server GAS (fonte di verit√† globale)
    fetchRemotePaymentStatus().then(enabled => {
      _paymentsEnabled = enabled;
      _remoteStatusLoaded = true;
      window.lh360PaymentsEnabled = enabled;
      applyPaymentUI(enabled);
    });

    // ‚îÄ‚îÄ Verifica prenotazione contro i fogli Google ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    // Recupera lo SKU del prodotto nel carrello (se presente) per
    // determinare il corretto stato B/C del pulsante dopo la verifica.
    let _initCartSku = null;
    try {
      const _initCart = JSON.parse(localStorage.getItem('lh360_cart') || '[]');
      if (_initCart.length === 1) _initCartSku = _initCart[0].sku || null;
    } catch(e) {}
    // Applica subito UI dalla cache locale (risposta istantanea),
    // poi interroga il server: se l'email non √® pi√π nei fogli, resetta.
    applyReservationUI(_initCartSku, 'cart');
    verifyReservationState(_initCartSku, 'cart');

    // Reservation modal events
    document.getElementById('lhRmClose')   ?.addEventListener('click', window.closeFounderModal);
    document.getElementById('lhRmBackdrop')?.addEventListener('click', window.closeFounderModal);
    document.getElementById('lhRmSubmit')  ?.addEventListener('click', submitReservation);
    document.getElementById('lhRmSucClose')?.addEventListener('click', window.closeFounderModal);
    document.getElementById('lhRmWaitClose')?.addEventListener('click',window.closeFounderModal);

    // Change product modal events
    document.getElementById('lhCpClose')    ?.addEventListener('click', window.closeChangeProductModal);
    document.getElementById('lhCpBackdrop') ?.addEventListener('click', window.closeChangeProductModal);
    document.getElementById('lhCpKeepBtn')  ?.addEventListener('click', window.closeChangeProductModal);
    document.getElementById('lhCpSwitchBtn')?.addEventListener('click', confirmChangeProduct);

    // Admin panel events
    document.getElementById('lhAdmX')      ?.addEventListener('click', closeAdminPanel);
    document.getElementById('lhAdmCancel') ?.addEventListener('click', closeAdminPanel);
    document.getElementById('lhAdmConfirm')?.addEventListener('click', confirmAdminPwd);
    document.getElementById('lhAdmPwd')    ?.addEventListener('keydown', e=>{ if(e.key==='Enter') confirmAdminPwd(); });
    document.getElementById('lhAdmLogout') ?.addEventListener('click', logoutAdmin);
    document.getElementById('lhAdminBanner')?.addEventListener('click', openAdminPanel);

    // Payment toggle
    document.getElementById('lhPayToggleBtn')?.addEventListener('click', function() {
      window.lhApplyPaymentState(!_paymentsEnabled);
    });

    // ESC
    document.addEventListener('keydown', e=>{
      if(e.key==='Escape'){ window.closeFounderModal(); window.closeChangeProductModal(); closeAdminPanel(); }
    });
  });

})();
</script>

<script>
document.addEventListener('DOMContentLoaded', function () {
  const cartReserveBtn = document.getElementById('cartReserveBtn');
  if (cartReserveBtn) {
    cartReserveBtn.addEventListener('click', function () {
      // Gli stati B e C sono gestiti direttamente da applyReservationUI
      if (cartReserveBtn.classList.contains('btn-reserve-booked')) return;
      if (cartReserveBtn.classList.contains('btn-reserve-already-founder')) return;

      let pn='Carrello', ps='';
      try {
        const cart=JSON.parse(localStorage.getItem('lh360_cart')||'[]');
        if(cart.length===1){pn=cart[0].title||'Prodotto';ps=cart[0].sku||'';}
        else if(cart.length>1){pn=cart.length+' prodotti';}
      } catch(e){}
      window.openFounderModal(pn,ps,'cart');
    });
  }

  // ‚úÖ Ripristina lo stato del pulsante di prenotazione ad ogni cambio lingua.
  // Il sistema i18n sovrascrive il testo del <span data-i18n="reserve_btn_cart"> con la
  // traduzione generica, perdendo lo stato "Posto prenotato ‚úì" / "already-founder".
  // Ascoltiamo 'languageChanged' e richiamiamo applyReservationUI per ripristinare lo stato.
  document.addEventListener('languageChanged', function() {
    if (typeof window.lhApplyReservationUI === 'function') {
      let cartSkuOnLangChange = null;
      try {
        const cart = JSON.parse(localStorage.getItem('lh360_cart') || '[]');
        if (cart.length === 1) cartSkuOnLangChange = cart[0].sku || null;
      } catch(e) {}
      // Applica subito da cache locale, poi ri-verifica vs server
      window.lhApplyReservationUI(cartSkuOnLangChange, 'cart');
      if (typeof window.lhVerifyReservationState === 'function') {
        window.lhVerifyReservationState(cartSkuOnLangChange, 'cart');
      }
    }
  });
});
</script>
</body>
</html>
