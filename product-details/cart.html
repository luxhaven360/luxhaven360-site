<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Il Tuo Carrello</title>
    <!-- Connection Monitor Styles -->
    <link rel="stylesheet" href="../connection-monitor.css" />

    <!-- Sistema i18n -->
<script src="../translations.js"></script>
<script src="translations-pdp.js"></script>
<script src="i18n-pdp.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(to bottom, #09090b, #18181b, #09090b);
            color: #fafafa;
            line-height: 1.6;
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 3rem 1.5rem;
        }

        /* Header */
        .cart-header {
            margin-bottom: 3rem;
            padding-bottom: 2rem;
            border-bottom: 1px solid #27272a;
        }

        .cart-title {
            font-size: 3rem;
            font-weight: 300;
            letter-spacing: -0.02em;
            margin-bottom: 0.5rem;
        }

        .cart-subtitle {
            color: #a1a1aa;
            font-size: 1.125rem;
        }

        /* Cart Layout */
        .cart-layout {
            display: grid;
            grid-template-columns: 1fr 400px;
            gap: 4rem;
            align-items: start;
        }

        /* Cart Items */
        .cart-items {
            display: flex;
            flex-direction: column;
            gap: 2rem;
        }

        .cart-item {
            display: grid;
            grid-template-columns: 140px 1fr auto;
            gap: 2rem;
            padding: 2rem;
            background: rgba(24, 24, 27, 0.3);
            border: 1px solid rgba(39, 39, 42, 0.5);
            border-radius: 1.5rem;
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
        }

        .cart-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
            opacity: 0;
            transition: opacity 0.3s;
        }

        .cart-item:hover {
            border-color: rgba(255, 255, 255, 0.1);
            background: rgba(24, 24, 27, 0.5);
        }

        .cart-item:hover::before {
            opacity: 1;
        }

        .item-image {
            aspect-ratio: 3/4;
            border-radius: 1rem;
            overflow: hidden;
            background: #18181b;
        }

        .item-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.5s;
        }

        .cart-item:hover .item-image img {
            transform: scale(1.05);
        }

        .item-details {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            justify-content: center;
        }

        .item-name {
            font-size: 1.25rem;
            font-weight: 500;
            letter-spacing: -0.01em;
        }

        .item-variant {
            color: #a1a1aa;
            font-size: 0.875rem;
            display: flex;
            gap: 1rem;
        }

        .variant-detail {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .color-dot {
            width: 1rem;
            height: 1rem;
            border-radius: 50%;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .item-actions {
            display: flex;
            gap: 1rem;
            margin-top: 0.5rem;
        }

        .remove-btn {
            background: none;
            border: none;
            color: #71717a;
            cursor: pointer;
            font-size: 0.875rem;
            text-decoration: underline;
            transition: color 0.3s;
        }

        .remove-btn:hover {
            color: #ef4444;
        }

        .item-price-section {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            justify-content: center;
            gap: 0.5rem;
        }

        .item-price {
            font-size: 1.5rem;
            font-weight: 300;
            letter-spacing: 0.02em;
        }

        .item-original-price {
            color: #71717a;
            font-size: 0.875rem;
            text-decoration: line-through;
        }

        /* Empty Cart */
        .empty-cart {
            text-align: center;
            padding: 6rem 2rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            width: 100%;
            margin: 0 auto;
        }

        .empty-cart-icon {
            font-size: 4rem;
            margin-bottom: 1.5rem;
            opacity: 0.3;
        }

        .empty-cart h2 {
            font-size: 2rem;
            font-weight: 300;
            margin-bottom: 1rem;
        }

        .empty-cart p {
            color: #a1a1aa;
            margin-bottom: 2rem;
        }

        .btn-continue {
            display: inline-block;
            padding: 1rem 2.5rem;
            background: white;
            color: #09090b;
            text-decoration: none;
            border-radius: 1rem;
            font-weight: 500;
            transition: all 0.3s;
        }

        .btn-continue:hover {
            background: #f4f4f5;
            transform: scale(1.02);
        }

        /* Summary Sidebar */
        .cart-summary {
            position: sticky;
            top: 2rem;
            background: rgba(24, 24, 27, 0.5);
            border: 1px solid rgba(39, 39, 42, 0.8);
            border-radius: 1.5rem;
            padding: 2rem;
            backdrop-filter: blur(20px);
        }

        .summary-title {
            font-size: 1.5rem;
            font-weight: 500;
            margin-bottom: 1.5rem;
            letter-spacing: -0.01em;
        }

        .summary-row {
            display: flex;
            justify-content: space-between;
            padding: 1rem 0;
            border-bottom: 1px solid rgba(39, 39, 42, 0.5);
        }

        .summary-row:last-of-type {
            border-bottom: none;
        }

        .summary-label {
            color: #a1a1aa;
            font-size: 0.9375rem;
        }

        .summary-value {
            font-weight: 500;
        }

        .summary-total {
            padding: 1.5rem 0;
            border-top: 2px solid rgba(255, 255, 255, 0.1);
            margin-top: 1rem;
        }

        .summary-total .summary-label {
            color: white;
            font-size: 1.125rem;
            font-weight: 500;
        }

        .summary-total .summary-value {
            font-size: 1.75rem;
            font-weight: 300;
            letter-spacing: 0.02em;
        }

        /* Indicatore calcolo sconto premium */
.discount-calculating {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    color: #D4AF37;
    font-size: 0.875rem;
    font-weight: 400;
    letter-spacing: 0.05em;
}

.discount-calculating::before {
    content: '';
    width: 12px;
    height: 12px;
    border: 2px solid #D4AF37;
    border-top-color: transparent;
    border-radius: 50%;
    animation: discountSpin 0.8s linear infinite;
}

@keyframes discountSpin {
    to { transform: rotate(360deg); }
}

.discount-calculating-text {
    background: linear-gradient(90deg, #D4AF37, #FFD700, #D4AF37);
    background-size: 200% auto;
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    animation: discountShimmer 2s linear infinite;
}

@keyframes discountShimmer {
    to { background-position: 200% center; }
}

        .progress-section {
            margin-bottom: 1.5rem;
        }

        .progress-text {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.5rem;
            font-size: 0.875rem;
            color: #a1a1aa;
        }

        .progress-highlight {
            color: #34d399;
        }

        .progress-bar {
            height: 4px;
            background: #27272a;
            border-radius: 2px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #34d399, #10b981);
            transition: width 0.3s ease;
        }

        /* Promo Code */
        .promo-code {
            margin: 1.5rem 0;
        }

        .promo-label {
            display: block;
            font-size: 0.875rem;
            color: #a1a1aa;
            margin-bottom: 0.5rem;
        }

        .promo-input-wrapper {
            display: flex;
            gap: 0.5rem;
        }

        .promo-input {
            flex: 1;
            padding: 0.75rem 1rem;
            background: rgba(39, 39, 42, 0.5);
            border: none;
            border-radius: 0.75rem;
            color: white;
            font-size: 0.875rem;
        }

        .promo-input::placeholder {
            color: #71717a;
        }

        .promo-apply {
            padding: 0.75rem 1.5rem;
            background: white;
            color: #09090b;
            border: none;
            border-radius: 0.75rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
        }

        .promo-apply:hover {
            background: #f4f4f5;
        }

        /* ‚úÖ Feedback validazione coupon - Design Premium */
.promo-message {
    margin-top: 0.75rem;
    font-size: 0.875rem;
    padding: 0.875rem 1.125rem;
    border-radius: 0.75rem;
    display: none;
    font-weight: 500;
    letter-spacing: 0.01em;
    line-height: 1.5;
    animation: messageSlideIn 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
}

@keyframes messageSlideIn {
    from {
        opacity: 0;
        transform: translateY(-0.5rem);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.promo-message.success {
    background: linear-gradient(135deg, rgba(212, 175, 55, 0.12), rgba(255, 215, 0, 0.08));
    color: #D4AF37;
    border: 1px solid rgba(212, 175, 55, 0.4);
}

.promo-message.success::before {
    content: '‚úì ';
    font-weight: 700;
    margin-right: 0.5rem;
    font-size: 1.1em;
}

.promo-message.error {
    background: linear-gradient(135deg, rgba(239, 68, 68, 0.12), rgba(220, 38, 38, 0.08));
    color: #ef4444;
    border: 1px solid rgba(239, 68, 68, 0.4);
}

.promo-message.error::before {
    content: '‚úï ';
    font-weight: 700;
    margin-right: 0.5rem;
    font-size: 1.1em;
}

.promo-message.warning {
    background: linear-gradient(135deg, rgba(251, 191, 36, 0.12), rgba(245, 158, 11, 0.08));
    color: #f59e0b;
    border: 1px solid rgba(251, 191, 36, 0.4);
}

.promo-message.warning::before {
    content: '‚ö† ';
    font-weight: 700;
    margin-right: 0.5rem;
    font-size: 1.1em;
}

        /* Checkout Button */
        .checkout-btn {
            width: 100%;
            padding: 1.25rem;
            background: white;
            color: #09090b;
            border: none;
            border-radius: 1rem;
            font-size: 1.125rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 2rem;
        }

        .checkout-btn:hover {
            background: #f4f4f5;
            transform: scale(1.02);
        }

        /* Trust Badges */
        .trust-badges {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .trust-badge {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            color: #a1a1aa;
            font-size: 0.875rem;
        }

        .trust-icon {
            font-size: 1.25rem;
            opacity: 0.8;
        }

        /* Recommended Section */
        .recommended-section {
            margin-top: 6rem;
        }

        .recommended-title {
            font-size: 2rem;
            font-weight: 300;
            margin-bottom: 2rem;
        }

        .recommended-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 2rem;
        }

        .recommended-item {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .recommended-image {
            aspect-ratio: 3/4;
            border-radius: 1rem;
            overflow: hidden;
            background: #18181b;
        }

        .recommended-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.5s;
        }

        .recommended-item:hover img {
            transform: scale(1.05);
        }

        .recommended-name {
            font-size: 1rem;
            font-weight: 500;
        }

        .recommended-price {
            color: #a1a1aa;
            font-size: 0.875rem;
        }

        /* Descrizione prodotti consigliati */
.recommended-desc {
    font-size: 0.875rem;
    color: #71717a;
    margin-top: 0.25rem;
    margin-bottom: 0.5rem;
    line-height: 1.3;
    min-height: 2.6em;
    overflow: hidden;
    text-overflow: ellipsis;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
}

/* ‚úÖ NUOVO: Padding tra nome e immagine */
.recommended-name {
    font-size: 1rem;
    font-weight: 500;
    margin-top: 1rem; /* ‚Üê Aggiunto padding */
}

/* Hover effect migliorato */
.recommended-item {
    transition: transform 0.3s, box-shadow 0.3s;
    cursor: pointer;
}

.recommended-item:hover {
    transform: translateY(-0.5rem);
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
}

/* ‚úÖ RIMOSSO: Hover oro dal titolo normale */
/* .recommended-item:hover .recommended-name {
    color: #D4AF37;
} */

/* ‚úÖ NUOVO: Hover oro SOLO per prodotti featured */
.recommended-item.featured:hover .recommended-name {
    color: #FFD700;
}

/* Badge "Consigliato" Premium (invariato) */
.recommended-item.featured {
    position: relative;
    border: 2px solid #D4AF37;
    border-radius: 1rem;
    padding: 0.5rem;
    background: linear-gradient(135deg, rgba(212, 175, 55, 0.05), rgba(0, 0, 0, 0));
    transform: scale(1.05);
    box-shadow: 0 8px 30px rgba(212, 175, 55, 0.3);
}

.recommended-badge {
    position: absolute;
    top: 10px;
    right: 10px;
    background: linear-gradient(135deg, #D4AF37, #FFD700);
    color: #09090b;
    padding: 0.375rem 0.875rem;
    border-radius: 2rem;
    font-size: 0.75rem;
    font-weight: 700;
    letter-spacing: 0.05em;
    text-transform: uppercase;
    box-shadow: 0 4px 12px rgba(212, 175, 55, 0.4);
    z-index: 10;
}

.recommended-item.featured .recommended-name {
    color: #D4AF37;
    font-weight: 600;
}

.recommended-item.featured .recommended-image {
    border: 1px solid rgba(212, 175, 55, 0.3);
}

        @media (max-width: 768px) {
            .cart-layout {
                grid-template-columns: 1fr;
            }

            .cart-item {
                grid-template-columns: 120px 1fr;
                gap: 1.5rem;
            }

            .item-price-section {
                grid-column: 2;
                align-items: flex-start;
            }

            .recommended-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        /* Evidenziazione riga sconto attivo */
.summary-row.discount-active .summary-value {
    color: #34d399 !important;
    font-weight: 600;
    font-size: 1.125rem;
}

/* Badge combo applicata */
.combo-badge {
    display: inline-block;
    background: rgba(52, 211, 153, 0.1);
    border: 1px solid #34d399;
    color: #34d399;
    padding: 0.25rem 0.75rem;
    border-radius: 1rem;
    font-size: 0.75rem;
    margin-left: 0.5rem;
    font-weight: 500;
}

/* Animazione comparsa sconto */
@keyframes discountPulse {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.05); }
}

.discount-active {
    animation: discountPulse 0.6s ease-in-out;
}

        /* ============================================
   SELETTORE LINGUA PREMIUM (PDP PAGES)
   ============================================ */

.pdp-lang-selector {
    position: fixed;
    top: 2rem;
    right: 2rem;
    z-index: 9999;
    display: flex;
    align-items: center;
    gap: 0.25rem;
    background: rgba(9, 9, 11, 0.85);
    backdrop-filter: blur(20px);
    border: 1px solid rgba(212, 175, 55, 0.2);
    border-radius: 2rem;
    padding: 0.625rem 1.25rem;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

.pdp-lang-selector:hover {
    border-color: rgba(212, 175, 55, 0.5);
    box-shadow: 0 12px 48px rgba(212, 175, 55, 0.15);
}

.pdp-lang-option {
    background: none;
    border: none;
    color: #71717a;
    font-size: 0.875rem;
    font-weight: 500;
    letter-spacing: 0.05em;
    padding: 0.5rem 0.75rem;
    cursor: pointer;
    transition: all 0.3s;
    border-radius: 1rem;
    position: relative;
}

.pdp-lang-option:hover {
    color: #d4d4d8;
    background: rgba(255, 255, 255, 0.05);
}

.pdp-lang-option.active {
    color: #D4AF37;
    font-weight: 600;
    background: linear-gradient(135deg, rgba(212, 175, 55, 0.1), rgba(255, 215, 0, 0.05));
}

.pdp-lang-option.active::after {
    content: '';
    position: absolute;
    bottom: 0.25rem;
    left: 50%;
    transform: translateX(-50%);
    width: 1.25rem;
    height: 2px;
    background: linear-gradient(90deg, #D4AF37, #FFD700);
    border-radius: 2px;
    box-shadow: 0 0 8px rgba(212, 175, 55, 0.6);
}

.pdp-lang-divider {
    width: 1px;
    height: 1rem;
    background: rgba(113, 113, 122, 0.3);
    margin: 0 0.125rem;
}

/* Responsive Mobile */
@media (max-width: 768px) {
    .pdp-lang-selector {
        top: 1rem;
        right: 1rem;
        padding: 0.5rem 1rem;
    }
    
    .pdp-lang-option {
        font-size: 0.8125rem;
        padding: 0.375rem 0.5rem;
    }
}
    </style>

    
<!-- ‚≠ê LOADER CORRETTO (Sostituisci quello esistente prima del </head>) -->
<script>
document.write(`
<div id="cartLoader" style="position:fixed;top:0;left:0;width:100%;height:100%;background:linear-gradient(135deg, #09090b 0%, #18181b 50%, #09090b 100%);z-index:99999;display:flex;align-items:center;justify-content:center;transition:opacity 0.6s ease;">
    <div style="text-align:center;max-width:400px;padding:2rem;">
        <!-- Icona SVG invece di emoji problematico -->
        <svg width="60" height="60" viewBox="0 0 24 24" fill="none" stroke="#D4AF37" stroke-width="1.5" style="margin:0 auto 1.5rem;">
            <circle cx="9" cy="21" r="1"/>
            <circle cx="20" cy="21" r="1"/>
            <path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"/>
        </svg>
        
        <div style="font-size:1.25rem;color:#d4d4d8;margin-bottom:2rem;font-weight:300;">Caricamento Carrello</div>
        
        <div style="position:relative;height:4px;background:rgba(212,175,55,0.1);border-radius:10px;overflow:hidden;margin-bottom:1rem;">
            <div id="loaderBar" style="position:absolute;left:0;top:0;height:100%;width:0%;background:linear-gradient(90deg, #D4AF37, #FFD700);border-radius:10px;animation:fillBar 2.8s cubic-bezier(0.4, 0, 0.2, 1) forwards;"></div>
        </div>
        
        <div style="display:flex;gap:0.5rem;justify-content:center;margin-top:1.5rem;">
            <div style="width:8px;height:8px;background:#D4AF37;border-radius:50%;animation:pulse 1.5s ease-in-out infinite;"></div>
            <div style="width:8px;height:8px;background:#D4AF37;border-radius:50%;animation:pulse 1.5s ease-in-out 0.3s infinite;"></div>
            <div style="width:8px;height:8px;background:#D4AF37;border-radius:50%;animation:pulse 1.5s ease-in-out 0.6s infinite;"></div>
        </div>
    </div>
</div>

<style>
@keyframes fillBar {
    to { width: 100%; }
}
@keyframes pulse {
    0%, 100% { opacity: 0.3; transform: scale(0.8); }
    50% { opacity: 1; transform: scale(1.2); }
}
</style>
`);
</script>
</head>
<body>
    <!-- Selettore Lingua Premium -->
<div class="pdp-lang-selector" id="pdpLanguageSelector">
    <button class="pdp-lang-option active" data-lang="it">IT</button>
    <span class="pdp-lang-divider"></span>
    <button class="pdp-lang-option" data-lang="en">EN</button>
    <span class="pdp-lang-divider"></span>
    <button class="pdp-lang-option" data-lang="fr">FR</button>
    <span class="pdp-lang-divider"></span>
    <button class="pdp-lang-option" data-lang="de">DE</button>
    <span class="pdp-lang-divider"></span>
    <button class="pdp-lang-option" data-lang="es">ES</button>
</div>
    
    <div class="container">
        <div class="cart-header">
    <h1 class="cart-title" data-i18n="cart_title">Il Tuo Carrello</h1>
    <p class="cart-subtitle" id="itemCount" data-i18n="cart_items_count_zero">0 Articoli</p>
</div>

        <div class="cart-layout">
            <div class="cart-items" id="cartItems">
                </div>

            <div class="cart-summary">
    <h2 class="summary-title" data-i18n="cart_summary_title">Riepilogo Ordine</h2>

    <div class="progress-section">
        <div class="progress-text">
            <span data-i18n="cart_summary_shipping_progress">Spedizione gratuita a</span>
            <span class="progress-highlight">‚Ç¨ 150</span>
        </div>
        <div class="progress-bar">
            <div class="progress-fill" id="progressFill" style="width: 0%;"></div>
        </div>
    </div>

    <div class="summary-row">
        <span class="summary-label" data-i18n="cart_summary_subtotal">Subtotale</span>
        <span class="summary-value" id="subtotal">‚Ç¨ 0,00</span>
    </div>
    <div class="summary-row">
        <span class="summary-label" data-i18n="cart_summary_shipping">Spedizione</span>
        <span class="summary-value" id="shipping">‚Ç¨ 15,00</span>
    </div>
    <div class="summary-row" id="discountRow">
        <span class="summary-label">
           <span data-i18n="cart_summary_discount">Sconto</span>
           <span class="combo-badge" id="comboBadge" style="display: none;" data-i18n="cart_combo_badge">COMBO</span>
        </span>
        <span class="summary-value" id="discount">- ‚Ç¨ 0,00</span>
    </div>

    <div class="promo-code">
       <label class="promo-label" data-i18n="cart_coupon_label">Codice Promozionale</label>
       <div class="promo-input-wrapper">
           <input type="text" class="promo-input" id="couponInput" data-i18n-placeholder="cart_coupon_placeholder" placeholder="Inserisci codice">
           <button class="promo-apply" id="applyCouponBtn" data-i18n="cart_coupon_apply_btn">Applica</button>
       </div>
       <div class="promo-message" id="couponMessage"></div>
    </div>

    <div class="summary-row summary-total">
        <span class="summary-label" data-i18n="cart_summary_total">Totale</span>
        <span class="summary-value" id="total">‚Ç¨ 0,00</span>
    </div>

    <button type="button" class="checkout-btn" id="checkoutBtn" data-i18n="cart_checkout_btn">Procedi al Checkout</button>

    <div class="trust-badges">
        <div class="trust-badge">
            <span class="trust-icon">üîí</span>
            <span data-i18n="cart_trust_secure">Pagamenti sicuri e protetti</span>
        </div>
        <div class="trust-badge">
            <span class="trust-icon">‚Üª</span>
            <span data-i18n="cart_trust_return">Reso gratuito entro 30 giorni</span>
        </div>
        <div class="trust-badge">
            <span class="trust-icon">‚úî</span>
            <span data-i18n="cart_trust_guarantee">Garanzia soddisfatti o rimborsati</span>
        </div>
    </div>
</div>
        </div>

        <div class="recommended-section">
    <h2 class="recommended-title" data-i18n="cart_recommended_title">Potrebbero interessarti anche</h2>
    <div class="recommended-grid" id="recommendedGrid">
        <div id="recommendedLoader" style="grid-column: 1/-1; text-align: center; padding: 4rem 2rem;">
            <div style="display: inline-block; margin-bottom: 1.5rem;">
                <svg width="50" height="50" viewBox="0 0 50 50" style="animation: spin 1s linear infinite;">
                    <circle cx="25" cy="25" r="20" fill="none" stroke="#D4AF37" stroke-width="3" stroke-dasharray="80, 200" stroke-linecap="round"/>
                </svg>
            </div>
            <div style="font-size: 1.125rem; color: #d4d4d8; font-weight: 300; margin-bottom: 0.5rem; letter-spacing: -0.01em;" data-i18n="cart_recommended_loading">
                Selezioniamo i migliori prodotti per te
            </div>
            <div style="font-size: 0.875rem; color: #71717a;" data-i18n="cart_recommended_loading_sub">
                In base ai tuoi gusti e agli articoli nel carrello
            </div>
        </div>
    </div>
</div>

<style>
@keyframes spin {
    to { transform: rotate(360deg); }
}
</style>
        </div>
    </div>

    <!-- Connection Monitor Script -->
    <script src="../connection-monitor.js"></script>

    <!-- ‚≠ê SCRIPT PRINCIPALE CORRETTO (Sostituisci l'intero <script> dopo il body) -->
<script>
    let cart = JSON.parse(localStorage.getItem('lh360_cart')) || [];
    const webAppUrl = 'https://script.google.com/macros/s/AKfycbwr79RkXIEocpuOKaM6uMJqE6VFs9wjlUPvrr__FvDbDDrD2ELB1NbfrWP3BCYpHj2u/exec';
    let appliedCoupon = null;

    // === FUNZIONI TRACKING COUPON (invariate) ===
    function getUserId() {
        let userId = localStorage.getItem('lh360_user_id');
        if (!userId) {
            userId = 'USER_' + Date.now() + '_' + Math.random().toString(36).substring(2, 15);
            localStorage.setItem('lh360_user_id', userId);
        }
        return userId;
    }

    function hasCouponBeenUsed(couponCode) {
        const usedCoupons = JSON.parse(localStorage.getItem('lh360_used_coupons') || '{}');
        const userId = getUserId();
        return usedCoupons[userId]?.includes(couponCode.toUpperCase());
    }

    function markCouponAsUsed(couponCode) {
        const usedCoupons = JSON.parse(localStorage.getItem('lh360_used_coupons') || '{}');
        const userId = getUserId();
        if (!usedCoupons[userId]) usedCoupons[userId] = [];
        if (!usedCoupons[userId].includes(couponCode.toUpperCase())) {
            usedCoupons[userId].push(couponCode.toUpperCase());
            localStorage.setItem('lh360_used_coupons', JSON.stringify(usedCoupons));
        }
    }

    // === RENDERING CARRELLO ===
    function renderCart() {
        const cartItemsContainer = document.getElementById('cartItems');
        cartItemsContainer.innerHTML = '';
        
        if (cart.length === 0) {
            checkEmptyCart();
        } else {
            cart.forEach((item, index) => {
                let variantHTML = '';
if (item.color || item.size) {
    const variantParts = [];
    if (item.color) variantParts.push(item.color);
    if (item.size) variantParts.push(`Taglia ${item.size}`);
    const variantText = variantParts.join(' ¬∑ '); // Middot Unicode: U+00B7
    
    variantHTML = '<div class="item-variant">';
    if (item.color) {
        const colorMap = {
            'Nero': '#000000', 'Bianco': '#FFFFFF', 'Grigio': '#808080',
            'Blu': '#0000FF', 'Rosso': '#FF0000', 'Verde': '#008000',
            'Giallo': '#FFFF00', 'Viola': '#800080', 'Arancione': '#FFA500',
            'Marrone': '#A52A2A', 'Oro': '#FFD700', 'Argento': '#C0C0C0',
            'Beige': '#F5F5DC', 'Rosa': '#FFC0CB', 'Celeste': '#87CEEB',
            'Black': '#000000', 'White': '#FFFFFF', 'Grey': '#808080',
            'Blue': '#0000FF', 'Red': '#FF0000'
        };
        const cssColor = colorMap[item.color] || item.color;
        const isLight = ['#FFFFFF', 'white', '#F5F5DC', 'beige'].includes(cssColor.toLowerCase());
        const borderStyle = isLight ? 'border: 1px solid rgba(255,255,255,0.3);' : '';
        variantHTML += `<div class="variant-detail"><span class="color-dot" style="background-color: ${cssColor}; ${borderStyle}"></span><span>${variantText}</span></div>`;
    } else {
        variantHTML += `<div class="variant-detail"><span>${variantText}</span></div>`;
    }
    variantHTML += '</div>';
}
                
                const finalPrice = (item.discountPrice && item.discountPrice < item.price) ? item.discountPrice : item.price;
                const hasDiscount = item.discountPrice && item.discountPrice < item.price;
                
                const itemElement = document.createElement('div');
                itemElement.className = 'cart-item';
                itemElement.dataset.id = index;
                itemElement.innerHTML = `
                    <div class="item-image">
                        <img src="${item.image || 'https://via.placeholder.com/140x186?text=' + encodeURIComponent(item.title)}" alt="${item.title}">
                    </div>
                    <div class="item-details">
                        <div class="item-name">${item.title}</div>
                        ${variantHTML}
                        <div class="item-actions">
                            <button class="remove-btn" onclick="removeItem(${index})">Rimuovi</button>
                        </div>
                    </div>
                    <div class="item-price-section">
                        ${hasDiscount ? `<div class="item-original-price">‚Ç¨ ${item.price.toFixed(2).replace('.', ',')}</div>` : ''}
                        <div class="item-price">‚Ç¨ ${finalPrice.toFixed(2).replace('.', ',')}</div>
                    </div>
                `;
                cartItemsContainer.appendChild(itemElement);
            });
        }
        updateSummaryImmediate(); // ‚úÖ Update immediato UI
    }

    /**
 * ‚úÖ Ripristina coupon salvato (OTTIMIZZATO - evita calcoli multipli)
 */
async function restoreAppliedCoupon() {
  const savedCoupon = localStorage.getItem('lh360_applied_coupon');
  
  if (!savedCoupon) return; // ‚≠ê Se non c'√® coupon, esci subito

  try {
    const couponData = JSON.parse(savedCoupon);
    const { code, discountPercent } = couponData;

    if (!code || !discountPercent) {
      localStorage.removeItem('lh360_applied_coupon');
      return;
    }

    // ‚úÖ Valida coupon con backend
    const response = await fetch(`${webAppUrl}?action=validate_coupon&code=${encodeURIComponent(code)}&t=${Date.now()}`);
    const result = await response.json();

    if (result.success && result.valid) {
      // ‚úÖ Ripristina coupon PRIMA di chiamare updateSummary
      appliedCoupon = { 
        code: code, 
        discountPercent: discountPercent,
        appliedAt: Date.now()
      };
      
      document.getElementById('couponInput').value = code;
      
      // ‚úÖ SINGOLA chiamata diretta a updateSummaryWithCoupon
      // (updateSummaryImmediate √® gi√† stato chiamato da renderCart)
      await updateSummaryWithCoupon();
      
      // ‚úÖ Mostra messaggio ripristino
      showCouponMessage(
        `Coupon "${code}" ripristinato con successo ¬∑ Sconto attivo: ${discountPercent}%`, 
        'success'
      );
      
    } else {
      // ‚ùå Coupon non valido/utilizzato
      localStorage.removeItem('lh360_applied_coupon');
      appliedCoupon = null;
      
      const errorMsg = (result.error && result.error.includes('utilizzato')) 
        ? `Il coupon "${code}" √® stato utilizzato in un ordine precedente` 
        : `Il coupon "${code}" non √® pi√π valido o √® scaduto`;
      
      showCouponMessage(errorMsg, 'error');
      
      // Ricalcola senza coupon
      await updateSummary();
    }
  } catch (error) {
    console.error('‚ùå Errore recupero coupon:', error);
    localStorage.removeItem('lh360_applied_coupon');
    appliedCoupon = null;
  }
}

    // ‚≠ê FIX PROBLEMA 2: Rimozione immediata senza setTimeout
    function removeItem(index) {
    const itemElement = document.querySelector(`[data-id="${index}"]`);
    if (!itemElement) return;
    
    // ‚úÖ RIMOZIONE IMMEDIATA dal carrello
    cart.splice(index, 1);
    localStorage.setItem('lh360_cart', JSON.stringify(cart));
    
    // ‚úÖ AGGIORNAMENTO IMMEDIATO UI
    updateSummaryImmediate();
    
    // ‚úÖ Animazione fade out PARALLELA (non blocca aggiornamento)
    itemElement.style.transition = 'opacity 0.2s, transform 0.2s';
    itemElement.style.opacity = '0';
    itemElement.style.transform = 'translateX(-1rem)';
    
    // Rimuovi elemento DOM e ri-renderizza dopo animazione
    setTimeout(async () => {
        renderCart();
        await updateSummary(); // ‚úÖ AGGIUNTO: Completa il calcolo sconti
    }, 200);
}

   async function updateSummary() {
    let subtotal = 0;
    let itemCount = 0;
    
    cart.forEach(item => {
        const finalPrice = (item.discountPrice && item.discountPrice < item.price) ? item.discountPrice : item.price;
        subtotal += finalPrice * (item.qty || 1);
        itemCount += (item.qty || 1);
    });

    // Verifica sconti combo
    let discount = 0;
    let isComboDiscount = false;

    try {
        const skuList = cart.map(item => item.sku).join(',');
        const response = await fetch(`${webAppUrl}?action=check_combo&skus=${encodeURIComponent(skuList)}&t=${Date.now()}`);
        const result = await response.json();

        if (result.success && result.comboDiscount > 0) {
            discount = result.comboDiscount;
            isComboDiscount = true;
        }
    } catch (error) {
        console.error('Errore verifica combo:', error);
    }

    // Considera coupon se applicato
    if (appliedCoupon) {
        const couponDiscount = (subtotal * appliedCoupon.discountPercent) / 100;
        discount += couponDiscount;
    }

    // Calcola spedizione
    const totalAfterDiscounts = subtotal - discount;
    const shipping = totalAfterDiscounts >= 150 ? 0 : 15;
    const total = subtotal + shipping - discount;

    // Aggiorna UI con prezzi formattati
    const i18n = window.i18nPDP();
    if (i18n) {
        document.getElementById('subtotal').textContent = i18n.formatPrice(subtotal);
        document.getElementById('shipping').textContent = shipping === 0 
            ? i18n.t('cart_summary_shipping_free') 
            : i18n.formatPrice(shipping);
        document.getElementById('total').textContent = i18n.formatPrice(total);
        
        // Aggiorna conteggio articoli
        const itemCountText = itemCount === 1 
            ? i18n.t('cart_items_count_one') 
            : i18n.t('cart_items_count_many', { n: itemCount });
        document.getElementById('itemCount').textContent = itemCountText;
    }
    
    showDiscountValue(discount, isComboDiscount);

    const progress = Math.min(100, (totalAfterDiscounts / 150) * 100);
    document.getElementById('progressFill').style.width = `${progress}%`;
}

    /**
 * ‚úÖ AGGIORNAMENTO IMMEDIATO UI (senza chiamate async)
 * Calcola e mostra istantaneamente: subtotale, articoli, barra progresso
 */
function updateSummaryImmediate() {
    let subtotal = 0;
    let itemCount = 0;
    
    cart.forEach(item => {
        const finalPrice = (item.discountPrice && item.discountPrice < item.price) 
            ? item.discountPrice 
            : item.price;
        subtotal += finalPrice * (item.qty || 1);
        itemCount += (item.qty || 1);
    });

    const shipping = subtotal >= 150 ? 0 : 15;
    
    let couponDiscount = 0;
    if (appliedCoupon) {
        couponDiscount = (subtotal * appliedCoupon.discountPercent) / 100;
    }
    
    const totalWithCoupon = subtotal + shipping - couponDiscount;

    document.getElementById('subtotal').textContent = `‚Ç¨ ${subtotal.toFixed(2).replace('.', ',')}`;
    document.getElementById('shipping').textContent = shipping === 0 ? 'Gratuita' : `‚Ç¨ ${shipping.toFixed(2).replace('.', ',')}`;
    document.getElementById('total').textContent = `‚Ç¨ ${totalWithCoupon.toFixed(2).replace('.', ',')}`;
    document.getElementById('itemCount').textContent = itemCount === 1 ? '1 Articolo' : `${itemCount} Articoli`;

    const progress = Math.min(100, (subtotal / 150) * 100);
    document.getElementById('progressFill').style.width = `${progress}%`;
    
    if (cart.length > 0) {
        showDiscountCalculating(); // ‚úÖ Ora nasconde anche il badge
    } else {
        showDiscountValue(0); // ‚úÖ Nasconde tutto se carrello vuoto
    }
}

 /**
 * ‚úÖ Mostra indicatore "Calcolo..." per sconti in elaborazione
 */
function showDiscountCalculating() {
    const discountEl = document.getElementById('discount');
    const discountRow = document.getElementById('discountRow');
    const comboBadge = document.getElementById('comboBadge');
    
    // ‚úÖ NASCONDI SEMPRE il badge durante il calcolo
    if (comboBadge) {
        comboBadge.style.display = 'none';
    }
    
    discountEl.innerHTML = `
        <span class="discount-calculating">
            <span class="discount-calculating-text">Calcolo...</span>
        </span>
    `;
    discountRow.classList.add('discount-active');
}

/**
 * ‚úÖ Mostra valore sconto finale (o nasconde se zero)
 */
function showDiscountValue(totalDiscount, isCombo = false) {
    const discountEl = document.getElementById('discount');
    const discountRow = document.getElementById('discountRow');
    const comboBadge = document.getElementById('comboBadge');
    
    if (totalDiscount > 0) {
        discountEl.innerHTML = `- ‚Ç¨ ${totalDiscount.toFixed(2).replace('.', ',')}`;
        discountRow.classList.add('discount-active');
        
        // ‚úÖ Mostra badge COMBO solo se isCombo √® true
        if (comboBadge) {
            comboBadge.style.display = isCombo ? 'inline-block' : 'none';
        }
    } else {
        discountEl.textContent = '- ‚Ç¨ 0,00';
        discountRow.classList.remove('discount-active');
        if (comboBadge) comboBadge.style.display = 'none';
    }
}

    function checkEmptyCart() {
    document.querySelector('.cart-layout').style.gridTemplateColumns = '1fr';
    const i18n = window.i18nPDP();
    
    document.getElementById('cartItems').innerHTML = `
        <div class="empty-cart">
            <div class="empty-cart-icon">${i18n.t('cart_empty_icon')}</div>
            <h2>${i18n.t('cart_empty_title')}</h2>
            <p>${i18n.t('cart_empty_subtitle')}</p>
            <a href="/luxhaven360-site/index.html#shop" class="btn-continue">${i18n.t('cart_empty_cta')}</a>
        </div>
    `;
    document.querySelector('.cart-summary').style.display = 'none';
}

    /**
 * ‚úÖ Inizializza carrello con sequenza ottimizzata
 * Evita calcoli multipli durante il ripristino coupon
 */
async function initializeCart() {
  // 1. Rendering DOM
  renderCart(); 
  
  // 2. Ripristina coupon (se presente) e calcola sconti
  await restoreAppliedCoupon();
  
  // 3. Se NON c'era coupon da ripristinare, calcola normalmente
  if (!appliedCoupon) {
    await updateSummary();
  }
  
  // 4. Carica prodotti consigliati
  loadRecommendedProducts();
}

// ‚úÖ Avvia inizializzazione
initializeCart();

/**
 * Carica prodotti consigliati basati sulla categoria del carrello
 */
async function loadRecommendedProducts() {
    // Mostra loader (se esiste gi√† nel DOM, altrimenti skip)
const loader = document.getElementById('recommendedLoader');
    try {
        const container = document.getElementById('recommendedGrid');
        if (!container) return;
        
        // Determina categoria prevalente nel carrello
        const categories = cart.map(item => {
            const skuPrefix = item.sku ? item.sku.split('-')[0] : 'ME';
            return { 'PR': 'properties', 'SC': 'supercars', 'EX': 'stays', 'ME': 'shop' }[skuPrefix] || 'shop';
        });
        
        const categoryCount = categories.reduce((acc, cat) => {
            acc[cat] = (acc[cat] || 0) + 1;
            return acc;
        }, {});
        
        const targetCategory = Object.keys(categoryCount).sort((a, b) => categoryCount[b] - categoryCount[a])[0] || 'shop';
        
        // Fetch prodotti dalla stessa categoria
        const response = await fetch(`${webAppUrl}?action=get_products&category=${targetCategory}&t=${Date.now()}`);
        const result = await response.json();
        
        if (!result.success || !result.products || result.products.length === 0) {
            container.innerHTML = '<p style="text-align:center;color:#71717a;">Nessun prodotto correlato disponibile</p>';
            return;
        }
        
        // Escludi prodotti gi√† nel carrello
        const cartSkus = cart.map(item => item.sku);
        let availableProducts = result.products.filter(p => !cartSkus.includes(p.sku));
        
        // Se dopo il filtro non rimangono prodotti, mostra comunque quelli del carrello
        if (availableProducts.length === 0) {
            availableProducts = result.products;
        }
        
        // Seleziona 4 prodotti casuali
        const shuffled = availableProducts.sort(() => 0.5 - Math.random());
        const selected = shuffled.slice(0, 4);
        
        // Genera HTML
        container.innerHTML = selected.map((product, index) => {
    const isFeatured = index === 0;
    const featuredClass = isFeatured ? ' featured' : '';
    const badgeHtml = isFeatured ? '<div class="recommended-badge">‚ú¶ Consigliato</div>' : '';
    
    // ‚úÖ Tronca descrizione a max 60 caratteri
    const shortDesc = (product.desc || '').length > 60 
        ? product.desc.substring(0, 60) + '...' 
        : product.desc || '';
    
    // ‚úÖ NUOVO: Logica Sconto
    const hasDiscount = product.discountPrice && product.discountPrice < product.price;
    const originalPrice = parseFloat(product.price) || 0;
    const finalPrice = hasDiscount ? parseFloat(product.discountPrice) : originalPrice;
    const discountPercent = hasDiscount ? Math.round(((originalPrice - finalPrice) / originalPrice) * 100) : 0;
    
    // ‚úÖ HTML Prezzo con Sconto
    const priceHtml = hasDiscount 
        ? `
            <div style="display: flex; flex-direction: column; gap: 0.35rem; align-items: flex-start;">
                <div style="font-size: 0.75rem; color: #71717a; text-decoration: line-through; font-weight: 300;">
                    ‚Ç¨ ${originalPrice.toLocaleString('it-IT', {minimumFractionDigits: 2})}
                </div>
                <div style="display: flex; align-items: center; gap: 0.5rem;">
                    <span style="font-size: 1.125rem; font-weight: 700; background: linear-gradient(135deg, #D4AF37, #FFD700); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;">
                        ‚Ç¨ ${finalPrice.toLocaleString('it-IT', {minimumFractionDigits: 2})}
                    </span>
                    <span style="display: inline-block; background: linear-gradient(135deg, #D4AF37, #FFD700); color: #09090b; padding: 0.2rem 0.5rem; border-radius: 1rem; font-size: 0.65rem; font-weight: 700; letter-spacing: 0.05em; box-shadow: 0 2px 8px rgba(212, 175, 55, 0.3);">
                        -${discountPercent}%
                    </span>
                </div>
            </div>
        `
        : `<div class="recommended-price">‚Ç¨ ${finalPrice.toLocaleString('it-IT', {minimumFractionDigits: 2})}</div>`;
    
    return `
        <a href="pdp-products.html?sku=${product.sku}" 
           class="recommended-item${featuredClass}" 
           style="text-decoration: none; color: inherit; display: block;">
            ${badgeHtml}
            <div class="recommended-image">
                <img src="${product.icon || 'https://via.placeholder.com/300x400?text=No+Image'}" 
                     alt="${product.title}" 
                     style="width:100%;height:100%;object-fit:cover;" />
            </div>
            <div class="recommended-name">${product.title}</div>
            <div class="recommended-desc">${shortDesc}</div>
            ${priceHtml}
        </a>
    `;
}).join('');

        // Nascondi loader dopo aver popolato i prodotti
if (loader) {
    loader.style.display = 'none';
}
        
    } catch (error) {
        console.error('Errore caricamento prodotti consigliati:', error);
        // Nascondi loader anche in caso di errore
const loader = document.getElementById('recommendedLoader');
if (loader) {
    loader.style.display = 'none';
}
    }
}

    /* --- CHECKOUT (invariato) --- */
    async function initiateCheckout(e) {
    if (e) e.preventDefault();
    const btn = document.getElementById('checkoutBtn');
    if (!btn || btn.disabled) return;
    
    const freshCart = JSON.parse(localStorage.getItem('lh360_cart')) || [];
    const validItems = freshCart.filter(item => item && item.title && item.price);
    if (validItems.length === 0) { alert('Il carrello √® vuoto!'); return; }

    const originalText = btn.innerText;
    btn.innerText = 'Connessione sicura...';
    btn.style.opacity = '0.7';
    btn.disabled = true;

    // 1. Calcola subtotale (con prezzi finali dei prodotti, gi√† scontati se hanno discountPrice)
    let subtotal = 0;
    validItems.forEach(item => {
        const finalPrice = (item.discountPrice && item.discountPrice < item.price) ? item.discountPrice : item.price;
        subtotal += finalPrice * (item.qty || 1);
    });

    // 2. Calcola sconti aggiuntivi (combo + coupon)
    let comboDiscount = 0;
    try {
        const skuList = validItems.map(item => item.sku).join(',');
        const response = await fetch(`${webAppUrl}?action=check_combo&skus=${encodeURIComponent(skuList)}&t=${Date.now()}`);
        const result = await response.json();
        if (result.success && result.comboDiscount > 0) comboDiscount = result.comboDiscount;
    } catch (error) { console.error('Errore verifica combo:', error); }

    let couponDiscount = 0;
    if (appliedCoupon) {
        couponDiscount = (subtotal * appliedCoupon.discountPercent) / 100;
    }

    const totalDiscount = comboDiscount + couponDiscount;

    // 3. Calcola totale finale e spedizione
    const totalAfterDiscounts = subtotal - totalDiscount;
    const shipping = totalAfterDiscounts >= 150 ? 0 : 15;

    // ‚≠ê NUOVO: Salva dati sconti per success.html
localStorage.setItem('lh360_applied_discounts', JSON.stringify({
    comboDiscount: comboDiscount,
    couponDiscount: couponDiscount,
    couponCode: appliedCoupon ? appliedCoupon.code : null,
    isComboActive: comboDiscount > 0,
    totalDiscount: totalDiscount,
    timestamp: Date.now()
}));

    // 4. Costruisci payload per Stripe (con sconto applicato proporzionalmente ai prodotti)
    const data = {
    cart: validItems.map(item => {
       const finalPrice = (item.discountPrice && item.discountPrice < item.price) ? item.discountPrice : item.price;
       
       // Applica sconto proporzionale al prezzo del singolo item
       let adjustedPrice = finalPrice;
       if (totalDiscount > 0 && subtotal > 0) {
           const itemSubtotal = finalPrice * (item.qty || 1);
           const discountRatio = itemSubtotal / subtotal;
           const itemDiscount = totalDiscount * discountRatio;
           adjustedPrice = finalPrice - (itemDiscount / (item.qty || 1));
           adjustedPrice = Math.max(0.50, adjustedPrice);
       }
       
       // ‚≠ê COSTRUZIONE DESCRIZIONE STRUTTURATA
       let structuredDesc = item.title;
       const variantParts = [];
       if (item.color) variantParts.push(item.color);
       if (item.size) variantParts.push(item.size);
       if (variantParts.length > 0) {
           structuredDesc += ' | ' + variantParts.join(' - ');
       }
       
       return {
           sku: item.sku || '',
           title: item.title,
           description: structuredDesc,  // ‚≠ê AGGIUNTO
           price: adjustedPrice,
           qty: item.qty || 1,
           color: item.color || '',
           size: item.size || '',
           currency: item.currency || 'EUR',
           image: item.image || ''
         };
    }),
            shipping: shipping,
            is_buy_now: false,
            cancel_url: window.location.href,
            checkout_metadata: {  // ‚úÖ AGGIUNGI QUESTO BLOCCO
              used_coupon: appliedCoupon ? appliedCoupon.code : ''
            }
     };

    try {
        const dataStr = encodeURIComponent(JSON.stringify(data));
        const callbackName = 'handleCheckoutResponse';
        const targetUrl = `${webAppUrl}?action=create_checkout_session&data=${dataStr}&callback=${callbackName}&t=${Date.now()}`;
        
        const response = await fetch(targetUrl, { method: 'GET', mode: 'cors', headers: { 'Content-Type': 'text/plain' }});
        if (!response.ok) throw new Error('Errore di rete Google');
        const textResponse = await response.text();
        const jsonString = textResponse.substring(textResponse.indexOf('(') + 1, textResponse.lastIndexOf(')'));
        const result = JSON.parse(jsonString);
        if (result.error) throw new Error(result.error);
else if (result.url) { 
  // ‚úÖ AGGIUNGI QUESTE RIGHE PRIMA DEL REDIRECT
  if (appliedCoupon) {
    markCouponAsUsed(appliedCoupon.code);
  }
  
  localStorage.removeItem('lh360_applied_coupon');
  btn.innerText = 'Reindirizzamento...'; 
  window.location.assign(result.url); 
}
        else throw new Error('Risposta non valida dal server');
    } catch (err) {
        console.error(err);
        alert("Impossibile avviare il pagamento: " + err.message);
        btn.innerText = originalText;
        btn.style.opacity = '1';
        btn.disabled = false;
    }
}

    const checkoutBtn = document.getElementById('checkoutBtn');
    if (checkoutBtn) checkoutBtn.onclick = initiateCheckout;

   // ‚úÖ Converti automaticamente input coupon in maiuscolo
document.getElementById('couponInput').addEventListener('input', function(e) {
  const cursorPosition = e.target.selectionStart; // Salva posizione cursore
  e.target.value = e.target.value.toUpperCase();
  e.target.setSelectionRange(cursorPosition, cursorPosition); // Ripristina cursore
});

// Evento applicazione coupon
document.getElementById('applyCouponBtn').addEventListener('click', async function() {
  const couponCode = document.getElementById('couponInput').value.trim().toUpperCase();
  const btn = this;
  const i18n = window.i18nPDP();

  if (!couponCode) { 
    showCouponMessage('cart_coupon_enter_valid', 'warning'); 
    return; 
  }

  if (appliedCoupon && appliedCoupon.code === couponCode) {
    showCouponMessage('cart_coupon_already_applied', 'success', { code: couponCode });
    
    setTimeout(() => {
      showCouponMessage('cart_coupon_restored', 'success', { 
        code: couponCode, 
        percent: appliedCoupon.discountPercent 
      });
    }, 3000);
    return;
  }
  
  if (appliedCoupon) {
    appliedCoupon = null;
    localStorage.removeItem('lh360_applied_coupon');
    updateSummaryImmediate();
    await updateSummaryWithCoupon();
  }

  btn.disabled = true;
  btn.textContent = i18n.t('cart_checkout_processing');
  showCouponMessage('cart_coupon_calculating', 'warning');

  try {
    const response = await fetch(`${webAppUrl}?action=validate_coupon&code=${encodeURIComponent(couponCode)}&t=${Date.now()}`);
    const result = await response.json();
    
    if (result.success && result.valid) {
      btn.textContent = i18n.t('cart_coupon_apply_btn');
      
      appliedCoupon = { 
        code: couponCode, 
        discountPercent: result.discountPercent,
        appliedAt: Date.now()
      };
      
      localStorage.setItem('lh360_applied_coupon', JSON.stringify(appliedCoupon));
      
      showDiscountCalculating();
      await updateSummaryWithCoupon();
      await new Promise(resolve => setTimeout(resolve, 400));
      
      showCouponMessage('cart_coupon_success', 'success', {
        code: couponCode,
        percent: result.discountPercent
      });
      
    } else {
      let errorKey = 'cart_coupon_invalid';
      
      if (result.error) {
        if (result.error.includes('scaduto')) {
          errorKey = 'cart_coupon_expired';
        } else if (result.error.includes('utilizzato')) {
          errorKey = 'cart_coupon_used';
        } else if (result.error.includes('non riconosciuto')) {
          errorKey = 'cart_coupon_not_found';
        }
      }
      
      showCouponMessage(errorKey, 'error', { code: couponCode });
      appliedCoupon = null;
      localStorage.removeItem('lh360_applied_coupon');
    }
  } catch (error) {
    console.error('Errore validazione coupon:', error);
    showCouponMessage('cart_coupon_connection_error', 'error');
    appliedCoupon = null;
    localStorage.removeItem('lh360_applied_coupon');
  } finally {
    btn.disabled = false;
    btn.textContent = i18n.t('cart_coupon_apply_btn');
  }
});

    /**
 * ‚úÖ Mostra messaggi coupon con design premium
 * @param {string} message - Testo del messaggio
 * @param {string} type - 'success' | 'error' | 'warning'
 */
function showCouponMessage(messageKey, type, replacements = {}) {
    const messageEl = document.getElementById('couponMessage');
    const i18n = window.i18nPDP();
    
    if (messageEl._hideTimeout) {
        clearTimeout(messageEl._hideTimeout);
    }
    
    const message = i18n ? i18n.t(messageKey, replacements) : messageKey;
    
    messageEl.textContent = message;
    messageEl.className = `promo-message ${type}`;
    messageEl.style.display = 'block';
    
    const hideDelay = type === 'success' ? 6000 : 8000;
    
    messageEl._hideTimeout = setTimeout(() => {
        messageEl.style.opacity = '0';
        messageEl.style.transform = 'translateY(-0.5rem)';
        messageEl.style.transition = 'opacity 0.3s, transform 0.3s';
        
        setTimeout(() => {
            messageEl.style.display = 'none';
            messageEl.style.opacity = '1';
            messageEl.style.transform = 'translateY(0)';
        }, 300);
    }, hideDelay);
}

    async function updateSummaryWithCoupon() {    
    let subtotal = 0;
    let itemCount = 0;
    
    cart.forEach(item => {
        const finalPrice = (item.discountPrice && item.discountPrice < item.price) 
            ? item.discountPrice 
            : item.price;
        subtotal += finalPrice * (item.qty || 1);
        itemCount += (item.qty || 1);
    });

    let discount = 0;
    let isComboDiscount = false;
    
    // Verifica sconti combo dal backend
    try {
        const skuList = cart.map(item => item.sku).join(',');
        const response = await fetch(`${webAppUrl}?action=check_combo&skus=${encodeURIComponent(skuList)}&t=${Date.now()}`);
        const result = await response.json();
        
        if (result.success && result.comboDiscount > 0) {
            discount = result.comboDiscount;
            isComboDiscount = true;
        }
    } catch (error) { 
        console.error('Errore verifica combo:', error); 
    }

    // Aggiungi sconto coupon se presente
    if (appliedCoupon) {
        const couponDiscount = (subtotal * appliedCoupon.discountPercent) / 100;
        discount += couponDiscount;
    }

    // Calcola totali finali
    const totalAfterDiscounts = subtotal - discount;
    const shipping = totalAfterDiscounts >= 150 ? 0 : 15;
    const total = subtotal + shipping - discount;

    // Aggiorna UI
    document.getElementById('subtotal').textContent = `‚Ç¨ ${subtotal.toFixed(2).replace('.', ',')}`;
    document.getElementById('shipping').textContent = shipping === 0 ? 'Gratuita' : `‚Ç¨ ${shipping.toFixed(2).replace('.', ',')}`;
    document.getElementById('total').textContent = `‚Ç¨ ${total.toFixed(2).replace('.', ',')}`;
    document.getElementById('itemCount').textContent = itemCount === 1 ? '1 Articolo' : `${itemCount} Articoli`;
    
    // Aggiorna barra progresso
    const progress = Math.min(100, (totalAfterDiscounts / 150) * 100);
    document.getElementById('progressFill').style.width = `${progress}%`;
    
    // ‚úÖ Mostra valore sconto finale (nasconde indicatore)
    showDiscountValue(discount, isComboDiscount);
}

    // ‚≠ê FIX PROBLEMA 3: Nascondi loader dopo 3 secondi (ridotto da 4)
    window.addEventListener('DOMContentLoaded', () => {
        setTimeout(() => {
            const loader = document.getElementById('cartLoader');
            if (loader) {
                loader.style.opacity = '0';
                setTimeout(() => loader.remove(), 600);
            }
        }, 4200); // ‚≠ê Ridotto per caricamento pi√π veloce
    });

    // FIX: Ripristina stato bottone checkout quando si torna indietro
window.addEventListener('pageshow', function(event) {
    if (event.persisted) {
        const checkoutBtn = document.getElementById('checkoutBtn');
        if (checkoutBtn) {
            checkoutBtn.disabled = false;
            checkoutBtn.textContent = 'Procedi al Checkout';
            checkoutBtn.style.opacity = '1';
        }
    }
});

    /**
 * Aggiorna tutti i prezzi con la nuova lingua/valuta
 */
function updateAllPricesForLanguage() {
    const i18n = window.i18nPDP();
    if (!i18n) return;
    
    // In cart.html: aggiorna summary
    if (typeof updateSummary === 'function') {
        updateSummary();
    }
    
    // In pdp-products.html: aggiorna prezzo prodotto
    if (currentProduct && currentProduct.price) {
        const priceContainer = document.getElementById('productPrice');
        if (priceContainer) {
            if (currentProduct.discountPrice && currentProduct.discountPrice < currentProduct.price) {
                const discountPercent = Math.round(((currentProduct.price - currentProduct.discountPrice) / currentProduct.price) * 100);
                
                priceContainer.innerHTML = `
                    <div class="price-container">
                        <div class="price-original">${i18n.formatPrice(currentProduct.price, currentProduct.currency || 'EUR')}</div>
                        <div class="price-row">
                            <div class="price-discounted">${i18n.formatPrice(currentProduct.discountPrice, currentProduct.currency || 'EUR')}</div>
                            <span class="discount-badge">-${discountPercent}%</span>
                        </div>
                    </div>
                `;
            } else {
                priceContainer.innerHTML = `<div class="price">${i18n.formatPrice(currentProduct.price, currentProduct.currency || 'EUR')}</div>`;
            }
        }
    }
    
    // Aggiorna prezzi nelle card (se presenti)
    document.querySelectorAll('.card').forEach(card => {
        const originalPrice = parseFloat(card.dataset.originalPrice);
        const originalCurrency = card.dataset.originalCurrency || 'EUR';
        
        if (!originalPrice) return;
        
        const discountPrice = parseFloat(card.dataset.discountPrice);
        const hasDiscount = discountPrice && discountPrice < originalPrice;
        
        if (hasDiscount) {
            const originalPriceEl = card.querySelector('div[style*="text-decoration: line-through"]');
            if (originalPriceEl) {
                originalPriceEl.textContent = i18n.formatPrice(originalPrice, originalCurrency);
            }
            
            const discountedPriceEl = card.querySelector('div[style*="background-clip: text"]');
            if (discountedPriceEl && discountedPriceEl.parentElement.style.display === 'flex') {
                discountedPriceEl.textContent = i18n.formatPrice(discountPrice, originalCurrency);
            }
        } else {
            const priceElement = card.querySelector('.card-price');
            if (priceElement) {
                priceElement.textContent = i18n.formatPrice(originalPrice, originalCurrency);
            }
        }
    });
}
    // Ascolta cambio lingua da altre pagine
window.addEventListener('storage', (event) => {
    if (event.key === 'lh360_lang' && event.newValue) {
        const i18n = window.i18nPDP();
        if (i18n && i18n.currentLang !== event.newValue) {
            i18n.changeLanguage(event.newValue);
        }
    }
});
    
</script>
</body>
</html>
