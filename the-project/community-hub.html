<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<meta name="robots" content="noindex, nofollow"/>
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate"/>
<title>Community Hub — LuxHaven360</title>

<script>
// Anti-bypass: nasconde il contenuto principale finché l'autenticazione non è verificata
// NOTA: non usare document.write — #mainApp è già display:none nel CSS,
//       e viene mostrato solo quando si aggiunge la classe .active via JS.
(function() {
  try {
    var session = localStorage.getItem('lh360_community_session');
    if (!session) {
      // Senza sessione: nessuna azione necessaria, #mainApp è già hidden via CSS
      // Aggiungiamo solo un marker sul body per eventuali stili condizionali
      document.documentElement.classList.add('no-session');
    }
  } catch(e) {}
})();
</script>
<noscript><meta http-equiv="refresh" content="0; url=../the-project/community.html"/></noscript>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,300;0,400;0,500;0,600;1,300;1,400&family=Raleway:wght@300;400;500;600;700&display=swap" rel="stylesheet">

<style>
/* ═══════════════════════════════════════════════
   RESET & ROOT
═══════════════════════════════════════════════ */
*, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }
ul, ol { list-style: none; }
a { text-decoration: none; color: inherit; }
button { cursor: pointer; border: none; background: none; }
img { display: block; max-width: 100%; }
input, textarea { outline: none; border: none; background: none; }
::-webkit-scrollbar { width: 4px; height: 4px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: rgba(212,175,55,0.25); border-radius: 2px; }
::-webkit-scrollbar-thumb:hover { background: rgba(212,175,55,0.5); }

:root {
  --gold: #D4AF37;
  --gold-light: #E8CC6A;
  --gold-dim: rgba(212,175,55,0.45);
  --gold-faint: rgba(212,175,55,0.07);
  --gold-subtle: rgba(212,175,55,0.12);
  --dark: #0A0A0A;
  --darker: #050505;
  --dark2: #0F0F0F;
  --dark3: #141414;
  --dark4: #1A1A1A;
  --dark5: #202020;
  --light: #F5F5F5;
  --muted: rgba(245,245,245,0.45);
  --muted2: rgba(245,245,245,0.25);
  --muted3: rgba(245,245,245,0.12);
  --border: rgba(212,175,55,0.1);
  --border2: rgba(245,245,245,0.06);
  --green: #4CAF78;
  --green-dim: rgba(76,175,120,0.2);
  --amber: #E8A030;
  --red: #C8506A;
  --red-dim: rgba(200,80,106,0.2);
  --blue: #5B8ED4;
  --sidebar-w: 240px;
  --header-h: 58px;
  --right-w: 260px;
  --ff-display: 'Cormorant Garamond', Georgia, serif;
  --ff-ui: 'Raleway', sans-serif;
  --radius: 8px;
  --radius-lg: 14px;
  --shadow: 0 8px 32px rgba(0,0,0,0.6);
  --shadow-sm: 0 2px 12px rgba(0,0,0,0.4);
  --transition: all 0.22s cubic-bezier(0.4, 0, 0.2, 1);
}

html { height: 100%; }
body {
  font-family: var(--ff-ui);
  background: var(--darker);
  color: var(--light);
  height: 100%;
  overflow: hidden;
  -webkit-font-smoothing: antialiased;
}

/* ═══════════════════════════════════════════════
   LOGIN GATE
═══════════════════════════════════════════════ */
#loginGate {
  position: fixed; inset: 0; z-index: 9999;
  background: var(--darker);
  display: flex; align-items: center; justify-content: center;
  overflow: auto;
}

.login-bg {
  position: absolute; inset: 0;
  background:
    radial-gradient(ellipse 60% 50% at 20% 30%, rgba(212,175,55,0.06) 0%, transparent 60%),
    radial-gradient(ellipse 40% 60% at 80% 70%, rgba(212,175,55,0.04) 0%, transparent 60%);
  pointer-events: none;
}

.login-grid {
  position: absolute; inset: 0;
  background-image:
    linear-gradient(rgba(212,175,55,0.03) 1px, transparent 1px),
    linear-gradient(90deg, rgba(212,175,55,0.03) 1px, transparent 1px);
  background-size: 60px 60px;
  pointer-events: none;
}

.login-card {
  position: relative; z-index: 1;
  width: 420px; max-width: 95vw;
  background: var(--dark3);
  border: 1px solid var(--border);
  border-radius: var(--radius-lg);
  padding: 2.5rem 2.5rem 2rem;
  box-shadow: 0 32px 80px rgba(0,0,0,0.8), 0 0 0 1px rgba(212,175,55,0.05);
  animation: loginReveal 0.6s ease forwards;
}

@keyframes loginReveal {
  from { opacity: 0; transform: translateY(24px); }
  to { opacity: 1; transform: translateY(0); }
}

.login-logo {
  text-align: center; margin-bottom: 2rem;
}
.login-logo-mark {
  display: inline-flex; align-items: center; justify-content: center;
  width: 52px; height: 52px;
  border: 1.5px solid var(--gold-dim);
  border-radius: 50%;
  margin-bottom: 1rem;
  position: relative;
}
.login-logo-mark::before {
  content: '';
  position: absolute; inset: 4px;
  border: 1px solid rgba(212,175,55,0.2);
  border-radius: 50%;
}
.login-logo-mark svg { color: var(--gold); }
.login-brand {
  font-family: var(--ff-display);
  font-size: 1.6rem; font-weight: 400;
  letter-spacing: 0.06em;
  color: var(--gold);
}
.login-subtitle {
  font-size: 0.68rem; letter-spacing: 0.2em;
  text-transform: uppercase;
  color: var(--muted); margin-top: 0.2rem;
}

.login-title {
  font-family: var(--ff-display);
  font-size: 1.3rem; font-weight: 400;
  color: var(--light); margin-bottom: 0.4rem;
  text-align: center;
}
.login-desc {
  font-size: 0.75rem; color: var(--muted);
  text-align: center; line-height: 1.6;
  margin-bottom: 1.8rem;
}

.login-field { margin-bottom: 1rem; }
.login-label {
  display: block; font-size: 0.65rem;
  letter-spacing: 0.15em; text-transform: uppercase;
  color: var(--muted); margin-bottom: 0.45rem;
}
.login-input {
  width: 100%; padding: 0.7rem 1rem;
  background: var(--dark5);
  border: 1px solid var(--border2);
  border-radius: var(--radius);
  color: var(--light); font-family: var(--ff-ui);
  font-size: 0.85rem;
  transition: var(--transition);
}
.login-input:focus {
  border-color: var(--gold-dim);
  background: var(--dark4);
  box-shadow: 0 0 0 3px rgba(212,175,55,0.07);
}
.login-input::placeholder { color: var(--muted2); }

.login-btn {
  width: 100%; padding: 0.8rem;
  background: linear-gradient(135deg, #C9A227, #D4AF37, #C9A227);
  background-size: 200% 200%;
  border-radius: var(--radius);
  color: var(--darker); font-family: var(--ff-ui);
  font-size: 0.78rem; font-weight: 700;
  letter-spacing: 0.15em; text-transform: uppercase;
  margin-top: 1.4rem;
  transition: var(--transition);
  animation: goldShift 4s ease infinite;
}
@keyframes goldShift {
  0%, 100% { background-position: 0% 50%; }
  50% { background-position: 100% 50%; }
}
.login-btn:hover { transform: translateY(-1px); box-shadow: 0 8px 24px rgba(212,175,55,0.25); }
.login-btn:active { transform: translateY(0); }

.login-error {
  display: none; margin-top: 0.8rem;
  padding: 0.6rem 0.8rem;
  background: var(--red-dim);
  border: 1px solid rgba(200,80,106,0.3);
  border-radius: var(--radius);
  font-size: 0.75rem; color: #E8A0AF; text-align: center;
}
.login-error.show { display: block; }

.login-demo {
  margin-top: 1.5rem;
  padding-top: 1.2rem;
  border-top: 1px solid var(--border2);
}
.login-demo-title {
  font-size: 0.62rem; letter-spacing: 0.15em;
  text-transform: uppercase; color: var(--muted2);
  text-align: center; margin-bottom: 0.7rem;
}
.login-demo-accounts {
  display: flex; flex-direction: column; gap: 0.4rem;
}
.demo-account {
  display: flex; align-items: center; justify-content: space-between;
  padding: 0.5rem 0.7rem;
  background: var(--dark5);
  border: 1px solid var(--border2);
  border-radius: 6px;
  cursor: pointer; transition: var(--transition);
  font-size: 0.72rem;
}
.demo-account:hover { border-color: var(--gold-dim); background: var(--dark4); }
.demo-role {
  font-size: 0.65rem; letter-spacing: 0.08em;
  text-transform: uppercase; color: var(--muted);
}
.demo-role.team { color: var(--gold); }
.demo-role.member { color: var(--green); }
.demo-role.candidate { color: var(--amber); }
.demo-credentials { color: var(--muted2); font-size: 0.68rem; }

/* ═══════════════════════════════════════════════
   MAIN APP LAYOUT
═══════════════════════════════════════════════ */
#mainApp {
  display: none;
  height: 100vh;
  overflow: hidden;
}
#mainApp.active {
  display: grid;
  grid-template-columns: var(--sidebar-w) 1fr var(--right-w);
  grid-template-rows: var(--header-h) 1fr;
  grid-template-areas:
    "sidebar header right"
    "sidebar content right";
}

/* ═══════════════════════════════════════════════
   SIDEBAR
═══════════════════════════════════════════════ */
#sidebar {
  grid-area: sidebar;
  background: var(--dark2);
  border-right: 1px solid var(--border);
  display: flex; flex-direction: column;
  height: 100vh; overflow: hidden;
  position: relative;
}

.sidebar-logo {
  padding: 1.2rem 1.4rem;
  border-bottom: 1px solid var(--border);
  display: flex; align-items: center; gap: 0.7rem;
}
.sidebar-logo-mark {
  width: 30px; height: 30px;
  border: 1px solid var(--gold-dim);
  border-radius: 50%;
  display: flex; align-items: center; justify-content: center;
  flex-shrink: 0;
}
.sidebar-logo-mark svg { width: 14px; height: 14px; color: var(--gold); }
.sidebar-logo-text { font-family: var(--ff-display); font-size: 1.05rem; color: var(--gold); font-weight: 400; letter-spacing: 0.04em; }
.sidebar-logo-sub { font-size: 0.6rem; letter-spacing: 0.18em; text-transform: uppercase; color: var(--muted2); margin-top: -1px; }

.sidebar-section-label {
  font-size: 0.58rem; letter-spacing: 0.2em; text-transform: uppercase;
  color: var(--muted2); padding: 1.2rem 1.4rem 0.4rem;
}

.sidebar-nav { flex: 1; overflow-y: auto; padding: 0.4rem 0.6rem 1rem; }

.nav-item {
  display: flex; align-items: center; gap: 0.65rem;
  padding: 0.6rem 0.8rem;
  border-radius: 7px;
  font-size: 0.78rem; font-weight: 400;
  color: var(--muted);
  cursor: pointer; transition: var(--transition);
  margin-bottom: 1px;
  position: relative;
}
.nav-item:hover { background: var(--gold-faint); color: var(--light); }
.nav-item.active {
  background: rgba(212,175,55,0.1);
  color: var(--gold);
}
.nav-item.active .nav-icon { color: var(--gold); }
.nav-icon { width: 16px; height: 16px; flex-shrink: 0; opacity: 0.7; transition: var(--transition); }
.nav-item:hover .nav-icon, .nav-item.active .nav-icon { opacity: 1; }
.nav-badge {
  margin-left: auto;
  background: var(--red);
  color: white; font-size: 0.6rem; font-weight: 700;
  padding: 1px 5px; border-radius: 10px;
  min-width: 18px; text-align: center;
}
.nav-badge.gold { background: var(--gold); color: var(--darker); }
.nav-dot {
  margin-left: auto;
  width: 6px; height: 6px; border-radius: 50%;
  background: var(--green);
}
.nav-separator { height: 1px; background: var(--border2); margin: 0.6rem 0.8rem; }

/* admin-only: nascosto per tutti i ruoli non-team */
.admin-only { display: none !important; }
.role-team .admin-only { display: block !important; }
.role-team .nav-item.admin-only { display: flex !important; }
.role-team .nav-separator.admin-only { display: block !important; }
.role-team .sidebar-section-label.admin-only { display: block !important; }

.nav-item.member-plus { display: none; }
.role-team .nav-item.member-plus,
.role-founding .nav-item.member-plus { display: flex; }

.sidebar-user {
  border-top: 1px solid var(--border);
  padding: 0.9rem 1.2rem;
  display: flex; align-items: center; gap: 0.7rem;
  cursor: pointer; transition: var(--transition);
}
.sidebar-user:hover { background: var(--gold-faint); }
.user-avatar-sm {
  width: 32px; height: 32px; border-radius: 50%;
  background: linear-gradient(135deg, #1A1A1A, #2A2A2A);
  border: 1.5px solid var(--gold-dim);
  display: flex; align-items: center; justify-content: center;
  font-family: var(--ff-display); font-size: 0.9rem; color: var(--gold);
  flex-shrink: 0; position: relative;
}
.status-dot {
  position: absolute; bottom: -1px; right: -1px;
  width: 9px; height: 9px; border-radius: 50%;
  background: var(--green);
  border: 2px solid var(--dark2);
}
.user-info-sm { min-width: 0; }
.user-name-sm { font-size: 0.78rem; font-weight: 500; color: var(--light); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.user-role-sm { font-size: 0.62rem; letter-spacing: 0.1em; text-transform: uppercase; color: var(--muted); margin-top: 1px; }
.user-role-sm.gold { color: var(--gold); }
.user-role-sm.green { color: var(--green); }
.user-role-sm.amber { color: var(--amber); }
.user-chevron { margin-left: auto; opacity: 0.3; }

/* ═══════════════════════════════════════════════
   HEADER
═══════════════════════════════════════════════ */
#topHeader {
  grid-area: header;
  background: var(--dark2);
  border-bottom: 1px solid var(--border);
  display: flex; align-items: center;
  padding: 0 1.6rem;
  gap: 1rem;
  position: sticky; top: 0; z-index: 100;
}

.header-title {
  font-family: var(--ff-display);
  font-size: 1.3rem; font-weight: 400;
  color: var(--light); flex: 1;
}
.header-subtitle {
  font-size: 0.65rem; letter-spacing: 0.12em;
  text-transform: uppercase; color: var(--muted);
  margin-top: 1px;
}

.header-search {
  display: flex; align-items: center; gap: 0.5rem;
  background: var(--dark5); border: 1px solid var(--border2);
  border-radius: var(--radius); padding: 0.4rem 0.9rem;
  width: 220px; transition: var(--transition);
}
.header-search:focus-within {
  border-color: var(--gold-dim);
  box-shadow: 0 0 0 3px rgba(212,175,55,0.06);
}
.header-search svg { color: var(--muted2); width: 14px; height: 14px; flex-shrink: 0; }
.header-search input {
  color: var(--light); font-family: var(--ff-ui);
  font-size: 0.78rem; flex: 1; min-width: 0;
}
.header-search input::placeholder { color: var(--muted2); }

.header-actions { display: flex; align-items: center; gap: 0.5rem; }
.header-btn {
  width: 36px; height: 36px;
  display: flex; align-items: center; justify-content: center;
  border-radius: 8px; transition: var(--transition);
  color: var(--muted); position: relative;
}
.header-btn:hover { background: var(--gold-faint); color: var(--gold); }
.header-btn svg { width: 17px; height: 17px; }
.notif-count {
  position: absolute; top: 4px; right: 4px;
  width: 16px; height: 16px;
  background: var(--red); border-radius: 50%;
  font-size: 0.58rem; font-weight: 700; color: white;
  display: flex; align-items: center; justify-content: center;
  border: 1.5px solid var(--dark2);
}
.notif-count.hidden { display: none; }

.level-badge {
  display: flex; align-items: center; gap: 0.5rem;
  padding: 0.3rem 0.8rem;
  border-radius: 20px;
  font-size: 0.65rem; font-weight: 600;
  letter-spacing: 0.1em; text-transform: uppercase;
}
.level-badge.team { background: rgba(212,175,55,0.12); color: var(--gold); border: 1px solid rgba(212,175,55,0.3); }
.level-badge.founding { background: rgba(76,175,120,0.1); color: var(--green); border: 1px solid rgba(76,175,120,0.25); }
.level-badge.candidate { background: rgba(232,160,48,0.1); color: var(--amber); border: 1px solid rgba(232,160,48,0.25); }
.level-badge-dot { width: 6px; height: 6px; border-radius: 50%; background: currentColor; }

/* ═══════════════════════════════════════════════
   MAIN CONTENT
═══════════════════════════════════════════════ */
#mainContent {
  grid-area: content;
  overflow-y: auto;
  background: var(--darker);
  position: relative;
}

.panel { display: none; animation: panelFade 0.25s ease; }
.panel.active { display: block; }
@keyframes panelFade {
  from { opacity: 0; transform: translateY(8px); }
  to { opacity: 1; transform: translateY(0); }
}

.panel-inner { padding: 1.6rem; }

.section-header {
  display: flex; align-items: flex-start;
  justify-content: space-between; margin-bottom: 1.4rem;
  gap: 1rem;
}
.section-title {
  font-family: var(--ff-display);
  font-size: 1.5rem; font-weight: 400; color: var(--light);
}
.section-desc {
  font-size: 0.75rem; color: var(--muted); margin-top: 0.2rem; line-height: 1.5;
}

/* ═══════════════════════════════════════════════
   RIGHT PANEL
═══════════════════════════════════════════════ */
#rightPanel {
  grid-area: right;
  background: var(--dark2);
  border-left: 1px solid var(--border);
  overflow-y: auto;
  padding: 1rem;
  display: flex; flex-direction: column; gap: 1rem;
}

.rp-section { margin-bottom: 0.3rem; }
.rp-title {
  font-size: 0.62rem; letter-spacing: 0.18em;
  text-transform: uppercase; color: var(--muted2);
  margin-bottom: 0.7rem;
}
.online-member {
  display: flex; align-items: center; gap: 0.6rem;
  padding: 0.45rem 0.4rem;
  border-radius: 7px;
  cursor: pointer; transition: var(--transition);
  margin-bottom: 2px;
}
.online-member:hover { background: var(--gold-faint); }
.om-avatar {
  width: 28px; height: 28px; border-radius: 50%;
  display: flex; align-items: center; justify-content: center;
  font-family: var(--ff-display); font-size: 0.85rem; color: var(--gold);
  position: relative; flex-shrink: 0;
}
.om-status {
  position: absolute; bottom: -1px; right: -1px;
  width: 8px; height: 8px; border-radius: 50%;
  border: 2px solid var(--dark2);
}
.om-status.online { background: var(--green); }
.om-status.away { background: var(--amber); }
.om-status.offline { background: var(--muted2); }
.om-name { font-size: 0.75rem; color: var(--light); flex: 1; }
.om-role-tag { font-size: 0.58rem; letter-spacing: 0.1em; text-transform: uppercase; color: var(--muted2); }
.om-role-tag.gold { color: var(--gold); }

.rp-divider { height: 1px; background: var(--border2); margin: 0.6rem 0; }

.event-card-sm {
  background: var(--dark4);
  border: 1px solid var(--border2);
  border-radius: 8px;
  padding: 0.75rem;
  margin-bottom: 0.5rem;
}
.event-date-sm { font-size: 0.62rem; color: var(--gold); letter-spacing: 0.1em; text-transform: uppercase; margin-bottom: 0.2rem; }
.event-title-sm { font-size: 0.78rem; color: var(--light); font-weight: 500; line-height: 1.4; }
.event-meta-sm { font-size: 0.68rem; color: var(--muted); margin-top: 0.3rem; }

.live-indicator {
  display: inline-flex; align-items: center; gap: 0.35rem;
  font-size: 0.6rem; letter-spacing: 0.12em; text-transform: uppercase;
  color: var(--red); font-weight: 600;
  margin-bottom: 0.6rem;
}
.live-dot {
  width: 7px; height: 7px; border-radius: 50%;
  background: var(--red);
  animation: livePulse 1.5s ease infinite;
}
@keyframes livePulse {
  0%, 100% { opacity: 1; transform: scale(1); }
  50% { opacity: 0.5; transform: scale(0.8); }
}

/* ═══════════════════════════════════════════════
   CARDS & GRID
═══════════════════════════════════════════════ */
.grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }
.grid-3 { display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; }

.card {
  background: var(--dark3);
  border: 1px solid var(--border);
  border-radius: var(--radius-lg);
  padding: 1.3rem;
  transition: var(--transition);
}
.card:hover { border-color: rgba(212,175,55,0.2); }

.stat-card {
  background: var(--dark3);
  border: 1px solid var(--border);
  border-radius: var(--radius-lg);
  padding: 1.2rem 1.4rem;
}
.stat-label { font-size: 0.65rem; letter-spacing: 0.15em; text-transform: uppercase; color: var(--muted); margin-bottom: 0.5rem; }
.stat-value { font-family: var(--ff-display); font-size: 2rem; font-weight: 300; color: var(--light); line-height: 1; }
.stat-value .stat-unit { font-size: 0.9rem; color: var(--muted); }
.stat-change {
  font-size: 0.68rem; margin-top: 0.5rem;
  display: flex; align-items: center; gap: 0.3rem;
}
.stat-change.up { color: var(--green); }
.stat-change.neutral { color: var(--muted); }

@keyframes statPulse {
  0%, 100% { opacity: 0.4; }
  50% { opacity: 0.8; }
}

/* ═══════════════════════════════════════════════
   FEED
═══════════════════════════════════════════════ */
.feed-post {
  background: var(--dark3);
  border: 1px solid var(--border);
  border-radius: var(--radius-lg);
  margin-bottom: 1rem;
  overflow: hidden;
  transition: var(--transition);
}
.feed-post:hover { border-color: rgba(212,175,55,0.18); }

.post-header {
  display: flex; align-items: center; gap: 0.8rem;
  padding: 1rem 1.2rem 0.7rem;
}
.post-avatar {
  width: 36px; height: 36px; border-radius: 50%;
  display: flex; align-items: center; justify-content: center;
  font-family: var(--ff-display); font-size: 1rem;
  flex-shrink: 0;
}
.post-avatar.team-av { background: linear-gradient(135deg, #1A1510, #2A2010); border: 1.5px solid var(--gold-dim); color: var(--gold); }
.post-avatar.user-av { background: linear-gradient(135deg, #0F1A15, #152010); border: 1.5px solid rgba(76,175,120,0.4); color: var(--green); }
.post-author { font-size: 0.82rem; font-weight: 600; color: var(--light); }
.post-role { font-size: 0.62rem; letter-spacing: 0.1em; text-transform: uppercase; color: var(--muted); }
.post-time { margin-left: auto; font-size: 0.68rem; color: var(--muted2); }

.post-body { padding: 0 1.2rem 0.8rem; }
.post-type-tag {
  display: inline-flex; align-items: center; gap: 0.35rem;
  font-size: 0.6rem; letter-spacing: 0.1em; text-transform: uppercase;
  padding: 0.25rem 0.6rem; border-radius: 20px;
  margin-bottom: 0.6rem;
}
.post-type-tag.update { background: rgba(212,175,55,0.1); color: var(--gold); }
.post-type-tag.news { background: rgba(91,142,212,0.1); color: var(--blue); }
.post-type-tag.exclusive { background: rgba(76,175,120,0.1); color: var(--green); }
.post-type-tag.survey { background: rgba(232,160,48,0.1); color: var(--amber); }

.post-title { font-family: var(--ff-display); font-size: 1.05rem; color: var(--light); margin-bottom: 0.4rem; font-weight: 400; line-height: 1.4; }
.post-text { font-size: 0.8rem; color: rgba(245,245,245,0.7); line-height: 1.7; }
.post-image {
  width: 100%; height: 180px; object-fit: cover;
  background: linear-gradient(135deg, var(--dark4), var(--dark5));
  display: flex; align-items: center; justify-content: center;
  margin: 0.7rem 0;
  border-radius: 8px; overflow: hidden;
}
.post-img-placeholder {
  font-size: 0.7rem; letter-spacing: 0.12em; text-transform: uppercase;
  color: var(--muted2);
}
.post-locked {
  display: flex; align-items: center; gap: 0.5rem;
  padding: 0.7rem 1rem;
  background: rgba(212,175,55,0.05);
  border: 1px dashed rgba(212,175,55,0.2);
  border-radius: 7px; margin: 0.7rem 0;
  font-size: 0.75rem; color: var(--muted);
}
.post-locked svg { color: var(--gold-dim); width: 15px; height: 15px; flex-shrink: 0; }

.post-actions {
  display: flex; align-items: center; gap: 0.3rem;
  padding: 0.6rem 1.2rem;
  border-top: 1px solid var(--border2);
}
.post-action-btn {
  display: flex; align-items: center; gap: 0.4rem;
  padding: 0.35rem 0.7rem;
  border-radius: 6px;
  font-size: 0.72rem; color: var(--muted);
  transition: var(--transition);
}
.post-action-btn:hover { background: var(--gold-faint); color: var(--light); }
.post-action-btn.liked { color: var(--red); }
.post-action-btn svg { width: 14px; height: 14px; }
.post-separator { flex: 1; }
.reaction-bar {
  display: flex; align-items: center; gap: 0.3rem;
  padding: 0.35rem 1.2rem 0.35rem;
}
.reaction-item {
  display: flex; align-items: center; gap: 0.25rem;
  font-size: 0.72rem; color: var(--muted2);
}

/* Comments section */
.post-comments {
  border-top: 1px solid var(--border2);
  padding: 0.8rem 1.2rem;
  display: none;
}
.post-comments.open { display: block; }
.comment {
  display: flex; align-items: flex-start; gap: 0.6rem;
  margin-bottom: 0.7rem;
}
.comment-avatar {
  width: 26px; height: 26px; border-radius: 50%;
  flex-shrink: 0; display: flex; align-items: center; justify-content: center;
  font-size: 0.7rem; font-family: var(--ff-display);
  background: var(--dark5); border: 1px solid var(--border2); color: var(--muted);
}
.comment-bubble {
  background: var(--dark4); border: 1px solid var(--border2);
  border-radius: 8px; padding: 0.5rem 0.7rem;
  flex: 1;
}
.comment-author { font-size: 0.7rem; font-weight: 600; color: var(--light); margin-bottom: 0.2rem; }
.comment-text { font-size: 0.75rem; color: rgba(245,245,245,0.7); line-height: 1.5; }
.comment-time { font-size: 0.62rem; color: var(--muted2); margin-top: 0.2rem; }
.comment-input-row {
  display: flex; gap: 0.5rem; margin-top: 0.5rem;
}
.comment-input {
  flex: 1; background: var(--dark4); border: 1px solid var(--border2);
  border-radius: 20px; padding: 0.45rem 0.9rem;
  font-family: var(--ff-ui); font-size: 0.75rem; color: var(--light);
  transition: var(--transition);
}
.comment-input:focus { border-color: var(--gold-dim); }
.comment-input::placeholder { color: var(--muted2); }
.comment-send-btn {
  width: 32px; height: 32px; border-radius: 50%;
  background: var(--gold); display: flex; align-items: center; justify-content: center;
  flex-shrink: 0; transition: var(--transition);
}
.comment-send-btn:hover { background: var(--gold-light); }
.comment-send-btn svg { width: 13px; height: 13px; color: var(--darker); }

/* ═══════════════════════════════════════════════
   MESSAGES / DM
═══════════════════════════════════════════════ */
.messages-layout {
  display: grid;
  grid-template-columns: 260px 1fr;
  height: calc(100vh - var(--header-h) - 2rem);
  background: var(--dark3);
  border: 1px solid var(--border);
  border-radius: var(--radius-lg);
  overflow: hidden;
}
.conv-list { border-right: 1px solid var(--border2); overflow-y: auto; }
.conv-search {
  padding: 0.8rem;
  border-bottom: 1px solid var(--border2);
}
.conv-search-input {
  width: 100%; background: var(--dark5);
  border: 1px solid var(--border2); border-radius: 20px;
  padding: 0.4rem 0.8rem;
  font-family: var(--ff-ui); font-size: 0.75rem; color: var(--light);
}
.conv-search-input::placeholder { color: var(--muted2); }

.conv-item {
  display: flex; align-items: center; gap: 0.7rem;
  padding: 0.7rem 0.9rem;
  cursor: pointer; transition: var(--transition);
  border-bottom: 1px solid rgba(245,245,245,0.03);
  position: relative;
}
.conv-item:hover { background: var(--gold-faint); }
.conv-item.active { background: rgba(212,175,55,0.08); }
.conv-avatar {
  width: 36px; height: 36px; border-radius: 50%; flex-shrink: 0;
  display: flex; align-items: center; justify-content: center;
  font-family: var(--ff-display); font-size: 1rem;
  background: var(--dark5); border: 1.5px solid var(--border2);
  color: var(--muted); position: relative;
}
.conv-info { flex: 1; min-width: 0; }
.conv-name { font-size: 0.8rem; font-weight: 500; color: var(--light); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.conv-preview { font-size: 0.7rem; color: var(--muted2); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin-top: 1px; }
.conv-meta { text-align: right; flex-shrink: 0; }
.conv-time { font-size: 0.62rem; color: var(--muted2); }
.conv-unread {
  display: inline-flex; align-items: center; justify-content: center;
  width: 16px; height: 16px; border-radius: 50%;
  background: var(--gold); color: var(--darker);
  font-size: 0.58rem; font-weight: 700; margin-top: 2px;
}

.chat-area {
  display: flex; flex-direction: column; overflow: hidden;
}
.chat-header {
  padding: 0.8rem 1.2rem;
  border-bottom: 1px solid var(--border2);
  display: flex; align-items: center; gap: 0.7rem;
}
.chat-header-name { font-size: 0.85rem; font-weight: 500; color: var(--light); }
.chat-header-status { font-size: 0.68rem; color: var(--green); }
.chat-header-status.offline { color: var(--muted2); }
.chat-header-actions { margin-left: auto; display: flex; gap: 0.3rem; }

.chat-messages {
  flex: 1; overflow-y: auto;
  padding: 1rem 1.2rem;
  display: flex; flex-direction: column; gap: 0.6rem;
}
.chat-date-divider {
  text-align: center; font-size: 0.63rem;
  letter-spacing: 0.1em; text-transform: uppercase;
  color: var(--muted2); margin: 0.5rem 0;
  position: relative;
}
.chat-date-divider::before {
  content: ''; position: absolute;
  top: 50%; left: 0; right: 0;
  height: 1px; background: var(--border2);
  z-index: 0;
}
.chat-date-divider span { background: var(--dark3); padding: 0 0.8rem; position: relative; z-index: 1; }

.msg { display: flex; align-items: flex-end; gap: 0.5rem; }
.msg.sent { flex-direction: row-reverse; }
.msg-avatar { width: 24px; height: 24px; border-radius: 50%; flex-shrink: 0; display: flex; align-items: center; justify-content: center; font-family: var(--ff-display); font-size: 0.7rem; background: var(--dark5); border: 1px solid var(--border2); color: var(--muted); }
.msg-bubble {
  max-width: 65%; padding: 0.55rem 0.85rem;
  border-radius: 14px; font-size: 0.78rem; line-height: 1.5;
}
.msg.received .msg-bubble { background: var(--dark4); color: var(--light); border: 1px solid var(--border2); border-bottom-left-radius: 4px; }
.msg.sent .msg-bubble { background: rgba(212,175,55,0.12); color: var(--light); border: 1px solid rgba(212,175,55,0.2); border-bottom-right-radius: 4px; }
.msg-time { font-size: 0.6rem; color: var(--muted2); margin-top: 0.2rem; }
.msg.sent .msg-time { text-align: right; }

.chat-input-area {
  padding: 0.8rem 1.2rem;
  border-top: 1px solid var(--border2);
  display: flex; align-items: center; gap: 0.6rem;
}
.chat-input {
  flex: 1; background: var(--dark4);
  border: 1px solid var(--border2);
  border-radius: 22px;
  padding: 0.55rem 1rem;
  font-family: var(--ff-ui); font-size: 0.8rem; color: var(--light);
  resize: none; transition: var(--transition);
}
.chat-input:focus { border-color: var(--gold-dim); }
.chat-input::placeholder { color: var(--muted2); }
.chat-send-btn {
  width: 38px; height: 38px; border-radius: 50%;
  background: var(--gold); flex-shrink: 0;
  display: flex; align-items: center; justify-content: center;
  transition: var(--transition);
}
.chat-send-btn:hover { background: var(--gold-light); transform: scale(1.05); }
.chat-send-btn svg { width: 15px; height: 15px; color: var(--darker); }
.chat-actions { display: flex; gap: 0.3rem; }
.chat-action { width: 34px; height: 34px; border-radius: 8px; color: var(--muted); display: flex; align-items: center; justify-content: center; transition: var(--transition); }
.chat-action:hover { background: var(--gold-faint); color: var(--gold); }
.chat-action svg { width: 16px; height: 16px; }

/* ═══════════════════════════════════════════════
   NOTIFICATIONS
═══════════════════════════════════════════════ */
.notif-item {
  display: flex; align-items: flex-start; gap: 0.8rem;
  padding: 0.9rem 1.1rem;
  border: 1px solid var(--border);
  border-radius: var(--radius-lg);
  margin-bottom: 0.5rem;
  background: var(--dark3);
  cursor: pointer; transition: var(--transition);
  position: relative;
}
.notif-item:hover { border-color: rgba(212,175,55,0.18); }
.notif-item.unread { background: rgba(212,175,55,0.03); border-color: rgba(212,175,55,0.12); }
.notif-item.unread::before {
  content: ''; position: absolute;
  left: 0; top: 0; bottom: 0; width: 3px;
  background: var(--gold); border-radius: 3px 0 0 3px;
}
.notif-icon {
  width: 36px; height: 36px; border-radius: 50%;
  display: flex; align-items: center; justify-content: center;
  flex-shrink: 0;
}
.notif-icon.gold { background: rgba(212,175,55,0.12); color: var(--gold); }
.notif-icon.green { background: rgba(76,175,120,0.12); color: var(--green); }
.notif-icon.blue { background: rgba(91,142,212,0.12); color: var(--blue); }
.notif-icon.red { background: rgba(200,80,106,0.12); color: var(--red); }
.notif-icon svg { width: 16px; height: 16px; }
.notif-content { flex: 1; min-width: 0; }
.notif-text { font-size: 0.8rem; color: var(--light); line-height: 1.5; }
.notif-text strong { color: var(--gold); font-weight: 600; }
.notif-time { font-size: 0.65rem; color: var(--muted2); margin-top: 0.2rem; }
.notif-unread-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--gold); flex-shrink: 0; margin-top: 4px; }

/* ═══════════════════════════════════════════════
   LISTINGS
═══════════════════════════════════════════════ */
.listing-card {
  background: var(--dark3);
  border: 1px solid var(--border);
  border-radius: var(--radius-lg);
  overflow: hidden;
  transition: var(--transition);
  cursor: pointer;
}
.listing-card:hover { border-color: rgba(212,175,55,0.25); transform: translateY(-2px); box-shadow: 0 12px 40px rgba(0,0,0,0.5); }
.listing-img {
  height: 160px;
  background: linear-gradient(135deg, #0A1520, #0D1A10, #1A0D10);
  display: flex; align-items: center; justify-content: center;
  position: relative; overflow: hidden;
}
.listing-img::after {
  content: ''; position: absolute;
  inset: 0;
  background: linear-gradient(to top, rgba(0,0,0,0.6) 0%, transparent 60%);
}
.listing-img-text {
  font-family: var(--ff-display); font-size: 1.8rem;
  color: rgba(212,175,55,0.15); font-style: italic;
  letter-spacing: 0.08em;
}
.listing-exclusive-tag {
  position: absolute; top: 10px; right: 10px; z-index: 1;
  font-size: 0.58rem; letter-spacing: 0.14em; text-transform: uppercase;
  background: rgba(212,175,55,0.9); color: var(--darker);
  padding: 0.2rem 0.55rem; border-radius: 20px; font-weight: 700;
}
.listing-info { padding: 1rem 1.1rem; }
.listing-city { font-size: 0.62rem; letter-spacing: 0.15em; text-transform: uppercase; color: var(--gold); margin-bottom: 0.3rem; }
.listing-name { font-family: var(--ff-display); font-size: 1.1rem; color: var(--light); font-weight: 400; margin-bottom: 0.4rem; }
.listing-desc { font-size: 0.74rem; color: var(--muted); line-height: 1.6; }
.listing-footer {
  display: flex; align-items: center; justify-content: space-between;
  padding: 0.7rem 1.1rem;
  border-top: 1px solid var(--border2);
}
.listing-price { font-family: var(--ff-display); font-size: 1.05rem; color: var(--light); }
.listing-price-unit { font-size: 0.65rem; color: var(--muted); }
.listing-book-btn {
  font-size: 0.68rem; letter-spacing: 0.1em; text-transform: uppercase;
  font-weight: 600; padding: 0.4rem 0.9rem;
  background: rgba(212,175,55,0.1); color: var(--gold);
  border: 1px solid rgba(212,175,55,0.25); border-radius: 20px;
  transition: var(--transition);
}
.listing-book-btn:hover { background: var(--gold); color: var(--darker); }
.listing-locked-overlay {
  display: flex; align-items: center; gap: 0.4rem;
  font-size: 0.7rem; color: var(--muted);
}

/* ═══════════════════════════════════════════════
   ADMIN PANELS
═══════════════════════════════════════════════ */
.admin-table {
  width: 100%; border-collapse: collapse;
  font-size: 0.78rem;
}
.admin-table th {
  font-size: 0.62rem; letter-spacing: 0.14em; text-transform: uppercase;
  color: var(--muted2); font-weight: 600;
  padding: 0.6rem 1rem; text-align: left;
  border-bottom: 1px solid var(--border2);
}
.admin-table td {
  padding: 0.75rem 1rem;
  border-bottom: 1px solid rgba(245,245,245,0.03);
  color: var(--light);
  vertical-align: middle;
}
.admin-table tr:hover td { background: var(--gold-faint); }
.member-row-avatar {
  width: 30px; height: 30px; border-radius: 50%;
  display: inline-flex; align-items: center; justify-content: center;
  font-family: var(--ff-display); font-size: 0.9rem;
  background: var(--dark5); border: 1px solid var(--border2); color: var(--muted);
  margin-right: 0.5rem; vertical-align: middle;
}
.level-pill {
  display: inline-flex; align-items: center; gap: 0.25rem;
  padding: 0.2rem 0.6rem; border-radius: 20px;
  font-size: 0.62rem; font-weight: 600; letter-spacing: 0.08em;
}
.level-pill.founding { background: var(--green-dim); color: var(--green); }
.level-pill.candidate { background: rgba(232,160,48,0.12); color: var(--amber); }
.level-pill.team { background: rgba(212,175,55,0.12); color: var(--gold); }
.action-btn-sm {
  padding: 0.3rem 0.65rem; border-radius: 5px;
  font-size: 0.65rem; font-weight: 600; letter-spacing: 0.08em;
  transition: var(--transition); display: inline-flex; align-items: center; gap: 0.25rem;
}
.action-btn-sm.promote { background: rgba(76,175,120,0.1); color: var(--green); border: 1px solid rgba(76,175,120,0.2); }
.action-btn-sm.promote:hover { background: rgba(76,175,120,0.2); }
.action-btn-sm.message { background: rgba(212,175,55,0.1); color: var(--gold); border: 1px solid rgba(212,175,55,0.2); }
.action-btn-sm.message:hover { background: rgba(212,175,55,0.2); }
.action-btn-sm.warn { background: var(--red-dim); color: var(--red); border: 1px solid rgba(200,80,106,0.2); }
.action-btn-sm.warn:hover { background: rgba(200,80,106,0.25); }

/* Broadcast */
.broadcast-form { background: var(--dark3); border: 1px solid var(--border); border-radius: var(--radius-lg); padding: 1.4rem; }
.broadcast-target {
  display: flex; gap: 0.5rem; flex-wrap: wrap; margin-bottom: 1rem;
}
.target-chip {
  padding: 0.3rem 0.8rem; border-radius: 20px;
  font-size: 0.65rem; font-weight: 600; letter-spacing: 0.08em;
  cursor: pointer; transition: var(--transition);
  border: 1px solid var(--border2); color: var(--muted);
}
.target-chip:hover { border-color: var(--gold-dim); color: var(--gold); }
.target-chip.active { background: rgba(212,175,55,0.12); border-color: rgba(212,175,55,0.35); color: var(--gold); }

.form-group { margin-bottom: 1rem; }
.form-label { font-size: 0.65rem; letter-spacing: 0.15em; text-transform: uppercase; color: var(--muted); margin-bottom: 0.4rem; display: block; }
.form-input {
  width: 100%; background: var(--dark5);
  border: 1px solid var(--border2); border-radius: var(--radius);
  padding: 0.65rem 0.9rem;
  font-family: var(--ff-ui); font-size: 0.82rem; color: var(--light);
  transition: var(--transition);
}
.form-input:focus { border-color: var(--gold-dim); box-shadow: 0 0 0 3px rgba(212,175,55,0.06); }
.form-input::placeholder { color: var(--muted2); }
.form-textarea { min-height: 100px; resize: vertical; line-height: 1.6; }
.form-actions { display: flex; gap: 0.7rem; justify-content: flex-end; margin-top: 1.2rem; }
.btn-primary {
  padding: 0.65rem 1.4rem;
  background: var(--gold); color: var(--darker);
  border-radius: var(--radius); font-family: var(--ff-ui);
  font-size: 0.75rem; font-weight: 700; letter-spacing: 0.12em; text-transform: uppercase;
  transition: var(--transition);
}
.btn-primary:hover { background: var(--gold-light); transform: translateY(-1px); }
.btn-secondary {
  padding: 0.65rem 1.4rem;
  background: transparent; color: var(--muted);
  border: 1px solid var(--border2); border-radius: var(--radius);
  font-family: var(--ff-ui); font-size: 0.75rem; font-weight: 600;
  letter-spacing: 0.12em; text-transform: uppercase; transition: var(--transition);
}
.btn-secondary:hover { border-color: var(--gold-dim); color: var(--light); }

/* Discussions */
.discussion-thread {
  background: var(--dark3); border: 1px solid var(--border);
  border-radius: var(--radius-lg); margin-bottom: 0.7rem;
  overflow: hidden; cursor: pointer; transition: var(--transition);
}
.discussion-thread:hover { border-color: rgba(212,175,55,0.18); }
.thread-header {
  display: flex; align-items: center; gap: 0.8rem;
  padding: 1rem 1.2rem;
}
.thread-category {
  padding: 0.2rem 0.6rem; border-radius: 20px;
  font-size: 0.6rem; font-weight: 600; letter-spacing: 0.1em; text-transform: uppercase;
}
.thread-category.question { background: rgba(91,142,212,0.1); color: var(--blue); }
.thread-category.feedback { background: rgba(76,175,120,0.1); color: var(--green); }
.thread-category.idea { background: rgba(232,160,48,0.1); color: var(--amber); }
.thread-category.general { background: var(--gold-faint); color: var(--gold); }
.thread-title { font-size: 0.88rem; font-weight: 500; color: var(--light); flex: 1; }
.thread-meta { display: flex; align-items: center; gap: 1rem; font-size: 0.68rem; color: var(--muted2); }
.thread-stat { display: flex; align-items: center; gap: 0.3rem; }
.thread-stat svg { width: 13px; height: 13px; }
.thread-footer {
  display: flex; align-items: center; justify-content: space-between;
  padding: 0.5rem 1.2rem;
  border-top: 1px solid var(--border2);
  font-size: 0.7rem; color: var(--muted2);
}
.thread-last-reply { display: flex; align-items: center; gap: 0.4rem; }
.thread-pinned {
  display: flex; align-items: center; gap: 0.3rem;
  color: var(--gold); font-size: 0.62rem; font-weight: 600; letter-spacing: 0.1em;
}

/* Moderation */
.report-card {
  background: var(--dark3); border: 1px solid var(--border);
  border-radius: var(--radius-lg); padding: 1rem 1.2rem;
  margin-bottom: 0.5rem; transition: var(--transition);
}
.report-card:hover { border-color: rgba(200,80,106,0.2); }
.report-header { display: flex; align-items: center; gap: 0.7rem; margin-bottom: 0.6rem; }
.report-type {
  font-size: 0.6rem; letter-spacing: 0.12em; text-transform: uppercase;
  font-weight: 700; padding: 0.2rem 0.6rem; border-radius: 20px;
  background: var(--red-dim); color: var(--red);
}
.report-content { font-size: 0.78rem; color: var(--muted); line-height: 1.6; margin-bottom: 0.7rem; padding: 0.6rem 0.8rem; background: var(--dark5); border-radius: 6px; border-left: 3px solid rgba(200,80,106,0.3); }
.report-actions { display: flex; gap: 0.5rem; }
.mod-btn { padding: 0.35rem 0.8rem; border-radius: 6px; font-size: 0.68rem; font-weight: 600; letter-spacing: 0.08em; transition: var(--transition); }
.mod-btn.remove { background: var(--red-dim); color: var(--red); border: 1px solid rgba(200,80,106,0.2); }
.mod-btn.remove:hover { background: rgba(200,80,106,0.25); }
.mod-btn.dismiss { background: var(--green-dim); color: var(--green); border: 1px solid rgba(76,175,120,0.2); }
.mod-btn.dismiss:hover { background: rgba(76,175,120,0.25); }
.mod-btn.warn-user { background: rgba(232,160,48,0.1); color: var(--amber); border: 1px solid rgba(232,160,48,0.2); }
.mod-btn.warn-user:hover { background: rgba(232,160,48,0.2); }

/* Survey */
.survey-card {
  background: var(--dark3); border: 1px solid rgba(212,175,55,0.2);
  border-radius: var(--radius-lg); padding: 1.3rem;
  margin-bottom: 1rem;
}
.survey-title { font-family: var(--ff-display); font-size: 1.1rem; color: var(--light); margin-bottom: 0.4rem; }
.survey-desc { font-size: 0.75rem; color: var(--muted); margin-bottom: 1rem; line-height: 1.6; }
.survey-option {
  display: flex; align-items: center; gap: 0.8rem;
  padding: 0.6rem 0.8rem; border-radius: 7px;
  border: 1px solid var(--border2); margin-bottom: 0.4rem;
  cursor: pointer; transition: var(--transition); position: relative; overflow: hidden;
}
.survey-option:hover { border-color: var(--gold-dim); }
.survey-option.voted { border-color: var(--gold-dim); cursor: default; }
.survey-progress {
  position: absolute; top: 0; left: 0; height: 100%;
  background: rgba(212,175,55,0.06); transition: width 0.6s ease;
}
.survey-option-text { font-size: 0.8rem; color: var(--light); position: relative; z-index: 1; flex: 1; }
.survey-option-pct { font-size: 0.72rem; color: var(--muted); position: relative; z-index: 1; }
.survey-footer { display: flex; align-items: center; justify-content: space-between; margin-top: 0.8rem; font-size: 0.68rem; color: var(--muted2); }

/* Founder Profile */
.profile-hero {
  background: linear-gradient(135deg, var(--dark3) 0%, rgba(212,175,55,0.05) 100%);
  border: 1px solid var(--border);
  border-radius: var(--radius-lg);
  padding: 1.8rem;
  display: flex; align-items: flex-start; gap: 1.4rem;
  margin-bottom: 1.2rem;
}
.profile-avatar-lg {
  width: 72px; height: 72px; border-radius: 50%;
  background: linear-gradient(135deg, #1A1510, #2A2010);
  border: 2px solid var(--gold-dim);
  display: flex; align-items: center; justify-content: center;
  font-family: var(--ff-display); font-size: 1.8rem; color: var(--gold);
  flex-shrink: 0; position: relative;
}
.profile-avatar-lg .status-dot { width: 14px; height: 14px; border-width: 3px; }
.profile-name { font-family: var(--ff-display); font-size: 1.6rem; font-weight: 400; color: var(--light); margin-bottom: 0.2rem; }
.profile-membership { font-size: 0.68rem; letter-spacing: 0.15em; text-transform: uppercase; color: var(--muted); margin-bottom: 0.7rem; }
.profile-badges { display: flex; gap: 0.5rem; flex-wrap: wrap; }
.profile-badge {
  display: flex; align-items: center; gap: 0.35rem;
  padding: 0.3rem 0.7rem; border-radius: 20px;
  font-size: 0.63rem; font-weight: 600; letter-spacing: 0.08em;
}
.profile-badge.gold-badge { background: rgba(212,175,55,0.12); color: var(--gold); border: 1px solid rgba(212,175,55,0.25); }
.profile-badge.green-badge { background: var(--green-dim); color: var(--green); border: 1px solid rgba(76,175,120,0.25); }
.profile-stats-row { display: flex; gap: 2rem; margin-top: 0.8rem; }
.profile-stat-item .ps-value { font-family: var(--ff-display); font-size: 1.4rem; color: var(--light); }
.profile-stat-item .ps-label { font-size: 0.62rem; letter-spacing: 0.1em; text-transform: uppercase; color: var(--muted); }

/* Progress bar */
.progress-bar-wrap { background: var(--dark5); border-radius: 20px; height: 6px; margin: 0.4rem 0; overflow: hidden; }
.progress-bar-fill { height: 100%; border-radius: 20px; background: linear-gradient(90deg, #C9A227, #D4AF37); transition: width 1s ease; }

/* Toast notifications */
#toastContainer {
  position: fixed; bottom: 1.5rem; right: 1.5rem;
  z-index: 99999; display: flex; flex-direction: column; gap: 0.5rem;
}
.toast {
  display: flex; align-items: center; gap: 0.7rem;
  padding: 0.75rem 1rem;
  background: var(--dark3);
  border: 1px solid var(--border);
  border-radius: var(--radius-lg);
  box-shadow: var(--shadow);
  min-width: 280px; max-width: 360px;
  animation: toastIn 0.3s ease forwards;
  font-size: 0.78rem;
}
.toast.out { animation: toastOut 0.3s ease forwards; }
@keyframes toastIn { from { opacity: 0; transform: translateX(30px); } to { opacity: 1; transform: translateX(0); } }
@keyframes toastOut { from { opacity: 1; transform: translateX(0); } to { opacity: 0; transform: translateX(30px); } }
.toast-icon { width: 32px; height: 32px; border-radius: 50%; flex-shrink: 0; display: flex; align-items: center; justify-content: center; }
.toast-icon.gold { background: rgba(212,175,55,0.15); color: var(--gold); }
.toast-icon.green { background: rgba(76,175,120,0.15); color: var(--green); }
.toast-icon.red { background: rgba(200,80,106,0.15); color: var(--red); }
.toast-icon svg { width: 14px; height: 14px; }
.toast-text { flex: 1; color: var(--light); line-height: 1.4; }
.toast-close { color: var(--muted2); flex-shrink: 0; cursor: pointer; }
.toast-close:hover { color: var(--muted); }

/* Notification dropdown */
.notif-dropdown {
  position: absolute; top: calc(100% + 8px); right: 0;
  width: 320px;
  background: var(--dark3); border: 1px solid var(--border);
  border-radius: var(--radius-lg); box-shadow: var(--shadow);
  z-index: 1000; overflow: hidden;
  display: none;
}
.notif-dropdown.open { display: block; animation: panelFade 0.2s ease; }
.notif-dropdown-header {
  display: flex; align-items: center; justify-content: space-between;
  padding: 0.9rem 1.1rem;
  border-bottom: 1px solid var(--border2);
}
.notif-dropdown-title { font-size: 0.78rem; font-weight: 600; color: var(--light); }
.notif-mark-all { font-size: 0.68rem; color: var(--gold); cursor: pointer; }
.notif-mark-all:hover { color: var(--gold-light); }
.notif-dropdown-list { max-height: 340px; overflow-y: auto; }
.notif-dropdown-item {
  display: flex; align-items: flex-start; gap: 0.7rem;
  padding: 0.8rem 1.1rem;
  cursor: pointer; transition: var(--transition);
  border-bottom: 1px solid rgba(245,245,245,0.03);
}
.notif-dropdown-item:hover { background: var(--gold-faint); }
.notif-dropdown-item.unread { background: rgba(212,175,55,0.03); }
.ndi-icon { width: 32px; height: 32px; border-radius: 50%; flex-shrink: 0; display: flex; align-items: center; justify-content: center; font-size: 0.85rem; }
.ndi-text { font-size: 0.75rem; color: var(--muted); line-height: 1.5; flex: 1; }
.ndi-text strong { color: var(--light); }
.ndi-time { font-size: 0.62rem; color: var(--muted2); margin-top: 0.2rem; }
.ndi-unread { width: 7px; height: 7px; border-radius: 50%; background: var(--gold); flex-shrink: 0; margin-top: 5px; }

/* Notif empty states */
.notif-dropdown-empty {
  display: flex; align-items: center; gap: 0.6rem;
  padding: 1.2rem 1.1rem;
  color: var(--muted2); font-size: 0.75rem;
}
.notif-dropdown-empty svg { flex-shrink: 0; opacity: 0.5; }

.notif-empty-state {
  display: flex; flex-direction: column; align-items: center;
  padding: 3rem 2rem; text-align: center;
}
.notif-empty-icon {
  width: 56px; height: 56px;
  border-radius: 50%;
  background: var(--dark4);
  border: 1px solid var(--border);
  display: flex; align-items: center; justify-content: center;
  color: var(--muted2); margin-bottom: 1rem;
}
.notif-empty-title {
  font-family: var(--ff-display); font-size: 1rem; font-weight: 400;
  color: var(--light); margin-bottom: 0.5rem;
}
.notif-empty-desc {
  font-size: 0.75rem; color: var(--muted);
  line-height: 1.7; max-width: 340px;
}

/* Tabs */
.tab-row { display: flex; gap: 0.2rem; margin-bottom: 1.2rem; border-bottom: 1px solid var(--border2); }
.tab-btn {
  padding: 0.6rem 1rem; font-size: 0.75rem; font-weight: 500;
  color: var(--muted); cursor: pointer; transition: var(--transition);
  border-bottom: 2px solid transparent; margin-bottom: -1px;
}
.tab-btn:hover { color: var(--light); }
.tab-btn.active { color: var(--gold); border-bottom-color: var(--gold); }
.tab-content { display: none; }
.tab-content.active { display: block; }

/* Activity log */
.activity-item {
  display: flex; align-items: flex-start; gap: 0.7rem;
  padding: 0.5rem 0;
  border-bottom: 1px solid rgba(245,245,245,0.03);
  font-size: 0.75rem;
}
.activity-dot { width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0; margin-top: 5px; }
.activity-dot.gold { background: var(--gold); }
.activity-dot.green { background: var(--green); }
.activity-dot.blue { background: var(--blue); }
.activity-dot.red { background: var(--red); }
.activity-text { color: var(--muted); flex: 1; line-height: 1.5; }
.activity-text strong { color: var(--light); }
.activity-time { color: var(--muted2); flex-shrink: 0; }

/* Analytics chart placeholder */
.chart-placeholder {
  height: 160px; background: var(--dark5);
  border-radius: var(--radius); display: flex;
  align-items: flex-end; gap: 4px;
  padding: 1rem 1rem 0;
  overflow: hidden;
}
.chart-bar { flex: 1; background: rgba(212,175,55,0.2); border-radius: 3px 3px 0 0; min-height: 10px; position: relative; transition: var(--transition); }
.chart-bar:hover { background: rgba(212,175,55,0.45); }

/* Utilities */
.hidden { display: none !important; }
.flex { display: flex; }
.gap-1 { gap: 0.5rem; }
.items-center { align-items: center; }
.justify-between { justify-content: space-between; }
.mb-1 { margin-bottom: 0.5rem; }
.mb-2 { margin-bottom: 1rem; }
.text-gold { color: var(--gold); }
.text-muted { color: var(--muted); }
.text-green { color: var(--green); }
.text-amber { color: var(--amber); }
.text-sm { font-size: 0.75rem; }
.font-display { font-family: var(--ff-display); }
.locked-overlay {
  display: flex; flex-direction: column; align-items: center; justify-content: center;
  padding: 2.5rem 1.5rem; text-align: center; gap: 0.7rem;
  background: var(--dark3); border: 1px dashed rgba(212,175,55,0.2);
  border-radius: var(--radius-lg);
}
.locked-overlay svg { color: rgba(212,175,55,0.35); width: 36px; height: 36px; }
.locked-title { font-family: var(--ff-display); font-size: 1.2rem; color: var(--light); font-weight: 400; }
.locked-desc { font-size: 0.75rem; color: var(--muted); max-width: 300px; line-height: 1.6; }
.upgrade-btn {
  padding: 0.6rem 1.3rem; background: rgba(212,175,55,0.1);
  color: var(--gold); border: 1px solid rgba(212,175,55,0.3);
  border-radius: var(--radius); font-size: 0.72rem; font-weight: 600;
  letter-spacing: 0.1em; text-transform: uppercase;
  cursor: pointer; transition: var(--transition); margin-top: 0.4rem;
}
.upgrade-btn:hover { background: var(--gold); color: var(--darker); }

/* ═══════════════════════════════════════════════
   THREAD DETAIL OVERLAY — Premium Experience
═══════════════════════════════════════════════ */
#threadOverlay {
  position: fixed; inset: 0; z-index: 5000;
  background: rgba(5,5,5,0.88);
  backdrop-filter: blur(12px);
  display: none; align-items: center; justify-content: center;
  padding: 1.5rem;
  animation: overlayFadeIn 0.25s ease;
}
#threadOverlay.open { display: flex; }
@keyframes overlayFadeIn { from { opacity: 0; } to { opacity: 1; } }

.thread-detail {
  width: 100%; max-width: 760px;
  max-height: calc(100vh - 3rem);
  background: var(--dark2);
  border: 1px solid rgba(212,175,55,0.18);
  border-radius: 18px;
  display: flex; flex-direction: column;
  box-shadow: 0 40px 100px rgba(0,0,0,0.9), 0 0 0 1px rgba(212,175,55,0.06);
  overflow: hidden;
  animation: threadSlideIn 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
}
@keyframes threadSlideIn {
  from { opacity: 0; transform: scale(0.96) translateY(20px); }
  to   { opacity: 1; transform: scale(1) translateY(0); }
}

.thread-detail-header {
  padding: 1.4rem 1.8rem 1.1rem;
  border-bottom: 1px solid rgba(212,175,55,0.1);
  background: linear-gradient(135deg, var(--dark3) 0%, rgba(212,175,55,0.03) 100%);
  flex-shrink: 0;
  position: relative;
}
.thread-detail-header::after {
  content: '';
  position: absolute; bottom: 0; left: 1.8rem; right: 1.8rem;
  height: 1px;
  background: linear-gradient(90deg, transparent, rgba(212,175,55,0.2), transparent);
}
.thread-detail-back {
  display: inline-flex; align-items: center; gap: 0.4rem;
  font-size: 0.65rem; letter-spacing: 0.14em; text-transform: uppercase;
  color: var(--muted2); cursor: pointer; margin-bottom: 0.9rem;
  transition: var(--transition);
}
.thread-detail-back:hover { color: var(--gold); }
.thread-detail-back svg { width: 13px; height: 13px; }

.thread-detail-meta {
  display: flex; align-items: center; gap: 0.7rem; margin-bottom: 0.6rem;
}
.thread-detail-title {
  font-family: var(--ff-display);
  font-size: 1.35rem; font-weight: 400;
  color: var(--light); line-height: 1.35;
  letter-spacing: 0.01em;
}
.thread-detail-info {
  display: flex; align-items: center; gap: 1.2rem;
  margin-top: 0.6rem; font-size: 0.68rem; color: var(--muted2);
}
.thread-detail-info span { display: flex; align-items: center; gap: 0.3rem; }
.thread-detail-info svg { width: 12px; height: 12px; }

.thread-detail-messages {
  flex: 1; overflow-y: auto;
  padding: 1.2rem 1.8rem;
  display: flex; flex-direction: column; gap: 1rem;
  background: var(--darker);
}

.thread-message {
  display: flex; gap: 0.9rem; align-items: flex-start;
}
.thread-msg-avatar {
  width: 36px; height: 36px; border-radius: 50%; flex-shrink: 0;
  display: flex; align-items: center; justify-content: center;
  font-family: var(--ff-display); font-size: 1rem;
  background: linear-gradient(135deg, var(--dark4), var(--dark5));
  border: 1.5px solid var(--border2);
  color: var(--muted);
}
.thread-msg-avatar.team { background: linear-gradient(135deg, #1A1510, #2A2010); border-color: var(--gold-dim); color: var(--gold); }
.thread-msg-body { flex: 1; min-width: 0; }
.thread-msg-header {
  display: flex; align-items: baseline; gap: 0.6rem; margin-bottom: 0.35rem;
}
.thread-msg-author {
  font-size: 0.82rem; font-weight: 600; color: var(--light);
}
.thread-msg-author.team-author { color: var(--gold); }
.thread-msg-role {
  font-size: 0.6rem; letter-spacing: 0.1em; text-transform: uppercase; color: var(--muted2);
}
.thread-msg-time { margin-left: auto; font-size: 0.62rem; color: var(--muted2); }
.thread-msg-text {
  font-size: 0.82rem; color: rgba(245,245,245,0.78);
  line-height: 1.7; word-break: break-word;
  background: var(--dark3);
  border: 1px solid var(--border2);
  border-radius: 0 12px 12px 12px;
  padding: 0.75rem 1rem;
}
.thread-message.op .thread-msg-text {
  background: rgba(212,175,55,0.04);
  border-color: rgba(212,175,55,0.12);
}
.thread-msg-reactions {
  display: flex; gap: 0.4rem; margin-top: 0.4rem;
}
.thread-reaction {
  display: inline-flex; align-items: center; gap: 0.25rem;
  padding: 0.15rem 0.5rem; border-radius: 20px;
  font-size: 0.68rem; color: var(--muted2);
  background: var(--dark4); border: 1px solid var(--border2);
  cursor: pointer; transition: var(--transition);
}
.thread-reaction:hover { border-color: var(--gold-dim); color: var(--gold); }

.thread-divider {
  display: flex; align-items: center; gap: 0.8rem;
  font-size: 0.62rem; letter-spacing: 0.12em; text-transform: uppercase;
  color: var(--muted2); margin: 0.5rem 0;
}
.thread-divider::before, .thread-divider::after {
  content: ''; flex: 1; height: 1px; background: var(--border2);
}

.thread-detail-compose {
  padding: 1.1rem 1.8rem 1.3rem;
  border-top: 1px solid rgba(212,175,55,0.08);
  background: var(--dark2);
  flex-shrink: 0;
}
.thread-compose-label {
  font-size: 0.62rem; letter-spacing: 0.15em; text-transform: uppercase;
  color: var(--muted2); margin-bottom: 0.6rem;
}
.thread-compose-row {
  display: flex; gap: 0.7rem; align-items: flex-end;
}
.thread-compose-avatar {
  width: 34px; height: 34px; border-radius: 50%; flex-shrink: 0;
  display: flex; align-items: center; justify-content: center;
  font-family: var(--ff-display); font-size: 0.95rem;
  background: linear-gradient(135deg, var(--dark4), var(--dark5));
  border: 1.5px solid var(--gold-dim); color: var(--gold);
}
.thread-compose-input {
  flex: 1; background: var(--dark4);
  border: 1px solid var(--border2);
  border-radius: 14px;
  padding: 0.7rem 1.1rem;
  font-family: var(--ff-ui); font-size: 0.82rem; color: var(--light);
  resize: none; min-height: 48px; max-height: 140px;
  transition: var(--transition); line-height: 1.5;
}
.thread-compose-input:focus {
  border-color: rgba(212,175,55,0.35);
  box-shadow: 0 0 0 3px rgba(212,175,55,0.06);
  background: var(--dark3);
}
.thread-compose-input::placeholder { color: var(--muted2); }
.thread-compose-send {
  width: 42px; height: 42px; border-radius: 50%;
  background: linear-gradient(135deg, #C9A227, #D4AF37);
  flex-shrink: 0; display: flex; align-items: center; justify-content: center;
  transition: var(--transition);
  box-shadow: 0 4px 16px rgba(212,175,55,0.2);
}
.thread-compose-send:hover { transform: scale(1.08); box-shadow: 0 6px 20px rgba(212,175,55,0.35); }
.thread-compose-send svg { width: 16px; height: 16px; color: var(--darker); }

/* New thread modal */
#newThreadModal {
  position: fixed; inset: 0; z-index: 6000;
  background: rgba(5,5,5,0.88); backdrop-filter: blur(12px);
  display: none; align-items: center; justify-content: center;
  padding: 1.5rem;
}
#newThreadModal.open { display: flex; }
.new-thread-card {
  width: 100%; max-width: 560px;
  background: var(--dark2);
  border: 1px solid rgba(212,175,55,0.18);
  border-radius: 18px;
  box-shadow: 0 40px 100px rgba(0,0,0,0.9);
  overflow: hidden;
  animation: threadSlideIn 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
}
.new-thread-header {
  padding: 1.3rem 1.6rem 1rem;
  border-bottom: 1px solid rgba(212,175,55,0.1);
  background: linear-gradient(135deg, var(--dark3) 0%, rgba(212,175,55,0.03) 100%);
  display: flex; align-items: center; justify-content: space-between;
}
.new-thread-title { font-family: var(--ff-display); font-size: 1.2rem; color: var(--light); font-weight: 400; }
.new-thread-close {
  width: 32px; height: 32px; border-radius: 50%;
  display: flex; align-items: center; justify-content: center;
  color: var(--muted2); cursor: pointer; transition: var(--transition);
  background: var(--dark5); border: 1px solid var(--border2);
}
.new-thread-close:hover { color: var(--gold); border-color: var(--gold-dim); }
.new-thread-body { padding: 1.4rem 1.6rem; }
.new-thread-footer {
  padding: 0.9rem 1.6rem 1.2rem;
  border-top: 1px solid var(--border2);
  display: flex; gap: 0.7rem; justify-content: flex-end;
  background: var(--dark3);
}

/* Listing cards for candidates — preview only */
.listing-book-btn.locked-btn {
  background: rgba(245,245,245,0.04);
  color: var(--muted2);
  border-color: var(--border2);
  cursor: not-allowed;
  pointer-events: none;
  font-size: 0.62rem;
}
.listing-candidate-notice {
  display: flex; align-items: center; gap: 0.6rem;
  padding: 0.65rem 1rem; margin-bottom: 1.2rem;
  background: rgba(232,160,48,0.07);
  border: 1px solid rgba(232,160,48,0.2);
  border-radius: var(--radius);
  font-size: 0.76rem; color: var(--amber);
}
.listing-candidate-notice svg { width: 15px; height: 15px; flex-shrink: 0; }

/* Responsive tweaks */
@media (max-width: 1100px) {
  :root { --right-w: 0px; }
  #rightPanel { display: none; }
  #mainApp.active { grid-template-columns: var(--sidebar-w) 1fr; grid-template-areas: "sidebar header" "sidebar content"; }
}
@media (max-width: 768px) {
  :root { --sidebar-w: 0px; }
  #sidebar { display: none; }
  #mainApp.active { grid-template-columns: 1fr; grid-template-areas: "header" "content"; }
}
</style>
</head>
<body>

<!-- ═══════════════ LOGIN GATE ═══════════════ -->
<div id="loginGate">
  <div class="login-bg"></div>
  <div class="login-grid"></div>
  <div class="login-card">
    <div class="login-logo">
      <div class="login-logo-mark">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
          <polygon points="12,2 15.09,8.26 22,9.27 17,14.14 18.18,21.02 12,17.77 5.82,21.02 7,14.14 2,9.27 8.91,8.26"/>
        </svg>
      </div>
      <div class="login-brand">LuxHaven360</div>
      <div class="login-subtitle">Community Hub — Members Only</div>
    </div>
    <h2 class="login-title">Accesso Esclusivo</h2>
    <p class="login-desc">Area riservata ai membri della Community LuxHaven360. L'accesso è consentito solo a utenti autorizzati.</p>
    <div class="login-field">
      <label class="login-label" for="loginEmail">Email</label>
      <input type="email" id="loginEmail" class="login-input" placeholder="email@dominio.com" autocomplete="email"/>
    </div>
    <div class="login-field">
      <label class="login-label" for="loginPass">Password</label>
      <input type="password" id="loginPass" class="login-input" placeholder="••••••••" autocomplete="current-password"/>
    </div>
    <button class="login-btn" id="loginBtn">Accedi alla Community</button>
    <div class="login-error" id="loginError">Credenziali non valide. Riprova.</div>
    <div class="login-demo">
      <div class="login-demo-title">Hai perso le credenziali?</div>
      <div style="text-align:center; font-size:0.72rem; color:var(--muted2); line-height:1.6;">
        Le credenziali ti sono state inviate via email al momento della prenotazione.<br>
        Per assistenza: <a href="/cdn-cgi/l/email-protection#fa898f8a8a95888eba968f82929b8c9f94c9cccad4999597" style="color:var(--gold); text-decoration:none;"><span class="__cf_email__" data-cfemail="84f7f1f4f4ebf6f0c4e8f1fcece5f2e1eab7b2b4aae7ebe9">[email&#160;protected]</span></a>
      </div>
    </div>
    <div style="margin-top:0.8rem; padding:0.55rem 0.8rem; border-radius:var(--radius); background:rgba(212,175,55,0.05); border:1px solid rgba(212,175,55,0.18); text-align:center; font-size:0.63rem; color:var(--muted2); line-height:1.7;">
      🔐 <strong style="color:var(--gold);">Accesso Fondatore</strong><br>
      <span style="font-family:monospace; letter-spacing:0.03em; font-size:0.65rem; color:var(--light);"><a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="41272e2f2520352e3324012d3439292037242f7277716f222e2c">[email&#160;protected]</a></span><br>
      <span style="font-family:monospace; letter-spacing:0.03em; font-size:0.65rem; color:var(--light);">LuxFounder2025!</span>
    </div>
  </div>
</div>

<!-- ═══════════════ MAIN APP ═══════════════ -->
<div id="mainApp">

  <!-- SIDEBAR -->
  <aside id="sidebar">
    <div class="sidebar-logo">
      <div class="sidebar-logo-mark">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
          <polygon points="12,2 15.09,8.26 22,9.27 17,14.14 18.18,21.02 12,17.77 5.82,21.02 7,14.14 2,9.27 8.91,8.26"/>
        </svg>
      </div>
      <div>
        <div class="sidebar-logo-text">LuxHaven360</div>
        <div class="sidebar-logo-sub">Community Hub</div>
      </div>
    </div>

    <nav class="sidebar-nav">
      <div class="sidebar-section-label">Principale</div>
      <div class="nav-item active" onclick="showPanel('dashboard', this)">
        <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><rect x="3" y="3" width="7" height="7" rx="1"/><rect x="14" y="3" width="7" height="7" rx="1"/><rect x="3" y="14" width="7" height="7" rx="1"/><rect x="14" y="14" width="7" height="7" rx="1"/></svg>
        Dashboard
      </div>
      <div class="nav-item" onclick="showPanel('feed', this)">
        <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><path d="M22 16.92v3a2 2 0 01-2.18 2 19.79 19.79 0 01-8.63-3.07A19.5 19.5 0 013.07 9.81a19.79 19.79 0 01-3.07-8.7A2 2 0 012.18 1h3a2 2 0 012 1.72 12.84 12.84 0 00.7 2.81 2 2 0 01-.45 2.11L6.91 8.09A16 16 0 0015.91 17.1l1.45-1.45a2 2 0 012.11-.45 12.84 12.84 0 002.81.7A2 2 0 0122 16.92z"/></svg>
        Feed Aggiornamenti
        <span class="nav-badge hidden" id="feedBadge">0</span>
      </div>
      <div class="nav-item" onclick="showPanel('discussions', this)">
        <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><path d="M21 15a2 2 0 01-2 2H7l-4 4V5a2 2 0 012-2h14a2 2 0 012 2z"/></svg>
        Discussioni
        <span class="nav-badge hidden" id="discBadge">0</span>
      </div>
      <div class="nav-item" onclick="showPanel('messages', this)">
        <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg>
        Messaggi
        <span class="nav-badge hidden" id="msgBadge">0</span>
      </div>

      <div class="nav-separator"></div>
      <div class="sidebar-section-label">Contenuti</div>

      <div class="nav-item member-plus" onclick="showPanel('listings', this)">
        <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><path d="M3 9l9-7 9 7v11a2 2 0 01-2 2H5a2 2 0 01-2-2z"/><polyline points="9,22 9,12 15,12 15,22"/></svg>
        Listing Esclusivi
        <span class="nav-badge gold">New</span>
      </div>
      <div class="nav-item" id="listingsLockedNav" onclick="showPanel('listings', this)">
        <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0110 0v4"/></svg>
        Listing Esclusivi
      </div>
      <div class="nav-item" onclick="showPanel('surveys', this)">
        <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><polyline points="9,11 12,14 22,4"/><path d="M21 12v7a2 2 0 01-2 2H5a2 2 0 01-2-2V5a2 2 0 012-2h11"/></svg>
        Sondaggi & Feedback
      </div>
      <div class="nav-item" onclick="showPanel('notifications', this)">
        <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><path d="M18 8A6 6 0 006 8c0 7-3 9-3 9h18s-3-2-3-9"/><path d="M13.73 21a2 2 0 01-3.46 0"/></svg>
        Notifiche
        <span class="nav-badge hidden" id="notifNavBadge">0</span>
      </div>

      <div class="nav-separator"></div>
      <div class="sidebar-section-label">Personale</div>

      <div class="nav-item" onclick="showPanel('profile', this)">
        <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><path d="M20 21v-2a4 4 0 00-4-4H8a4 4 0 00-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
        Il Mio Profilo
      </div>

      <div class="nav-separator admin-only"></div>
      <div class="sidebar-section-label admin-only">Amministrazione</div>

      <div class="nav-item admin-only" onclick="showPanel('members', this)">
        <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 00-3-3.87"/><path d="M16 3.13a4 4 0 010 7.75"/></svg>
        Gestione Membri
        <span class="nav-dot"></span>
      </div>
      <div class="nav-item admin-only" onclick="showPanel('broadcast', this)">
        <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><path d="M22 16.92v3a2 2 0 01-2.18 2 19.79 19.79 0 01-8.63-3.07A19.5 19.5 0 013.07 9.81"/><polyline points="1,1 23,23"/></svg>
        Comunicazioni
      </div>
      <div class="nav-item admin-only" onclick="showPanel('moderation', this)">
        <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>
        Moderazione
        <span class="nav-badge hidden" id="modBadge">0</span>
      </div>
      <div class="nav-item admin-only" onclick="showPanel('analytics', this)">
        <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/></svg>
        Analytics
      </div>
    </nav>

    <div class="sidebar-user" onclick="showPanel('profile', document.querySelector('.nav-item'))">
      <div class="user-avatar-sm" id="sidebarAvatar">
        <div class="status-dot"></div>
      </div>
      <div class="user-info-sm">
        <div class="user-name-sm" id="sidebarName">—</div>
        <div class="user-role-sm" id="sidebarRole">—</div>
      </div>
      <svg class="user-chevron" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9,18 15,12 9,6"/></svg>
    </div>
  </aside>

  <!-- HEADER -->
  <header id="topHeader">
    <div>
      <div class="header-title" id="headerTitle">Dashboard</div>
    </div>
    <div class="header-search">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
      <input type="text" placeholder="Cerca nella Community…" id="globalSearch"/>
    </div>
    <div class="header-actions">
      <div class="level-badge" id="headerBadge">—</div>
      <div style="position:relative">
        <button class="header-btn" id="notifBell" onclick="toggleNotifDropdown()">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><path d="M18 8A6 6 0 006 8c0 7-3 9-3 9h18s-3-2-3-9"/><path d="M13.73 21a2 2 0 01-3.46 0"/></svg>
          <span class="notif-count hidden" id="headerNotifCount"></span>
        </button>
        <div class="notif-dropdown" id="notifDropdown">
          <div class="notif-dropdown-header">
            <span class="notif-dropdown-title">Notifiche</span>
            <span class="notif-mark-all" onclick="markAllRead()">Segna tutte come lette</span>
          </div>
          <div class="notif-dropdown-list" id="notifDropdownList"></div>
        </div>
      </div>
      <button class="header-btn" onclick="logout()">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><path d="M9 21H5a2 2 0 01-2-2V5a2 2 0 012-2h4"/><polyline points="16,17 21,12 16,7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>
      </button>
    </div>
  </header>

  <!-- MAIN CONTENT -->
  <main id="mainContent">

    <!-- ═══ DASHBOARD ═══ -->
    <div class="panel active" id="panel-dashboard">
      <div class="panel-inner">
        <div class="section-header">
          <div>
            <div class="section-title" id="dashWelcome">Benvenuto</div>
            <div class="section-desc" id="dashSubtitle">Panoramica della tua Community LuxHaven360</div>
          </div>
          <div style="display:flex; gap:0.5rem; align-items:center;">
            <div style="font-size:0.68rem; color:var(--muted2);" id="lastLoginTime">—</div>
          </div>
        </div>

        <!-- Stats row -->
        <div class="grid-3 mb-2" id="dashStatsGrid">
          <div class="stat-card">
            <div class="stat-label">Membri Attivi</div>
            <div class="stat-value" id="dashStatActiveMembers">—</div>
            <div class="stat-change neutral" id="dashStatMembersChange">Ultimi 30 giorni</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Aggiornamenti del Progetto</div>
            <div class="stat-value" id="dashStatFeedUpdates">—</div>
            <div class="stat-change neutral">Ultimi 30 giorni</div>
          </div>
          <div class="stat-card admin-only">
            <div class="stat-label">Founding Members</div>
            <div class="stat-value" id="dashStatFoundingCount">—</div>
            <div class="stat-change up" id="dashStatFoundingChange">
              <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="23,6 13.5,15.5 8.5,10.5 1,18"/><polyline points="17,6 23,6 23,12"/></svg>
              su 200 posti totali
            </div>
          </div>
          <div class="stat-card" id="candidateStatCard">
            <div class="stat-label">Posti Founding Member</div>
            <div class="stat-value" id="dashStatRemainingSpots">—</div>
            <div class="stat-change neutral" id="dashStatRemainingLabel">Slot disponibili</div>
          </div>
        </div>

        <!-- Quick activity feed -->
        <div class="grid-2 mb-2" id="dashGrid">
          <div class="card">
            <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:0.8rem;">
              <div style="font-size:0.65rem; letter-spacing:0.15em; text-transform:uppercase; color:var(--muted2);">Attività Recente</div>
              <button onclick="clearActivityLog()" style="font-size:0.65rem;color:var(--muted2);background:none;border:none;cursor:pointer;padding:0;opacity:0.6;" title="Svuota log attività">Svuota</button>
            </div>
            <div id="dashActivity"></div>
          </div>
          <div class="card" id="dashFeedPreview">
            <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:0.8rem;">
              <div style="font-size:0.65rem; letter-spacing:0.15em; text-transform:uppercase; color:var(--muted2);">Ultimi Aggiornamenti</div>
              <span style="font-size:0.68rem; color:var(--gold); cursor:pointer;" onclick="showPanel('feed', null)">Vedi tutti →</span>
            </div>
            <div id="dashFeedList"></div>
          </div>
        </div>

        <!-- Founder status card -->
        <div id="founderStatusCard" class="card">
          <div style="font-size:0.65rem; letter-spacing:0.15em; text-transform:uppercase; color:var(--muted2); margin-bottom:0.8rem;">Stato Founder</div>
          <div id="founderStatusContent"></div>
        </div>
      </div>
    </div>

    <!-- ═══ FEED ═══ -->
    <div class="panel" id="panel-feed">
      <div class="panel-inner">
        <div class="section-header">
          <div>
            <div class="section-title">Feed Aggiornamenti</div>
            <div class="section-desc">Novità, annunci e aggiornamenti esclusivi dal team LuxHaven360.</div>
          </div>
          <div class="admin-only">
            <button class="btn-primary" onclick="showPanel('broadcast', null)" style="font-size:0.7rem; padding:0.5rem 1rem;">+ Pubblica</button>
          </div>
        </div>
        <div id="feedContainer"></div>
      </div>
    </div>

    <!-- ═══ DISCUSSIONS ═══ -->
    <div class="panel" id="panel-discussions">
      <div class="panel-inner">
        <div class="section-header">
          <div>
            <div class="section-title">Discussioni</div>
            <div class="section-desc">Partecipa alle conversazioni della Community.</div>
          </div>
          <button class="btn-primary" style="font-size:0.7rem; padding:0.5rem 1rem;" onclick="openNewThreadModal()">+ Nuovo Thread</button>
        </div>
        <div class="tab-row">
          <div class="tab-btn active" onclick="switchTab('disc', 'all', this)">Tutti</div>
          <div class="tab-btn" onclick="switchTab('disc', 'feedback', this)">Feedback</div>
          <div class="tab-btn" onclick="switchTab('disc', 'question', this)">Domande</div>
          <div class="tab-btn" onclick="switchTab('disc', 'idea', this)">Idee</div>
        </div>
        <div id="discussionsContainer"></div>
      </div>
    </div>

    <!-- ═══ MESSAGES ═══ -->
    <div class="panel" id="panel-messages">
      <div class="panel-inner" style="padding:1rem;">
        <div class="messages-layout">
          <div class="conv-list">
            <div class="conv-search">
              <input class="conv-search-input" placeholder="Cerca conversazioni…" oninput="filterConversations(this.value)"/>
            </div>
            <div id="convListContainer"></div>
          </div>
          <div class="chat-area">
            <div class="chat-header" id="chatHeader">
              <div class="user-avatar-sm" id="chatHeaderAvatar" style="width:36px;height:36px;font-size:1rem;"></div>
              <div>
                <div class="chat-header-name" id="chatHeaderName">Seleziona una conversazione</div>
                <div class="chat-header-status" id="chatHeaderStatus">—</div>
              </div>
              <div class="chat-header-actions">
                <button class="header-btn" style="width:30px;height:30px;" title="Chiama">
                  <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><path d="M22 16.92v3a2 2 0 01-2.18 2 19.79 19.79 0 01-8.63-3.07A19.5 19.5 0 013.07 9.81a19.79 19.79 0 01-3.07-8.7A2 2 0 012.18 1h3a2 2 0 012 1.72 12.84 12.84 0 00.7 2.81 2 2 0 01-.45 2.11L6.91 8.09A16 16 0 0015.91 17.1l1.45-1.45a2 2 0 012.11-.45 12.84 12.84 0 002.81.7A2 2 0 0122 16.92z"/></svg>
                </button>
              </div>
            </div>
            <div class="chat-messages" id="chatMessages"></div>
            <div class="chat-input-area">
              <div class="chat-actions">
                <button class="chat-action" title="Allega file">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><path d="M21.44 11.05l-9.19 9.19a6 6 0 01-8.49-8.49l9.19-9.19a4 4 0 015.66 5.66l-9.2 9.19a2 2 0 01-2.83-2.83l8.49-8.48"/></svg>
                </button>
                <button class="chat-action" title="Emoji">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><circle cx="12" cy="12" r="10"/><path d="M8 13s1.5 2 4 2 4-2 4-2"/><line x1="9" y1="9" x2="9.01" y2="9"/><line x1="15" y1="9" x2="15.01" y2="9"/></svg>
                </button>
              </div>
              <input class="chat-input" id="chatInput" placeholder="Scrivi un messaggio…" onkeydown="handleChatKey(event)"/>
              <button class="chat-send-btn" onclick="sendMessage()">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22,2 15,22 11,13 2,9"/></svg>
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- ═══ LISTINGS ═══ -->
    <div class="panel" id="panel-listings">
      <div class="panel-inner">
        <div class="section-header">
          <div>
            <div class="section-title">Listing Esclusivi</div>
            <div class="section-desc">Accesso anticipato alle proprietà disponibili prima del lancio pubblico.</div>
          </div>
        </div>
        <div id="listingsContainer"></div>
      </div>
    </div>

    <!-- ═══ SURVEYS ═══ -->
    <div class="panel" id="panel-surveys">
      <div class="panel-inner">
        <div class="section-header">
          <div>
            <div class="section-title">Sondaggi & Feedback</div>
            <div class="section-desc">La tua voce contribuisce direttamente allo sviluppo del progetto.</div>
          </div>
        </div>
        <div id="surveysContainer"></div>
      </div>
    </div>

    <!-- ═══ NOTIFICATIONS ═══ -->
    <div class="panel" id="panel-notifications">
      <div class="panel-inner">
        <div class="section-header">
          <div>
            <div class="section-title">Centro Notifiche</div>
          </div>
          <button class="btn-secondary" id="markAllReadBtn" style="font-size:0.7rem; padding:0.45rem 1rem; display:none;" onclick="markAllRead()">Segna tutte come lette</button>
        </div>
        <div id="notifsContainer"></div>
      </div>
    </div>

    <!-- ═══ PROFILE ═══ -->
    <div class="panel" id="panel-profile">
      <div class="panel-inner" id="profileContainer"></div>
    </div>

    <!-- ═══ MEMBERS (Admin) ═══ -->
    <div class="panel" id="panel-members">
      <div class="panel-inner">
        <div class="section-header">
          <div>
            <div class="section-title">Gestione Membri</div>
            <div class="section-desc">Visualizza, modifica e gestisci i livelli dei membri della Community.</div>
          </div>
          <button class="btn-primary" style="font-size:0.7rem; padding:0.5rem 1rem;">+ Invita Membro</button>
        </div>
        <div class="tab-row">
          <div class="tab-btn active" onclick="switchTab('members', 'all', this)">Tutti (47)</div>
          <div class="tab-btn" onclick="switchTab('members', 'founding', this)">Founding Members (19)</div>
          <div class="tab-btn" onclick="switchTab('members', 'candidate', this)">Candidates (28)</div>
        </div>
        <div class="card" style="padding:0; overflow:hidden;">
          <table class="admin-table">
            <thead>
              <tr>
                <th>Membro</th>
                <th>Livello</th>
                <th>Data Iscrizione</th>
                <th>Ultima Attività</th>
                <th>Stato</th>
                <th>Azioni</th>
              </tr>
            </thead>
            <tbody id="membersTable"></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- ═══ BROADCAST (Admin) ═══ -->
    <div class="panel" id="panel-broadcast">
      <div class="panel-inner">
        <div class="section-header">
          <div>
            <div class="section-title">Comunicazioni</div>
            <div class="section-desc">Pubblica aggiornamenti e comunicati per i membri della Community.</div>
          </div>
        </div>
        <div class="broadcast-form">
          <div class="form-group">
            <label class="form-label">Destinatari</label>
            <div class="broadcast-target">
              <div class="target-chip active" onclick="toggleChip(this)">Tutti i membri</div>
              <div class="target-chip" onclick="toggleChip(this)">Founding Members</div>
              <div class="target-chip" onclick="toggleChip(this)">Founder Candidates</div>
            </div>
          </div>
          <div class="form-group">
            <label class="form-label">Tipo di comunicazione</label>
            <div class="broadcast-target">
              <div class="target-chip active" data-type="update" onclick="toggleChipSingle(this, 'type')">Aggiornamento Progetto</div>
              <div class="target-chip" data-type="news" onclick="toggleChipSingle(this, 'type')">Annuncio</div>
              <div class="target-chip" data-type="exclusive" data-lock="1" onclick="toggleChipSingle(this, 'type')">Contenuto Esclusivo</div>
              <div class="target-chip" data-type="update" onclick="toggleChipSingle(this, 'type')">Evento</div>
            </div>
          </div>
          <div class="form-group">
            <label class="form-label">Titolo</label>
            <input class="form-input" id="broadcastTitle" placeholder="Titolo della comunicazione…"/>
          </div>
          <div class="form-group">
            <label class="form-label">Contenuto</label>
            <textarea class="form-input form-textarea" id="broadcastContent" placeholder="Scrivi il contenuto della comunicazione…"></textarea>
          </div>
          <div class="form-group">
            <label class="form-label">Programma invio</label>
            <div style="display:flex; gap:0.7rem; align-items:center;">
              <div class="target-chip active" onclick="toggleChipSingle(this, 'schedule')">Immediato</div>
              <div class="target-chip" onclick="toggleChipSingle(this, 'schedule')">Pianificato</div>
              <input class="form-input" type="datetime-local" style="width:auto; flex:0;" id="scheduleDate"/>
            </div>
          </div>
          <div class="form-actions">
            <button class="btn-secondary">Anteprima</button>
            <button class="btn-primary" onclick="publishBroadcast()">Pubblica Ora</button>
          </div>
        </div>

        <!-- ── Gestione Eventi ── -->
        <div class="card" style="margin-top:1.5rem;">
          <div class="section-header" style="margin-bottom:1rem; padding:0;">
            <div>
              <div class="section-title" style="font-size:0.9rem;">Gestione Eventi</div>
              <div class="section-desc" style="font-size:0.72rem;">Crea e gestisci gli eventi nella sezione "Prossimi Eventi" del pannello laterale.</div>
            </div>
          </div>

          <!-- Form nuovo evento -->
          <div style="display:flex; flex-direction:column; gap:0.8rem; margin-bottom:1.2rem;">
            <div class="form-group" style="margin:0;">
              <label class="form-label">Titolo Evento *</label>
              <input class="form-input" id="eventTitleInput" placeholder="es. Q&A Esclusiva — Founding Members"/>
            </div>
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:0.8rem;">
              <div class="form-group" style="margin:0;">
                <label class="form-label">Data e Ora *</label>
                <input class="form-input" id="eventDateInput" type="datetime-local"/>
              </div>
              <div class="form-group" style="margin:0;">
                <label class="form-label">Orario (testo)</label>
                <input class="form-input" id="eventTimeStrInput" placeholder="es. Ore 18:00"/>
              </div>
            </div>
            <div class="form-group" style="margin:0;">
              <label class="form-label">Nota / Accesso</label>
              <input class="form-input" id="eventMetaInput" placeholder="es. Solo Founding Members · Accesso prioritario"/>
            </div>
          </div>
          <button class="btn-primary" onclick="createEventUI()" style="width:100%;">
            ＋ Crea Evento
          </button>

          <!-- Lista eventi esistenti -->
          <div id="eventsAdminList" style="margin-top:1rem;"></div>
        </div>
      </div>
    </div>

    <!-- ═══ MODERATION (Admin) ═══ -->
    <div class="panel" id="panel-moderation">
      <div class="panel-inner">
        <div class="section-header">
          <div>
            <div class="section-title">Moderazione</div>
            <div class="section-desc">Gestisci segnalazioni e monitora l'attività della Community.</div>
          </div>
        </div>
        <div id="moderationContainer"></div>
      </div>
    </div>

    <!-- ═══ ANALYTICS (Admin) ═══ -->
    <div class="panel" id="panel-analytics">
      <div class="panel-inner">
        <div class="section-header">
          <div>
            <div class="section-title">Analytics</div>
            <div class="section-desc">Dati e metriche della Community in tempo reale.</div>
          </div>
        </div>
        <div class="grid-3 mb-2">
          <div class="stat-card">
            <div class="stat-label">Sessioni Oggi</div>
            <div class="stat-value">24</div>
            <div class="stat-change up">+18% vs ieri</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Messaggi (7gg)</div>
            <div class="stat-value">318</div>
            <div class="stat-change up">+12% vs settimana prec.</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Engagement Rate</div>
            <div class="stat-value">78<span class="stat-unit">%</span></div>
            <div class="stat-change up">↑ in crescita</div>
          </div>
        </div>
        <div class="grid-2">
          <div class="card">
            <div style="font-size:0.65rem; letter-spacing:0.15em; text-transform:uppercase; color:var(--muted2); margin-bottom:0.8rem;">Attività Settimanale</div>
            <div class="chart-placeholder" id="weeklyChart"></div>
          </div>
          <div class="card">
            <div style="font-size:0.65rem; letter-spacing:0.15em; text-transform:uppercase; color:var(--muted2); margin-bottom:0.8rem;">Distribuzione Livelli</div>
            <div style="display:flex; flex-direction:column; gap:0.7rem; margin-top:0.5rem;">
              <div>
                <div style="display:flex; justify-content:space-between; font-size:0.72rem; margin-bottom:0.3rem;"><span class="text-gold">Founding Members</span><span>19 (40%)</span></div>
                <div class="progress-bar-wrap"><div class="progress-bar-fill" style="width:40%; background:linear-gradient(90deg, #C9A227, #D4AF37);"></div></div>
              </div>
              <div>
                <div style="display:flex; justify-content:space-between; font-size:0.72rem; margin-bottom:0.3rem;"><span class="text-amber">Founder Candidates</span><span>28 (60%)</span></div>
                <div class="progress-bar-wrap"><div class="progress-bar-fill" style="width:60%; background:linear-gradient(90deg, #C87020, #E8A030);"></div></div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

  </main>

  <!-- RIGHT PANEL -->
  <aside id="rightPanel">
    <div class="rp-section">
      <div id="liveIndicatorRp" style="display:none;"><div class="live-indicator"><div class="live-dot"></div> In diretta</div></div>
      <div class="rp-title">Membri Online</div>
      <div id="onlineMembersList"></div>
    </div>
    <div class="rp-divider"></div>
    <div class="rp-section">
      <div class="rp-title">Prossimi Eventi</div>
      <div id="upcomingEvents"></div>
    </div>
    <div class="rp-divider"></div>
    <div class="rp-section">
      <div class="rp-title">Stato Progetto</div>
      <div style="margin-top:0.3rem;">
        <div style="display:flex; justify-content:space-between; font-size:0.72rem; margin-bottom:0.35rem;"><span>Posti confermati</span><span class="text-gold" id="rpStatusBooked">— / 200</span></div>
        <div class="progress-bar-wrap"><div class="progress-bar-fill" id="rpStatusBar" style="width:0%;"></div></div>
        <div style="font-size:0.65rem; color:var(--muted2); margin-top:0.4rem; line-height:1.5;" id="rpStatusRemaining">—</div>
      </div>
    </div>
  </aside>

</div>

<!-- THREAD DETAIL OVERLAY -->
<div id="threadOverlay">
  <div class="thread-detail" id="threadDetail">
    <div class="thread-detail-header">
      <div class="thread-detail-back" onclick="closeThread()">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="15,18 9,12 15,6"/></svg>
        Torna alle discussioni
      </div>
      <div class="thread-detail-meta" id="threadDetailMeta"></div>
      <div class="thread-detail-title" id="threadDetailTitle"></div>
      <div class="thread-detail-info" id="threadDetailInfo"></div>
    </div>
    <div class="thread-detail-messages" id="threadDetailMessages"></div>
    <div class="thread-detail-compose">
      <div class="thread-compose-label">La tua risposta</div>
      <div class="thread-compose-row">
        <div class="thread-compose-avatar" id="threadComposeAvatar"></div>
        <textarea class="thread-compose-input" id="threadComposeInput" placeholder="Scrivi la tua risposta…" onkeydown="handleThreadKey(event)"></textarea>
        <button class="thread-compose-send" onclick="submitThreadReply()">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22,2 15,22 11,13 2,9"/></svg>
        </button>
      </div>
    </div>
  </div>
</div>

<!-- NEW THREAD MODAL -->
<div id="newThreadModal">
  <div class="new-thread-card">
    <div class="new-thread-header">
      <div class="new-thread-title">Nuovo Thread</div>
      <button class="new-thread-close" onclick="closeNewThreadModal()">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
      </button>
    </div>
    <div class="new-thread-body">
      <div class="form-group">
        <label class="form-label">Categoria</label>
        <div class="broadcast-target" id="newThreadCategories">
          <div class="target-chip active" data-cat="general">Generale</div>
          <div class="target-chip" data-cat="question">Domanda</div>
          <div class="target-chip" data-cat="feedback">Feedback</div>
          <div class="target-chip" data-cat="idea">Idea</div>
        </div>
      </div>
      <div class="form-group">
        <label class="form-label">Titolo del thread</label>
        <input class="form-input" id="newThreadTitleInput" placeholder="Scrivi un titolo chiaro e descrittivo…"/>
      </div>
      <div class="form-group">
        <label class="form-label">Messaggio iniziale</label>
        <textarea class="form-input form-textarea" id="newThreadBodyInput" placeholder="Descrivi l'argomento, fai una domanda o condividi la tua idea…"></textarea>
      </div>
    </div>
    <div class="new-thread-footer">
      <button class="btn-secondary" onclick="closeNewThreadModal()">Annulla</button>
      <button class="btn-primary" onclick="submitNewThread()">Pubblica Thread</button>
    </div>
  </div>
</div>

<!-- TOAST CONTAINER -->
<div id="toastContainer"></div>

<!-- ═══════════════ JAVASCRIPT ═══════════════ -->
<script>
/* ═══════════════════════════════════════════
   CONFIGURAZIONE
   ⚠ Sostituisci GAS_URL con l'URL del tuo deployment Google Apps Script
═══════════════════════════════════════════ */
const GAS_URL = 'https://script.google.com/macros/s/AKfycbwrDLCy9xO2mcX0ORieD5k9Ck7_6ysrnBfayWg_Gd_Pno4UrCa-2JuBTvkzBNvkfQ_xxQ/exec';

/* ═══════════════════════════════════════════
   APP STATE
═══════════════════════════════════════════ */

let currentUser = null;
let currentConv = null;
let notifCount = 0;
let unreadMsgs = 0;

/* Mock data */
const MEMBERS_DATA = [
  { name:'Sofia Romano',    initial:'S', level:'founding',  joined:'12 Nov 2024', last:'2 min fa',  status:'online' },
  { name:'Alessandro Mori', initial:'A', level:'founding',  joined:'15 Nov 2024', last:'8 min fa',  status:'online' },
  { name:'Elena De Luca',   initial:'E', level:'founding',  joined:'20 Nov 2024', last:'1 ora fa',  status:'away'   },
  { name:'Marco Bianchi',   initial:'M', level:'candidate', joined:'28 Nov 2024', last:'3 ore fa',  status:'offline'},
  { name:'Chiara Vitale',   initial:'C', level:'candidate', joined:'1 Dic 2024',  last:'ieri',      status:'offline'},
  { name:'Luca Fontana',    initial:'L', level:'founding',  joined:'5 Dic 2024',  last:'4 min fa',  status:'online' },
  { name:'Giulia Marini',   initial:'G', level:'founding',  joined:'8 Dic 2024',  last:'30 min fa', status:'away'   },
  { name:'Roberto Costa',   initial:'R', level:'candidate', joined:'12 Dic 2024', last:'2 gg fa',   status:'offline'},
];

let FEED_POSTS = [];
// I post vengono caricati esclusivamente da GAS
let DISCUSSIONS = [];
// Le discussioni vengono caricate esclusivamente da GAS
let LISTINGS = [];
// Le listing vengono caricate esclusivamente da GAS
const CONVS = [
  { id:1, name:'Team LuxHaven360', initial:'T', type:'team', status:'online', last:'Grazie per il feedback!', time:'10:24', unread:1,
    messages:[
      { from:'them', text:'Ciao! Benvenuto nella Community Hub.', time:'09:00' },
      { from:'them', text:'Hai qualche domanda sui tuoi vantaggi come membro?', time:'09:02' },
      { from:'me', text:'Sì, volevo sapere quando saranno disponibili i prossimi listing esclusivi.', time:'09:15' },
      { from:'them', text:'Grazie per il feedback!', time:'10:24' },
    ]
  },
  { id:2, name:'Sofia Romano', initial:'S', type:'member', status:'online', last:'Certo, ci sentiamo presto!', time:'Ieri', unread:1,
    messages:[
      { from:'them', text:'Ciao! Ho visto il tuo profilo nella community.', time:'Ieri 14:00' },
      { from:'me', text:'Ciao Sofia! Sì, mi sono iscritto di recente.', time:'Ieri 14:30' },
      { from:'them', text:'Certo, ci sentiamo presto!', time:'Ieri 15:00' },
    ]
  },
  { id:3, name:'Alessandro Mori', initial:'A', type:'member', status:'away', last:'Ottima idea, ne parliamo nel thread!', time:'2 gg fa', unread:0,
    messages:[
      { from:'them', text:'Hai letto il thread sulle sessioni live?', time:'2 gg fa' },
      { from:'me', text:'Sì, ottima proposta di Chiara!', time:'2 gg fa' },
      { from:'them', text:'Ottima idea, ne parliamo nel thread!', time:'2 gg fa' },
    ]
  },
];

const NOTIFICATIONS = [];
// Le notifiche vengono generate da eventi reali
let SURVEYS = [];
// I sondaggi vengono caricati esclusivamente da GAS (get_community_data → surveys)

const REPORTS = [
  { id:1, type:'Contenuto inappropriato', reporter:'Marco B.', target:'Commento di utente anonimo', content:'Il commento segnalato contiene linguaggio non appropriato rispetto al tono della Community.', time:'1 ora fa' },
  { id:2, type:'Spam', reporter:'Sofia R.', target:'Messaggio privato', content:'Messaggio promozionale non autorizzato inviato ad altri membri della community.', time:'3 ore fa' },
];

// Presenza real-time — popolata da GAS tramite heartbeat/polling (nessun dato statico)
let ONLINE_MEMBERS = [];

// Eventi community — popolati da GAS (nessun dato statico)
let EVENTS = [];
let _pendingLocalEvents = []; // eventi creati localmente non ancora confermati da GAS

/* ═══════════════════════════════════════════
   SESSION MANAGEMENT
═══════════════════════════════════════════ */
const SESSION_KEY = 'lh360_community_session';

function saveSession(user) {
  try {
    localStorage.setItem(SESSION_KEY, JSON.stringify({
      user: user,
      timestamp: Date.now()
    }));
  } catch(e) {}
}

function loadSession() {
  try {
    const raw = localStorage.getItem(SESSION_KEY);
    if (!raw) return null;
    const data = JSON.parse(raw);
    // Sessione valida per 30 giorni
    const MAX_AGE = 30 * 24 * 60 * 60 * 1000;
    if (Date.now() - data.timestamp > MAX_AGE) {
      localStorage.removeItem(SESSION_KEY);
      return null;
    }
    return data.user;
  } catch(e) {
    return null;
  }
}

function clearSession() {
  try { localStorage.removeItem(SESSION_KEY); } catch(e) {}
}

/* ═══════════════════════════════════════════
   AUTH
═══════════════════════════════════════════ */
document.getElementById('loginBtn').addEventListener('click', doLogin);
document.getElementById('loginPass').addEventListener('keydown', e => { if(e.key === 'Enter') doLogin(); });

async function doLogin() {
  const emailInput = document.getElementById('loginEmail');
  const passInput  = document.getElementById('loginPass');
  const errorEl    = document.getElementById('loginError');
  const loginBtn   = document.getElementById('loginBtn');

  const email    = emailInput.value.trim().toLowerCase();
  const password = passInput.value.trim();

  if (!email || !password) {
    errorEl.textContent = 'Inserisci email e password.';
    errorEl.classList.add('show');
    return;
  }

  // UI: loading state
  loginBtn.disabled  = true;
  loginBtn.textContent = 'Verifica in corso…';
  errorEl.classList.remove('show');

  try {
    if (!GAS_URL || GAS_URL === 'YOUR_GAS_DEPLOYMENT_URL_HERE') {
      throw new Error('GAS_URL non configurato. Aggiorna la costante GAS_URL nel codice.');
    }

    const url = `${GAS_URL}?action=verify_login_extended&email=${encodeURIComponent(email)}&password=${encodeURIComponent(password)}`;
    const resp = await fetch(url);
    if (!resp.ok) throw new Error('Errore di rete: ' + resp.status);
    const data = await resp.json();

    if (data.success && data.authorized && data.user) {
      currentUser = data.user;
      saveSession(currentUser);

      // ── Pre-carica le statistiche durante il login ─────────────────────────
      // Aggiorna il testo del pulsante per dare feedback visivo
      loginBtn.textContent = 'Connessione in corso…';
      try {
        const statsResp = await fetch(`${GAS_URL}?action=get_dashboard_stats`);
        if (statsResp.ok) {
          const statsData = await statsResp.json();
          if (statsData && statsData.success) saveStatsCache(statsData);
        }
      } catch (_e) { /* silenzioso */ }

      document.documentElement.classList.remove('no-session');
      const mainAppEl = document.getElementById('mainApp');
      mainAppEl.style.cssText = '';
      document.getElementById('loginGate').style.display = 'none';
      mainAppEl.classList.add('active');
      initApp();
    } else {
      const msg = data.error || 'Credenziali non valide. Riprova.';
      errorEl.textContent = msg;
      errorEl.classList.add('show');
      passInput.value = '';
      passInput.focus();
    }
  } catch(err) {
    errorEl.textContent = 'Errore di connessione: ' + err.message;
    errorEl.classList.add('show');
    passInput.value = '';
  } finally {
    loginBtn.disabled  = false;
    loginBtn.textContent = 'Accedi alla Community';
  }
}

function logout() {
  // Rimuovi presenza e ferma heartbeat prima di fare logout
  if (_heartbeatTimer) { clearInterval(_heartbeatTimer); _heartbeatTimer = null; }
  removePresence(); // async ma non blocchiamo — fire and forget
  currentUser = null;
  clearSession();
  // Redirect alla pagina community pubblica
  window.location.href = '../the-project/community.html';
}

/* ═══════════════════════════════════════════
   AUTO-AUTH CHECK (eseguito al caricamento)
═══════════════════════════════════════════ */
(async function checkSessionOnLoad() {
  const saved = loadSession();
  if (!saved) return; // nessuna sessione: login gate già visibile

  currentUser = saved;
  document.documentElement.classList.remove('no-session');
  const mainAppEl = document.getElementById('mainApp');
  mainAppEl.style.cssText = '';
  document.getElementById('loginGate').style.display = 'none';
  mainAppEl.classList.add('active');

  // ── Strategia stats zero-latency ────────────────────────────────────────
  // CASO A: Cache presente (utente di ritorno) → applica subito, zero latenza.
  // CASO B: Cache assente (localStorage svuotato / primo accesso) →
  //         fetch sincrono GAS PRIMA di chiamare initApp, così le card
  //         mostrano i valori reali al primo render. Mai "—".
  const cachedStats = loadStatsCache();
  if (cachedStats) {
    // Applica immediatamente: valori reali visibili dal primo frame
    applyDashboardStats(cachedStats);
    // initApp NON aspetta — può partire subito
    if (document.readyState === 'complete' || document.readyState === 'interactive') {
      initApp();
    } else {
      document.addEventListener('DOMContentLoaded', initApp);
    }
  } else {
    // Nessuna cache: fetch real-time PRIMA di mostrare la dashboard
    if (typeof GAS_URL !== 'undefined' && GAS_URL && !GAS_URL.includes('YOUR_GAS')) {
      try {
        const r = await fetch(`${GAS_URL}?action=get_dashboard_stats`);
        if (r.ok) {
          const d = await r.json();
          if (d && d.success) {
            saveStatsCache(d);
            applyDashboardStats(d);
          }
        }
      } catch (_e) { /* GAS non raggiungibile: le card rimarranno con —, ma è raro */ }
    }
    // Avvia l'app dopo il fetch (o subito se GAS non configurato)
    if (document.readyState === 'complete' || document.readyState === 'interactive') {
      initApp();
    } else {
      document.addEventListener('DOMContentLoaded', initApp);
    }
  }
})();

/* ═══════════════════════════════════════════
   INIT APP
═══════════════════════════════════════════ */
function initApp() {
  // ── Cache bust: rimuovi tutte le versioni precedenti della cache community ──
  // Questo garantisce che dati statici vecchi non vengano mai caricati dal browser
  // Rimuovi tutte le versioni precedenti di cache (community + stats)
  ['lh360_community_v1', 'lh360_community_v2'].forEach(k => {
    try { localStorage.removeItem(k); } catch(e) {}
  });

  const role = currentUser.role;
  
  // Apply role class to sidebar
  const sidebar = document.getElementById('sidebar');
  sidebar.className = `role-${role === 'team' ? 'team' : role === 'founding' ? 'founding' : 'candidate'}`;

  // Update sidebar user
  const av = document.getElementById('sidebarAvatar');
  av.textContent = currentUser.initial;
  const statusDot = document.createElement('div');
  statusDot.className = 'status-dot';
  av.appendChild(statusDot);
  document.getElementById('sidebarName').textContent = currentUser.name;
  const roleEl = document.getElementById('sidebarRole');
  roleEl.textContent = currentUser.title;
  roleEl.className = 'user-role-sm ' + (role === 'team' ? 'gold' : role === 'founding' ? 'green' : 'amber');

  // Header badge
  const badge = document.getElementById('headerBadge');
  if (role === 'team') {
    badge.textContent = '⬡ Team LuxHaven360';
    badge.className = 'level-badge team';
  } else if (role === 'founding') {
    badge.textContent = '★ Founding Member';
    badge.className = 'level-badge founding';
  } else {
    badge.textContent = '◈ Founder Candidate';
    badge.className = 'level-badge candidate';
  }

  // Show/hide listings nav items
  if (role === 'team' || role === 'founding') {
    document.querySelector('.nav-item.member-plus[onclick*="listings"]') && 
    (document.querySelector('.nav-item.member-plus[onclick*="listings"]').style.display = 'flex');
    document.getElementById('listingsLockedNav') && 
    (document.getElementById('listingsLockedNav').style.display = 'none');
  } else {
    const memberListingNav = document.querySelector('.nav-item.member-plus[onclick*="listings"]');
    if (memberListingNav) memberListingNav.style.display = 'none';
    const lockedNav = document.getElementById('listingsLockedNav');
    if (lockedNav) lockedNav.style.display = 'flex';
  }

  // Last login time
  const now = new Date();
  document.getElementById('lastLoginTime').textContent = `Accesso: ${now.getHours()}:${String(now.getMinutes()).padStart(2,'0')}`;

  // Dashboard
  document.getElementById('dashWelcome').textContent = `Benvenuto, ${currentUser.name.split(' ')[0]}`;
  renderDashboard();
  renderFeed();
  renderDiscussions();
  renderConversations();
  renderListings();
  renderSurveys();
  renderNotifications();
  renderProfile();
  renderMembersTable();
  renderModeration();
  renderRightPanel();
  renderNotifDropdown();
  renderWeeklyChart();

  // Forza lo stato corretto del badge notifiche al primo render:
  // notifCount è 0 e NOTIFICATIONS è vuoto → campanella priva di badge
  updateNotifBadge();

  // Simulate real-time activity
  // Avvia presenza real-time: heartbeat immediato + timer ogni 2 minuti
  startPresenceSystem();

  // Carica statistiche dinamiche ogni 10 secondi (aggiornamento in tempo reale)
  loadDashboardStats();
  if (_dashStatsTimer) clearInterval(_dashStatsTimer);
  _dashStatsTimer = setInterval(loadDashboardStats, 10 * 1000);

  // Carica dati community (post, discussioni, sondaggi, presenza, eventi) da GAS
  initCommunityData();

  // Gestisci link diretto a un post (#post-ID nella URL)
  handlePostAnchor();
}

/* ═══════════════════════════════════════════
   NAVIGATION
═══════════════════════════════════════════ */
function showPanel(id, navEl) {
  // Blocca pannelli admin per ruoli non-team
  const adminPanels = ['broadcast', 'members', 'moderation', 'analytics'];
  if (adminPanels.includes(id) && currentUser && currentUser.role !== 'team') {
    showToast('red', '\uD83D\uDD12', 'Accesso non autorizzato.');
    return;
  }
  document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
  const panel = document.getElementById('panel-' + id);
  if (panel) panel.classList.add('active');
  
  document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
  if (navEl) navEl.classList.add('active');

  const titles = {
    dashboard:'Dashboard', feed:'Feed Aggiornamenti', discussions:'Discussioni',
    messages:'Messaggi', listings:'Listing Esclusivi', surveys:'Sondaggi & Feedback',
    notifications:'Centro Notifiche', profile:'Il Mio Profilo',
    members:'Gestione Membri', broadcast:'Comunicazioni', moderation:'Moderazione', analytics:'Analytics'
  };
  document.getElementById('headerTitle').textContent = titles[id] || id;

  // Clear badges when viewing
  if (id === 'notifications') { notifCount = 0; updateNotifBadge(); }
  if (id === 'messages') { unreadMsgs = 0; updateMsgBadge(); }
  if (id === 'feed') {
    document.getElementById('feedBadge').classList.add('hidden');
    // Avvia/riavvia il tracking lettura post quando il feed diventa visibile
    requestAnimationFrame(() => initFeedReadTracking());
  }
  if (id === 'dashboard') { renderActivityFeed(); renderFeedPreview(); loadDashboardStats(); }
  if (id === 'profile') {
    // Rirenderi il profilo con statistiche aggiornate in tempo reale
    renderProfile();
  }
  if (id === 'broadcast' && currentUser && currentUser.role === 'team') {
    renderEventsAdminList();
  }
}

/* ═══════════════════════════════════════════
   RENDER DASHBOARD
═══════════════════════════════════════════ */
function renderDashboard() {
  // Attività recente e feed preview — delegati a funzioni dinamiche
  renderActivityFeed();
  renderFeedPreview();

  // Founder status
  const fc = document.getElementById('founderStatusContent');
  const role = currentUser.role;
  if (role === 'team') {
    fc.innerHTML = `
      <div style="display:flex; gap:1.5rem; flex-wrap:wrap;">
        <div><div class="stat-label">Ruolo</div><div style="font-family:var(--ff-display); font-size:1.1rem; color:var(--gold);">Team LuxHaven360</div></div>
        <div><div class="stat-label">Accesso</div><div style="font-size:0.82rem; color:var(--green);">Completo · Admin</div></div>
        <div><div class="stat-label">Permessi</div><div style="font-size:0.82rem; color:var(--light);">Tutti i pannelli</div></div>
      </div>`;
  } else if (role === 'founding') {
    fc.innerHTML = `
      <div style="display:flex; gap:1.5rem; flex-wrap:wrap; margin-bottom:0.8rem;">
        <div><div class="stat-label">Livello</div><div style="font-family:var(--ff-display); font-size:1.1rem; color:var(--green);">Founding Member</div></div>
        <div><div class="stat-label">Status</div><div style="font-size:0.82rem; color:var(--gold);">Permanente · Confermato</div></div>
        <div><div class="stat-label">Posizione</div><div style="font-size:0.82rem; color:var(--light);">#19 / 200</div></div>
      </div>
      <div style="display:flex; gap:0.5rem; flex-wrap:wrap;">
        ${['Accesso prioritario listing','Canale diretto team','Prenotazioni anticipate','Area Founder dedicata','Status permanente'].map(b => `<div class="profile-badge gold-badge">✓ ${b}</div>`).join('')}
      </div>`;
  } else {
    // Legge posti rimasti dall'elemento già aggiornato da loadDashboardStats
    const spotsEl = document.getElementById('dashStatRemainingSpots');
    const hasRealData = spotsEl && !spotsEl.querySelector('[style*="animation"]');
    const remainingText = hasRealData ? ((spotsEl.textContent.split('/')[0] || '').trim() + ' rimasti') : '… rimasti';

    fc.innerHTML = `
      <div style="display:flex; gap:1.5rem; flex-wrap:wrap; margin-bottom:0.8rem;">
        <div><div class="stat-label">Livello Attuale</div><div style="font-family:var(--ff-display); font-size:1.1rem; color:var(--amber);">Founder Candidate</div></div>
        <div><div class="stat-label">Prossimo Livello</div><div style="font-size:0.82rem; color:var(--gold);">Founding Member</div></div>
        <div><div class="stat-label">Posti Disponibili</div><div style="font-size:0.82rem; color:var(--light);" id="founderStatusRemainingSpots">${remainingText}</div></div>
      </div>
      <div style="margin-bottom:0.5rem; font-size:0.72rem; color:var(--muted);">Progressione verso Founding Member</div>
      <div class="progress-bar-wrap" style="height:8px;"><div class="progress-bar-fill" style="width:45%;"></div></div>
      <div style="font-size:0.7rem; color:var(--muted2); margin-top:0.4rem;">45% completato · Conferma accesso per sbloccare i benefici Founding Member</div>
      <button class="upgrade-btn" style="margin-top:0.8rem;" onclick="showToast('gold', '⭐', 'Richiesta inviata al team. Sarai contattato a breve!')">
        Richiedi Upgrade a Founding Member
      </button>`;
  }
}

/* ═══════════════════════════════════════════
   COMMUNITY DATA — CACHE + GAS SYNC
═══════════════════════════════════════════ */
const COMMUNITY_CACHE_KEY  = 'lh360_community_v3';
const COMMUNITY_CACHE_TTL  = 5 * 60 * 1000; // 5 minuti (solo per posts/discussions)
const EVENTS_CACHE_KEY     = 'lh360_events_v1'; // cache eventi separata, senza TTL
const ONLINE_CACHE_KEY     = 'lh360_online_v1'; // cache membri online, TTL breve (60s)
let _communityPollTimer    = null;

function saveCommunityCache() {
  try {
    localStorage.setItem(COMMUNITY_CACHE_KEY, JSON.stringify({
      ts:           Date.now(),
      posts:        FEED_POSTS,
      discussions:  DISCUSSIONS,
      threadMsgs:   THREAD_MESSAGES,
      surveys:      SURVEYS,
      listings:     LISTINGS
    }));
  } catch(e) {}
}

/* Salva gli eventi in una cache dedicata senza TTL — devono essere sempre disponibili */
function saveEventsCache() {
  try {
    localStorage.setItem(EVENTS_CACHE_KEY, JSON.stringify({ events: EVENTS }));
  } catch(e) {}
}

function loadEventsCache() {
  try {
    const raw = localStorage.getItem(EVENTS_CACHE_KEY);
    if (!raw) return null;
    return JSON.parse(raw).events || null;
  } catch(e) { return null; }
}

function saveOnlineCache() {
  try { localStorage.setItem(ONLINE_CACHE_KEY, JSON.stringify({ ts: Date.now(), members: ONLINE_MEMBERS })); } catch(e) {}
}

function loadOnlineCache() {
  try {
    const raw = localStorage.getItem(ONLINE_CACHE_KEY);
    if (!raw) return null;
    const obj = JSON.parse(raw);
    if (Date.now() - obj.ts > 60 * 1000) return null; // scade dopo 60s
    return obj.members || null;
  } catch(e) { return null; }
}

function loadCommunityCache() {
  try {
    const raw = localStorage.getItem(COMMUNITY_CACHE_KEY);
    if (!raw) return null;
    const obj = JSON.parse(raw);
    if (Date.now() - obj.ts > COMMUNITY_CACHE_TTL) return null;
    return obj;
  } catch(e) { return null; }
}

/* Applica i dati GAS in memoria + ri-renderizza le sezioni visibili */
function applyRemoteData(data) {
  if (!data) return;

  // ── Post del feed ───────────────────────────────────────────────
  // Sempre sovrascrive — nessun fallback su dati statici
  if (data.hasOwnProperty('posts') && Array.isArray(data.posts)) {
    const likedSet = new Set(FEED_POSTS.filter(p => p.liked).map(p => p.id));
    FEED_POSTS = data.posts.map(p => ({
      ...p,
      liked:       likedSet.has(p.id) || (p.likedBy && currentUser && p.likedBy.includes(currentUser.name)),
      commentsData: p.commentsData || []
    }));
  }

  // ── Discussioni ──────────────────────────────────────────────────
  // Sempre sovrascrive — se GAS risponde con array vuoto, DISCUSSIONS è [] (nessun fallback statico)
  if (data.hasOwnProperty('discussions') && Array.isArray(data.discussions)) {
    DISCUSSIONS = data.discussions;
  }

  // ── Listing Esclusivi ─────────────────────────────────────────────
  if (Array.isArray(data.listings)) {
    LISTINGS = data.listings;
  }

  // ── Risposte thread ──────────────────────────────────────────────
  if (data.replies && typeof data.replies === 'object') {
    Object.keys(data.replies).forEach(discId => {
      const id = parseInt(discId, 10) || discId;
      THREAD_MESSAGES[id] = data.replies[discId];
    });
  }

  // ── Sondaggi da GAS (sovrascrive sempre — nessun fallback statico) ─
  if (Array.isArray(data.surveys)) {
    SURVEYS = data.surveys;
  }

  // ── Voti sondaggi ────────────────────────────────────────────────
  if (data.votes && typeof data.votes === 'object') {
    SURVEYS.forEach(s => {
      const key = 'survey_' + s.id;
      if (data.votes[key]) {
        const v = data.votes[key];
        // Aggiorna conteggi opzioni
        Object.keys(v.options || {}).forEach(idx => {
          if (s.options[idx]) s.options[idx].votes = v.options[idx];
        });
        s.total = s.options.reduce((sum, o) => sum + o.votes, 0);
        if (currentUser && v.voters && v.voters.includes(currentUser.name)) {
          s.voted = true;
        }
      }
    });
  }

  saveCommunityCache();

  // Re-renderizza solo i pannelli visibili
  const activePanel = document.querySelector('.panel.active');
  if (!activePanel) return;
  const pid = activePanel.id.replace('panel-', '');
  if (pid === 'feed')        renderFeed();
  if (pid === 'discussions') renderDiscussions();
  if (pid === 'surveys')     renderSurveys();
  if (pid === 'listings')    renderListings();
  if (pid === 'dashboard')   { renderActivityFeed(); renderFeedPreview(); }
}

/* Carica dati community da GAS (o cache se fresca) */
async function initCommunityData() {
  if (!currentUser) return;

  // 1a. Carica eventi dalla cache dedicata SUBITO — rendering immediato senza latenza
  const cachedEvents = loadEventsCache();
  if (cachedEvents && cachedEvents.length > 0) {
    applyEventsData(cachedEvents);
  }

  // 1b. Carica membri online dalla cache SUBITO (TTL 60s)
  const cachedOnline = loadOnlineCache();
  if (cachedOnline && cachedOnline.length > 0) {
    applyPresenceData(cachedOnline);
  }

  // 1c. Applica cache community (posts, discussions, ecc.)
  const cache = loadCommunityCache();
  if (cache) {
    applyRemoteData({
      posts:       cache.posts,
      discussions: cache.discussions,
      replies:     cache.threadMsgs || {},
      votes:       {},
      listings:    cache.listings || []
    });
  }

  // 2. Fetch completo da GAS — include posts, discussions, presenza, eventi
  if (!GAS_URL) return;
  try {
    const data = await fetch(`${GAS_URL}?action=get_community_data`).then(r => r.json());
    if (data.success) {
      applyRemoteData(data);
      if (Array.isArray(data.online)) applyPresenceData(data.online);
      if (Array.isArray(data.events)) { applyEventsData(data.events); saveEventsCache(); }
    }
  } catch(e) {
    console.warn('[CommunityData] GAS non raggiungibile:', e.message);
    renderRightPanel();
  }

  // 3. Polling real-time ogni 5 secondi
  if (_communityPollTimer) clearInterval(_communityPollTimer);
  _communityPollTimer = setInterval(pollCommunityUpdates, 5 * 1000);
}

/* Polling leggero: solo metadati per evitare render inutili */
let _pollCycle = 0;
async function pollCommunityUpdates() {
  if (!GAS_URL || !currentUser) return;
  _pollCycle++;
  try {
    const data = await fetch(`${GAS_URL}?action=get_community_data`).then(r => r.json());
    if (data.success) {
      // Presenza real-time: aggiorna lista membri online
      if (Array.isArray(data.online)) applyPresenceData(data.online);
      // Eventi: aggiorna e persisti in cache — ogni ciclo (5s)
      if (Array.isArray(data.events)) applyEventsData(data.events);
      // Notifiche in tempo reale
      if (Array.isArray(data.notifications)) {
        NOTIFICATIONS.length = 0;
        data.notifications.forEach(n => NOTIFICATIONS.push(n));
        notifCount = NOTIFICATIONS.filter(n => n.unread).length;
        updateNotifBadge();
        renderNotifDropdown();
        const notifPanel = document.getElementById('panel-notifications');
        if (notifPanel && notifPanel.classList.contains('active')) renderNotifications();
      }
      // Ogni 3 cicli (≈15s): aggiorna anche posts/discussions (più pesante)
      if (_pollCycle % 3 === 0) applyRemoteData(data);
    }
  } catch(e) {}
  // Statistiche dashboard
  try {
    const resp = await fetch(`${GAS_URL}?action=get_dashboard_stats`);
    if (resp.ok) {
      const stats = await resp.json();
      if (stats.success) { saveStatsCache(stats); applyDashboardStats(stats); }
    }
  } catch(e) {}
}

/* Seed disabilitato — contenuti pubblicati solo dal Team tramite pannello Comunicazioni */
async function seedInitialData() {
  console.info('[Seed] Disabilitato.');
  return; // nessun seed automatico
  for (const post of [...FEED_POSTS].reverse()) {
    try {
      await fetch(`${GAS_URL}?action=publish_post` +
        `&author=${encodeURIComponent(post.author)}&initial=${encodeURIComponent(post.initial)}` +
        `&role=${encodeURIComponent(post.role)}&type=${encodeURIComponent(post.type)}` +
        `&title=${encodeURIComponent(post.title)}&text=${encodeURIComponent(post.text)}` +
        `&locked=${encodeURIComponent(post.locked||'')}`);
    } catch(e) {}
  }
  for (const disc of [...DISCUSSIONS].reverse()) {
    const replies = THREAD_MESSAGES[disc.id] || [];
    const op = replies[0];
    if (!op) continue;
    try {
      await fetch(`${GAS_URL}?action=save_discussion` +
        `&category=${encodeURIComponent(disc.category)}&title=${encodeURIComponent(disc.title)}` +
        `&body=${encodeURIComponent(op.text)}&author=${encodeURIComponent(disc.author)}` +
        `&initial=${encodeURIComponent(op.initial||'?')}&role=${encodeURIComponent(op.role||'')}` +
        `&isTeam=${!!op.isTeam}`);
    } catch(e) {}
  }
  console.info('[Seed] Completato.');
}

/* ── sharePost: crea link diretto al post ───────────────────────── */
function sharePost(postId) {
  const base = window.location.origin + window.location.pathname;
  const url  = `${base}#post-${postId}`;
  navigator.clipboard.writeText(url).then(
    ()  => showToast('blue', '🔗', 'Link copiato negli appunti!'),
    ()  => {
      // Fallback se clipboard non disponibile (es. HTTP)
      prompt('Copia il link:', url);
    }
  );
}

/* Gestisci anchor al caricamento (per link diretti a post) */
function handlePostAnchor() {
  const hash = window.location.hash;
  if (!hash || !hash.startsWith('#post-')) return;
  const postId = parseInt(hash.replace('#post-', ''), 10);
  if (!postId) return;
  setTimeout(() => {
    showPanel('feed', null);
    setTimeout(() => {
      const el = document.getElementById('post-' + postId);
      if (el) {
        el.scrollIntoView({ behavior: 'smooth', block: 'center' });
        el.style.outline = '1px solid var(--gold)';
        setTimeout(() => { el.style.outline = ''; }, 2500);
      }
    }, 200);
  }, 500);
}

/* ═══════════════════════════════════════════
   STATS CACHE (localStorage — mostra valori immediati)
═══════════════════════════════════════════ */
const STATS_CACHE_KEY = 'lh360_stats_cache';
// Nessun TTL: la cache persiste tra sessioni (stale-while-revalidate).
// I valori vengono aggiornati in background dal polling ogni 10s.

function saveStatsCache(data) {
  try { localStorage.setItem(STATS_CACHE_KEY, JSON.stringify({ data, ts: Date.now() })); } catch(e) {}
}

function loadStatsCache() {
  try {
    const raw = localStorage.getItem(STATS_CACHE_KEY);
    if (!raw) return null;
    const obj = JSON.parse(raw);
    return (obj && obj.data) ? obj.data : null;
    // Nessun controllo TTL: usiamo sempre il valore in cache (sarà aggiornato dal polling)
  } catch(e) { return null; }
}

/* ═══════════════════════════════════════════
   LOAD DASHBOARD STATS (cache-first, GAS in background)
═══════════════════════════════════════════ */
let _dashStatsTimer = null;

async function loadDashboardStats() {
  if (!currentUser) return;

  // 1. Mostra subito i valori dalla cache reale (da sessioni precedenti via GAS)
  // Se la cache non esiste (primo accesso assoluto), le card restano con — fino a GAS.
  // Non usiamo mai dati mock: un — neutro è preferibile a un numero sbagliato.
  const cached = loadStatsCache();
  if (cached) {
    applyDashboardStats(cached);
  }

  if (!GAS_URL) return;

  // 2. Aggiorna in background da GAS — l'utente non vede il loading
  try {
    const url = `${GAS_URL}?action=get_dashboard_stats`;
    const resp = await fetch(url);
    if (!resp.ok) throw new Error('HTTP ' + resp.status);
    const data = await resp.json();
    if (!data.success) throw new Error(data.error || 'Errore');
    saveStatsCache(data);
    applyDashboardStats(data);
  } catch (err) {
    console.warn('[Stats] GAS non raggiungibile:', err.message);
  }
}

/* applyClientSideStats rimossa: usava MEMBERS_DATA mock causando valori falsi visibili.
   I dati reali provengono esclusivamente da GAS (con cache per accessi successivi). */

function applyDashboardStats(data) {
  // ── Membri Attivi ────────────────────────────────────────
  const activeEl = document.getElementById('dashStatActiveMembers');
  if (activeEl) activeEl.textContent = data.active_members ?? '—';

  const changeEl = document.getElementById('dashStatMembersChange');
  if (changeEl) {
    const newW  = data.weekly_new  ?? 0;
    const lostW = data.weekly_lost ?? 0;
    if (newW > 0 || lostW > 0) {
      const sign = newW >= lostW ? '+' : '-';
      const diff = Math.abs(newW - lostW);
      const cls  = newW >= lostW ? 'up' : 'neutral';
      changeEl.className = `stat-change ${cls}`;
      changeEl.innerHTML = newW >= lostW
        ? `<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="23,6 13.5,15.5 8.5,10.5 1,18"/><polyline points="17,6 23,6 23,12"/></svg> +${newW} questa settimana`
        : `<span>-${lostW} usciti, +${newW} nuovi questa settimana</span>`;
    } else {
      changeEl.className = 'stat-change neutral';
      changeEl.textContent = 'Nessuna variazione questa settimana';
    }
  }

  // ── Aggiornamenti Feed ───────────────────────────────────
  const feedEl = document.getElementById('dashStatFeedUpdates');
  if (feedEl) feedEl.textContent = data.feed_updates_30d ?? '—';

  // ── Founding Members ─────────────────────────────────────
  const foundingEl = document.getElementById('dashStatFoundingCount');
  if (foundingEl) foundingEl.textContent = data.founding_member_count ?? '—';
  const foundingChangeEl = document.getElementById('dashStatFoundingChange');
  if (foundingChangeEl) {
    foundingChangeEl.innerHTML = `<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="23,6 13.5,15.5 8.5,10.5 1,18"/><polyline points="17,6 23,6 23,12"/></svg> su ${data.max_founders ?? 200} posti totali`;
  }

  // ── Posti Disponibili ─────────────────────────────────────
  const remaining  = data.remaining_spots ?? 0;
  const maxF       = data.max_founders    ?? 200;
  const totalBooked = maxF - remaining;
  const pct         = Math.min(100, Math.round((totalBooked / maxF) * 100));

  const spotsEl = document.getElementById('dashStatRemainingSpots');
  if (spotsEl) spotsEl.innerHTML = `${remaining} <span class="stat-unit">/ ${maxF}</span>`;

  const spotsLabelEl = document.getElementById('dashStatRemainingLabel');
  if (spotsLabelEl) {
    spotsLabelEl.textContent = remaining === 0 ? 'Tutti i posti esauriti' : 'Slot disponibili';
    spotsLabelEl.className = `stat-change ${remaining < 20 ? 'up' : 'neutral'}`;
  }

  // ── Right Panel Stato Progetto ────────────────────────────
  const rpBooked    = document.getElementById('rpStatusBooked');
  const rpBar       = document.getElementById('rpStatusBar');
  const rpRemaining = document.getElementById('rpStatusRemaining');
  if (rpBooked)    rpBooked.textContent = `${totalBooked} / ${maxF}`;
  if (rpBar)       rpBar.style.width    = `${pct}%`;
  if (rpRemaining) rpRemaining.textContent = `${remaining} posti ancora disponibili`;

  // ── Aggiorna Founder Status Card (per candidati) ──────────
  // Aggiorna il campo "Posti Disponibili" nella founder status card senza re-render completo
  const fsrEl = document.getElementById('founderStatusRemainingSpots');
  if (fsrEl) fsrEl.textContent = `${remaining} rimasti`;
}

/* ═══════════════════════════════════════════
   ACTIVITY LOG (localStorage-based)
═══════════════════════════════════════════ */
const ACTIVITY_LOG_KEY = 'lh360_activity_log';
const ACTIVITY_MAX     = 100;
const ACTIVITY_DAYS    = 14;

function logActivity(dotColor, text) {
  const entry = { dotColor, text, ts: Date.now() };
  try {
    const raw = localStorage.getItem(ACTIVITY_LOG_KEY);
    let log = raw ? JSON.parse(raw) : [];
    log.unshift(entry);
    if (log.length > ACTIVITY_MAX) log = log.slice(0, ACTIVITY_MAX);
    localStorage.setItem(ACTIVITY_LOG_KEY, JSON.stringify(log));
  } catch(e) {}
  // Aggiorna il feed se la dashboard è visibile
  const dashPanel = document.getElementById('panel-dashboard');
  if (dashPanel && dashPanel.classList.contains('active')) renderActivityFeed();
}

function formatTimeAgo(ts) {
  const diff = Date.now() - ts;
  const m = Math.floor(diff / 60000);
  const h = Math.floor(diff / 3600000);
  const d = Math.floor(diff / 86400000);
  if (m < 1)  return 'Ora';
  if (m < 60) return m + 'm';
  if (h < 24) return h + 'h';
  return d + 'g';
}

/* ═══════════════════════════════════════════
   RENDER ATTIVITÀ RECENTE (dinamico)
═══════════════════════════════════════════ */
function clearActivityLog() {
  try { localStorage.removeItem(ACTIVITY_LOG_KEY); } catch(e) {}
  renderActivityFeed();
  showToast('blue', '🗑️', 'Attività recente svuotata');
}

function renderActivityFeed() {
  const act = document.getElementById('dashActivity');
  if (!act) return;

  const cutoff = Date.now() - ACTIVITY_DAYS * 24 * 60 * 60 * 1000;
  let activities = [];

  // Leggi dal log persistente
  try {
    const raw = localStorage.getItem(ACTIVITY_LOG_KEY);
    if (raw) {
      activities = JSON.parse(raw)
        .filter(e => e.ts >= cutoff)
        .slice(0, 5)
        .map(e => ({ dot: e.dotColor, text: e.text, time: formatTimeAgo(e.ts) }));
    }
  } catch(e) {}

  // Nessun seed statico — mostra solo attività reali del log persistente

  if (activities.length === 0) {
    act.innerHTML = '<div style="font-size:0.75rem;color:var(--muted2);text-align:center;padding:1rem 0;">Nessuna attività recente.</div>';
    return;
  }

  act.innerHTML = activities.map(a => `
    <div class="activity-item">
      <div class="activity-dot ${a.dot}"></div>
      <div class="activity-text">${a.text}</div>
      <div class="activity-time">${a.time}</div>
    </div>
  `).join('');
}

/* ═══════════════════════════════════════════
   RENDER ULTIMI AGGIORNAMENTI (feed team-only, max 4)
═══════════════════════════════════════════ */
function renderFeedPreview() {
  const feedList = document.getElementById('dashFeedList');
  if (!feedList) return;

  // Solo post del Team/Admin/Community Manager, max 4, ordinati per timestamp decrescente
  const teamPosts = FEED_POSTS
    .filter(p => p.role && (
      p.role.toLowerCase().includes('team') ||
      p.role.toLowerCase().includes('admin') ||
      p.role.toLowerCase().includes('community')
    ))
    .sort((a, b) => (b.ts || 0) - (a.ts || 0))
    .slice(0, 4);

  if (teamPosts.length === 0) {
    feedList.innerHTML = '<div style="font-size:0.75rem;color:var(--muted2);text-align:center;padding:1rem 0;">Nessun aggiornamento recente dal Team.</div>';
    return;
  }

  feedList.innerHTML = teamPosts.map(p => `
    <div style="display:flex; gap:0.6rem; padding:0.5rem 0; border-bottom:1px solid var(--border2); cursor:pointer;" onclick="showPanel('feed', null)">
      <div style="font-size:0.7rem; letter-spacing:0.08em; text-transform:uppercase; padding:0.2rem 0.5rem; border-radius:10px; height:fit-content; flex-shrink:0;
        ${p.type==='update' ? 'background:rgba(212,175,55,0.1);color:var(--gold)' : p.type==='exclusive' ? 'background:rgba(76,175,120,0.1);color:var(--green)' : 'background:rgba(91,142,212,0.1);color:var(--blue)'}">
        ${p.type==='update'?'UPD':p.type==='exclusive'?'EXCL':'NEWS'}
      </div>
      <div style="min-width:0;">
        <div style="font-size:0.78rem; color:var(--light); font-weight:500; line-height:1.4; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${p.title}</div>
        <div style="font-size:0.65rem; color:var(--muted2); margin-top:2px;">${p.time || formatTimeAgo(p.ts)}</div>
      </div>
    </div>
  `).join('');
}

/* ═══════════════════════════════════════════
   RENDER FEED
═══════════════════════════════════════════ */
function renderFeed() {
  const container = document.getElementById('feedContainer');
  if (FEED_POSTS.length === 0) {
    container.innerHTML = '<div style="text-align:center;padding:3rem 1rem;color:var(--muted2);font-size:0.82rem;">Nessun aggiornamento disponibile.<br>Il team pubblicherà presto il primo contenuto.</div>';
    return;
  }
  // Ordina per timestamp decrescente (più recente prima)
  const sortedPosts = [...FEED_POSTS].sort((a, b) => (b.ts || 0) - (a.ts || 0));
  container.innerHTML = sortedPosts.map(post => {
    const isLocked = post.locked === 'candidate' && currentUser.role === 'candidate';
    return `
    <div class="feed-post" id="post-${post.id}">
      <div class="post-header">
        <div class="post-avatar ${post.initial === 'L' || post.initial === 'V' ? 'team-av' : 'user-av'}">${post.initial}</div>
        <div>
          <div class="post-author">${post.author}</div>
          <div class="post-role">${post.role}</div>
        </div>
        <div class="post-time">${post.time}</div>
      </div>
      <div class="post-body">
        <div class="post-type-tag ${post.type}">${post.type === 'update' ? '📢 Aggiornamento' : post.type === 'exclusive' ? '⭐ Contenuto Esclusivo' : '📰 Notizia'}</div>
        <div class="post-title">${post.title}</div>
        ${isLocked ? `
          <div class="post-locked">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0110 0v4"/></svg>
            Questo contenuto è riservato ai <strong style="color:var(--gold)">Founding Members</strong>. Effettua l'upgrade per accedere.
          </div>
          <button class="upgrade-btn" onclick="showToast('gold','⭐','Richiesta upgrade inviata al team!')">Sblocca come Founding Member</button>
        ` : `<div class="post-text">${post.text}</div>`}
      </div>
      ${!isLocked ? `
      <div class="reaction-bar" id="reaction-bar-${post.id}">
        <span class="reaction-item" id="react-likes-${post.id}">❤️ ${post.likes}</span>
        <span class="reaction-item" style="margin-left:0.5rem" id="react-comments-${post.id}">💬 ${post.comments}</span>
      </div>
      <div class="post-actions">
        <button class="post-action-btn ${post.liked ? 'liked' : ''}" onclick="toggleLike(${post.id}, this)">
          <svg viewBox="0 0 24 24" fill="${post.liked ? 'currentColor' : 'none'}" stroke="currentColor" stroke-width="1.8"><path d="M20.84 4.61a5.5 5.5 0 00-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 00-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 000-7.78z"/></svg>
          ${post.liked ? 'Liked' : 'Mi piace'} (${post.likes})
        </button>
        <button class="post-action-btn" onclick="toggleComments(${post.id})">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><path d="M21 15a2 2 0 01-2 2H7l-4 4V5a2 2 0 012-2h14a2 2 0 012 2z"/></svg>
          Commenta (${post.comments})
        </button>
        <div class="post-separator"></div>
        <button class="post-action-btn" onclick="sharePost(${post.id})">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><path d="M4 12v8a2 2 0 002 2h12a2 2 0 002-2v-8"/><polyline points="16,6 12,2 8,6"/><line x1="12" y1="2" x2="12" y2="15"/></svg>
          Condividi
        </button>
      </div>
      <div class="post-comments" id="comments-${post.id}">
        ${post.commentsData.map(c => `
          <div class="comment">
            <div class="comment-avatar">${c.initial}</div>
            <div class="comment-bubble">
              <div class="comment-author">${c.author}</div>
              <div class="comment-text">${c.text}</div>
              <div class="comment-time">${c.time}</div>
            </div>
          </div>
        `).join('')}
        <div class="comment-input-row">
          <div class="comment-avatar" style="margin-top:0;">${currentUser.initial}</div>
          <input class="comment-input" placeholder="Scrivi un commento…" onkeydown="submitComment(event, ${post.id})"/>
          <button class="comment-send-btn" onclick="submitCommentBtn(${post.id})">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22,2 15,22 11,13 2,9"/></svg>
          </button>
        </div>
      </div>
      ` : ''}
    </div>`;
  }).join('');
  // Avvia tracking lettura post tramite IntersectionObserver
  requestAnimationFrame(() => initFeedReadTracking());
}

function toggleLike(postId, btn) {
  const post = FEED_POSTS.find(p => p.id === postId);
  if (!post) return;

  // Ottimistic update immediato
  post.liked  = !post.liked;
  post.likes += post.liked ? 1 : -1;

  btn.className = `post-action-btn ${post.liked ? 'liked' : ''}`;
  btn.innerHTML = `<svg viewBox="0 0 24 24" fill="${post.liked ? 'currentColor' : 'none'}" stroke="currentColor" stroke-width="1.8"><path d="M20.84 4.61a5.5 5.5 0 00-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 00-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 000-7.78z"/></svg> ${post.liked ? 'Liked' : 'Mi piace'} (${post.likes})`;

  // Sincronizza reaction-bar (indicatori riassuntivi ❤️ 💬)
  const reactLikes = document.getElementById('react-likes-' + postId);
  if (reactLikes) reactLikes.textContent = '❤️ ' + post.likes;

  if (post.liked) showToast('red', '❤️', 'Hai messo like al post!');

  // Persisti su GAS in background
  if (GAS_URL && currentUser) {
    const url = `${GAS_URL}?action=toggle_post_like&postId=${postId}&userName=${encodeURIComponent(currentUser.name)}`;
    fetch(url).then(r => r.json()).then(data => {
      // Correggi con il dato reale dal server (in caso di race condition)
      if (data.success) {
        post.likes = data.likes;
        post.liked = data.liked;
        btn.innerHTML = `<svg viewBox="0 0 24 24" fill="${post.liked ? 'currentColor' : 'none'}" stroke="currentColor" stroke-width="1.8"><path d="M20.84 4.61a5.5 5.5 0 00-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 00-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 000-7.78z"/></svg> ${post.liked ? 'Liked' : 'Mi piace'} (${post.likes})`;
        if (reactLikes) reactLikes.textContent = '❤️ ' + post.likes;
      }
    }).catch(() => {}); // Fallback: mantieni ottimistic
  }
}

function toggleComments(postId) {
  const el = document.getElementById('comments-' + postId);
  if (el) el.classList.toggle('open');
}

function submitComment(e, postId) { if(e.key==='Enter') submitCommentBtn(postId, e.target); }
function submitCommentBtn(postId, inputEl) {
  const input = inputEl || document.querySelector(`#comments-${postId} .comment-input`);
  if (!input || !input.value.trim()) return;
  const text = input.value.trim();
  const post = FEED_POSTS.find(p => p.id === postId);
  if (!post) return;

  const shortName = currentUser.name.split(' ')[0] + ' ' + (currentUser.name.split(' ')[1]||'?')[0] + '.';
  const newComment = { author: shortName, initial: currentUser.initial, text, time: 'Ora' };

  // Ottimistic update immediato
  post.commentsData.push(newComment);
  post.comments = post.commentsData.length;
  input.value = '';

  // Aggiorna contatori in entrambi i punti (pulsante + reaction-bar)
  const commentBtn = document.querySelector(`#post-${postId} .post-action-btn:nth-child(2)`);
  if (commentBtn) commentBtn.innerHTML = commentBtn.innerHTML.replace(/\(\d+\)/, `(${post.comments})`);
  const reactComments = document.getElementById('react-comments-' + postId);
  if (reactComments) reactComments.textContent = '💬 ' + post.comments;

  // Render solo i commenti (evita re-render completo del feed)
  const commentsContainer = document.getElementById('comments-' + postId);
  if (commentsContainer) {
    renderPostComments(post, commentsContainer);
    commentsContainer.classList.add('open');
  }
  showToast('green', '💬', 'Commento pubblicato!');
  logActivity('green', `<strong>${currentUser.name.split(' ')[0]}</strong> ha commentato nel feed`);

  // Aggiorna contatore commenti nel profilo in tempo reale
  const profComments = document.getElementById('profileStatComments');
  if (profComments) profComments.textContent = countUserComments();

  // Persisti su GAS in background
  if (GAS_URL && currentUser) {
    const url = `${GAS_URL}?action=add_post_comment&postId=${postId}` +
      `&author=${encodeURIComponent(shortName)}&initial=${encodeURIComponent(currentUser.initial)}` +
      `&text=${encodeURIComponent(text)}`;
    fetch(url).catch(() => {});
  }
}

function renderPostComments(post, container) {
  const rows = post.commentsData.map(c => `
    <div class="comment">
      <div class="comment-avatar">${c.initial}</div>
      <div class="comment-bubble">
        <div class="comment-author">${c.author}</div>
        <div class="comment-text">${c.text}</div>
        <div class="comment-time">${c.time}</div>
      </div>
    </div>
  `).join('');
  const inputRow = `
    <div class="comment-input-row">
      <div class="comment-avatar" style="margin-top:0;">${currentUser.initial}</div>
      <input class="comment-input" placeholder="Scrivi un commento…" onkeydown="submitComment(event, ${post.id})"/>
      <button class="comment-send-btn" onclick="submitCommentBtn(${post.id})">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22,2 15,22 11,13 2,9"/></svg>
      </button>
    </div>`;
  container.innerHTML = rows + inputRow;
}

/* ═══════════════════════════════════════════
   RENDER DISCUSSIONS
═══════════════════════════════════════════ */
function renderDiscussions(filter) {
  const threads = filter && filter !== 'all' ? DISCUSSIONS.filter(d => d.category === filter) : DISCUSSIONS;
  const container = document.getElementById('discussionsContainer');
  if (threads.length === 0) {
    container.innerHTML = '<div style="text-align:center;padding:3rem 1rem;color:var(--muted2);font-size:0.82rem;">Nessuna discussione ancora.<br>Sii il primo a creare un thread!</div>';
    return;
  }
  container.innerHTML = threads.map(d => `
    <div class="discussion-thread" onclick="openThread(${d.id})">
      <div class="thread-header">
        ${d.pinned ? '<span class="thread-pinned">📌 Fissato</span>' : ''}
        <span class="thread-category ${d.category}">${d.category === 'feedback' ? 'Feedback' : d.category === 'question' ? 'Domanda' : d.category === 'idea' ? 'Idea' : 'Generale'}</span>
        <div class="thread-title">${d.title}</div>
        <div class="thread-meta">
          <div class="thread-stat"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a2 2 0 01-2 2H7l-4 4V5a2 2 0 012-2h14a2 2 0 012 2z"/></svg> ${d.replies}</div>
          <div class="thread-stat"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg> ${d.views}</div>
        </div>
      </div>
      <div class="thread-footer">
        <div class="thread-last-reply">💬 <span>${d.lastReply}</span></div>
        <div>${d.author} · ${d.time}</div>
      </div>
    </div>
  `).join('');
}

/* ═══════════════════════════════════════════
   THREAD DETAIL VIEW
═══════════════════════════════════════════ */
const THREAD_MESSAGES = {};
// Le risposte ai thread vengono caricate da GAS
let currentThreadId = null;

function openThread(id) {
  const thread = DISCUSSIONS.find(d => d.id === id);
  if (!thread) return;
  currentThreadId = id;

  // Category tag
  const catLabels = { feedback:'Feedback', question:'Domanda', idea:'Idea', general:'Generale' };
  document.getElementById('threadDetailMeta').innerHTML = `
    <span class="thread-category ${thread.category}">${catLabels[thread.category] || thread.category}</span>
    ${thread.pinned ? '<span class="thread-pinned">📌 Fissato</span>' : ''}
  `;
  document.getElementById('threadDetailTitle').textContent = thread.title;
  document.getElementById('threadDetailInfo').innerHTML = `
    <span>
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a2 2 0 01-2 2H7l-4 4V5a2 2 0 012-2h14a2 2 0 012 2z"/></svg>
      ${thread.replies} risposte
    </span>
    <span>
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>
      ${thread.views} visualizzazioni
    </span>
    <span>✍️ ${thread.author} · ${thread.time}</span>
  `;

  // Compose avatar
  document.getElementById('threadComposeAvatar').textContent = currentUser.initial;

  // Messages
  renderThreadMessages(id);

  document.getElementById('threadOverlay').classList.add('open');
  document.body.style.overflow = 'hidden';
}

function renderThreadMessages(id) {
  const messages = THREAD_MESSAGES[id] || [];
  const container = document.getElementById('threadDetailMessages');
  container.innerHTML = '';

  if (messages.length === 0) {
    container.innerHTML = `<div style="text-align:center;padding:2rem;color:var(--muted);font-size:0.8rem;">Nessun messaggio ancora. Sii il primo a rispondere!</div>`;
    return;
  }

  messages.forEach((msg, idx) => {
    const div = document.createElement('div');
    div.className = `thread-message${msg.isOp ? ' op' : ''}`;
    div.innerHTML = `
      <div class="thread-msg-avatar ${msg.isTeam ? 'team' : ''}">${msg.initial}</div>
      <div class="thread-msg-body">
        <div class="thread-msg-header">
          <span class="thread-msg-author ${msg.isTeam ? 'team-author' : ''}">${msg.author}</span>
          <span class="thread-msg-role">${msg.role}</span>
          <span class="thread-msg-time">${msg.time}</span>
        </div>
        <div class="thread-msg-text">${msg.text}</div>
        <div class="thread-msg-reactions">
          ${(msg.reactions || []).map(r => `<div class="thread-reaction">${r}</div>`).join('')}
        </div>
      </div>
    `;
    container.appendChild(div);

    if (idx === 0 && messages.length > 1) {
      const div2 = document.createElement('div');
      div2.className = 'thread-divider';
      div2.innerHTML = '<span>Risposte</span>';
      container.appendChild(div2);
    }
  });

  container.scrollTop = container.scrollHeight;
}

function closeThread() {
  document.getElementById('threadOverlay').classList.remove('open');
  document.body.style.overflow = '';
  currentThreadId = null;
  document.getElementById('threadComposeInput').value = '';
}

function handleThreadKey(e) {
  if (e.key === 'Enter' && (e.ctrlKey || e.metaKey)) submitThreadReply();
}

async function submitThreadReply() {
  const input = document.getElementById('threadComposeInput');
  const text  = input.value.trim();
  if (!text || !currentThreadId) return;

  const shortName = currentUser.name.split(' ')[0] + ' ' + (currentUser.name.split(' ')[1]||'?')[0] + '.';
  const newReply  = {
    author: shortName, initial: currentUser.initial,
    role: currentUser.title, isTeam: currentUser.role === 'team',
    time: 'Ora', text, isOp: false, reactions: []
  };

  // Ottimistic update
  if (!THREAD_MESSAGES[currentThreadId]) THREAD_MESSAGES[currentThreadId] = [];
  THREAD_MESSAGES[currentThreadId].push(newReply);

  const thread = DISCUSSIONS.find(d => d.id === currentThreadId);
  if (thread) { thread.replies++; thread.lastReply = `${currentUser.name.split(' ')[0]} · Ora`; }

  input.value = '';
  renderThreadMessages(currentThreadId);
  renderDiscussions();
  showToast('green', '💬', 'Risposta pubblicata con successo!');
  logActivity('blue', `<strong>${currentUser.name.split(' ')[0]}</strong> ha risposto in una discussione`);

  // Persisti su GAS
  if (GAS_URL && currentUser) {
    try {
      const url = `${GAS_URL}?action=add_reply` +
        `&discId=${currentThreadId}&author=${encodeURIComponent(shortName)}` +
        `&initial=${encodeURIComponent(currentUser.initial)}&role=${encodeURIComponent(currentUser.title)}` +
        `&text=${encodeURIComponent(text)}&isTeam=${currentUser.role === 'team'}`;
      await fetch(url);
      saveCommunityCache();
    } catch(e) { console.warn('[Reply] GAS error:', e.message); }
  }
}

/* New Thread Modal */
function openNewThreadModal() {
  document.getElementById('newThreadModal').classList.add('open');
  document.body.style.overflow = 'hidden';
  // Category chip selection
  document.querySelectorAll('#newThreadCategories .target-chip').forEach(chip => {
    chip.onclick = () => {
      document.querySelectorAll('#newThreadCategories .target-chip').forEach(c => c.classList.remove('active'));
      chip.classList.add('active');
    };
  });
}

function closeNewThreadModal() {
  document.getElementById('newThreadModal').classList.remove('open');
  document.body.style.overflow = '';
  document.getElementById('newThreadTitleInput').value = '';
  document.getElementById('newThreadBodyInput').value = '';
}

async function submitNewThread() {
  const title = document.getElementById('newThreadTitleInput').value.trim();
  const body  = document.getElementById('newThreadBodyInput').value.trim();
  if (!title) { showToast('red', '⚠️', 'Inserisci un titolo per il thread.'); return; }
  if (!body)  { showToast('red', '⚠️', 'Inserisci il messaggio iniziale.'); return; }

  const activeChip = document.querySelector('#newThreadCategories .target-chip.active');
  const cat        = activeChip ? activeChip.dataset.cat : 'general';
  const shortName  = currentUser.name.split(' ')[0] + ' ' + (currentUser.name.split(' ')[1]||'?')[0] + '.';

  // Ottimistic: aggiungi subito in locale
  const tempId = Date.now();
  DISCUSSIONS.unshift({
    id: tempId, category: cat, title,
    author: shortName, time: 'Ora', replies: 0, views: 1, pinned: false,
    lastReply: 'Nessuna risposta ancora'
  });
  THREAD_MESSAGES[tempId] = [{
    author: shortName, initial: currentUser.initial, role: currentUser.title,
    isTeam: currentUser.role === 'team', time: 'Ora', text: body, isOp: true, reactions: []
  }];

  closeNewThreadModal();
  renderDiscussions();
  showToast('gold', '✏️', 'Thread pubblicato con successo!');
  logActivity('blue', `<strong>${currentUser.name.split(' ')[0]}</strong> ha avviato una nuova discussione`);

  // Aggiorna contatore discussioni nel profilo in tempo reale
  const profDisc = document.getElementById('profileStatDiscussions');
  if (profDisc) profDisc.textContent = countUserDiscussions();

  // Persisti su GAS
  if (GAS_URL && currentUser) {
    try {
      const url = `${GAS_URL}?action=save_discussion` +
        `&category=${encodeURIComponent(cat)}&title=${encodeURIComponent(title)}` +
        `&body=${encodeURIComponent(body)}&author=${encodeURIComponent(shortName)}` +
        `&initial=${encodeURIComponent(currentUser.initial)}&role=${encodeURIComponent(currentUser.title)}` +
        `&isTeam=${currentUser.role === 'team'}`;
      const data = await fetch(url).then(r => r.json());
      if (data.success && data.discussion) {
        // Sostituisci tempId con ID reale del server
        const idx = DISCUSSIONS.findIndex(d => d.id === tempId);
        if (idx !== -1) DISCUSSIONS[idx].id = data.discussion.id;
        const msgs = THREAD_MESSAGES[tempId];
        if (msgs) {
          THREAD_MESSAGES[data.discussion.id] = msgs;
          delete THREAD_MESSAGES[tempId];
        }
        saveCommunityCache();
      }
    } catch(e) { console.warn('[NewThread] GAS error:', e.message); }
  }

  // Auto-open the new thread
  setTimeout(() => openThread(newId), 200);
}

function switchTab(context, value, el) {
  el.closest('.tab-row').querySelectorAll('.tab-btn').forEach(t => t.classList.remove('active'));
  el.classList.add('active');
  if (context === 'disc') renderDiscussions(value);
}

/* ═══════════════════════════════════════════
   RENDER CONVERSATIONS / MESSAGES
═══════════════════════════════════════════ */
function renderConversations() {
  const container = document.getElementById('convListContainer');
  container.innerHTML = CONVS.map(c => `
    <div class="conv-item ${currentConv === c.id ? 'active' : ''}" id="conv-${c.id}" onclick="openConv(${c.id})">
      <div class="conv-avatar" style="${c.type==='team' ? 'border-color:var(--gold-dim);color:var(--gold);' : ''}">
        ${c.initial}
        <div class="om-status ${c.status}" style="position:absolute;bottom:-1px;right:-1px;"></div>
      </div>
      <div class="conv-info">
        <div class="conv-name">${c.name}</div>
        <div class="conv-preview">${c.last}</div>
      </div>
      <div class="conv-meta">
        <div class="conv-time">${c.time}</div>
        ${c.unread > 0 ? `<div class="conv-unread">${c.unread}</div>` : ''}
      </div>
    </div>
  `).join('');
}

function openConv(id) {
  currentConv = id;
  const conv = CONVS.find(c => c.id === id);
  if (!conv) return;
  
  // Mark as read
  conv.unread = 0;
  renderConversations();

  const headerAvatar = document.getElementById('chatHeaderAvatar');
  headerAvatar.textContent = conv.initial;
  headerAvatar.style.borderColor = conv.type === 'team' ? 'var(--gold-dim)' : '';
  headerAvatar.style.color = conv.type === 'team' ? 'var(--gold)' : '';
  document.getElementById('chatHeaderName').textContent = conv.name;
  const statusEl = document.getElementById('chatHeaderStatus');
  statusEl.textContent = conv.status === 'online' ? '● Online' : conv.status === 'away' ? '● Away' : '○ Offline';
  statusEl.className = 'chat-header-status ' + (conv.status === 'online' ? '' : conv.status === 'away' ? 'offline' : 'offline');

  const messagesEl = document.getElementById('chatMessages');
  messagesEl.innerHTML = `<div class="chat-date-divider"><span>Oggi</span></div>`;
  conv.messages.forEach(msg => {
    messagesEl.innerHTML += `
      <div class="msg ${msg.from === 'me' ? 'sent' : 'received'}">
        ${msg.from !== 'me' ? `<div class="msg-avatar" style="${conv.type==='team'?'color:var(--gold);border-color:var(--gold-dim);':''}">${conv.initial}</div>` : ''}
        <div>
          <div class="msg-bubble">${msg.text}</div>
          <div class="msg-time">${msg.time}</div>
        </div>
        ${msg.from === 'me' ? `<div class="msg-avatar" style="color:var(--gold);border-color:var(--gold-dim);">${currentUser.initial}</div>` : ''}
      </div>`;
  });
  messagesEl.scrollTop = messagesEl.scrollHeight;
}

function handleChatKey(e) { if(e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); } }

function sendMessage() {
  const input = document.getElementById('chatInput');
  const text = input.value.trim();
  if (!text || !currentConv) return;
  
  const conv = CONVS.find(c => c.id === currentConv);
  if (!conv) return;
  
  conv.messages.push({ from:'me', text, time: new Date().getHours()+':'+String(new Date().getMinutes()).padStart(2,'0') });
  conv.last = text;
  input.value = '';
  openConv(currentConv);
  
  // Simulate reply after 2s
  setTimeout(() => {
    const replies = [
      'Grazie per il messaggio!', 'Capito, ti rispondo a breve.',
      'Ottima osservazione, ne terremo conto.',
      'Perfetto, procediamo in questo senso.',
    ];
    conv.messages.push({
      from:'them',
      text: replies[Math.floor(Math.random() * replies.length)],
      time: new Date().getHours()+':'+String(new Date().getMinutes()).padStart(2,'0')
    });
    conv.unread = 0;
    renderConversations();
    if (currentConv === conv.id) openConv(conv.id);
    showToast('blue', '💬', `Nuovo messaggio da ${conv.name}`);
  }, 2000 + Math.random() * 1000);
}

function filterConversations(query) {
  const items = document.querySelectorAll('.conv-item');
  items.forEach(item => {
    const name = item.querySelector('.conv-name').textContent.toLowerCase();
    item.style.display = name.includes(query.toLowerCase()) ? '' : 'none';
  });
}

/* ═══════════════════════════════════════════
   RENDER LISTINGS
═══════════════════════════════════════════ */
function renderListings() {
  const container = document.getElementById('listingsContainer');
  if (!container) return;

  const earlyAccessBanner = `
    <div style="background:rgba(212,175,55,0.06); border:1px solid rgba(212,175,55,0.2); border-radius:var(--radius); padding:0.7rem 1rem; margin-bottom:1.2rem; display:flex; align-items:center; gap:0.7rem; font-size:0.78rem; color:var(--gold);">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><polygon points="12,2 15.09,8.26 22,9.27 17,14.14 18.18,21.02 12,17.77 5.82,21.02 7,14.14 2,9.27 8.91,8.26"/></svg>
      Accesso anticipato esclusivo — Le proprietà saranno pubblicate non appena disponibili.
    </div>`;

  // Le listing vengono caricate esclusivamente da GAS (get_community_data → listings)
  const listings = typeof LISTINGS !== 'undefined' ? LISTINGS : [];

  if (listings.length === 0) {
    container.innerHTML = earlyAccessBanner + '<div style="text-align:center;padding:3rem 1rem;color:var(--muted2);font-size:0.82rem;">Nessuna proprietà disponibile al momento.<br>Il team aggiungerà presto le prime location esclusive.</div>';
    return;
  }

  const role = currentUser.role;
  const candidateNotice = role === 'candidate' ? `
    <div class="listing-candidate-notice">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>
      <span>Le prenotazioni anticipate sono riservate ai <strong>Founding Members</strong>. Effettua l'upgrade per accedere.</span>
    </div>` : '';

  container.innerHTML = earlyAccessBanner + candidateNotice + `
    <div class="grid-3">
      ${listings.map(l => `
        <div class="listing-card">
          <div class="listing-img">
            <div class="listing-img-text">${l.location || l.city || ''}</div>
            ${l.tag ? `<div class="listing-exclusive-tag">${l.tag}</div>` : ''}
          </div>
          <div class="listing-info">
            <div class="listing-city">${l.city || ''}</div>
            <div class="listing-name">${l.name || ''}</div>
            <div class="listing-desc">${l.desc || ''}</div>
          </div>
          <div class="listing-footer">
            <div><div class="listing-price">${l.price || ''} <span class="listing-price-unit">${l.unit || '/notte'}</span></div></div>
            ${role === 'candidate'
              ? '<span class="listing-book-btn locked-btn"><svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display:inline;margin-right:4px;vertical-align:middle;"><rect x="3" y="11" width="18" height="11" rx="2"/><path d="M7 11V7a5 5 0 0110 0v4"/></svg>Solo Founding</span>'
              : '<button class="listing-book-btn" onclick="showToast(\'gold\',\'🏠\',\'Richiesta prenotazione inviata al team!\')">Prenota</button>'}
          </div>
        </div>
      `).join('')}
    </div>`;
}


function renderSurveys() {
  const container = document.getElementById('surveysContainer');
  if (SURVEYS.length === 0) {
    container.innerHTML = '<div style="text-align:center;padding:3rem 1rem;color:var(--muted2);font-size:0.82rem;">Nessun sondaggio attivo al momento.<br>Il team pubblicherà presto le prime votazioni.</div>';
    return;
  }
  container.innerHTML = SURVEYS.map(s => `
    <div class="survey-card" id="survey-${s.id}">
      <div class="post-type-tag survey" style="margin-bottom:0.8rem;">📊 Sondaggio Attivo</div>
      <div class="survey-title">${s.title}</div>
      <div class="survey-desc">${s.desc}</div>
      ${s.options.map((o, i) => {
        const pct = s.voted ? Math.round(o.votes / s.total * 100) : 0;
        return `
        <div class="survey-option ${s.voted && s.myVote === i ? 'voted' : ''}" onclick="voteSurvey(${s.id}, ${i})">
          <div class="survey-progress" style="width:${pct}%"></div>
          <div class="survey-option-text">${o.text}</div>
          ${s.voted ? `<div class="survey-option-pct">${pct}%</div>` : ''}
        </div>`;
      }).join('')}
      <div class="survey-footer">
        <span>${s.total} voti totali</span>
        ${s.voted ? '<span class="text-gold">✓ Hai già votato</span>' : '<span>Vota per vedere i risultati</span>'}
      </div>
    </div>
  `).join('');
}

async function voteSurvey(surveyId, optionIndex) {
  const s = SURVEYS.find(s => s.id === surveyId);
  if (!s || s.voted) return;
  // Ottimistic update
  s.voted  = true;
  s.myVote = optionIndex;
  s.options[optionIndex].votes++;
  s.total++;
  renderSurveys();
  showToast('green', '✓', 'Voto registrato! Grazie per il tuo feedback.');
  saveCommunityCache();

  // Persisti su GAS
  if (GAS_URL && currentUser) {
    try {
      const url = `${GAS_URL}?action=save_vote&surveyId=${surveyId}&optionIdx=${optionIndex}&userName=${encodeURIComponent(currentUser.name)}`;
      await fetch(url);
    } catch(e) { console.warn('[Vote] GAS error:', e.message); }
  }
}

/* ═══════════════════════════════════════════
   RENDER NOTIFICATIONS
═══════════════════════════════════════════ */
function renderNotifications() {
  const colorMap = { message:'blue', update:'gold', like:'red', reply:'green', listing:'gold', system:'gold', event:'blue' };
  const container = document.getElementById('notifsContainer');
  const markAllBtn = document.getElementById('markAllReadBtn');

  if (NOTIFICATIONS.length === 0) {
    if (markAllBtn) markAllBtn.style.display = 'none';
    container.innerHTML = `
      <div class="notif-empty-state">
        <div class="notif-empty-icon">
          <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M18 8A6 6 0 006 8c0 7-3 9-3 9h18s-3-2-3-9"/><path d="M13.73 21a2 2 0 01-3.46 0"/></svg>
        </div>
        <div class="notif-empty-title">Nessuna notifica al momento</div>
        <div class="notif-empty-desc">Le notifiche appariranno qui in tempo reale non appena verranno generate da eventi della Community.</div>
      </div>`;
    return;
  }

  if (markAllBtn) markAllBtn.style.display = '';
  container.innerHTML = NOTIFICATIONS.map(n => `
    <div class="notif-item ${n.unread ? 'unread' : ''}" onclick="markNotifRead(${n.id})">
      <div class="notif-icon ${colorMap[n.type] || 'gold'}">${n.icon}</div>
      <div class="notif-content">
        <div class="notif-text">${n.text}</div>
        <div class="notif-time">${n.time}</div>
      </div>
      ${n.unread ? '<div class="notif-unread-dot"></div>' : ''}
    </div>
  `).join('');
}

function renderNotifDropdown() {
  const list = document.getElementById('notifDropdownList');

  if (NOTIFICATIONS.length === 0) {
    list.innerHTML = `
      <div class="notif-dropdown-empty">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M18 8A6 6 0 006 8c0 7-3 9-3 9h18s-3-2-3-9"/><path d="M13.73 21a2 2 0 01-3.46 0"/></svg>
        <span>Nessuna notifica al momento</span>
      </div>`;
    return;
  }

  list.innerHTML = NOTIFICATIONS.slice(0,5).map(n => `
    <div class="notif-dropdown-item ${n.unread ? 'unread' : ''}" onclick="markNotifRead(${n.id}); toggleNotifDropdown();">
      <div class="ndi-icon">${n.icon}</div>
      <div class="ndi-text">
        ${n.text}
        <div class="ndi-time">${n.time}</div>
      </div>
      ${n.unread ? '<div class="ndi-unread"></div>' : ''}
    </div>
  `).join('');
}

function toggleNotifDropdown() {
  document.getElementById('notifDropdown').classList.toggle('open');
}

function markNotifRead(id) {
  const n = NOTIFICATIONS.find(n => n.id === id);
  if (n && n.unread) {
    n.unread = false;
    notifCount = Math.max(0, notifCount - 1);
    updateNotifBadge();
    renderNotifications();
    renderNotifDropdown();
  }
}

function markAllRead() {
  NOTIFICATIONS.forEach(n => n.unread = false);
  notifCount = 0;
  updateNotifBadge();
  renderNotifications();
  renderNotifDropdown();
  document.getElementById('notifDropdown').classList.remove('open');
  showToast('green', '✓', 'Tutte le notifiche segnate come lette.');
}

function updateNotifBadge() {
  const badge    = document.getElementById('headerNotifCount');
  const navBadge = document.getElementById('notifNavBadge');
  if (!badge || !navBadge) return;

  // Unica fonte di verità: il numero di notifiche REALI non lette nell'array
  const realUnread = NOTIFICATIONS.filter(n => n.unread).length;
  notifCount = realUnread; // sincronizza sempre la variabile

  if (realUnread > 0) {
    badge.textContent = realUnread;
    badge.classList.remove('hidden');
    navBadge.textContent = realUnread;
    navBadge.classList.remove('hidden');
    navBadge.style.display = '';
  } else {
    // Azzera e nascondi — nessun badge residuo o hardcoded
    badge.textContent = '';
    badge.classList.add('hidden');
    navBadge.textContent = '';
    navBadge.classList.add('hidden');
    navBadge.style.display = 'none';
  }
}

function updateMsgBadge() {
  const badge = document.getElementById('msgBadge');
  if (unreadMsgs > 0) {
    badge.textContent = unreadMsgs;
    badge.style.display = '';
  } else {
    badge.style.display = 'none';
    badge.classList.add('hidden');
  }
}

/* ═══════════════════════════════════════════
   PROFILO: HELPER FUNCTIONS
═══════════════════════════════════════════ */

/* Converte data ISO o "GG/MM/AAAA - HH:MM" → "15 Novembre 2024" */
function formatJoinDate(raw) {
  if (!raw) return '—';
  const months = ['Gennaio','Febbraio','Marzo','Aprile','Maggio','Giugno',
                  'Luglio','Agosto','Settembre','Ottobre','Novembre','Dicembre'];
  try {
    // Formato ISO
    const d = new Date(raw);
    if (!isNaN(d.getTime())) return `${d.getDate()} ${months[d.getMonth()]} ${d.getFullYear()}`;
    // Formato GG/MM/AAAA
    const m = String(raw).match(/(\d{1,2})[\/\.](\d{2})[\/\.](\d{4})/);
    if (m) return `${parseInt(m[1])} ${months[parseInt(m[2])-1]} ${m[3]}`;
  } catch(_e) {}
  return String(raw);
}

/* Converte codice lingua → nome esteso */
function langCodeToName(code) {
  const map = { IT:'Italiano', EN:'English', FR:'Français', DE:'Deutsch', ES:'Español' };
  return map[(code||'IT').toUpperCase()] || 'Italiano';
}

/* ── Lettura/salvataggio preferenze notifiche ── */
const NOTIF_PREF_DEFAULTS = { project_updates:true, direct_messages:true, new_listings:true, post_replies:false };

function _notifPrefKey() {
  return currentUser ? `lh360_np_${currentUser.email.replace(/[^a-z0-9]/gi,'_')}` : null;
}
function loadNotifPrefs() {
  const k = _notifPrefKey();
  if (!k) return { ...NOTIF_PREF_DEFAULTS };
  try {
    const raw = localStorage.getItem(k);
    return raw ? { ...NOTIF_PREF_DEFAULTS, ...JSON.parse(raw) } : { ...NOTIF_PREF_DEFAULTS };
  } catch(_e) { return { ...NOTIF_PREF_DEFAULTS }; }
}
function saveNotifPrefsLocal(prefs) {
  const k = _notifPrefKey();
  if (!k) return;
  try { localStorage.setItem(k, JSON.stringify(prefs)); } catch(_e) {}
  // Sync background GAS
  if (typeof GAS_URL !== 'undefined' && GAS_URL && currentUser) {
    fetch(`${GAS_URL}?action=save_notif_prefs&email=${encodeURIComponent(currentUser.email)}&prefs=${encodeURIComponent(JSON.stringify(prefs))}`).catch(()=>{});
  }
}
function isNotifEnabled(prefKey) {
  const p = loadNotifPrefs();
  return p[prefKey] !== false;
}

/* Aggiunge una notifica reale rispettando le preferenze */
function addRealNotification(prefKey, icon, text) {
  if (!isNotifEnabled(prefKey)) return; // preferenza disabilitata → nessuna notifica
  const n = { id: Date.now() + Math.random(), icon, text, time: 'Ora', unread: true };
  NOTIFICATIONS.unshift(n);
  updateNotifBadge();
  renderNotifDropdown();
  const np = document.getElementById('panel-notifications');
  if (np && np.classList.contains('active')) renderNotifications();
}

/* ── Statistiche attività utente ── */
function _uStatsKey() {
  return currentUser ? `lh360_us_${currentUser.email.replace(/[^a-z0-9]/gi,'_')}` : null;
}
function loadUserStats() {
  const k = _uStatsKey();
  if (!k) return { readPosts: [] };
  try { const r = localStorage.getItem(k); return r ? JSON.parse(r) : { readPosts: [] }; }
  catch(_e) { return { readPosts: [] }; }
}
function saveUserStats(s) {
  const k = _uStatsKey(); if (!k) return;
  try { localStorage.setItem(k, JSON.stringify(s)); } catch(_e) {}
}
function markPostRead(postId) {
  if (!postId) return;
  const s = loadUserStats();
  if (s.readPosts.includes(postId)) return;
  s.readPosts.push(postId); saveUserStats(s);
  // Aggiorna il contatore nel profilo se visibile
  const el = document.getElementById('profileStatPostsRead');
  if (el) el.textContent = s.readPosts.length;
}
function countUserComments() {
  if (!currentUser) return 0;
  const name = currentUser.name;
  let n = 0;
  FEED_POSTS.forEach(p => {
    if (p.commentsData) n += p.commentsData.filter(c => c.author === name).length;
  });
  return n;
}
function countUserDiscussions() {
  if (!currentUser) return 0;
  return DISCUSSIONS.filter(d => d.author === currentUser.name).length;
}

/* IntersectionObserver: marca i post come letti quando scorrono nella viewport */
let _feedReadObserver = null;
function initFeedReadTracking() {
  if (_feedReadObserver) _feedReadObserver.disconnect();
  _feedReadObserver = new IntersectionObserver(entries => {
    entries.forEach(e => {
      if (e.isIntersecting) {
        const id = parseInt((e.target.id||'').replace('post-',''), 10);
        if (id) markPostRead(id);
      }
    });
  }, { threshold: 0.4 });
  document.querySelectorAll('.feed-post[id^="post-"]').forEach(el => _feedReadObserver.observe(el));
}

/* Toggle notifica dall'UI */
function toggleNotifPref(el) {
  const prefKey = el.dataset.pref;
  const nowOn = !el.classList.contains('off'); // stato attuale
  const newState = !nowOn;
  const inner = el.querySelector('div');
  if (newState) {
    el.classList.remove('off'); el.style.background='var(--gold)'; el.style.borderColor='var(--gold)';
    if (inner) { inner.style.left='calc(100% - 16px)'; inner.style.background='var(--darker)'; }
  } else {
    el.classList.add('off'); el.style.background='var(--dark5)'; el.style.borderColor='var(--border2)';
    if (inner) { inner.style.left='1px'; inner.style.background='var(--muted2)'; }
  }
  const prefs = loadNotifPrefs();
  prefs[prefKey] = newState;
  saveNotifPrefsLocal(prefs);
  const labels = { project_updates:'aggiornamenti progetto', direct_messages:'messaggi diretti',
                   new_listings:'nuovi listing', post_replies:'risposte ai post' };
  showToast(newState ? 'green' : 'blue', newState ? '🔔' : '🔕',
    `Notifiche ${labels[prefKey]||prefKey} ${newState ? 'abilitate' : 'disabilitate'}.`);
}

/* ═══════════════════════════════════════════
   RENDER PROFILE
═══════════════════════════════════════════ */
function renderProfile() {
  const role      = currentUser.role;
  const container = document.getElementById('profileContainer');

  // ── Dati reali dal profilo GAS ────────────────────────────────────────
  const joinDate  = formatJoinDate(currentUser.joinDate);
  const userLang  = langCodeToName(currentUser.lang);

  // ── Statistiche attività dinamiche ────────────────────────────────────
  const uStats     = loadUserStats();
  const readCount  = uStats.readPosts.length;
  const commCount  = countUserComments();
  const discCount  = countUserDiscussions();

  // ── Preferenze notifiche reali ────────────────────────────────────────
  const nprefs = loadNotifPrefs();

  const roleLabel = role === 'team' ? 'Team LuxHaven360' : role === 'founding' ? 'Founding Member' : 'Founder Candidate';
  const roleColor = role === 'team' ? 'var(--gold)' : role === 'founding' ? 'var(--green)' : 'var(--amber)';

  const notifToggles = [
    ['Aggiornamenti progetto','Ricevi notifiche per i nuovi aggiornamenti','project_updates'],
    ['Messaggi diretti','Notifiche per i tuoi messaggi','direct_messages'],
    ['Nuovi listing','Avvisi per i nuovi listing disponibili','new_listings'],
    ['Risposte ai tuoi post','Notifiche per le risposte','post_replies'],
  ];

  container.innerHTML = `
    <div class="profile-hero">
      <div class="profile-avatar-lg">
        ${currentUser.initial}
        <div class="status-dot"></div>
      </div>
      <div style="flex:1; min-width:0;">
        <div class="profile-name">${currentUser.name}</div>
        <div class="profile-membership">Membro dal ${joinDate}</div>
        <div class="profile-badges">
          <div class="profile-badge gold-badge">⭐ ${roleLabel}</div>
          <div class="profile-badge green-badge">✓ Verificato</div>
          ${role === 'founding' ? '<div class="profile-badge gold-badge">🏆 Early Founder</div>' : ''}
          ${role === 'team' ? '<div class="profile-badge gold-badge">🛡 Amministratore</div>' : ''}
        </div>
        <div class="profile-stats-row">
          <div class="profile-stat-item"><div class="ps-value" id="profileStatPostsRead">${readCount}</div><div class="ps-label">Post letti</div></div>
          <div class="profile-stat-item"><div class="ps-value" id="profileStatComments">${commCount}</div><div class="ps-label">Commenti</div></div>
          <div class="profile-stat-item"><div class="ps-value" id="profileStatDiscussions">${discCount}</div><div class="ps-label">Discussioni</div></div>
          <div class="profile-stat-item"><div class="ps-value" style="color:${roleColor}">#${currentUser.position || (role === 'team' ? '1' : '—')}</div><div class="ps-label">Posizione</div></div>
        </div>
      </div>
    </div>
    <div class="grid-2">
      <div class="card">
        <div style="font-size:0.65rem; letter-spacing:0.15em; text-transform:uppercase; color:var(--muted2); margin-bottom:0.8rem;">Informazioni Account</div>
        <div style="display:flex; flex-direction:column; gap:0.7rem;">
          ${[['Email', currentUser.email], ['Livello', roleLabel], ['Stato', 'Attivo · Online'], ['Lingua', userLang]].map(([k,v]) => `
            <div style="display:flex; justify-content:space-between; font-size:0.78rem; border-bottom:1px solid var(--border2); padding-bottom:0.5rem;">
              <span style="color:var(--muted)">${k}</span><span>${v}</span>
            </div>`).join('')}
        </div>
      </div>
      <div class="card">
        <div style="font-size:0.65rem; letter-spacing:0.15em; text-transform:uppercase; color:var(--muted2); margin-bottom:0.8rem;">Vantaggi Attivi</div>
        ${role === 'founding' || role === 'team' ? `
          <div style="display:flex; flex-direction:column; gap:0.5rem;">
            ${['Accesso anticipato ai listing esclusivi','Canale diretto con il team','Prenotazioni prioritarie','Status permanente Founding Member','Notifiche esclusive in tempo reale'].map(b => `
              <div style="display:flex;align-items:center;gap:0.5rem;font-size:0.78rem;padding:0.4rem 0;border-bottom:1px solid var(--border2);">
                <span style="color:var(--green);font-size:0.9rem;">✓</span> ${b}</div>`).join('')}
          </div>` : `
          <div style="display:flex; flex-direction:column; gap:0.5rem; margin-bottom:1rem;">
            ${['Aggiornamenti esclusivi','Anteprime contenuti','Accesso alla Community','Interazione e feedback'].map(b => `
              <div style="display:flex;align-items:center;gap:0.5rem;font-size:0.78rem;padding:0.4rem 0;border-bottom:1px solid var(--border2);">
                <span style="color:var(--green);">✓</span> ${b}</div>`).join('')}
          </div>
          <div style="padding-top:0.5rem;border-top:1px solid var(--border2);">
            <div style="font-size:0.7rem;color:var(--muted);margin-bottom:0.5rem;">Sblocca con Founding Member:</div>
            ${['Listing esclusivi','Prenotazioni anticipate','Canale diretto team','Status permanente'].map(b => `
              <div style="display:flex;align-items:center;gap:0.5rem;font-size:0.78rem;padding:0.3rem 0;color:var(--muted2);">
                <span style="color:var(--muted2);">🔒</span> ${b}</div>`).join('')}
          </div>
          <button class="upgrade-btn" style="margin-top:0.8rem;width:100%;" onclick="showToast('gold','⭐','Richiesta inviata! Il team ti contatterà.')">
            Richiedi Upgrade</button>`}
      </div>
    </div>
    <div class="card" style="margin-top:1rem;">
      <div style="font-size:0.65rem;letter-spacing:0.15em;text-transform:uppercase;color:var(--muted2);margin-bottom:1rem;">Impostazioni Notifiche</div>
      <div style="display:flex;flex-direction:column;gap:0.5rem;">
        ${notifToggles.map(([title, desc, prefKey]) => {
          const isOn = nprefs[prefKey] !== false;
          return `<div style="display:flex;align-items:center;justify-content:space-between;padding:0.6rem 0;border-bottom:1px solid var(--border2);">
            <div>
              <div style="font-size:0.78rem;color:var(--light);">${title}</div>
              <div style="font-size:0.68rem;color:var(--muted);margin-top:2px;">${desc}</div>
            </div>
            <div data-pref="${prefKey}" onclick="toggleNotifPref(this)" class="${isOn?'':'off'}"
              style="width:36px;height:20px;border-radius:10px;background:${isOn?'var(--gold)':'var(--dark5)'};border:1.5px solid ${isOn?'var(--gold)':'var(--border2)'};position:relative;cursor:pointer;flex-shrink:0;transition:all 0.2s;">
              <div style="width:14px;height:14px;background:${isOn?'var(--darker)':'var(--muted2)'};border-radius:50%;position:absolute;top:2px;left:${isOn?'calc(100% - 16px)':'1px'};transition:all 0.2s;"></div>
            </div>
          </div>`;
        }).join('')}
      </div>
    </div>`;
}

/* ═══════════════════════════════════════════
   RENDER MEMBERS TABLE (Admin)
═══════════════════════════════════════════ */
function renderMembersTable() {
  const tbody = document.getElementById('membersTable');
  if (!tbody) return;
  tbody.innerHTML = MEMBERS_DATA.map(m => `
    <tr>
      <td>
        <span class="member-row-avatar" style="${m.level==='founding'?'border-color:rgba(76,175,120,0.3);color:var(--green)':''}">${m.initial}</span>
        ${m.name}
      </td>
      <td><span class="level-pill ${m.level}">${m.level === 'founding' ? 'Founding Member' : 'Candidate'}</span></td>
      <td style="color:var(--muted)">${m.joined}</td>
      <td style="color:var(--muted)">${m.last}</td>
      <td>
        <span style="display:inline-flex; align-items:center; gap:0.3rem; font-size:0.68rem;">
          <span class="om-status ${m.status}" style="position:static; border:none;"></span>
          ${m.status === 'online' ? '<span style="color:var(--green)">Online</span>' : m.status === 'away' ? '<span style="color:var(--amber)">Away</span>' : '<span style="color:var(--muted2)">Offline</span>'}
        </span>
      </td>
      <td>
        <div style="display:flex; gap:0.3rem; flex-wrap:wrap;">
          ${m.level === 'candidate' ? `<button class="action-btn-sm promote" onclick="promoteMember('${m.name}')">↑ Promuovi</button>` : ''}
          <button class="action-btn-sm message" onclick="showToast('blue','💬','DM inviato a ${m.name}')">Messaggio</button>
          <button class="action-btn-sm warn" onclick="showToast('red','⚠️','Avviso inviato a ${m.name}')">Avviso</button>
        </div>
      </td>
    </tr>
  `).join('');
}

function promoteMember(name) {
  const m = MEMBERS_DATA.find(m => m.name === name);
  if (m && m.level === 'candidate') {
    m.level = 'founding';
    renderMembersTable();
    showToast('gold', '⭐', `${name} promosso a Founding Member!`);
    logActivity('gold', `<strong>${name}</strong> è diventato Founding Member`);
  }
}

/* ═══════════════════════════════════════════
   RENDER MODERATION
═══════════════════════════════════════════ */
function renderModeration() {
  const container = document.getElementById('moderationContainer');
  if (!container) return;
  
  container.innerHTML = `
    <div class="tab-row" style="margin-bottom:1rem;">
      <div class="tab-btn active">Segnalazioni (${REPORTS.length})</div>
      <div class="tab-btn">Contenuti Rimossi (0)</div>
      <div class="tab-btn">Log Attività</div>
    </div>
    ${REPORTS.length === 0 ? '<div style="text-align:center; padding:2rem; color:var(--muted);">Nessuna segnalazione attiva.</div>' : ''}
    ${REPORTS.map(r => `
      <div class="report-card" id="report-${r.id}">
        <div class="report-header">
          <span class="report-type">${r.type}</span>
          <span style="font-size:0.7rem; color:var(--muted);">Segnalato da: <strong style="color:var(--light)">${r.reporter}</strong></span>
          <span style="font-size:0.7rem; color:var(--muted2); margin-left:auto;">${r.time}</span>
        </div>
        <div style="font-size:0.72rem; color:var(--muted); margin-bottom:0.4rem;">Target: ${r.target}</div>
        <div class="report-content">${r.content}</div>
        <div class="report-actions">
          <button class="mod-btn remove" onclick="resolveReport(${r.id}, 'remove')">🗑 Rimuovi contenuto</button>
          <button class="mod-btn warn-user" onclick="resolveReport(${r.id}, 'warn')">⚠ Avvisa utente</button>
          <button class="mod-btn dismiss" onclick="resolveReport(${r.id}, 'dismiss')">✓ Archivia</button>
        </div>
      </div>
    `).join('')}`;
}

function resolveReport(id, action) {
  const idx = REPORTS.findIndex(r => r.id === id);
  if (idx > -1) {
    REPORTS.splice(idx, 1);
    renderModeration();
    const msgs = { remove:'Contenuto rimosso con successo.', warn:'Avviso inviato all\'utente.', dismiss:'Segnalazione archiviata.' };
    showToast('green', '✓', msgs[action]);
    document.getElementById('modBadge').textContent = REPORTS.length;
    if (REPORTS.length === 0) document.getElementById('modBadge').classList.add('hidden');
  }
}

/* ═══════════════════════════════════════════
   RENDER RIGHT PANEL
═══════════════════════════════════════════ */
function renderRightPanel() {
  // ── Membri Online ─────────────────────────────────────────────────────
  const list = document.getElementById('onlineMembersList');
  const liveRpIndicator = document.getElementById('liveIndicatorRp');

  if (!list) return;

  if (ONLINE_MEMBERS.length === 0) {
    list.innerHTML = `
      <div style="padding:1rem 0 0.5rem; color:var(--muted2); font-size:0.72rem; text-align:center;">
        Nessun membro online al momento
      </div>`;
  } else {
    list.innerHTML = ONLINE_MEMBERS.map(m => {
      const isTeam     = m.role === 'team';
      const roleLabel  = isTeam ? 'Team' : m.role === 'founding' ? 'Founding Member' : 'Founder Candidate';
      const nameColor  = isTeam ? 'var(--gold)' : 'var(--light)';
      return `
      <div class="online-member">
        <div class="om-avatar" style="background:var(--dark4); border:1px solid var(--border2); color:${isTeam ? 'var(--gold)' : 'var(--muted)'};">
          ${m.initial}
          <div class="om-status online"></div>
        </div>
        <div style="min-width:0;">
          <div class="om-name" style="color:${nameColor};">${m.name}</div>
          <div class="om-role-tag ${isTeam ? 'gold' : ''}">${roleLabel}</div>
        </div>
      </div>`;
    }).join('');
  }

  // ── Prossimi Eventi ────────────────────────────────────────────────────
  const eventsEl = document.getElementById('upcomingEvents');
  if (!eventsEl) return;

  // Controlla se c'è un evento live attivo
  const hasLive = EVENTS.some(e => e.isLive);
  if (liveRpIndicator) liveRpIndicator.style.display = hasLive ? 'block' : 'none';

  // Filtra: mostra eventi non completati e non terminati — live O futuri
  const now    = Date.now();
  const visible = EVENTS.filter(e => {
    if (e.isCompleted || e.isEnded) return false;
    if (e.isLive) return true;
    try { return new Date(e.dateIso).getTime() >= now; }
    catch(_e) { return false; }
  });

  if (visible.length === 0) {
    eventsEl.innerHTML = `
      <div style="padding:0.8rem 0; color:var(--muted2); font-size:0.72rem; text-align:center; line-height:1.6;">
        Non sono presenti eventi al momento
      </div>`;
    return;
  }

  eventsEl.innerHTML = visible.map(e => {
    const dateLabel = e.isLive ? 'LIVE ORA' : formatEventDate(e.dateIso);
    const metaParts = [];
    if (e.timeStr) metaParts.push(e.timeStr);
    if (e.meta)    metaParts.push(e.meta);
    const metaStr   = metaParts.join(' · ');
    return `
    <div class="event-card-sm" data-event-id="${e.id}">
      ${e.isLive ? '<div class="live-indicator" style="margin-bottom:0.3rem;"><div class="live-dot"></div> Live ora</div>' : ''}
      <div class="event-date-sm ${e.isLive ? 'text-gold' : ''}">${dateLabel}</div>
      <div class="event-title-sm">${e.title}</div>
      ${metaStr ? `<div class="event-meta-sm">${metaStr}</div>` : ''}
      ${currentUser && currentUser.role === 'team' ? `
        <div style="display:flex; gap:0.4rem; margin-top:0.4rem; flex-wrap:wrap;">
          <button onclick="toggleEventLive(${e.id}, ${!e.isLive})" style="font-size:0.62rem; padding:2px 7px; border-radius:4px; border:1px solid ${e.isLive?'var(--amber)':'var(--green)'}; background:transparent; color:${e.isLive?'var(--amber)':'var(--green)'}; cursor:pointer;">
            ${e.isLive ? '⏹ Stop Live' : '▶ Vai Live'}
          </button>
          <button onclick="endEventUI(${e.id})" style="font-size:0.62rem; padding:2px 7px; border-radius:4px; border:1px solid var(--amber); background:transparent; color:var(--amber); cursor:pointer;">⏏ Termina</button>
          <button onclick="completeEventUI(${e.id})" style="font-size:0.62rem; padding:2px 7px; border-radius:4px; border:1px solid var(--green); background:transparent; color:var(--green); cursor:pointer;">✔ Completa</button>
          <button onclick="deleteEventUI(${e.id})" style="font-size:0.62rem; padding:2px 7px; border-radius:4px; border:1px solid var(--border2); background:transparent; color:var(--muted2); cursor:pointer;">✕ Elimina</button>
        </div>` : ''}
    </div>`;
  }).join('');
}

/* Formatta una data ISO in "15 Mar 2025" */
function formatEventDate(iso) {
  if (!iso) return '';
  const months = ['Gen','Feb','Mar','Apr','Mag','Giu','Lug','Ago','Set','Ott','Nov','Dic'];
  try {
    const d = new Date(iso);
    if (isNaN(d.getTime())) return iso;
    return `${d.getDate()} ${months[d.getMonth()]} ${d.getFullYear()}`;
  } catch(_e) { return iso; }
}

/* ═══════════════════════════════════════════
   RENDER WEEKLY CHART
═══════════════════════════════════════════ */
function renderWeeklyChart() {
  const chart = document.getElementById('weeklyChart');
  if (!chart) return;
  const data = [42, 68, 35, 89, 71, 54, 93];
  const max = Math.max(...data);
  chart.innerHTML = data.map((v, i) => `
    <div class="chart-bar" style="height:${(v/max*100)}%;" title="${['Lun','Mar','Mer','Gio','Ven','Sab','Dom'][i]}: ${v} azioni"></div>
  `).join('');
}

/* ═══════════════════════════════════════════
   BROADCAST (Admin)
═══════════════════════════════════════════ */
function toggleChip(el) { el.classList.toggle('active'); }
function toggleChipSingle(el, group) {
  el.closest('.broadcast-target').querySelectorAll('.target-chip').forEach(c => c.classList.remove('active'));
  el.classList.add('active');
}
async function publishBroadcast() {
  const titleEl   = document.getElementById('broadcastTitle');
  const contentEl = document.getElementById('broadcastContent');
  const title   = titleEl.value.trim();
  const content = contentEl.value.trim();
  if (!title || !content) { showToast('red','⚠️','Compila tutti i campi obbligatori.'); return; }

  // Determina tipo dal chip selezionato
  const typeChip = document.querySelector('.broadcast-target .target-chip.active');
  const typeMap  = { 'update':'update', 'exclusive':'exclusive', 'news':'news' };
  const postType = typeChip ? (typeMap[typeChip.dataset.type] || 'update') : 'update';

  const lockedChip = document.querySelector('.broadcast-target .target-chip[data-lock].active');
  const locked     = lockedChip ? 'candidate' : '';

  // Ottimistic: aggiungi subito in locale
  const tempId = Date.now();
  const newPost = {
    id: tempId, author: currentUser.name, initial: currentUser.initial,
    role: currentUser.title, type: postType, time: 'Ora',
    title, text: content, locked, likes: 0, comments: 0, liked: false,
    commentsData: [], likedBy: [], ts: new Date().toISOString()
  };
  FEED_POSTS.unshift(newPost);
  renderFeed();
  renderFeedPreview();

  showToast('gold','📢','Comunicazione pubblicata con successo!');
  logActivity('gold', `<strong>${currentUser.name}</strong> ha pubblicato un aggiornamento`);
  showPanel('feed', document.querySelector('.nav-item'));
  titleEl.value   = '';
  contentEl.value = '';

  // Persisti su GAS
  if (GAS_URL) {
    try {
      const url = `${GAS_URL}?action=publish_post` +
        `&author=${encodeURIComponent(currentUser.name)}` +
        `&initial=${encodeURIComponent(currentUser.initial)}` +
        `&role=${encodeURIComponent(currentUser.title)}` +
        `&type=${encodeURIComponent(postType)}` +
        `&title=${encodeURIComponent(title)}` +
        `&text=${encodeURIComponent(content)}` +
        `&locked=${encodeURIComponent(locked)}`;
      const data = await fetch(url).then(r => r.json());
      if (data.success && data.post) {
        // Aggiorna ID locale con quello reale dal server
        const idx = FEED_POSTS.findIndex(p => p.id === tempId);
        if (idx !== -1) FEED_POSTS[idx].id = data.post.id;
        saveCommunityCache();
        loadDashboardStats();
      }
    } catch(e) {
      console.warn('[Broadcast] GAS error:', e.message);
    }
  }
}

/* ═══════════════════════════════════════════
   TOAST SYSTEM
═══════════════════════════════════════════ */
function showToast(color, icon, text) {
  const container = document.getElementById('toastContainer');
  const toast = document.createElement('div');
  toast.className = 'toast';
  toast.innerHTML = `
    <div class="toast-icon ${color}">${icon}</div>
    <div class="toast-text">${text}</div>
    <button class="toast-close" onclick="this.parentElement.remove()">
      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
    </button>`;
  container.appendChild(toast);
  setTimeout(() => {
    toast.classList.add('out');
    setTimeout(() => toast.remove(), 300);
  }, 3500);
}

/* ═══════════════════════════════════════════
   REAL-TIME SIMULATION
═══════════════════════════════════════════ */
/* ═══════════════════════════════════════════
   PRESENZA REAL-TIME
═══════════════════════════════════════════ */
const HEARTBEAT_INTERVAL = 2 * 60 * 1000; // ogni 2 minuti
let _heartbeatTimer = null;
let _presencePollTimer = null;

/* Invia heartbeat a GAS — segnala che l'utente è online */
async function sendHeartbeat() {
  if (!GAS_URL || !currentUser) return;
  try {
    await fetch(`${GAS_URL}?action=heartbeat` +
      `&email=${encodeURIComponent(currentUser.email)}` +
      `&name=${encodeURIComponent(currentUser.name)}` +
      `&initial=${encodeURIComponent(currentUser.initial)}` +
      `&role=${encodeURIComponent(currentUser.role)}`);
  } catch(_e) {}
}

/* Rimuove la presenza quando l'utente si disconnette/chiude */
async function removePresence() {
  if (!GAS_URL || !currentUser) return;
  try {
    await fetch(`${GAS_URL}?action=remove_presence&email=${encodeURIComponent(currentUser.email)}`);
  } catch(_e) {}
}

/* Aggiorna la lista membri online dal payload GAS */
function applyPresenceData(onlineList) {
  if (!Array.isArray(onlineList)) return;
  ONLINE_MEMBERS.length = 0;
  onlineList.forEach(u => ONLINE_MEMBERS.push(u));
  saveOnlineCache();
  renderRightPanel();

  // Aggiorna anche il contatore nella dashboard
  const countEl = document.getElementById('dashOnlineCount');
  if (countEl) countEl.textContent = ONLINE_MEMBERS.length;
}

/* Aggiorna la lista eventi dal payload GAS */
function applyEventsData(eventsList) {
  if (!Array.isArray(eventsList)) return;
  const _snapshot = [...eventsList]; // snapshot prima di svuotare, evita bug self-reference
  EVENTS.length = 0;
  _snapshot.forEach(e => EVENTS.push(e));

  // Re-inietta gli eventi pendenti locali che il server non conosce ancora
  if (_pendingLocalEvents.length > 0) {
    const serverIds = new Set(_snapshot.map(e => e._localId || e.id));
    _pendingLocalEvents = _pendingLocalEvents.filter(pe => {
      if (serverIds.has(pe._localId)) return false; // il server lo ha già → rimuovi dal pending
      EVENTS.push(pe); // ancora non sul server → mantienilo visibile
      return true;
    });
    EVENTS.sort((a, b) => new Date(a.dateIso) - new Date(b.dateIso));
  }
  renderRightPanel();

  // Aggiorna anche la label "In Diretta" nell'header
  const hasLive = EVENTS.some(e => e.isLive);
  const headerLive = document.getElementById('headerLiveIndicator');
  if (headerLive) headerLive.style.display = hasLive ? 'flex' : 'none';

  // Persisti gli eventi in cache locale per rendering immediato al prossimo caricamento
  saveEventsCache();
}

/* Inizia la presenza: heartbeat immediato + timer */
function startPresenceSystem() {
  sendHeartbeat(); // immediato
  if (_heartbeatTimer) clearInterval(_heartbeatTimer);
  _heartbeatTimer = setInterval(sendHeartbeat, HEARTBEAT_INTERVAL);

  // Segnala presenza come "offline" quando l'utente chiude/lascia la pagina
  window.addEventListener('beforeunload', removePresence);
  window.addEventListener('visibilitychange', () => {
    if (document.visibilityState === 'visible') {
      sendHeartbeat(); // ritorna dalla tab → heartbeat immediato
    }
  });
}

/* Funzione placeholder — sostituta dalla simulazione fake */
function startRealTimeSimulation() {
  // Rimpiazzata da startPresenceSystem() — nessuna simulazione
}

/* ─── Toggle evento live (solo team) ─── */
async function toggleEventLive(eventId, goLive) {
  if (!GAS_URL) return;
  try {
    const r = await fetch(`${GAS_URL}?action=set_event_live&eventId=${eventId}&live=${goLive}`);
    const d = await r.json();
    if (d.success) {
      const ev = EVENTS.find(e => e.id === eventId);
      if (ev) ev.isLive = goLive;
      applyEventsData(EVENTS);
      showToast(goLive ? 'gold' : 'blue', goLive ? '🔴' : '⏹',
        goLive ? 'Evento impostato come LIVE!' : 'Live terminato.');
    }
  } catch(_e) { showToast('red','⚠️','Errore aggiornamento evento.'); }
}

/* ─── Elimina evento (solo team) ─── */
async function deleteEventUI(eventId) {
  if (!GAS_URL) return;
  try {
    const r = await fetch(`${GAS_URL}?action=delete_event&eventId=${eventId}`);
    const d = await r.json();
    if (d.success) {
      const idx = EVENTS.findIndex(e => e.id === eventId);
      if (idx !== -1) EVENTS.splice(idx, 1);
      applyEventsData(EVENTS);
      showToast('green','✓','Evento eliminato.');
    }
  } catch(_e) { showToast('red','⚠️','Errore eliminazione evento.'); }
}


/* ═══════════════════════════════════════════
   GESTIONE EVENTI (Admin)
═══════════════════════════════════════════ */
async function createEventUI() {
  const title   = (document.getElementById('eventTitleInput')?.value   || '').trim();
  const dateVal = (document.getElementById('eventDateInput')?.value    || '').trim();
  const timeStr = (document.getElementById('eventTimeStrInput')?.value || '').trim();
  const meta    = (document.getElementById('eventMetaInput')?.value    || '').trim();

  if (!title)   { showToast('red','⚠️','Il titolo è obbligatorio.'); return; }
  if (!dateVal) { showToast('red','⚠️','La data è obbligatoria.'); return; }
  const dateIso = new Date(dateVal).toISOString();

  const _localId = 'local_' + Date.now();

  if (GAS_URL) {
    try {
      const r = await fetch(`${GAS_URL}?action=save_event` +
        `&title=${encodeURIComponent(title)}&dateIso=${encodeURIComponent(dateIso)}` +
        `&timeStr=${encodeURIComponent(timeStr)}&meta=${encodeURIComponent(meta)}`);
      const d = await r.json();
      if (d.success && d.event) {
        // Rimuovi l'eventuale pending locale corrispondente
        _pendingLocalEvents = _pendingLocalEvents.filter(pe => pe._localId !== _localId);
        EVENTS.push(d.event);
        EVENTS.sort((a,b) => new Date(a.dateIso) - new Date(b.dateIso));
        applyEventsData(EVENTS);
        renderEventsAdminList();
        ['eventTitleInput','eventDateInput','eventTimeStrInput','eventMetaInput']
          .forEach(id => { const el=document.getElementById(id); if(el) el.value=''; });
        showToast('gold','📅','Evento creato con successo!');
        return;
      } else {
        showToast('red','⚠️', 'GAS error: ' + (d.error || 'risposta inattesa'));
      }
    } catch(_e) {
      showToast('amber','⚠️','GAS non raggiungibile: ' + _e.message);
    }
  }
  // Fallback locale: l'evento viene tracciato come pending finché GAS non lo conferma
  const newEvt = { _localId, id: Date.now(), title, dateIso, timeStr, meta, accessLevel:'all', isLive:false, createdAt:new Date().toISOString() };
  _pendingLocalEvents.push(newEvt);
  EVENTS.push(newEvt);
  EVENTS.sort((a,b) => new Date(a.dateIso) - new Date(b.dateIso));
  applyEventsData(EVENTS);
  renderEventsAdminList();
  ['eventTitleInput','eventDateInput','eventTimeStrInput','eventMetaInput']
    .forEach(id => { const el=document.getElementById(id); if(el) el.value=''; });
  showToast('amber','📅','Evento salvato localmente (GAS non raggiungibile — non persisterà al refresh).');
}

function renderEventsAdminList() {
  const container = document.getElementById('eventsAdminList');
  if (!container) return;
  if (EVENTS.length === 0) {
    container.innerHTML = '<div style="font-size:0.72rem;color:var(--muted2);padding:0.5rem 0;">Nessun evento creato.</div>';
    return;
  }
  container.innerHTML = EVENTS.map(e => `
    <div style="display:flex;align-items:center;justify-content:space-between;padding:0.5rem 0;border-bottom:1px solid var(--border2);gap:0.5rem;">
      <div style="min-width:0;flex:1;">
        <div style="font-size:0.75rem;color:var(--light);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${e.title}</div>
        <div style="font-size:0.65rem;color:var(--muted2);">${formatEventDate(e.dateIso)}${e.timeStr?' · '+e.timeStr:''}</div>
        ${e.isLive ? '<span style="font-size:0.6rem;color:var(--amber);letter-spacing:0.1em;">● LIVE</span>' : ''}
      </div>
      <div style="display:flex;gap:0.3rem;flex-shrink:0;">
        <button onclick="toggleEventLiveAdmin(${e.id},${!e.isLive})"
          style="font-size:0.62rem;padding:2px 8px;border-radius:4px;border:1px solid ${e.isLive?'var(--amber)':'var(--green)'};background:transparent;color:${e.isLive?'var(--amber)':'var(--green)'};cursor:pointer;">
          ${e.isLive?'⏹ Stop':'▶ Live'}
        </button>
        <button onclick="endEventAdmin(${e.id})"
          style="font-size:0.62rem;padding:2px 8px;border-radius:4px;border:1px solid var(--amber);background:transparent;color:var(--amber);cursor:pointer;">⏏ Termina</button>
        <button onclick="completeEventAdmin(${e.id})"
          style="font-size:0.62rem;padding:2px 8px;border-radius:4px;border:1px solid var(--green);background:transparent;color:var(--green);cursor:pointer;">✔ Completa</button>
        <button onclick="deleteEventAdmin(${e.id})"
          style="font-size:0.62rem;padding:2px 7px;border-radius:4px;border:1px solid var(--border2);background:transparent;color:var(--muted2);cursor:pointer;">✕ Elimina</button>
      </div>
    </div>`).join('');
}

async function toggleEventLiveAdmin(eventId, goLive) {
  await toggleEventLive(eventId, goLive);
  renderEventsAdminList();
}

async function endEventUI(eventId) {
  if (!GAS_URL) return;
  try {
    const r = await fetch(`${GAS_URL}?action=complete_event&eventId=${eventId}&mode=end`);
    const d = await r.json();
    if (d.success) {
      const idx = EVENTS.findIndex(e => e.id === eventId);
      if (idx !== -1) EVENTS[idx].isEnded = true;
      applyEventsData(EVENTS);
      showToast('amber','⏏','Evento terminato.');
    }
  } catch(_e) {
    // fallback locale
    const idx = EVENTS.findIndex(e => e.id === eventId);
    if (idx !== -1) { EVENTS[idx].isEnded = true; applyEventsData(EVENTS); }
    showToast('amber','⏏','Evento terminato localmente.');
  }
  renderEventsAdminList();
}

async function completeEventUI(eventId) {
  if (!GAS_URL) return;
  try {
    const r = await fetch(`${GAS_URL}?action=complete_event&eventId=${eventId}&mode=complete`);
    const d = await r.json();
    if (d.success) {
      const idx = EVENTS.findIndex(e => e.id === eventId);
      if (idx !== -1) EVENTS[idx].isCompleted = true;
      applyEventsData(EVENTS);
      showToast('gold','✔','Evento completato.');
    }
  } catch(_e) {
    const idx = EVENTS.findIndex(e => e.id === eventId);
    if (idx !== -1) { EVENTS[idx].isCompleted = true; applyEventsData(EVENTS); }
    showToast('amber','✔','Evento completato localmente.');
  }
  renderEventsAdminList();
}

async function endEventAdmin(eventId)      { await endEventUI(eventId);      renderEventsAdminList(); }
async function completeEventAdmin(eventId) { await completeEventUI(eventId); renderEventsAdminList(); }

async function deleteEventAdmin(eventId) {
  await deleteEventUI(eventId);
  renderEventsAdminList();
}

/* Logica broadcast e aggiorna la lista eventi admin ora integrata nella showPanel originale */

function initGlobalSearch() {
  const input = document.getElementById('globalSearch');
  if (!input) return;
  input.addEventListener('input', function() {
    const q = this.value.trim().toLowerCase();
    if (!q) {
      document.querySelectorAll('.feed-post, .discussion-thread, .listing-card').forEach(el => el.style.display = '');
      return;
    }
    document.querySelectorAll('.feed-post').forEach(el => {
      el.style.display = el.textContent.toLowerCase().includes(q) ? '' : 'none';
    });
    document.querySelectorAll('.discussion-thread').forEach(el => {
      el.style.display = el.textContent.toLowerCase().includes(q) ? '' : 'none';
    });
    document.querySelectorAll('.listing-card').forEach(el => {
      el.style.display = el.textContent.toLowerCase().includes(q) ? '' : 'none';
    });
  });
}
</script>
</body>
</html>
