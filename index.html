<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>LuxHaven360 - Eccellenza Immobiliare</title>
    <link rel="stylesheet" href="styles.css" />
</head>
<body>
    <div id="intro-loader">
        <div class="intro-content">
            <div class="intro-logo-wrapper">
                <img src="assets/logo-azienda.png" alt="LuxHaven360" class="intro-logo">
            </div>
            <div class="intro-divider"></div>
            <h2 class="intro-tagline">Eccellenza Senza Compromessi</h2>
            <div class="intro-progress-bar">
                <div class="intro-progress-fill"></div>
            </div>
        </div>
    </div>

    <nav id="navbar">
        <div class="nav-content">
            <div class="logo" onclick="showSection('home')">LuxHaven360</div>
            <div class="mobile-toggle" onclick="toggleMenu()">
                <span></span><span></span><span></span>
            </div>
            <ul class="nav-links" id="navLinks">
                <li><a href="#" onclick="showSection('home')">Home</a></li>
                <li><a href="#" onclick="showSection('properties')">Immobili</a></li>
                <li><a href="#" onclick="showSection('supercars')">Supercar</a></li>
                <li><a href="#" onclick="showSection('stays')">Esperienze</a></li>
                <li><a href="#" onclick="showSection('shop')">Shop</a></li>
                <li><a href="#" onclick="showSection('contact')">Contatti</a></li>
                <li id="trackingIcon" class="cart-icon" onclick="window.location.href='product-details/tracking-order.html'" title="Traccia i tuoi ordini" style="display: none;">üì¶</li>
                <li id="cartIcon" class="cart-icon" onclick="window.location.href='product-details/cart.html'">üõí</li>
            </ul>
        </div>
    </nav>

    <section class="hero" id="home">
        <div class="hero-bg"></div>
        <div class="hero-pattern"></div>
        <div class="hero-content">
            <h1 class="hero-title"><img src="assets/logo-azienda.png" alt="LuxHaven360 Logo" /></h1>
            <p class="hero-subtitle">Eccellenza Senza Compromessi</p>
            <div class="cta-buttons">
                <a href="#" class="btn btn-primary" onclick="showSection('properties')">Esplora Propriet√†</a>
                <a href="#" class="btn" onclick="showSection('contact')">Contattaci</a>
            </div>
        </div>
        <div class="scroll-indicator"><div class="scroll-line"></div></div>
    </section>

    <section class="section" id="properties">
        <h2 class="section-title">Immobili Esclusivi</h2>
        <div class="grid" id="propertiesGrid"></div>
    </section>

    <section class="section" id="supercars">
        <h2 class="section-title">Supercar Collection</h2>
        <div class="grid" id="supercarsGrid"></div>
    </section>

    <section class="section" id="stays">
        <h2 class="section-title">Esperienze Esclusive</h2>
        <div class="grid" id="staysGrid"></div>
    </section>

    <section class="section" id="shop">
        <h2 class="section-title">Merchandising Ufficiale</h2>
        <div class="grid" id="shopGrid"></div>
    </section>

    <section class="section" id="contact">
        <h2 class="section-title">Contattaci</h2>
        <div class="contact-content">
            <div class="about-content" style="margin-bottom: 3rem;">
                <p class="about-text">
                    LuxHaven360 rappresenta l'eccellenza nel settore immobiliare e automotive di alto livello. 
                    Offriamo un servizio personalizzato e discreto per clienti che ricercano propriet√† 
                    straordinarie ed esperienze indimenticabili.
                </p>
            </div>
            <form class="contact-form" onsubmit="event.preventDefault(); alert('Messaggio inviato con successo! Ti contatteremo presto.');">
                <div class="form-group">
                    <label for="name">Nome</label>
                    <input type="text" id="name" required />
                </div>
                <div class="form-group">
                    <label for="email">Email</label>
                    <input type="email" id="email" required />
                </div>
                <div class="form-group">
                    <label for="interest">Interesse</label>
                    <select id="interest" style="padding: 1rem; background: rgba(26, 26, 26, 0.5); border: 1px solid rgba(212, 175, 55, 0.3); color: var(--light);">
                        <option>Immobili</option>
                        <option>Supercar</option>
                        <option>Esperienze</option>
                        <option>Shop</option>
                        <option>Altro</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="message">Messaggio</label>
                    <textarea id="message" required></textarea>
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%;">Invia Richiesta</button>
            </form>
        </div>
    </section>

    <footer>
        <div class="footer-content">
            <p class="footer-text">¬© 2025 LuxHaven360. Tutti i diritti riservati.</p>
            <p class="footer-text" style="margin-top: 0.5rem;">Privacy Policy | Terms of Service</p>
        </div>
    </footer>

    <script src="script.js"></script>
    <script>
        // *** SCRIPT DA AGGIUNGERE IN index.html NELLA SEZIONE <script> FINALE ***
// Sostituisce completamente la funzione updateTrackingIcon() esistente

const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbzYjct3AE7ML_mSnwwIo4hz8550bEANbt7tTkVrDcWTRT2rc-_MCMUYYaDOSb0JswE/exec';

let trackingRetryCount = 0;
const TRACKING_MAX_RETRIES = 3;

window.onload = function() {
    const introLoader = document.getElementById('intro-loader');
    if (introLoader) {
        document.body.style.overflow = 'hidden';
        setTimeout(() => {
            introLoader.classList.add('fade-out');
            document.body.style.overflow = '';
            setTimeout(() => { introLoader.style.display = 'none'; }, 800);
        }, 4000);
    }

    const hash = window.location.hash.substring(1);
    if (hash && typeof showSection === 'function') showSection(hash);
    
    updateCartIcon();
    // *** Avvio tracking con nuovo sistema robusto ***
    updateTrackingIconRobust();
};

function updateCartIcon() {
    const cart = JSON.parse(localStorage.getItem('lh360_cart')) || [];
    const totalQty = cart.reduce((sum, item) => sum + (item.qty || 1), 0);
    const cartIcon = document.getElementById('cartIcon');
    if (cartIcon) {
         if (totalQty > 0) cartIcon.classList.add('show');
         else cartIcon.classList.remove('show');
    }
}

// *** NUOVO: Sistema robusto per tracking icon che funziona su mobile ***
function updateTrackingIconRobust() {
    const trackingIcon = document.getElementById('trackingIcon');
    if (!trackingIcon) return;

    console.log('üîç Controllo tracking icon...');

    // 1. Cleanup ordini vecchi PRIMA del controllo
    cleanupOldOrders();
    
    // 2. Controllo Locale Ottimistico
    const hasLocal = checkLocalStorageForActiveOrders();
    
    if (hasLocal) {
        console.log('‚úÖ Ordini locali trovati, mostro icona');
        if (trackingIcon.style.display !== 'block') {
            trackingIcon.style.display = 'block';
        }
    } else {
        console.log('‚ÑπÔ∏è Nessun ordine locale, nascondo icona temporaneamente');
        trackingIcon.style.display = 'none';
    }

    // 3. Verifica Server con Retry Automatico
    fetchActiveOrdersWithRetry(trackingIcon);
}

function fetchActiveOrdersWithRetry(icon) {
    attemptFetchActiveOrders(icon);
}

function attemptFetchActiveOrders(icon) {
    const callbackName = 'handleActiveOrdersCount_' + Date.now() + '_' + trackingRetryCount;
    const script = document.createElement('script');
    
    // *** FIX MOBILE: Timeout pi√π lungo e parametri cache-busting ***
    const timestamp = Date.now();
    script.src = `${WEB_APP_URL}?get_active_count=1&callback=${callbackName}&t=${timestamp}&retry=${trackingRetryCount}&nocache=${Math.random()}`;
    
    // *** FIX MOBILE: Timeout aumentato a 15 secondi ***
    const timeout = setTimeout(() => {
        console.warn(`‚ö†Ô∏è Timeout API tracking (tentativo ${trackingRetryCount + 1}/${TRACKING_MAX_RETRIES})`);
        cleanupScript();
        handleTrackingRetry(icon);
    }, 15000);

    window[callbackName] = function(response) {
        clearTimeout(timeout);
        console.log('‚úÖ Risposta server tracking ricevuta:', response);
        
        if (response && typeof response.count === 'number') {
            if (response.count > 0) {
                console.log(`‚úÖ ${response.count} ordini attivi confermati dal server`);
                if (icon.style.display !== 'block') {
                    icon.style.display = 'block';
                }
            } else {
                console.log('‚ÑπÔ∏è Nessun ordine attivo sul server');
                if (icon.style.display !== 'none') {
                    icon.style.display = 'none';
                }
                clearAllLocalOrderData();
            }
            // Reset retry count su successo
            trackingRetryCount = 0;
        } else {
            console.warn('‚ö†Ô∏è Risposta server tracking invalida');
            handleTrackingRetry(icon);
        }
        cleanupScript();
    };
    
    script.onerror = () => {
        clearTimeout(timeout);
        console.error(`‚ùå Errore caricamento script tracking (tentativo ${trackingRetryCount + 1}/${TRACKING_MAX_RETRIES})`);
        cleanupScript();
        handleTrackingRetry(icon);
    };
    
    function cleanupScript() {
        try {
            if (script.parentNode) document.body.removeChild(script);
            delete window[callbackName];
        } catch (e) {}
    }
    
    document.body.appendChild(script);
    console.log(`üîÑ Tentativo ${trackingRetryCount + 1}/${TRACKING_MAX_RETRIES} - Verifica ordini attivi...`);
}

function handleTrackingRetry(icon) {
    trackingRetryCount++;
    
    if (trackingRetryCount < TRACKING_MAX_RETRIES) {
        // *** FIX MOBILE: Delay progressivo tra i retry ***
        const delay = trackingRetryCount * 3000; // 3s, 6s, 9s
        console.log(`‚è≥ Nuovo tentativo tracking tra ${delay}ms...`);
        setTimeout(() => attemptFetchActiveOrders(icon), delay);
    } else {
        console.warn('‚ö†Ô∏è Tutti i tentativi tracking falliti, mantengo stato locale');
        trackingRetryCount = 0; // Reset per future chiamate
        // Non tocchiamo l'icona: manteniamo lo stato locale ottimistico
    }
}

function clearAllLocalOrderData() {
    console.log('üóëÔ∏è Pulizia dati ordini locali...');
    localStorage.removeItem('lh360_pending_order');
    localStorage.removeItem('lh360_last_order_id');
    localStorage.removeItem('lh360_order_confirmed_time');
    
    for (let i = localStorage.length - 1; i >= 0; i--) {
        const key = localStorage.key(i);
        if (key && (
            key.startsWith('lh360_order_') ||
            key.startsWith('lh360_pending_') ||
            key.startsWith('lh360_order_time_') ||
            key === 'lh360_last_product' ||
            key === 'lh360_selected_sku'
        )) {
            localStorage.removeItem(key);
            console.log(`  üóëÔ∏è Rimossa key: ${key}`);
        }
    }
}

function checkLocalStorageForActiveOrders() {
    const now = new Date();
    const thirtyDaysAgo = new Date(now.getTime() - (30 * 24 * 60 * 60 * 1000));
    const twoDaysAgo = new Date(now.getTime() - (2 * 24 * 60 * 60 * 1000));
    
    const activeStates = ['Confermato', 'In Preparazione', 'In Transito'];
    
    // Check 1: Ordine pending
    const pendingOrder = localStorage.getItem('lh360_pending_order');
    if (pendingOrder) {
        try {
            const order = JSON.parse(pendingOrder);
            const orderDate = new Date(order.timestamp || order.data);
            
            if (!isNaN(orderDate.getTime()) && orderDate > thirtyDaysAgo) {
                if (activeStates.includes(order.stato)) {
                    console.log('  ‚úì Pending attivo:', order.id, order.stato);
                    return true;
                }
                
                if (order.stato === 'Consegnato') {
                    const deliveryDate = parseDeliveryDate(order.consegna_prevista);
                    if (deliveryDate && deliveryDate > twoDaysAgo) {
                        console.log('  ‚úì Consegnato recente (<2 giorni):', order.id);
                        return true;
                    }
                }
            }
        } catch (e) {
            console.error('Errore parsing pending order:', e);
        }
    }
    
    // Check 2: Timestamp ordini individuali
    for (let i = 0; i < localStorage.length; i++) {
        const key = localStorage.key(i);
        if (key && key.startsWith('lh360_order_time_')) {
            const timestamp = localStorage.getItem(key);
            if (timestamp) {
                const orderDate = new Date(timestamp);
                if (!isNaN(orderDate.getTime()) && orderDate > thirtyDaysAgo) {
                    console.log('  ‚úì Timestamp recente:', key);
                    return true;
                }
            }
        }
    }
    
    // Check 3: Ultimo ordine registrato
    const lastOrderTime = localStorage.getItem('lh360_order_confirmed_time');
    if (lastOrderTime) {
        const orderDate = new Date(lastOrderTime);
        if (!isNaN(orderDate.getTime()) && orderDate > thirtyDaysAgo) {
            console.log('  ‚úì Confirmed time recente');
            return true;
        }
    }
    
    return false;
}

function parseDeliveryDate(dateStr) {
    if (!dateStr || dateStr === 'Da definire') return null;
    
    try {
        const months = {
            'gennaio': 0, 'febbraio': 1, 'marzo': 2, 'aprile': 3,
            'maggio': 4, 'giugno': 5, 'luglio': 6, 'agosto': 7,
            'settembre': 8, 'ottobre': 9, 'novembre': 10, 'dicembre': 11
        };
        
        const match = dateStr.match(/(\d{1,2})\s+(\w+)\s+(\d{4})/);
        if (match) {
            const day = parseInt(match[1]);
            const monthName = match[2].toLowerCase();
            const year = parseInt(match[3]);
            if (months[monthName] !== undefined) {
                return new Date(year, months[monthName], day);
            }
        }
        
        const parts = dateStr.split('/');
        if (parts.length === 3) {
            return new Date(parts[2], parts[1] - 1, parts[0]);
        }
    } catch (e) {
        console.error('Errore parsing data consegna:', e);
    }
    
    return null;
}

function cleanupOldOrders() {
    const thirtyDaysAgo = new Date(Date.now() - (30 * 24 * 60 * 60 * 1000));
    
    // Rimuovi pending order se vecchio
    const pendingOrder = localStorage.getItem('lh360_pending_order');
    if (pendingOrder) {
        try {
            const order = JSON.parse(pendingOrder);
            const orderDate = new Date(order.timestamp || order.data);
            if (orderDate < thirtyDaysAgo) {
                localStorage.removeItem('lh360_pending_order');
                console.log('  üóëÔ∏è Rimosso pending order vecchio');
            }
        } catch (e) {}
    }
    
    // Rimuovi timestamp vecchi
    for (let i = localStorage.length - 1; i >= 0; i--) {
        const key = localStorage.key(i);
        if (key && key.startsWith('lh360_order_time_')) {
            const timestamp = localStorage.getItem(key);
            if (timestamp) {
                const orderDate = new Date(timestamp);
                if (orderDate < thirtyDaysAgo) {
                    localStorage.removeItem(key);
                    console.log('  üóëÔ∏è Rimosso timestamp vecchio:', key);
                }
            }
        }
    }
    
    // Rimuovi confirmed_time se vecchio
    const lastOrderTime = localStorage.getItem('lh360_order_confirmed_time');
    if (lastOrderTime) {
        const orderDate = new Date(lastOrderTime);
        if (orderDate < thirtyDaysAgo) {
            localStorage.removeItem('lh360_order_confirmed_time');
            console.log('  üóëÔ∏è Rimosso confirmed_time vecchio');
        }
    }
}

// Listener per cambiamenti localStorage (cross-tab sync)
window.addEventListener('storage', (event) => {
    if (event.key === 'lh360_cart') {
        updateCartIcon();
    }
    if (event.key && (event.key.startsWith('lh360_order_') || event.key.startsWith('lh360_pending_'))) {
        console.log('üîÑ Cambio localStorage rilevato, aggiorno tracking icon');
        trackingRetryCount = 0; // Reset retry count
        updateTrackingIconRobust();
    }
});

// *** NUOVO: Aggiorna icone periodicamente ma con rate limiting intelligente ***
let lastTrackingUpdate = 0;
const TRACKING_UPDATE_COOLDOWN = 5 * 60 * 1000; // 5 minuti

setInterval(() => {
    const now = Date.now();
    if (now - lastTrackingUpdate > TRACKING_UPDATE_COOLDOWN) {
        console.log('üîÑ Update periodico tracking icon');
        lastTrackingUpdate = now;
        trackingRetryCount = 0; // Reset retry count
        updateTrackingIconRobust();
    }
}, 5 * 60 * 1000);
    </script>
</body>
</html>


