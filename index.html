<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>LuxHaven360 - Eccellenza Immobiliare</title>
    <link rel="stylesheet" href="styles.css" />
</head>
<body>
    <!-- Navigation -->
    <nav id="navbar">
        <div class="nav-content">
            <div class="logo" onclick="showSection('home')">LuxHaven360</div>
            <div class="mobile-toggle" onclick="toggleMenu()">
                <span></span><span></span><span></span>
            </div>
            <ul class="nav-links" id="navLinks">
                <li><a href="#" onclick="showSection('home')">Home</a></li>
                <li><a href="#" onclick="showSection('properties')">Immobili</a></li>
                <li><a href="#" onclick="showSection('supercars')">Supercar</a></li>
                <li><a href="#" onclick="showSection('stays')">Esperienze</a></li>
                <li><a href="#" onclick="showSection('shop')">Shop</a></li>
                <li><a href="#" onclick="showSection('contact')">Contatti</a></li>
                <!-- Icona Tracciamento Ordini (NASCOSTA di default, NO flash) -->
                <li id="trackingIcon" class="cart-icon" style="display: none !important; opacity: 0; visibility: hidden;" onclick="window.location.href='product-details/tracking-order.html'" title="Traccia i tuoi ordini">üì¶</li>
                <li id="cartIcon" class="cart-icon" onclick="window.location.href='product-details/cart.html'">üõí</li>
            </ul>
        </div>
    </nav>

    <!-- Hero Section -->
    <section class="hero" id="home">
        <div class="hero-bg"></div>
        <div class="hero-pattern"></div>
        <div class="hero-content">
            <h1 class="hero-title"><img src="assets/logo-azienda.png" alt="LuxHaven360 Logo" /></h1>
            <p class="hero-subtitle">Eccellenza Senza Compromessi</p>
            <div class="cta-buttons">
                <a href="#" class="btn btn-primary" onclick="showSection('properties')">Esplora Propriet√†</a>
                <a href="#" class="btn" onclick="showSection('contact')">Contattaci</a>
            </div>
        </div>
        <div class="scroll-indicator"><div class="scroll-line"></div></div>
    </section>

    <!-- Properties Section (popolata dinamicamente) -->
    <section class="section" id="properties">
        <h2 class="section-title">Immobili Esclusivi</h2>
        <div class="grid" id="propertiesGrid">
            <!-- cards caricate dinamicamente -->
        </div>
    </section>

    <!-- Supercars Section (popolata dinamicamente) -->
    <section class="section" id="supercars">
        <h2 class="section-title">Supercar Collection</h2>
        <div class="grid" id="supercarsGrid">
            <!-- cards caricate dinamicamente -->
        </div>
    </section>

    <!-- Stays Section (popolata dinamicamente) -->
    <section class="section" id="stays">
        <h2 class="section-title">Esperienze Esclusive</h2>
        <div class="grid" id="staysGrid">
            <!-- cards caricate dinamicamente -->
        </div>
    </section>

    <!-- Shop Section (popolata dinamicamente) -->
    <section class="section" id="shop">
        <h2 class="section-title">Merchandising Ufficiale</h2>
        <div class="grid" id="shopGrid">
            <!-- cards caricate dinamicamente -->
        </div>
    </section>

    <!-- Contact Section -->
    <section class="section" id="contact">
        <h2 class="section-title">Contattaci</h2>
        <div class="contact-content">
            <div class="about-content" style="margin-bottom: 3rem;">
                <p class="about-text">
                    LuxHaven360 rappresenta l'eccellenza nel settore immobiliare e automotive di alto livello. 
                    Offriamo un servizio personalizzato e discreto per clienti che ricercano propriet√† 
                    straordinarie ed esperienze indimenticabili.
                </p>
            </div>
            <form class="contact-form" onsubmit="event.preventDefault(); alert('Messaggio inviato con successo! Ti contatteremo presto.');">
                <div class="form-group">
                    <label for="name">Nome</label>
                    <input type="text" id="name" required />
                </div>
                <div class="form-group">
                    <label for="email">Email</label>
                    <input type="email" id="email" required />
                </div>
                <div class="form-group">
                    <label for="interest">Interesse</label>
                    <select id="interest" style="padding: 1rem; background: rgba(26, 26, 26, 0.5); border: 1px solid rgba(212, 175, 55, 0.3); color: var(--light);">
                        <option>Immobili</option>
                        <option>Supercar</option>
                        <option>Esperienze</option>
                        <option>Shop</option>
                        <option>Altro</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="message">Messaggio</label>
                    <textarea id="message" required></textarea>
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%;">Invia Richiesta</button>
            </form>
        </div>
    </section>

    <!-- Footer -->
    <footer>
        <div class="footer-content">
            <p class="footer-text">¬© 2025 LuxHaven360. Tutti i diritti riservati.</p>
            <p class="footer-text" style="margin-top: 0.5rem;">Privacy Policy | Terms of Service</p>
        </div>
    </footer>

    <script src="script.js"></script>
    <script>
        // URL della Web App Google Apps Script
        const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbyiDu50VIVwzJ3qQNCWZmSk-_ovC7iBvxJGUYriRc3-PwMRbsgi8wb0baqxk3nLxti2/exec';

        // Gestione hash per anchor link esterni
        window.onload = function() {
            const hash = window.location.hash.substring(1);
            if (hash && typeof showSection === 'function') {
                showSection(hash);
            }
            updateCartIcon();
            updateTrackingIcon(); // NUOVO: Check ordini attivi
        };

        // Funzione per aggiornare la visibilit√† dell'icona carrello
        function updateCartIcon() {
            const cart = JSON.parse(localStorage.getItem('lh360_cart')) || [];
            const totalQty = cart.reduce((sum, item) => sum + (item.qty || 1), 0);
            const cartIcon = document.getElementById('cartIcon');
            if (totalQty > 0) {
                cartIcon.classList.add('show');
            } else {
                cartIcon.classList.remove('show');
            }
        }

        /**
         * AGGIORNATA: Icona tracking SENZA flash
         * Mostra SOLO dopo conferma definitiva (localStorage + API agreement)
         */
        function updateTrackingIcon() {
            const trackingIcon = document.getElementById('trackingIcon');
            
            // CRITICAL: Tripla protezione contro flash
            trackingIcon.style.display = 'none';
            trackingIcon.style.opacity = '0';
            trackingIcon.style.visibility = 'hidden';
            
            // NON mostrare basandosi solo su localStorage (causa flash)
            // Attendi conferma API prima di decidere
            
            const callbackName = 'handleActiveOrdersCount_' + Date.now();
            const script = document.createElement('script');
            script.src = `${WEB_APP_URL}?get_active_count=1&callback=${callbackName}&t=${Date.now()}`;
            
            const timeout = setTimeout(() => {
                // Timeout: usa localStorage come fallback SOLO se veramente sicuro
                const hasActiveOrders = checkForActiveOrders();
                if (hasActiveOrders) {
                    showIcon();
                    console.log('‚ö†Ô∏è API timeout, icona mostrata da localStorage fallback');
                } else {
                    console.log('‚ùå API timeout, nessun ordine attivo');
                }
                cleanup();
            }, 5000);
            
            window[callbackName] = function(response) {
                clearTimeout(timeout);
                console.log('üì° Risposta API tracking icon:', response);
                
                // API √® l'UNICA autorit√† - ignora localStorage se API dice "no"
                if (response && response.count > 0) {
                    showIcon();
                    console.log('‚úÖ Icona tracking mostrata (API conferma:', response.count, 'ordini attivi)');
                } else {
                    // API dice "no ordini" ‚Üí NASCONDI sempre (anche se localStorage diceva s√¨)
                    hideIcon();
                    console.log('‚ùå Icona tracking nascosta (API: 0 ordini attivi)');
                    
                    // Cleanup localStorage per evitare futuri flash
                    if (response && response.count === 0) {
                        cleanupInactiveOrders();
                    }
                }
                
                cleanup();
            };
            
            script.onerror = () => {
                clearTimeout(timeout);
                console.error('‚ùå Errore API tracking icon');
                
                // Errore API: usa localStorage ma con cautela estrema
                const hasActiveOrders = checkForActiveOrders();
                if (hasActiveOrders) {
                    showIcon();
                    console.log('‚ö†Ô∏è API error, icona mostrata da localStorage fallback');
                } else {
                    hideIcon();
                }
                cleanup();
            };
            
            function showIcon() {
                trackingIcon.style.display = 'block';
                trackingIcon.style.opacity = '1';
                trackingIcon.style.visibility = 'visible';
            }
            
            function hideIcon() {
                trackingIcon.style.display = 'none';
                trackingIcon.style.opacity = '0';
                trackingIcon.style.visibility = 'hidden';
            }
            
            function cleanup() {
                try {
                    if (script.parentNode) document.body.removeChild(script);
                    delete window[callbackName];
                } catch (e) {}
            }
            
            document.body.appendChild(script);
        }

        /**
         * Controlla se ci sono ORDINI ATTIVI in localStorage
         * 
         * LOGICA ORDINE ATTIVO:
         * 1. Stati sempre attivi: "Confermato", "In Preparazione", "In Transito"
         * 2. Stato "Consegnato": attivo SOLO se consegna < 2 giorni fa
         * 3. Data ordine < 30 giorni (filtro generale)
         */
        function checkForActiveOrders() {
            const now = new Date();
            const thirtyDaysAgo = new Date(now.getTime() - (30 * 24 * 60 * 60 * 1000));
            const twoDaysAgo = new Date(now.getTime() - (2 * 24 * 60 * 60 * 1000));
            
            // Stati sempre attivi (senza limite temporale oltre i 30 giorni)
            const alwaysActiveStates = ['Confermato', 'In Preparazione', 'In Transito'];
            
            // Check 1: Ordine pending (sempre considerato attivo se recente)
            const pendingOrder = localStorage.getItem('lh360_pending_order');
            if (pendingOrder) {
                try {
                    const order = JSON.parse(pendingOrder);
                    const orderDate = parseOrderDate(order.timestamp || order.data);
                    
                    if (orderDate && orderDate > thirtyDaysAgo) {
                        const stato = order.stato || 'In Preparazione';
                        
                        if (alwaysActiveStates.includes(stato)) {
                            console.log('‚úì Ordine pending ATTIVO:', order.id, '(stato:', stato + ')');
                            return true;
                        }
                        
                        if (stato === 'Consegnato') {
                            const deliveryDate = parseOrderDate(order.consegna_prevista || order.data);
                            if (deliveryDate && deliveryDate > twoDaysAgo) {
                                console.log('‚úì Ordine pending ATTIVO:', order.id, '(consegnato < 2 giorni fa)');
                                return true;
                            }
                        }
                    }
                } catch (e) {
                    console.error('Errore parsing pending order:', e);
                }
            }
            
            // Check 2: Timestamp ordini con verifica < 30 giorni
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key && key.startsWith('lh360_order_time_')) {
                    const timestamp = localStorage.getItem(key);
                    if (timestamp) {
                        const orderDate = new Date(timestamp);
                        if (!isNaN(orderDate.getTime()) && orderDate > thirtyDaysAgo) {
                            // Assumiamo che se c'√® un timestamp recente, l'ordine √® attivo
                            // (stati specifici vengono verificati da API)
                            console.log('‚úì Trovato timestamp ordine recente:', key);
                            return true;
                        }
                    }
                }
            }
            
            // Check 3: Ordine confermato recente (timestamp principale)
            const lastOrderTime = localStorage.getItem('lh360_order_confirmed_time');
            if (lastOrderTime) {
                const orderDate = new Date(lastOrderTime);
                if (!isNaN(orderDate.getTime()) && orderDate > thirtyDaysAgo) {
                    console.log('‚úì Trovato ordine confermato recente');
                    return true;
                }
            }
            
            console.log('‚ÑπÔ∏è Nessun ordine attivo trovato in localStorage');
            return false;
        }

        /**
         * Parse date da vari formati
         */
        function parseOrderDate(dateStr) {
            if (!dateStr) return null;
            
            // ISO format
            let date = new Date(dateStr);
            if (!isNaN(date.getTime())) return date;
            
            // dd/MM/yyyy format
            const parts = dateStr.toString().split('/');
            if (parts.length === 3) {
                date = new Date(parts[2], parts[1] - 1, parts[0]);
                if (!isNaN(date.getTime())) return date;
            }
            
            // "14 novembre 2025" format
            const italianMonths = {
                'gennaio': 0, 'febbraio': 1, 'marzo': 2, 'aprile': 3,
                'maggio': 4, 'giugno': 5, 'luglio': 6, 'agosto': 7,
                'settembre': 8, 'ottobre': 9, 'novembre': 10, 'dicembre': 11
            };
            
            const match = dateStr.toString().match(/(\d{1,2})\s+(\w+)\s+(\d{4})/);
            if (match) {
                const day = parseInt(match[1]);
                const monthName = match[2].toLowerCase();
                const year = parseInt(match[3]);
                
                if (italianMonths[monthName] !== undefined) {
                    date = new Date(year, italianMonths[monthName], day);
                    if (!isNaN(date.getTime())) return date;
                }
            }
            
            return null;
        }

        /**
         * Cleanup: Rimuovi ordini inattivi da localStorage
         */
        function cleanupInactiveOrders() {
            const now = new Date();
            const thirtyDaysAgo = new Date(now.getTime() - (30 * 24 * 60 * 60 * 1000));
            const twoDaysAgo = new Date(now.getTime() - (2 * 24 * 60 * 60 * 1000));
            
            // Cleanup pending order se non pi√π attivo
            const pendingOrder = localStorage.getItem('lh360_pending_order');
            if (pendingOrder) {
                try {
                    const order = JSON.parse(pendingOrder);
                    const orderDate = parseOrderDate(order.timestamp || order.data);
                    
                    let shouldRemove = false;
                    
                    if (!orderDate || orderDate < thirtyDaysAgo) {
                        shouldRemove = true;
                    } else if (order.stato === 'Consegnato') {
                        const deliveryDate = parseOrderDate(order.consegna_prevista || order.data);
                        if (deliveryDate && deliveryDate < twoDaysAgo) {
                            shouldRemove = true;
                        }
                    }
                    
                    if (shouldRemove) {
                        localStorage.removeItem('lh360_pending_order');
                        console.log('üóëÔ∏è Rimosso ordine pending non pi√π attivo:', order.id);
                    }
                } catch (e) {}
            }
            
            // Cleanup timestamp vecchi
            for (let i = localStorage.length - 1; i >= 0; i--) {
                const key = localStorage.key(i);
                if (key && key.startsWith('lh360_order_time_')) {
                    const timestamp = localStorage.getItem(key);
                    if (timestamp) {
                        const orderDate = new Date(timestamp);
                        if (orderDate < thirtyDaysAgo) {
                            localStorage.removeItem(key);
                            console.log('üóëÔ∏è Rimosso timestamp vecchio:', key);
                        }
                    }
                }
            }
        }

        // Listener per cambiamenti in localStorage (per aggiornamenti cross-tab)
        window.addEventListener('storage', (event) => {
            if (event.key === 'lh360_cart') {
                updateCartIcon();
            }
            // Aggiorna anche tracking icon se viene salvato un nuovo ordine
            if (event.key && event.key.startsWith('lh360_order_')) {
                updateTrackingIcon();
            }
        });

        // Aggiorna icone periodicamente (ogni 5 minuti)
        setInterval(() => {
            updateTrackingIcon();
        }, 5 * 60 * 1000);
    </script>
</body>
</html>
