<!DOCTYPE html>
<html lang="it">
<head>
    <script src="error-handler.js" defer></script>
<script src="./siteguard-client.js"></script>
    <meta charset="UTF-8" />
    <!-- â•â• PERFORMANCE: DNS prefetch & preconnect â•â• -->
    <link rel="preconnect" href="https://script.google.com" crossorigin>
    <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
    <link rel="dns-prefetch" href="https://www.google.com">
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>LuxHaven360 - Eccellenza Immobiliare</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/lipis/flag-icons@7.0.0/css/flag-icons.min.css">
    <link rel="stylesheet" href="styles.css" />
    <link rel="stylesheet" href="connection-monitor.css" />
    <script src="translations.js"></script>
    <script src="translations-brief-descriptions.js"></script>
    <script src="i18n.js"></script>
    <link rel="stylesheet" href="lang-selector.css" />
</head>
<body>
    <!-- ========================================
         INTRO LOADER
         ======================================== -->
    <div id="intro-loader">
        <div class="intro-content">
            <div class="intro-logo-wrapper">
                <img src="assets/logo-azienda.png" alt="LuxHaven360" class="intro-logo">
            </div>
            <div class="intro-divider"></div>
            <h2 class="intro-tagline" data-i18n="intro_tagline">Eccellenza Senza Compromessi</h2>
            <div class="intro-progress-bar">
                <div class="intro-progress-fill"></div>
            </div>
        </div>
    </div>

    <!-- ========================================
         NAVBAR
         ======================================== -->
    <nav id="navbar">
        <div class="nav-content">
            <div class="logo" onclick="showSection('home')">LuxHaven360</div>
            <div class="mobile-toggle" onclick="toggleMenu()">
                <span></span><span></span><span></span>
            </div>
            <ul class="nav-links" id="navLinks">
                <li><a href="#" onclick="showSection('home')" data-i18n="nav_home">Home</a></li>
                <li><a href="#" onclick="showSection('properties')" data-i18n="nav_properties">Immobili</a></li>
                <li><a href="#" onclick="showSection('supercars')" data-i18n="nav_supercars">Supercar</a></li>
                <li><a href="#" onclick="showSection('stays')" data-i18n="nav_stays">Esperienze</a></li>
                <li><a href="#" onclick="showSection('shop')" data-i18n="nav_shop">Shop</a></li>
                <li><a href="#" onclick="showSection('contact')" data-i18n="nav_contact">Contatti</a></li>
                <li id="trackingIcon" class="cart-icon" onclick="window.location.href='product-details/tracking-order.html?view=all'" data-i18n-title="nav_tracking_title" style="display: none;">ðŸ“¦</li>
                <li id="cartIcon" class="cart-icon" onclick="window.location.href='product-details/cart.html'" data-i18n-title="nav_cart_title">ðŸ›’</li>
            </ul>

            <!-- SELETTORE LINGUA -->
            <div class="lang-selector" id="languageSelector">
               <button class="lang-selector-toggle">
                        <span class="current-lang-flag fi fi-it"></span>
                        <span class="current-lang-code">IT</span>
                        <svg class="chevron-icon" width="12" height="12" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                    </svg>
                </button>
                
                <div class="lang-dropdown">
                    <button class="lang-option" data-lang="it">
                       <span class="lang-flag fi fi-it"></span>
                       <span class="lang-name">Italiano</span>
                    </button>
                    <button class="lang-option" data-lang="en">
                       <span class="lang-flag fi fi-gb"></span>
                       <span class="lang-name">English</span>
                    </button>
                    <button class="lang-option" data-lang="fr">
                       <span class="lang-flag fi fi-fr"></span>
                       <span class="lang-name">FranÃ§ais</span>
                    </button>
                   <button class="lang-option" data-lang="de">
                       <span class="lang-flag fi fi-de"></span>
                       <span class="lang-name">Deutsch</span>
                   </button>
                   <button class="lang-option" data-lang="es">
                       <span class="lang-flag fi fi-es"></span>
                       <span class="lang-name">EspaÃ±ol</span>
                   </button>
                </div>
            </div>
        </div>
    </nav>

    <!-- ========================================
         HERO SECTION
         ======================================== -->
    <section class="hero" id="home" style="display: flex;">
        <div class="hero-bg"></div>
        <div class="hero-pattern"></div>
        <div class="hero-content">
            <h1 class="hero-title">
                <img src="assets/logo-azienda.png" alt="LuxHaven360 Logo" fetchpriority="high" decoding="async" />
            </h1>
            <p class="hero-subtitle" data-i18n="hero_tagline">Eccellenza Senza Compromessi</p>
            <div class="cta-buttons">
                <a href="#" class="btn btn-primary" onclick="showSection('properties')" data-i18n="hero_cta_explore">Esplora ProprietÃ </a>
                <a href="#" class="btn" onclick="showSection('contact')" data-i18n="hero_cta_contact">Contattaci</a>
            </div>
        </div>
        <div class="scroll-indicator"><div class="scroll-line"></div></div>
    </section>

    <!-- ========================================
         EARLY ACCESS â€” FOUNDER PROGRAM
         ======================================== -->
    <section class="founder-section" id="founder-access">
        <div class="founder-inner">
            <!-- Badge -->
            <div class="founder-badge-wrap">
                <span class="founder-badge">
                    <span class="founder-badge-dot"></span>
                    Early Access
                </span>
            </div>

            <!-- Headline -->
            <h2 class="founder-title">Founder Reservation <span class="founder-title-accent">Program</span></h2>
            <p class="founder-subtitle">
                Accesso riservato ai primi <strong>200 membri</strong> che prenotano un prodotto.<br>
                Solo le prenotazioni confermate vengono conteggiate.
            </p>

            <!-- Counter -->
            <div class="founder-counter-block">
                <div class="founder-counter-numbers">
                    <span class="founder-taken" id="founderTaken">147</span>
                    <span class="founder-separator">/</span>
                    <span class="founder-total">200</span>
                </div>
                <p class="founder-counter-label">posti Founder confermati</p>

                <!-- Progress bar -->
                <div class="founder-progress-track">
                    <div class="founder-progress-fill" id="founderProgressFill" style="width: 73.5%"></div>
                    <div class="founder-progress-glow" id="founderProgressGlow" style="left: 73.5%"></div>
                </div>
                <div class="founder-progress-labels">
                    <span>0</span>
                    <span class="founder-remaining"><span id="founderRemaining">53</span> posti rimasti</span>
                    <span>200</span>
                </div>
            </div>

            <!-- Benefits grid -->
            <div class="founder-benefits">
                <div class="founder-benefit-item">
                    <div class="founder-benefit-icon">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75M21 12c0 1.268-.63 2.39-1.593 3.068a3.745 3.745 0 01-1.043 3.296 3.745 3.745 0 01-3.296 1.043A3.745 3.745 0 0112 21c-1.268 0-2.39-.63-3.068-1.593a3.745 3.745 0 01-3.296-1.043 3.745 3.745 0 01-1.043-3.296A3.745 3.745 0 013 12c0-1.268.63-2.39 1.593-3.068a3.745 3.745 0 011.043-3.296 3.745 3.745 0 013.296-1.043A3.745 3.745 0 0112 3c1.268 0 2.39.63 3.068 1.593a3.745 3.745 0 013.296 1.043 3.745 3.745 0 011.043 3.296A3.745 3.745 0 0121 12z"/></svg>
                    </div>
                    <span>Status permanente <em>Founding Member</em></span>
                </div>
                <div class="founder-benefit-item">
                    <div class="founder-benefit-icon">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M15.59 14.37a6 6 0 01-5.84 7.38v-4.8m5.84-2.58a14.98 14.98 0 006.16-12.12A14.98 14.98 0 009.631 8.41m5.96 5.96a14.926 14.926 0 01-5.841 2.58m-.119-8.54a6 6 0 00-7.381 5.84h4.8m2.581-5.84a14.927 14.927 0 00-2.58 5.84m2.699 2.7c-.103.021-.207.041-.311.06a15.09 15.09 0 01-2.448-2.448 14.9 14.9 0 01.06-.312m-2.24 2.39a4.493 4.493 0 00-1.757 4.306 4.493 4.493 0 004.306-1.758M16.5 9a1.5 1.5 0 11-3 0 1.5 1.5 0 013 0z"/></svg>
                    </div>
                    <span>Accesso anticipato ai nuovi listing</span>
                </div>
                <div class="founder-benefit-item">
                    <div class="founder-benefit-icon">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 13.5l10.5-11.25L12 10.5h8.25L9.75 21.75 12 13.5H3.75z"/></svg>
                    </div>
                    <span>Accesso anticipato ai future drops</span>
                </div>
                <div class="founder-benefit-item">
                    <div class="founder-benefit-icon">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M18 18.72a9.094 9.094 0 003.741-.479 3 3 0 00-4.682-2.72m.94 3.198l.001.031c0 .225-.012.447-.037.666A11.944 11.944 0 0112 21c-2.17 0-4.207-.576-5.963-1.584A6.062 6.062 0 016 18.719m12 0a5.971 5.971 0 00-.941-3.197m0 0A5.995 5.995 0 0012 12.75a5.995 5.995 0 00-5.058 2.772m0 0a3 3 0 00-4.681 2.72 8.986 8.986 0 003.74.477m.94-3.197a5.971 5.971 0 00-.94 3.197M15 6.75a3 3 0 11-6 0 3 3 0 016 0zm6 3a2.25 2.25 0 11-4.5 0 2.25 2.25 0 014.5 0zm-13.5 0a2.25 2.25 0 11-4.5 0 2.25 2.25 0 014.5 0z"/></svg>
                    </div>
                    <span>Community privata riservata</span>
                </div>
                <div class="founder-benefit-item">
                    <div class="founder-benefit-icon">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M9.813 15.904L9 18.75l-.813-2.846a4.5 4.5 0 00-3.09-3.09L2.25 12l2.846-.813a4.5 4.5 0 003.09-3.09L9 5.25l.813 2.846a4.5 4.5 0 003.09 3.09L15.75 12l-2.846.813a4.5 4.5 0 00-3.09 3.09z"/></svg>
                    </div>
                    <span>Condizioni riservate nel tempo</span>
                </div>
                <div class="founder-benefit-item">
                    <div class="founder-benefit-icon">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M7.5 8.25h9m-9 3H12m-9.75 1.51c0 1.6 1.123 2.994 2.707 3.227 1.129.166 2.27.293 3.423.379.35.026.67.21.865.501L12 21l2.755-4.133a1.14 1.14 0 01.865-.501 48.172 48.172 0 003.423-.379c1.584-.233 2.707-1.626 2.707-3.228V6.741c0-1.602-1.123-2.995-2.707-3.228A48.394 48.394 0 0012 3c-2.392 0-4.744.175-7.043.513C3.373 3.746 2.25 5.14 2.25 6.741v6.018z"/></svg>
                    </div>
                    <span>Influenza diretta sullo sviluppo</span>
                </div>
            </div>

            <!-- CTA -->
            <div class="founder-cta-wrap">
                <a href="#" class="founder-cta-btn" onclick="showSection('properties')">
                    <span>Prenota un prodotto</span>
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M17.25 8.25L21 12m0 0l-3.75 3.75M21 12H3"/></svg>
                </a>
                <p class="founder-cta-note">Il posto viene riservato al momento della prenotazione confermata</p>
            </div>
        </div>
    </section>

    <!-- ========================================
         SEZIONE IMMOBILI
         ======================================== -->
    <section class="section" id="properties">
        <h2 class="section-title" data-i18n="section_properties">Immobili Esclusivi</h2>
        
        <!-- FILTRO IMMOBILI -->
        <div class="property-filter-container" id="propertyFilterContainer" style="display: none;">
            <div class="filter-header">
                <span class="filter-label" data-i18n="filter_label_property">Tipologia Immobile</span>
                <button class="filter-reset-btn" id="propertyResetBtn" style="display: none;">
                    <span>âœ•</span> 
                    <span data-i18n="filter_reset">Mostra Tutto</span>
                </button>
            </div>
            <div class="filter-pills-grid">
                <button class="filter-pill" data-property-type="V">
                    <svg class="pill-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"/>
                    </svg>
                    <span class="pill-label" data-i18n="filter_ville">Ville</span>
                    <span class="pill-count">0</span>
                </button>
                
                <button class="filter-pill" data-property-type="C">
                    <svg class="pill-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/>
                    </svg>
                    <span class="pill-label" data-i18n="filter_castelli">Castelli</span>
                    <span class="pill-count">0</span>
                </button>
                
                <button class="filter-pill" data-property-type="A">
                    <svg class="pill-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 14v3m4-3v3m4-3v3M3 21h18M3 10h18M3 7l9-4 9 4M4 10h16v11H4V10z"/>
                    </svg>
                    <span class="pill-label" data-i18n="filter_appartamenti">Appartamenti</span>
                    <span class="pill-count">0</span>
                </button>
            </div>
        </div>

        <div class="grid" id="propertiesGrid"></div>
    </section>

    <!-- ========================================
         SEZIONE SUPERCAR
         ======================================== -->
    <section class="section" id="supercars">
        <h2 class="section-title" data-i18n="section_supercars">Supercar Collection</h2>
        
        <!-- FILTRO SUPERCAR -->
        <div class="supercar-filter-container" id="supercarFilterContainer" style="display: none;">
            <div class="filter-header">
                <span class="filter-label" data-i18n="filter_label_supercar">Configurazione</span>
                <button class="filter-reset-btn" id="supercarResetBtn" style="display: none;">
                    <span>âœ•</span> 
                    <span data-i18n="filter_reset">Mostra Tutto</span>
                </button>
            </div>
            <div class="filter-pills-grid">
                <button class="filter-pill" data-supercar-type="single">
                    <svg class="pill-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
                    </svg>
                    <span class="pill-label" data-i18n="filter_single">Singola Supercar</span>
                    <span class="pill-count">0</span>
                </button>
                
                <button class="filter-pill" data-supercar-type="combo">
                    <svg class="pill-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"/>
                    </svg>
                    <span class="pill-label" data-i18n="filter_combo">Doppia Supercar</span>
                    <span class="pill-count">0</span>
                </button>
            </div>
        </div>

        <div class="grid" id="supercarsGrid"></div>
    </section>

    <!-- ========================================
         SEZIONE ESPERIENZE
         ======================================== -->
    <section class="section" id="stays">
        <h2 class="section-title" data-i18n="section_stays">Esperienze Esclusive</h2>
        <div class="grid" id="staysGrid"></div>
    </section>

    <!-- ========================================
         SEZIONE SHOP
         ======================================== -->
    <section class="section" id="shop">
        <h2 class="section-title" data-i18n="section_shop">Merchandising Ufficiale</h2>
        
        <!-- FILTRO CATEGORIE -->
        <div class="category-filter-container" id="categoryFilterContainer" style="display: none;">
            <div class="category-filter-header">
                <span class="filter-label" data-i18n="filter_label_category">Filtra per Categoria</span>
                <button class="filter-reset" id="filterResetBtn" style="display: none;">
                    <span>âœ•</span> 
                    <span data-i18n="filter_reset">Mostra Tutto</span>
                </button>
            </div>
            <div class="category-pills" id="categoryPills">
                <!-- Categorie caricate dinamicamente -->
            </div>
        </div>
        
        <div class="grid" id="shopGrid"></div>
    </section>

    <!-- ========================================
         SEZIONE CONTATTI
         ======================================== -->
    <section class="section" id="contact">
        <h2 class="section-title" data-i18n="section_contact">Contattaci</h2>
        <div class="contact-content">
            <div class="about-content" style="margin-bottom: 3rem;">
                <p class="about-text" data-i18n="contact_intro">
                    LuxHaven360 rappresenta l'eccellenza nel settore immobiliare e automotive di alto livello. 
                    Offriamo un servizio personalizzato e discreto per clienti che ricercano proprietÃ  
                    straordinarie ed esperienze indimenticabili.
                </p>
            </div>
            <form class="contact-form" id="contactForm" onsubmit="handleContactSubmit(event)">
                <div class="form-group">
                    <label for="name" data-i18n="contact_name">Nome</label>
                    <input type="text" id="name" required data-i18n-placeholder="contact_name" placeholder="Nome" />
                </div>
                <div class="form-group">
                    <label for="email" data-i18n="contact_email">Email</label>
                    <input type="email" id="email" required data-i18n-placeholder="contact_email" placeholder="Email" />
                </div>
                <div class="form-group">
                    <label for="interest" data-i18n="contact_interest">Interesse</label>
                    <select id="interest">
                        <option value="properties" data-i18n="interest_properties">Immobili</option>
                        <option value="supercars" data-i18n="interest_supercars">Supercar</option>
                        <option value="stays" data-i18n="interest_stays">Esperienze</option>
                        <option value="shop" data-i18n="interest_shop">Shop</option>
                        <option value="other" data-i18n="interest_other">Altro</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="message" data-i18n="contact_message">Messaggio</label>
                    <textarea id="message" required data-i18n-placeholder="contact_message" placeholder="Messaggio"></textarea>
                </div>
                <button type="submit" class="btn btn-primary" data-i18n="contact_submit">Invia Richiesta</button>
            </form>
            
            <!-- MESSAGGIO SUCCESSO -->
            <div id="contactSuccessMessage" style="display: none;">
                <div class="success-overlay">
                    <div class="success-card">
                        <div class="success-icon">âœ“</div>
                        <h3 class="success-title" data-i18n="contact_success_title">Richiesta Inviata!</h3>
                        <p class="success-text" data-i18n="contact_success_text" data-i18n-html="true">
                            La tua richiesta Ã¨ stata inviata con successo.<br>
                            Ti contatteremo entro 24-48 ore.
                        </p>
                        <button class="btn btn-primary" onclick="closeSuccessMessage()" data-i18n="contact_btn_ok" style="width: 100%; margin-top: 1.5rem;">
                            Perfetto
                        </button>
                    </div>
                </div>
            </div>

            <!-- MESSAGGIO ERRORE -->
            <div id="contactErrorMessage" style="display: none;">
                <div class="error-overlay">
                    <div class="error-card">
                        <div class="error-icon">âš </div>
                        <h3 class="error-title" data-i18n="contact_error_title">Email Non Valida</h3>
                        <p class="error-text" id="errorText" data-i18n="contact_error_text">
                            L'indirizzo email inserito non Ã¨ valido.
                        </p>
                        <button class="btn" onclick="closeErrorMessage()" data-i18n="contact_btn_retry" style="width: 100%; margin-top: 1.5rem; background: #ef4444; border-color: #ef4444;">
                            Riprova
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- ========================================
         FOOTER
         ======================================== -->
    <footer>
        <div class="footer-content">
            <p class="footer-text">Â© <span id="current-year">2025</span> <span data-i18n="footer_company">LuxHaven360. Tutti i diritti riservati.</span></p>
            <p class="footer-text" style="margin-top: 0.5rem;">
                <span data-i18n="footer_privacy">Privacy Policy</span> | 
                <span data-i18n="footer_terms">Terms of Service</span>
            </p>
        </div>
    </footer>

    <!-- ========================================
         FLOATING COMMUNITY BUTTON
         ======================================== -->
    <div class="community-float" id="communityFloat" onclick="window.location.href='https://luxhaven360.github.io/luxhaven360-site/the-project/community.html'" title="Members Area">
        <div class="community-float-inner">
            <div class="community-float-icon">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M18 18.72a9.094 9.094 0 003.741-.479 3 3 0 00-4.682-2.72m.94 3.198l.001.031c0 .225-.012.447-.037.666A11.944 11.944 0 0112 21c-2.17 0-4.207-.576-5.963-1.584A6.062 6.062 0 016 18.719m12 0a5.971 5.971 0 00-.941-3.197m0 0A5.995 5.995 0 0012 12.75a5.995 5.995 0 00-5.058 2.772m0 0a3 3 0 00-4.681 2.72 8.986 8.986 0 003.74.477m.94-3.197a5.971 5.971 0 00-.94 3.197M15 6.75a3 3 0 11-6 0 3 3 0 016 0zm6 3a2.25 2.25 0 11-4.5 0 2.25 2.25 0 014.5 0zm-13.5 0a2.25 2.25 0 11-4.5 0 2.25 2.25 0 014.5 0z"/>
                </svg>
            </div>
            <span class="community-float-label">Members</span>
        </div>
        <div class="community-float-pulse"></div>
    </div>

    <!-- SCRIPTS -->
    <script src="script.js"></script>
    <script src="connection-monitor.js"></script>
    <script>
        const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbwr79RkXIEocpuOKaM6uMJqE6VFs9wjlUPvrr__FvDbDDrD2ELB1NbfrWP3BCYpHj2u/exec';

        // INIZIALIZZAZIONE PAGINA
        function initializePage() {
    const introLoader = document.getElementById('intro-loader');
    const progressBar = document.querySelector('.intro-progress-fill');
    
    document.body.style.overflow = 'hidden';

    let progress = 0;
    const fakeLoaderInterval = setInterval(() => {
        if (progress < 70) {
            progress += (Math.random() * 8);
            if (progress > 70) progress = 70;
            if (progressBar) progressBar.style.width = `${progress}%`;
        }
    }, 80);

    // âœ… Carica tassi di cambio E prodotti in parallelo
    const ratesPromise = loadExchangeRates();
    const dataPromise = typeof initDynamicProducts === 'function' 
        ? initDynamicProducts() 
        : Promise.resolve();

    // âœ… Aspetta che ENTRAMBI finiscano
    Promise.all([ratesPromise, dataPromise]).then(() => {
    // âœ… Aggiorna tutti i prezzi con i tassi corretti (delay maggiore per sicurezza)
    setTimeout(() => {
        console.log('ðŸ”„ Refresh finale prezzi dopo caricamento completo');
        updateAllPricesForLanguage();
    }, 300); // â† Aumentato da 100 a 300ms
        
        clearInterval(fakeLoaderInterval);
        
        if (progressBar) {
            progressBar.style.transition = 'width 0.3s ease-out';
            progressBar.style.width = '100%';
        }

        setTimeout(() => {
            if (introLoader) {
                introLoader.style.opacity = '0';
                introLoader.classList.add('fade-out');
                document.body.style.overflow = '';
                
                setTimeout(() => { 
                    introLoader.style.display = 'none'; 
                }, 400); 
            }
        }, 200);
    });

            loadShopCategories();

            const hash = window.location.hash.substring(1);
            if (hash && typeof showSection === 'function') showSection(hash);
            
            setTimeout(() => {
                updateCartIcon();
                updateTrackingIcon();
                restoreShopFilterIfNeeded();
                restoreBookableFilters();
            }, 100);
        }

        function restoreShopFilterIfNeeded() {
            const savedFilter = localStorage.getItem('lh360_active_shop_filter');
            
            if (!savedFilter) return;
            
            console.log('ðŸ”„ Ripristino UI filtro salvato:', savedFilter);
            
            const checkInterval = setInterval(() => {
                const categoryPills = document.querySelectorAll('.category-pill');
                
                if (categoryPills.length > 0) {
                    clearInterval(checkInterval);
                    
                    const targetPill = Array.from(categoryPills)
                        .find(p => p.dataset.category === savedFilter);
                    
                    if (targetPill) {
                        document.querySelectorAll('.category-pill').forEach(p => p.classList.remove('active'));
                        targetPill.classList.add('active');
                        
                        const resetBtn = document.getElementById('filterResetBtn');
                        if (resetBtn) resetBtn.style.display = 'inline-flex';
                        
                        console.log('âœ… UI filtro ripristinata');
                    }
                }
            }, 100);
            
            setTimeout(() => clearInterval(checkInterval), 3000);
        }

        window.addEventListener('load', initializePage);

        window.addEventListener('pageshow', function(event) {
            if (event.persisted) {
                console.log('ðŸ“± Pagina ripristinata da cache (bfcache)');
                
                const waitForProducts = setInterval(() => {
                    const hasProducts = document.querySelectorAll('.card[data-sku]').length > 0;
                    
                    if (hasProducts) {
                        clearInterval(waitForProducts);
                        
                        console.log('âœ… Prodotti trovati, ripristino filtri');
                        restoreShopFilterIfNeeded();
                        restoreBookableFilters();
                    }
                }, 100);
                
                setTimeout(() => {
                    clearInterval(waitForProducts);
                    
                    const hasProducts = document.querySelectorAll('.card[data-sku]').length > 0;
                    
                    if (!hasProducts) {
                        console.log('âš ï¸ Prodotti non trovati dopo timeout, ricarico dinamicamente');
                        initDynamicProducts().then(() => {
                            console.log('âœ… Prodotti ricaricati, applico filtri');
                            restoreShopFilterIfNeeded();
                            restoreBookableFilters();
                        });
                    }
                }, 3000);
            }
        });

        function updateCartIcon() {
            const cart = JSON.parse(localStorage.getItem('lh360_cart')) || [];
            const totalQty = cart.reduce((sum, item) => sum + (item.qty || 1), 0);
            const cartIcon = document.getElementById('cartIcon');
            if (cartIcon) {
                if (totalQty > 0) cartIcon.classList.add('show');
                else cartIcon.classList.remove('show');
            }
        }

        function updateTrackingIcon() {
            const trackingIcon = document.getElementById('trackingIcon');
            if (!trackingIcon) return;

            cleanupOldOrders();
            const hasLocal = checkLocalStorageForActiveOrders();

            if (hasLocal) {
                trackingIcon.style.display = 'inline-flex'; 
            }

            fetchActiveOrdersFromAPI(trackingIcon);
        }

        async function fetchActiveOrdersFromAPI(icon) {
            try {
                const response = await fetch(`${WEB_APP_URL}?get_active_count=1&t=${Date.now()}`, {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json'
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const data = await response.json();
                
                if (data && typeof data.count === 'number') {
                    if (data.count > 0) {
                        icon.style.display = 'inline-flex';
                        console.log('ðŸ“¦ Tracking Icon: Attivata da API (Ordini: ' + data.count + ')');
                    } else {
                        icon.style.display = 'none';
                        clearAllLocalOrderData();
                    }
                }
                
            } catch (error) {
                console.warn('âš ï¸ Errore API tracking icon:', error);
            }
        }

        function clearAllLocalOrderData() {
            localStorage.removeItem('lh360_pending_order');
            localStorage.removeItem('lh360_last_order_id');
            localStorage.removeItem('lh360_order_confirmed_time');
            for (let i = localStorage.length - 1; i >= 0; i--) {
                const key = localStorage.key(i);
                if (key && (
                    key.startsWith('lh360_order_') ||
                    key.startsWith('lh360_pending_') ||
                    key.startsWith('lh360_order_time_') ||
                    key === 'lh360_last_product' ||
                    key === 'lh360_selected_sku'
                )) {
                    localStorage.removeItem(key);
                    console.log(`ðŸ—‘ï¸ Rimossa key outdated: ${key}`);
                }
            }
        }

        function checkLocalStorageForActiveOrders() {
            const now = new Date();
            const thirtyDaysAgo = new Date(now.getTime() - (30 * 24 * 60 * 60 * 1000));
            const twoDaysAgo = new Date(now.getTime() - (2 * 24 * 60 * 60 * 1000));
            
            const activeStates = ['Confermato', 'In Preparazione', 'In Transito'];
            
            const pendingOrder = localStorage.getItem('lh360_pending_order');
            if (pendingOrder) {
                try {
                    const order = JSON.parse(pendingOrder);
                    const orderDate = new Date(order.timestamp || order.data);
                    
                    if (!isNaN(orderDate.getTime()) && orderDate > thirtyDaysAgo) {
                        if (activeStates.includes(order.stato)) {
                            console.log('âœ“ Ordine pending attivo:', order.id, order.stato);
                            return true;
                        }
                        
                        if (order.stato === 'Consegnato') {
                            const deliveryDate = parseDeliveryDate(order.consegna_prevista);
                            if (deliveryDate && deliveryDate > twoDaysAgo) {
                                console.log('âœ“ Ordine consegnato recente (<2 giorni):', order.id);
                                return true;
                            }
                        }
                    }
                } catch (e) {
                    console.error('Errore parsing pending order:', e);
                }
            }
            
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key && key.startsWith('lh360_order_time_')) {
                    const timestamp = localStorage.getItem(key);
                    if (timestamp) {
                        const orderDate = new Date(timestamp);
                        if (!isNaN(orderDate.getTime()) && orderDate > thirtyDaysAgo) {
                            console.log('âœ“ Ordine recente trovato (timestamp):', key);
                            return true;
                        }
                    }
                }
            }
            
            const lastOrderTime = localStorage.getItem('lh360_order_confirmed_time');
            if (lastOrderTime) {
                const orderDate = new Date(lastOrderTime);
                if (!isNaN(orderDate.getTime()) && orderDate > thirtyDaysAgo) {
                    console.log('âœ“ Ordine recente (confirmed_time)');
                    return true;
                }
            }
            
            return false;
        }

        function parseDeliveryDate(dateStr) {
            if (!dateStr || dateStr === 'Da definire') return null;
            
            try {
                const months = {
                    'gennaio': 0, 'febbraio': 1, 'marzo': 2, 'aprile': 3,
                    'maggio': 4, 'giugno': 5, 'luglio': 6, 'agosto': 7,
                    'settembre': 8, 'ottobre': 9, 'novembre': 10, 'dicembre': 11
                };
                
                const match = dateStr.match(/(\d{1,2})\s+(\w+)\s+(\d{4})/);
                if (match) {
                    const day = parseInt(match[1]);
                    const monthName = match[2].toLowerCase();
                    const year = parseInt(match[3]);
                    if (months[monthName] !== undefined) {
                        return new Date(year, months[monthName], day);
                    }
                }
                
                const parts = dateStr.split('/');
                if (parts.length === 3) {
                    return new Date(parts[2], parts[1] - 1, parts[0]);
                }
            } catch (e) {
                console.error('Errore parsing data consegna:', e);
            }
            
            return null;
        }

        function cleanupOldOrders() {
            const thirtyDaysAgo = new Date(Date.now() - (30 * 24 * 60 * 60 * 1000));
            
            const pendingOrder = localStorage.getItem('lh360_pending_order');
            if (pendingOrder) {
                try {
                    const order = JSON.parse(pendingOrder);
                    const orderDate = new Date(order.timestamp || order.data);
                    if (orderDate < thirtyDaysAgo) {
                        localStorage.removeItem('lh360_pending_order');
                        console.log('ðŸ—‘ï¸ Rimosso ordine pending vecchio');
                    }
                } catch (e) {}
            }
            
            for (let i = localStorage.length - 1; i >= 0; i--) {
                const key = localStorage.key(i);
                if (key && key.startsWith('lh360_order_time_')) {
                    const timestamp = localStorage.getItem(key);
                    if (timestamp) {
                        const orderDate = new Date(timestamp);
                        if (orderDate < thirtyDaysAgo) {
                            localStorage.removeItem(key);
                            console.log('ðŸ—‘ï¸ Rimosso timestamp vecchio:', key);
                        }
                    }
                }
            }
            
            const lastOrderTime = localStorage.getItem('lh360_order_confirmed_time');
            if (lastOrderTime) {
                const orderDate = new Date(lastOrderTime);
                if (orderDate < thirtyDaysAgo) {
                    localStorage.removeItem('lh360_order_confirmed_time');
                    console.log('ðŸ—‘ï¸ Rimosso confirmed_time vecchio');
                }
            }
        }

        window.addEventListener('storage', (event) => {
            if (event.key === 'lh360_cart') {
                updateCartIcon();
            }
            if (event.key && (event.key.startsWith('lh360_order_') || event.key.startsWith('lh360_pending_'))) {
                updateTrackingIcon();
            }
        });

        setInterval(() => {
            updateTrackingIcon();
        }, 5 * 60 * 1000);

        // ========================================
        // COPYRIGHT DINAMICO - APPROCCIO SEMPLICE
        // ========================================
        function updateYear() {
            const yearSpan = document.getElementById('current-year');
            if (yearSpan) {
                const currentYear = new Date().getFullYear();
                if (yearSpan.textContent !== currentYear.toString()) {
                    yearSpan.textContent = currentYear;
                }
            }
        }
        
        // Aggiorna anno ogni secondo (sicuro, semplice)
        setInterval(updateYear, 1000);
        updateYear(); // Chiamata immediata

        // ========================================
        // RESET SCROLL - APPROCCIO SEMPLICE
        // ========================================
        // Reset scroll quando pagina viene mostrata (back/forward)
        window.addEventListener('pageshow', function() {
            setTimeout(() => window.scrollTo(0, 0), 0);
        });
    </script>
</body>
</html>
