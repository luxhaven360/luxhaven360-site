<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>LuxHaven360 - Eccellenza Immobiliare</title>
    <link rel="stylesheet" href="styles.css" />
</head>
<body>
    <div id="intro-loader">
        <div class="intro-content">
            <div class="intro-logo-wrapper">
                <img src="assets/logo-azienda.png" alt="LuxHaven360" class="intro-logo">
            </div>
            <div class="intro-divider"></div>
            <h2 class="intro-tagline">Eccellenza Senza Compromessi</h2>
            <div class="intro-progress-bar">
                <div class="intro-progress-fill"></div>
            </div>
        </div>
    </div>

    <nav id="navbar">
        <div class="nav-content">
            <div class="logo" onclick="showSection('home')">LuxHaven360</div>
            <div class="mobile-toggle" onclick="toggleMenu()">
                <span></span><span></span><span></span>
            </div>
            <ul class="nav-links" id="navLinks">
                <li><a href="#" onclick="showSection('home')">Home</a></li>
                <li><a href="#" onclick="showSection('properties')">Immobili</a></li>
                <li><a href="#" onclick="showSection('supercars')">Supercar</a></li>
                <li><a href="#" onclick="showSection('stays')">Esperienze</a></li>
                <li><a href="#" onclick="showSection('shop')">Shop</a></li>
                <li><a href="#" onclick="showSection('contact')">Contatti</a></li>
                <!-- Icona tracking (solo nel menu) -->
                <li id="trackingIcon" class="cart-icon" onclick="window.location.href='product-details/tracking-order.html?view=all'" title="Traccia i tuoi ordini" style="display: none;">ðŸ“¦</li>
                <li id="cartIcon" class="cart-icon" onclick="window.location.href='product-details/cart.html'">ðŸ›’</li>
            </ul>
        </div>
    </nav>

    <section class="hero" id="home" style="display: flex;">
        <div class="hero-bg"></div>
        <div class="hero-pattern"></div>
        <div class="hero-content">
            <h1 class="hero-title"><img src="assets/logo-azienda.png" alt="LuxHaven360 Logo" /></h1>
            <p class="hero-subtitle">Eccellenza Senza Compromessi</p>
            <div class="cta-buttons">
                <a href="#" class="btn btn-primary" onclick="showSection('properties')">Esplora ProprietÃ </a>
                <a href="#" class="btn" onclick="showSection('contact')">Contattaci</a>
            </div>
        </div>
        <div class="scroll-indicator"><div class="scroll-line"></div></div>
    </section>

    <section class="section" id="properties">
        <h2 class="section-title">Immobili Esclusivi</h2>
        <!-- âœ¨ FILTRO IMMOBILI PREMIUM -->
<div class="property-filter-container" id="propertyFilterContainer" style="display: none;">
    <div class="filter-header">
        <span class="filter-label">Tipologia Immobile</span>
        <button class="filter-reset-btn" id="propertyResetBtn" style="display: none;">
            <span>âœ•</span> Mostra Tutto
        </button>
    </div>
    <div class="filter-pills-grid">
        <button class="filter-pill" data-property-type="V">
            <svg class="pill-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"/>
            </svg>
            <span class="pill-label">Ville</span>
            <span class="pill-count">0</span>
        </button>
        
        <button class="filter-pill" data-property-type="C">
            <svg class="pill-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/>
            </svg>
            <span class="pill-label">Castelli</span>
            <span class="pill-count">0</span>
        </button>
        
        <button class="filter-pill" data-property-type="A">
            <svg class="pill-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 14v3m4-3v3m4-3v3M3 21h18M3 10h18M3 7l9-4 9 4M4 10h16v11H4V10z"/>
            </svg>
            <span class="pill-label">Appartamenti</span>
            <span class="pill-count">0</span>
        </button>
    </div>
</div>

<div class="grid" id="propertiesGrid"></div>
    </section>

    <section class="section" id="supercars">
        <h2 class="section-title">Supercar Collection</h2>
        <!-- âœ¨ FILTRO SUPERCAR PREMIUM -->
<div class="supercar-filter-container" id="supercarFilterContainer" style="display: none;">
    <div class="filter-header">
        <span class="filter-label">Configurazione</span>
        <button class="filter-reset-btn" id="supercarResetBtn" style="display: none;">
            <span>âœ•</span> Mostra Tutto
        </button>
    </div>
    <div class="filter-pills-grid">
        <button class="filter-pill" data-supercar-type="single">
            <svg class="pill-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
            </svg>
            <span class="pill-label">Singola Supercar</span>
            <span class="pill-count">0</span>
        </button>
        
        <button class="filter-pill" data-supercar-type="combo">
            <svg class="pill-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"/>
            </svg>
            <span class="pill-label">Doppia Supercar</span>
            <span class="pill-count">0</span>
        </button>
    </div>
</div>

<div class="grid" id="supercarsGrid"></div>
    </section>

    <section class="section" id="stays">
        <h2 class="section-title">Esperienze Esclusive</h2>
        <div class="grid" id="staysGrid"></div>
    </section>

    <section class="section" id="shop">
    <h2 class="section-title">Merchandising Ufficiale</h2>
    
    <!-- âœ¨ NUOVO: Filtro Categorie Premium -->
    <div class="category-filter-container" id="categoryFilterContainer" style="display: none;">
        <div class="category-filter-header">
            <span class="filter-label">Filtra per Categoria</span>
            <button class="filter-reset" id="filterResetBtn" style="display: none;">
                <span>âœ•</span> Mostra Tutto
            </button>
        </div>
        <div class="category-pills" id="categoryPills">
            <!-- Categorie caricate dinamicamente -->
        </div>
    </div>
    
    <div class="grid" id="shopGrid"></div>
</section>

    <section class="section" id="contact">
        <h2 class="section-title">Contattaci</h2>
        <div class="contact-content">
            <div class="about-content" style="margin-bottom: 3rem;">
                <p class="about-text">
                    LuxHaven360 rappresenta l'eccellenza nel settore immobiliare e automotive di alto livello. 
                    Offriamo un servizio personalizzato e discreto per clienti che ricercano proprietÃ  
                    straordinarie ed esperienze indimenticabili.
                </p>
            </div>
            <form class="contact-form" onsubmit="event.preventDefault(); alert('Messaggio inviato con successo! Ti contatteremo presto.');">
                <div class="form-group">
                    <label for="name">Nome</label>
                    <input type="text" id="name" required />
                </div>
                <div class="form-group">
                    <label for="email">Email</label>
                    <input type="email" id="email" required />
                </div>
                <div class="form-group">
                    <label for="interest">Interesse</label>
                    <select id="interest" style="padding: 1rem; background: rgba(26, 26, 26, 0.5); border: 1px solid rgba(212, 175, 55, 0.3); color: var(--light);">
                        <option>Immobili</option>
                        <option>Supercar</option>
                        <option>Esperienze</option>
                        <option>Shop</option>
                        <option>Altro</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="message">Messaggio</label>
                    <textarea id="message" required></textarea>
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%;">Invia Richiesta</button>
            </form>
        </div>
    </section>

    <footer>
        <div class="footer-content">
            <p class="footer-text">Â© 2025 LuxHaven360. Tutti i diritti riservati.</p>
            <p class="footer-text" style="margin-top: 0.5rem;">Privacy Policy | Terms of Service</p>
        </div>
    </footer>

    <script src="script.js"></script>
    <script>
        const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbwr79RkXIEocpuOKaM6uMJqE6VFs9wjlUPvrr__FvDbDDrD2ELB1NbfrWP3BCYpHj2u/exec';

    // âœ… FUNZIONE DI INIZIALIZZAZIONE
function initializePage() {
    const introLoader = document.getElementById('intro-loader');
    const progressBar = document.querySelector('.intro-progress-fill');
    
    // Blocca lo scroll
    document.body.style.overflow = 'hidden';

    // --- Animazione Caricamento ---
    let progress = 0;
    const fakeLoaderInterval = setInterval(() => {
        if (progress < 70) {
            progress += (Math.random() * 8);
            if (progress > 70) progress = 70;
            if (progressBar) progressBar.style.width = `${progress}%`;
        }
    }, 80);

    // --- Caricamento Dati ---
    const dataPromise = typeof initDynamicProducts === 'function' 
        ? initDynamicProducts() 
        : Promise.resolve();

    dataPromise.then(() => {
    clearInterval(fakeLoaderInterval);
    
    // 1. Completa la barra immediatamente
    if (progressBar) {
        progressBar.style.transition = 'width 0.3s ease-out';
        progressBar.style.width = '100%';
    }

    // 2. Nascondi il loader IMMEDIATAMENTE dopo animazione barra (300ms)
    setTimeout(() => {
        if (introLoader) {
            introLoader.style.opacity = '0';
            introLoader.classList.add('fade-out');
            document.body.style.overflow = '';
            
            setTimeout(() => { 
                introLoader.style.display = 'none'; 
            }, 400); 
        }
    }, 350); // â¬…ï¸ RIDOTTO DA 200 A 350ms per sincronizzarsi con l'animazione della barra (300ms)
});

    // PRE-CARICA CATEGORIE SHOP
    loadShopCategories();

    // Gestione Hash e Icone
    const hash = window.location.hash.substring(1);
    if (hash && typeof showSection === 'function') showSection(hash);
    
    updateCartIcon();
    updateTrackingIcon();
    
    // âœ… RIPRISTINA FILTRI SE ATTIVI
    restoreShopFilterIfNeeded();
    restoreBookableFilters(); // âœ… AGGIUNTO: Ripristina anche filtri immobili e supercar
}

// âœ… NUOVA FUNZIONE: Ripristina filtro shop
function restoreShopFilterIfNeeded() {
    const savedFilter = localStorage.getItem('lh360_active_shop_filter');
    
    if (!savedFilter) return;
    
    console.log('ðŸ”„ Ripristino filtro salvato:', savedFilter);
    
    // âœ… ATTENDI SIA LE PILLS CHE LE CARD CON data-shop-category
    const checkInterval = setInterval(() => {
        const categoryPills = document.querySelectorAll('.category-pill');
        const shopCards = document.querySelectorAll('.card[data-shop-category]');
        
        console.log(`ðŸ” Check: ${categoryPills.length} pills, ${shopCards.length} cards con categoria`);
        
        // Aspetta che ENTRAMBI siano pronti
        if (categoryPills.length > 0 && shopCards.length > 0) {
    clearInterval(checkInterval);
    
    // â¬‡ï¸ NASCONDI GRID IMMEDIATAMENTE
    const shopGrid = document.getElementById('shopGrid');
    if (shopGrid) shopGrid.style.opacity = '0';
    
    // Trova la pill corrispondente
    const targetPill = Array.from(categoryPills)
        .find(p => p.dataset.category === savedFilter);
    
    if (targetPill) {
        console.log('âœ… Filtro trovato, applicazione in corso...');
        console.log(`ðŸ“¦ Card disponibili: ${shopCards.length}`);
        
        // âœ… APPLICA DIRETTAMENTE IL FILTRO (non simulare click)
        setTimeout(() => {
                    // Attiva visualmente la pill
                    document.querySelectorAll('.category-pill').forEach(p => p.classList.remove('active'));
                    targetPill.classList.add('active');
                    
                    // Mostra pulsante reset
                    const resetBtn = document.getElementById('filterResetBtn');
                    if (resetBtn) resetBtn.style.display = 'inline-flex';
                    
                    // Applica il filtro alle card
                    const shopGrid = document.getElementById('shopGrid');
                    if (shopGrid) {
                        let visibleCount = 0;
                        let hiddenCount = 0;
                        
                        shopCards.forEach(card => {
                            const cardCategory = card.dataset.shopCategory || '';
                            
                            if (cardCategory === savedFilter) {
                                card.style.display = 'block';
                                card.style.animation = 'fadeIn 0.5s ease';
                                visibleCount++;
                            } else {
                                card.style.display = 'none';
                                hiddenCount++;
                            }
                        });
                        
                        console.log(`âœ… Filtro applicato: ${visibleCount} mostrate, ${hiddenCount} nascoste`);

// â¬‡ï¸ MOSTRA GRID CON ANIMAZIONE
shopGrid.style.transition = 'opacity 0.4s ease';
shopGrid.style.opacity = '1';

// Scroll al grid
setTimeout(() => {
    shopGrid.scrollIntoView({ behavior: 'smooth', block: 'start' });
}, 200);
            } else {
                console.warn('âš ï¸ Pill per categoria "' + savedFilter + '" non trovata');
            }
        }
    }, 150); // Controlla ogni 150ms
    
    // Timeout di sicurezza (max 5 secondi)
    setTimeout(() => {
        clearInterval(checkInterval);
        console.log('â±ï¸ Timeout raggiunto per ripristino filtro');
    }, 5000);
}

// === GESTIONE EVENTI ===

// Caricamento iniziale
window.addEventListener('load', initializePage);

// âœ… GESTIONE BACK/FORWARD CACHE (bfcache)
window.addEventListener('pageshow', function(event) {
    // Se la pagina viene ripristinata dalla cache (tasto indietro)
    if (event.persisted) {
        console.log('ðŸ“± Pagina ripristinata da cache (bfcache)');
        
        // âœ… STRATEGIA: Aspetta che i prodotti siano caricati prima di ripristinare i filtri
        const waitForProducts = setInterval(() => {
            const hasProducts = document.querySelectorAll('.card[data-sku]').length > 0;
            
            if (hasProducts) {
                clearInterval(waitForProducts);
                
                console.log('âœ… Prodotti trovati, ripristino filtri');
                restoreShopFilterIfNeeded();
                restoreBookableFilters();
            }
        }, 100); // Check ogni 100ms
        
        // Timeout di sicurezza: se dopo 3 secondi non trova prodotti, ricarica
        setTimeout(() => {
            clearInterval(waitForProducts);
            
            const hasProducts = document.querySelectorAll('.card[data-sku]').length > 0;
            
            if (!hasProducts) {
                console.log('âš ï¸ Prodotti non trovati dopo timeout, ricarico dinamicamente');
                initDynamicProducts().then(() => {
                    console.log('âœ… Prodotti ricaricati, applico filtri');
                    restoreShopFilterIfNeeded();
                    restoreBookableFilters();
                });
            }
        }, 3000);
    }
});

        function updateCartIcon() {
            const cart = JSON.parse(localStorage.getItem('lh360_cart')) || [];
            const totalQty = cart.reduce((sum, item) => sum + (item.qty || 1), 0);
            const cartIcon = document.getElementById('cartIcon');
            if (cartIcon) {
                 if (totalQty > 0) cartIcon.classList.add('show');
                 else cartIcon.classList.remove('show');
            }
        }

       // --- FIX TRACKING ICON: VISIBILE SIA SU DESKTOP CHE MOBILE ---
    function updateTrackingIcon() {
        const trackingIcon = document.getElementById('trackingIcon');
        if (!trackingIcon) return;

        cleanupOldOrders();
        const hasLocal = checkLocalStorageForActiveOrders();

        // Check locale immediato
        if (hasLocal) {
            // RIMOSSO IL BLOCCO "isDesktop": Ora mostra l'icona sempre
            trackingIcon.style.display = 'inline-flex'; 
        }

        // Chiamata server per conferma
        fetchActiveOrdersFromAPI(trackingIcon);
    }

    function fetchActiveOrdersFromAPI(icon) {
        const callbackName = 'handleActiveOrdersCount_' + Date.now();
        const script = document.createElement('script');
        // Aggiunta parametro cache-buster 't' per evitare cache browser
        script.src = `${WEB_APP_URL}?get_active_count=1&callback=${callbackName}&t=${Date.now()}`;
        
        const timeout = setTimeout(() => { cleanupScript(); }, 8000);

        window[callbackName] = function(response) {
            clearTimeout(timeout);
            
            if (response && typeof response.count === 'number') {
                if (response.count > 0) {
                    // RIMOSSO IL BLOCCO "isDesktop": Se count > 0, mostra sempre
                    icon.style.display = 'inline-flex';
                    console.log('ðŸ“¦ Tracking Icon: Attivata da API (Ordini: ' + response.count + ')');
                } else {
                    // Se l'API dice 0, nascondi e pulisci
                    icon.style.display = 'none';
                    clearAllLocalOrderData();
                }
            }

            cleanupScript();
        };

        script.onerror = () => {
            clearTimeout(timeout);
            cleanupScript();
            // In caso di errore rete, ci fidiamo dello stato locale (se era visibile, resta visibile)
        };

        function cleanupScript() {
            try { if (script.parentNode) document.body.removeChild(script); } catch (e) {}
            try { delete window[callbackName]; } catch (e) {}
        }

        document.body.appendChild(script);
    }

        function clearAllLocalOrderData() {
            localStorage.removeItem('lh360_pending_order');
            localStorage.removeItem('lh360_last_order_id');
            localStorage.removeItem('lh360_order_confirmed_time');
            for (let i = localStorage.length - 1; i >= 0; i--) {
                const key = localStorage.key(i);
                if (key && (
                    key.startsWith('lh360_order_') ||
                    key.startsWith('lh360_pending_') ||
                    key.startsWith('lh360_order_time_') ||
                    key === 'lh360_last_product' ||
                    key === 'lh360_selected_sku'
                )) {
                    localStorage.removeItem(key);
                    console.log(`ðŸ—‘ï¸ Rimossa key outdated: ${key}`);
                }
            }
        }

        /**
         * Check localStorage per ordini attivi (ultimi 30 giorni)
         * Applica regola dei 2 giorni per "Consegnato"
         */
        function checkLocalStorageForActiveOrders() {
            const now = new Date();
            const thirtyDaysAgo = new Date(now.getTime() - (30 * 24 * 60 * 60 * 1000));
            const twoDaysAgo = new Date(now.getTime() - (2 * 24 * 60 * 60 * 1000));
            
            // Stati attivi (escluso "Consegnato" che ha regola speciale)
            const activeStates = ['Confermato', 'In Preparazione', 'In Transito'];
            
            // Check 1: Ordine pending
            const pendingOrder = localStorage.getItem('lh360_pending_order');
            if (pendingOrder) {
                try {
                    const order = JSON.parse(pendingOrder);
                    const orderDate = new Date(order.timestamp || order.data);
                    
                    if (!isNaN(orderDate.getTime()) && orderDate > thirtyDaysAgo) {
                        // Check stato
                        if (activeStates.includes(order.stato)) {
                            console.log('âœ“ Ordine pending attivo:', order.id, order.stato);
                            return true;
                        }
                        
                        // Check "Consegnato" con regola 2 giorni
                        if (order.stato === 'Consegnato') {
                            const deliveryDate = parseDeliveryDate(order.consegna_prevista);
                            if (deliveryDate && deliveryDate > twoDaysAgo) {
                                console.log('âœ“ Ordine consegnato recente (<2 giorni):', order.id);
                                return true;
                            }
                        }
                    }
                } catch (e) {
                    console.error('Errore parsing pending order:', e);
                }
            }
            
            // Check 2: Timestamp ordini individuali (formato: lh360_order_time_*)
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key && key.startsWith('lh360_order_time_')) {
                    const timestamp = localStorage.getItem(key);
                    if (timestamp) {
                        const orderDate = new Date(timestamp);
                        if (!isNaN(orderDate.getTime()) && orderDate > thirtyDaysAgo) {
                            console.log('âœ“ Ordine recente trovato (timestamp):', key);
                            // Assumiamo attivo se nei 30 giorni (stato preciso viene da API)
                            return true;
                        }
                    }
                }
            }
            
            // Check 3: Ultimo ordine registrato
            const lastOrderTime = localStorage.getItem('lh360_order_confirmed_time');
            if (lastOrderTime) {
                const orderDate = new Date(lastOrderTime);
                if (!isNaN(orderDate.getTime()) && orderDate > thirtyDaysAgo) {
                    console.log('âœ“ Ordine recente (confirmed_time)');
                    return true;
                }
            }
            
            return false;
        }

        /**
         * Parse data di consegna (formato: "dd MMMM yyyy" o "dd/MM/yyyy")
         */
        function parseDeliveryDate(dateStr) {
            if (!dateStr || dateStr === 'Da definire') return null;
            
            try {
                // Prova formato: "dd MMMM yyyy"
                const months = {
                    'gennaio': 0, 'febbraio': 1, 'marzo': 2, 'aprile': 3,
                    'maggio': 4, 'giugno': 5, 'luglio': 6, 'agosto': 7,
                    'settembre': 8, 'ottobre': 9, 'novembre': 10, 'dicembre': 11
                };
                
                const match = dateStr.match(/(\d{1,2})\s+(\w+)\s+(\d{4})/);
                if (match) {
                    const day = parseInt(match[1]);
                    const monthName = match[2].toLowerCase();
                    const year = parseInt(match[3]);
                    if (months[monthName] !== undefined) {
                        return new Date(year, months[monthName], day);
                    }
                }
                
                // Prova formato: "dd/MM/yyyy"
                const parts = dateStr.split('/');
                if (parts.length === 3) {
                    return new Date(parts[2], parts[1] - 1, parts[0]);
                }
            } catch (e) {
                console.error('Errore parsing data consegna:', e);
            }
            
            return null;
        }

        /**
         * Cleanup: Rimuovi ordini vecchi da localStorage
         */
        function cleanupOldOrders() {
            const thirtyDaysAgo = new Date(Date.now() - (30 * 24 * 60 * 60 * 1000));
            
            // Rimuovi pending order se vecchio
            const pendingOrder = localStorage.getItem('lh360_pending_order');
            if (pendingOrder) {
                try {
                    const order = JSON.parse(pendingOrder);
                    const orderDate = new Date(order.timestamp || order.data);
                    if (orderDate < thirtyDaysAgo) {
                        localStorage.removeItem('lh360_pending_order');
                        console.log('ðŸ—‘ï¸ Rimosso ordine pending vecchio');
                    }
                } catch (e) {}
            }
            
            // Rimuovi timestamp vecchi
            for (let i = localStorage.length - 1; i >= 0; i--) {
                const key = localStorage.key(i);
                if (key && key.startsWith('lh360_order_time_')) {
                    const timestamp = localStorage.getItem(key);
                    if (timestamp) {
                        const orderDate = new Date(timestamp);
                        if (orderDate < thirtyDaysAgo) {
                            localStorage.removeItem(key);
                            console.log('ðŸ—‘ï¸ Rimosso timestamp vecchio:', key);
                        }
                    }
                }
            }
            
            // Rimuovi confirmed_time se vecchio
            const lastOrderTime = localStorage.getItem('lh360_order_confirmed_time');
            if (lastOrderTime) {
                const orderDate = new Date(lastOrderTime);
                if (orderDate < thirtyDaysAgo) {
                    localStorage.removeItem('lh360_order_confirmed_time');
                    console.log('ðŸ—‘ï¸ Rimosso confirmed_time vecchio');
                }
            }
        }

        // Listener per cambiamenti localStorage (cross-tab sync)
        window.addEventListener('storage', (event) => {
            if (event.key === 'lh360_cart') {
                updateCartIcon();
            }
            if (event.key && (event.key.startsWith('lh360_order_') || event.key.startsWith('lh360_pending_'))) {
                updateTrackingIcon();
            }
        });

        // Aggiorna icone periodicamente (ogni 5 minuti)
        setInterval(() => {
            updateTrackingIcon();
        }, 5 * 60 * 1000);
    </script>
</body>
</html>








